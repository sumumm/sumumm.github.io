<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/green/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"sumumm.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":300},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="æ€ä¹ˆä¿æŠ¤å…±äº«èµ„æºï¼Œé˜²æ­¢ç«äº‰ï¼Ÿè‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="LV06-06-å¹¶å‘ä¸ç«äº‰-02-å¹¶å‘æ§åˆ¶">
<meta property="og:url" content="https://sumumm.github.io/post/4af1eda3.html">
<meta property="og:site_name" content="è‹æœ¨">
<meta property="og:description" content="æ€ä¹ˆä¿æŠ¤å…±äº«èµ„æºï¼Œé˜²æ­¢ç«äº‰ï¼Ÿè‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250121105044537.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250121105204784.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122095804419.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122100058803.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122100356113.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122103229395.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122103247395.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250121165825048.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250121165930968.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122111048057.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122111333006.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122110709727.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122111727299.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122111851029.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122151244602.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122151319872.png">
<meta property="article:published_time" content="2025-01-24T15:59:53.000Z">
<meta property="article:modified_time" content="2025-06-13T16:25:57.053Z">
<meta property="article:author" content="è‹æœ¨">
<meta property="article:tag" content="LV06-é©±åŠ¨å¼€å‘">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250121105044537.png">


<link rel="canonical" href="https://sumumm.github.io/post/4af1eda3.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":"","permalink":"https://sumumm.github.io/post/4af1eda3.html","path":"post/4af1eda3.html","title":"LV06-06-å¹¶å‘ä¸ç«äº‰-02-å¹¶å‘æ§åˆ¶"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LV06-06-å¹¶å‘ä¸ç«äº‰-02-å¹¶å‘æ§åˆ¶ | è‹æœ¨</title>
  








    <script src="/js/browser_tools_disable.js"></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.com/hexo-next-tags-plus@latest/lib/tag_plus.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">è‹æœ¨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">æˆ‘çš„å­¦ä¹ ä¹‹è·¯</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>è‹æœ¨çš„å®¶</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»é¡µ<span class="badge">42</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£é¡µ<span class="badge">673</span></a></li><li class="menu-item menu-item-flink"><a href="/flink/" rel="section"><i class="fa fa-link fa-fw"></i>å‹äººå¸</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äºæˆ‘</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="nav-text">ä¸€ã€åŸå­æ“ä½œ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="nav-text">1. ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8EAPI"><span class="nav-text">2. ç›¸å…³æ•°æ®ç»“æ„ä¸API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-atomic-t"><span class="nav-text">2.1Â atomic_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%8E%9F%E5%AD%90%E6%95%B4%E5%BD%A2%E6%93%8D%E4%BD%9CAPI"><span class="nav-text">2.2 åŸå­æ•´å½¢æ“ä½œAPI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E5%8E%9F%E5%AD%90%E4%BD%8D%E6%93%8D%E4%BD%9C-API"><span class="nav-text">2.3Â åŸå­ä½æ“ä½œ API  </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9Cdemo"><span class="nav-text">3. åŸå­æ“ä½œdemo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-demo%E6%BA%90%E7%A0%81"><span class="nav-text">3.1 demoæºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%BC%80%E5%8F%91%E6%9D%BF%E9%AA%8C%E8%AF%81"><span class="nav-text">3.2 å¼€å‘æ¿éªŒè¯</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E8%87%AA%E6%97%8B%E9%94%81"><span class="nav-text">äºŒã€è‡ªæ—‹é”</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%87%AA%E6%97%8B%E9%94%81"><span class="nav-text">1. ä»€ä¹ˆæ˜¯è‡ªæ—‹é”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">1.1 è‡ªæ—‹é”çš„åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">1.2 è‡ªæ—‹é”çš„å®ç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%9F%AD%E6%97%B6%E9%97%B4%E5%8A%A0%E9%94%81%E5%9C%BA%E6%99%AF%EF%BC%9F"><span class="nav-text">2. çŸ­æ—¶é—´åŠ é”åœºæ™¯ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8EAPI"><span class="nav-text">3. ç›¸å…³æ•°æ®ç»“æ„ä¸API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-struct-spinlock"><span class="nav-text">3.1Â struct spinlock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%87%AA%E6%97%8B%E9%94%81%E7%9B%B8%E5%85%B3-API"><span class="nav-text">3.2Â è‡ªæ—‹é”ç›¸å…³ API  </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%94%81"><span class="nav-text">4. å…¶ä»–ç±»å‹çš„é”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E8%AF%BB%E5%86%99%E8%87%AA%E6%97%8B%E9%94%81"><span class="nav-text">4.1 è¯»å†™è‡ªæ—‹é”</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">4.1.1 åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">4.1.2 æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-3-%E7%9B%B8%E5%85%B3API"><span class="nav-text">4.1.3 ç›¸å…³API</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E9%A1%BA%E5%BA%8F%E9%94%81"><span class="nav-text">4.2Â é¡ºåºé”  </span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">4.2.1 åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">4.2.2 æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-3-%E7%9B%B8%E5%85%B3API"><span class="nav-text">4.2.3 ç›¸å…³API</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-text">5. æ­»é”é—®é¢˜ï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81"><span class="nav-text">5.1 ä»€ä¹ˆæ˜¯æ­»é”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2"><span class="nav-text">5.2 è¿›ç¨‹åˆ‡æ¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81"><span class="nav-text">5.3 è‡ªæ—‹é”çš„æ­»é”</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-1-%E6%83%85%E5%86%B5%E4%B8%80"><span class="nav-text">5.3.1 æƒ…å†µä¸€</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-2-%E6%83%85%E5%86%B5%E4%BA%8C"><span class="nav-text">5.3.2 æƒ…å†µäºŒ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">6. æ³¨æ„äº‹é¡¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E8%87%AA%E6%97%8B%E9%94%81demo"><span class="nav-text">7. è‡ªæ—‹é”demo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8%E7%9A%84demo1"><span class="nav-text">7.1 æ­£å¸¸ä½¿ç”¨çš„demo1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-1-demo%E6%BA%90%E7%A0%81"><span class="nav-text">7.1.1 demoæºç </span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#7-1-1-1-sdriver-demo-c"><span class="nav-text">7.1.1.1 sdriver_demo.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-1-1-2-app-demo-c"><span class="nav-text">7.1.1.2 app_demo.c</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-2-%E5%BC%80%E5%8F%91%E6%9D%BF%E9%AA%8C%E8%AF%81"><span class="nav-text">7.1.2 å¼€å‘æ¿éªŒè¯</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8%E7%9A%84demo2"><span class="nav-text">7.2 æ­£å¸¸ä½¿ç”¨çš„demo2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-demo%E6%BA%90%E7%A0%81"><span class="nav-text">7.2.1 demoæºç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-%E5%BC%80%E5%8F%91%E6%9D%BF%E9%AA%8C%E8%AF%81"><span class="nav-text">7.2.2 å¼€å‘æ¿éªŒè¯</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E6%AD%BB%E9%94%81%E7%9A%84demo"><span class="nav-text">7.3 æ­»é”çš„demo</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-1-demo%E6%BA%90%E7%A0%81"><span class="nav-text">7.3.1 demoæºç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-2-%E5%BC%80%E5%8F%91%E6%9D%BF%E9%AA%8C%E8%AF%81"><span class="nav-text">7.3.2 å¼€å‘æ¿éªŒè¯</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-text">ä¸‰ã€ä¿¡å·é‡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-text">1. ä»€ä¹ˆæ˜¯ä¿¡å·é‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="nav-text">1.1 ä¸€ä¸ªä¾‹å­</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-text">1.2 ä¿¡å·é‡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-text">2. ä¿¡å·é‡çš„ç‰¹ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8EAPI-1"><span class="nav-text">3. ç›¸å…³æ•°æ®ç»“æ„ä¸API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-struct-semaphore"><span class="nav-text">3.1Â struct semaphore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E7%9B%B8%E5%85%B3API"><span class="nav-text">3.2 ç›¸å…³API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">3.3 ä½¿ç”¨ç¤ºä¾‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E4%BF%A1%E5%8F%B7%E9%87%8Fdemo"><span class="nav-text">4. ä¿¡å·é‡demo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-demo%E6%BA%90%E7%A0%81"><span class="nav-text">4.1 demoæºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%BC%80%E5%8F%91%E6%9D%BF%E9%AA%8C%E8%AF%81"><span class="nav-text">4.2 å¼€å‘æ¿éªŒè¯</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-text">å››ã€äº’æ–¥é”</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-text">1. ä»€ä¹ˆæ˜¯äº’æ–¥é”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8EAPI-1"><span class="nav-text">2. ç›¸å…³æ•°æ®ç»“æ„ä¸API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-struct-mutex"><span class="nav-text">2.1Â struct mutex</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E4%BA%92%E6%96%A5%E9%94%81%E7%9B%B8%E5%85%B3API"><span class="nav-text">2.2 äº’æ–¥é”ç›¸å…³API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">2.3 ä½¿ç”¨ç¤ºä¾‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">3. æ³¨æ„äº‹é¡¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E4%BA%92%E6%96%A5%E9%94%81demo"><span class="nav-text">4. äº’æ–¥é”demo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-demo%E6%BA%90%E7%A0%81-1"><span class="nav-text">4.1 demoæºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%BC%80%E5%8F%91%E6%9D%BF%E9%AA%8C%E8%AF%81-1"><span class="nav-text">4.2 å¼€å‘æ¿éªŒè¯</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="è‹æœ¨"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">è‹æœ¨</p>
  <div class="site-description" itemprop="description">è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">673</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/sumumm" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;sumumm" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sumumm.github.io/post/4af1eda3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="è‹æœ¨">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹æœ¨">
      <meta itemprop="description" content="è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="LV06-06-å¹¶å‘ä¸ç«äº‰-02-å¹¶å‘æ§åˆ¶ | è‹æœ¨">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LV06-06-å¹¶å‘ä¸ç«äº‰-02-å¹¶å‘æ§åˆ¶
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-01-24 23:59:53" itemprop="dateCreated datePublished" datetime="2025-01-24T23:59:53+08:00">2025-01-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">åµŒå…¥å¼å¼€å‘</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">02IMX6ULLå¹³å°</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">LV06-é©±åŠ¨å¼€å‘</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>15k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>55 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>æ€ä¹ˆä¿æŠ¤å…±äº«èµ„æºï¼Œé˜²æ­¢ç«äº‰ï¼Ÿè‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚</p>
<span id="more"></span>

<!-- Photo: https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/ -->

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ä½¿ç”¨å·¥å…·åŠç‰ˆæœ¬ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center" rowspan="5">PCç«¯å¼€å‘ç¯å¢ƒ</td>        <td align="center" width=150px>Windows</td>        <td align="left">Windows11</td>    </tr>    <tr>        <td align="center">Ubuntu</td>        <td align="left">Ubuntu20.04.2çš„64ä½ç‰ˆæœ¬</td>      </tr>    <tr>        <td align="center">VMwareÂ® Workstation 17 Pro</td>        <td align="left">17.6.0 build-24238078</td>      </tr>    <tr>        <td align="center">ç»ˆç«¯è½¯ä»¶</td>        <td align="left">MobaXterm(Professional Edition v23.0 Build 5042 (license))</td>    </tr>    <tr>        <td align="center">Win32DiskImager</td>        <td align="left">Win32DiskImager v1.0</td>      </tr>    <tr>        <td align="center" rowspan="3">Linuxå¼€å‘æ¿ç¯å¢ƒ</td>        <td align="center">Linuxå¼€å‘æ¿</td>        <td align="left">æ­£ç‚¹åŸå­ i.MX6ULL Linux é˜¿å°”æ³•å¼€å‘æ¿</td>      </tr>    <tr>        <td align="center">uboot</td>        <td align="left">NXPå®˜æ–¹æä¾›çš„ubootï¼Œä½¿ç”¨çš„ubootç‰ˆæœ¬ä¸ºU-Boot 2019.04</td>      </tr>    <tr>        <td align="center">linuxå†…æ ¸</td>        <td align="left">linux-4.19.71(NXPå®˜æ–¹æä¾›)</td>      </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹æœ¬æ–‡å‚è€ƒèµ„æ–™ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center">åˆ†ç±»</td>        <td align="center">ç½‘å€</td>        <td align="center">è¯´æ˜</td>    </tr>    <tr>        <td align="center" rowspan="5">å®˜æ–¹ç½‘ç«™</td>        <td align="left"><a href="https://www.arm.com/" target="_blank">https://www.arm.com/</a></td>        <td align="left">ARMå®˜æ–¹ç½‘ç«™ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°Cotex-Mxä»¥åŠARMVxçš„ä¸€äº›æ–‡æ¡£</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxp.com.cn/" target="_blank">https://www.nxp.com.cn/ </a></td>        <td align="left">NXPå®˜æ–¹ç½‘ç«™</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxpic.org.cn/" target="_blank">https://www.nxpic.org.cn/</a></td><td align="left">NXP å®˜æ–¹ç¤¾åŒº</td>    </tr>    <tr>        <td align="left"><a href="https://u-boot.readthedocs.io/en/latest/" target="_blank">https://u-boot.readthedocs.io/en/latest/</a></td><td align="left">u-bootå®˜ç½‘</td>    </tr>    <tr>        <td align="left"><a href="https://www.kernel.org/" target="_blank">https://www.kernel.org/</a></td><td align="left">linuxå†…æ ¸å®˜ç½‘</td>    </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ç›¸å…³æ–‡ä»¶ä¸‹è½½ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center">åˆ†ç±»</td>        <td align="center">ç½‘å€</td>        <td align="center">è¯´æ˜</td>    </tr>    <tr>        <td align="center" rowspan="3">NXP</td>        <td align="left"><a href="https://github.com/nxp-imx" target="_blank">https://github.com/nxp-imx</a></td>        <td align="left">NXP imxå¼€å‘èµ„æºGitHubç»„ç»‡ï¼Œé‡Œè¾¹ä¼šæœ‰u-bootå’Œlinuxå†…æ ¸çš„ä»“åº“</td>    </tr>    <tr>        <td align="left"><a href="https://github.com/nxp-imx/linux-imx/releases/tag/v4.19.71" target="_blank">nxp-imx/linux-imx/releases/tag/v4.19.71</a></td>        <td align="left">NXP linuxå†…æ ¸ä»“åº“tagsä¸­çš„v4.19.71</td>    </tr>    <tr>        <td align="left"><a href="https://github.com/nxp-imx/uboot-imx/releases/tag/rel_imx_4.19.35_1.1.0" target="_blank">nxp-imx/uboot-imx/releases/tag/rel_imx_4.19.35_1.1.0</a></td>        <td align="left">NXP u-bootä»“åº“tagsä¸­çš„rel_imx_4.19.35_1.1.0</td>    </tr>    <tr>        <td align="center" rowspan="2">I.MX6ULL</td>        <td align="left"><a href="https://www.nxp.com.cn/docs/en/data-sheet/IMX6ULLIEC.pdf" target="_blank">i.MX 6ULL Applications Processors for Industrial Products</a></td>        <td align="left">I.MX6ULL èŠ¯ç‰‡æ‰‹å†Œï¼ˆdatasheetï¼Œå¯ä»¥åœ¨çº¿æŸ¥çœ‹ï¼‰</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh" target="_blank">i.MX 6ULL Applications ProcessorReference Manual</a></td>        <td align="left">I.MX6ULL å‚è€ƒæ‰‹å†Œï¼ˆä¸‹è½½åæ‰èƒ½æŸ¥çœ‹ï¼Œéœ€è¦ç™»å½•NXPå®˜ç½‘ï¼‰</td>    </tr>    <tr>        <td align="center" rowspan="3">Source Code</td>        <td align="left"><a href="https://elixir.bootlin.com/linux/latest/source" target="_blank">https://elixir.bootlin.com/linux/latest/source</a></td>        <td align="left">linux kernelæºç </td>    </tr>    <tr>        <td align="left"><a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/?h=v4.19.71&id=e7d2672c66e4d3675570369bf20856296da312c4" target="_blank">kernel/git/stable/linux.git - Linux kernel stable tree</a></td>        <td align="left">linux kernelæºç (å®˜ç½‘,tag 4.19.71)</td>    </tr>    <tr>        <td align="left"><a href="https://elixir.bootlin.com/u-boot/latest/source" target="_blank">https://elixir.bootlin.com/u-boot/latest/source</a></td>        <td align="left">ubootæºç </td>    </tr></table>
              </div>
            </details>

<h1 id="ä¸€ã€åŸå­æ“ä½œ"><a href="#ä¸€ã€åŸå­æ“ä½œ" class="headerlink" title="ä¸€ã€åŸå­æ“ä½œ"></a><font size=3>ä¸€ã€åŸå­æ“ä½œ</font></h1><h2 id="1-ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ"><a href="#1-ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ" class="headerlink" title="1. ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ"></a><font size=3>1. ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ</font></h2><p>â€œåŸå­â€ æ˜¯åŒ–å­¦ä¸–ç•Œä¸­ä¸å¯å†åˆ†çš„æœ€å°å¾®ç²’ï¼Œ ä¸€åˆ‡ç‰©è´¨éƒ½ç”±åŸå­ç»„æˆã€‚ åœ¨ Linux å†…æ ¸ä¸­çš„åŸå­æ“ä½œå¯ä»¥ç†è§£ä¸ºâ€œä¸å¯è¢«æ‹†åˆ†çš„æ“ä½œâ€ ï¼Œ å°±æ˜¯ä¸èƒ½è¢«æ›´é«˜ç­‰çº§ä¸­æ–­æŠ¢å¤ºä¼˜å…ˆçš„æ“ä½œã€‚   </p>
<p>ä¸€èˆ¬åŸå­æ“ä½œç”¨äºå˜é‡æˆ–è€…ä½æ“ä½œã€‚å‡å¦‚ç°åœ¨è¦å¯¹æ— ç¬¦å·æ•´å½¢å˜é‡ a èµ‹å€¼ï¼Œå€¼ä¸º 3ï¼Œå¯¹äº C è¯­è¨€æ¥è®²å¾ˆç®€å•ï¼Œç›´æ¥å°±æ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ C è¯­è¨€è¦å…ˆç¼–è¯‘ä¸ºæˆæ±‡ç¼–æŒ‡ä»¤ï¼Œ ARM æ¶æ„ä¸æ”¯æŒç›´æ¥å¯¹å¯„å­˜å™¨è¿›è¡Œè¯»å†™æ“ä½œï¼Œæ¯”å¦‚è¦å€ŸåŠ©å¯„å­˜å™¨ R0ã€ R1 ç­‰æ¥å®Œæˆèµ‹å€¼æ“ä½œã€‚å‡è®¾å˜é‡ a çš„åœ°å€ä¸º 0X3000000ï¼Œâ€œa&#x3D;3â€è¿™ä¸€è¡Œ Cè¯­è¨€å¯èƒ½ä¼šè¢«ç¼–è¯‘ä¸ºå¦‚ä¸‹æ‰€ç¤ºçš„æ±‡ç¼–ä»£ç ï¼š  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ldr r0, =0X30000000 /* å˜é‡ a åœ°å€ */</span><br><span class="line">ldr r1, = 3         /* è¦å†™å…¥çš„å€¼ */</span><br><span class="line">str r1, [r0]        /* å°† 3 å†™å…¥åˆ° a å˜é‡ä¸­ */</span><br></pre></td></tr></table></figure>

<p>åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¸¾ä¾‹è¯´æ˜ï¼Œå®é™…çš„ç»“æœè¦æ¯”ç¤ºä¾‹ä»£ç å¤æ‚çš„å¤šã€‚ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ C è¯­è¨€é‡Œé¢ç®€ç®€å•å•çš„ä¸€å¥â€œa&#x3D;3â€ï¼Œç¼–è¯‘æˆæ±‡ç¼–æ–‡ä»¶ä»¥åå˜æˆäº† 3 å¥ï¼Œé‚£ä¹ˆç¨‹åºåœ¨æ‰§è¡Œçš„æ—¶å€™è‚¯å®šæ˜¯æŒ‰ç…§æ±‡ç¼–è¯­å¥ä¸€æ¡ä¸€æ¡çš„æ‰§è¡Œã€‚å‡è®¾ç°åœ¨çº¿ç¨‹ Aè¦å‘ a å˜é‡å†™å…¥ 10 è¿™ä¸ªå€¼ï¼Œè€Œçº¿ç¨‹ B ä¹Ÿè¦å‘ a å˜é‡å†™å…¥ 20 è¿™ä¸ªå€¼ï¼Œæˆ‘ä»¬ç†æƒ³ä¸­çš„æ‰§è¡Œé¡ºåºå¦‚å›¾æ‰€ç¤ºï¼š  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250121105044537.png" alt="image-20250121105044537"  />

<p>æŒ‰ç…§ä¸Šå›¾æ‰€ç¤ºçš„æµç¨‹ï¼Œç¡®å®å¯ä»¥å®ç°çº¿ç¨‹ A å°† a å˜é‡è®¾ç½®ä¸º 10ï¼Œçº¿ç¨‹ B å°† a å˜é‡è®¾ç½®ä¸º 20ã€‚ä½†æ˜¯å®é™…ä¸Šçš„æ‰§è¡Œæµç¨‹å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250121105204784.png" alt="image-20250121105204784"  />

<p>æŒ‰ç…§å›¾è¿™ä¸ªå›¾æ‰€ç¤ºçš„æµç¨‹ï¼Œçº¿ç¨‹ A æœ€ç»ˆå°†å˜é‡ a è®¾ç½®ä¸ºäº† 20ï¼Œè€Œå¹¶ä¸æ˜¯è¦æ±‚çš„ 10ï¼çº¿ç¨‹B æ²¡æœ‰é—®é¢˜ã€‚è¿™å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„è®¾ç½®å˜é‡å€¼çš„å¹¶å‘ä¸ç«äº‰çš„ä¾‹å­ï¼Œè¦è§£å†³è¿™ä¸ªé—®é¢˜å°±<strong>è¦ä¿è¯é‚£ä¸‰è¡Œæ±‡ç¼–æŒ‡ä»¤ä½œä¸ºä¸€ä¸ªæ•´ä½“è¿è¡Œï¼Œä¹Ÿå°±æ˜¯ä½œä¸ºä¸€ä¸ªåŸå­å­˜åœ¨</strong>ã€‚</p>
<h2 id="2-ç›¸å…³æ•°æ®ç»“æ„ä¸API"><a href="#2-ç›¸å…³æ•°æ®ç»“æ„ä¸API" class="headerlink" title="2. ç›¸å…³æ•°æ®ç»“æ„ä¸API"></a><font size=3>2. ç›¸å…³æ•°æ®ç»“æ„ä¸API</font></h2><p>Linux å†…æ ¸æä¾›äº†ä¸€ç»„åŸå­æ“ä½œ API å‡½æ•°æ¥å®Œæˆæ­¤åŠŸèƒ½ï¼Œ Linux å†…æ ¸æä¾›äº†ä¸¤ç»„åŸå­æ“ä½œ API å‡½æ•°ï¼Œä¸€ç»„æ˜¯å¯¹æ•´å½¢å˜é‡è¿›è¡Œæ“ä½œçš„ï¼Œä¸€ç»„æ˜¯å¯¹ä½è¿›è¡Œæ“ä½œçš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹è¿™äº› API å‡½æ•°å’Œç›¸å…³çš„æ•°æ®ç»“æ„ã€‚ </p>
<h3 id="2-1-atomic-t"><a href="#2-1-atomic-t" class="headerlink" title="2.1Â atomic_t"></a><font size=3>2.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/types.h#L178">atomic_t</a></font></h3><p>åœ¨ Linux å†…æ ¸ä¸­ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/types.h#L178">atomic_t</a> å’Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/types.h#L181">atomic64_t</a> ç»“æ„ä½“åˆ†åˆ«æ¥å®Œæˆ 32 ä½ç³»ç»Ÿå’Œ 64 ä½ç³»ç»Ÿçš„<strong>æ•´å½¢æ•°æ®åŸå­æ“ä½œ</strong>ï¼Œ ä¸¤ä¸ªç»“æ„ä½“å®šä¹‰åœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/types.h#L181">types.h - include&#x2F;linux&#x2F;types.h</a> æ–‡ä»¶ä¸­  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">int</span> counter;</span><br><span class="line">&#125; <span class="type">atomic_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">long</span> counter;</span><br><span class="line">&#125; <span class="type">atomic64_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-åŸå­æ•´å½¢æ“ä½œAPI"><a href="#2-2-åŸå­æ•´å½¢æ“ä½œAPI" class="headerlink" title="2.2 åŸå­æ•´å½¢æ“ä½œAPI"></a><font size=3>2.2 åŸå­æ•´å½¢æ“ä½œAPI</font></h3><p>å¦‚æœè¦ä½¿ç”¨åŸå­æ“ä½œ API å‡½æ•°ï¼Œé¦–å…ˆè¦å…ˆå®šä¹‰ä¸€ä¸ª atomic_t çš„å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤º ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">atomic_t</span> a; <span class="comment">// å®šä¹‰ a</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥åœ¨å®šä¹‰åŸå­å˜é‡çš„æ—¶å€™ç»™åŸå­å˜é‡èµ‹åˆå€¼ï¼Œå¦‚ä¸‹æ‰€ç¤º :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">atomic_t</span> b = ATOMIC_INIT(<span class="number">0</span>); <span class="comment">//å®šä¹‰åŸå­å˜é‡ b å¹¶èµ‹åˆå€¼ä¸º 0</span></span><br></pre></td></tr></table></figure>

<p>åŸå­å˜é‡æœ‰äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹åŸå­å˜é‡è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚è¯»ã€å†™ã€å¢åŠ ã€å‡å°‘ç­‰ç­‰ï¼Œ Linux å†…æ ¸æä¾›äº†å¤§é‡çš„åŸå­æ“ä½œ API å‡½æ•°ï¼Œå…¶å®è¿™äº›å¤§éƒ¨åˆ†éƒ½æ˜¯å®ï¼š</p>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>ATOMIC_INIT(int i)</td>
<td>å®šä¹‰åŸå­å˜é‡çš„æ—¶å€™å¯¹å…¶åˆå§‹åŒ–ï¼Œ èµ‹å€¼ä¸º i</td>
</tr>
<tr>
<td>int atomic_read(atomic_t *v)</td>
<td>è¯»å– v çš„å€¼ï¼Œ å¹¶ä¸”è¿”å›ã€‚</td>
</tr>
<tr>
<td>void atomic_set(atomic_t *v, int i)</td>
<td>å‘åŸå­å˜é‡ v å†™å…¥ i å€¼ã€‚</td>
</tr>
<tr>
<td>void atomic_add(int i, atomic_t *v)</td>
<td>åŸå­å˜é‡ v åŠ ä¸Š i å€¼ã€‚</td>
</tr>
<tr>
<td>void atomic_sub(int i, atomic_t *v)</td>
<td>åŸå­å˜é‡ v å‡å» i å€¼ã€‚</td>
</tr>
<tr>
<td>void atomic_inc(atomic_t *v)</td>
<td>åŸå­å˜é‡ v åŠ  1</td>
</tr>
<tr>
<td>void atomic_dec(atomic_t *v)</td>
<td>åŸå­å˜é‡ v å‡ 1</td>
</tr>
<tr>
<td>int atomic_dec_return(atomic_t *v)</td>
<td>åŸå­å˜é‡ v å‡ 1ï¼Œ å¹¶è¿”å› v çš„å€¼ã€‚</td>
</tr>
<tr>
<td>int atomic_inc_return(atomic_t *v)</td>
<td>åŸå­å˜é‡ v åŠ  1ï¼Œ å¹¶è¿”å› v çš„å€¼ã€‚</td>
</tr>
<tr>
<td>int atomic_sub_and_test(int i, atomic_t *v)</td>
<td>åŸå­å˜é‡ v å‡ iï¼Œ å¦‚æœç»“æœä¸º 0 å°±è¿”å›çœŸï¼Œ å¦åˆ™è¿”å›å‡</td>
</tr>
<tr>
<td>int atomic_dec_and_test(atomic_t *v)</td>
<td>åŸå­å˜é‡ v å‡ 1ï¼Œ å¦‚æœç»“æœä¸º 0 å°±è¿”å›çœŸï¼Œ å¦åˆ™è¿”å›å‡</td>
</tr>
<tr>
<td>int atomic_inc_and_test(atomic_t *v)</td>
<td>åŸå­å˜é‡ v åŠ  1ï¼Œ å¦‚æœç»“æœä¸º 0 å°±è¿”å›çœŸï¼Œ å¦åˆ™è¿”å›å‡</td>
</tr>
<tr>
<td>int atomic_add_negative(int i, atomic_t *v)</td>
<td>åŸå­å˜é‡ v åŠ  iï¼Œ å¦‚æœç»“æœä¸ºè´Ÿå°±è¿”å›çœŸï¼Œ å¦åˆ™è¿”å›</td>
</tr>
</tbody></table>
<blockquote>
<p>è¿™äº›éƒ½åˆ†æ•£å®šä¹‰åœ¨è¿™äº›å¤´æ–‡ä»¶ï¼Œå®ƒä»¬æ˜¯ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/atomic.h">atomic.h - include&#x2F;linux&#x2F;atomic.h</a></p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/asm-generic/atomic.h">atomic.h - include&#x2F;asm-generic&#x2F;atomic.h</a></p>
</blockquote>
<p>ç›¸åº”çš„ä¹Ÿæä¾›äº† 64 ä½åŸå­å˜é‡çš„æ“ä½œ API å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸è¯¦ç»†äº†è§£ï¼Œå’Œä¸Šè¡¨ä¸­çš„ API å‡½æ•°æœ‰ç”¨æ³•ä¸€æ ·ï¼Œåªæ˜¯å°†â€œatomic_â€å‰ç¼€æ¢ä¸ºâ€œatomic64_â€ï¼Œå°† int æ¢ä¸º long longã€‚å¦‚æœä½¿ç”¨çš„æ˜¯ 64 ä½çš„ SOCï¼Œé‚£ä¹ˆå°±è¦ä½¿ç”¨ 64 ä½çš„åŸå­æ“ä½œå‡½æ•°ã€‚åŸå­å˜é‡å’Œç›¸åº”çš„ API å‡½æ•°ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œå‚è€ƒå¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">atomic_t</span> v = ATOMIC_INIT(<span class="number">0</span>); <span class="comment">/* å®šä¹‰å¹¶åˆå§‹åŒ–åŸå­å˜é›¶ v=0 */</span></span><br><span class="line"><span class="type">atomic_set</span>(&amp;v, <span class="number">10</span>);          <span class="comment">/* è®¾ç½® v=10 */</span></span><br><span class="line"><span class="type">atomic_read</span>(&amp;v);             <span class="comment">/* è¯»å– v çš„å€¼ï¼Œè‚¯å®šæ˜¯ 10 */</span></span><br><span class="line"><span class="type">atomic_inc</span>(&amp;v);              <span class="comment">/* v çš„å€¼åŠ  1ï¼Œ v=11 */</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-åŸå­ä½æ“ä½œ-API"><a href="#2-3-åŸå­ä½æ“ä½œ-API" class="headerlink" title="2.3Â åŸå­ä½æ“ä½œ API  "></a><font size=3>2.3Â åŸå­ä½æ“ä½œ API  </font></h3><p>ä½æ“ä½œä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„æ“ä½œï¼Œ Linux å†…æ ¸ä¹Ÿæä¾›äº†ä¸€ç³»åˆ—çš„åŸå­ä½æ“ä½œ API å‡½æ•°ï¼Œåªä¸è¿‡åŸå­ä½æ“ä½œä¸åƒåŸå­æ•´å½¢å˜é‡é‚£æ ·æœ‰ä¸ª atomic_t çš„æ•°æ®ç»“æ„ï¼ŒåŸå­ä½æ“ä½œæ˜¯ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œï¼Œ API å‡½æ•°å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>void set_bit(int nr, void *p)</td>
<td>å°† p åœ°å€çš„ç¬¬ nr ä½ç½® 1ã€‚</td>
</tr>
<tr>
<td>void clear_bit(int nr,void *p)</td>
<td>å°† p åœ°å€çš„ç¬¬ nr ä½æ¸…é›¶ã€‚</td>
</tr>
<tr>
<td>void change_bit(int nr, void *p)</td>
<td>å°† p åœ°å€çš„ç¬¬ nr ä½è¿›è¡Œç¿»è½¬ã€‚</td>
</tr>
<tr>
<td>int test_bit(int nr, void *p)</td>
<td>è·å– p åœ°å€çš„ç¬¬ nr ä½çš„å€¼ã€‚</td>
</tr>
<tr>
<td>int test_and_set_bit(int nr, void *p)</td>
<td>å°† p åœ°å€çš„ç¬¬ nr ä½ç½® 1ï¼Œå¹¶ä¸”è¿”å› nr ä½åŸæ¥çš„å€¼ã€‚</td>
</tr>
<tr>
<td>int test_and_clear_bit(int nr, void *p)</td>
<td>å°† p åœ°å€çš„ç¬¬ nr ä½æ¸…é›¶ï¼Œå¹¶ä¸”è¿”å› nr ä½åŸæ¥çš„å€¼ã€‚</td>
</tr>
<tr>
<td>int test_and_change_bit(int nr, void *p)</td>
<td>å°† p åœ°å€çš„ç¬¬ nr ä½ç¿»è½¬ï¼Œå¹¶ä¸”è¿”å› nr ä½åŸæ¥çš„å€¼ã€‚</td>
</tr>
</tbody></table>
<blockquote>
<p>Tipsï¼š</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/asm-generic/bitops/atomic.h#L14">atomic.h - include&#x2F;asm-generic&#x2F;bitops&#x2F;atomic.h</a></p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/asm-generic/bitops/non-atomic.h#L104">non-atomic.h - include&#x2F;asm-generic&#x2F;bitops&#x2F;non-atomic.h</a></p>
</blockquote>
<h2 id="3-åŸå­æ“ä½œdemo"><a href="#3-åŸå­æ“ä½œdemo" class="headerlink" title="3. åŸå­æ“ä½œdemo"></a><font size=3>3. åŸå­æ“ä½œdemo</font></h2><h3 id="3-1-demoæºç "><a href="#3-1-demoæºç " class="headerlink" title="3.1 demoæºç "></a><font size=3>3.1 demoæºç </font></h3><p>åœ¨ xxx_open()å‡½æ•°å’Œ xxx_release()å‡½æ•°ä¸­åŠ å…¥åŸå­æ•´å½¢å˜é‡ v çš„èµ‹å€¼ä»£ç ï¼Œ å¹¶ä¸”åœ¨ open()å‡½æ•°ä¸­åŠ å…¥åŸå­æ•´å½¢å˜é‡ v çš„åˆ¤æ–­ä»£ç ï¼Œ ä»è€Œå®ç°åŒä¸€æ—¶é—´å†…åªå…è®¸ä¸€ä¸ªåº”ç”¨æ‰“å¼€è¯¥è®¾å¤‡èŠ‚ç‚¹ï¼Œ ä»¥æ­¤æ¥é˜²æ­¢å…±äº«èµ„æºç«äº‰çš„äº§ç”Ÿã€‚  </p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/tree/master/07_concurrency/03_atomic">07_concurrency&#x2F;03_atomic Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<h3 id="3-2-å¼€å‘æ¿éªŒè¯"><a href="#3-2-å¼€å‘æ¿éªŒè¯" class="headerlink" title="3.2 å¼€å‘æ¿éªŒè¯"></a><font size=3>3.2 å¼€å‘æ¿éªŒè¯</font></h3><p>æˆ‘ä»¬å°†ç¼–è¯‘å¾—åˆ°çš„sdriver_demo.koã€app_demo.outæ‹·è´åˆ°å¼€å‘æ¿ã€‚</p>
<ul>
<li>ï¼ˆ1ï¼‰åŠ è½½é©±åŠ¨</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insmod sdriver_demo.ko</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122095804419.png" alt="image-20250122095804419"  />

<ul>
<li>ï¼ˆ2ï¼‰1ä¸ªåº”ç”¨ç¨‹åºè®¿é—® è®¾å¤‡èŠ‚ç‚¹</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./app_demo.out /dev/sdevchr 2 0 sumu1</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122100058803.png" alt="image-20250122100058803"  />

<p>åœ¨opençš„æ—¶å€™ï¼ŒåŸå­å˜é‡å˜ä¸º0ï¼Œåœ¨releaseçš„æ—¶å€™ï¼ŒåŸå­å˜é‡çš„å€¼æ¢å¤åˆ°1ã€‚</p>
<ul>
<li>ï¼ˆ3ï¼‰2ä¸ªåº”ç”¨ç¨‹åºè®¿é—® è®¾å¤‡èŠ‚ç‚¹</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./app_demo.out /dev/sdevchr 2 0 sumu1 &amp;</span><br><span class="line">./app_demo.out /dev/sdevchr 2 0 sumu2 &amp;</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122100356113.png" alt="image-20250122100356113"  />

<p>å¯ä»¥çœ‹åˆ°åº”ç”¨ç¨‹åºåœ¨æ‰“å¼€ç¬¬äºŒæ¬¡ &#x2F;dev&#x2F;sdevchr æ–‡ä»¶çš„æ—¶å€™ï¼Œ å‡ºç°äº†â€œcanâ€™t open file &#x2F;dev&#x2F;sdevchr !â€æ‰“å°ï¼Œ è¯æ˜æ–‡ä»¶æ‰“å¼€å¤±è´¥ï¼Œ åªæœ‰åœ¨ç¬¬ä¸€ä¸ªåº”ç”¨å…³é—­ç›¸åº”çš„æ–‡ä»¶ä¹‹åï¼Œ ä¸‹ä¸€ä¸ªåº”ç”¨æ‰èƒ½æ‰“å¼€ï¼Œ é€šè¿‡é™åˆ¶åŒä¸€æ—¶é—´å†…è®¾å¤‡è®¿é—®æ•°é‡ï¼Œ æ¥å¯¹å…±äº«èµ„æºè¿›è¡Œä¿æŠ¤ã€‚  </p>
<h1 id="äºŒã€è‡ªæ—‹é”"><a href="#äºŒã€è‡ªæ—‹é”" class="headerlink" title="äºŒã€è‡ªæ—‹é”"></a><font size=3>äºŒã€è‡ªæ—‹é”</font></h1><h2 id="1-ä»€ä¹ˆæ˜¯è‡ªæ—‹é”"><a href="#1-ä»€ä¹ˆæ˜¯è‡ªæ—‹é”" class="headerlink" title="1. ä»€ä¹ˆæ˜¯è‡ªæ—‹é”"></a><font size=3>1. ä»€ä¹ˆæ˜¯è‡ªæ—‹é”</font></h2><h3 id="1-1-è‡ªæ—‹é”çš„åŸºæœ¬æ¦‚å¿µ"><a href="#1-1-è‡ªæ—‹é”çš„åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="1.1 è‡ªæ—‹é”çš„åŸºæœ¬æ¦‚å¿µ"></a><font size=3>1.1 è‡ªæ—‹é”çš„åŸºæœ¬æ¦‚å¿µ</font></h3><p>åŸå­æ“ä½œåªèƒ½å¯¹æ•´å½¢å˜é‡æˆ–è€…ä½è¿›è¡Œä¿æŠ¤ï¼Œä½†æ˜¯ï¼Œåœ¨å®é™…çš„ä½¿ç”¨ç¯å¢ƒä¸­æ€ä¹ˆå¯èƒ½åªæœ‰æ•´å½¢å˜é‡æˆ–ä½è¿™ä¹ˆç®€å•çš„ä¸´ç•ŒåŒºå‘¢ï¼Ÿ</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œè®¾å¤‡ç»“æ„ä½“å˜é‡å°±ä¸æ˜¯æ•´å‹å˜é‡ï¼Œæˆ‘ä»¬å¯¹äºç»“æ„ä½“ä¸­æˆå‘˜å˜é‡çš„æ“ä½œä¹Ÿè¦ä¿è¯åŸå­æ€§ï¼Œåœ¨çº¿ç¨‹ A å¯¹ç»“æ„ä½“å˜é‡ä½¿ç”¨æœŸé—´ï¼Œåº”è¯¥ç¦æ­¢å…¶ä»–çš„çº¿ç¨‹æ¥è®¿é—®æ­¤ç»“æ„ä½“å˜é‡ï¼Œè¿™äº›å·¥ä½œåŸå­æ“ä½œéƒ½ä¸èƒ½èƒœä»»ï¼Œè¿™ä¸ªæ—¶å€™æ€ä¹ˆåŠï¼Ÿè¿™å°±åˆ°äº†è¿™ä¸€éƒ¨åˆ†è¦å­¦ä¹ çš„è‡ªæ—‹é”äº†ã€‚  </p>
<p>è‡ªæ—‹é”æ˜¯ä¸ºäº†ä¿æŠ¤å…±äº«èµ„æºæå‡ºçš„ä¸€ç§é”æœºåˆ¶ã€‚ è‡ªæ—‹é”ï¼ˆspin lockï¼‰ æ˜¯ä¸€ç§éé˜»å¡é”ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ å¦‚æœæŸçº¿ç¨‹éœ€è¦è·å–é”ï¼Œ ä½†è¯¥é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹å ç”¨æ—¶ï¼Œ è¯¥çº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·ï¼Œ è€Œæ˜¯åœ¨ä¸æ–­çš„æ¶ˆè€— CPU èµ„æºï¼Œ ä¸åœçš„è¯•å›¾è·å–é”ã€‚  </p>
<blockquote>
<p>ä¹Ÿå°±æ˜¯ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¦è®¿é—®æŸä¸ªå…±äº«èµ„æºçš„æ—¶å€™é¦–å…ˆè¦å…ˆè·å–ç›¸åº”çš„é”ï¼Œ é”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåªè¦æ­¤çº¿ç¨‹ä¸é‡Šæ”¾æŒæœ‰çš„é”ï¼Œé‚£ä¹ˆå…¶ä»–çš„çº¿ç¨‹å°±ä¸èƒ½è·å–æ­¤é”ã€‚å¯¹äºè‡ªæ—‹é”è€Œè¨€ï¼Œå¦‚æœè‡ªæ—‹é”æ­£åœ¨è¢«çº¿ç¨‹ A æŒæœ‰ï¼Œçº¿ç¨‹ B æƒ³è¦è·å–è‡ªæ—‹é”ï¼Œé‚£ä¹ˆçº¿ç¨‹ B å°±ä¼šå¤„äºå¿™ <strong>å¾ªç¯-æ—‹è½¬-ç­‰å¾…</strong> çŠ¶æ€ï¼Œçº¿ç¨‹ B ä¸ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€æˆ–è€…è¯´å»åšå…¶ä»–çš„å¤„ç†ï¼Œè€Œæ˜¯ä¼šä¸€ç›´å‚»å‚»çš„åœ¨é‚£é‡Œâ€œè½¬åœˆåœˆâ€çš„ç­‰å¾…é”å¯ç”¨ã€‚</p>
</blockquote>
<p>æ¯”å¦‚ç°åœ¨æœ‰ä¸ªå…¬ç”¨ç”µè¯äº­ï¼Œä¸€æ¬¡è‚¯å®šåªèƒ½è¿›å»ä¸€ä¸ªäººæ‰“ç”µè¯ï¼Œç°åœ¨ç”µè¯äº­é‡Œé¢æœ‰äººæ­£åœ¨æ‰“ç”µè¯ï¼Œç›¸å½“äºè·å¾—äº†è‡ªæ—‹é”ã€‚æ­¤æ—¶æˆ‘ä»¬åˆ°äº†ç”µè¯äº­é—¨å£ï¼Œå› ä¸ºé‡Œé¢æœ‰äººï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½è¿›å»æ‰“ç”µè¯ï¼Œç›¸å½“äºæ²¡æœ‰è·å–è‡ªæ—‹é”ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è‚¯å®šæ˜¯ç«™åœ¨åŸåœ°ç­‰å¾…ï¼Œæˆ‘ä»¬å¯èƒ½å› ä¸ºæ— èŠçš„ç­‰å¾…è€Œè½¬åœˆåœˆæ¶ˆé£æ—¶å…‰ï¼Œåæ­£å°±æ˜¯å“ªé‡Œä¹Ÿä¸èƒ½å»ï¼Œè¦ä¸€ç›´ç­‰åˆ°é‡Œé¢çš„äººæ‰“å®Œç”µè¯å‡ºæ¥ã€‚ç»ˆäºï¼Œé‡Œé¢çš„äººæ‰“å®Œç”µè¯å‡ºæ¥äº†ï¼Œç›¸å½“äºé‡Šæ”¾äº†è‡ªæ—‹é”ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ç”µè¯äº­æ‰“ç”µè¯äº†ï¼Œç›¸å½“äºè·å–åˆ°äº†è‡ªæ—‹é”ã€‚</p>
<h3 id="1-2-è‡ªæ—‹é”çš„å®ç°"><a href="#1-2-è‡ªæ—‹é”çš„å®ç°" class="headerlink" title="1.2 è‡ªæ—‹é”çš„å®ç°"></a><font size=3>1.2 è‡ªæ—‹é”çš„å®ç°</font></h3><p> linuxä¸Šçš„è‡ªæ—‹é”æœ‰ä¸‰ç§å®ç°ï¼š</p>
<ul>
<li>ï¼ˆ1ï¼‰åœ¨å•cpuï¼Œä¸å¯æŠ¢å å†…æ ¸ä¸­ï¼Œè‡ªæ—‹é”ä¸ºç©ºæ“ä½œã€‚</li>
<li>ï¼ˆ2ï¼‰åœ¨å•cpuï¼Œå¯æŠ¢å å†…æ ¸ä¸­ï¼Œè‡ªæ—‹é”å®ç°ä¸ºâ€œç¦æ­¢å†…æ ¸æŠ¢å â€ï¼Œå¹¶ä¸å®ç°â€œè‡ªæ—‹â€ã€‚</li>
<li>ï¼ˆ3ï¼‰åœ¨å¤šcpuï¼Œå¯æŠ¢å å†…æ ¸ä¸­ï¼Œè‡ªæ—‹é”å®ç°ä¸ºâ€œç¦æ­¢å†…æ ¸æŠ¢å â€ + â€œè‡ªæ—‹â€ã€‚</li>
</ul>
<h2 id="2-çŸ­æ—¶é—´åŠ é”åœºæ™¯ï¼Ÿ"><a href="#2-çŸ­æ—¶é—´åŠ é”åœºæ™¯ï¼Ÿ" class="headerlink" title="2. çŸ­æ—¶é—´åŠ é”åœºæ™¯ï¼Ÿ"></a><font size=3>2. çŸ­æ—¶é—´åŠ é”åœºæ™¯ï¼Ÿ</font></h2><p>åœ¨æœ‰äº›åœºæ™¯ä¸­ï¼Œ åŒæ­¥èµ„æº(ç”¨æ¥ä¿æŒä¸€è‡´æ€§çš„ä¸¤ä¸ªæˆ–å¤šä¸ªèµ„æº)çš„é”å®šæ—¶é—´å¾ˆçŸ­ï¼Œ ä¸ºäº†è¿™ä¸€å°æ®µæ—¶é—´å»åˆ‡æ¢çº¿ç¨‹ï¼Œ çº¿ç¨‹æŒ‚èµ·å’Œæ¢å¤ç°åœºçš„èŠ±è´¹å¯èƒ½ä¼šè®©ç³»ç»Ÿå¾—ä¸å¿å¤±ã€‚ å¦‚æœè®¡ç®—æœºæœ‰å¤šä¸ªCPU æ ¸å¿ƒï¼Œ èƒ½å¤Ÿè®©ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„çº¿ç¨‹åŒæ—¶å¹¶è¡Œæ‰§è¡Œï¼Œ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è®©åé¢é‚£ä¸ªè¯·æ±‚é”çš„çº¿ç¨‹ä¸æ”¾å¼ƒ CPU çš„æ‰§è¡Œæ—¶é—´ï¼Œ ç›´åˆ°æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œ åé¢è¯·æ±‚é”çš„çº¿ç¨‹æ‰å¯ä»¥è·å–é”ã€‚  </p>
<p>ä¸ºäº†è®©åé¢é‚£ä¸ªè¯·æ±‚é”çš„çº¿ç¨‹â€œç¨ç­‰ä¸€ä¸‹â€ï¼Œ æˆ‘ä»¬éœ€è®©å®ƒè¿›è¡Œè‡ªæ—‹ï¼Œ å¦‚æœåœ¨è‡ªæ—‹å®Œæˆåå‰é¢é”å®šåŒæ­¥èµ„æºçš„çº¿ç¨‹å·²ç»é‡Šæ”¾äº†é”ï¼Œ é‚£ä¹ˆè¯¥çº¿ç¨‹ä¾¿ä¸å¿…é˜»å¡ï¼Œ å¹¶ä¸”ç›´æ¥è·å–åŒæ­¥èµ„æºï¼Œ ä»è€Œé¿å…åˆ‡æ¢çº¿ç¨‹çš„å¼€é”€ã€‚ è¿™å°±æ˜¯è‡ªæ—‹é”ã€‚   </p>
<p>ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è‡ªæ—‹é”çš„ä¸€ä¸ªç¼ºç‚¹ï¼šé‚£å°±ç­‰å¾…è‡ªæ—‹é”çš„çº¿ç¨‹ä¼šä¸€ç›´å¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œè¿™æ ·ä¼šæµªè´¹å¤„ç†å™¨æ—¶é—´ï¼Œé™ä½ç³»ç»Ÿæ€§èƒ½ï¼Œ<strong>æ‰€ä»¥è‡ªæ—‹é”çš„æŒæœ‰æ—¶é—´ä¸èƒ½å¤ªé•¿</strong>ã€‚è‡ªæ—‹é”é€‚ç”¨äºçŸ­æ—¶æœŸçš„è½»é‡çº§åŠ é”ï¼Œå¦‚æœé‡åˆ°éœ€è¦é•¿æ—¶é—´æŒæœ‰é”çš„åœºæ™¯é‚£å°±éœ€è¦æ¢å…¶ä»–çš„æ–¹æ³•äº†ï¼Œæˆ‘ä»¬åé¢å†è¯´ã€‚</p>
<h2 id="3-ç›¸å…³æ•°æ®ç»“æ„ä¸API"><a href="#3-ç›¸å…³æ•°æ®ç»“æ„ä¸API" class="headerlink" title="3. ç›¸å…³æ•°æ®ç»“æ„ä¸API"></a><font size=3>3. ç›¸å…³æ•°æ®ç»“æ„ä¸API</font></h2><h3 id="3-1-struct-spinlock"><a href="#3-1-struct-spinlock" class="headerlink" title="3.1Â struct spinlock"></a><font size=3>3.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/spinlock_types.h#L61">struct spinlock</a></font></h3><p>Linux å†…æ ¸ä½¿ç”¨ç»“æ„ä½“ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/spinlock_types.h#L61">struct spinlock</a> è¡¨ç¤ºè‡ªæ—‹é”ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">raw_spinlock</span> <span class="title">rlock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> LOCK_PADSIZE (offsetof(struct raw_spinlock, dep_map))</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			u8 __padding[LOCK_PADSIZE];</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">dep_map</span>;</span></span><br><span class="line">		&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125; <span class="type">spinlock_t</span>;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä½¿ç”¨è‡ªæ—‹é”ä¹‹å‰ï¼Œè‚¯å®šè¦å…ˆå®šä¹‰ä¸€ä¸ªè‡ªæ—‹é”å˜é‡ï¼Œå®šä¹‰æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">spinlock_t</span> lock; <span class="comment">// å®šä¹‰è‡ªæ—‹é”</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-è‡ªæ—‹é”ç›¸å…³-API"><a href="#3-2-è‡ªæ—‹é”ç›¸å…³-API" class="headerlink" title="3.2Â è‡ªæ—‹é”ç›¸å…³ API  "></a><font size=3>3.2Â è‡ªæ—‹é”ç›¸å…³ API  </font></h3><p>è‡ªæ—‹é”ç›¸å…³å‡½æ•°å®šä¹‰åœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/spinlock.h">spinlock.h - include&#x2F;linux&#x2F;spinlock.h</a> ï¼š</p>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>DEFINE_SPINLOCK(spinlock_t lock)</td>
<td>å®šä¹‰å¹¶åˆå§‹åŒ–ä¸€ä¸ªè‡ªé€‰å˜é‡ã€‚</td>
</tr>
<tr>
<td>int spin_lock_init(spinlock_t *lock)</td>
<td>åˆå§‹åŒ–è‡ªæ—‹é”ã€‚</td>
</tr>
<tr>
<td>void spin_lock(spinlock_t *lock)</td>
<td>è·å–æŒ‡å®šçš„è‡ªæ—‹é”ï¼Œä¹Ÿå«åšåŠ é”ã€‚</td>
</tr>
<tr>
<td>void spin_unlock(spinlock_t *lock)</td>
<td>é‡Šæ”¾æŒ‡å®šçš„è‡ªæ—‹é”ã€‚</td>
</tr>
<tr>
<td>int spin_trylock(spinlock_t *lock)</td>
<td>å°è¯•è·å–æŒ‡å®šçš„è‡ªæ—‹é”ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°å°±è¿”å› 0</td>
</tr>
<tr>
<td>int spin_is_locked(spinlock_t *lock)</td>
<td>æ£€æŸ¥æŒ‡å®šçš„è‡ªæ—‹é”æ˜¯å¦è¢«è·å–ï¼Œå¦‚æœæ²¡æœ‰è¢«è·å–å°±è¿”å›é 0ï¼Œå¦åˆ™è¿”å› 0ã€‚</td>
</tr>
</tbody></table>
<p>è¡¨ä¸­çš„è‡ªæ—‹é”APIå‡½æ•°é€‚ç”¨äºSMPæˆ–æ”¯æŒæŠ¢å çš„å•CPUä¸‹çº¿ç¨‹ä¹‹é—´çš„å¹¶å‘è®¿é—®ï¼Œä¹Ÿå°±æ˜¯ç”¨äºçº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´ï¼Œè¢«è‡ªæ—‹é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºä¸€å®šä¸èƒ½è°ƒç”¨ä»»ä½•èƒ½å¤Ÿå¼•èµ·ç¡çœ å’Œé˜»å¡çš„API å‡½æ•°ï¼Œå¦åˆ™çš„è¯ä¼šå¯èƒ½ä¼šå¯¼è‡´<strong>æ­»é”</strong>ç°è±¡çš„å‘ç”Ÿã€‚</p>
<h2 id="4-å…¶ä»–ç±»å‹çš„é”"><a href="#4-å…¶ä»–ç±»å‹çš„é”" class="headerlink" title="4. å…¶ä»–ç±»å‹çš„é”"></a><font size=3>4. å…¶ä»–ç±»å‹çš„é”</font></h2><p>åœ¨è‡ªæ—‹é”çš„åŸºç¡€ä¸Šè¿˜è¡ç”Ÿå‡ºäº†å…¶ä»–ç‰¹å®šåœºåˆä½¿ç”¨çš„é”ï¼Œè¿™äº›é”åœ¨é©±åŠ¨ä¸­å…¶å®ç”¨çš„ä¸å¤šï¼Œæ›´å¤šçš„æ˜¯åœ¨ Linux å†…æ ¸ä¸­ä½¿ç”¨ã€‚</p>
<h3 id="4-1-è¯»å†™è‡ªæ—‹é”"><a href="#4-1-è¯»å†™è‡ªæ—‹é”" class="headerlink" title="4.1 è¯»å†™è‡ªæ—‹é”"></a><font size=3>4.1 è¯»å†™è‡ªæ—‹é”</font></h3><h4 id="4-1-1-åŸºæœ¬æ¦‚å¿µ"><a href="#4-1-1-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="4.1.1 åŸºæœ¬æ¦‚å¿µ"></a><font size=3>4.1.1 åŸºæœ¬æ¦‚å¿µ</font></h4><p>ç°åœ¨æœ‰ä¸ªå­¦ç”Ÿä¿¡æ¯è¡¨ï¼Œæ­¤è¡¨å­˜æ”¾ç€å­¦ç”Ÿçš„å¹´é¾„ã€å®¶åº­ä½å€ã€ç­çº§ç­‰ä¿¡æ¯ï¼Œæ­¤è¡¨å¯ä»¥éšæ—¶è¢«ä¿®æ”¹å’Œè¯»å–ã€‚æ­¤è¡¨è‚¯å®šæ˜¯æ•°æ®ï¼Œé‚£ä¹ˆå¿…é¡»è¦å¯¹å…¶è¿›è¡Œä¿æŠ¤ï¼Œå¦‚æœæˆ‘ä»¬ç°åœ¨ä½¿ç”¨è‡ªæ—‹é”å¯¹å…¶è¿›è¡Œä¿æŠ¤ã€‚æ¯æ¬¡åªèƒ½ä¸€ä¸ªè¯»æ“ä½œæˆ–è€…å†™æ“ä½œï¼Œä½†æ˜¯ï¼Œå®é™…ä¸Šæ­¤è¡¨æ˜¯å¯ä»¥å¹¶å‘è¯»å–çš„ã€‚åªéœ€è¦ä¿è¯åœ¨ä¿®æ”¹æ­¤è¡¨çš„æ—¶å€™æ²¡äººè¯»å–ï¼Œæˆ–è€…åœ¨å…¶ä»–äººè¯»å–æ­¤è¡¨çš„æ—¶å€™æ²¡æœ‰äººä¿®æ”¹æ­¤è¡¨å°±è¡Œäº†ã€‚ä¹Ÿå°±æ˜¯æ­¤è¡¨çš„è¯»å’Œå†™ä¸èƒ½åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯å¯ä»¥å¤šäººå¹¶å‘çš„è¯»å–æ­¤è¡¨ã€‚åƒè¿™æ ·ï¼Œå½“æŸä¸ªæ•°æ®ç»“æ„ç¬¦åˆè¯»&#x2F;å†™æˆ–ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…æ¨¡å‹çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¯»å†™è‡ªæ—‹é”ã€‚  </p>
<p>è¯»å†™è‡ªæ—‹é”ä¸ºè¯»å’Œå†™æ“ä½œæä¾›äº†ä¸åŒçš„é”ï¼Œä¸€æ¬¡åªèƒ½å…è®¸ä¸€ä¸ªå†™æ“ä½œï¼Œä¹Ÿå°±æ˜¯åªèƒ½ä¸€ä¸ªçº¿ç¨‹æŒæœ‰å†™é”ï¼Œè€Œä¸”ä¸èƒ½è¿›è¡Œè¯»æ“ä½œã€‚ä½†æ˜¯å½“æ²¡æœ‰å†™æ“ä½œçš„æ—¶å€™å…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æŒæœ‰è¯»é”ï¼Œå¯ä»¥è¿›è¡Œå¹¶å‘çš„è¯»æ“ä½œã€‚</p>
<h4 id="4-1-2-æ•°æ®ç»“æ„"><a href="#4-1-2-æ•°æ®ç»“æ„" class="headerlink" title="4.1.2 æ•°æ®ç»“æ„"></a><font size=3>4.1.2 æ•°æ®ç»“æ„</font></h4><p>Linux å†…æ ¸ä½¿ç”¨  <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/rwlock_types.h#L20">rwlock_t</a> ç»“æ„ä½“è¡¨ç¤ºè¯»å†™é”ï¼Œç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">arch_rwlock_t</span> raw_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SPINLOCK</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> magic, owner_cpu;</span><br><span class="line">	<span class="type">void</span> *owner;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">dep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; <span class="type">rwlock_t</span>;</span><br></pre></td></tr></table></figure>

<h4 id="4-1-3-ç›¸å…³API"><a href="#4-1-3-ç›¸å…³API" class="headerlink" title="4.1.3 ç›¸å…³API"></a><font size=3>4.1.3 ç›¸å…³API</font></h4><p>è¯»å†™é”æ“ä½œ API å‡½æ•°åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ç»™è¯»ä½¿ç”¨çš„ï¼Œä¸€ä¸ªæ˜¯ç»™å†™ä½¿ç”¨çš„ï¼Œè¿™äº› API å‡½æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆå§‹åŒ–</li>
</ul>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>DEFINE_RWLOCK(rwlock_t lock)</td>
<td>å®šä¹‰å¹¶åˆå§‹åŒ–è¯»å†™é”</td>
</tr>
<tr>
<td>void rwlock_init(rwlock_t *lock)</td>
<td>åˆå§‹åŒ–è¯»å†™é”ã€‚</td>
</tr>
</tbody></table>
<ul>
<li>è¯»é”</li>
</ul>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>void read_lock(rwlock_t *lock)</td>
<td>è·å–è¯»é”ã€‚</td>
</tr>
<tr>
<td>void read_unlock(rwlock_t *lock)</td>
<td>é‡Šæ”¾è¯»é”ã€‚</td>
</tr>
<tr>
<td>void read_lock_irq(rwlock_t *lock)</td>
<td>ç¦æ­¢æœ¬åœ°ä¸­æ–­ï¼Œå¹¶ä¸”è·å–è¯»é”ã€‚</td>
</tr>
<tr>
<td>void read_unlock_irq(rwlock_t *lock)</td>
<td>æ‰“å¼€æœ¬åœ°ä¸­æ–­ï¼Œå¹¶ä¸”é‡Šæ”¾è¯»é”ã€‚</td>
</tr>
<tr>
<td>void read_lock_irqsave(rwlock_t *lock, unsigned long flags)</td>
<td>ä¿å­˜ä¸­æ–­çŠ¶æ€ï¼Œç¦æ­¢æœ¬åœ°ä¸­æ–­ï¼Œå¹¶è·å–è¯»é”ã€‚</td>
</tr>
<tr>
<td>void read_unlock_irqrestore(rwlock_t *lock, unsigned long flags)</td>
<td>å°†ä¸­æ–­çŠ¶æ€æ¢å¤åˆ°ä»¥å‰çš„çŠ¶æ€ï¼Œå¹¶ä¸”æ¿€æ´»æœ¬åœ°ä¸­æ–­ï¼Œé‡Šæ”¾è¯»é”ã€‚</td>
</tr>
<tr>
<td>void read_lock_bh(rwlock_t *lock)</td>
<td>å…³é—­ä¸‹åŠéƒ¨ï¼Œå¹¶è·å–è¯»é”ã€‚</td>
</tr>
<tr>
<td>void read_unlock_bh(rwlock_t *lock)</td>
<td>æ‰“å¼€ä¸‹åŠéƒ¨ï¼Œå¹¶é‡Šæ”¾è¯»é”ã€‚</td>
</tr>
</tbody></table>
<ul>
<li>å†™é”</li>
</ul>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>void write_lock(rwlock_t *lock)</td>
<td>è·å–å†™é”ã€‚</td>
</tr>
<tr>
<td>void write_unlock(rwlock_t *lock)</td>
<td>é‡Šæ”¾å†™é”ã€‚</td>
</tr>
<tr>
<td>void write_lock_irq(rwlock_t *lock)</td>
<td>ç¦æ­¢æœ¬åœ°ä¸­æ–­ï¼Œå¹¶ä¸”è·å–å†™é”ã€‚</td>
</tr>
<tr>
<td>void write_unlock_irq(rwlock_t *lock)</td>
<td>æ‰“å¼€æœ¬åœ°ä¸­æ–­ï¼Œå¹¶ä¸”é‡Šæ”¾å†™é”ã€‚</td>
</tr>
<tr>
<td>void write_lock_irqsave(rwlock_t *lock, unsigned long flags)</td>
<td>ä¿å­˜ä¸­æ–­çŠ¶æ€ï¼Œç¦æ­¢æœ¬åœ°ä¸­æ–­ï¼Œå¹¶è·å–å†™é”ã€‚</td>
</tr>
<tr>
<td>void write_unlock_irqrestore(rwlock_t *lock, unsigned long flags)</td>
<td>å°†ä¸­æ–­çŠ¶æ€æ¢å¤åˆ°ä»¥å‰çš„çŠ¶æ€ï¼Œå¹¶ä¸”æ¿€æ´»æœ¬åœ°ä¸­æ–­ï¼Œé‡Šæ”¾è¯»é”ã€‚</td>
</tr>
<tr>
<td>void write_lock_bh(rwlock_t *lock)</td>
<td>å…³é—­ä¸‹åŠéƒ¨ï¼Œå¹¶è·å–è¯»é”ã€‚</td>
</tr>
<tr>
<td>void write_unlock_bh(rwlock_t *lock)</td>
<td>æ‰“å¼€ä¸‹åŠéƒ¨ï¼Œå¹¶é‡Šæ”¾è¯»é”ã€‚</td>
</tr>
</tbody></table>
<h3 id="4-2-é¡ºåºé”"><a href="#4-2-é¡ºåºé”" class="headerlink" title="4.2Â é¡ºåºé”  "></a><font size=3>4.2Â é¡ºåºé”  </font></h3><h4 id="4-2-1-åŸºæœ¬æ¦‚å¿µ"><a href="#4-2-1-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="4.2.1 åŸºæœ¬æ¦‚å¿µ"></a><font size=3>4.2.1 åŸºæœ¬æ¦‚å¿µ</font></h4><p>é¡ºåºé”åœ¨è¯»å†™é”çš„åŸºç¡€ä¸Šè¡ç”Ÿè€Œæ¥çš„ï¼Œä½¿ç”¨è¯»å†™é”çš„æ—¶å€™è¯»æ“ä½œå’Œå†™æ“ä½œä¸èƒ½åŒæ—¶è¿›è¡Œã€‚ä½¿ç”¨é¡ºåºé”çš„è¯å¯ä»¥å…è®¸åœ¨å†™çš„æ—¶å€™è¿›è¡Œè¯»æ“ä½œï¼Œä¹Ÿå°±æ˜¯å®ç°åŒæ—¶è¯»å†™ï¼Œä½†æ˜¯ä¸å…è®¸åŒæ—¶è¿›è¡Œå¹¶å‘çš„å†™æ“ä½œã€‚è™½ç„¶é¡ºåºé”çš„è¯»å’Œå†™æ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯å¦‚æœåœ¨è¯»çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†å†™æ“ä½œï¼Œæœ€å¥½é‡æ–°è¿›è¡Œè¯»å–ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§ã€‚é¡ºåºé”ä¿æŠ¤çš„èµ„æºä¸èƒ½æ˜¯æŒ‡é’ˆï¼Œå› ä¸ºå¦‚æœåœ¨å†™æ“ä½œçš„æ—¶å€™å¯èƒ½ä¼šå¯¼è‡´æŒ‡é’ˆæ— æ•ˆï¼Œè€Œè¿™ä¸ªæ—¶å€™æ°å·§æœ‰è¯»æ“ä½œè®¿é—®æŒ‡é’ˆçš„è¯å°±å¯èƒ½å¯¼è‡´æ„å¤–å‘ç”Ÿï¼Œæ¯”å¦‚è¯»å–é‡æŒ‡é’ˆå¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚   </p>
<h4 id="4-2-2-æ•°æ®ç»“æ„"><a href="#4-2-2-æ•°æ®ç»“æ„" class="headerlink" title="4.2.2 æ•°æ®ç»“æ„"></a><font size=3>4.2.2 æ•°æ®ç»“æ„</font></h4><p>Linux å†…æ ¸ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/seqlock.h#L407">seqlock_t</a>ç»“æ„ä½“è¡¨ç¤ºé¡ºåºé” ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">seqcount</span> <span class="title">seqcount</span>;</span></span><br><span class="line">	<span class="type">spinlock_t</span> lock;</span><br><span class="line">&#125; <span class="type">seqlock_t</span>;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-3-ç›¸å…³API"><a href="#4-2-3-ç›¸å…³API" class="headerlink" title="4.2.3 ç›¸å…³API"></a><font size=3>4.2.3 ç›¸å…³API</font></h4><ul>
<li>åˆå§‹åŒ–</li>
</ul>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>DEFINE_SEQLOCK(seqlock_t sl)</td>
<td>å®šä¹‰å¹¶åˆå§‹åŒ–é¡ºåºé”</td>
</tr>
<tr>
<td>void seqlock_ini seqlock_t *sl)</td>
<td>åˆå§‹åŒ–é¡ºåºé”ã€‚</td>
</tr>
</tbody></table>
<ul>
<li>é¡ºåºå†™æ“ä½œ</li>
</ul>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>void write_seqlock(seqlock_t *sl)</td>
<td>è·å–å†™é¡ºåºé”ã€‚</td>
</tr>
<tr>
<td>void write_sequnlock(seqlock_t *sl)</td>
<td>é‡Šæ”¾å†™é¡ºåºé”ã€‚</td>
</tr>
<tr>
<td>void write_seqlock_irq(seqlock_t *sl)</td>
<td>ç¦æ­¢æœ¬åœ°ä¸­æ–­ï¼Œå¹¶ä¸”è·å–å†™é¡ºåºé”</td>
</tr>
<tr>
<td>void write_sequnlock_irq(seqlock_t *sl)</td>
<td>æ‰“å¼€æœ¬åœ°ä¸­æ–­ï¼Œå¹¶ä¸”é‡Šæ”¾å†™é¡ºåºé”ã€‚</td>
</tr>
<tr>
<td>void write_seqlock_irqsave(seqlock_t *sl, unsigned long flags)</td>
<td>ä¿å­˜ä¸­æ–­çŠ¶æ€ï¼Œç¦æ­¢æœ¬åœ°ä¸­æ–­ï¼Œå¹¶è·å–å†™é¡ºåºé”ã€‚</td>
</tr>
<tr>
<td>void write_sequnlock_irqrestore(seqlock_t *sl, unsigned long flags)</td>
<td>å°†ä¸­æ–­çŠ¶æ€æ¢å¤åˆ°ä»¥å‰çš„çŠ¶æ€ï¼Œå¹¶ä¸”æ¿€æ´»æœ¬åœ°ä¸­æ–­ï¼Œé‡Šæ”¾å†™é¡ºåºé”ã€‚</td>
</tr>
<tr>
<td>void write_seqlock_bh(seqlock_t *sl)</td>
<td>å…³é—­ä¸‹åŠéƒ¨ï¼Œå¹¶è·å–å†™è¯»é”ã€‚</td>
</tr>
<tr>
<td>void write_sequnlock_bh(seqlock_t *sl)</td>
<td>æ‰“å¼€ä¸‹åŠéƒ¨ï¼Œå¹¶é‡Šæ”¾å†™è¯»é”ã€‚</td>
</tr>
</tbody></table>
<ul>
<li>é¡ºåºè¯»æ“ä½œ</li>
</ul>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>unsigned read_seqbegin(const seqlock_t *sl)</td>
<td>è¯»å•å…ƒè®¿é—®å…±äº«èµ„æºçš„æ—¶å€™è°ƒç”¨æ­¤å‡½æ•°ï¼Œæ­¤å‡½æ•°ä¼šè¿”å›é¡ºåºé”çš„é¡ºåºå·ã€‚</td>
</tr>
<tr>
<td>unsigned read_seqretry(const seqlock_t *sl, unsigned start)</td>
<td>è¯»ç»“æŸä»¥åè°ƒç”¨æ­¤å‡½æ•°æ£€æŸ¥åœ¨è¯»çš„è¿‡ç¨‹ä¸­æœ‰æ²¡æœ‰å¯¹èµ„æºè¿›è¡Œå†™æ“ä½œï¼Œå¦‚æœæœ‰çš„è¯å°±è¦é‡è¯»</td>
</tr>
</tbody></table>
<h2 id="5-æ­»é”é—®é¢˜ï¼Ÿ"><a href="#5-æ­»é”é—®é¢˜ï¼Ÿ" class="headerlink" title="5. æ­»é”é—®é¢˜ï¼Ÿ"></a><font size=3>5. æ­»é”é—®é¢˜ï¼Ÿ</font></h2><h3 id="5-1-ä»€ä¹ˆæ˜¯æ­»é”"><a href="#5-1-ä»€ä¹ˆæ˜¯æ­»é”" class="headerlink" title="5.1 ä»€ä¹ˆæ˜¯æ­»é”"></a><font size=3>5.1 ä»€ä¹ˆæ˜¯æ­»é”</font></h3><p>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹ç‰©åœ¨åŒä¸€èµ„æºä¸Šç›¸äº’å ç”¨ï¼Œ å¹¶è¯·æ±‚é”å®šå¯¹æ–¹çš„èµ„æºï¼Œ ä»è€Œå¯¼è‡´æ¶æ€§å¾ªç¯çš„ç°è±¡ã€‚ å½“å¤šä¸ªè¿›ç¨‹å› ç«äº‰èµ„æºè€Œé€ æˆçš„ä¸€ç§åƒµå±€ï¼ˆäº’ç›¸ç­‰å¾…ï¼‰ ï¼Œ è‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œ è¿™äº›è¿›ç¨‹éƒ½å°†æ— æ³•å‘å‰æ¨è¿›ï¼Œ è¿™ç§æƒ…å†µå°±æ˜¯æ­»é”ã€‚  </p>
<h3 id="5-2-è¿›ç¨‹åˆ‡æ¢"><a href="#5-2-è¿›ç¨‹åˆ‡æ¢" class="headerlink" title="5.2 è¿›ç¨‹åˆ‡æ¢"></a><font size=3>5.2 è¿›ç¨‹åˆ‡æ¢</font></h3><ul>
<li>åœ¨éæŠ¢å å¼å†…æ ¸ä¸­ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹åœ¨å†…æ ¸æ€è¿è¡Œï¼Œå…¶åªæœ‰åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¼šè¢«åˆ‡æ¢ï¼š</li>
</ul>
<p>ï¼ˆ1ï¼‰å…¶è¿è¡Œå®Œæˆï¼ˆè¿”å›ç”¨æˆ·ç©ºé—´ï¼‰</p>
<p>ï¼ˆ2ï¼‰ä¸»åŠ¨è®©å‡ºcpuï¼ˆå³ä¸»åŠ¨è°ƒç”¨scheduleæˆ–å†…æ ¸ä¸­çš„ä»»åŠ¡é˜»å¡â€”â€”è¿™åŒæ ·ä¹Ÿä¼šå¯¼è‡´è°ƒç”¨scheduleï¼‰</p>
<ul>
<li>åœ¨æŠ¢å å¼å†…æ ¸ä¸­ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹åœ¨å†…æ ¸æ€è¿è¡Œï¼Œå…¶åªæœ‰åœ¨ä»¥ä¸‹å››ç§æƒ…å†µä¼šè¢«åˆ‡æ¢ï¼š</li>
</ul>
<p>ï¼ˆ1ï¼‰å…¶è¿è¡Œå®Œæˆï¼ˆè¿”å›ç”¨æˆ·ç©ºé—´ï¼‰</p>
<p>ï¼ˆ2ï¼‰ä¸»åŠ¨è®©å‡ºcpuï¼ˆå³ä¸»åŠ¨è°ƒç”¨scheduleæˆ–å†…æ ¸ä¸­çš„ä»»åŠ¡é˜»å¡â€”â€”è¿™åŒæ ·ä¹Ÿä¼šå¯¼è‡´è°ƒç”¨scheduleï¼‰</p>
<p>ï¼ˆ3ï¼‰å½“ä»ä¸­æ–­å¤„ç†ç¨‹åºæ­£åœ¨æ‰§è¡Œï¼Œä¸”è¿”å›å†…æ ¸ç©ºé—´ä¹‹å‰ï¼ˆæ­¤æ—¶å¯æŠ¢å æ ‡å¿—premptcounté¡»ä¸º0ï¼‰ ã€‚</p>
<p>ï¼ˆ4ï¼‰å½“å†…æ ¸ä»£ç å†ä¸€æ¬¡å…·æœ‰å¯æŠ¢å æ€§çš„æ—¶å€™ï¼Œå¦‚è§£é”åŠä½¿èƒ½è½¯ä¸­æ–­ç­‰ã€‚</p>
<blockquote>
<p>ç¦æ­¢å†…æ ¸æŠ¢å åªæ˜¯å…³é—­â€œå¯æŠ¢å æ ‡å¿—â€ï¼Œè€Œä¸æ˜¯ç¦æ­¢è¿›ç¨‹åˆ‡æ¢ã€‚æ˜¾å¼ä½¿ç”¨scheduleæˆ–è¿›ç¨‹é˜»å¡ï¼ˆæ­¤ä¹Ÿä¼šå¯¼è‡´è°ƒç”¨scheduleï¼‰æ—¶ï¼Œè¿˜æ˜¯ä¼šå‘ç”Ÿè¿›ç¨‹è°ƒåº¦çš„ã€‚</p>
</blockquote>
<h3 id="5-3-è‡ªæ—‹é”çš„æ­»é”"><a href="#5-3-è‡ªæ—‹é”çš„æ­»é”" class="headerlink" title="5.3 è‡ªæ—‹é”çš„æ­»é”"></a><font size=3>5.3 è‡ªæ—‹é”çš„æ­»é”</font></h3><h4 id="5-3-1-æƒ…å†µä¸€"><a href="#5-3-1-æƒ…å†µä¸€" class="headerlink" title="5.3.1 æƒ…å†µä¸€"></a><font size=3>5.3.1 æƒ…å†µä¸€</font></h4><p>å¯¹äºå¤šæ ¸æŠ¢å ä¸å¤šæ ¸éæŠ¢å çš„æƒ…å†µï¼Œåœ¨ä½¿ç”¨è‡ªæ—‹é”æ—¶ï¼Œå…¶æƒ…å†µåŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚å› ä¸ºåœ¨å¤šæ ¸æŠ¢å çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨è‡ªæ—‹é”ä¼šç¦æ­¢å†…æ ¸æŠ¢å ï¼Œè¿™æ ·å¤šæ ¸æŠ¢å å°±ç›¸å½“äºå¤šæ ¸éæŠ¢å çš„æƒ…å†µã€‚</p>
<p>è‡ªæ—‹é”ä¼šè‡ªåŠ¨ç¦æ­¢æŠ¢å ï¼Œä¹Ÿå°±è¯´å½“çº¿ç¨‹ Aå¾—åˆ°é”ä»¥åä¼šæš‚æ—¶ç¦æ­¢å†…æ ¸æŠ¢å ã€‚å¦‚æœçº¿ç¨‹ A åœ¨æŒæœ‰é”æœŸé—´è¿›å…¥äº†ä¼‘çœ çŠ¶æ€ï¼Œé‚£ä¹ˆè¿›ç¨‹ A ä¼šè‡ªåŠ¨æ”¾å¼ƒ CPU ä½¿ç”¨æƒã€‚è¿›ç¨‹ B å¼€å§‹è¿è¡Œï¼Œè¿›ç¨‹ B ä¹Ÿæƒ³è¦è·å–é”ï¼Œä½†æ˜¯æ­¤æ—¶é”è¢« A è¿›ç¨‹æŒæœ‰ï¼Œè€Œä¸”å†…æ ¸æŠ¢å è¿˜è¢«ç¦æ­¢äº†ï¼è¿›ç¨‹ B æ— æ³•è¢«è°ƒåº¦å‡ºå»ï¼Œé‚£ä¹ˆè¿›ç¨‹ A å°±æ— æ³•è¿è¡Œï¼Œé”ä¹Ÿå°±æ— æ³•é‡Šæ”¾ï¼Œå¥½äº†ï¼Œæ­»é”å‘ç”Ÿäº†ï¼ å¦‚ä¸‹å›¾ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122103229395.png" alt="image-20250122103229395"  />

<blockquote>
<p>åœ¨å•cpuå†…æ ¸ä¸Šä¸ä¼šå‡ºç°ä¸Šè¿°æƒ…å†µï¼Œå› ä¸ºå•cpuä¸Šçš„è‡ªæ—‹é”å®é™…æ²¡æœ‰â€œè‡ªæ—‹åŠŸèƒ½â€ã€‚</p>
</blockquote>
<p>ç›¸åº”çš„è§£å†³åŠæ³•æ˜¯ï¼Œ åœ¨è‡ªæ—‹é”çš„ä½¿ç”¨è¿‡ç¨‹ä¸­è¦å°½å¯èƒ½çŸ­çš„æ—¶é—´å†…æ‹¥æœ‰è‡ªæ—‹é”ï¼Œ è€Œä¸”ä¸èƒ½åœ¨ä¸´ç•ŒåŒºä¸­è°ƒç”¨å¯¼è‡´çº¿ç¨‹ä¼‘çœ çš„å‡½æ•°ã€‚</p>
<h4 id="5-3-2-æƒ…å†µäºŒ"><a href="#5-3-2-æƒ…å†µäºŒ" class="headerlink" title="5.3.2 æƒ…å†µäºŒ"></a><font size=3>5.3.2 æƒ…å†µäºŒ</font></h4><p>ç¬¬äºŒç§æƒ…å†µæ˜¯è¿›ç¨‹ A æ‹¥æœ‰è‡ªæ—‹é”ï¼Œ ä¸­æ–­åˆ°æ¥ï¼Œ CPU æ‰§è¡Œä¸­æ–­å‡½æ•°ï¼Œ è¿›ç¨‹Aåˆ‡æ¢åˆ°ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œ åœ¨ä¸­æ–­å¤„ç†å‡½æ•°ä¸­åˆéœ€è¦è·å¾—è‡ªæ—‹é”ï¼Œ è®¿é—®å…±äº«èµ„æºï¼Œ æ­¤æ—¶ä¸­æ–­å¤„ç†å‡½æ•°æ— æ³•è·å¾—é”ï¼Œ åªèƒ½è‡ªæ—‹ï¼Œ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122103247395.png" alt="image-20250122103247395"  />

<p>å¯¹äºä¸­æ–­å¼•å‘çš„æ­»é”ï¼Œ æœ€å¥½çš„è§£å†³æ–¹æ³•å°±æ˜¯åœ¨è·å–é”ä¹‹å‰å…³é—­æœ¬åœ°ä¸­æ–­ï¼Œ Linux å†…æ ¸åœ¨  <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/spinlock.h">spinlock.h - include&#x2F;linux&#x2F;spinlock.h</a> æ–‡ä»¶ä¸­æä¾›äº†ç›¸åº”çš„ API å‡½æ•°  :</p>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>void spin_lock_irq(spinlock_t *lock)</td>
<td>ç¦æ­¢æœ¬åœ°ä¸­æ–­ï¼Œ å¹¶è·å–è‡ªæ—‹é”ã€‚</td>
</tr>
<tr>
<td>void spin_unlock_irq(spinlock_t *lock)</td>
<td>æ¿€æ´»æœ¬åœ°ä¸­æ–­ï¼Œ å¹¶é‡Šæ”¾è‡ªæ—‹é”ã€‚</td>
</tr>
<tr>
<td>void spin_lock_irqsave(spinlock_t *lock, unsigned long flags)</td>
<td>æ¢å¤ä¸­æ–­çŠ¶æ€ï¼Œ å…³é—­ä¸­æ–­å¹¶è·å–è‡ªæ—‹é”ã€‚</td>
</tr>
<tr>
<td>void spin_unlock_irqrestore(spinlock_t *lock, unsigned long flags)</td>
<td>å°†ä¸­æ–­çŠ¶æ€æ¢å¤åˆ°ä»¥å‰çš„çŠ¶æ€ï¼Œ æ‰“å¼€ä¸­æ–­å¹¶é‡Šæ”¾è‡ªæ—‹é”</td>
</tr>
<tr>
<td>void spin_lock_bh(spinlock_t *lock)</td>
<td>å…³é—­ä¸‹åŠéƒ¨ï¼Œ è·å–è‡ªæ—‹é”</td>
</tr>
<tr>
<td>void spin_unlock_bh(spinlock_t *lock)</td>
<td>æ‰“å¼€ä¸‹åŠéƒ¨ï¼Œ è·å–è‡ªæ—‹é”</td>
</tr>
</tbody></table>
<p>ç”±äº Linux å†…æ ¸è¿è¡Œæ˜¯éå¸¸å¤æ‚çš„ï¼Œ å¾ˆéš¾ç¡®å®šæŸä¸ªæ—¶åˆ»çš„ä¸­æ–­çŠ¶æ€ï¼Œ å› æ­¤å»ºè®®ä½¿ç”¨spin_lock_irqsave ã€spin_unlock_irqrestoreï¼Œ å› ä¸ºè¿™ä¸€ç»„å‡½æ•°ä¼šä¿å­˜ä¸­æ–­çŠ¶æ€ï¼Œ åœ¨é‡Šæ”¾é”çš„æ—¶å€™ä¼šæ¢å¤ä¸­æ–­çŠ¶æ€ã€‚  </p>
<h2 id="6-æ³¨æ„äº‹é¡¹"><a href="#6-æ³¨æ„äº‹é¡¹" class="headerlink" title="6. æ³¨æ„äº‹é¡¹"></a><font size=3>6. æ³¨æ„äº‹é¡¹</font></h2><p>â‘ ã€å› ä¸ºåœ¨ç­‰å¾…è‡ªæ—‹é”çš„æ—¶å€™å¤„äºâ€œè‡ªæ—‹â€çŠ¶æ€ï¼Œå› æ­¤é”çš„æŒæœ‰æ—¶é—´ä¸èƒ½å¤ªé•¿ï¼Œä¸€å®šè¦çŸ­ï¼Œå¦åˆ™çš„è¯ä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚å¦‚æœä¸´ç•ŒåŒºæ¯”è¾ƒå¤§ï¼Œè¿è¡Œæ—¶é—´æ¯”è¾ƒé•¿çš„è¯è¦é€‰æ‹©å…¶ä»–çš„å¹¶å‘å¤„ç†æ–¹å¼ï¼Œæ¯”å¦‚ç¨åè¦å­¦ä¹ çš„ä¿¡å·é‡å’Œäº’æ–¥ä½“ã€‚</p>
<p>â‘¡ã€è‡ªæ—‹é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºå†…ä¸èƒ½è°ƒç”¨ä»»ä½•å¯èƒ½å¯¼è‡´çº¿ç¨‹ä¼‘çœ çš„ API å‡½æ•°ï¼Œå¦åˆ™çš„è¯å¯èƒ½å¯¼è‡´æ­»é”ã€‚</p>
<p>â‘¢ã€ä¸èƒ½é€’å½’ç”³è¯·è‡ªæ—‹é”ï¼Œå› ä¸ºä¸€æ—¦é€šè¿‡é€’å½’çš„æ–¹å¼ç”³è¯·ä¸€ä¸ªæˆ‘ä»¬æ­£åœ¨æŒæœ‰çš„é”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¿…é¡»â€œè‡ªæ—‹â€ï¼Œç­‰å¾…é”è¢«é‡Šæ”¾ï¼Œç„¶è€Œæ­£å¤„äºâ€œè‡ªæ—‹â€çŠ¶æ€ï¼Œæ ¹æœ¬æ²¡æ³•é‡Šæ”¾é”ã€‚ç»“æœå°±æ˜¯è‡ªå·±æŠŠè‡ªå·±é”æ­»äº†ï¼</p>
<p>â‘£ã€åœ¨ç¼–å†™é©±åŠ¨ç¨‹åºçš„æ—¶å€™æˆ‘ä»¬å¿…é¡»è€ƒè™‘åˆ°é©±åŠ¨çš„å¯ç§»æ¤æ€§ï¼Œå› æ­¤ä¸ç®¡ç”¨çš„æ˜¯å•æ ¸çš„è¿˜æ˜¯å¤šæ ¸çš„ SOCï¼Œéƒ½å°†å…¶å½“åšå¤šæ ¸ SOC æ¥ç¼–å†™é©±åŠ¨ç¨‹åºã€‚</p>
<h2 id="7-è‡ªæ—‹é”demo"><a href="#7-è‡ªæ—‹é”demo" class="headerlink" title="7. è‡ªæ—‹é”demo"></a><font size=3>7. è‡ªæ—‹é”demo</font></h2><p>åŠ äº†é”ä¹‹åï¼Œå†…éƒ¨ä¼‘çœ å¤ªä¹…çš„è¯ï¼Œä¼šå¡æ­»å¹¶äº§ç”Ÿå´©æºƒï¼Œå´©æºƒåº”è¯¥æ˜¯æ­»é”å¯¼è‡´çš„ï¼Œä½†æ˜¯è¦æ˜¯æŠŠé”åŠ åœ¨å†…éƒ¨å¾ªç¯çš„åœ°æ–¹ï¼Œä¼šæœ‰ä¸ä¸€æ ·çš„æ•ˆæœï¼Œå¤§æ¦‚å¯ä»¥æ¼”ç¤ºè‡ªæ—‹é”çš„æ•ˆæœã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªæ­£å¸¸demoï¼Œä¸¤ä¸ªå¼‚å¸¸çš„demoï¼Œå¼‚å¸¸çš„ä¸¤ä¸ªå¯ä»¥å½“åšæ­»é”çš„å®ä¾‹ã€‚</p>
<h3 id="7-1-æ­£å¸¸ä½¿ç”¨çš„demo1"><a href="#7-1-æ­£å¸¸ä½¿ç”¨çš„demo1" class="headerlink" title="7.1 æ­£å¸¸ä½¿ç”¨çš„demo1"></a><font size=3>7.1 æ­£å¸¸ä½¿ç”¨çš„demo1</font></h3><h4 id="7-1-1-demoæºç "><a href="#7-1-1-demoæºç " class="headerlink" title="7.1.1 demoæºç "></a><font size=3>7.1.1 demoæºç </font></h4><h5 id="7-1-1-1-sdriver-demo-c"><a href="#7-1-1-1-sdriver-demo-c" class="headerlink" title="7.1.1.1 sdriver_demo.c"></a><font size=3>7.1.1.1 sdriver_demo.c</font></h5><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… </summary>
              <div class='content'>
              <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span> <span class="comment">/* module_init module_exit */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span> <span class="comment">/* MODULE_LICENSE */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span> <span class="comment">/* msleepç­‰å»¶æ—¶å‡½æ•° */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./timestamp_autogenerated.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./version_autogenerated.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./sdrv_common.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #undef PRT</span></span><br><span class="line"><span class="comment">// #undef PRTE</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PRT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRT printk</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PRTE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRTE printk</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHRDEV_NAME <span class="string">&quot;sdev&quot;</span>    <span class="comment">/* è®¾å¤‡å,cat /proc/devices æŸ¥çœ‹ä¸è®¾å¤‡å·çš„å¯¹åº”å…³ç³» */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLASS_NAME  <span class="string">&quot;sclass&quot;</span>  <span class="comment">/* ç±»åï¼Œåœ¨ /sys/class ä¸­æ˜¾ç¤ºçš„åç§° */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">&quot;sdevchr&quot;</span> <span class="comment">/* è®¾å¤‡èŠ‚ç‚¹åï¼Œåœ¨ /sys/class/class_name/ ä¸­æ˜¾ç¤ºçš„åç§°ä»¥åŠ /dev/ ä¸‹æ˜¾ç¤ºçš„èŠ‚ç‚¹å */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE     32        <span class="comment">/* è®¾ç½®æœ€å¤§åç§»é‡ä¸º32 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_TEST0 _IO(<span class="string">&#x27;S&#x27;</span>, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_TEST1 _IOW(<span class="string">&#x27;S&#x27;</span>, 1, int)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_TEST2 _IOR(<span class="string">&#x27;S&#x27;</span>, 2, int)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_TEST3 _IOW(<span class="string">&#x27;S&#x27;</span>, 3, int)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CMD_TEST</span>&#123;</span></span><br><span class="line">	<span class="type">int</span> a;</span><br><span class="line">	<span class="type">int</span> b;</span><br><span class="line">	<span class="type">int</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">CHAR_DEVICE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">dev_t</span> dev_num;         <span class="comment">// å®šä¹‰dev_tç±»å‹ï¼ˆ32ä½å¤§å°ï¼‰çš„å˜é‡dev_num,ç”¨æ¥å­˜æ”¾è®¾å¤‡å·</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">s_cdev</span>;</span>    <span class="comment">// å®šä¹‰cdevç»“æ„ä½“ç±»å‹çš„å˜é‡scdev</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span>   <span class="comment">// å®šäºstruct class *ç±»å‹ç»“æ„ä½“å˜é‡ classï¼Œè¡¨ç¤ºè¦åˆ›å»ºçš„ç±»</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span> <span class="comment">// è®¾å¤‡</span></span><br><span class="line">    <span class="type">char</span> buf[BUFSIZE];     <span class="comment">// è®¾ç½®æ•°æ®å­˜å‚¨æ•°ç»„mem</span></span><br><span class="line">    ulong run_cnt;         <span class="comment">// ç«äº‰æµ‹è¯•ç”¨çš„ä¸€ä¸ªå…±äº«æ•°æ®</span></span><br><span class="line">    <span class="type">spinlock_t</span> s_lock;     <span class="comment">// è‡ªæ—‹é”</span></span><br><span class="line">&#125; _CHAR_DEVICE;</span><br><span class="line"></span><br><span class="line">_CHAR_DEVICE g_chrdev = &#123;<span class="number">0</span>&#125;;  <span class="comment">//å®šä¹‰ä¸€ä¸ªdevice_testç»“æ„ä½“å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">scdev_ops_open</span><span class="params">(<span class="keyword">struct</span> inode *pInode, <span class="keyword">struct</span> file *pFile)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRT(<span class="string">&quot;This is scdev_ops_open!\n&quot;</span>);</span><br><span class="line">    pFile-&gt;private_data = &amp;g_chrdev;  <span class="comment">//è®¾ç½®ç§æœ‰æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">scdev_ops_read</span><span class="params">(<span class="keyword">struct</span> file *pFile, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span></span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">loff_t</span> offset = *off; <span class="comment">// å°†è¯»å–æ•°æ®çš„åç§»é‡èµ‹å€¼ç»™loff_tç±»å‹å˜é‡p</span></span><br><span class="line">    <span class="type">size_t</span> count = size;</span><br><span class="line">    _CHAR_DEVICE *p_chrdev=(_CHAR_DEVICE *)pFile-&gt;private_data; <span class="comment">//åœ¨writeå‡½æ•°ä¸­è¯»å–private_data</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (offset &gt; BUFSIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; BUFSIZE - offset)</span><br><span class="line">    &#123;</span><br><span class="line">        count = BUFSIZE - offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(buf, p_chrdev-&gt;buf + offset, count))</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="comment">// å°†memä¸­çš„å€¼å†™å…¥bufï¼Œå¹¶ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´</span></span><br><span class="line">        PRT(<span class="string">&quot;copy_to_user error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; BUFSIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        PRT(<span class="string">&quot;buf[%d] %c\n&quot;</span>, i, p_chrdev-&gt;buf[i]); <span class="comment">// å°†memä¸­çš„å€¼æ‰“å°å‡ºæ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    PRT(<span class="string">&quot;read offset is %llu, count is %d\n&quot;</span>, offset, count);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    *off = *off + count; <span class="comment">// æ›´æ–°åç§»å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">scdev_ops_write</span><span class="params">(<span class="keyword">struct</span> file *pFile, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">loff_t</span> offset = *off; <span class="comment">// å°†è¯»å–æ•°æ®çš„åç§»é‡èµ‹å€¼ç»™loff_tç±»å‹å˜é‡p</span></span><br><span class="line">    <span class="type">size_t</span> count = size;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    _CHAR_DEVICE *p_chrdev=(_CHAR_DEVICE *)pFile-&gt;private_data; <span class="comment">//åœ¨writeå‡½æ•°ä¸­è¯»å–private_data</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (offset &gt; BUFSIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; BUFSIZE - offset)</span><br><span class="line">    &#123;</span><br><span class="line">        count = BUFSIZE - offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(p_chrdev-&gt;buf + offset, buf, count))</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="comment">// å°†bufä¸­çš„å€¼ï¼Œä»ç”¨æˆ·ç©ºé—´ä¼ é€’åˆ°å†…æ ¸ç©ºé—´</span></span><br><span class="line">        PRT(<span class="string">&quot;copy_to_user error \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†æ‹·è´çš„æ•°æ®è½¬åŒ–ä¸º10è¿›åˆ¶æ•°</span></span><br><span class="line">    kstrtoul_from_user(buf, count, <span class="number">10</span>, &amp;p_chrdev-&gt;run_cnt);</span><br><span class="line">    spin_lock(&amp;p_chrdev-&gt;s_lock);</span><br><span class="line">    <span class="keyword">for</span> (i = p_chrdev-&gt;run_cnt; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        PRT(<span class="string">&quot;addr=0x%px run_cnt=%ld current is %d\n&quot;</span>, &amp;p_chrdev-&gt;run_cnt, p_chrdev-&gt;run_cnt, i); <span class="comment">// å¾ªç¯æ‰“å°æ•°æ®</span></span><br><span class="line">        mdelay(<span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock(&amp;p_chrdev-&gt;s_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; BUFSIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        PRT(<span class="string">&quot;buf[%d] %c\n&quot;</span>, i, p_chrdev-&gt;buf[i]); <span class="comment">// å°†memä¸­çš„å€¼æ‰“å°å‡ºæ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    PRT(<span class="string">&quot;write offset is %llu, count is %d\n&quot;</span>, offset, count); <span class="comment">// æ‰“å°å†™å…¥çš„å€¼</span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    *off = *off + count;                         <span class="comment">// æ›´æ–°åç§»å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">scdev_ops_release</span><span class="params">(<span class="keyword">struct</span> inode *pInode, <span class="keyword">struct</span> file *pFile)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRT(<span class="string">&quot;This is scdev_ops_release!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">loff_t</span> <span class="title function_">scdev_ops_llseek</span><span class="params">(<span class="keyword">struct</span> file *pFile, <span class="type">loff_t</span> offset, <span class="type">int</span> whence)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">loff_t</span> new_offset = <span class="number">0</span>; <span class="comment">// å®šä¹‰loff_tç±»å‹çš„æ–°çš„åç§»å€¼</span></span><br><span class="line">    <span class="keyword">switch</span> (whence)    <span class="comment">// å¯¹lseekå‡½æ•°ä¼ é€’çš„whenceå‚æ•°è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> SEEK_SET:</span><br><span class="line">            <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || offset &gt; BUFSIZE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> -EINVAL; <span class="comment">// EINVAL=22 è¡¨ç¤ºæ— æ•ˆå‚æ•°</span></span><br><span class="line">            &#125;</span><br><span class="line">            new_offset = offset; <span class="comment">// å¦‚æœwhenceå‚æ•°ä¸ºSEEK_SETï¼Œåˆ™æ–°åç§»å€¼ä¸ºoffset</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SEEK_CUR:</span><br><span class="line">            <span class="keyword">if</span> ((pFile-&gt;f_pos + offset &lt; <span class="number">0</span>) || (pFile-&gt;f_pos + offset &gt; BUFSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">            &#125;</span><br><span class="line">            new_offset = pFile-&gt;f_pos + offset; <span class="comment">// å¦‚æœwhenceå‚æ•°ä¸ºSEEK_CURï¼Œåˆ™æ–°åç§»å€¼ä¸ºpFile-&gt;f_pos + offsetï¼ŒpFile-&gt;f_posä¸ºå½“å‰çš„åç§»å€¼</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SEEK_END:</span><br><span class="line">            <span class="keyword">if</span> (pFile-&gt;f_pos + offset &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">            &#125;</span><br><span class="line">            new_offset = BUFSIZE + offset; <span class="comment">// å¦‚æœwhenceå‚æ•°ä¸ºSEEK_ENDï¼Œåˆ™æ–°åç§»å€¼ä¸ºBUFSIZE + offsetï¼ŒBUFSIZEä¸ºæœ€å¤§åç§»é‡</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pFile-&gt;f_pos = new_offset; <span class="comment">// æ›´æ–°pFile-&gt;f_posåç§»å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> new_offset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">scdev_ops_ioctl</span><span class="params">(<span class="keyword">struct</span> file *pFile, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> val = <span class="number">0</span>;<span class="comment">//å®šä¹‰ int ç±»å‹å‘åº”ç”¨ç©ºé—´ä¼ é€’çš„å˜é‡ val</span></span><br><span class="line">    <span class="keyword">switch</span>(cmd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> CMD_TEST0:</span><br><span class="line">            PRT(<span class="string">&quot;this is CMD_TEST0\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_TEST1:</span><br><span class="line">            PRT(<span class="string">&quot;this is CMD_TEST1\n&quot;</span>);</span><br><span class="line">            PRT(<span class="string">&quot;arg is %ld\n&quot;</span>,arg);<span class="comment">//æ‰“å°åº”ç”¨ç©ºé—´ä¼ é€’æ¥çš„ arg å‚æ•°</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_TEST2:</span><br><span class="line">            val = <span class="number">1</span>;<span class="comment">//å°†è¦ä¼ é€’çš„å˜é‡ val èµ‹å€¼ä¸º 1</span></span><br><span class="line">            PRT(<span class="string">&quot;this is CMD_TEST2\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(copy_to_user((<span class="type">int</span> *)arg, &amp;val, <span class="keyword">sizeof</span>(val)) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//é€šè¿‡ copy_to_user å‘ç”¨æˆ·ç©ºé—´ä¼ é€’æ•°æ®</span></span><br><span class="line">                PRT(<span class="string">&quot;copy_to_user error \n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_TEST3:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> __<span class="title">CMD_TEST</span> <span class="title">cmd_test3</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span> (copy_from_user(&amp;cmd_test3, (<span class="type">int</span> *)arg, <span class="keyword">sizeof</span>(cmd_test3)) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                PRT(<span class="string">&quot;copy_from_user error\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            PRT(<span class="string">&quot;cmd_test3.a = %d\n&quot;</span>, cmd_test3.a);</span><br><span class="line">            PRT(<span class="string">&quot;cmd_test3.b = %d\n&quot;</span>, cmd_test3.b);</span><br><span class="line">            PRT(<span class="string">&quot;cmd_test3.c = %d\n&quot;</span>, cmd_test3.c);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">g_scdev_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,<span class="comment">//å°†ownerå­—æ®µæŒ‡å‘æœ¬æ¨¡å—ï¼Œå¯ä»¥é¿å…åœ¨æ¨¡å—çš„æ“ä½œæ­£åœ¨è¢«ä½¿ç”¨æ—¶å¸è½½è¯¥æ¨¡å—</span></span><br><span class="line">	.open = scdev_ops_open,</span><br><span class="line">	.read = scdev_ops_read,</span><br><span class="line">	.write = scdev_ops_write,</span><br><span class="line">	.release = scdev_ops_release,</span><br><span class="line">    .llseek = scdev_ops_llseek,</span><br><span class="line">    .unlocked_ioctl = scdev_ops_ioctl,</span><br><span class="line">&#125;; <span class="comment">// å®šä¹‰file_operationsç»“æ„ä½“ç±»å‹çš„å˜é‡g_cdev_dev_ops</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">scdev_create</span><span class="params">(_CHAR_DEVICE *p_chrdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;          <span class="comment">// å®šä¹‰intç±»å‹çš„å˜é‡retï¼Œç”¨æ¥åˆ¤æ–­å‡½æ•°è¿”å›å€¼</span></span><br><span class="line">    <span class="type">int</span> major, minor; <span class="comment">// å®šä¹‰intç±»å‹çš„ä¸»è®¾å¤‡å·majorå’Œæ¬¡è®¾å¤‡å·minor</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–è‡ªæ—‹é” */</span></span><br><span class="line">	spin_lock_init(&amp;p_chrdev-&gt;s_lock);</span><br><span class="line"></span><br><span class="line">    ret = alloc_chrdev_region(&amp;p_chrdev-&gt;dev_num, <span class="number">0</span>, <span class="number">1</span>, CHRDEV_NAME); <span class="comment">// è‡ªåŠ¨è·å–è®¾å¤‡å·ï¼Œè®¾å¤‡åä¸ºchrdev_name</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        PRTE(<span class="string">&quot;alloc_chrdev_region is error!ret=%d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> err_alloc_devno;</span><br><span class="line">    &#125;</span><br><span class="line">    major = MAJOR(p_chrdev-&gt;dev_num); <span class="comment">// ä½¿ç”¨MAJOR()å‡½æ•°è·å–ä¸»è®¾å¤‡å·</span></span><br><span class="line">    minor = MINOR(p_chrdev-&gt;dev_num); <span class="comment">// ä½¿ç”¨MINOR()å‡½æ•°è·å–æ¬¡è®¾å¤‡å·</span></span><br><span class="line">    PRT(<span class="string">&quot;major is %d, minor is %d !\n&quot;</span>, major, minor);</span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;p_chrdev-&gt;s_cdev, &amp;g_scdev_ops); <span class="comment">// ä½¿ç”¨cdev_init()å‡½æ•°åˆå§‹åŒ–p_chrdev-&gt;s_cdevç»“æ„ä½“ï¼Œå¹¶é“¾æ¥åˆ° cdev_ops ç»“æ„ä½“</span></span><br><span class="line">    p_chrdev-&gt;s_cdev.owner = THIS_MODULE;          <span class="comment">// å°†ownerå­—æ®µæŒ‡å‘æœ¬æ¨¡å—ï¼Œå¯ä»¥é¿å…åœ¨æ¨¡å—çš„æ“ä½œæ­£åœ¨è¢«ä½¿ç”¨æ—¶å¸è½½è¯¥æ¨¡å—</span></span><br><span class="line">    ret = cdev_add(&amp;p_chrdev-&gt;s_cdev, p_chrdev-&gt;dev_num, <span class="number">1</span>); <span class="comment">// ä½¿ç”¨cdev_add()å‡½æ•°è¿›è¡Œå­—ç¬¦è®¾å¤‡çš„æ·»åŠ </span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        PRTE(<span class="string">&quot;cdev_add is error !ret=%d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> err_cdev_add;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p_chrdev-&gt;<span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, CLASS_NAME); <span class="comment">// ä½¿ç”¨class_createè¿›è¡Œç±»çš„åˆ›å»ºï¼Œç±»åç§°ä¸º class_dev</span></span><br><span class="line">    <span class="keyword">if</span>(IS_ERR(p_chrdev-&gt;class))</span><br><span class="line">    &#123;</span><br><span class="line">        ret = PTR_ERR(p_chrdev-&gt;class);</span><br><span class="line">        <span class="keyword">goto</span> err_class_create;</span><br><span class="line">    &#125;</span><br><span class="line">    p_chrdev-&gt;device = device_create(p_chrdev-&gt;class, <span class="literal">NULL</span>, p_chrdev-&gt;dev_num, <span class="literal">NULL</span>, <span class="string">&quot;%s&quot;</span>, DEVICE_NAME); <span class="comment">// ä½¿ç”¨device_createè¿›è¡Œè®¾å¤‡çš„åˆ›å»ºï¼Œè®¾å¤‡åç§°ä¸º device_dev</span></span><br><span class="line">    <span class="keyword">if</span>(IS_ERR(p_chrdev-&gt;device))</span><br><span class="line">    &#123;</span><br><span class="line">        ret = PTR_ERR(p_chrdev-&gt;class);</span><br><span class="line">        <span class="keyword">goto</span> err_device_create;</span><br><span class="line">    &#125;</span><br><span class="line">    PRT(<span class="string">&quot;scdev_create /dev/%s success!\n&quot;</span>, DEVICE_NAME);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ä¸€äº›åˆ—çš„é”™è¯¯å¤„ç†</span></span><br><span class="line">err_device_create:</span><br><span class="line">    class_destroy(p_chrdev-&gt;class);   <span class="comment">// åˆ é™¤åˆ›å»ºçš„ç±»</span></span><br><span class="line">err_class_create:</span><br><span class="line">    cdev_del(&amp;p_chrdev-&gt;s_cdev);      <span class="comment">// ä½¿ç”¨cdev_del()å‡½æ•°è¿›è¡Œå­—ç¬¦è®¾å¤‡çš„åˆ é™¤</span></span><br><span class="line">err_cdev_add:</span><br><span class="line">    unregister_chrdev_region(p_chrdev-&gt;dev_num, <span class="number">1</span>); <span class="comment">//æ³¨é”€è®¾å¤‡å·</span></span><br><span class="line">err_alloc_devno:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">scdev_destroy</span><span class="params">(_CHAR_DEVICE *p_chrdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ å­—ç¬¦è®¾å¤‡çš„æ³¨å†Œè¦æ”¾åœ¨ç”³è¯·å­—ç¬¦è®¾å¤‡å·ä¹‹åï¼Œ</span></span><br><span class="line">    <span class="comment">// å­—ç¬¦è®¾å¤‡çš„åˆ é™¤è¦æ”¾åœ¨é‡Šæ”¾å­—ç¬¦é©±åŠ¨è®¾å¤‡å·ä¹‹å‰ã€‚</span></span><br><span class="line">    cdev_del(&amp;p_chrdev-&gt;s_cdev);                    <span class="comment">// ä½¿ç”¨cdev_del()å‡½æ•°è¿›è¡Œå­—ç¬¦è®¾å¤‡çš„åˆ é™¤</span></span><br><span class="line">    unregister_chrdev_region(p_chrdev-&gt;dev_num, <span class="number">1</span>); <span class="comment">// é‡Šæ”¾å­—ç¬¦é©±åŠ¨è®¾å¤‡å·</span></span><br><span class="line">    device_destroy(p_chrdev-&gt;class, p_chrdev-&gt;dev_num); <span class="comment">// åˆ é™¤åˆ›å»ºçš„è®¾å¤‡</span></span><br><span class="line">    class_destroy(p_chrdev-&gt;class);                 <span class="comment">// åˆ é™¤åˆ›å»ºçš„ç±»</span></span><br><span class="line">    PRT(<span class="string">&quot;scdev_destroy success!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  sdrv_demo_init</span></span><br><span class="line"><span class="comment"> * @note   æ³¨å†Œé©±åŠ¨</span></span><br><span class="line"><span class="comment"> * @param [in]</span></span><br><span class="line"><span class="comment"> * @param [out]</span></span><br><span class="line"><span class="comment"> * @retval </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> __init <span class="type">int</span> <span class="title function_">sdrv_demo_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	printk(<span class="string">&quot;*** [%s:%d]Build Time: %s %s, git version:%s ***\n&quot;</span>, __FUNCTION__,</span><br><span class="line">           __LINE__, KERNEL_KO_DATE, KERNEL_KO_TIME, KERNEL_KO_VERSION);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ³¨å†Œå­—ç¬¦è®¾å¤‡</span></span><br><span class="line">    ret = scdev_create(&amp;g_chrdev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        PRT(<span class="string">&quot;Failed to scdev_create!ret=%d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> err_scdev_create;</span><br><span class="line">    &#125;</span><br><span class="line">    PRT(<span class="string">&quot;sdrv_demo module init success!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_scdev_create:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  sdrv_demo_exit</span></span><br><span class="line"><span class="comment"> * @note   æ³¨é”€é©±åŠ¨</span></span><br><span class="line"><span class="comment"> * @param [in]</span></span><br><span class="line"><span class="comment"> * @param [out]</span></span><br><span class="line"><span class="comment"> * @retval </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> __exit <span class="type">void</span> <span class="title function_">sdrv_demo_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ³¨é”€å­—ç¬¦è®¾å¤‡</span></span><br><span class="line">    scdev_destroy(&amp;g_chrdev);</span><br><span class="line">    PRT(<span class="string">&quot;sdrv_demo module exit!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(sdrv_demo_init); <span class="comment">// å°†__initå®šä¹‰çš„å‡½æ•°æŒ‡å®šä¸ºé©±åŠ¨çš„å…¥å£å‡½æ•°</span></span><br><span class="line">module_exit(sdrv_demo_exit); <span class="comment">// å°†__exitå®šä¹‰çš„å‡½æ•°æŒ‡å®šä¸ºé©±åŠ¨çš„å‡ºå£å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¨¡å—ä¿¡æ¯(é€šè¿‡ modinfo xxx.ko æŸ¥çœ‹) */</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL v2&quot;</span>);            <span class="comment">/* æºç çš„è®¸å¯è¯åè®® */</span></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;sumu&quot;</span>);               <span class="comment">/* å­—ç¬¦ä¸²å¸¸é‡å†…å®¹ä¸ºæ¨¡å—ä½œè€…è¯´æ˜ */</span></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Description&quot;</span>);   <span class="comment">/* å­—ç¬¦ä¸²å¸¸é‡å†…å®¹ä¸ºæ¨¡å—åŠŸèƒ½è¯´æ˜ */</span></span><br><span class="line">MODULE_ALIAS(<span class="string">&quot;module&#x27;s other name&quot;</span>); <span class="comment">/* å­—ç¬¦ä¸²å¸¸é‡å†…å®¹ä¸ºæ¨¡å—åˆ«å */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
              </div>
            </details>

<h5 id="7-1-1-2-app-demo-c"><a href="#7-1-1-2-app-demo-c" class="headerlink" title="7.1.1.2 app_demo.c"></a><font size=3>7.1.1.2 app_demo.c</font></h5><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… </summary>
              <div class='content'>
              <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE   32 <span class="comment">/* è®¾ç½®æœ€å¤§åç§»é‡ä¸º64, æ–¹ä¾¿æ‰“å°å®Œæ•´çš„å†…å­˜ç©ºé—´æ•°æ®*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">usage_info</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++++++++++++\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;+       help information  @sumu          +\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++++++++++++\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;help:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;use format: ./app_name /dev/device_name arg1 ... \n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;            ./app_demo.out /dev/sdevice run_cnt # run_cntä¸ºè¿è¡Œæ¬¡æ•° \n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;command info:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  (1)load module  : insmod module_name.ko\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  (2)unload module: rmmod module_name.ko\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  (3)show module  : lsmod\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  (4)view device  : cat /proc/devices\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  (5)create device node: mknod /dev/device_name c major_num secondary_num \n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  (6)show device node  : ls /dev/device_name \n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  (7)show device vlass  : ls /sys/class \n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;+++++++++++++++++++++++++++++++++++++++++\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">pid_t</span> pid = <span class="number">0</span>; <span class="comment">//ç”¨äºä¿å­˜ fork å‡½æ•°è¿”å›çš„çˆ¶ã€å­çº¿ç¨‹çš„PID</span></span><br><span class="line">    <span class="type">char</span> *filename = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">char</span> writebuf[BUFSIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*** Build Time: %s %s,Git Version: %s Git Remote: %s***\n&quot;</span>, </span><br><span class="line">            __DATE__, __TIME__, GIT_VERSION, GIT_PATH);</span><br><span class="line">    <span class="comment">// ./xxx.out /dev/sdevice x x x</span></span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        usage_info();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è§£æå‚æ•°</span></span><br><span class="line">    filename = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">snprintf</span> (writebuf, <span class="keyword">sizeof</span>(writebuf), <span class="string">&quot;%s&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s %s %s\n&quot;</span>, argv[<span class="number">0</span>], filename, argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="comment">// åˆ›å»ºå­è¿›ç¨‹</span></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fork error!!\n&quot;</span>); <span class="comment">// fork å‡½æ•°æ‰§è¡Œé”™è¯¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == pid) <span class="comment">// å­è¿›ç¨‹</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;This is child process!\n&quot;</span>);</span><br><span class="line">        <span class="comment">/* æ‰“å¼€é©±åŠ¨æ–‡ä»¶ */</span></span><br><span class="line">        fd = open(filename, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open file %s !\n&quot;</span>, filename);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* å‘è®¾å¤‡é©±åŠ¨å†™æ•°æ® */</span></span><br><span class="line">        ret = write(fd, writebuf, <span class="built_in">strlen</span>(writebuf));</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;write file %s failed!\n&quot;</span>, filename);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å…³é—­è®¾å¤‡ */</span></span><br><span class="line">        ret = close(fd);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t close file %s !\n&quot;</span>, filename);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;This is parent process!\n&quot;</span>);</span><br><span class="line">        <span class="comment">/* æ‰“å¼€é©±åŠ¨æ–‡ä»¶ */</span></span><br><span class="line">        fd = open(filename, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open file %s !\n&quot;</span>, filename);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* å‘è®¾å¤‡é©±åŠ¨å†™æ•°æ® */</span></span><br><span class="line">        ret = write(fd, writebuf, <span class="built_in">strlen</span>(writebuf));</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;write file %s failed!\n&quot;</span>, filename);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å…³é—­è®¾å¤‡ */</span></span><br><span class="line">        ret = close(fd);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t close file %s !\n&quot;</span>, filename);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>

<h4 id="7-1-2-å¼€å‘æ¿éªŒè¯"><a href="#7-1-2-å¼€å‘æ¿éªŒè¯" class="headerlink" title="7.1.2 å¼€å‘æ¿éªŒè¯"></a><font size=3>7.1.2 å¼€å‘æ¿éªŒè¯</font></h4><p>æˆ‘ä»¬å°†ç¼–è¯‘å¾—åˆ°çš„sdriver_demo.koã€app_demo.outæ‹·è´åˆ°å¼€å‘æ¿ã€‚</p>
<ul>
<li>ï¼ˆ1ï¼‰åŠ è½½é©±åŠ¨</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insmod sdriver_demo.ko</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250121165825048.png" alt="image-20250121165825048"  />

<ul>
<li>ï¼ˆ2ï¼‰è¿™é‡Œæ¢äº†ç§å†™æ³•ï¼Œapp_demo.out ä¼šåˆ›å»ºå­è¿›ç¨‹è¿è¡Œ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./app_demo.out /dev/sdevchr 10</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250121165930968.png" alt="image-20250121165930968"  />

<p>å¯ä»¥çœ‹åˆ°ä¸å†æ˜¯åƒä¹‹å‰ç«äº‰æ¼”ç¤ºé‚£æ ·äº¤æ›¿æ‰“å°äº†ï¼Œæ˜¯ç­‰ä¸€ä¸ªæ‰“å®Œå†æ‰“å¦ä¸€ä¸ªã€‚</p>
<h3 id="7-2-æ­£å¸¸ä½¿ç”¨çš„demo2"><a href="#7-2-æ­£å¸¸ä½¿ç”¨çš„demo2" class="headerlink" title="7.2 æ­£å¸¸ä½¿ç”¨çš„demo2"></a><font size=3>7.2 æ­£å¸¸ä½¿ç”¨çš„demo2</font></h3><p>è¿™ä¸ªdemoæ˜¯å®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œæ“ä½œå®ƒçš„æ—¶å€™ï¼Œç”¨è‡ªæ—‹é”é”å®šï¼Œä¿è¯æ“ä½œçš„æ—¶å€™ä¸ä¼šè¢«æ‰“æ–­è€Œå‡ºç°é—®é¢˜ï¼Œç›¸å½“äºå‰é¢çš„åŸå­æ“ä½œï¼Œä½†æ˜¯æ¯”åŸå­æ“ä½œèƒ½ä¿æŠ¤çš„èŒƒå›´æ›´å¤§äº›ã€‚</p>
<h4 id="7-2-1-demoæºç "><a href="#7-2-1-demoæºç " class="headerlink" title="7.2.1 demoæºç "></a><font size=3>7.2.1 demoæºç </font></h4><p><a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/tree/master/07_concurrency/04_spin_lock_3">07_concurrency&#x2F;04_spin_lock_3 Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<h4 id="7-2-2-å¼€å‘æ¿éªŒè¯"><a href="#7-2-2-å¼€å‘æ¿éªŒè¯" class="headerlink" title="7.2.2 å¼€å‘æ¿éªŒè¯"></a><font size=3>7.2.2 å¼€å‘æ¿éªŒè¯</font></h4><p>æˆ‘ä»¬å°†ç¼–è¯‘å¾—åˆ°çš„sdriver_demo.koã€app_demo.outæ‹·è´åˆ°å¼€å‘æ¿ã€‚</p>
<ul>
<li>ï¼ˆ1ï¼‰åŠ è½½é©±åŠ¨</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insmod sdriver_demo.ko</span><br></pre></td></tr></table></figure>



<ul>
<li>ï¼ˆ2ï¼‰è¿™é‡Œæ¢äº†ç§å†™æ³•ï¼Œapp_demo.out ä¼šåˆ›å»ºå­è¿›ç¨‹è¿è¡Œ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./app_demo.out /dev/sdevchr 2 # è¿™ä¸ªå‚æ•°æ²¡å•¥æ„ä¹‰ï¼Œæˆ‘åœ¨å†…éƒ¨å†™æ­»äº†</span><br></pre></td></tr></table></figure>

<p>usleep(1000*200*6)æ—¶ï¼Œçˆ¶å­è¿›ç¨‹ä¾æ¬¡è¿è¡Œï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122111048057.png" alt="image-20250122111048057"  />

<p>usleep(1000*200*2)æ—¶ï¼Œå­è¿›ç¨‹è¿è¡Œå¤±è´¥ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122111333006.png" alt="image-20250122111333006"  />

<blockquote>
<p>ä¿®æ”¹app_demo.cä¸­ä¸‹å›¾ä½ç½®çš„ä¼‘çœ æ—¶é—´å¯ä»¥æ§åˆ¶å­è¿›ç¨‹çš„è¿è¡Œæ—¶é—´ï¼Œå½“çˆ¶è¿›ç¨‹è¿è¡Œå®Œå†è¿è¡Œå­è¿›ç¨‹æ—¶ï¼Œå­è¿›ç¨‹è¿è¡Œæ­£å¸¸ï¼Œå½“çˆ¶è¿›ç¨‹æœªè¿è¡Œå®Œæ¯•å°±å¼€å§‹è¿è¡Œå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å°±ä¼šæ‰“å¼€èŠ‚ç‚¹å¤±è´¥ï¼Œè¾¾åˆ°å…±äº«èµ„æºä¿æŠ¤çš„ç›®çš„ã€‚</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122110709727.png" alt="image-20250122110709727"  />
</blockquote>
<h3 id="7-3-æ­»é”çš„demo"><a href="#7-3-æ­»é”çš„demo" class="headerlink" title="7.3 æ­»é”çš„demo"></a><font size=3>7.3 æ­»é”çš„demo</font></h3><h4 id="7-3-1-demoæºç "><a href="#7-3-1-demoæºç " class="headerlink" title="7.3.1 demoæºç "></a><font size=3>7.3.1 demoæºç </font></h4><p>è¿™ä¸ªdemoæ˜¯ç¬¬ä¸€ç§æƒ…å†µï¼Œ å³æ‹¥æœ‰è‡ªæ—‹é”çš„è¿›ç¨‹ A åœ¨å†…æ ¸æ€ä¼‘çœ äº†ï¼Œ å†…æ ¸è°ƒåº¦ B è¿›ç¨‹ï¼Œ ç¢°å·§ B è¿›ç¨‹ä¹Ÿè¦è·å¾—è‡ªæ—‹é”ï¼Œ ä¾æ¬¡äº§ç”Ÿæ­»é”ã€‚  </p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/tree/master/07_concurrency/04_spin_lock_1">07_concurrency&#x2F;04_spin_lock_1 Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/tree/master/07_concurrency/04_spin_lock_2">07_concurrency&#x2F;04_spin_lock_2 Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<h4 id="7-3-2-å¼€å‘æ¿éªŒè¯"><a href="#7-3-2-å¼€å‘æ¿éªŒè¯" class="headerlink" title="7.3.2 å¼€å‘æ¿éªŒè¯"></a><font size=3>7.3.2 å¼€å‘æ¿éªŒè¯</font></h4><p>è¿™ä¸ªdemoæ˜¯åœ¨å†…æ ¸è¿›è¡Œé•¿æ—¶é—´ä¼‘çœ ï¼Œä¼šå¯¼è‡´å´©æºƒï¼Œå…ˆä¸ç®¡äº†ï¼ŒçŸ¥é“æ­»é”çš„åŸç†å°±å¯ä»¥äº†ã€‚å´©æºƒçš„ä¿¡æ¯å¯ä»¥çœ‹è¿™é‡Œï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªï¼š<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/blob/master/07_concurrency/04_spin_lock_1/debug_log.md">07_concurrency&#x2F;04_spin_lock_1&#x2F;debug_log.md Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<h1 id="ä¸‰ã€ä¿¡å·é‡"><a href="#ä¸‰ã€ä¿¡å·é‡" class="headerlink" title="ä¸‰ã€ä¿¡å·é‡"></a><font size=3>ä¸‰ã€ä¿¡å·é‡</font></h1><h2 id="1-ä»€ä¹ˆæ˜¯ä¿¡å·é‡"><a href="#1-ä»€ä¹ˆæ˜¯ä¿¡å·é‡" class="headerlink" title="1. ä»€ä¹ˆæ˜¯ä¿¡å·é‡"></a><font size=3>1. ä»€ä¹ˆæ˜¯ä¿¡å·é‡</font></h2><h3 id="1-1-ä¸€ä¸ªä¾‹å­"><a href="#1-1-ä¸€ä¸ªä¾‹å­" class="headerlink" title="1.1 ä¸€ä¸ªä¾‹å­"></a><font size=3>1.1 ä¸€ä¸ªä¾‹å­</font></h3><p>ä¸¾ä¸ªä¾‹å­ï¼ŒæŸä¸ªåœè½¦åœºæœ‰ 100 ä¸ªåœè½¦ä½ï¼Œè¿™ 100 ä¸ªåœè½¦ä½å¤§å®¶éƒ½å¯ä»¥ç”¨ï¼Œå¯¹äºå¤§å®¶æ¥è¯´è¿™100 ä¸ªåœè½¦ä½å°±æ˜¯å…±äº«èµ„æºã€‚å‡è®¾ç°åœ¨è¿™ä¸ªåœè½¦åœºæ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬è¦æŠŠè½¦åœåˆ°è¿™ä¸ªè¿™ä¸ªåœè½¦åœºè‚¯å®šè¦å…ˆçœ‹ä¸€ä¸‹ç°åœ¨åœäº†å¤šå°‘è½¦äº†ï¼Ÿè¿˜æœ‰æ²¡æœ‰åœè½¦ä½ï¼Ÿå½“å‰åœè½¦æ•°é‡å°±æ˜¯ä¸€ä¸ªä¿¡å·é‡ï¼Œå…·ä½“çš„åœè½¦æ•°é‡å°±æ˜¯è¿™ä¸ªä¿¡å·é‡å€¼ï¼Œå½“è¿™ä¸ªå€¼åˆ° 100 çš„æ—¶å€™è¯´æ˜åœè½¦åœºæ»¡äº†ã€‚åœè½¦åœºæ»¡çš„æ—¶æˆ‘ä»¬å¯ä»¥ç­‰ä¸€ä¼šçœ‹çœ‹æœ‰æ²¡æœ‰å…¶ä»–çš„è½¦å¼€å‡ºåœè½¦åœºï¼Œå½“æœ‰è½¦å¼€å‡ºåœè½¦åœºçš„æ—¶å€™åœè½¦æ•°é‡å°±ä¼šå‡ä¸€ï¼Œä¹Ÿå°±æ˜¯è¯´ä¿¡å·é‡å‡ä¸€ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥æŠŠè½¦åœè¿›å»äº†ï¼Œæˆ‘ä»¬æŠŠè½¦åœè¿›å»ä»¥ååœè½¦æ•°é‡å°±ä¼šåŠ ä¸€ï¼Œä¹Ÿå°±æ˜¯ä¿¡å·é‡åŠ ä¸€ã€‚è¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä½¿ç”¨ä¿¡å·é‡è¿›è¡Œå…±äº«èµ„æºç®¡ç†çš„æ¡ˆä¾‹ï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ä½¿ç”¨çš„å°±æ˜¯è®¡æ•°å‹ä¿¡å·é‡ã€‚  </p>
<h3 id="1-2-ä¿¡å·é‡"><a href="#1-2-ä¿¡å·é‡" class="headerlink" title="1.2 ä¿¡å·é‡"></a><font size=3>1.2 ä¿¡å·é‡</font></h3><p>ä¿¡å·é‡æ˜¯æ“ä½œç³»ç»Ÿä¸­æœ€å…¸å‹çš„ç”¨äºåŒæ­¥å’Œäº’æ–¥çš„æ‰‹æ®µï¼Œ <strong>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡</strong>ï¼Œ ä¿¡å·é‡çš„å€¼è¡¨ç¤ºæ§åˆ¶è®¿é—®èµ„æºçš„çº¿ç¨‹æ•°ï¼Œ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ¥è‡ªè¡Œè®¾ç½®ã€‚</p>
<p>å¦‚æœåœ¨åˆå§‹åŒ–çš„æ—¶å€™å°†ä¿¡å·é‡é‡å€¼è®¾ç½®ä¸ºå¤§äº 1ï¼Œ é‚£ä¹ˆè¿™ä¸ªä¿¡å·é‡å°±æ˜¯<strong>è®¡æ•°å‹ä¿¡å·é‡</strong>ï¼Œ å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œä¸èƒ½ç”¨äºäº’æ–¥è®¿é—®ã€‚</p>
<p>å¦‚æœå°†ä¿¡å·é‡é‡å€¼è®¾ç½®ä¸º 1ï¼Œ é‚£ä¹ˆè¿™ä¸ªä¿¡å·é‡å°±æ˜¯<strong>äºŒå€¼ä¿¡å·é‡</strong>ï¼Œ åŒä¸€æ—¶é—´å†…åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºï¼Œ å¯ä»¥ç”¨äºäº’æ–¥è®¿é—®ã€‚</p>
<p>æ³¨æ„ï¼ ä¿¡å·é‡çš„å€¼ä¸èƒ½å°äº 0ã€‚ å½“ä¿¡å·é‡çš„å€¼ä¸º 0 æ—¶ï¼Œ æƒ³è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œ ç›´åˆ°ä¿¡å·é‡å¤§äº 0 æ—¶ï¼Œ ç­‰å¾…çš„çº¿ç¨‹æ‰å¯ä»¥è®¿é—®ã€‚ å½“è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œ ä¿¡å·é‡æ‰§è¡Œâ€œå‡ä¸€â€æ“ä½œï¼Œ è®¿é—®å®Œæˆåå†æ‰§è¡Œâ€œåŠ ä¸€â€ æ“ä½œ ã€‚</p>
<h2 id="2-ä¿¡å·é‡çš„ç‰¹ç‚¹"><a href="#2-ä¿¡å·é‡çš„ç‰¹ç‚¹" class="headerlink" title="2. ä¿¡å·é‡çš„ç‰¹ç‚¹"></a><font size=3>2. ä¿¡å·é‡çš„ç‰¹ç‚¹</font></h2><p>ç›¸æ¯”äºè‡ªæ—‹é”ï¼Œä¿¡å·é‡å¯ä»¥ä½¿çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œæ¯”å¦‚ A ä¸ Bã€ C åˆç§Ÿäº†ä¸€å¥—æˆ¿å­ï¼Œè¿™ä¸ªæˆ¿å­åªæœ‰ä¸€ä¸ªå«ç”Ÿé—´ï¼Œä¸€æ¬¡åªèƒ½ä¸€ä¸ªäººä½¿ç”¨ã€‚æŸä¸€å¤©æ—©ä¸Š A å»ä¸Šå«ç”Ÿé—´äº†ï¼Œè¿‡äº†ä¸€ä¼š B ä¹Ÿæƒ³ç”¨å«ç”Ÿé—´ï¼Œå› ä¸º A åœ¨å«ç”Ÿé—´é‡Œé¢ï¼Œæ‰€ä»¥ B åªèƒ½ç­‰åˆ° A ç”¨æ¥äº†æ‰èƒ½è¿›å»ã€‚ B è¦ä¹ˆå°±ä¸€ç›´åœ¨å«ç”Ÿé—´é—¨å£ç­‰ç€ï¼Œç­‰ A å‡ºæ¥ï¼Œè¿™ä¸ªæ—¶å€™å°±ç›¸å½“äºè‡ªæ—‹é”ã€‚ B ä¹Ÿå¯ä»¥å‘Šè¯‰ Aï¼Œè®© A å‡ºæ¥ä»¥åé€šçŸ¥ä»–ä¸€ä¸‹ï¼Œç„¶å B ç»§ç»­å›æˆ¿é—´ç¡è§‰ï¼Œè¿™ä¸ªæ—¶å€™ç›¸å½“äºä¿¡å·é‡ã€‚</p>
<p>å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ä¿¡å·é‡ä¼šæé«˜å¤„ç†å™¨çš„ä½¿ç”¨æ•ˆç‡ï¼Œæ¯•ç«Ÿä¸ç”¨ä¸€ç›´å‚»ä¹ä¹çš„åœ¨é‚£é‡Œâ€œè‡ªæ—‹â€ç­‰å¾…ã€‚ä½†æ˜¯ï¼Œä¿¡å·é‡çš„å¼€é”€è¦æ¯”è‡ªæ—‹é”å¤§ï¼Œå› ä¸ºä¿¡å·é‡ä½¿çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ä»¥åä¼šåˆ‡æ¢çº¿ç¨‹ï¼Œåˆ‡æ¢çº¿ç¨‹å°±ä¼šæœ‰å¼€é”€ã€‚æ€»ç»“ä¸€ä¸‹ä¿¡å·é‡çš„ç‰¹ç‚¹ï¼š  </p>
<p>â‘ ã€å› ä¸ºä¿¡å·é‡å¯ä»¥ä½¿ç­‰å¾…èµ„æºçº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå› æ­¤é€‚ç”¨äºé‚£äº›å ç”¨èµ„æºæ¯”è¾ƒä¹…çš„åœºåˆã€‚</p>
<p>â‘¡ã€å› æ­¤ä¿¡å·é‡ä¸èƒ½ç”¨äºä¸­æ–­ä¸­ï¼Œå› ä¸ºä¿¡å·é‡ä¼šå¼•èµ·ä¼‘çœ ï¼Œä¸­æ–­ä¸èƒ½ä¼‘çœ ã€‚</p>
<p>â‘¢ã€å¦‚æœå…±äº«èµ„æºçš„æŒæœ‰æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œé‚£å°±ä¸é€‚åˆä½¿ç”¨ä¿¡å·é‡äº†ï¼Œå› ä¸ºé¢‘ç¹çš„ä¼‘çœ ã€åˆ‡æ¢çº¿ç¨‹å¼•èµ·çš„å¼€é”€è¦è¿œå¤§äºä¿¡å·é‡å¸¦æ¥çš„é‚£ç‚¹ä¼˜åŠ¿ã€‚</p>
<h2 id="3-ç›¸å…³æ•°æ®ç»“æ„ä¸API-1"><a href="#3-ç›¸å…³æ•°æ®ç»“æ„ä¸API-1" class="headerlink" title="3. ç›¸å…³æ•°æ®ç»“æ„ä¸API"></a><font size=3>3. ç›¸å…³æ•°æ®ç»“æ„ä¸API</font></h2><h3 id="3-1-struct-semaphore"><a href="#3-1-struct-semaphore" class="headerlink" title="3.1Â struct semaphore"></a><font size=3>3.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/semaphore.h#L16">struct semaphore</a></font></h3><p>Linux å†…æ ¸ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/semaphore.h#L16">struct semaphore</a> ç»“æ„ä½“è¡¨ç¤ºä¿¡å·é‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Please don&#x27;t access any members of this structure directly */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> &#123;</span></span><br><span class="line">	<span class="type">raw_spinlock_t</span>		lock;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">wait_list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-ç›¸å…³API"><a href="#3-2-ç›¸å…³API" class="headerlink" title="3.2 ç›¸å…³API"></a><font size=3>3.2 ç›¸å…³API</font></h3><p>ä¿¡å·é‡ç›¸å…³çš„APIå‡½æ•°å£°æ˜å¯ä»¥åœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/semaphore.h">semaphore.h - include&#x2F;linux&#x2F;semaphore.h</a> ä¸­æ‰¾åˆ°ï¼š</p>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>DEFINE_SEAMPHORE(name)</td>
<td>å®šä¹‰ä¸€ä¸ªä¿¡å·é‡ï¼Œå¹¶ä¸”è®¾ç½®ä¿¡å·é‡çš„å€¼ä¸º 1ã€‚</td>
</tr>
<tr>
<td>void sema_init(struct semaphore *sem, int val)</td>
<td>åˆå§‹åŒ–ä¿¡å·é‡ semï¼Œè®¾ç½®ä¿¡å·é‡å€¼ä¸º valã€‚</td>
</tr>
<tr>
<td>void down(struct semaphore *sem)</td>
<td>è·å–ä¿¡å·é‡ï¼Œå› ä¸ºä¼šå¯¼è‡´ä¼‘çœ ï¼Œå› æ­¤ä¸èƒ½åœ¨ä¸­æ–­ä¸­ä½¿ç”¨ã€‚</td>
</tr>
<tr>
<td>int down_trylock(struct semaphore *sem);</td>
<td>å°è¯•è·å–ä¿¡å·é‡ï¼Œå¦‚æœèƒ½è·å–åˆ°ä¿¡å·é‡å°±è·å–ï¼Œå¹¶ä¸”è¿”å› 0ã€‚å¦‚æœä¸èƒ½å°±è¿”å›é 0ï¼Œå¹¶ä¸”ä¸ä¼šè¿›å…¥ä¼‘çœ ã€‚</td>
</tr>
<tr>
<td>int down_interruptible(struct semaphore *sem)</td>
<td>è·å–ä¿¡å·é‡ï¼Œå’Œ down ç±»ä¼¼ï¼Œåªæ˜¯ä½¿ç”¨ down è¿›å…¥ä¼‘çœ çŠ¶æ€çš„çº¿ç¨‹ä¸èƒ½è¢«ä¿¡å·æ‰“æ–­ã€‚è€Œä½¿ç”¨æ­¤å‡½æ•°è¿›å…¥ä¼‘çœ ä»¥åæ˜¯å¯ä»¥è¢«ä¿¡å·æ‰“æ–­çš„ã€‚</td>
</tr>
<tr>
<td>void up(struct semaphore *sem)</td>
<td>é‡Šæ”¾ä¿¡å·é‡</td>
</tr>
</tbody></table>
<h3 id="3-3-ä½¿ç”¨ç¤ºä¾‹"><a href="#3-3-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="3.3 ä½¿ç”¨ç¤ºä¾‹"></a><font size=3>3.3 ä½¿ç”¨ç¤ºä¾‹</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> <span class="title">sem</span>;</span> <span class="comment">/* å®šä¹‰ä¿¡å·é‡ */</span></span><br><span class="line">sema_init(&amp;sem, <span class="number">1</span>); <span class="comment">/* åˆå§‹åŒ–ä¿¡å·é‡ */</span></span><br><span class="line">down(&amp;sem); <span class="comment">/* ç”³è¯·ä¿¡å·é‡ */</span></span><br><span class="line"><span class="comment">/* ä¸´ç•ŒåŒº */</span></span><br><span class="line">up(&amp;sem); <span class="comment">/* é‡Šæ”¾ä¿¡å·é‡ */</span></span><br></pre></td></tr></table></figure>

<h2 id="4-ä¿¡å·é‡demo"><a href="#4-ä¿¡å·é‡demo" class="headerlink" title="4. ä¿¡å·é‡demo"></a><font size=3>4. ä¿¡å·é‡demo</font></h2><h3 id="4-1-demoæºç "><a href="#4-1-demoæºç " class="headerlink" title="4.1 demoæºç "></a><font size=3>4.1 demoæºç </font></h3><p><a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/tree/master/07_concurrency/05_semaphore">07_concurrency&#x2F;05_semaphore Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<h3 id="4-2-å¼€å‘æ¿éªŒè¯"><a href="#4-2-å¼€å‘æ¿éªŒè¯" class="headerlink" title="4.2 å¼€å‘æ¿éªŒè¯"></a><font size=3>4.2 å¼€å‘æ¿éªŒè¯</font></h3><p>æˆ‘ä»¬å°†ç¼–è¯‘å¾—åˆ°çš„sdriver_demo.koã€app_demo.outæ‹·è´åˆ°å¼€å‘æ¿ã€‚</p>
<ul>
<li>ï¼ˆ1ï¼‰åŠ è½½é©±åŠ¨</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insmod sdriver_demo.ko</span><br></pre></td></tr></table></figure>

<ul>
<li>ï¼ˆ2ï¼‰app_demo.out ä¼šåˆ›å»ºå­è¿›ç¨‹è¿è¡Œ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./app_demo.out /dev/sdevchr 2</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122111727299.png" alt="image-20250122111727299"  />

<p>å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªæ‰§è¡Œå®Œå†æ‰§è¡Œå¦ä¸€ä¸ªã€‚æ²¡æœ‰ä¿¡å·é‡ä¿æŠ¤çš„æ—¶å€™æ˜¯è¿™æ ·çš„ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122111851029.png" alt="image-20250122111851029"  />

<h1 id="å››ã€äº’æ–¥é”"><a href="#å››ã€äº’æ–¥é”" class="headerlink" title="å››ã€äº’æ–¥é”"></a><font size=3>å››ã€äº’æ–¥é”</font></h1><h2 id="1-ä»€ä¹ˆæ˜¯äº’æ–¥é”"><a href="#1-ä»€ä¹ˆæ˜¯äº’æ–¥é”" class="headerlink" title="1. ä»€ä¹ˆæ˜¯äº’æ–¥é”"></a><font size=3>1. ä»€ä¹ˆæ˜¯äº’æ–¥é”</font></h2><p>æ¯”å¦‚å…¬å¸éƒ¨é—¨é‡Œï¼Œ æˆ‘åœ¨ä½¿ç”¨ç€æ‰“å°æœºæ‰“å°ä¸œè¥¿çš„åŒæ—¶ï¼ˆè¿˜æ²¡æœ‰æ‰“å°å®Œï¼‰ ï¼Œ åˆ«äººåˆšå¥½ä¹Ÿåœ¨æ­¤åˆ»ä½¿ç”¨æ‰“å°æœºæ‰“å°ä¸œè¥¿ï¼Œ å¦‚æœä¸åšä»»ä½•å¤„ç†çš„è¯ï¼Œæ‰“å°å‡ºæ¥çš„ä¸œè¥¿è‚¯å®šæ˜¯é”™ä¹±çš„ã€‚ é‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ç§æƒ…å†µå‘¢ï¼Ÿ åªè¦æˆ‘åœ¨æ‰“å°ç€çš„æ—¶å€™åˆ«äººæ˜¯ä¸å…è®¸æ‰“å°çš„ï¼Œ åªæœ‰ç­‰æˆ‘æ‰“å°ç»“æŸååˆ«äººæ‰å…è®¸æ‰“å°ã€‚ è¿™ä¸ªè¿‡ç¨‹æœ‰ç‚¹ç±»ä¼¼äºï¼Œ æŠŠæ‰“å°æœºæ”¾åœ¨ä¸€ä¸ªæˆ¿é—´é‡Œï¼Œ ç»™è¿™ä¸ªæˆ¿é—´å®‰æŠŠé”ï¼Œ è¿™ä¸ªé”é»˜è®¤æ˜¯æ‰“å¼€çš„ã€‚ å½“ A éœ€è¦æ‰“å°æ—¶ï¼Œ ä»–å…ˆè¿‡æ¥æ£€æŸ¥è¿™æŠŠé”æœ‰æ²¡æœ‰é”ç€ï¼Œ æ²¡æœ‰çš„è¯å°±è¿›å»ï¼Œ åŒæ—¶ä¸Šé”åœ¨æˆ¿é—´é‡Œæ‰“å°ã€‚ è€Œåœ¨è¿™æ—¶ï¼Œ åˆšå¥½ B ä¹Ÿéœ€è¦æ‰“å°ï¼Œ B åŒæ ·å…ˆæ£€æŸ¥é”ï¼Œ å‘ç°é”æ˜¯é”ä½çš„ï¼Œ ä»–å°±åœ¨é—¨å¤–ç­‰ç€ã€‚ è€Œå½“ A æ‰“å°ç»“æŸåï¼Œ ä»–ä¼šå¼€é”å‡ºæ¥ï¼Œ è¿™æ—¶å€™ B æ‰è¿›å»ä¸Šé”æ‰“å°ã€‚ </p>
<p>ç°åœ¨åº”è¯¥å°±çŸ¥é“äº’æ–¥é”æ˜¯ä»€ä¹ˆäº†ï¼Œä¹Ÿå¯ä»¥å«äº’æ–¥ä½“ï¼Œåé¢æˆ‘è¿˜æ˜¯å«äº’æ–¥é”å§ã€‚äº’æ–¥é”ä¼šå¯¼è‡´ä¼‘çœ ï¼Œ æ‰€ä»¥åœ¨ä¸­æ–­é‡Œé¢ä¸èƒ½ç”¨äº’æ–¥é”ã€‚ <strong>åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰äº’æ–¥é”ï¼Œå¹¶ä¸”åªæœ‰æŒæœ‰è€…æ‰å¯ä»¥è§£é”ï¼Œ å¹¶ä¸”ä¸å…è®¸é€’å½’ä¸Šé”å’Œè§£é”ã€‚</strong></p>
<p>æˆ‘ä»¬å°†ä¿¡å·é‡é‡å€¼è®¾ç½®ä¸º 1ï¼Œ æœ€ç»ˆå®ç°çš„å°±æ˜¯äº’æ–¥æ•ˆæœï¼Œè™½ç„¶ä¸¤è€…åŠŸèƒ½ç›¸åŒä½†æ˜¯å…·ä½“çš„å®ç°æ–¹å¼æ˜¯ä¸åŒçš„ï¼Œ ä½†æ˜¯ä½¿ç”¨äº’æ–¥é”æ•ˆç‡æ›´é«˜ã€æ›´ç®€æ´ï¼Œ æ‰€ä»¥å¦‚æœä½¿ç”¨åˆ°çš„ä¿¡å·é‡â€œé‡å€¼â€ä¸º 1ï¼Œ ä¸€èˆ¬å°†å…¶ä¿®æ”¹ä¸ºä½¿ç”¨äº’æ–¥é”å®ç°ã€‚</p>
<p>å½“æœ‰å¤šä¸ªçº¿ç¨‹å‡ ä¹åŒæ—¶ä¿®æ”¹æŸä¸€ä¸ªå…±äº«æ•°æ®çš„æ—¶å€™ï¼Œ éœ€è¦è¿›è¡ŒåŒæ­¥æ§åˆ¶ã€‚ çº¿ç¨‹åŒæ­¥èƒ½å¤Ÿä¿è¯å¤šä¸ªçº¿ç¨‹å®‰å…¨è®¿é—®ç«äº‰èµ„æºï¼Œ æœ€ç®€å•çš„åŒæ­¥æœºåˆ¶æ˜¯å¼•å…¥äº’æ–¥é”ã€‚ äº’æ–¥é”ä¸ºèµ„æºå¼•å…¥ä¸€ä¸ªçŠ¶æ€ï¼šé”å®šæˆ–è€…éé”å®šã€‚ æŸä¸ªçº¿ç¨‹è¦æ›´æ”¹å…±äº«æ•°æ®æ—¶ï¼Œ å…ˆå°†å…¶é”å®šï¼Œ æ­¤æ—¶èµ„æºçš„çŠ¶æ€ä¸ºâ€œé”å®šâ€ ï¼Œ å…¶ä»–çº¿ç¨‹ä¸èƒ½æ›´æ”¹ï¼› ç›´åˆ°è¯¥çº¿ç¨‹é‡Šæ”¾èµ„æºï¼Œ å°†èµ„æºçš„çŠ¶æ€å˜æˆâ€œéé”å®šâ€ ï¼Œ å…¶ä»–çš„çº¿ç¨‹æ‰èƒ½å†æ¬¡é”å®šè¯¥èµ„æºã€‚ äº’æ–¥é”ä¿è¯äº†æ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå†™å…¥æ“ä½œï¼Œ ä»è€Œä¿è¯äº†å¤šçº¿ç¨‹æƒ…å†µä¸‹æ•°æ®çš„æ­£ç¡®æ€§ï¼Œ èƒ½å¤Ÿä¿è¯å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«æ•°æ®ä¸ä¼šå‡ºç°èµ„æºç«äº‰åŠæ•°æ®é”™è¯¯ã€‚</p>
<h2 id="2-ç›¸å…³æ•°æ®ç»“æ„ä¸API-1"><a href="#2-ç›¸å…³æ•°æ®ç»“æ„ä¸API-1" class="headerlink" title="2. ç›¸å…³æ•°æ®ç»“æ„ä¸API"></a><font size=3>2. ç›¸å…³æ•°æ®ç»“æ„ä¸API</font></h2><h3 id="2-1-struct-mutex"><a href="#2-1-struct-mutex" class="headerlink" title="2.1Â struct mutex"></a><font size=3>2.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/mutex.h#L53">struct mutex</a></font></h3><p>Linux å†…æ ¸ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/mutex.h#L53">struct mutex</a> æ¥è¡¨ç¤ºäº’æ–¥é”ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> &#123;</span></span><br><span class="line">	<span class="type">atomic_long_t</span>		owner;</span><br><span class="line">	<span class="type">spinlock_t</span>		wait_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MUTEX_SPIN_ON_OWNER</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">optimistic_spin_queue</span> <span class="title">osq</span>;</span> <span class="comment">/* Spinner MCS lock */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">wait_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_MUTEXES</span></span><br><span class="line">	<span class="type">void</span>			*magic;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span>	<span class="title">dep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-äº’æ–¥é”ç›¸å…³API"><a href="#2-2-äº’æ–¥é”ç›¸å…³API" class="headerlink" title="2.2 äº’æ–¥é”ç›¸å…³API"></a><font size=3>2.2 äº’æ–¥é”ç›¸å…³API</font></h3><p>ç›¸å…³çš„APIåœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/mutex.h">mutex.h - include&#x2F;linux&#x2F;mutex.h</a> ä¸­æœ‰å¯¹åº”çš„å£°æ˜æˆ–è€…å®šä¹‰ï¼š</p>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>DEFINE_MUTEX(name)</td>
<td>å®šä¹‰å¹¶åˆå§‹åŒ–ä¸€ä¸ª mutex å˜é‡ã€‚</td>
</tr>
<tr>
<td>void mutex_init(mutex *lock)</td>
<td>åˆå§‹åŒ– mutexã€‚</td>
</tr>
<tr>
<td>void mutex_lock(struct mutex *lock)</td>
<td>è·å– mutexï¼Œä¹Ÿå°±æ˜¯ç»™ mutex ä¸Šé”ã€‚å¦‚æœè·å–ä¸åˆ°å°±è¿›ä¼‘çœ ã€‚</td>
</tr>
<tr>
<td>void mutex_unlock(struct mutex *lock)</td>
<td>é‡Šæ”¾ mutexï¼Œä¹Ÿå°±ç»™ mutex è§£é”ã€‚</td>
</tr>
<tr>
<td>int mutex_trylock(struct mutex *lock)</td>
<td>å°è¯•è·å– mutexï¼Œå¦‚æœæˆåŠŸå°±è¿”å› 1ï¼Œå¦‚æœå¤±è´¥å°±è¿”å› 0ã€‚</td>
</tr>
<tr>
<td>int mutex_is_locked(struct mutex *lock)</td>
<td>åˆ¤æ–­ mutex æ˜¯å¦è¢«è·å–ï¼Œå¦‚æœæ˜¯çš„è¯å°±è¿”å›1ï¼Œå¦åˆ™è¿”å› 0ã€‚</td>
</tr>
<tr>
<td>int mutex_lock_interruptible(struct mutex *lock)</td>
<td>ä½¿ç”¨æ­¤å‡½æ•°è·å–ä¿¡å·é‡å¤±è´¥è¿›å…¥ä¼‘çœ ä»¥åå¯ä»¥è¢«ä¿¡å·æ‰“æ–­ã€‚</td>
</tr>
</tbody></table>
<h3 id="2-3-ä½¿ç”¨ç¤ºä¾‹"><a href="#2-3-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="2.3 ä½¿ç”¨ç¤ºä¾‹"></a><font size=3>2.3 ä½¿ç”¨ç¤ºä¾‹</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span> <span class="comment">/* å®šä¹‰ä¸€ä¸ªäº’æ–¥ä½“ */</span></span><br><span class="line">mutex_init(&amp;lock); <span class="comment">/* åˆå§‹åŒ–äº’æ–¥ä½“ */</span></span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;lock); <span class="comment">/* ä¸Šé” */</span></span><br><span class="line"><span class="comment">/* ä¸´ç•ŒåŒº */</span></span><br><span class="line">mutex_unlock(&amp;lock); <span class="comment">/* è§£é” */</span></span><br></pre></td></tr></table></figure>



<h2 id="3-æ³¨æ„äº‹é¡¹"><a href="#3-æ³¨æ„äº‹é¡¹" class="headerlink" title="3. æ³¨æ„äº‹é¡¹"></a><font size=3>3. æ³¨æ„äº‹é¡¹</font></h2><p>åœ¨ä½¿ç”¨ mutex çš„æ—¶å€™è¦æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š  </p>
<p>â‘ ã€ mutex å¯ä»¥å¯¼è‡´ä¼‘çœ ï¼Œå› æ­¤ä¸èƒ½åœ¨ä¸­æ–­ä¸­ä½¿ç”¨ mutexï¼Œä¸­æ–­ä¸­åªèƒ½ä½¿ç”¨è‡ªæ—‹é”ã€‚</p>
<p>â‘¡ã€å’Œä¿¡å·é‡ä¸€æ ·ï¼Œ mutex ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¯ä»¥è°ƒç”¨å¼•èµ·é˜»å¡çš„ API å‡½æ•°ã€‚</p>
<p>â‘¢ã€å› ä¸ºä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŒæœ‰ mutexï¼Œå› æ­¤ï¼Œå¿…é¡»ç”± mutex çš„æŒæœ‰è€…é‡Šæ”¾ mutexã€‚å¹¶ä¸” mutex ä¸èƒ½é€’å½’ä¸Šé”å’Œè§£é”ã€‚</p>
<h2 id="4-äº’æ–¥é”demo"><a href="#4-äº’æ–¥é”demo" class="headerlink" title="4. äº’æ–¥é”demo"></a><font size=3>4. äº’æ–¥é”demo</font></h2><h3 id="4-1-demoæºç -1"><a href="#4-1-demoæºç -1" class="headerlink" title="4.1 demoæºç "></a><font size=3>4.1 demoæºç </font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span> <span class="comment">/* module_init module_exit */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span> <span class="comment">/* MODULE_LICENSE */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span> <span class="comment">/* ssleep */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./timestamp_autogenerated.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./version_autogenerated.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./sdrv_common.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #undef PRT</span></span><br><span class="line"><span class="comment">// #undef PRTE</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PRT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRT printk</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PRTE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRTE printk</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHRDEV_NAME <span class="string">&quot;sdev&quot;</span>    <span class="comment">/* è®¾å¤‡å,cat /proc/devices æŸ¥çœ‹ä¸è®¾å¤‡å·çš„å¯¹åº”å…³ç³» */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLASS_NAME  <span class="string">&quot;sclass&quot;</span>  <span class="comment">/* ç±»åï¼Œåœ¨ /sys/class ä¸­æ˜¾ç¤ºçš„åç§° */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">&quot;sdevchr&quot;</span> <span class="comment">/* è®¾å¤‡èŠ‚ç‚¹åï¼Œåœ¨ /sys/class/class_name/ ä¸­æ˜¾ç¤ºçš„åç§°ä»¥åŠ /dev/ ä¸‹æ˜¾ç¤ºçš„èŠ‚ç‚¹å */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE     32        <span class="comment">/* è®¾ç½®æœ€å¤§åç§»é‡ä¸º32 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MUTEX_FLAG  0         <span class="comment">/* ç”¨äºæœ‰æ— ä¿¡å·é‡çš„ç°è±¡å¯¹æ¯” */</span></span></span><br><span class="line"><span class="comment">// ioctl æ”¯æŒçš„å‘½ä»¤å®šä¹‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_TEST0 _IO(<span class="string">&#x27;S&#x27;</span>, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_TEST1 _IOW(<span class="string">&#x27;S&#x27;</span>, 1, int)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_TEST2 _IOR(<span class="string">&#x27;S&#x27;</span>, 2, int)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_TEST3 _IOW(<span class="string">&#x27;S&#x27;</span>, 3, int)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CMD_TEST</span>&#123;</span></span><br><span class="line">	<span class="type">int</span> a;</span><br><span class="line">	<span class="type">int</span> b;</span><br><span class="line">	<span class="type">int</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">CHAR_DEVICE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> dev_name[<span class="number">32</span>];     <span class="comment">// è®¾å¤‡åç§°ï¼Œ /dev/dev-name</span></span><br><span class="line">    <span class="type">dev_t</span> dev_num;         <span class="comment">// å®šä¹‰dev_tç±»å‹ï¼ˆ32ä½å¤§å°ï¼‰çš„å˜é‡dev_num,ç”¨æ¥å­˜æ”¾è®¾å¤‡å·</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">s_cdev</span>;</span>    <span class="comment">// å®šä¹‰cdevç»“æ„ä½“ç±»å‹çš„å˜é‡scdev</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span>   <span class="comment">// å®šäºstruct class *ç±»å‹ç»“æ„ä½“å˜é‡ classï¼Œè¡¨ç¤ºè¦åˆ›å»ºçš„ç±»</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span> <span class="comment">// è®¾å¤‡</span></span><br><span class="line">    <span class="type">char</span> buf[BUFSIZE];     <span class="comment">// è®¾ç½®æ•°æ®å­˜å‚¨æ•°ç»„mem</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex_lock</span>;</span>  <span class="comment">// äº’æ–¥é”</span></span><br><span class="line">&#125; _CHAR_DEVICE;</span><br><span class="line"></span><br><span class="line">_CHAR_DEVICE g_chrdev = &#123;<span class="number">0</span>&#125;;  <span class="comment">//å®šä¹‰ä¸€ä¸ªdevice_testç»“æ„ä½“å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">scdev_ops_open</span><span class="params">(<span class="keyword">struct</span> inode *pInode, <span class="keyword">struct</span> file *pFile)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    PRT(<span class="string">&quot;This is scdev_ops_open!dev name=%s\n&quot;</span>, g_chrdev.dev_name);</span><br><span class="line">    pFile-&gt;private_data = &amp;g_chrdev;  <span class="comment">// è®¾ç½®ç§æœ‰æ•°æ®</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> MUTEX_FLAG == 1</span></span><br><span class="line">    <span class="comment">/* è·å–äº’æ–¥é”,å¯ä»¥è¢«ä¿¡å·æ‰“æ–­ */</span></span><br><span class="line">    <span class="keyword">if</span> (mutex_lock_interruptible(&amp;g_chrdev.mutex_lock))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    mutex_lock(&amp;g_chrdev.lock); <span class="comment">/* ä¸èƒ½è¢«ä¿¡å·æ‰“æ–­ */</span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">scdev_ops_read</span><span class="params">(<span class="keyword">struct</span> file *pFile, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span></span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">loff_t</span> offset = *off; <span class="comment">// å°†è¯»å–æ•°æ®çš„åç§»é‡èµ‹å€¼ç»™loff_tç±»å‹å˜é‡p</span></span><br><span class="line">    <span class="type">size_t</span> count = size;</span><br><span class="line">    _CHAR_DEVICE *p_chrdev=(_CHAR_DEVICE *)pFile-&gt;private_data; <span class="comment">//åœ¨writeå‡½æ•°ä¸­è¯»å–private_data</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (offset &gt; BUFSIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; BUFSIZE - offset)</span><br><span class="line">    &#123;</span><br><span class="line">        count = BUFSIZE - offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(buf, p_chrdev-&gt;buf + offset, count))</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="comment">// å°†memä¸­çš„å€¼å†™å…¥bufï¼Œå¹¶ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´</span></span><br><span class="line">        PRT(<span class="string">&quot;copy_to_user error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; BUFSIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        PRT(<span class="string">&quot;buf[%d] %c\n&quot;</span>, i, p_chrdev-&gt;buf[i]); <span class="comment">// å°†memä¸­çš„å€¼æ‰“å°å‡ºæ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    PRT(<span class="string">&quot;read offset is %llu, count is %d\n&quot;</span>, offset, count);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    *off = *off + count; <span class="comment">// æ›´æ–°åç§»å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">scdev_ops_write</span><span class="params">(<span class="keyword">struct</span> file *pFile, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">loff_t</span> offset = *off; <span class="comment">// å°†è¯»å–æ•°æ®çš„åç§»é‡èµ‹å€¼ç»™loff_tç±»å‹å˜é‡p</span></span><br><span class="line">    <span class="type">size_t</span> count = size;</span><br><span class="line">    _CHAR_DEVICE *p_chrdev=(_CHAR_DEVICE *)pFile-&gt;private_data; <span class="comment">//åœ¨writeå‡½æ•°ä¸­è¯»å–private_data</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (offset &gt; BUFSIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; BUFSIZE - offset)</span><br><span class="line">    &#123;</span><br><span class="line">        count = BUFSIZE - offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(p_chrdev-&gt;buf + offset, buf, count))</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="comment">// å°†bufä¸­çš„å€¼ï¼Œä»ç”¨æˆ·ç©ºé—´ä¼ é€’åˆ°å†…æ ¸ç©ºé—´</span></span><br><span class="line">        PRT(<span class="string">&quot;copy_to_user error \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PRT(<span class="string">&quot;copy_from_user buf is %s\n&quot;</span>, p_chrdev-&gt;buf + offset);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; BUFSIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        PRT(<span class="string">&quot;buf[%d] %c\n&quot;</span>, i, p_chrdev-&gt;buf[i]); <span class="comment">// å°†memä¸­çš„å€¼æ‰“å°å‡ºæ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    PRT(<span class="string">&quot;write offset is %llu, count is %d\n&quot;</span>, offset, count); <span class="comment">// æ‰“å°å†™å…¥çš„å€¼</span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    *off = *off + count;                         <span class="comment">// æ›´æ–°åç§»å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">scdev_ops_release</span><span class="params">(<span class="keyword">struct</span> inode *pInode, <span class="keyword">struct</span> file *pFile)</span></span><br><span class="line">&#123;</span><br><span class="line">    _CHAR_DEVICE *p_chrdev=(_CHAR_DEVICE *)pFile-&gt;private_data; <span class="comment">//åœ¨writeå‡½æ•°ä¸­è¯»å–private_data</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> MUTEX_FLAG == 1</span></span><br><span class="line">    mutex_unlock(&amp;p_chrdev-&gt;mutex_lock);<span class="comment">// é‡Šæ”¾äº’æ–¥é”</span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    PRT(<span class="string">&quot;This is scdev_ops_release!dev_name=%s\n&quot;</span>, p_chrdev-&gt;dev_name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">loff_t</span> <span class="title function_">scdev_ops_llseek</span><span class="params">(<span class="keyword">struct</span> file *pFile, <span class="type">loff_t</span> offset, <span class="type">int</span> whence)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">loff_t</span> new_offset = <span class="number">0</span>; <span class="comment">// å®šä¹‰loff_tç±»å‹çš„æ–°çš„åç§»å€¼</span></span><br><span class="line">    <span class="keyword">switch</span> (whence)    <span class="comment">// å¯¹lseekå‡½æ•°ä¼ é€’çš„whenceå‚æ•°è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> SEEK_SET:</span><br><span class="line">            <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || offset &gt; BUFSIZE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> -EINVAL; <span class="comment">// EINVAL=22 è¡¨ç¤ºæ— æ•ˆå‚æ•°</span></span><br><span class="line">            &#125;</span><br><span class="line">            new_offset = offset; <span class="comment">// å¦‚æœwhenceå‚æ•°ä¸ºSEEK_SETï¼Œåˆ™æ–°åç§»å€¼ä¸ºoffset</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SEEK_CUR:</span><br><span class="line">            <span class="keyword">if</span> ((pFile-&gt;f_pos + offset &lt; <span class="number">0</span>) || (pFile-&gt;f_pos + offset &gt; BUFSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">            &#125;</span><br><span class="line">            new_offset = pFile-&gt;f_pos + offset; <span class="comment">// å¦‚æœwhenceå‚æ•°ä¸ºSEEK_CURï¼Œåˆ™æ–°åç§»å€¼ä¸ºpFile-&gt;f_pos + offsetï¼ŒpFile-&gt;f_posä¸ºå½“å‰çš„åç§»å€¼</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SEEK_END:</span><br><span class="line">            <span class="keyword">if</span> (pFile-&gt;f_pos + offset &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">            &#125;</span><br><span class="line">            new_offset = BUFSIZE + offset; <span class="comment">// å¦‚æœwhenceå‚æ•°ä¸ºSEEK_ENDï¼Œåˆ™æ–°åç§»å€¼ä¸ºBUFSIZE + offsetï¼ŒBUFSIZEä¸ºæœ€å¤§åç§»é‡</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pFile-&gt;f_pos = new_offset; <span class="comment">// æ›´æ–°pFile-&gt;f_posåç§»å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> new_offset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">scdev_ops_ioctl</span><span class="params">(<span class="keyword">struct</span> file *pFile, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> val = <span class="number">0</span>;<span class="comment">//å®šä¹‰ int ç±»å‹å‘åº”ç”¨ç©ºé—´ä¼ é€’çš„å˜é‡ val</span></span><br><span class="line">    <span class="keyword">switch</span>(cmd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> CMD_TEST0:</span><br><span class="line">            PRT(<span class="string">&quot;this is CMD_TEST0\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_TEST1:</span><br><span class="line">            PRT(<span class="string">&quot;this is CMD_TEST1\n&quot;</span>);</span><br><span class="line">            PRT(<span class="string">&quot;arg is %ld\n&quot;</span>,arg);<span class="comment">//æ‰“å°åº”ç”¨ç©ºé—´ä¼ é€’æ¥çš„ arg å‚æ•°</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_TEST2:</span><br><span class="line">            val = <span class="number">1</span>;<span class="comment">//å°†è¦ä¼ é€’çš„å˜é‡ val èµ‹å€¼ä¸º 1</span></span><br><span class="line">            PRT(<span class="string">&quot;this is CMD_TEST2\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(copy_to_user((<span class="type">int</span> *)arg, &amp;val, <span class="keyword">sizeof</span>(val)) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//é€šè¿‡ copy_to_user å‘ç”¨æˆ·ç©ºé—´ä¼ é€’æ•°æ®</span></span><br><span class="line">                PRT(<span class="string">&quot;copy_to_user error \n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_TEST3:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> __<span class="title">CMD_TEST</span> <span class="title">cmd_test3</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span> (copy_from_user(&amp;cmd_test3, (<span class="type">int</span> *)arg, <span class="keyword">sizeof</span>(cmd_test3)) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                PRT(<span class="string">&quot;copy_from_user error\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            PRT(<span class="string">&quot;cmd_test3.a = %d\n&quot;</span>, cmd_test3.a);</span><br><span class="line">            PRT(<span class="string">&quot;cmd_test3.b = %d\n&quot;</span>, cmd_test3.b);</span><br><span class="line">            PRT(<span class="string">&quot;cmd_test3.c = %d\n&quot;</span>, cmd_test3.c);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">g_scdev_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,<span class="comment">//å°†ownerå­—æ®µæŒ‡å‘æœ¬æ¨¡å—ï¼Œå¯ä»¥é¿å…åœ¨æ¨¡å—çš„æ“ä½œæ­£åœ¨è¢«ä½¿ç”¨æ—¶å¸è½½è¯¥æ¨¡å—</span></span><br><span class="line">	.open = scdev_ops_open,</span><br><span class="line">	.read = scdev_ops_read,</span><br><span class="line">	.write = scdev_ops_write,</span><br><span class="line">	.release = scdev_ops_release,</span><br><span class="line">    .llseek = scdev_ops_llseek,</span><br><span class="line">    .unlocked_ioctl = scdev_ops_ioctl,</span><br><span class="line">&#125;; <span class="comment">// å®šä¹‰file_operationsç»“æ„ä½“ç±»å‹çš„å˜é‡g_cdev_dev_ops</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">scdev_create</span><span class="params">(_CHAR_DEVICE *p_chrdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;          <span class="comment">// å®šä¹‰intç±»å‹çš„å˜é‡retï¼Œç”¨æ¥åˆ¤æ–­å‡½æ•°è¿”å›å€¼</span></span><br><span class="line">    <span class="type">int</span> major, minor; <span class="comment">// å®šä¹‰intç±»å‹çš„ä¸»è®¾å¤‡å·majorå’Œæ¬¡è®¾å¤‡å·minor</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> MUTEX_FLAG == 1</span></span><br><span class="line">	mutex_init(&amp;p_chrdev-&gt;mutex_lock);	<span class="comment">/* åˆå§‹åŒ–äº’æ–¥é” */</span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ret = alloc_chrdev_region(&amp;p_chrdev-&gt;dev_num, <span class="number">0</span>, <span class="number">1</span>, CHRDEV_NAME); <span class="comment">// è‡ªåŠ¨è·å–è®¾å¤‡å·ï¼Œè®¾å¤‡åä¸ºchrdev_name</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        PRTE(<span class="string">&quot;alloc_chrdev_region is error!ret=%d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> err_alloc_devno;</span><br><span class="line">    &#125;</span><br><span class="line">    major = MAJOR(p_chrdev-&gt;dev_num); <span class="comment">// ä½¿ç”¨MAJOR()å‡½æ•°è·å–ä¸»è®¾å¤‡å·</span></span><br><span class="line">    minor = MINOR(p_chrdev-&gt;dev_num); <span class="comment">// ä½¿ç”¨MINOR()å‡½æ•°è·å–æ¬¡è®¾å¤‡å·</span></span><br><span class="line">    <span class="comment">//PRT(&quot;major is %d, minor is %d !\n&quot;, major, minor);</span></span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;p_chrdev-&gt;s_cdev, &amp;g_scdev_ops); <span class="comment">// ä½¿ç”¨cdev_init()å‡½æ•°åˆå§‹åŒ–p_chrdev-&gt;s_cdevç»“æ„ä½“ï¼Œå¹¶é“¾æ¥åˆ° cdev_ops ç»“æ„ä½“</span></span><br><span class="line">    p_chrdev-&gt;s_cdev.owner = THIS_MODULE;          <span class="comment">// å°†ownerå­—æ®µæŒ‡å‘æœ¬æ¨¡å—ï¼Œå¯ä»¥é¿å…åœ¨æ¨¡å—çš„æ“ä½œæ­£åœ¨è¢«ä½¿ç”¨æ—¶å¸è½½è¯¥æ¨¡å—</span></span><br><span class="line">    ret = cdev_add(&amp;p_chrdev-&gt;s_cdev, p_chrdev-&gt;dev_num, <span class="number">1</span>); <span class="comment">// ä½¿ç”¨cdev_add()å‡½æ•°è¿›è¡Œå­—ç¬¦è®¾å¤‡çš„æ·»åŠ </span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        PRTE(<span class="string">&quot;cdev_add is error !ret=%d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> err_cdev_add;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p_chrdev-&gt;<span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, CLASS_NAME); <span class="comment">// ä½¿ç”¨class_createè¿›è¡Œç±»çš„åˆ›å»ºï¼Œç±»åç§°ä¸º class_dev</span></span><br><span class="line">    <span class="keyword">if</span>(IS_ERR(p_chrdev-&gt;class))</span><br><span class="line">    &#123;</span><br><span class="line">        ret = PTR_ERR(p_chrdev-&gt;class);</span><br><span class="line">        <span class="keyword">goto</span> err_class_create;</span><br><span class="line">    &#125;</span><br><span class="line">    p_chrdev-&gt;device = device_create(p_chrdev-&gt;class, <span class="literal">NULL</span>, p_chrdev-&gt;dev_num, <span class="literal">NULL</span>, <span class="string">&quot;%s&quot;</span>, DEVICE_NAME); <span class="comment">// ä½¿ç”¨device_createè¿›è¡Œè®¾å¤‡çš„åˆ›å»ºï¼Œè®¾å¤‡åç§°ä¸º device_dev</span></span><br><span class="line">    <span class="keyword">if</span>(IS_ERR(p_chrdev-&gt;device))</span><br><span class="line">    &#123;</span><br><span class="line">        ret = PTR_ERR(p_chrdev-&gt;class);</span><br><span class="line">        <span class="keyword">goto</span> err_device_create;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">snprintf</span> (p_chrdev-&gt;dev_name, <span class="keyword">sizeof</span>(p_chrdev-&gt;dev_name), <span class="string">&quot;/dev/%s&quot;</span>, DEVICE_NAME);</span><br><span class="line">    PRT(<span class="string">&quot;scdev_create %s success!\n&quot;</span>, p_chrdev-&gt;dev_name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ä¸€äº›åˆ—çš„é”™è¯¯å¤„ç†</span></span><br><span class="line">err_device_create:</span><br><span class="line">    class_destroy(p_chrdev-&gt;class);   <span class="comment">// åˆ é™¤åˆ›å»ºçš„ç±»</span></span><br><span class="line">err_class_create:</span><br><span class="line">    cdev_del(&amp;p_chrdev-&gt;s_cdev);      <span class="comment">// ä½¿ç”¨cdev_del()å‡½æ•°è¿›è¡Œå­—ç¬¦è®¾å¤‡çš„åˆ é™¤</span></span><br><span class="line">err_cdev_add:</span><br><span class="line">    unregister_chrdev_region(p_chrdev-&gt;dev_num, <span class="number">1</span>); <span class="comment">//æ³¨é”€è®¾å¤‡å·</span></span><br><span class="line">err_alloc_devno:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">scdev_destroy</span><span class="params">(_CHAR_DEVICE *p_chrdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ å­—ç¬¦è®¾å¤‡çš„æ³¨å†Œè¦æ”¾åœ¨ç”³è¯·å­—ç¬¦è®¾å¤‡å·ä¹‹åï¼Œ</span></span><br><span class="line">    <span class="comment">// å­—ç¬¦è®¾å¤‡çš„åˆ é™¤è¦æ”¾åœ¨é‡Šæ”¾å­—ç¬¦é©±åŠ¨è®¾å¤‡å·ä¹‹å‰ã€‚</span></span><br><span class="line">    cdev_del(&amp;p_chrdev-&gt;s_cdev);                    <span class="comment">// ä½¿ç”¨cdev_del()å‡½æ•°è¿›è¡Œå­—ç¬¦è®¾å¤‡çš„åˆ é™¤</span></span><br><span class="line">    unregister_chrdev_region(p_chrdev-&gt;dev_num, <span class="number">1</span>); <span class="comment">// é‡Šæ”¾å­—ç¬¦é©±åŠ¨è®¾å¤‡å·</span></span><br><span class="line">    device_destroy(p_chrdev-&gt;class, p_chrdev-&gt;dev_num); <span class="comment">// åˆ é™¤åˆ›å»ºçš„è®¾å¤‡</span></span><br><span class="line">    class_destroy(p_chrdev-&gt;class);                 <span class="comment">// åˆ é™¤åˆ›å»ºçš„ç±»</span></span><br><span class="line">    PRT(<span class="string">&quot;scdev_destroy success!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  sdrv_demo_init</span></span><br><span class="line"><span class="comment"> * @note   æ³¨å†Œé©±åŠ¨</span></span><br><span class="line"><span class="comment"> * @param [in]</span></span><br><span class="line"><span class="comment"> * @param [out]</span></span><br><span class="line"><span class="comment"> * @retval </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> __init <span class="type">int</span> <span class="title function_">sdrv_demo_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	printk(<span class="string">&quot;*** [%s:%d]Build Time: %s %s, git version:%s ***\n&quot;</span>, __FUNCTION__,</span><br><span class="line">           __LINE__, KERNEL_KO_DATE, KERNEL_KO_TIME, KERNEL_KO_VERSION);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ³¨å†Œå­—ç¬¦è®¾å¤‡</span></span><br><span class="line">    ret = scdev_create(&amp;g_chrdev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        PRTE(<span class="string">&quot;Failed to scdev_create!ret=%d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> err_scdev_create;</span><br><span class="line">    &#125;</span><br><span class="line">    PRT(<span class="string">&quot;sdrv_demo module init success!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_scdev_create:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  sdrv_demo_exit</span></span><br><span class="line"><span class="comment"> * @note   æ³¨é”€é©±åŠ¨</span></span><br><span class="line"><span class="comment"> * @param [in]</span></span><br><span class="line"><span class="comment"> * @param [out]</span></span><br><span class="line"><span class="comment"> * @retval </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> __exit <span class="type">void</span> <span class="title function_">sdrv_demo_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ³¨é”€å­—ç¬¦è®¾å¤‡</span></span><br><span class="line">    scdev_destroy(&amp;g_chrdev);</span><br><span class="line">    PRT(<span class="string">&quot;sdrv_demo module exit!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(sdrv_demo_init); <span class="comment">// å°†__initå®šä¹‰çš„å‡½æ•°æŒ‡å®šä¸ºé©±åŠ¨çš„å…¥å£å‡½æ•°</span></span><br><span class="line">module_exit(sdrv_demo_exit); <span class="comment">// å°†__exitå®šä¹‰çš„å‡½æ•°æŒ‡å®šä¸ºé©±åŠ¨çš„å‡ºå£å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¨¡å—ä¿¡æ¯(é€šè¿‡ modinfo xxx.ko æŸ¥çœ‹) */</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL v2&quot;</span>);            <span class="comment">/* æºç çš„è®¸å¯è¯åè®® */</span></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;sumu&quot;</span>);               <span class="comment">/* å­—ç¬¦ä¸²å¸¸é‡å†…å®¹ä¸ºæ¨¡å—ä½œè€…è¯´æ˜ */</span></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Description&quot;</span>);   <span class="comment">/* å­—ç¬¦ä¸²å¸¸é‡å†…å®¹ä¸ºæ¨¡å—åŠŸèƒ½è¯´æ˜ */</span></span><br><span class="line">MODULE_ALIAS(<span class="string">&quot;module&#x27;s other name&quot;</span>); <span class="comment">/* å­—ç¬¦ä¸²å¸¸é‡å†…å®¹ä¸ºæ¨¡å—åˆ«å */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="4-2-å¼€å‘æ¿éªŒè¯-1"><a href="#4-2-å¼€å‘æ¿éªŒè¯-1" class="headerlink" title="4.2 å¼€å‘æ¿éªŒè¯"></a><font size=3>4.2 å¼€å‘æ¿éªŒè¯</font></h3><p>å…¶å®è¿™ä¸ªç°è±¡å’Œä¿¡å·é‡æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å°†ç¼–è¯‘å¾—åˆ°çš„sdriver_demo.koã€app_demo.outæ‹·è´åˆ°å¼€å‘æ¿ã€‚</p>
<ul>
<li>ï¼ˆ1ï¼‰åŠ è½½é©±åŠ¨</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insmod sdriver_demo.ko</span><br></pre></td></tr></table></figure>

<ul>
<li>ï¼ˆ2ï¼‰app_demo.out ä¼šåˆ›å»ºå­è¿›ç¨‹è¿è¡Œ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./app_demo.out /dev/sdevchr 2</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122151244602.png" alt="image-20250122151244602"  />

<p>å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªæ‰§è¡Œå®Œå†æ‰§è¡Œå¦ä¸€ä¸ªã€‚æ²¡æœ‰äº’æ–¥é”ä¿æŠ¤çš„æ—¶å€™æ˜¯è¿™æ ·çš„ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/LV06-06-%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89-02-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/img/image-20250122151319872.png" alt="image-20250122151319872"  />



<blockquote>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xhjcehust/article/details/26132167">è‡ªæ—‹é”åœ¨æŠ¢å (æˆ–éæŠ¢å )å•æ ¸å’Œå¤šæ ¸ä¸­çš„ä½œç”¨_å¤šæ ¸ç³»ç»Ÿä¸­,ä»»åŠ¡å¯ä»¥é€šè¿‡è‡ªæ—‹é”æˆ–è€…ä¸­æ–­çš„æ–¹å¼ç‹¬å cpu-CSDNåšå®¢</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">




    <div>
        
            <div style="text-align:center;color: #ccc;font-size:14px;">
            ----------æœ¬æ–‡ç»“æŸ
            <i class="fas fa-fan fa-spin" style="color: #FF1493; font-size: 1rem"></i>
            æ„Ÿè°¢æ‚¨çš„é˜…è¯»----------
            </div>
        
    </div>





  
  <div class="my_post_copyright"> 
    <p><span>æ–‡ç« æ ‡é¢˜:</span><a href="/post/4af1eda3.html">LV06-06-å¹¶å‘ä¸ç«äº‰-02-å¹¶å‘æ§åˆ¶</a></p>
    <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="æ¬¢è¿è®¿é—® ã€Šè‹æœ¨ã€‹ çš„å­¦ä¹ ç¬”è®°">è‹æœ¨</a></p>
    <p><span>å‘å¸ƒæ—¶é—´:</span>2025å¹´01æœˆ24æ—¥ - 23:59</p>
    <p><span>æœ€åæ›´æ–°:</span>2025å¹´06æœˆ14æ—¥ - 00:25</p>
    <p><span>åŸå§‹é“¾æ¥:</span><a href="/post/4af1eda3.html" title="LV06-06-å¹¶å‘ä¸ç«äº‰-02-å¹¶å‘æ§åˆ¶">https://sumumm.github.io/post/4af1eda3.html</a></p>
    <p><span>è®¸å¯åè®®:</span><i class="fab fa-creative-commons"></i> <a rel="license" href= "https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>  
  </div>
  


          <div class="post-tags">
              <a href="/tags/LV06-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/" rel="tag"><i class="fa fa-tag"></i> LV06-é©±åŠ¨å¼€å‘</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/4a15a66.html" rel="prev" title="LV06-07-IOæ¨¡å‹-01-IOæ¨¡å‹ç®€ä»‹">
                  <i class="fa fa-angle-left"></i> LV06-07-IOæ¨¡å‹-01-IOæ¨¡å‹ç®€ä»‹
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/9eb12c76.html" rel="next" title="LV06-06-å¹¶å‘ä¸ç«äº‰-01-å¹¶å‘ä¸ç«äº‰ç®€ä»‹">
                  LV06-06-å¹¶å‘ä¸ç«äº‰-01-å¹¶å‘ä¸ç«äº‰ç®€ä»‹ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">è‹æœ¨</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">3.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">225:26</span>
  </span>
</div>




    <span id="sitetime"></span>
    <script defer language=javascript>
        function siteTime()
        {
            window.setTimeout("siteTime()", 1000);
            var seconds = 1000;
            var minutes = seconds * 60;
            var hours = minutes * 60;
            var days = hours * 24;
            var years = days * 365;
            var today = new Date();
            var todayYear = today.getFullYear();
            var todayMonth = today.getMonth()+1;
            var todayDate = today.getDate();
            var todayHour = today.getHours();
            var todayMinute = today.getMinutes();
            var todaySecond = today.getSeconds();
            /*==================================================
            Date.UTC() -- è¿”å›dateå¯¹è±¡è·ä¸–ç•Œæ ‡å‡†æ—¶é—´(UTC)1970å¹´1æœˆ1æ—¥åˆå¤œä¹‹é—´çš„æ¯«ç§’æ•°(æ—¶é—´æˆ³)
            year        - ä½œä¸ºdateå¯¹è±¡çš„å¹´ä»½ï¼Œä¸º4ä½å¹´ä»½å€¼
            month       - 0-11ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æœˆä»½
            day         - 1-31ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å¤©æ•°
            hours       - 0(åˆå¤œ24ç‚¹)-23ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å°æ—¶æ•°
            minutes     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„åˆ†é’Ÿæ•°
            seconds     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„ç§’æ•°
            microseconds - 0-999ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æ¯«ç§’æ•°
            ==================================================*/
            var t1 = Date.UTC(2017, 
                              5, 
                              19, 
                              0, 
                              0, 
                              0); //åŒ—äº¬æ—¶é—´
            var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
            var diff = t2-t1;
            var diffYears = Math.floor(diff/years);
            var diffDays = Math.floor((diff/days)-diffYears*365);
            var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
            var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
            var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
            document.getElementById("sitetime").innerHTML="å·²åœ¨è¿™é‡Œ "+diffYears+" å¹´ "+diffDays+" å¤© "+diffHours+" å°æ—¶ "+diffMinutes+" åˆ†é’Ÿ "+diffSeconds+" ç§’";
        }
        siteTime();
    </script>



    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


 
        <div id="click-show-text"
            data-mobile = false
            data-text = å¯Œå¼º,æ°‘ä¸»,æ–‡æ˜,å’Œè°,è‡ªç”±,å¹³ç­‰,å…¬æ­£,æ³•åˆ¶,çˆ±å›½,æ•¬ä¸š,è¯šä¿¡,å‹å–„
            data-fontsize = 15px
            data-random= false>
        </div>
       

      
        <script async src=https://cdn.jsdelivr.net/npm/hexo-next-mouse-effect@latest/click/showText.js></script>
      

      
    




    <script async src="/js/fancybox_param.js"></script>





<!-- APlayeræœ¬ä½“ -->



</body>
</html>
