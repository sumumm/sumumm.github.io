<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/green/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"sumumm.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":300},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="æœ¬æ–‡ä¸»è¦æ˜¯ubootå¯åŠ¨æµç¨‹çš„ç›¸å…³ç¬”è®°ã€‚è‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="LV05-01-uboot-04-ubootå¯åŠ¨æµç¨‹">
<meta property="og:url" content="https://sumumm.github.io/post/e99b9cbc.html">
<meta property="og:site_name" content="è‹æœ¨">
<meta property="og:description" content="æœ¬æ–‡ä¸»è¦æ˜¯ubootå¯åŠ¨æµç¨‹çš„ç›¸å…³ç¬”è®°ã€‚è‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015091825040.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015092906081.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015130030906.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015130125594.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015143824906.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015165952642.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015170028569.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015170057791.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015170124394.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015170554062.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015171129255.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015203536954.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015210430581.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016083509867.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016083629656.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016083741446.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016084737899.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016084922548.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016100037636.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016101203235.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016113057647.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/uboot_start-169061995797628.png">
<meta property="article:published_time" content="2023-09-08T11:22:56.000Z">
<meta property="article:modified_time" content="2025-06-13T16:25:57.041Z">
<meta property="article:author" content="è‹æœ¨">
<meta property="article:tag" content="(ALPHA)LV05-ubootä¸å†…æ ¸">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015091825040.png">


<link rel="canonical" href="https://sumumm.github.io/post/e99b9cbc.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sumumm.github.io/post/e99b9cbc.html","path":"post/e99b9cbc.html","title":"LV05-01-uboot-04-ubootå¯åŠ¨æµç¨‹"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LV05-01-uboot-04-ubootå¯åŠ¨æµç¨‹ | è‹æœ¨</title>
  








    <script src="/js/browser_tools_disable.js"></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.com/hexo-next-tags-plus@latest/lib/tag_plus.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">è‹æœ¨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">æˆ‘çš„å­¦ä¹ ä¹‹è·¯</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>è‹æœ¨çš„å®¶</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»é¡µ<span class="badge">42</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£é¡µ<span class="badge">673</span></a></li><li class="menu-item menu-item-flink"><a href="/flink/" rel="section"><i class="fa fa-link fa-fw"></i>å‹äººå¸</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äºæˆ‘</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E9%93%BE%E6%8E%A5%E8%84%9A%E6%9C%ACu-boot-lds"><span class="nav-text">ä¸€ã€é“¾æ¥è„šæœ¬u-boot.lds  </span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3"><span class="nav-text">1. ç¨‹åºå…¥å£</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-uboot%E8%B5%B7%E5%A7%8B%E5%9C%B0%E5%9D%80"><span class="nav-text">2. ubootèµ·å§‹åœ°å€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%B8%8E%E5%9C%B0%E5%9D%80%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-text">3. ä¸åœ°å€ç›¸å…³çš„å˜é‡</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-text">äºŒã€ubootå¯åŠ¨æµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-reset-%E5%87%BD%E6%95%B0"><span class="nav-text">1. reset å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-reset-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="nav-text">1.1 reset å‡½æ•°åœ¨å“ªï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%9C%80%E7%BB%88%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">1.2 æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-1-%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E7%8A%B6%E6%80%81"><span class="nav-text">1.2.1 è®¾ç½®å·¥ä½œçŠ¶æ€</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-2-%E8%AE%BE%E7%BD%AE%E5%90%91%E9%87%8F%E8%A1%A8"><span class="nav-text">1.2.2 è®¾ç½®å‘é‡è¡¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-3-%E6%9C%80%E7%BB%88%E8%B7%B3%E8%BD%AC%E5%88%B0-main"><span class="nav-text">1.2.3 æœ€ç»ˆè·³è½¬åˆ° main</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-lowlevel-init-%E5%87%BD%E6%95%B0"><span class="nav-text">2.Â lowlevel_init å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-lowlevel-init-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="nav-text">2.1Â lowlevel_init å‡½æ•°åœ¨å“ªï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E6%9C%80%E7%BB%88%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">2.2 æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E8%AE%BE%E7%BD%AE%E5%A0%86%E6%A0%88%E6%8C%87%E9%92%88-sp"><span class="nav-text">2.1 è®¾ç½®å †æ ˆæŒ‡é’ˆ sp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-sp%E6%8C%87%E9%92%888%E5%AD%97%E8%8A%82%E5%AF%B9%E9%BD%90"><span class="nav-text">2.2 spæŒ‡é’ˆ8å­—èŠ‚å¯¹é½</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-sp%E6%8C%87%E9%92%88%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><span class="nav-text">2.3 spæŒ‡é’ˆå…¶ä»–æ“ä½œ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-s-init-%E5%87%BD%E6%95%B0"><span class="nav-text">3.Â s_init å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-s-init-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="nav-text">3.1Â s_init å‡½æ•°åœ¨å“ªï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E6%9C%80%E7%BB%88%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">3.2 æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-main-%E5%87%BD%E6%95%B0"><span class="nav-text">4. _main å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-main-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="nav-text">4.1 _main å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">4.2 åšäº†ä»€ä¹ˆï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-%E8%AE%BE%E7%BD%AE%E5%88%9D%E5%A7%8BC%E8%BF%90%E8%A1%8C%E6%97%B6%E7%8E%AF%E5%A2%83"><span class="nav-text">4.2.1 è®¾ç½®åˆå§‹Cè¿è¡Œæ—¶ç¯å¢ƒ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-%E8%AE%BE%E7%BD%AE%E4%B8%AD%E9%97%B4%E7%8E%AF%E5%A2%83"><span class="nav-text">4.2.2 è®¾ç½®ä¸­é—´ç¯å¢ƒ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-3-%E8%AE%BE%E7%BD%AE%E6%9C%80%E7%BB%88%E7%8E%AF%E5%A2%83"><span class="nav-text">4.2.3 è®¾ç½®æœ€ç»ˆç¯å¢ƒ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-board-init-f-%E5%87%BD%E6%95%B0"><span class="nav-text">5.Â board_init_f å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-board-init-f-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="nav-text">5.1Â board_init_f å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">5.2 åšäº†ä»€ä¹ˆï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-init-sequence-f"><span class="nav-text">5.3Â init_sequence_f</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-1-%E6%95%B0%E7%BB%84%E6%88%90%E5%91%98"><span class="nav-text">5.3.1 æ•°ç»„æˆå‘˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-2-%E9%87%8D%E8%A6%81%E5%87%BD%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="nav-text">5.3.2 é‡è¦å‡½æ•°è¯´æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-3-%E6%9C%80%E7%BB%88%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="nav-text">5.3.3 æœ€ç»ˆå†…å­˜åˆ†é…</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-relocate-code-%E5%87%BD%E6%95%B0"><span class="nav-text">6.Â relocate_code å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-relocate-code-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="nav-text">6.1Â relocate_code å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">6.2 åšäº†ä»€ä¹ˆï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-relocate-vectors%E5%87%BD%E6%95%B0"><span class="nav-text">7.Â relocate_vectorså‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-relocate-vectors-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="nav-text">7.1Â relocate_vectors å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">7.2 åšäº†ä»€ä¹ˆï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-board-init-r-%E5%87%BD%E6%95%B0"><span class="nav-text">8.Â board_init_r    å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-board-init-r-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="nav-text">8.1Â board_init_r å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">8.2 åšäº†ä»€ä¹ˆï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-init-sequence-r"><span class="nav-text">8.3Â init_sequence_rÂ </span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-1-%E6%95%B0%E7%BB%84%E6%88%90%E5%91%98"><span class="nav-text">8.3.1 æ•°ç»„æˆå‘˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-2-%E9%87%8D%E8%A6%81%E5%87%BD%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="nav-text">8.3.2 é‡è¦å‡½æ•°è¯´æ˜</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-run-main-loop-%E5%87%BD%E6%95%B0"><span class="nav-text">9.Â run_main_loop å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-run-main-loop-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="nav-text">9.1Â run_main_loop å‡½æ•°åœ¨å“ªï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">9.2 åšäº†ä»€ä¹ˆï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-1-run-main-loop%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89"><span class="nav-text">9.2.1Â run_main_loopå‡½æ•°å®šä¹‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-2-main-loop-%E5%87%BD%E6%95%B0"><span class="nav-text">9.2.2Â main_loop å‡½æ•°</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-cli-loop-%E5%87%BD%E6%95%B0"><span class="nav-text">10.Â cli_loop å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-cli-loop-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="nav-text">10.1Â cli_loop å‡½æ•°åœ¨å“ªï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">10.2 åšäº†ä»€ä¹ˆï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-2-1-cli-loop"><span class="nav-text">10.2.1Â cli_loop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-2-2-parse-file-outer-%E5%87%BD%E6%95%B0"><span class="nav-text">10.2.2Â parse_file_outer å‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-2-3-parse-stream-outer%E5%87%BD%E6%95%B0"><span class="nav-text">10.2.3Â parse_stream_outerå‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-2-4-run-list-%E5%87%BD%E6%95%B0"><span class="nav-text">10.2.4Â run_list å‡½æ•°</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-cmd-process-%E5%87%BD%E6%95%B0"><span class="nav-text">11.Â cmd_process å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9A%E4%B9%89%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="nav-text">11.1 å‘½ä»¤çš„å®šä¹‰ä¸æ‰§è¡Œ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1-1-%E7%9B%B8%E5%85%B3%E5%AE%8F%E5%AE%9A%E4%B9%89"><span class="nav-text">11.1.1 ç›¸å…³å®å®šä¹‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1-2-%E5%91%BD%E4%BB%A4%E5%AE%9E%E4%BE%8B"><span class="nav-text">11.1.2 å‘½ä»¤å®ä¾‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-2-3-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-text">11.2.3 å‘½ä»¤æ‰§è¡Œ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-cmd-process-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="nav-text">11.2Â cmd_process å‡½æ•°åœ¨å“ªï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">11.3 åšäº†ä»€ä¹ˆï¼Ÿ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81uboot%E5%90%AF%E5%8A%A8%E6%80%BB%E7%BB%93"><span class="nav-text">ä¸‰ã€ubootå¯åŠ¨æ€»ç»“</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="è‹æœ¨"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">è‹æœ¨</p>
  <div class="site-description" itemprop="description">è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">673</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/sumumm" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;sumumm" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sumumm.github.io/post/e99b9cbc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="è‹æœ¨">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹æœ¨">
      <meta itemprop="description" content="è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="LV05-01-uboot-04-ubootå¯åŠ¨æµç¨‹ | è‹æœ¨">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LV05-01-uboot-04-ubootå¯åŠ¨æµç¨‹
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-09-08 19:22:56" itemprop="dateCreated datePublished" datetime="2023-09-08T19:22:56+08:00">2023-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">åµŒå…¥å¼å¼€å‘</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">02IMX6ULLå¹³å°</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">LV05-ubootä¸å†…æ ¸</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>19k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1:08</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>æœ¬æ–‡ä¸»è¦æ˜¯ubootå¯åŠ¨æµç¨‹çš„ç›¸å…³ç¬”è®°ã€‚è‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚</p>
<span id="more"></span>

<!-- Photo: https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/ -->

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ä½¿ç”¨å·¥å…·åŠç‰ˆæœ¬ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center" width=150px>Windowsç‰ˆæœ¬</td>        <td align="left">windows11</td>    </tr>    <tr>        <td align="center">Ubuntuç‰ˆæœ¬</td>        <td align="left">Ubuntu16.04çš„64ä½ç‰ˆæœ¬</td>      </tr>    <tr>        <td align="center">VMwareÂ® Workstation 16 Pro</td>        <td align="left">16.2.3 build-19376536</td>      </tr>    <tr>        <td align="center">ç»ˆç«¯è½¯ä»¶</td>        <td align="left">MobaXterm(Professional Edition v23.0 Build 5042 (license))</td>      </tr>    <tr>        <td align="center">Linuxå¼€å‘æ¿</td>        <td align="left">æ­£ç‚¹åŸå­ i.MX6ULL Linux é˜¿å°”æ³•å¼€å‘æ¿</td>      </tr>    <tr>        <td align="center">uboot</td>        <td align="left">NXPå®˜æ–¹æä¾›çš„ubootï¼ŒNXPæä¾›çš„ç‰ˆæœ¬ä¸ºuboot-imx-rel_imx_4.1.15_2.1.0_ga(ä½¿ç”¨çš„ubootç‰ˆæœ¬ä¸ºU-Boot 2016.03)</td>      </tr>    <tr>        <td align="center">linuxå†…æ ¸</td>        <td align="left">linux-4.15(NXPå®˜æ–¹æä¾›)</td>      </tr>    <tr>        <td align="center">Win32DiskImager</td>        <td align="left">Win32DiskImager v1.0</td>      </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹æœ¬æ–‡å‚è€ƒèµ„æ–™ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center">åˆ†ç±»</td>        <td align="center">ç½‘å€</td>        <td align="center">è¯´æ˜</td>    </tr>    <tr>        <td align="center" rowspan="5">å®˜æ–¹ç½‘ç«™</td>        <td align="left"><a href="https://www.arm.com/" target="_blank">https://www.arm.com/</a></td>        <td align="left">ARMå®˜æ–¹ç½‘ç«™ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°Cotex-Mxä»¥åŠARMVxçš„ä¸€äº›æ–‡æ¡£</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxp.com.cn/" target="_blank">https://www.nxp.com.cn/ </a></td>        <td align="left">NXPå®˜æ–¹ç½‘ç«™</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxpic.org.cn/" target="_blank">https://www.nxpic.org.cn/</a></td><td align="left">NXP å®˜æ–¹ç¤¾åŒº</td>    </tr>    <tr>        <td align="left"><a href="https://u-boot.readthedocs.io/en/latest/" target="_blank">https://u-boot.readthedocs.io/en/latest/</a></td><td align="left">u-bootå®˜ç½‘</td>    </tr>    <tr>        <td align="left"><a href="https://www.kernel.org/" target="_blank">https://www.kernel.org/</a></td><td align="left">linuxå†…æ ¸å®˜ç½‘</td>    </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ç›¸å…³æ–‡ä»¶ä¸‹è½½ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center">åˆ†ç±»</td>        <td align="center">ç½‘å€</td>        <td align="center">è¯´æ˜</td>    </tr>    <tr>        <td align="center" rowspan="4">NXP</td>        <td align="left"><a href="https://github.com/nxp-imx" target="_blank">https://github.com/nxp-imx</a></td>        <td align="left">NXP imxå¼€å‘èµ„æºGitHubç»„ç»‡ï¼Œé‡Œè¾¹ä¼šæœ‰u-bootå’Œlinuxå†…æ ¸çš„ä»“åº“</td>    </tr>    <tr>        <td align="left"><a href="https://elixir.bootlin.com/linux/latest/source" target="_blank">https://elixir.bootlin.com/linux/latest/source</a></td>        <td align="left">åœ¨çº¿é˜…è¯»linux kernelæºç </td>    </tr>    <tr>        <td align="left"><a href="https://github.com/nxp-imx/linux-imx/releases/tag/rel_imx_4.1.15_2.1.0_ga" target="_blank">nxp-imx/linux-imx/releases/tag/rel_imx_4.1.15_2.1.0_ga</a></td>        <td align="left">NXP linuxå†…æ ¸ä»“åº“tagsä¸­çš„rel_imx_4.1.15_2.1.0_ga</td>    </tr>    <tr>        <td align="left"><a href="https://github.com/nxp-imx/uboot-imx/releases/tag/rel_imx_4.1.15_2.1.0_ga" target="_blank">nxp-imx/uboot-imx/releases/tag/rel_imx_4.1.15_2.1.0_ga</a></td>        <td align="left">NXP u-bootä»“åº“tagsä¸­çš„rel_imx_4.1.15_2.1.0_ga</td>    </tr>    <tr>        <td align="center" rowspan="2">I.MX6ULL</td>        <td align="left"><a href="https://www.nxp.com.cn/docs/en/data-sheet/IMX6ULLIEC.pdf" target="_blank">i.MX 6ULL Applications Processors for Industrial Products</a></td>        <td align="left">I.MX6ULL èŠ¯ç‰‡æ‰‹å†Œï¼ˆdatasheetï¼Œå¯ä»¥åœ¨çº¿æŸ¥çœ‹ï¼‰</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh" target="_blank">i.MX 6ULL Applications ProcessorReference Manual</a></td>        <td align="left">I.MX6ULL å‚è€ƒæ‰‹å†Œï¼ˆä¸‹è½½åæ‰èƒ½æŸ¥çœ‹ï¼Œéœ€è¦ç™»å½•NXPå®˜ç½‘ï¼‰</td>    </tr></table>
              </div>
            </details>

<h1 id="ä¸€ã€é“¾æ¥è„šæœ¬u-boot-lds"><a href="#ä¸€ã€é“¾æ¥è„šæœ¬u-boot-lds" class="headerlink" title="ä¸€ã€é“¾æ¥è„šæœ¬u-boot.lds  "></a><font size=3>ä¸€ã€é“¾æ¥è„šæœ¬u-boot.lds  </font></h1><h2 id="1-ç¨‹åºå…¥å£"><a href="#1-ç¨‹åºå…¥å£" class="headerlink" title="1. ç¨‹åºå…¥å£"></a><font size=3>1. ç¨‹åºå…¥å£</font></h2><p>æˆ‘ä»¬è¦åˆ†æubootçš„å¯åŠ¨æµç¨‹ï¼Œå°±è¦æ‰¾åˆ°æ•´ä¸ªç¨‹åºçš„â€œå…¥å£â€ï¼Œæ‰¾åˆ°ç¬¬ä¸€è¡Œç¨‹åºåœ¨å“ªé‡Œã€‚ç¨‹åºçš„é“¾æ¥æ˜¯ç”±é“¾æ¥è„šæœ¬æ¥å†³å®šçš„ï¼Œæ‰€ä»¥é€šè¿‡é“¾æ¥è„šæœ¬å¯ä»¥æ‰¾åˆ°ç¨‹åºçš„å…¥å£ã€‚å¦‚æœæ²¡æœ‰ç¼–è¯‘è¿‡ uboot çš„è¯ï¼Œé“¾æ¥è„šæœ¬ä¸ºubootæºç ç›®å½•ä¸­çš„è¿™ä¸ªæ–‡ä»¶ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/cpu/u-boot.lds</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™ä¸ªä¸æ˜¯æœ€ç»ˆä½¿ç”¨çš„é“¾æ¥è„šæœ¬ï¼Œæœ€ç»ˆçš„é“¾æ¥è„šæœ¬æ˜¯åœ¨è¿™ä¸ªé“¾æ¥è„šæœ¬çš„åŸºç¡€ä¸Šç”Ÿæˆçš„ã€‚ç¼–è¯‘ä¸€ä¸‹ ubootï¼Œç¼–è¯‘å®Œæˆä»¥åå°±ä¼šåœ¨ uboot æ ¹ç›®å½•ä¸‹ç”Ÿæˆ u-boot.ldsæ–‡ä»¶ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015091825040.png" alt="image-20221015091825040" style="zoom:50%;" />

<p><strong>ã€æ³¨æ„ã€‘</strong>åªæœ‰ç¼–è¯‘ u-boot ä»¥åæ‰ä¼šåœ¨æ ¹ç›®å½•ä¸‹å‡ºç° u-boot.lds æ–‡ä»¶ ã€‚</p>
<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_FORMAT(<span class="string">&quot;elf32-littlearm&quot;</span>, <span class="string">&quot;elf32-littlearm&quot;</span>, <span class="string">&quot;elf32-littlearm&quot;</span>)</span><br><span class="line">OUTPUT_ARCH(arm)</span><br><span class="line">ENTRY(_start)</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line"> . = <span class="number">0x00000000</span>;</span><br><span class="line"> . = ALIGN(<span class="number">4</span>);</span><br><span class="line"> .text :</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__image_copy_start)</span><br><span class="line">  *(.vectors)</span><br><span class="line">  arch/arm/cpu/armv7/start.o (.text*)</span><br><span class="line">  *(.text*)</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// åè¾¹çš„çœç•¥ ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ç¬¬ 3 è¡Œä¸ºä»£ç å½“å‰å…¥å£ç‚¹ï¼š _startï¼Œå…³äº _start åœ¨ubootæºç ä¸­çš„è¿™ä¸ªæ–‡ä»¶ä¸­æœ‰å®šä¹‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/lib/vectors.S</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€ç€è¿™ä¸ªæ–‡ä»¶ï¼Œæœ‰å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">/* ä¸­é—´æ³¨é‡Šçœç•¥ ... ... */</span><br><span class="line"></span><br><span class="line">	.section &quot;.vectors&quot;, &quot;ax&quot;</span><br><span class="line"></span><br><span class="line">/* ä¸­é—´æ³¨é‡Šçœç•¥ ... ... */</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_SYS_DV_NOR_BOOT_CFG</span><br><span class="line">	.word	CONFIG_SYS_DV_NOR_BOOT_CFG</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	b	reset</span><br><span class="line">	ldr	pc, _undefined_instruction</span><br><span class="line">	ldr	pc, _software_interrupt</span><br><span class="line">	ldr	pc, _prefetch_abort</span><br><span class="line">	ldr	pc, _data_abort</span><br><span class="line">	ldr	pc, _not_used</span><br><span class="line">	ldr	pc, _irq</span><br><span class="line">	ldr	pc, _fiq</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œ _start åé¢å°±æ˜¯ä¸­æ–­å‘é‡è¡¨ï¼Œä»å›¾ä¸­çš„â€œ .section â€œ .vectors â€œï¼Œâ€ ax â€ å¯ä»¥å¾—åˆ°ï¼Œæ­¤<strong>ä»£ç å­˜æ”¾åœ¨ .vectors æ®µé‡Œé¢</strong>ã€‚</p>
<h2 id="2-ubootèµ·å§‹åœ°å€"><a href="#2-ubootèµ·å§‹åœ°å€" class="headerlink" title="2. ubootèµ·å§‹åœ°å€"></a><font size=3>2. ubootèµ·å§‹åœ°å€</font></h2><p>æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨ uboot æºç ä¸­æŸ¥æ‰¾ __image_copy_start ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -nR &quot;__image_copy_start&quot;</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015092906081.png" alt="image-20221015092906081" style="zoom:50%;" />

<p>æˆ‘ä»¬æ‰“å¼€ u-boot.map  æ–‡ä»¶ï¼Œæœç´¢ __image_copy_start å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸Šè¾¹éƒ¨åˆ†çœç•¥ ... ...</span></span><br><span class="line">é“¾ç»“å™¨å‘½ä»¤ç¨¿å’Œå†…å­˜æ˜ å°„</span><br><span class="line"></span><br><span class="line">æ®µ .text çš„åœ°å€è®¾ç½®ä¸º <span class="number">0x87800000</span></span><br><span class="line">                <span class="number">0x0000000000000000</span>                . = <span class="number">0x0</span></span><br><span class="line">                <span class="number">0x0000000000000000</span>                . = ALIGN (<span class="number">0x4</span>)</span><br><span class="line"></span><br><span class="line">.text           <span class="number">0x0000000087800000</span>    <span class="number">0x3e734</span></span><br><span class="line"> *(.__image_copy_start)</span><br><span class="line"> .__image_copy_start</span><br><span class="line">                <span class="number">0x0000000087800000</span>        <span class="number">0x0</span> arch/arm/lib/built-in.o</span><br><span class="line">                <span class="number">0x0000000087800000</span>                __image_copy_start</span><br><span class="line"> *(.vectors)</span><br><span class="line"> .vectors       <span class="number">0x0000000087800000</span>      <span class="number">0x300</span> arch/arm/lib/built-in.o</span><br><span class="line">                <span class="number">0x0000000087800000</span>                _start</span><br><span class="line">                <span class="number">0x0000000087800020</span>                _undefined_instruction</span><br><span class="line">                <span class="number">0x0000000087800024</span>                _software_interrupt</span><br><span class="line">                <span class="number">0x0000000087800028</span>                _prefetch_abort</span><br><span class="line">                <span class="number">0x000000008780002c</span>                _data_abort</span><br><span class="line">                <span class="number">0x0000000087800030</span>                _not_used</span><br><span class="line">                <span class="number">0x0000000087800034</span>                _irq</span><br><span class="line">                <span class="number">0x0000000087800038</span>                _fiq</span><br><span class="line">                <span class="number">0x0000000087800040</span>                IRQ_STACK_START_IN</span><br><span class="line"><span class="comment">// ä¸‹è¾¹éƒ¨åˆ†çœç•¥ ... ...</span></span><br></pre></td></tr></table></figure>

<p>u-boot.map æ˜¯ uboot çš„æ˜ å°„æ–‡ä»¶ï¼Œç¼–è¯‘ uboot åå­˜åœ¨äºæºç é¡¶å±‚ç›®å½•ä¸­ï¼Œå¯ä»¥ä»æ­¤æ–‡ä»¶çœ‹åˆ°æŸä¸ªæ–‡ä»¶æˆ–è€…å‡½æ•°é“¾æ¥åˆ°äº†å“ªä¸ªåœ°å€ã€‚å¯ä»¥çœ‹åˆ° __image_copy_start ä¸º 0X87800000ï¼Œè€Œ .text çš„èµ·å§‹åœ°å€ä¹Ÿæ˜¯ 0X87800000 ã€‚  </p>
<p>æˆ‘ä»¬å†æ‰“å¼€ubootæºç ç›®å½•ä¸­çš„é“¾æ¥æ–‡ä»¶ u-boot.lds ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹è¯­å¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_FORMAT(<span class="string">&quot;elf32-littlearm&quot;</span>, <span class="string">&quot;elf32-littlearm&quot;</span>, <span class="string">&quot;elf32-littlearm&quot;</span>)</span><br><span class="line">OUTPUT_ARCH(arm)</span><br><span class="line">ENTRY(_start)</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line"> . = <span class="number">0x00000000</span>;</span><br><span class="line"> . = ALIGN(<span class="number">4</span>);</span><br><span class="line"> .text :</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__image_copy_start)</span><br><span class="line">  *(.vectors)</span><br><span class="line">  arch/arm/cpu/armv7/start.o (.text*)</span><br><span class="line">  *(.text*)</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// åè¾¹çš„çœç•¥ ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç¬¬ 11 è¡Œæ˜¯ vectors æ®µï¼Œ vectors æ®µä¿å­˜ä¸­æ–­å‘é‡è¡¨ ï¼Œæˆ‘ä»¬ä» arch&#x2F;arm&#x2F;lib&#x2F;vectors.S æ–‡ä»¶ä¸­çŸ¥é“ vectors.S çš„ä»£ç æ˜¯å­˜åœ¨ vectors æ®µä¸­çš„ã€‚  vectors æ®µçš„èµ·å§‹åœ°å€ä¹Ÿæ˜¯ 0X87800000ï¼Œè¯´æ˜<strong>æ•´ä¸ª uboot çš„èµ·å§‹åœ°å€å°±æ˜¯ 0X87800000</strong>ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è£¸æœºå¯æ‰§è¡Œç¨‹åºçš„é“¾æ¥èµ·å§‹åœ°å€é€‰æ‹© 0X87800000 äº†ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†å’Œ uboot ä¸€è‡´ã€‚  </p>
<p>u-boot.lds çš„ç¬¬12è¡Œæ˜¯å°† arch&#x2F;arm&#x2F;cpu&#x2F;armv7&#x2F;start.s ç¼–è¯‘å‡ºæ¥çš„ä»£ç æ”¾åˆ°ä¸­æ–­å‘é‡è¡¨åé¢ã€‚  </p>
<p>u-boot.lds çš„ç¬¬13è¡Œæ˜¯ text æ®µï¼Œå…¶ä»–çš„ä»£ç æ®µå°±æ”¾åˆ°è¿™é‡Œ ã€‚</p>
<h2 id="3-ä¸åœ°å€ç›¸å…³çš„å˜é‡"><a href="#3-ä¸åœ°å€ç›¸å…³çš„å˜é‡" class="headerlink" title="3. ä¸åœ°å€ç›¸å…³çš„å˜é‡"></a><font size=3>3. ä¸åœ°å€ç›¸å…³çš„å˜é‡</font></h2><p> åœ¨ u-boot.lds ä¸­æœ‰ä¸€äº›è·Ÿåœ°å€æœ‰å…³çš„â€œå˜é‡â€éœ€è¦æˆ‘ä»¬æ³¨æ„ä¸€ä¸‹ï¼Œè¿™äº›å˜é‡è¦æœ€ç»ˆç¼–è¯‘å®Œæˆæ‰èƒ½ç¡®å®šçš„ï¼š</p>
<table>
<thead>
<tr>
<th>å˜é‡</th>
<th>æ•°å€¼</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>__image_copy_start</td>
<td>0x87800000</td>
<td>uboot æ‹·è´çš„é¦–åœ°å€</td>
</tr>
<tr>
<td>__image_copy_end</td>
<td>0x8785dd54</td>
<td>uboot æ‹·è´çš„ç»“æŸåœ°å€</td>
</tr>
<tr>
<td>__rel_dyn_start</td>
<td>0x8785dd54</td>
<td>.rel.dyn æ®µèµ·å§‹åœ°å€</td>
</tr>
<tr>
<td>__rel_dyn_end</td>
<td>0x878668f4</td>
<td>.rel.dyn æ®µç»“æŸåœ°å€</td>
</tr>
<tr>
<td>_image_binary_end</td>
<td>0x878668f4</td>
<td>é•œåƒç»“æŸåœ°å€</td>
</tr>
<tr>
<td>__bss_start</td>
<td>0x8785dd54</td>
<td>.bss æ®µèµ·å§‹åœ°å€</td>
</tr>
<tr>
<td>__bss_end</td>
<td>0x878a8e74</td>
<td>.bss æ®µç»“æŸåœ°å€</td>
</tr>
</tbody></table>
<p align="center">è¡¨ä¸€-3-1</p>

<p>è¿™äº›â€œå˜é‡â€å€¼å¯ä»¥åœ¨ u-boot.map æ–‡ä»¶ä¸­æŸ¥æ‰¾ï¼Œä¸Šè¡¨ä¸­é™¤äº†__image_copy_startä»¥å¤–ï¼Œå…¶ä»–çš„å˜é‡å€¼æ¯æ¬¡ç¼–è¯‘çš„æ—¶å€™å¯èƒ½ä¼šå˜åŒ–ï¼Œå¦‚æœä¿®æ”¹äº† uboot ä»£ç ã€ä¿®æ”¹äº† uboot é…ç½®ã€é€‰ç”¨ä¸åŒçš„ä¼˜åŒ–ç­‰çº§ç­‰ç­‰éƒ½ä¼šå½±å“åˆ°è¿™äº›å€¼ã€‚æ‰€ä»¥ï¼Œä¸€åˆ‡ä»¥å®é™…å€¼ä¸ºå‡†ã€‚</p>
<h1 id="äºŒã€ubootå¯åŠ¨æµç¨‹"><a href="#äºŒã€ubootå¯åŠ¨æµç¨‹" class="headerlink" title="äºŒã€ubootå¯åŠ¨æµç¨‹"></a><font size=3>äºŒã€ubootå¯åŠ¨æµç¨‹</font></h1><h2 id="1-reset-å‡½æ•°"><a href="#1-reset-å‡½æ•°" class="headerlink" title="1. reset å‡½æ•°"></a><font size=3>1. reset å‡½æ•°</font></h2><h3 id="1-1-reset-å‡½æ•°åœ¨å“ªï¼Ÿ"><a href="#1-1-reset-å‡½æ•°åœ¨å“ªï¼Ÿ" class="headerlink" title="1.1 reset å‡½æ•°åœ¨å“ªï¼Ÿ"></a><font size=3>1.1 reset å‡½æ•°åœ¨å“ªï¼Ÿ</font></h3><p>ä» u-boot.lds ä¸­æˆ‘ä»¬å·²ç»çŸ¥é“äº†å…¥å£ç‚¹æ˜¯ arch&#x2F;arm&#x2F;lib&#x2F;vectors.S æ–‡ä»¶ä¸­çš„_startï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">/* ä¸­é—´æ³¨é‡Šçœç•¥ ... ... */</span><br><span class="line"></span><br><span class="line">	.section &quot;.vectors&quot;, &quot;ax&quot;</span><br><span class="line"></span><br><span class="line">/* ä¸­é—´æ³¨é‡Šçœç•¥ ... ... */</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_SYS_DV_NOR_BOOT_CFG</span><br><span class="line">	.word	CONFIG_SYS_DV_NOR_BOOT_CFG</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	b	reset</span><br><span class="line">	ldr	pc, _undefined_instruction</span><br><span class="line">	ldr	pc, _software_interrupt</span><br><span class="line">	ldr	pc, _prefetch_abort</span><br><span class="line">	ldr	pc, _data_abort</span><br><span class="line">	ldr	pc, _not_used</span><br><span class="line">	ldr	pc, _irq</span><br><span class="line">	ldr	pc, _fiq</span><br></pre></td></tr></table></figure>

<p>_startåè¾¹ä¸ºä¸­æ–­å‘é‡è¡¨ï¼Œç¨‹åºå¯åŠ¨åï¼Œä¼šé¦–å…ˆè·³è½¬åˆ° reset å‡½æ•°é‡Œè¾¹ï¼Œè€Œ reset å‡½æ•°åˆ™æ˜¯å®šä¹‰åœ¨ubootæºç çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/cpu/armv7/start.S</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰¾åˆ°resetï¼Œä¼šæœ‰å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reset:</span><br><span class="line">	/* Allow the board to save important registers */</span><br><span class="line">	b	save_boot_params</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° reset ä¸­åˆä» reset å‡½æ•°è·³è½¬åˆ°äº† save_boot_params å‡½æ•°ï¼Œè€Œ save_boot_params å‡½æ•°åŒæ ·å®šä¹‰åœ¨ start.S é‡Œé¢ ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/*************************************************************************</span><br><span class="line"> *</span><br><span class="line"> * void save_boot_params(u32 r0, u32 r1, u32 r2, u32 r3)</span><br><span class="line"> *	__attribute__((weak));</span><br><span class="line"> *</span><br><span class="line"> * Stack pointer is not yet initialized at this moment</span><br><span class="line"> * Don&#x27;t save anything to stack even if compiled with -O0</span><br><span class="line"> *</span><br><span class="line"> *************************************************************************/</span><br><span class="line">ENTRY(save_boot_params)</span><br><span class="line">	b	save_boot_params_ret		@ back to my caller</span><br><span class="line">ENDPROC(save_boot_params)</span><br><span class="line">	.weak	save_boot_params</span><br></pre></td></tr></table></figure>

<p>å‘ç° save_boot_params å‡½æ•°ä¹Ÿæ˜¯åªæœ‰ä¸€å¥è·³è½¬è¯­å¥ï¼Œè·³è½¬åˆ° save_boot_params_ret å‡½æ•°ï¼Œsave_boot_params_ret ä¹Ÿæ˜¯å®šä¹‰åœ¨ start.S æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">save_boot_params_ret:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * disable interrupts (FIQ and IRQ), also set the cpu to SVC32 mode,</span></span><br><span class="line"><span class="comment">	 * except if in HYP mode already</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mrs	r0, cpsr</span><br><span class="line">	and	r1, r0, #<span class="number">0x1f</span>		@ mask mode bits</span><br><span class="line">	teq	r1, #<span class="number">0x1a</span>		@ test <span class="keyword">for</span> HYP mode</span><br><span class="line">	bicne	r0, r0, #<span class="number">0x1f</span>		@ clear all mode bits</span><br><span class="line">	orrne	r0, r0, #<span class="number">0x13</span>		@ <span class="built_in">set</span> SVC mode</span><br><span class="line">	orr	r0, r0, #<span class="number">0xc0</span>		@ disable FIQ and IRQ</span><br><span class="line">	msr	cpsr,r0</span><br><span class="line"><span class="comment">/* åè¾¹çš„çœç•¥ ... ... */</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ"><a href="#1-2-æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.2 æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>1.2 æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ</font></h3><h4 id="1-2-1-è®¾ç½®å·¥ä½œçŠ¶æ€"><a href="#1-2-1-è®¾ç½®å·¥ä½œçŠ¶æ€" class="headerlink" title="1.2.1 è®¾ç½®å·¥ä½œçŠ¶æ€"></a><font size=3>1.2.1 è®¾ç½®å·¥ä½œçŠ¶æ€</font></h4><p>ä¸Šè¾¹æˆ‘ä»¬é€šè¿‡resetæ‰¾åˆ°äº† save_boot_params_ret å‡½æ•°ï¼Œresetå‡½æ•°ç»è¿‡å¤šæ¬¡è·³è½¬ï¼Œæœ€ç»ˆæ‰§è¡Œçš„æ˜¯ save_boot_params_ret å‡½æ•°ä¸­çš„å†…å®¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">save_boot_params_ret:</span><br><span class="line">	/*</span><br><span class="line">	 * disable interrupts (FIQ and IRQ), also set the cpu to SVC32 mode,</span><br><span class="line">	 * except if in HYP mode already</span><br><span class="line">	 */</span><br><span class="line">	mrs	r0, cpsr</span><br><span class="line">	and	r1, r0, #0x1f		@ mask mode bits</span><br><span class="line">	teq	r1, #0x1a		@ test for HYP mode</span><br><span class="line">	bicne	r0, r0, #0x1f		@ clear all mode bits</span><br><span class="line">	orrne	r0, r0, #0x13		@ set SVC mode</span><br><span class="line">	orr	r0, r0, #0xc0		@ disable FIQ and IRQ</span><br><span class="line">	msr	cpsr,r0</span><br><span class="line">/* åè¾¹çš„çœç•¥ ... ... */</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 6 è¡Œï¼šè¯»å–å¯„å­˜å™¨ cpsr ä¸­çš„å€¼ï¼Œå¹¶ä¿å­˜åˆ° r0 å¯„å­˜å™¨ä¸­ã€‚  </p>
<p>ç¬¬ 7 è¡Œï¼šå°†å¯„å­˜å™¨ r0 ä¸­çš„å€¼ä¸ 0X1F è¿›è¡Œä¸è¿ç®—ï¼Œç»“æœä¿å­˜åˆ° r1 å¯„å­˜å™¨ä¸­ï¼Œç›®çš„å°±æ˜¯æå– cpsr å¯„å­˜å™¨çš„ bit[4:0] è¿™ 5 ä½ï¼Œè¿™ 5 ä½è¡¨ç¤ºM4 M3 M2 M1 M0ï¼Œè€Œ M[4:0] è¿™äº”ä½ç”¨æ¥è®¾ç½®å¤„ç†å™¨çš„å·¥ä½œæ¨¡å¼ã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ Cotex-A7 å·¥ä½œæ¨¡å¼ </summary>
              <div class='content'>
              <table><thead><tr><th align="center">M[4:0]</th><th align="center">æ¨¡å¼</th></tr></thead><tbody><tr><td align="center">10000</td><td align="center">User(usr)</td></tr><tr><td align="center">10001</td><td align="center">FIQ(fiq)</td></tr><tr><td align="center">10010</td><td align="center">IRQ(irq)</td></tr><tr><td align="center">10011</td><td align="center">Supervisor(svc)</td></tr><tr><td align="center">10110</td><td align="center">Monitor(mon)</td></tr><tr><td align="center">10111</td><td align="center">Abort(abt)</td></tr><tr><td align="center">11010</td><td align="center">Hyp(hyp)</td></tr><tr><td align="center">11011</td><td align="center">Undefined(und)</td></tr><tr><td align="center">11111</td><td align="center">System(sys)</td></tr></tbody></table>
              </div>
            </details>  

<p>ç¬¬ 8 è¡Œï¼šåˆ¤æ–­ r1 å¯„å­˜å™¨çš„å€¼æ˜¯å¦ç­‰äº 0X1A(0b11010)ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­å½“å‰å¤„ç†å™¨æ¨¡å¼æ˜¯å¦å¤„äº Hyp æ¨¡å¼ã€‚<br>ç¬¬ 9 è¡Œï¼šå¦‚æœ r1 å’Œ 0X1A ä¸ç›¸ç­‰ï¼Œä¹Ÿå°±æ˜¯ CPU ä¸å¤„äº Hyp æ¨¡å¼çš„è¯å°±å°† r0 å¯„å­˜å™¨çš„ bit[4:0] è¿›è¡Œæ¸…é›¶ï¼Œå…¶å®å°±æ˜¯æ¸…é™¤æ¨¡å¼ä½<br>ç¬¬ 10 è¡Œï¼šå¦‚æœå¤„ç†å™¨ä¸å¤„äº Hyp æ¨¡å¼çš„è¯å°±å°† r0 çš„å¯„å­˜å™¨çš„å€¼ä¸ 0x13 è¿›è¡Œæˆ–è¿ç®—ï¼Œ0x13&#x3D;0b10011ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®å¤„ç†å™¨è¿›å…¥ SVC æ¨¡å¼ã€‚<br>ç¬¬ 11 è¡Œï¼Œ r0 å¯„å­˜å™¨çš„å€¼å†ä¸ 0xC0 è¿›è¡Œæˆ–è¿ç®—ï¼Œé‚£ä¹ˆ r0 å¯„å­˜å™¨æ­¤æ—¶çš„å€¼å°±æ˜¯ 0xD3ï¼Œ cpsr å¯„å­˜å™¨çš„ I ä½å’Œ F ä½åˆ†åˆ«æ§åˆ¶ IRQ å’Œ FIQ ä¸¤ä¸ªä¸­æ–­çš„å¼€å…³ï¼Œè®¾ç½®ä¸º 1 å°±å…³é—­äº† FIQ å’Œ IRQã€‚<br>ç¬¬ 12 è¡Œï¼Œå°† r0 å¯„å­˜å™¨å†™å›åˆ° cpsr å¯„å­˜å™¨ä¸­ã€‚å®Œæˆè®¾ç½® CPU å¤„äº SVC32 æ¨¡å¼ï¼Œå¹¶ä¸”å…³é—­ FIQ å’Œ IRQ è¿™ä¸¤ä¸ªä¸­æ–­ã€‚ </p>
<h4 id="1-2-2-è®¾ç½®å‘é‡è¡¨"><a href="#1-2-2-è®¾ç½®å‘é‡è¡¨" class="headerlink" title="1.2.2 è®¾ç½®å‘é‡è¡¨"></a><font size=3>1.2.2 è®¾ç½®å‘é‡è¡¨</font></h4><p>æ¥ä¸‹æ¥ï¼Œè¿˜æ˜¯ save_boot_params_ret å‡½æ•°ï¼Œä¼šç»§ç»­æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Setup vector:</span><br><span class="line"> * (OMAP4 spl TEXT_BASE is not 32 byte aligned.</span><br><span class="line"> * Continue to use ROM code vector only in OMAP4 spl)</span><br><span class="line"> */</span><br><span class="line">#if !(defined(CONFIG_OMAP44XX) &amp;&amp; defined(CONFIG_SPL_BUILD))</span><br><span class="line">	/* Set V=0 in CP15 SCTLR register - for VBAR to point to vector */</span><br><span class="line">	mrc	p15, 0, r0, c1, c0, 0	@ Read CP15 SCTLR Register</span><br><span class="line">	bic	r0, #CR_V		@ V = 0</span><br><span class="line">	mcr	p15, 0, r0, c1, c0, 0	@ Write CP15 SCTLR Register</span><br><span class="line"></span><br><span class="line">	/* Set vector address in CP15 VBAR register */</span><br><span class="line">	ldr	r0, =_start</span><br><span class="line">	mcr	p15, 0, r0, c12, c0, 0	@Set VBAR</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 6 è¡Œï¼šå¦‚æœæ²¡æœ‰å®šä¹‰ CONFIG_OMAP44XX å’Œ CONFIG_SPL_BUILD çš„è¯æ¡ä»¶æˆç«‹ï¼Œæ­¤å¤„æ¡ä»¶æˆç«‹ã€‚  </p>
<p>ç¬¬ 8 è¡Œï¼šè¯»å– CP15 ä¸­ c1 å¯„å­˜å™¨çš„å€¼åˆ° r0 å¯„å­˜å™¨ä¸­ï¼Œæ ¹æ®åå¤„ç†å™¨ç›¸å…³çŸ¥è¯†ï¼Œè¿™é‡Œæ˜¯è¯»å– SCTLR å¯„å­˜å™¨çš„å€¼ã€‚</p>
<p>ç¬¬ 9 è¡Œï¼šCR_V åœ¨ arch&#x2F;arm&#x2F;include&#x2F;asm&#x2F;system.h ä¸­æœ‰å¦‚ä¸‹æ‰€ç¤ºå®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CR_V	(1 &lt;&lt; 13)	<span class="comment">/* Vectors relocated to 0xffff0000	*/</span></span></span><br></pre></td></tr></table></figure>

<p>å› æ­¤è¿™ä¸€è¡Œçš„ç›®çš„å°±æ˜¯æ¸…é™¤ SCTLR å¯„å­˜å™¨ä¸­çš„ bit[13]ã€‚bit[13] ä¸º V ä½ï¼Œæ­¤ä½æ˜¯å‘é‡è¡¨æ§åˆ¶ä½ï¼Œå½“ä¸º 0 çš„æ—¶å€™å‘é‡è¡¨åŸºåœ°å€ä¸º  0X00000000 ï¼Œè½¯ä»¶å¯ä»¥é‡å®šä½å‘é‡è¡¨ã€‚ä¸º 1 çš„æ—¶å€™å‘é‡è¡¨åŸºåœ°å€ä¸º 0XFFFF0000ï¼Œè½¯ä»¶ä¸èƒ½é‡å®šä½å‘é‡è¡¨ã€‚è¿™é‡Œå°† V æ¸…é›¶ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†æ¥ä¸‹æ¥çš„å‘é‡è¡¨é‡å®šä½ã€‚</p>
<p>ç¬¬ 10 è¡Œï¼šå°† r0 å¯„å­˜å™¨çš„å€¼é‡æ–°å†™å…¥åˆ°å¯„å­˜å™¨ SCTLR ä¸­ã€‚  </p>
<p>ç¬¬ 13 è¡Œï¼šè®¾ç½® r0 å¯„å­˜å™¨çš„å€¼ä¸º _startï¼Œ _startå°±æ˜¯æ•´ä¸ª uboot çš„å…¥å£åœ°å€ï¼Œå…¶å€¼ä¸º0X87800000ï¼Œç›¸å½“äº uboot çš„èµ·å§‹åœ°å€ï¼Œå› æ­¤ 0x87800000 ä¹Ÿæ˜¯å‘é‡è¡¨çš„èµ·å§‹åœ°å€ã€‚</p>
<p>ç¬¬ 14 è¡Œï¼šå°† r0 å¯„å­˜å™¨çš„å€¼ï¼ˆå‘é‡è¡¨å€¼ï¼‰å†™å…¥åˆ° CP15 çš„ c12 å¯„å­˜å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ VBAR å¯„å­˜å™¨ã€‚å› æ­¤ç¬¬ 8~14 è¡Œå°±æ˜¯è®¾ç½®å‘é‡è¡¨é‡å®šä½çš„ã€‚  </p>
<h4 id="1-2-3-æœ€ç»ˆè·³è½¬åˆ°-main"><a href="#1-2-3-æœ€ç»ˆè·³è½¬åˆ°-main" class="headerlink" title="1.2.3 æœ€ç»ˆè·³è½¬åˆ° main"></a><font size=3>1.2.3 æœ€ç»ˆè·³è½¬åˆ° main</font></h4><p>æ¥ä¸‹æ¥å°±æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	/* the mask ROM code should have PLL and others stable */</span><br><span class="line">#ifndef CONFIG_SKIP_LOWLEVEL_INIT</span><br><span class="line">	bl	cpu_init_cp15</span><br><span class="line">	bl	cpu_init_crit</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	bl	_main</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 2 è¡Œï¼šå¦‚æœæ²¡æœ‰å®šä¹‰ CONFIG_SKIP_LOWLEVEL_INIT çš„è¯æ¡ä»¶æˆç«‹ã€‚æˆ‘ä»¬æ²¡æœ‰å®šä¹‰: CONFIG_SKIP_LOWLEVEL_INITï¼Œå› æ­¤æ¡ä»¶æˆç«‹ï¼Œæ‰§è¡Œä¸‹é¢çš„è¯­å¥ã€‚  </p>
<p>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ cpu_init_cp15 å‡½æ•°ï¼Œç”¨æ¥è®¾ç½® CP15 ç›¸å…³çš„å†…å®¹ï¼Œæ¯”å¦‚å…³é—­ MMU ç­‰ï¼Œæ­¤å‡½æ•°åŒæ ·åœ¨ start.Sæ–‡ä»¶ä¸­å®šä¹‰çš„ï¼Œè¿™é‡Œå°±æš‚æ—¶ä¸å…³å¿ƒè¿™ä¸ªå‡½æ•°äº†ã€‚</p>
<p>ç¬¬ 4 è¡Œï¼šè°ƒç”¨ cpu_init_critå‡½æ•°ï¼Œè€Œè¯¥å‡½æ•°å†…éƒ¨ä»…ä»…æ˜¯è°ƒç”¨äº†å‡½æ•° lowlevel_init ï¼ˆè¿™ä¸ªå‡½æ•°åè¾¹ä¼šå†åˆ†æï¼‰ã€‚</p>
<p>ç¬¬ 7 è¡Œï¼šè·³è½¬åˆ° main å‡½æ•°ã€‚</p>
<h2 id="2-lowlevel-init-å‡½æ•°"><a href="#2-lowlevel-init-å‡½æ•°" class="headerlink" title="2.Â lowlevel_init å‡½æ•°"></a><font size=3>2.Â lowlevel_init å‡½æ•°</font></h2><p>ä¸Šè¾¹æˆ‘ä»¬åˆ†æè¿‡ï¼Œåˆ°æ‰§è¡Œ main å‡½æ•°ä¹‹å‰ï¼Œè¿˜ä¼šè°ƒç”¨lowlevel_init  å‡½æ•°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°æ˜¯å¹²å˜›çš„ã€‚</p>
<h3 id="2-1-lowlevel-init-å‡½æ•°åœ¨å“ªï¼Ÿ"><a href="#2-1-lowlevel-init-å‡½æ•°åœ¨å“ªï¼Ÿ" class="headerlink" title="2.1Â lowlevel_init å‡½æ•°åœ¨å“ªï¼Ÿ"></a><font size=3>2.1Â lowlevel_init å‡½æ•°åœ¨å“ªï¼Ÿ</font></h3><p>lowlevel_init è¿™ä¸ªå‡½æ•°åœ¨ubootæºç çš„è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰ ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/cpu/armv7/lowlevel_init.S</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ä¼šçœ‹åˆ°æœ‰å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * A lowlevel_init function that sets up the stack to call a C function to</span><br><span class="line"> * perform further init.</span><br><span class="line"> *</span><br><span class="line"> * (C) Copyright 2010</span><br><span class="line"> * Texas Instruments, &lt;www.ti.com&gt;</span><br><span class="line"> *</span><br><span class="line"> * Author :</span><br><span class="line"> *	Aneesh V	&lt;aneesh@ti.com&gt;</span><br><span class="line"> *</span><br><span class="line"> * SPDX-License-Identifier:	GPL-2.0+</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#include &lt;asm-offsets.h&gt;</span><br><span class="line">#include &lt;config.h&gt;</span><br><span class="line">#include &lt;linux/linkage.h&gt;</span><br><span class="line"></span><br><span class="line">ENTRY(lowlevel_init)</span><br><span class="line">	/*</span><br><span class="line">	 * Setup a temporary stack. Global data is not available yet.</span><br><span class="line">	 */</span><br><span class="line">	ldr	sp, =CONFIG_SYS_INIT_SP_ADDR</span><br><span class="line">	bic	sp, sp, #7 /* 8-byte alignment for ABI compliance */</span><br><span class="line">#ifdef CONFIG_SPL_DM</span><br><span class="line">	mov	r9, #0</span><br><span class="line">#else</span><br><span class="line">	/*</span><br><span class="line">	 * Set up global data for boards that still need it. This will be</span><br><span class="line">	 * removed soon.</span><br><span class="line">	 */</span><br><span class="line">#ifdef CONFIG_SPL_BUILD</span><br><span class="line">	ldr	r9, =gdata</span><br><span class="line">#else</span><br><span class="line">	sub	sp, sp, #GD_SIZE</span><br><span class="line">	bic	sp, sp, #7</span><br><span class="line">	mov	r9, sp</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line">	/*</span><br><span class="line">	 * Save the old lr(passed in ip) and the current lr to stack</span><br><span class="line">	 */</span><br><span class="line">	push	&#123;ip, lr&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Call the very early init function. This should do only the</span><br><span class="line">	 * absolute bare minimum to get started. It should not:</span><br><span class="line">	 *</span><br><span class="line">	 * - set up DRAM</span><br><span class="line">	 * - use global_data</span><br><span class="line">	 * - clear BSS</span><br><span class="line">	 * - try to start a console</span><br><span class="line">	 *</span><br><span class="line">	 * For boards with SPL this should be empty since SPL can do all of</span><br><span class="line">	 * this init in the SPL board_init_f() function which is called</span><br><span class="line">	 * immediately after this.</span><br><span class="line">	 */</span><br><span class="line">	bl	s_init</span><br><span class="line">	pop	&#123;ip, pc&#125;</span><br><span class="line">ENDPROC(lowlevel_init)</span><br></pre></td></tr></table></figure>

<h3 id="2-2-æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ"><a href="#2-2-æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2.2 æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>2.2 æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ</font></h3><h4 id="2-1-è®¾ç½®å †æ ˆæŒ‡é’ˆ-sp"><a href="#2-1-è®¾ç½®å †æ ˆæŒ‡é’ˆ-sp" class="headerlink" title="2.1 è®¾ç½®å †æ ˆæŒ‡é’ˆ sp"></a><font size=3>2.1 è®¾ç½®å †æ ˆæŒ‡é’ˆ sp</font></h4><p>ç¬¬ 22 è¡Œä»£ç å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldr	sp, =CONFIG_SYS_INIT_SP_ADDR</span><br></pre></td></tr></table></figure>

<p>è¯¥è¯­å¥è®¾ç½® sp æŒ‡å‘ CONFIG_SYS_INIT_SP_ADDRï¼Œ CONFIG_SYS_INIT_SP_ADDR åœ¨ include&#x2F;configs&#x2F;mx6ullevk.h æ–‡ä»¶ä¸­æœ‰å¦‚ä¸‹æ‰€ç¤ºå®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_INIT_RAM_ADDR	IRAM_BASE_ADDR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_INIT_RAM_SIZE	IRAM_SIZE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_INIT_SP_OFFSET \</span></span><br><span class="line"><span class="meta">	(CONFIG_SYS_INIT_RAM_SIZE - GENERATED_GBL_DATA_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_INIT_SP_ADDR \</span></span><br><span class="line"><span class="meta">	(CONFIG_SYS_INIT_RAM_ADDR + CONFIG_SYS_INIT_SP_OFFSET)</span></span><br></pre></td></tr></table></figure>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ IRAM_BASE_ADDR å’Œ IRAM_SIZE çš„å€¼ </summary>
              <div class='content'>
              <p>IRAM_BASE_ADDR å’Œ IRAM_SIZE åœ¨ æ–‡ ä»¶ arch&#x2F;arm&#x2F;include&#x2F;asm&#x2F;arch-mx6&#x2F;imx-regs.h ä¸­æœ‰å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶å®å°±æ˜¯IMX6UL&#x2F;IM6ULL å†…éƒ¨ ocram çš„é¦–åœ°å€å’Œå¤§å°ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRAM_BASE_ADDR			0x00900000</span></span><br><span class="line"><span class="comment">// å®ƒä¿©å¹¶ä¸æŒ¨ç€ï¼Œä¸­é—´çš„çœç•¥ ... ...</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !(defined(CONFIG_MX6SX) || defined(CONFIG_MX6UL) || \</span></span><br><span class="line"><span class="meta">	defined(CONFIG_MX6SLL) || defined(CONFIG_MX6SL))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRAM_SIZE                    0x00040000</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRAM_SIZE                    0x00020000</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p> å¦‚æœç¬¬ 3 è¡Œçš„æ¡ä»¶æˆç«‹çš„è¯ IRAM_SIZE&#x3D;0X40000ï¼Œå½“å®šä¹‰äº† CONFIG_MX6SXã€CONFIG_MX6Uã€ CONFIG_MX6SLL å’ŒCONFIG_MX6SL ä¸­çš„ä»»æ„ä¸€ä¸ªçš„è¯ï¼Œæ¡ä»¶å°±ä¸æˆç«‹ï¼Œåœ¨ .config ä¸­å®šä¹‰äº† CONFIG_MX6ULï¼Œæ‰€ä»¥æ¡ä»¶ä¸æˆç«‹ï¼Œæ‰€ä»¥æœ€ç»ˆIRAM_SIZE &#x3D; 0X20000 &#x3D; 128KBã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SYS_INIT_RAM_ADDR = IRAM_BASE_ADDR = <span class="number">0x00900000</span></span><br><span class="line">CONFIG_SYS_INIT_RAM_SIZE = <span class="number">0x00020000</span> = <span class="number">128</span>KB</span><br></pre></td></tr></table></figure>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ GENERATED_GBL_DATA_SIZE çš„å€¼ </summary>
              <div class='content'>
              <p>GENERATED_GBL_DATA_SIZE åœ¨æ–‡ä»¶ include&#x2F;generated&#x2F;generic-asm-offsets.h ä¸­æœ‰å®šä¹‰ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DO NOT MODIFY.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This file was generated by Kbuild</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_GBL_DATA_SIZE 256 <span class="comment">/* (sizeof(struct global_data) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_BD_INFO_SIZE 80 <span class="comment">/* (sizeof(struct bd_info) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_SIZE 248 <span class="comment">/* sizeof(struct global_data)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_BD 0 <span class="comment">/* offsetof(struct global_data, bd)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_MALLOC_BASE 192 <span class="comment">/* offsetof(struct global_data, malloc_base)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOCADDR 48 <span class="comment">/* offsetof(struct global_data, relocaddr)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOC_OFF 68 <span class="comment">/* offsetof(struct global_data, reloc_off)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_START_ADDR_SP 64 <span class="comment">/* offsetof(struct global_data, start_addr_sp)	@ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>ç¬¬ 9 è¡Œï¼šGENERATED_GBL_DATA_SIZE&#x3D;256ï¼Œ GENERATED_GBL_DATA_SIZE çš„å«ä¹‰ä¸º (sizeof(struct global_data) + 15) &amp; ~15 ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GENERATED_GBL_DATA_SIZE = <span class="number">256</span></span><br></pre></td></tr></table></figure>
              </div>
            </details>

<p>æ‰€ä»¥ï¼Œæ‰€éœ€è¦çš„å˜é‡æœ‰å¦‚ä¸‹ä¸‰ä¸ªï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SYS_INIT_RAM_ADDR = IRAM_BASE_ADDR = <span class="number">0x00900000</span></span><br><span class="line">CONFIG_SYS_INIT_RAM_SIZE = <span class="number">0x00020000</span> = <span class="number">128</span>KB</span><br><span class="line">GENERATED_GBL_DATA_SIZE = <span class="number">256</span></span><br></pre></td></tr></table></figure>

<p>æ•…ï¼ŒCONFIG_SYS_INIT_SP_ADDR  çš„å€¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SYS_INIT_SP_OFFSET = CONFIG_SYS_INIT_RAM_SIZE - GENERATED_GBL_DATA_SIZE = <span class="number">0x00020000</span> - <span class="number">256</span> = <span class="number">0x1FF00</span></span><br><span class="line">CONFIG_SYS_INIT_SP_ADDR = CONFIG_SYS_INIT_RAM_ADDR + CONFIG_SYS_INIT_SP_OFFSET = <span class="number">0x00900000</span> + <span class="number">0x1FF00</span> = <span class="number">0X0091FF00</span></span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶çš„ sp æŒ‡å‘ 0X91FF00ï¼Œè¿™å±äº IMX6UL&#x2F;IMX6ULL çš„å†…éƒ¨ ramã€‚  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015130030906.png" alt="image-20221015130030906" style="zoom: 43%;" />

<h4 id="2-2-spæŒ‡é’ˆ8å­—èŠ‚å¯¹é½"><a href="#2-2-spæŒ‡é’ˆ8å­—èŠ‚å¯¹é½" class="headerlink" title="2.2 spæŒ‡é’ˆ8å­—èŠ‚å¯¹é½"></a><font size=3>2.2 spæŒ‡é’ˆ8å­—èŠ‚å¯¹é½</font></h4><p>ç¬¬ 23 è¡Œä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bic	sp, sp, #7 /* 8-byte alignment for ABI compliance */</span><br></pre></td></tr></table></figure>

<h4 id="2-3-spæŒ‡é’ˆå…¶ä»–æ“ä½œ"><a href="#2-3-spæŒ‡é’ˆå…¶ä»–æ“ä½œ" class="headerlink" title="2.3 spæŒ‡é’ˆå…¶ä»–æ“ä½œ"></a><font size=3>2.3 spæŒ‡é’ˆå…¶ä»–æ“ä½œ</font></h4><p>ç¬¬ 34 è¡Œï¼šsp æŒ‡é’ˆå‡å» GD_SIZEï¼Œ GD_SIZE åŒæ ·åœ¨ include&#x2F;generated&#x2F;generic-asm-offsets.h ä¸­å®šäº†ï¼Œå¤§å°ä¸º 248ã€‚</p>
<p>ç¬¬ 35 è¡Œï¼šå¯¹ sp åš 8 å­—èŠ‚å¯¹é½ï¼Œæ­¤æ—¶ sp çš„åœ°å€ä¸º 0X0091FF00 - 248 &#x3D; 0X0091FE08ã€‚æ­¤æ—¶çš„ sp æŒ‡é’ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015130125594.png" alt="image-20221015130125594" style="zoom:40%;" />

<p>ç¬¬ 36 è¡Œï¼šå°† sp åœ°å€ä¿å­˜åœ¨ r9 å¯„å­˜å™¨ä¸­ã€‚</p>
<p>ç¬¬ 42 è¡Œï¼šå°† ip å’Œ lr å‹æ ˆ</p>
<p>ç¬¬ 57 è¡Œï¼šè°ƒç”¨å‡½æ•° s_initï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬åè¾¹å†è¯´ã€‚</p>
<p>ç¬¬ 58 è¡Œï¼šå°†ç¬¬ 36 è¡Œå…¥æ ˆçš„ ip å’Œ lr è¿›è¡Œå‡ºæ ˆï¼Œå¹¶å°† lr èµ‹ç»™ pcã€‚  </p>
<h2 id="3-s-init-å‡½æ•°"><a href="#3-s-init-å‡½æ•°" class="headerlink" title="3.Â s_init å‡½æ•°"></a><font size=3>3.Â s_init å‡½æ•°</font></h2><h3 id="3-1-s-init-å‡½æ•°åœ¨å“ªï¼Ÿ"><a href="#3-1-s-init-å‡½æ•°åœ¨å“ªï¼Ÿ" class="headerlink" title="3.1Â s_init å‡½æ•°åœ¨å“ªï¼Ÿ"></a><font size=3>3.1Â s_init å‡½æ•°åœ¨å“ªï¼Ÿ</font></h3><p>å‰è¾¹æˆ‘ä»¬åˆ†æ lowlevel_init å‡½æ•°çš„æ—¶å€™ï¼Œå‘ç°è¿™ä¸ªå‡½æ•°åœ¨æœ€åè°ƒç”¨äº† s_init å‡½æ•°ï¼Œs_init å‡½æ•°å®šä¹‰åœ¨ubootæºç çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/cpu/armv7/mx6/soc.c</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šçœ‹åˆ°æ­¤å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">s_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">anatop_regs</span> *<span class="title">anatop</span> =</span> (<span class="keyword">struct</span> anatop_regs *)ANATOP_BASE_ADDR;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mxc_ccm_reg</span> *<span class="title">ccm</span> =</span> (<span class="keyword">struct</span> mxc_ccm_reg *)CCM_BASE_ADDR;</span><br><span class="line">	u32 mask480;</span><br><span class="line">	u32 mask528;</span><br><span class="line">	u32 reg, periph1, periph2;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (is_cpu_type(MXC_CPU_MX6SX) || is_cpu_type(MXC_CPU_MX6UL) ||</span><br><span class="line">	    is_cpu_type(MXC_CPU_MX6ULL) || is_cpu_type(MXC_CPU_MX6SLL))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Due to hardware limitation, on MX6Q we need to gate/ungate all PFDs</span></span><br><span class="line"><span class="comment">	 * to make sure PFD is working right, otherwise, PFDs may</span></span><br><span class="line"><span class="comment">	 * not output clock after reset, MX6DL and MX6SL have added 396M pfd</span></span><br><span class="line"><span class="comment">	 * workaround in ROM code, as bus clock need it</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	mask480 = ANATOP_PFD_CLKGATE_MASK(<span class="number">0</span>) |</span><br><span class="line">		ANATOP_PFD_CLKGATE_MASK(<span class="number">1</span>) |</span><br><span class="line">		ANATOP_PFD_CLKGATE_MASK(<span class="number">2</span>) |</span><br><span class="line">		ANATOP_PFD_CLKGATE_MASK(<span class="number">3</span>);</span><br><span class="line">	mask528 = ANATOP_PFD_CLKGATE_MASK(<span class="number">1</span>) |</span><br><span class="line">		ANATOP_PFD_CLKGATE_MASK(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	reg = readl(&amp;ccm-&gt;cbcmr);</span><br><span class="line">	periph2 = ((reg &amp; MXC_CCM_CBCMR_PRE_PERIPH2_CLK_SEL_MASK)</span><br><span class="line">		&gt;&gt; MXC_CCM_CBCMR_PRE_PERIPH2_CLK_SEL_OFFSET);</span><br><span class="line">	periph1 = ((reg &amp; MXC_CCM_CBCMR_PRE_PERIPH_CLK_SEL_MASK)</span><br><span class="line">		&gt;&gt; MXC_CCM_CBCMR_PRE_PERIPH_CLK_SEL_OFFSET);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Checking if PLL2 PFD0 or PLL2 PFD2 is using for periph clock */</span></span><br><span class="line">	<span class="keyword">if</span> ((periph2 != <span class="number">0x2</span>) &amp;&amp; (periph1 != <span class="number">0x2</span>))</span><br><span class="line">		mask528 |= ANATOP_PFD_CLKGATE_MASK(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((periph2 != <span class="number">0x1</span>) &amp;&amp; (periph1 != <span class="number">0x1</span>) &amp;&amp;</span><br><span class="line">		(periph2 != <span class="number">0x3</span>) &amp;&amp; (periph1 != <span class="number">0x3</span>))</span><br><span class="line">		mask528 |= ANATOP_PFD_CLKGATE_MASK(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	writel(mask480, &amp;anatop-&gt;pfd_480_set);</span><br><span class="line">	writel(mask528, &amp;anatop-&gt;pfd_528_set);</span><br><span class="line">	writel(mask480, &amp;anatop-&gt;pfd_480_clr);</span><br><span class="line">	writel(mask528, &amp;anatop-&gt;pfd_528_clr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ"><a href="#3-2-æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="3.2 æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>3.2 æœ€ç»ˆåšäº†ä»€ä¹ˆï¼Ÿ</font></h3><p>åœ¨æ­¤å‡½æ•°ä¸­ä¼šåˆ¤æ–­CPUçš„ç±»å‹ï¼Œå¦‚æœ CPU ä¸º MX6SXã€ MX6ULã€ MX6ULL æˆ– MX6SLLä¸­çš„ä»»æ„ä¸€ç§ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›ï¼Œç›¸å½“äºs_init å‡½æ•°ä»€ä¹ˆéƒ½æ²¡åšã€‚æ‰€ä»¥å¯¹äº I.MX6UL&#x2F;I.MX6ULL æ¥è¯´ï¼Œ s_init å°±æ˜¯ä¸ªç©ºå‡½æ•°ã€‚ä» s_init å‡½æ•°é€€å‡ºä»¥åè¿›å…¥å‡½æ•° lowlevel_initï¼Œä½†æ˜¯ lowlevel_init å‡½æ•°ä¹Ÿæ‰§è¡Œå®Œæˆäº†ï¼Œè¿”å›åˆ°äº†å‡½æ•° cpu_init_critï¼Œå‡½æ•° cpu_init_crit ä¹Ÿæ‰§è¡Œå®Œæˆäº†ï¼Œæœ€ç»ˆè¿”å›åˆ° save_boot_params_retã€‚</p>
<h2 id="4-main-å‡½æ•°"><a href="#4-main-å‡½æ•°" class="headerlink" title="4. _main å‡½æ•°"></a><font size=3>4. _main å‡½æ•°</font></h2><h3 id="4-1-main-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"><a href="#4-1-main-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="4.1 _main å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"></a><font size=3>4.1 _main å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</font></h3><p>ç»è¿‡å‰è¾¹çš„åˆ†æï¼Œsave_boot_params_ret å‡½æ•°æœ€åä¼šè·³è½¬åˆ° _main å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨ uboot æºç çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/lib/crt0.S</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(_main)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up initial C runtime environment and call board_init_f(0).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span></span><br><span class="line">	ldr	sp, =(CONFIG_SPL_STACK)</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	ldr	sp, =(CONFIG_SYS_INIT_SP_ADDR)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CPU_V7M)	<span class="comment">/* v7M forbids using SP as BIC destination */</span></span></span><br><span class="line">	mov	r3, sp</span><br><span class="line">	bic	r3, r3, #<span class="number">7</span></span><br><span class="line">	mov	sp, r3</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	bic	sp, sp, #<span class="number">7</span>	<span class="comment">/* 8-byte alignment for ABI compliance */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	mov	r0, sp</span><br><span class="line">	bl	board_init_f_alloc_reserve</span><br><span class="line">	mov	sp, r0</span><br><span class="line">	<span class="comment">/* set up gd here, outside any C code */</span></span><br><span class="line">	mov	r9, r0</span><br><span class="line">	bl	board_init_f_init_reserve</span><br><span class="line"></span><br><span class="line">	mov	r0, #<span class="number">0</span></span><br><span class="line">	bl	board_init_f</span><br><span class="line"><span class="comment">/* åè¾¹çš„çœç•¥ ... ... */</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#4-2-åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="4.2 åšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>4.2 åšäº†ä»€ä¹ˆï¼Ÿ</font></h3><p>åœ¨ arch&#x2F;arm&#x2F;lib&#x2F;crt0.S æ–‡ä»¶å¼€å¤´ï¼Œå…¶å®å·²ç»è¯´æ˜äº† _main å‡½æ•°ä¸»è¦åšäº†é‚£äº›äº‹æƒ…ã€‚</p>
<ul>
<li>ï¼ˆ1ï¼‰è®¾ç½®è°ƒç”¨ board_init_f() çš„åˆå§‹ç¯å¢ƒã€‚</li>
<li>ï¼ˆ2ï¼‰è°ƒç”¨board_init_f()ã€‚</li>
<li>ï¼ˆ3ï¼‰è®¾ç½®ä¸­é—´ç¯å¢ƒï¼Œå…¶ä¸­å †æ ˆå’ŒGDæ˜¯ç”±ç³»ç»ŸRAMä¸­çš„board_init_f()åˆ†é…çš„ï¼Œä½†BSSå’Œåˆå§‹åŒ–çš„éconstæ•°æ®ä»ç„¶ä¸å¯ç”¨ã€‚</li>
<li>ï¼ˆ4ï¼‰å¯¹äºU-Boot(ä¸æ˜¯SPL)ï¼Œè°ƒç”¨relocate_code()ã€‚å¯¹äºSPL, board_init_f()åªè¿”å›(åˆ°crt0)ã€‚</li>
<li>ï¼ˆ5ï¼‰è®¾ç½®è°ƒç”¨board_init_r()çš„æœ€ç»ˆç¯å¢ƒã€‚</li>
<li>ï¼ˆ6ï¼‰å¯¹äºU-Bootæœ¬èº«(ä¸æ˜¯SPL)ï¼Œä¸€äº›cpuåœ¨å†…å­˜æ–¹é¢è¿˜æœ‰ä¸€äº›å·¥ä½œè¦åšï¼Œå› æ­¤è°ƒç”¨ c_runtime_cpu_setup ã€‚</li>
<li>ï¼ˆ7ï¼‰è°ƒç”¨board_init_r()ã€‚</li>
</ul>
<h4 id="4-2-1-è®¾ç½®åˆå§‹Cè¿è¡Œæ—¶ç¯å¢ƒ"><a href="#4-2-1-è®¾ç½®åˆå§‹Cè¿è¡Œæ—¶ç¯å¢ƒ" class="headerlink" title="4.2.1 è®¾ç½®åˆå§‹Cè¿è¡Œæ—¶ç¯å¢ƒ"></a><font size=3>4.2.1 è®¾ç½®åˆå§‹Cè¿è¡Œæ—¶ç¯å¢ƒ</font></h4><p>ä»¥ä¸‹éƒ¨åˆ†ä¸º arch&#x2F;arm&#x2F;lib&#x2F;crt0.S æ–‡ä»¶çš„ 69 - 93 è¡Œä»£ç </p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Set up initial C runtime environment and call board_init_f(0).</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span><br><span class="line">	ldr	sp, =(CONFIG_SPL_STACK)</span><br><span class="line">#else</span><br><span class="line">	ldr	sp, =(CONFIG_SYS_INIT_SP_ADDR)</span><br><span class="line">#endif</span><br><span class="line">#if defined(CONFIG_CPU_V7M)	/* v7M forbids using SP as BIC destination */</span><br><span class="line">	mov	r3, sp</span><br><span class="line">	bic	r3, r3, #7</span><br><span class="line">	mov	sp, r3</span><br><span class="line">#else</span><br><span class="line">	bic	sp, sp, #7	/* 8-byte alignment for ABI compliance */</span><br><span class="line">#endif</span><br><span class="line">	mov	r0, sp</span><br><span class="line">	bl	board_init_f_alloc_reserve</span><br><span class="line">	mov	sp, r0</span><br><span class="line">	/* set up gd here, outside any C code */</span><br><span class="line">	mov	r9, r0</span><br><span class="line">	bl	board_init_f_init_reserve</span><br><span class="line"></span><br><span class="line">	mov	r0, #0</span><br><span class="line">	bl	board_init_f</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 8 è¡Œï¼ˆç¬¬ 76 è¡Œï¼‰ï¼šè®¾ç½® sp æŒ‡é’ˆä¸º CONFIG_SYS_INIT_SP_ADDRï¼Œä¹Ÿå°±æ˜¯ sp æŒ‡å‘ 0X0091FF00ã€‚  </p>
<p>ç¬¬ 15 è¡Œï¼ˆç¬¬ 83 è¡Œï¼‰ï¼šsp åš 8 å­—èŠ‚å¯¹é½ã€‚ </p>
<p>ç¬¬ 17 è¡Œï¼ˆç¬¬ 85 è¡Œï¼‰ï¼šè¯»å– sp åˆ°å¯„å­˜å™¨ r0 é‡Œé¢ï¼Œæ­¤æ—¶ r0&#x3D;0X0091FF00ã€‚  </p>
<p>ç¬¬ 18 è¡Œï¼ˆç¬¬ 86 è¡Œï¼‰ï¼šè°ƒç”¨å‡½æ•° board_init_f_alloc_reserveï¼Œæ­¤å‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°ä¸º r0 ä¸­çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ 0X0091FF00 ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯ç•™å‡ºæ—©æœŸçš„ malloc å†…å­˜åŒºåŸŸå’Œ gd å†…å­˜åŒºåŸŸã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ board_init_f_alloc_reserve å‡½æ•° </summary>
              <div class='content'>
              <p>æ­¤å‡½æ•°å®šä¹‰åœ¨ common&#x2F;init&#x2F;board_init.c  æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ulong <span class="title function_">board_init_f_alloc_reserve</span><span class="params">(ulong top)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Reserve early malloc arena */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_MALLOC_F)</span></span><br><span class="line">	top -= CONFIG_SYS_MALLOC_F_LEN;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* LAST : reserve GD (rounded up to a multiple of 16 bytes) */</span></span><br><span class="line">	top = rounddown(top-<span class="keyword">sizeof</span>(<span class="keyword">struct</span> global_data), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> top;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•° board_init_f_alloc_reserve ä¸»è¦æ˜¯ç•™å‡ºæ—©æœŸçš„ malloc å†…å­˜åŒºåŸŸå’Œ gd å†…å­˜åŒºåŸŸï¼Œå…¶ä¸­ CONFIG_SYS_MALLOC_F_LEN&#x3D;0X400ï¼ˆ åœ¨æ–‡ä»¶ include&#x2F;generated&#x2F;autoconf.h ä¸­å®šä¹‰ ) ï¼Œsizeof(struct global_data)&#x3D;248ï¼ˆGD_SIZE å€¼ï¼‰ï¼Œå®Œæˆä»¥åçš„å†…å­˜åˆ†å¸ƒå¦‚ä¸‹å›¾ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015143824906.png" alt="image-20221015143824906" style="zoom:50%;" /><p>å‡½æ•° board_init_f_alloc_reserve æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œè¿”å›å€¼ä¸ºæ–°çš„ top å€¼ï¼Œæ­¤æ—¶ top&#x3D;0X0091FA00ã€‚  </p>
              </div>
            </details>

<p>ç¬¬ 19 è¡Œï¼ˆç¬¬ 87 è¡Œï¼‰ï¼šå°† r0 å†™å…¥åˆ° sp é‡Œé¢ï¼Œr0 ä¿å­˜ç€å‡½æ•° board_init_f_alloc_reserve çš„è¿”å›å€¼ï¼Œæ‰€ä»¥è¿™ä¸€å¥ä¹Ÿå°±æ˜¯è®¾ç½® sp &#x3D; 0X0091FA00ã€‚  </p>
<p>ç¬¬ 21 è¡Œï¼ˆç¬¬ 89 è¡Œï¼‰ï¼šå°† r0 å¯„å­˜å™¨çš„å€¼å†™åˆ°å¯„å­˜å™¨ r9 é‡Œé¢ï¼Œå› ä¸º r9 å¯„å­˜å™¨å­˜æ”¾ç€å…¨å±€å˜é‡ gd çš„åœ°å€ã€‚æ‰€ä»¥è¿™ä¸€å¥å…¶å®å°±æ˜¯è®© gd æŒ‡å‘ 0X0091FA00 ã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ gd åœ°å€ </summary>
              <div class='content'>
              <p>åœ¨æ–‡ä»¶ arch&#x2F;arm&#x2F;include&#x2F;asm&#x2F;global_data.h  ä¸­æœ‰å¦‚ä¸‹å®å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_GLOBAL_DATA_PTR		register volatile gd_t *gd asm (<span class="string">&quot;x18&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_GLOBAL_DATA_PTR		register volatile gd_t *gd asm (<span class="string">&quot;r9&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œ uboot ä¸­å®šä¹‰äº†ä¸€ä¸ªæŒ‡å‘ gd_t çš„æŒ‡é’ˆ gdï¼Œ gd æ˜¯å­˜æ”¾åœ¨å¯„å­˜å™¨ r9 é‡Œé¢çš„ï¼Œå› æ­¤ gd æ˜¯ä¸ªå…¨å±€å˜é‡ã€‚ å¦å¤– gd_t æ˜¯ä¸ªç»“æ„ä½“ï¼Œ è¿™ä¸ªç»“æ„ä½“å®šä¹‰åœ¨ uboot æºç çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include/asm-generic/global_data.h</span><br></pre></td></tr></table></figure><p> æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> &#123;</span></span><br><span class="line">	<span class="type">bd_t</span> *bd;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> baudrate;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> cpu_clk;	<span class="comment">/* CPU clock in Hz!		*/</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bus_clk;</span><br><span class="line">	<span class="comment">/* We cannot bracket this with CONFIG_PCI due to mpc5xxx */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> pci_clk;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> mem_clk;</span><br><span class="line">	<span class="comment">// ä¸­é—´éƒ¨åˆ†çœç•¥ ... ...</span></span><br><span class="line">&#125; <span class="type">gd_t</span>;</span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯çŸ¥ï¼Œè¿™ä¸€è¡Œä»£ç å°±æ˜¯è®¾ç½® gd æ‰€æŒ‡å‘çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ gd æŒ‡å‘ 0X0091FA00ã€‚  </p>
              </div>
            </details>

<p>ç¬¬ 22 è¡Œï¼ˆç¬¬ 90 è¡Œï¼‰ï¼šè°ƒç”¨å‡½æ•° board_init_f_init_reserve ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯ç”¨äºåˆå§‹åŒ– gdï¼Œå…¶å®å°±æ˜¯æ¸… 0 å¤„ç†ã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ board_init_f_init_reserve </summary>
              <div class='content'>
              <p>æ­¤å‡½æ•°åœ¨æ–‡ä»¶ common&#x2F;init&#x2F;board_init.c ä¸­æœ‰å®šä¹‰ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_f_init_reserve</span><span class="params">(ulong base)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> *<span class="title">gd_ptr</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _USE_MEMCPY</span></span><br><span class="line">	<span class="type">int</span> *ptr;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * clear GD entirely and set it up.</span></span><br><span class="line"><span class="comment">	 * Use gd_ptr, as gd may not be properly set yet.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	gd_ptr = (<span class="keyword">struct</span> global_data *)base;</span><br><span class="line">	<span class="comment">/* zero the area */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _USE_MEMCPY</span></span><br><span class="line">	<span class="built_in">memset</span>(gd_ptr, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(*gd));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">for</span> (ptr = (<span class="type">int</span> *)gd_ptr; ptr &lt; (<span class="type">int</span> *)(gd_ptr + <span class="number">1</span>); )</span><br><span class="line">		*ptr++ = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* set GD unless architecture did it already */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM)</span></span><br><span class="line">	arch_setup_gd(gd_ptr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* next alloc will be higher by one GD plus 16-byte alignment */</span></span><br><span class="line">	base += roundup(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> global_data), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * record early malloc arena start.</span></span><br><span class="line"><span class="comment">	 * Use gd as it is now properly set for all architectures.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_MALLOC_F)</span></span><br><span class="line">	<span class="comment">/* go down one &#x27;early malloc arena&#x27; */</span></span><br><span class="line">	gd-&gt;malloc_base = base;</span><br><span class="line">	<span class="comment">/* next alloc will be higher by one &#x27;early malloc arena&#x27; size */</span></span><br><span class="line">	base += CONFIG_SYS_MALLOC_F_LEN;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œæ­¤å‡½æ•°ç”¨äºåˆå§‹åŒ– gdï¼Œå…¶å®å°±æ˜¯æ¸…é›¶å¤„ç†ã€‚å¦å¤–ï¼Œæ­¤å‡½æ•°è¿˜è®¾ç½®äº† gd-&gt;malloc_base ä¸º gd åŸºåœ°å€+gd å¤§å° &#x3D; 0X0091FA00 + 248 &#x3D; 0X0091FAF8ï¼Œå†åš 16 å­—èŠ‚å¯¹é½ï¼Œæœ€ç»ˆ gd-&gt;malloc_base &#x3D; 0X0091FB00ï¼Œè¿™ä¸ªä¹Ÿå°±æ˜¯ early malloc çš„èµ·å§‹åœ°å€ã€‚  </p>
              </div>
            </details>

<p>ç¬¬ 25 è¡Œï¼ˆç¬¬ 93 è¡Œï¼‰ï¼šè°ƒç”¨ board_init_f å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;board_f.c ä¸­ï¼Œä¸»è¦ç”¨æ¥åˆå§‹åŒ– DDRï¼Œå®šæ—¶å™¨ï¼Œå®Œæˆä»£ç æ‹·è´ç­‰ï¼Œåè¾¹æˆ‘ä»¬ä¼šå†è¯¦ç»†åˆ†æè¿™ä¸ªå‡½æ•°ã€‚</p>
<h4 id="4-2-2-è®¾ç½®ä¸­é—´ç¯å¢ƒ"><a href="#4-2-2-è®¾ç½®ä¸­é—´ç¯å¢ƒ" class="headerlink" title="4.2.2 è®¾ç½®ä¸­é—´ç¯å¢ƒ"></a><font size=3>4.2.2 è®¾ç½®ä¸­é—´ç¯å¢ƒ</font></h4><p>ä»¥ä¸‹éƒ¨åˆ†ä¸º arch&#x2F;arm&#x2F;lib&#x2F;crt0.S æ–‡ä»¶çš„ 97 - 127 è¡Œä»£ç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Set up intermediate environment (new sp and gd) and call</span><br><span class="line"> * relocate_code(addr_moni). Trick here is that we&#x27;ll return</span><br><span class="line"> * &#x27;here&#x27; but relocated.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">	ldr	sp, [r9, #GD_START_ADDR_SP]	/* sp = gd-&gt;start_addr_sp */</span><br><span class="line">#if defined(CONFIG_CPU_V7M)	/* v7M forbids using SP as BIC destination */</span><br><span class="line">	mov	r3, sp</span><br><span class="line">	bic	r3, r3, #7</span><br><span class="line">	mov	sp, r3</span><br><span class="line">#else</span><br><span class="line">	bic	sp, sp, #7	/* 8-byte alignment for ABI compliance */</span><br><span class="line">#endif</span><br><span class="line">	ldr	r9, [r9, #GD_BD]		/* r9 = gd-&gt;bd */</span><br><span class="line">	sub	r9, r9, #GD_SIZE		/* new GD is below bd */</span><br><span class="line"></span><br><span class="line">	adr	lr, here</span><br><span class="line">	ldr	r0, [r9, #GD_RELOC_OFF]		/* r0 = gd-&gt;reloc_off */</span><br><span class="line">	add	lr, lr, r0</span><br><span class="line">#if defined(CONFIG_CPU_V7M)</span><br><span class="line">	orr	lr, #1				/* As required by Thumb-only */</span><br><span class="line">#endif</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]		/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	b	relocate_code</span><br><span class="line">here:</span><br><span class="line">/*</span><br><span class="line"> * now relocate vectors</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">	bl	relocate_vectors</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 13 è¡Œï¼ˆç¬¬ 109 è¡Œï¼‰ï¼šsp åš 8 å­—èŠ‚å¯¹é½ã€‚  </p>
<p>ç¬¬ 15 è¡Œï¼ˆç¬¬ 111 è¡Œï¼‰ï¼šè·å– gd-&gt;bd çš„åœ°å€èµ‹ç»™ r9ï¼Œæ­¤æ—¶ r9 å­˜æ”¾çš„æ˜¯ä¹‹å‰çš„ gdï¼Œè¿™é‡Œé€šè¿‡è·å– gd-&gt;bd çš„åœ°å€æ¥è®¡ç®—å‡ºæ–°çš„ gd çš„ä½ç½®ã€‚ </p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ GD_BD çš„å€¼ </summary>
              <div class='content'>
              <p>GD_BD å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;generated&#x2F;generic-asm-offsets.h ä¸­ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DO NOT MODIFY.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This file was generated by Kbuild</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_GBL_DATA_SIZE 256 <span class="comment">/* (sizeof(struct global_data) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_BD_INFO_SIZE 80 <span class="comment">/* (sizeof(struct bd_info) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_SIZE 248 <span class="comment">/* sizeof(struct global_data)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_BD 0 <span class="comment">/* offsetof(struct global_data, bd)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_MALLOC_BASE 192 <span class="comment">/* offsetof(struct global_data, malloc_base)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOCADDR 48 <span class="comment">/* offsetof(struct global_data, relocaddr)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOC_OFF 68 <span class="comment">/* offsetof(struct global_data, reloc_off)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_START_ADDR_SP 64 <span class="comment">/* offsetof(struct global_data, start_addr_sp)	@ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ ï¼Œå…¶å® GD_BD &#x3D; 0ã€‚</p>
              </div>
            </details>

<p>ç¬¬ 16 è¡Œï¼ˆç¬¬ 112 è¡Œï¼‰ï¼šæ–°çš„ gd åœ¨ bd ä¸‹é¢ï¼Œæ‰€ä»¥ r9 å‡å» gd çš„å¤§å°å°±æ˜¯æ–°çš„ gd çš„ä½ç½®ï¼Œè·å–åˆ°æ–°çš„ gdçš„ä½ç½®ä»¥åèµ‹å€¼ç»™ r9ã€‚  </p>
<p>ç¬¬ 18 è¡Œï¼ˆç¬¬ 114 è¡Œï¼‰ï¼šè®¾ç½® lr å¯„å­˜å™¨ä¸º hereï¼Œè¿™æ ·åé¢æ‰§è¡Œå…¶ä»–å‡½æ•°è¿”å›çš„æ—¶å€™å°±è¿”å›åˆ°äº†ç¬¬ 26 è¡Œï¼ˆç¬¬ 122 è¡Œï¼‰çš„ here ä½ç½®å¤„ã€‚  </p>
<p>ç¬¬ 19 è¡Œï¼ˆç¬¬ 115 è¡Œï¼‰ï¼šè¯»å– gd-&gt;reloc_off çš„å€¼å¤åˆ¶ç»™ r0 å¯„å­˜å™¨ï¼Œ GD_RELOC_OFF&#x3D;68ã€‚  </p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ GD_RELOC_OFF çš„å€¼ </summary>
              <div class='content'>
              <p>GD_RELOC_OFF å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;generated&#x2F;generic-asm-offsets.h ä¸­ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DO NOT MODIFY.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This file was generated by Kbuild</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_GBL_DATA_SIZE 256 <span class="comment">/* (sizeof(struct global_data) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_BD_INFO_SIZE 80 <span class="comment">/* (sizeof(struct bd_info) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_SIZE 248 <span class="comment">/* sizeof(struct global_data)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_BD 0 <span class="comment">/* offsetof(struct global_data, bd)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_MALLOC_BASE 192 <span class="comment">/* offsetof(struct global_data, malloc_base)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOCADDR 48 <span class="comment">/* offsetof(struct global_data, relocaddr)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOC_OFF 68 <span class="comment">/* offsetof(struct global_data, reloc_off)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_START_ADDR_SP 64 <span class="comment">/* offsetof(struct global_data, start_addr_sp)	@ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ ï¼Œå…¶å® GD_RELOC_OFF &#x3D; 68ã€‚</p>
              </div>
            </details>

<p>ç¬¬ 20 è¡Œï¼ˆç¬¬ 116 è¡Œï¼‰ï¼š lr å¯„å­˜å™¨çš„å€¼åŠ ä¸Š r0 å¯„å­˜å™¨çš„å€¼ï¼Œé‡æ–°èµ‹å€¼ç»™ lr å¯„å­˜å™¨ã€‚å› ä¸ºæ¥ä¸‹æ¥è¦é‡å®šä½ä»£ç ï¼Œä¹Ÿå°±æ˜¯æŠŠä»£ç æ‹·è´åˆ°æ–°çš„åœ°æ–¹å»ï¼ˆç°åœ¨çš„ uboot å­˜æ”¾çš„èµ·å§‹åœ°å€ä¸º 0X87800000ï¼Œä¸‹é¢è¦å°† uboot æ‹·è´åˆ° DDR æœ€åé¢çš„åœ°å€ç©ºé—´å‡ºï¼Œå°† 0X87800000 å¼€å§‹çš„å†…å­˜ç©ºå‡ºæ¥ï¼‰ï¼Œå…¶ä¸­å°±åŒ…æ‹¬hereï¼Œå› æ­¤ lr ä¸­çš„ here è¦ä½¿ç”¨é‡å®šä½åçš„ä½ç½®ã€‚ã€</p>
<p>ç¬¬ 24 è¡Œï¼ˆç¬¬ 120 è¡Œï¼‰ï¼šè¯»å– gd-&gt;relocaddr çš„å€¼èµ‹ç»™ r0 å¯„å­˜å™¨ï¼Œæ­¤æ—¶ r0 å¯„å­˜å™¨å°±ä¿å­˜ç€ uboot è¦æ‹·è´çš„ç›®çš„åœ°å€ï¼Œä¸º 0X9FF47000ã€‚ GD_RELOCADDR&#x3D;48ã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ GD_RELOCADDR çš„å€¼ </summary>
              <div class='content'>
              <p>GD_RELOCADDR å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;generated&#x2F;generic-asm-offsets.h ä¸­ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DO NOT MODIFY.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This file was generated by Kbuild</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_GBL_DATA_SIZE 256 <span class="comment">/* (sizeof(struct global_data) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_BD_INFO_SIZE 80 <span class="comment">/* (sizeof(struct bd_info) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_SIZE 248 <span class="comment">/* sizeof(struct global_data)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_BD 0 <span class="comment">/* offsetof(struct global_data, bd)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_MALLOC_BASE 192 <span class="comment">/* offsetof(struct global_data, malloc_base)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOCADDR 48 <span class="comment">/* offsetof(struct global_data, relocaddr)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOC_OFF 68 <span class="comment">/* offsetof(struct global_data, reloc_off)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_START_ADDR_SP 64 <span class="comment">/* offsetof(struct global_data, start_addr_sp)	@ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ ï¼Œå…¶å® GD_RELOCADDR &#x3D; 48ã€‚</p>
              </div>
            </details>

<p>ç¬¬ 25 è¡Œï¼ˆç¬¬ 121 è¡Œï¼‰ï¼šè°ƒç”¨å‡½æ•° relocate_codeï¼Œä¹Ÿå°±æ˜¯ä»£ç é‡å®šä½å‡½æ•°ï¼Œæ­¤å‡½æ•°è´Ÿè´£å°† uboot æ‹·è´åˆ°æ–°çš„åœ°æ–¹å»ï¼Œæ­¤å‡½æ•°å®šä¹‰åœ¨ arch&#x2F;arm&#x2F;lib&#x2F;relocate.S ä¸­ï¼Œåè¾¹ä¼šå†è¯¦ç»†åˆ†æè¿™ä¸ªå‡½æ•°ã€‚  </p>
<p>ç¬¬ 31 è¡Œï¼ˆç¬¬ 127 è¡Œï¼‰ï¼šè°ƒç”¨å‡½æ•° relocate_vectorsï¼Œå¯¹ä¸­æ–­å‘é‡è¡¨åšé‡å®šä½ï¼Œæ­¤å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ arch&#x2F;arm&#x2F;lib&#x2F;relocate.S ä¸­ï¼Œåè¾¹æˆ‘ä»¬ä¼šå†åˆ†æè¿™ä¸ªå‡½æ•°ã€‚</p>
<h4 id="4-2-3-è®¾ç½®æœ€ç»ˆç¯å¢ƒ"><a href="#4-2-3-è®¾ç½®æœ€ç»ˆç¯å¢ƒ" class="headerlink" title="4.2.3 è®¾ç½®æœ€ç»ˆç¯å¢ƒ"></a><font size=3>4.2.3 è®¾ç½®æœ€ç»ˆç¯å¢ƒ</font></h4><p>ä»¥ä¸‹éƒ¨åˆ†ä¸º arch&#x2F;arm&#x2F;lib&#x2F;crt0.S æ–‡ä»¶çš„ 129 - 177 è¡Œä»£ç ï¼Œè¿™éƒ¨åˆ†å…¶å®æ˜¯è·Ÿä¸Šè¾¹çš„ here æ˜¯ä¸€èµ·çš„ï¼Œåªæ˜¯è¿™éƒ¨åˆ†è®¾ç½®çš„æ˜¯æœ€ç»ˆç¯å¢ƒï¼Œå°±æ‹†åˆ†å¼€æ¥åˆ†æäº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/* Set up final (full) environment */</span><br><span class="line"></span><br><span class="line">	bl	c_runtime_cpu_setup	/* we still call old routine here */</span><br><span class="line">#endif</span><br><span class="line">#if !defined(CONFIG_SPL_BUILD) || defined(CONFIG_SPL_FRAMEWORK)</span><br><span class="line"># ifdef CONFIG_SPL_BUILD</span><br><span class="line">	/* Use a DRAM stack for the rest of SPL, if requested */</span><br><span class="line">	bl	spl_relocate_stack_gd</span><br><span class="line">	cmp	r0, #0</span><br><span class="line">	movne	sp, r0</span><br><span class="line">	movne	r9, r0</span><br><span class="line"># endif</span><br><span class="line">	ldr	r0, =__bss_start	/* this is auto-relocated! */</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_USE_ARCH_MEMSET</span><br><span class="line">	ldr	r3, =__bss_end		/* this is auto-relocated! */</span><br><span class="line">	mov	r1, #0x00000000		/* prepare zero to clear BSS */</span><br><span class="line"></span><br><span class="line">	subs	r2, r3, r0		/* r2 = memset len */</span><br><span class="line">	bl	memset</span><br><span class="line">#else</span><br><span class="line">	ldr	r1, =__bss_end		/* this is auto-relocated! */</span><br><span class="line">	mov	r2, #0x00000000		/* prepare zero to clear BSS */</span><br><span class="line"></span><br><span class="line">clbss_l:cmp	r0, r1			/* while not at end of BSS */</span><br><span class="line">#if defined(CONFIG_CPU_V7M)</span><br><span class="line">	itt	lo</span><br><span class="line">#endif</span><br><span class="line">	strlo	r2, [r0]		/* clear 32-bit BSS word */</span><br><span class="line">	addlo	r0, r0, #4		/* move to next */</span><br><span class="line">	blo	clbss_l</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if ! defined(CONFIG_SPL_BUILD)</span><br><span class="line">	bl coloured_LED_init</span><br><span class="line">	bl red_led_on</span><br><span class="line">#endif</span><br><span class="line">	/* call board_init_r(gd_t *id, ulong dest_addr) */</span><br><span class="line">	mov     r0, r9                  /* gd_t */</span><br><span class="line">	ldr	r1, [r9, #GD_RELOCADDR]	/* dest_addr */</span><br><span class="line">	/* call board_init_r */</span><br><span class="line">#if defined(CONFIG_SYS_THUMB_BUILD)</span><br><span class="line">	ldr	lr, =board_init_r	/* this is auto-relocated! */</span><br><span class="line">	bx	lr</span><br><span class="line">#else</span><br><span class="line">	ldr	pc, =board_init_r	/* this is auto-relocated! */</span><br><span class="line">#endif</span><br><span class="line">	/* we should not return here. */</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 3 è¡Œï¼ˆç¬¬ 131 è¡Œï¼‰ï¼šè°ƒç”¨å‡½æ•° c_runtime_cpu_setupã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ c_runtime_cpu_setup å‡½æ•° </summary>
              <div class='content'>
              <p>æ­¤å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶arch&#x2F;arm&#x2F;cpu&#x2F;armv7&#x2F;start.S ä¸­ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(c_runtime_cpu_setup)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If I-cache is enabled invalidate it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SYS_ICACHE_OFF</span></span><br><span class="line">	mcr	p15, <span class="number">0</span>, r0, c7, c5, <span class="number">0</span>	@ invalidate icache</span><br><span class="line">	mcr     p15, <span class="number">0</span>, r0, c7, c10, <span class="number">4</span>	@ DSB</span><br><span class="line">	mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">4</span>	@ ISB</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	bx	lr</span><br><span class="line"></span><br><span class="line"><span class="title function_">ENDPROC</span><span class="params">(c_runtime_cpu_setup)</span></span><br></pre></td></tr></table></figure>
              </div>
            </details>

<p>ç¬¬ 13 ~ 31 è¡Œï¼ˆç¬¬ 141~159 è¡Œï¼‰ï¼šæ¸…é™¤ BSS æ®µã€‚  </p>
<p>ç¬¬ 39 è¡Œï¼ˆç¬¬ 167 è¡Œï¼‰ï¼šè®¾ç½®å‡½æ•° board_init_r çš„ä¸¤ä¸ªå‚æ•°ï¼Œboard_init_r å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ gdï¼Œå› æ­¤è¯»å– r9 ä¿å­˜åˆ° r0 é‡Œé¢ã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ board_init_r å‡½æ•° </summary>
              <div class='content'>
              <p>å‡½æ•° board_init_r å£°æ˜å¦‚ä¸‹ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">board_init_r(<span class="type">gd_t</span> *id, ulong dest_addr)</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ gdï¼Œå› æ­¤è¯»å– r9 ä¿å­˜åˆ° r0 é‡Œé¢ã€‚</p>
              </div>
            </details>

<p>ç¬¬ 40 è¡Œï¼ˆç¬¬ 168 è¡Œï¼‰ï¼šå‡½æ•° board_init_r çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç›®çš„åœ°å€ï¼Œå› æ­¤ r1&#x3D; gd-&gt;relocaddrã€‚</p>
<p>ç¬¬ 46 è¡Œï¼ˆç¬¬ 174 è¡Œï¼‰ï¼šè°ƒç”¨å‡½æ•° board_init_rï¼Œæ­¤å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;board_r.c ä¸­ï¼Œåè¾¹ä¼šå†è¯¦ç»†åˆ†æè¿™ä¸ªå‡½æ•°ã€‚  </p>
<p>è¿™ä¸ªå°±æ˜¯_main å‡½æ•°çš„è¿è¡Œæµç¨‹ï¼Œåœ¨_main å‡½æ•°é‡Œé¢è°ƒç”¨äº† board_init_fã€ relocate_codeã€relocate_vectors å’Œ board_init_r è¿™ 4 ä¸ªå‡½æ•°ï¼Œ</p>
<h2 id="5-board-init-f-å‡½æ•°"><a href="#5-board-init-f-å‡½æ•°" class="headerlink" title="5.Â board_init_f å‡½æ•°"></a><font size=3>5.Â board_init_f å‡½æ•°</font></h2><h3 id="5-1-board-init-f-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"><a href="#5-1-board-init-f-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="5.1Â board_init_f å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"></a><font size=3>5.1Â board_init_f å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</font></h3><p>ä¸Šè¾¹æˆ‘ä»¬åˆ†æ _main å‡½æ•°çš„æ—¶å€™ï¼Œå®ƒè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œboard_init_f å‡½æ•°ä¸»è¦æœ‰ä¸¤ä¸ªå·¥ä½œ ï¼š</p>
<p>ï¼ˆ1ï¼‰åˆå§‹åŒ–ä¸€ç³»åˆ—å¤–è®¾ï¼Œæ¯”å¦‚ä¸²å£ã€å®šæ—¶å™¨ï¼Œæˆ–è€…æ‰“å°ä¸€äº›æ¶ˆæ¯ç­‰ã€‚</p>
<p>ï¼ˆ2ï¼‰åˆå§‹åŒ– gd çš„å„ä¸ªæˆå‘˜å˜é‡ï¼Œ uboot ä¼šå°†è‡ªå·±é‡å®šä½åˆ° DRAM æœ€åé¢çš„åœ°å€åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯å°†è‡ªå·±æ‹·è´åˆ° DRAM æœ€åé¢çš„å†…å­˜åŒºåŸŸä¸­ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ç»™ Linux è…¾å‡ºç©ºé—´ï¼Œé˜²æ­¢ Linux kernel è¦†ç›–æ‰ ubootï¼Œå°† DRAM å‰é¢çš„åŒºåŸŸå®Œæ•´çš„ç©ºå‡ºæ¥ã€‚åœ¨æ‹·è´ä¹‹å‰è‚¯å®šè¦ç»™ uboot å„éƒ¨åˆ†åˆ†é…å¥½å†…å­˜ä½ç½®å’Œå¤§å°ï¼Œæ¯”å¦‚ gd åº”è¯¥å­˜æ”¾åˆ°å“ªä¸ªä½ç½®ï¼Œ malloc å†…å­˜æ± åº”è¯¥å­˜æ”¾åˆ°å“ªä¸ªä½ç½®ç­‰ç­‰ã€‚è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åœ¨ gd çš„æˆå‘˜å˜é‡ä¸­ï¼Œå› æ­¤è¦å¯¹ gd çš„è¿™äº›æˆå‘˜å˜é‡åšåˆå§‹åŒ–ã€‚æœ€ç»ˆå½¢æˆä¸€ä¸ªå®Œæ•´çš„å†…å­˜â€œåˆ†é…å›¾â€ï¼Œåœ¨åé¢é‡å®šä½ uboot çš„æ—¶å€™å°±ä¼šç”¨åˆ°è¿™ä¸ªå†…å­˜â€œåˆ†é…å›¾â€ã€‚  </p>
<p>è¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨ uboot æºç ä¸­çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">common/board_f.c</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_f</span><span class="params">(ulong boot_flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_GENERIC_GLOBAL_DATA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For some archtectures, global data is initialized and used before</span></span><br><span class="line"><span class="comment">	 * calling this function. The data should be preserved. For others,</span></span><br><span class="line"><span class="comment">	 * CONFIG_SYS_GENERIC_GLOBAL_DATA should be defined and use the stack</span></span><br><span class="line"><span class="comment">	 * here to host global data until relocation.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">gd_t</span> data;</span><br><span class="line"></span><br><span class="line">	gd = &amp;data;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Clear global data before it is accessed at debug print</span></span><br><span class="line"><span class="comment">	 * in initcall_run_list. Otherwise the debug print probably</span></span><br><span class="line"><span class="comment">	 * get the wrong vaule of gd-&gt;have_console.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	zero_global_data();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	gd-&gt;flags = boot_flags;</span><br><span class="line">	gd-&gt;have_console = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (initcall_run_list(init_sequence_f))</span><br><span class="line">		hang();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_SANDBOX) &amp;&amp; \</span></span><br><span class="line"><span class="meta">		!defined(CONFIG_EFI_APP)</span></span><br><span class="line">	<span class="comment">/* NOTREACHED - jump_to_copy() does not return */</span></span><br><span class="line">	hang();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#5-2-åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="5.2 åšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>5.2 åšäº†ä»€ä¹ˆï¼Ÿ</font></h3><p>å‡½æ•°å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_f</span><span class="params">(ulong boot_flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_GENERIC_GLOBAL_DATA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For some archtectures, global data is initialized and used before</span></span><br><span class="line"><span class="comment">	 * calling this function. The data should be preserved. For others,</span></span><br><span class="line"><span class="comment">	 * CONFIG_SYS_GENERIC_GLOBAL_DATA should be defined and use the stack</span></span><br><span class="line"><span class="comment">	 * here to host global data until relocation.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">gd_t</span> data;</span><br><span class="line"></span><br><span class="line">	gd = &amp;data;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Clear global data before it is accessed at debug print</span></span><br><span class="line"><span class="comment">	 * in initcall_run_list. Otherwise the debug print probably</span></span><br><span class="line"><span class="comment">	 * get the wrong vaule of gd-&gt;have_console.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	zero_global_data();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	gd-&gt;flags = boot_flags;</span><br><span class="line">	gd-&gt;have_console = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (initcall_run_list(init_sequence_f))</span><br><span class="line">		hang();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_SANDBOX) &amp;&amp; \</span></span><br><span class="line"><span class="meta">		!defined(CONFIG_EFI_APP)</span></span><br><span class="line">	<span class="comment">/* NOTREACHED - jump_to_copy() does not return */</span></span><br><span class="line">	hang();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæ²¡æœ‰å®šä¹‰ CONFIG_SYS_GENERIC_GLOBAL_DATAï¼Œæ‰€ä»¥ç¬¬ 3 ~ 20 è¡Œï¼ˆç¬¬ 1037 ~ 1054 è¡Œï¼‰ä»£ç æ— æ•ˆã€‚  </p>
<p>ç¬¬ 22 è¡Œï¼ˆç¬¬ 1056 è¡Œï¼‰ï¼šåˆå§‹åŒ– gd-&gt;flags &#x3D; boot_flags &#x3D; 0ã€‚  </p>
<p>ç¬¬ 23 è¡Œï¼ˆç¬¬ 1057 è¡Œï¼‰ï¼šè®¾ç½® gd-&gt;have_console&#x3D;0ã€‚  </p>
<p>ç¬¬ 25 è¡Œï¼ˆç¬¬ 1059 è¡Œï¼‰ï¼šé€šè¿‡å‡½æ•° initcall_run_list æ¥è¿è¡Œåˆå§‹åŒ–åºåˆ— init_sequence_f é‡Œé¢çš„ä¸€äº›åˆ—å‡½æ•°ï¼Œ init_sequence_f é‡Œé¢åŒ…å«äº†ä¸€ç³»åˆ—çš„åˆå§‹åŒ–å‡½æ•°ã€‚è¿™æ‰æ˜¯æœ€é‡è¦çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”±å®ƒå®Œæˆçš„åŠŸèƒ½æˆ‘ä»¬åœ¨ 5.3 è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<h3 id="5-3-init-sequence-f"><a href="#5-3-init-sequence-f" class="headerlink" title="5.3Â init_sequence_f"></a><font size=3>5.3Â init_sequence_f</font></h3><h4 id="5-3-1-æ•°ç»„æˆå‘˜"><a href="#5-3-1-æ•°ç»„æˆå‘˜" class="headerlink" title="5.3.1 æ•°ç»„æˆå‘˜"></a><font size=3>5.3.1 æ•°ç»„æˆå‘˜</font></h4><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ init_sequence_f </summary>
              <div class='content'>
              <p>init_sequence_f ä¹Ÿæ˜¯å®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;board_f.c ä¸­ï¼Œç”±äº init_sequence_f çš„å†…å®¹æ¯”è¾ƒé•¿ï¼Œé‡Œé¢æœ‰å¤§é‡çš„æ¡ä»¶ç¼–è¯‘ä»£ç ï¼Œå°†æ¡ä»¶ç¼–è¯‘éƒ¨åˆ†åˆ é™¤æ‰äº†ï¼Œå»æ‰æ¡ä»¶ç¼–è¯‘ä»¥åçš„ init_sequence_f å®šä¹‰å¦‚ä¸‹ï¼š </p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">init_fnc_t</span> init_sequence_f[] = &#123;</span><br><span class="line">	setup_mon_len,</span><br><span class="line">	initf_malloc,</span><br><span class="line">	initf_console_record,</span><br><span class="line">	arch_cpu_init, <span class="comment">/* basic arch cpu dependent setup */</span></span><br><span class="line">	initf_dm,</span><br><span class="line">	arch_cpu_init_dm,</span><br><span class="line">	mark_bootstage, <span class="comment">/* need timer, go after init dm */</span></span><br><span class="line">	board_early_init_f,</span><br><span class="line">	timer_init, <span class="comment">/* initialize timer */</span></span><br><span class="line">	board_postclk_init,</span><br><span class="line">	get_clocks,</span><br><span class="line">	env_init, <span class="comment">/* initialize environment */</span></span><br><span class="line">	init_baud_rate, <span class="comment">/* initialze baudrate settings */</span></span><br><span class="line">	serial_init, <span class="comment">/* serial communications setup */</span></span><br><span class="line">	console_init_f, <span class="comment">/* stage 1 init of console */</span></span><br><span class="line">	display_options, <span class="comment">/* say that we are here */</span></span><br><span class="line">	display_text_info, <span class="comment">/* show debugging info if required */</span></span><br><span class="line">	print_cpuinfo, <span class="comment">/* display cpu info (and speed) */</span></span><br><span class="line">	show_board_info,</span><br><span class="line">	INIT_FUNC_WATCHDOG_INIT</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	init_func_i2c,</span><br><span class="line">	announce_dram_init,</span><br><span class="line">	<span class="comment">/* <span class="doctag">TODO:</span> unify all these dram functions? */</span></span><br><span class="line">	dram_init, <span class="comment">/* configure available RAM banks */</span></span><br><span class="line">	post_init_f,</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	testdram,</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now that we have DRAM mapped and working, we can</span></span><br><span class="line"><span class="comment">	 * relocate the code and continue running from DRAM.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Reserve memory at end of RAM for (top down in that order):</span></span><br><span class="line"><span class="comment">	 * - area that won&#x27;t get touched by U-Boot and Linux (optional)</span></span><br><span class="line"><span class="comment">	 * - kernel log buffer</span></span><br><span class="line"><span class="comment">	 * - protected RAM</span></span><br><span class="line"><span class="comment">	 * - LCD framebuffer</span></span><br><span class="line"><span class="comment">	 * - monitor code</span></span><br><span class="line"><span class="comment">	 * - board info struct</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	setup_dest_addr,</span><br><span class="line">	reserve_round_4k,</span><br><span class="line">	reserve_mmu,</span><br><span class="line">	reserve_trace,</span><br><span class="line">	reserve_uboot,</span><br><span class="line">	reserve_malloc,</span><br><span class="line">	reserve_board,</span><br><span class="line">	setup_machine,</span><br><span class="line">	reserve_global_data,</span><br><span class="line">	reserve_fdt,</span><br><span class="line">	reserve_arch,</span><br><span class="line">	reserve_stacks,</span><br><span class="line">	setup_dram_config,</span><br><span class="line">	show_dram_config,</span><br><span class="line">	display_new_sp,</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	reloc_fdt,</span><br><span class="line">	setup_reloc,</span><br><span class="line">	<span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
              </div>
            </details>

<h4 id="5-3-2-é‡è¦å‡½æ•°è¯´æ˜"><a href="#5-3-2-é‡è¦å‡½æ•°è¯´æ˜" class="headerlink" title="5.3.2 é‡è¦å‡½æ•°è¯´æ˜"></a><font size=3>5.3.2 é‡è¦å‡½æ•°è¯´æ˜</font></h4><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹é‡è¦å‡½æ•°åŠŸèƒ½åˆ†æ </summary>
              <div class='content'>
              <p>æ¥ä¸‹æ¥åˆ†æä»¥ä¸Šå‡½æ•°æ‰§è¡Œå®Œä»¥åçš„ç»“æœï¼š  </p><p>ç¬¬ 2 è¡Œï¼šsetup_mon_len å‡½æ•°è®¾ç½® gd çš„ mon_len æˆå‘˜å˜é‡ï¼Œæ­¤å¤„ä¸º__bss_end -_startï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªä»£ç çš„é•¿åº¦ã€‚ 0X878A8E74 - 0x87800000 &#x3D; 0XA8E74ï¼Œè¿™ä¸ªå°±æ˜¯ä»£ç é•¿åº¦ã€‚</p><p>ç¬¬ 3 è¡Œï¼š initf_malloc å‡½æ•°åˆå§‹åŒ– gd ä¸­è·Ÿ malloc æœ‰å…³çš„æˆå‘˜å˜é‡ï¼Œæ¯”å¦‚ malloc_limitï¼Œæ­¤å‡½æ•°ä¼šè®¾ç½® gd-&gt;malloc_limit &#x3D; CONFIG_SYS_MALLOC_F_LEN&#x3D;0X400ã€‚ malloc_limit è¡¨ç¤º malloc å†…å­˜æ± å¤§å°ã€‚</p><p>ç¬¬ 4 è¡Œï¼š initf_console_record ï¼Œ å¦‚ æœ å®š ä¹‰ äº† å® CONFIG_CONSOLE_RECORD å’Œ å® CONFIG_SYS_MALLOC_F_LEN çš„è¯æ­¤å‡½æ•°å°±ä¼šè°ƒç”¨å‡½æ•° console_record_initï¼Œä½†æ˜¯ IMX6ULL çš„ uboot æ²¡æœ‰å®šä¹‰å® CONFIG_CONSOLE_RECORDï¼Œæ‰€ä»¥æ­¤å‡½æ•°ç›´æ¥è¿”å› 0ã€‚</p><p>ç¬¬ 5 è¡Œï¼šarch_cpu_init å‡½æ•°ã€‚</p><p>ç¬¬ 6 è¡Œï¼šinitf_dm å‡½æ•°ï¼Œé©±åŠ¨æ¨¡å‹çš„ä¸€äº›åˆå§‹åŒ–ã€‚</p><p>ç¬¬ 7 è¡Œï¼šarch_cpu_init_dm å‡½æ•°æœªå®ç°ã€‚</p><p>ç¬¬ 8 è¡Œï¼šmark_bootstage å‡½æ•°åº”è¯¥æ˜¯å’Œä»€ä¹ˆæ ‡è®°æœ‰å…³çš„ï¼Œå…·ä½“æ²¡æœ‰æ·±ç©¶è¿‡ã€‚</p><p>ç¬¬ 9 è¡Œï¼š board_early_init_f å‡½æ•°ï¼Œæ¿å­ç›¸å…³çš„æ—©æœŸçš„ä¸€äº›åˆå§‹åŒ–è®¾ç½®ï¼Œ I.MX6ULL ç”¨æ¥åˆå§‹åŒ–ä¸²å£çš„ IO é…ç½®ã€‚</p><p>ç¬¬ 10 è¡Œï¼š timer_initï¼Œåˆå§‹åŒ–å®šæ—¶å™¨ï¼Œ Cortex-A7 å†…æ ¸æœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œè¿™é‡Œåˆå§‹åŒ–çš„å°±æ˜¯ CortexA å†…æ ¸çš„é‚£ä¸ªå®šæ—¶å™¨ã€‚é€šè¿‡è¿™ä¸ªå®šæ—¶å™¨æ¥ä¸º uboot æä¾›æ—¶é—´ã€‚å°±è·Ÿ Cortex-M å†…æ ¸ Systick å®šæ—¶å™¨ä¸€æ ·ã€‚å…³äº Cortex-A å†…éƒ¨å®šæ—¶å™¨çš„è¯¦ç»†å†…å®¹ï¼Œè¯·å‚è€ƒæ–‡æ¡£ã€ŠARM ArchitectureReference Manual ARMv7-A and ARMv7-R editionã€‹ çš„ Chapter B8 The Generic Timer ç« èŠ‚ã€‚</p><p>ç¬¬ 11 è¡Œï¼š board_postclk_initï¼Œå¯¹äº I.MX6ULL æ¥è¯´æ˜¯è®¾ç½® VDDSOC ç”µå‹ã€‚</p><p>ç¬¬ 12 è¡Œï¼šget_clocks å‡½æ•°ç”¨äºè·å–ä¸€äº›æ—¶é’Ÿå€¼ï¼Œ I.MX6ULL è·å–çš„æ˜¯ sdhc_clk æ—¶é’Ÿï¼Œä¹Ÿå°±æ˜¯ SD å¡å¤–è®¾çš„æ—¶é’Ÿã€‚</p><p>ç¬¬ 13 è¡Œï¼šenv_init å‡½æ•°æ˜¯å’Œç¯å¢ƒå˜é‡æœ‰å…³çš„ï¼Œè®¾ç½® gd çš„æˆå‘˜å˜é‡ env_addrï¼Œä¹Ÿå°±æ˜¯ç¯å¢ƒå˜é‡çš„ä¿å­˜åœ°å€ã€‚</p><p>ç¬¬ 14 è¡Œï¼šinit_baud_rate å‡½æ•°ç”¨äºåˆå§‹åŒ–æ³¢ç‰¹ç‡ï¼Œæ ¹æ®ç¯å¢ƒå˜é‡ baudrate æ¥åˆå§‹åŒ– gd-&gt;baudrateã€‚</p><p>ç¬¬ 15 è¡Œï¼šserial_initï¼Œåˆå§‹åŒ–ä¸²å£ã€‚</p><p>ç¬¬ 16 è¡Œï¼šconsole_init_fï¼Œè®¾ç½® gd-&gt;have_console ä¸º 1ï¼Œè¡¨ç¤ºæœ‰ä¸ªæ§åˆ¶å°ï¼Œæ­¤å‡½æ•°ä¹Ÿå°†å‰é¢æš‚å­˜åœ¨ç¼“å†²åŒºä¸­çš„æ•°æ®é€šè¿‡æ§åˆ¶å°æ‰“å°å‡ºæ¥ã€‚  </p><p>ç¬¬ 17 è¡Œï¼š display_optionsï¼Œé€šè¿‡ä¸²å£è¾“å‡ºä¸€äº›ä¿¡æ¯ ï¼Œå¦‚ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015165952642.png" alt="image-20221015165952642" style="zoom:50%;" /><p>ç¬¬ 18 è¡Œï¼š display_text_infoï¼Œæ‰“å°ä¸€äº›æ–‡æœ¬ä¿¡æ¯ï¼Œå¦‚æœå¼€å¯ UBOOT çš„ DEBUG åŠŸèƒ½çš„è¯å°±ä¼šè¾“å‡º text_baseã€ bss_startã€ bss_endï¼Œå½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug(<span class="string">&quot;U-Boot code: %08lX -&gt; %08lX BSS: -&gt; %08lX\n&quot;</span>,text_base, bss_start, bss_end);</span><br></pre></td></tr></table></figure><p>ç¬¬ 19 è¡Œï¼š print_cpuinfo å‡½æ•°ç”¨äºæ‰“å° CPU ä¿¡æ¯ï¼Œå¦‚ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015170028569.png" alt="image-20221015170028569" style="zoom:50%;" /><p>ç¬¬ 20 è¡Œï¼š show_board_info å‡½æ•°ç”¨äºæ‰“å°æ¿å­ä¿¡æ¯ï¼Œä¼šè°ƒç”¨ checkboard å‡½æ•°ï¼Œå¦‚ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015170057791.png" alt="image-20221015170057791" style="zoom:50%;" /><p>ç¬¬ 21 è¡Œï¼šINIT_FUNC_WATCHDOG_INITï¼Œåˆå§‹åŒ–çœ‹é—¨ç‹—ï¼Œå¯¹äº I.MX6ULL æ¥è¯´æ˜¯ç©ºå‡½æ•°ã€‚</p><p>ç¬¬ 22 è¡Œï¼šINIT_FUNC_WATCHDOG_RESETï¼Œå¤ä½çœ‹é—¨ç‹—ï¼Œå¯¹äº I.MX6ULL æ¥è¯´æ˜¯ç©ºå‡½æ•°ã€‚</p><p>ç¬¬ 23 è¡Œï¼šinit_func_i2c å‡½æ•°ç”¨äºåˆå§‹åŒ– I2Cï¼Œåˆå§‹åŒ–å®Œæˆä»¥åä¼šè¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼š  </p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015170124394.png" alt="image-20221015170124394" style="zoom:50%;" /><p>ç¬¬ 24 è¡Œï¼šannounce_dram_initï¼Œè¿™ä¸ªå‡½æ•°å¾ˆç®€å•ï¼Œå°±æ˜¯è¾“å‡ºå­—ç¬¦ä¸²â€œDRAM:â€</p><p>ç¬¬ 26 è¡Œï¼šdram_initï¼Œå¹¶éçœŸæ­£çš„åˆå§‹åŒ– DDRï¼Œåªæ˜¯è®¾ç½® gd-&gt;ram_size çš„å€¼ï¼Œå¯¹äºæ­£ç‚¹åŸå­ I.MX6ULL å¼€å‘æ¿ EMMC ç‰ˆæœ¬æ ¸å¿ƒæ¿æ¥è¯´å°±æ˜¯ 512MBã€‚</p><p>ç¬¬ 27 è¡Œï¼š post_init_fï¼Œæ­¤å‡½æ•°ç”¨æ¥å®Œæˆä¸€äº›æµ‹è¯•ï¼Œåˆå§‹åŒ– gd-&gt;post_init_f_timeã€‚</p><p>ç¬¬ 29 è¡Œï¼štestdramï¼Œæµ‹è¯• DRAMï¼Œç©ºå‡½æ•°ã€‚  </p><p>ç¬¬ 44 è¡Œï¼šsetup_dest_addr å‡½æ•°ï¼Œè®¾ç½®ç›®çš„åœ°å€ï¼Œè®¾ç½® gd-&gt;ram_sizeï¼Œ gd-&gt;ram_topï¼Œ gd-&gt;relocaddr è¿™ä¸‰ä¸ªçš„å€¼ã€‚</p><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ è¿™ä¸‰ä¸ªå€¼çš„æ‰“å°æ–¹æ³• </summary>              <div class='content'>              <p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šé‡åˆ°å¾ˆå¤šè·Ÿæ•°å€¼æœ‰å…³çš„è®¾ç½®ï¼Œå¦‚æœç›´æ¥çœ‹ä»£ç åˆ†æçš„è¯å°±å¤ªè´¹æ—¶é—´äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ uboot ä»£ç ï¼Œç›´æ¥å°†è¿™äº›å€¼é€šè¿‡ä¸²å£æ‰“å°å‡ºæ¥ï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹æ–‡ä»¶ common&#x2F;board_f.cï¼Œå› ä¸º setup_dest_addr å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;board_f.c ä¸­ï¼Œåœ¨setup_dest_addrå‡½æ•°è¾“å…¥å¦‚ä¸‹å›¾å†…å®¹ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015170554062.png" alt="image-20221015170554062" style="zoom:50%;" /><p>è®¾ç½®å¥½ä»¥åé‡æ–°ç¼–è¯‘ ubootï¼Œç„¶åçƒ§å†™åˆ° SD å¡ä¸­ï¼Œé€‰æ‹© SD å¡å¯åŠ¨ï¼Œé‡å¯å¼€å‘æ¿ï¼Œæˆ‘ä»¬å°±ä¼šå¾—åˆ°ä»¥ä¸‹è¾“å‡ºä¿¡æ¯ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015171129255.png" alt="image-20221015171129255" style="zoom: 50%;" /><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gd-&gt;ram_size = <span class="number">0X20000000</span>  <span class="comment">//ram å¤§å°ä¸º 0X20000000=512MB</span></span><br><span class="line">gd-&gt;ram_top = <span class="number">0XA0000000</span>   <span class="comment">//ram æœ€é«˜åœ°å€ä¸º 0X80000000+0X20000000=0XA0000000</span></span><br><span class="line">gd-&gt;relocaddr = <span class="number">0XA0000000</span> <span class="comment">//é‡å®šä½åæœ€é«˜åœ°å€ä¸º 0XA0000000</span></span><br></pre></td></tr></table></figure>              </div>            </details> <p>ç¬¬ 45 è¡Œ ï¼šreserve_round_4k å‡½ æ•° ç”¨ äº å¯¹ gd-&gt;relocaddr åš 4KB å¯¹ é½ ï¼Œ å›  ä¸º gd-&gt;relocaddr&#x3D;0XA0000000ï¼Œå·²ç»æ˜¯ 4K å¯¹é½äº†ï¼Œæ‰€ä»¥è°ƒæ•´åä¸å˜ã€‚</p><p>ç¬¬ 46 è¡Œï¼šreserve_mmuï¼Œç•™å‡º MMU çš„ TLB è¡¨çš„ä½ç½®ï¼Œåˆ†é… MMU çš„ TLB è¡¨å†…å­˜ä»¥åä¼šå¯¹ gd-&gt;relocaddr åš 64K å­—èŠ‚å¯¹é½ã€‚å¯¹é½ä¹‹åæœ‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gd-&gt;arch.tlb_size= <span class="number">0X4000</span>    <span class="comment">//MMU çš„ TLB è¡¨å¤§å°</span></span><br><span class="line">gd-&gt;arch.tlb_addr=<span class="number">0X9FFF0000</span> <span class="comment">//MMU çš„ TLB è¡¨èµ·å§‹åœ°å€ï¼Œ 64KB å¯¹é½ä»¥å</span></span><br><span class="line">gd-&gt;relocaddr=<span class="number">0X9FFF0000</span>     <span class="comment">//relocaddr åœ°å€</span></span><br></pre></td></tr></table></figure><p>ç¬¬ 47 è¡Œï¼šreserve_trace å‡½æ•°ï¼Œç•™å‡ºè·Ÿè¸ªè°ƒè¯•çš„å†…å­˜ï¼Œ I.MX6ULL æ²¡æœ‰ç”¨åˆ°ã€‚</p><p>ç¬¬ 48 è¡Œï¼š reserve_ubootï¼Œ ç•™å‡ºé‡å®šä½åçš„ uboot æ‰€å ç”¨çš„å†…å­˜åŒºåŸŸï¼Œ uboot æ‰€å ç”¨å¤§å°ç”± gd-&gt;mon_len æ‰€æŒ‡å®šï¼Œç•™å‡º uboot çš„ç©ºé—´ä»¥åè¿˜è¦å¯¹ gd-&gt;relocaddr åš 4K å­—èŠ‚å¯¹é½ï¼Œå¹¶ä¸”é‡æ–°è®¾ç½® gd-&gt;start_addr_sp ã€‚å®Œæˆä¹‹åå—ï¼Œç›¸å…³çš„å˜é‡å€¼ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gd-&gt;mon_len = <span class="number">0XA8EF4</span></span><br><span class="line">gd-&gt;start_addr_sp = <span class="number">0X9FF47000</span></span><br><span class="line">gd-&gt;relocaddr = <span class="number">0X9FF47000</span></span><br></pre></td></tr></table></figure><p>ç¬¬ 49 è¡Œï¼šreserve_mallocï¼Œç•™å‡º malloc åŒºåŸŸï¼Œè°ƒæ•´ gd-&gt;start_addr_sp ä½ç½®ï¼Œ malloc åŒºåŸŸç”±å®TOTAL_MALLOC_LEN å®šä¹‰ã€‚è°ƒæ•´ä¹‹åï¼Œç›¸å…³å˜é‡çš„å€¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TOTAL_MALLOC_LEN=<span class="number">0X1002000</span></span><br><span class="line">gd-&gt;start_addr_sp=<span class="number">0X9EF45000</span> <span class="comment">//0X9FF47000-16MB-8KB=0X9EF45000</span></span><br></pre></td></tr></table></figure><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ TOTAL_MALLOC_LEN </summary>              <div class='content'>              <p>è¿™ä¸ªå®ï¼Œå®šä¹‰åœ¨ include&#x2F;common.h ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>	TOTAL_MALLOC_LEN	(CONFIG_SYS_MALLOC_LEN + CONFIG_ENV_SIZE)</span></span><br></pre></td></tr></table></figure><p>åœ¨ include&#x2F;configs&#x2F;mx6ull_alientek_emmc.h æ–‡ä»¶ä¸­å®šä¹‰å® CONFIG_SYS_MALLOC_LEN å’Œ CONFIG_ENV_SIZEï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_ENV_SIZE			SZ_8K</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Size of malloc() pool */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_MALLOC_LEN		(16 * SZ_1M) <span class="comment">/* malloc å†…å­˜æ± å¤§å°ï¼Œè¿™é‡Œè®¾ç½®ä¸º 16MB */</span></span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å® CONFIG_SYS_MALLOC_LEN ä¸º 16MB &#x3D; 0X1000000ï¼Œå® CONFIG_ENV_SIZE &#x3D; 8KB &#x3D; 0X2000ï¼Œå› æ­¤TOTAL_MALLOC_LEN &#x3D; 0X1002000ã€‚  </p>              </div>            </details><p>ç¬¬ 50 è¡Œï¼šreserve_board å‡½æ•°ï¼Œç•™å‡ºæ¿å­ bd æ‰€å çš„å†…å­˜åŒºï¼Œ bd æ˜¯ç»“æ„ä½“ bd_tï¼Œ bd_t å¤§å°ä¸º 80 å­—èŠ‚ ã€‚æ­¤æ—¶ç›¸å…³å˜é‡çš„å€¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gd-&gt;start_addr_sp=<span class="number">0X9EF44FB0</span></span><br><span class="line">gd-&gt;bd=<span class="number">0X9EF44FB0</span></span><br></pre></td></tr></table></figure><p>ç¬¬ 51 è¡Œï¼š setup_machineï¼Œè®¾ç½®æœºå™¨ IDï¼Œ linux å¯åŠ¨çš„æ—¶å€™ä¼šå’Œè¿™ä¸ªæœºå™¨ ID åŒ¹é…ï¼Œå¦‚æœåŒ¹é…çš„è¯ linux å°±ä¼šå¯åŠ¨æ­£å¸¸ã€‚ä½†æ˜¯ I.MX6ULL ä¸ç”¨è¿™ç§æ–¹å¼äº†ï¼Œè¿™æ˜¯ä»¥å‰è€ç‰ˆæœ¬çš„ uboot å’Œ linux ä½¿ç”¨çš„ï¼Œæ–°ç‰ˆæœ¬ä½¿ç”¨è®¾å¤‡æ ‘äº†ï¼Œå› æ­¤æ­¤å‡½æ•°æ— æ•ˆã€‚</p><p>ç¬¬ 52 è¡Œï¼šreserve_global_data å‡½æ•°ï¼Œä¿ç•™å‡º gd_t çš„å†…å­˜åŒºåŸŸï¼Œ gd_t ç»“æ„ä½“å¤§å°ä¸º 248Bã€‚ç›¸å…³å˜é‡çš„å€¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gd-&gt;start_addr_sp=<span class="number">0X9EF44EB8</span> <span class="comment">//0X9EF44FB0-248=0X9EF44EB8</span></span><br><span class="line">gd-&gt;new_gd=<span class="number">0X9EF44EB8</span></span><br></pre></td></tr></table></figure><p>ç¬¬ 53 è¡Œï¼šreserve_fdtï¼Œç•™å‡ºè®¾å¤‡æ ‘ç›¸å…³çš„å†…å­˜åŒºåŸŸï¼Œ I.MX6ULL çš„ uboot æ²¡æœ‰ç”¨åˆ°ï¼Œå› æ­¤æ­¤å‡½æ•°æ— æ•ˆã€‚</p><p>ç¬¬ 54 è¡Œï¼šreserve_arch æ˜¯ä¸ªç©ºå‡½æ•°ã€‚</p><p>ç¬¬ 55 è¡Œï¼š reserve_stacksï¼Œç•™å‡ºæ ˆç©ºé—´ï¼Œå…ˆå¯¹ gd-&gt;start_addr_sp å‡å» 16ï¼Œç„¶ååš 16 å­—èŠ‚å¯¹é½ã€‚å¦‚æœä½¿èƒ½ IRQ çš„è¯è¿˜è¦ç•™å‡º IRQ ç›¸åº”çš„å†…å­˜ï¼Œå…·ä½“å·¥ä½œæ˜¯ç”± arch&#x2F;arm&#x2F;lib&#x2F;stack.c æ–‡ä»¶ä¸­çš„å‡½æ•° arch_reserve_stacks å®Œæˆã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨çš„è¿™ä¸ª uboot ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨åˆ° IRQï¼Œæ‰€ä»¥ä¸ä¼šç•™å‡º IRQ ç›¸åº”çš„å†…å­˜åŒºåŸŸï¼Œæ­¤æ—¶gd-&gt;start_addr_sp çš„å€¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gd-&gt;start_addr_sp=<span class="number">0X9EF44E90</span></span><br></pre></td></tr></table></figure><p>ç¬¬ 56 è¡Œï¼š setup_dram_config å‡½æ•°è®¾ç½® dram ä¿¡æ¯ï¼Œå°±æ˜¯è®¾ç½® gd-&gt;bd-&gt;bi_dram[0].start å’Œ gd-&gt;bd-&gt;bi_dram[0].sizeï¼Œåé¢ä¼šä¼ é€’ç»™ linux å†…æ ¸ï¼Œå‘Šè¯‰ linux DRAM çš„èµ·å§‹åœ°å€å’Œå¤§å°ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¯¥å‡½æ•°ä¸­æ‰“å°ä¸€ä¸‹è¿™å‡ ä¸ªå˜é‡ï¼Œç»“æœåº”è¯¥æ˜¯ä¸‹è¾¹è¿™æ ·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gd-&gt;bd-&gt;bi_dram[<span class="number">0</span>].start = <span class="number">0x80000000</span></span><br><span class="line">gd-&gt;bd-&gt;bi_dram[<span class="number">0</span>].size = <span class="number">0x20000000</span></span><br></pre></td></tr></table></figure><p>ç¬¬ 57 è¡Œï¼Œ show_dram_config å‡½æ•°ï¼Œç”¨äºæ˜¾ç¤º DRAM çš„é…ç½® ï¼Œå¦‚ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015203536954.png" alt="image-20221015203536954" style="zoom:50%;" /><p>ç¬¬ 58 è¡Œï¼šdisplay_new_sp å‡½æ•°ï¼Œæ˜¾ç¤ºæ–°çš„ sp ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ gd-&gt;start_addr_spï¼Œä¸è¿‡è¦å®šä¹‰å® DEBUG ã€‚</p><p>ç¬¬ 60 è¡Œï¼šreloc_fdt å‡½æ•°ç”¨äºé‡å®šä½ fdtï¼Œæ²¡æœ‰ç”¨åˆ°ã€‚</p><p>ç¬¬ 61 è¡Œï¼š setup_relocï¼Œè®¾ç½® gd çš„å…¶ä»–ä¸€äº›æˆå‘˜å˜é‡ï¼Œä¾›åé¢é‡å®šä½çš„æ—¶å€™ä½¿ç”¨ï¼Œå¹¶ä¸”å°†ä»¥å‰çš„ gd æ‹·è´åˆ° gd-&gt;new_gd å¤„ã€‚éœ€è¦ä½¿èƒ½ DEBUG æ‰èƒ½çœ‹åˆ°ç›¸åº”çš„ä¿¡æ¯è¾“å‡º ã€‚è¿™é‡Œæˆ‘ä»¬è¦æ˜¯æ‰“å°è¿™äº›ä¿¡æ¯çš„è¯ï¼Œä¼šå‘ç°uboot é‡å®šä½åçš„åç§»ä¸º 0X18747000ï¼Œé‡å®šä½åçš„æ–°åœ°å€ä¸º0X9FF4700ï¼Œæ–°çš„ gd é¦–åœ°å€ä¸º 0X9EF44EB8ï¼Œæœ€ç»ˆçš„ sp ä¸º 0X9EF44E90ã€‚  </p>
              </div>
            </details>  

<h4 id="5-3-3-æœ€ç»ˆå†…å­˜åˆ†é…"><a href="#5-3-3-æœ€ç»ˆå†…å­˜åˆ†é…" class="headerlink" title="5.3.3 æœ€ç»ˆå†…å­˜åˆ†é…"></a><font size=3>5.3.3 æœ€ç»ˆå†…å­˜åˆ†é…</font></h4><p>ç»è¿‡ä¸Šè¾¹çš„ä¸€ç³»åˆ—å‡½æ•°çš„æ‰§è¡Œï¼Œæœ€ç»ˆçš„å†…å­˜åˆ†é…å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221015210430581.png" alt="image-20221015210430581" style="zoom:50%;" />

<h2 id="6-relocate-code-å‡½æ•°"><a href="#6-relocate-code-å‡½æ•°" class="headerlink" title="6.Â relocate_code å‡½æ•°"></a><font size=3>6.Â relocate_code å‡½æ•°</font></h2><h3 id="6-1-relocate-code-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"><a href="#6-1-relocate-code-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="6.1Â relocate_code å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"></a><font size=3>6.1Â relocate_code å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</font></h3><p>ä¸Šè¾¹æˆ‘ä»¬åˆ†æ _main å‡½æ•°çš„æ—¶å€™ï¼Œå®ƒè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œ<strong>relocate_code å‡½æ•°æ˜¯ç”¨äºä»£ç æ‹·è´çš„</strong>ï¼Œå®ƒå®šä¹‰åœ¨ uboot æºç ä¸­çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/lib/relocate.S</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * void relocate_code(addr_moni)</span><br><span class="line"> *</span><br><span class="line"> * This function relocates the monitor code.</span><br><span class="line"> *</span><br><span class="line"> * NOTE:</span><br><span class="line"> * To prevent the code below from containing references with an R_ARM_ABS32</span><br><span class="line"> * relocation record type, we never refer to linker-defined symbols directly.</span><br><span class="line"> * Instead, we declare literals which contain their relative location with</span><br><span class="line"> * respect to relocate_code, and at run time, add relocate_code back to them.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">ENTRY(relocate_code)</span><br><span class="line">	ldr	r1, =__image_copy_start	/* r1 &lt;- SRC &amp;__image_copy_start */</span><br><span class="line">	subs	r4, r0, r1		/* r4 &lt;- relocation offset */</span><br><span class="line">	beq	relocate_done		/* skip relocation */</span><br><span class="line">	ldr	r2, =__image_copy_end	/* r2 &lt;- SRC &amp;__image_copy_end */</span><br><span class="line"></span><br><span class="line">copy_loop:</span><br><span class="line">	ldmia	r1!, &#123;r10-r11&#125;		/* copy from source address [r1]    */</span><br><span class="line">	stmia	r0!, &#123;r10-r11&#125;		/* copy to   target address [r0]    */</span><br><span class="line">	cmp	r1, r2			/* until source end address [r2]    */</span><br><span class="line">	blo	copy_loop</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * fix .rel.dyn relocations</span><br><span class="line">	 */</span><br><span class="line">	ldr	r2, =__rel_dyn_start	/* r2 &lt;- SRC &amp;__rel_dyn_start */</span><br><span class="line">	ldr	r3, =__rel_dyn_end	/* r3 &lt;- SRC &amp;__rel_dyn_end */</span><br><span class="line">fixloop:</span><br><span class="line">	ldmia	r2!, &#123;r0-r1&#125;		/* (r0,r1) &lt;- (SRC location,fixup) */</span><br><span class="line">	and	r1, r1, #0xff</span><br><span class="line">	cmp	r1, #23			/* relative fixup? */</span><br><span class="line">	bne	fixnext</span><br><span class="line"></span><br><span class="line">	/* relative fix: increase location by offset */</span><br><span class="line">	add	r0, r0, r4</span><br><span class="line">	ldr	r1, [r0]</span><br><span class="line">	add	r1, r1, r4</span><br><span class="line">	str	r1, [r0]</span><br><span class="line">fixnext:</span><br><span class="line">	cmp	r2, r3</span><br><span class="line">	blo	fixloop</span><br><span class="line"></span><br><span class="line">relocate_done:</span><br><span class="line"></span><br><span class="line">#ifdef __XSCALE__</span><br><span class="line">	/*</span><br><span class="line">	 * On xscale, icache must be invalidated and write buffers drained,</span><br><span class="line">	 * even with cache disabled - 4.2.7 of xscale core developer&#x27;s manual</span><br><span class="line">	 */</span><br><span class="line">	mcr	p15, 0, r0, c7, c7, 0	/* invalidate icache */</span><br><span class="line">	mcr	p15, 0, r0, c7, c10, 4	/* drain write buffer */</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	/* ARMv4- don&#x27;t know bx lr but the assembler fails to see that */</span><br><span class="line"></span><br><span class="line">#ifdef __ARM_ARCH_4__</span><br><span class="line">	mov	pc, lr</span><br><span class="line">#else</span><br><span class="line">	bx	lr</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_code)</span><br></pre></td></tr></table></figure>

<h3 id="6-2-åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#6-2-åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="6.2 åšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>6.2 åšäº†ä»€ä¹ˆï¼Ÿ</font></h3><p>æˆ‘ä»¬çš„åˆ†ææŒ‰ä¸‹è¾¹çš„è¡Œå·è¿›è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(relocate_code)</span><br><span class="line">	ldr	r1, =__image_copy_start	/* r1 &lt;- SRC &amp;__image_copy_start */</span><br><span class="line">	subs	r4, r0, r1		/* r4 &lt;- relocation offset */</span><br><span class="line">	beq	relocate_done		/* skip relocation */</span><br><span class="line">	ldr	r2, =__image_copy_end	/* r2 &lt;- SRC &amp;__image_copy_end */</span><br><span class="line"></span><br><span class="line">copy_loop:</span><br><span class="line">	ldmia	r1!, &#123;r10-r11&#125;		/* copy from source address [r1]    */</span><br><span class="line">	stmia	r0!, &#123;r10-r11&#125;		/* copy to   target address [r0]    */</span><br><span class="line">	cmp	r1, r2			/* until source end address [r2]    */</span><br><span class="line">	blo	copy_loop</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * fix .rel.dyn relocations</span><br><span class="line">	 */</span><br><span class="line">	ldr	r2, =__rel_dyn_start	/* r2 &lt;- SRC &amp;__rel_dyn_start */</span><br><span class="line">	ldr	r3, =__rel_dyn_end	/* r3 &lt;- SRC &amp;__rel_dyn_end */</span><br><span class="line">fixloop:</span><br><span class="line">	ldmia	r2!, &#123;r0-r1&#125;		/* (r0,r1) &lt;- (SRC location,fixup) */</span><br><span class="line">	and	r1, r1, #0xff</span><br><span class="line">	cmp	r1, #23			/* relative fixup? */</span><br><span class="line">	bne	fixnext</span><br><span class="line"></span><br><span class="line">	/* relative fix: increase location by offset */</span><br><span class="line">	add	r0, r0, r4</span><br><span class="line">	ldr	r1, [r0]</span><br><span class="line">	add	r1, r1, r4</span><br><span class="line">	str	r1, [r0]</span><br><span class="line">fixnext:</span><br><span class="line">	cmp	r2, r3</span><br><span class="line">	blo	fixloop</span><br><span class="line"></span><br><span class="line">relocate_done:</span><br><span class="line"></span><br><span class="line">#ifdef __XSCALE__</span><br><span class="line">	/*</span><br><span class="line">	 * On xscale, icache must be invalidated and write buffers drained,</span><br><span class="line">	 * even with cache disabled - 4.2.7 of xscale core developer&#x27;s manual</span><br><span class="line">	 */</span><br><span class="line">	mcr	p15, 0, r0, c7, c7, 0	/* invalidate icache */</span><br><span class="line">	mcr	p15, 0, r0, c7, c10, 4	/* drain write buffer */</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	/* ARMv4- don&#x27;t know bx lr but the assembler fails to see that */</span><br><span class="line"></span><br><span class="line">#ifdef __ARM_ARCH_4__</span><br><span class="line">	mov	pc, lr</span><br><span class="line">#else</span><br><span class="line">	bx	lr</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_code)</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 2 è¡Œï¼ˆç¬¬ 80 è¡Œï¼‰ï¼šr1&#x3D;__image_copy_startï¼Œä¹Ÿå°±æ˜¯ r1 å¯„å­˜å™¨ä¿å­˜æºåœ°å€ï¼Œä»ç¬¬ä¸€èŠ‚ä¸­çš„è¡¨ä¸€-3-1å¯çŸ¥ __image_copy_start &#x3D; 0X87800000ã€‚  </p>
<p>ç¬¬ 3 è¡Œï¼ˆç¬¬ 81 è¡Œï¼‰ï¼šr0&#x3D;0X9FF47000ï¼Œè¿™ä¸ªåœ°å€å°±æ˜¯ uboot æ‹·è´çš„ç›®æ ‡é¦–åœ°å€ã€‚ r4 &#x3D; r0-r1 &#x3D; 0X9FF47000 - 0X87800000 &#x3D; 0X18747000ï¼Œå› æ­¤ r4 ä¿å­˜åç§»é‡ã€‚  </p>
<p>ç¬¬ 4 è¡Œï¼ˆç¬¬ 82 è¡Œï¼‰ï¼šå¦‚æœåœ¨ç¬¬ 3 è¡Œï¼ˆç¬¬ 81 è¡Œï¼‰ä¸­ï¼Œ r0-r1 ç­‰äº 0ï¼Œè¯´æ˜ r0 å’Œ r1 ç›¸ç­‰ï¼Œä¹Ÿå°±æ˜¯æºåœ°å€å’Œç›®çš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œé‚£è‚¯å®šå°±ä¸éœ€è¦æ‹·è´äº†ï¼Œç›´æ¥æ‰§è¡Œ relocate_done å‡½æ•°ã€‚  </p>
<p>ç¬¬ 5 è¡Œï¼ˆç¬¬ 83 è¡Œï¼‰ï¼šr2&#x3D;__image_copy_endï¼Œ r2 ä¸­ä¿å­˜æ‹·è´ä¹‹å‰çš„ä»£ç ç»“æŸåœ°å€ï¼Œç”±è¡¨ä¸€-3-1å¯çŸ¥ï¼Œ__image_copy_end  &#x3D; 0x8785dd54ã€‚</p>
<p>ç¬¬ 6 è¡Œï¼ˆç¬¬ 84 è¡Œï¼‰ï¼šå‡½æ•° copy_loop å®Œæˆä»£ç æ‹·è´å·¥ä½œï¼ä» r1ï¼Œä¹Ÿå°±æ˜¯__image_copy_start å¼€å§‹ï¼Œè¯»å– uboot ä»£ç ä¿å­˜åˆ° r10 å’Œ r11 ä¸­ï¼Œä¸€æ¬¡å°±åªæ‹·è´è¿™ 2 ä¸ª 32 ä½çš„æ•°æ®ã€‚æ‹·è´å®Œæˆä»¥å r1 çš„å€¼ä¼šæ›´æ–°ï¼Œä¿å­˜ä¸‹ä¸€ä¸ªè¦æ‹·è´çš„æ•°æ®åœ°å€ã€‚</p>
<p>ç¬¬ 9 è¡Œï¼ˆç¬¬ 87 è¡Œï¼‰ï¼šå°† r10 å’Œ r11 çš„æ•°æ®å†™åˆ° r0 å¼€å§‹çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯ç›®çš„åœ°å€ã€‚å†™å®Œä»¥å r0 çš„å€¼ä¼šæ›´æ–°ï¼Œæ›´æ–°ä¸ºä¸‹ä¸€ä¸ªè¦å†™å…¥çš„æ•°æ®åœ°å€ã€‚  </p>
<p>ç¬¬ 10 è¡Œï¼ˆç¬¬ 88 è¡Œï¼‰ï¼šæ¯”è¾ƒ r1 æ˜¯å¦å’Œ r2 ç›¸ç­‰ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥æ˜¯å¦æ‹·è´å®Œæˆï¼Œå¦‚æœä¸ç›¸ç­‰çš„è¯è¯´æ˜æ²¡æœ‰æ‹·è´å®Œæˆï¼Œ æ²¡æœ‰æ‹·è´å®Œæˆçš„è¯å°±è·³è½¬åˆ° copy_loop æ¥ç€æ‹·è´ï¼Œç›´è‡³æ‹·è´å®Œæˆã€‚  </p>
<p>ç¬¬ 16 ~ 31 è¡Œï¼ˆç¬¬ 94 ~ 109 è¡Œï¼‰ï¼šæ˜¯é‡å®šä½ .rel.dyn æ®µï¼Œ .rel.dyn æ®µæ˜¯å­˜æ”¾ .text æ®µä¸­éœ€è¦é‡å®šä½åœ°å€çš„é›†åˆã€‚é‡å®šä½å°±æ˜¯ uboot å°†è‡ªèº«æ‹·è´åˆ° DRAM çš„å¦ä¸€ä¸ªåœ°æ–¹å»ç»§ç»­è¿è¡Œï¼ˆDRAM çš„é«˜åœ°å€å¤„ï¼‰ã€‚  æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªå¯æ‰§è¡Œçš„ bin æ–‡ä»¶ï¼Œå…¶é“¾æ¥åœ°å€å’Œè¿è¡Œåœ°å€è¦ç›¸ç­‰ï¼Œä¹Ÿå°±æ˜¯é“¾æ¥åˆ°å“ªä¸ªåœ°å€ï¼Œåœ¨è¿è¡Œä¹‹å‰å°±è¦æ‹·è´åˆ°å“ªä¸ªåœ°å€å»ã€‚ç°åœ¨æˆ‘ä»¬é‡å®šä½ä»¥åï¼Œè¿è¡Œåœ°å€å°±å’Œé“¾æ¥åœ°å€ä¸åŒäº†ï¼Œè¿™æ ·å¯»å€çš„æ—¶å€™ä¸ä¼šå‡ºé—®é¢˜å—ï¼Ÿè¿™ä¸ªé—®é¢˜è¿™é‡Œæˆ‘å°±æ²¡æœ‰ç»§ç»­æ·±å…¥è¿½ç©¶äº†ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥çœ‹æ­£ç‚¹åŸå­çš„é©±åŠ¨å¼€å‘æ‰‹å†Œï¼Œé‡Œè¾¹æœ‰å¾ˆè¯¦ç»†çš„è¯´æ˜ã€‚</p>
<h2 id="7-relocate-vectorså‡½æ•°"><a href="#7-relocate-vectorså‡½æ•°" class="headerlink" title="7.Â relocate_vectorså‡½æ•°"></a><font size=3>7.Â relocate_vectorså‡½æ•°</font></h2><h3 id="7-1-relocate-vectors-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"><a href="#7-1-relocate-vectors-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="7.1Â relocate_vectors å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"></a><font size=3>7.1Â relocate_vectors å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</font></h3><p>ä¸Šè¾¹æˆ‘ä»¬åˆ†æ _main å‡½æ•°çš„æ—¶å€™ï¼Œå®ƒè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œ<strong>relocate_vectors å‡½æ•°ç”¨äºé‡å®šä½å‘é‡è¡¨</strong>ï¼Œå®ƒå®šä¹‰åœ¨ uboot æºç ä¸­çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/lib/relocate.S</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(relocate_vectors)</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_CPU_V7M</span><br><span class="line">	/*</span><br><span class="line">	 * On ARMv7-M we only have to write the new vector address</span><br><span class="line">	 * to VTOR register.</span><br><span class="line">	 */</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]	/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	ldr	r1, =V7M_SCB_BASE</span><br><span class="line">	str	r0, [r1, V7M_SCB_VTOR]</span><br><span class="line">#else</span><br><span class="line">#ifdef CONFIG_HAS_VBAR</span><br><span class="line">	/*</span><br><span class="line">	 * If the ARM processor has the security extensions,</span><br><span class="line">	 * use VBAR to relocate the exception vectors.</span><br><span class="line">	 */</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]	/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	mcr     p15, 0, r0, c12, c0, 0  /* Set VBAR */</span><br><span class="line">#else</span><br><span class="line">	/*</span><br><span class="line">	 * Copy the relocated exception vectors to the</span><br><span class="line">	 * correct address</span><br><span class="line">	 * CP15 c1 V bit gives us the location of the vectors:</span><br><span class="line">	 * 0x00000000 or 0xFFFF0000.</span><br><span class="line">	 */</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]	/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	mrc	p15, 0, r2, c1, c0, 0	/* V bit (bit[13]) in CP15 c1 */</span><br><span class="line">	ands	r2, r2, #(1 &lt;&lt; 13)</span><br><span class="line">	ldreq	r1, =0x00000000		/* If V=0 */</span><br><span class="line">	ldrne	r1, =0xFFFF0000		/* If V=1 */</span><br><span class="line">	ldmia	r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">	stmia	r1!, &#123;r2-r8,r10&#125;</span><br><span class="line">	ldmia	r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">	stmia	r1!, &#123;r2-r8,r10&#125;</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line">	bx	lr</span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_vectors)</span><br></pre></td></tr></table></figure>

<h3 id="7-2-åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#7-2-åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="7.2 åšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>7.2 åšäº†ä»€ä¹ˆï¼Ÿ</font></h3><p>æˆ‘ä»¬çš„åˆ†ææŒ‰ä¸‹è¾¹çš„è¡Œå·è¿›è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(relocate_vectors)</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_CPU_V7M</span><br><span class="line">	/*</span><br><span class="line">	 * On ARMv7-M we only have to write the new vector address</span><br><span class="line">	 * to VTOR register.</span><br><span class="line">	 */</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]	/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	ldr	r1, =V7M_SCB_BASE</span><br><span class="line">	str	r0, [r1, V7M_SCB_VTOR]</span><br><span class="line">#else</span><br><span class="line">#ifdef CONFIG_HAS_VBAR</span><br><span class="line">	/*</span><br><span class="line">	 * If the ARM processor has the security extensions,</span><br><span class="line">	 * use VBAR to relocate the exception vectors.</span><br><span class="line">	 */</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]	/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	mcr     p15, 0, r0, c12, c0, 0  /* Set VBAR */</span><br><span class="line">#else</span><br><span class="line">	/*</span><br><span class="line">	 * Copy the relocated exception vectors to the</span><br><span class="line">	 * correct address</span><br><span class="line">	 * CP15 c1 V bit gives us the location of the vectors:</span><br><span class="line">	 * 0x00000000 or 0xFFFF0000.</span><br><span class="line">	 */</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]	/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	mrc	p15, 0, r2, c1, c0, 0	/* V bit (bit[13]) in CP15 c1 */</span><br><span class="line">	ands	r2, r2, #(1 &lt;&lt; 13)</span><br><span class="line">	ldreq	r1, =0x00000000		/* If V=0 */</span><br><span class="line">	ldrne	r1, =0xFFFF0000		/* If V=1 */</span><br><span class="line">	ldmia	r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">	stmia	r1!, &#123;r2-r8,r10&#125;</span><br><span class="line">	ldmia	r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">	stmia	r1!, &#123;r2-r8,r10&#125;</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line">	bx	lr</span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_vectors)</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 3 è¡Œï¼ˆç¬¬ 29 è¡Œï¼‰ï¼šå¦‚æœå®šä¹‰äº† CONFIG_CPU_V7M çš„è¯å°±æ‰§è¡Œç¬¬ 4 ~ 10 è¡Œï¼ˆç¬¬ 30 ~ 36 è¡Œï¼‰çš„ä»£ç ï¼Œè¿™æ˜¯ Cortex-M å†…æ ¸å•ç‰‡æœºæ‰§è¡Œçš„è¯­å¥ï¼Œå› æ­¤å¯¹äº I.MX6ULL æ¥è¯´æ˜¯æ— æ•ˆçš„ã€‚  </p>
<p>ç¬¬ 12 è¡Œï¼ˆç¬¬ 38 è¡Œï¼‰ï¼šå¦‚æœå®šä¹‰äº† CONFIG_HAS_VBAR çš„è¯å°±æ‰§è¡Œæ­¤è¯­å¥ï¼Œè¿™ä¸ªæ˜¯å‘é‡è¡¨åç§»ï¼Œ CortexA7 æ˜¯æ”¯æŒå‘é‡è¡¨åç§»çš„ã€‚è€Œä¸”ï¼Œåœ¨.config é‡Œé¢å®šä¹‰äº† CONFIG_HAS_VBARï¼Œå› æ­¤ä¼šæ‰§è¡Œè¿™ä¸ªåˆ†æ”¯ã€‚</p>
<p>ç¬¬ 17 è¡Œï¼ˆç¬¬ 43 è¡Œï¼‰ï¼šr0&#x3D;gd-&gt;relocaddrï¼Œä¹Ÿå°±æ˜¯é‡å®šä½å uboot çš„é¦–åœ°å€ï¼Œå‘é‡è¡¨è‚¯å®šæ˜¯ä»è¿™ä¸ªåœ°å€å¼€å§‹å­˜æ”¾çš„ã€‚</p>
<p>ç¬¬ 18 è¡Œï¼ˆç¬¬ 44 è¡Œï¼‰ï¼šå°† r0 çš„å€¼å†™å…¥åˆ° CP15 çš„ VBAR å¯„å­˜å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯å°†æ–°çš„å‘é‡è¡¨é¦–åœ°å€å†™å…¥åˆ°å¯„å­˜å™¨ VBAR ä¸­ï¼Œè®¾ç½®å‘é‡è¡¨åç§»ã€‚  </p>
<h2 id="8-board-init-r-å‡½æ•°"><a href="#8-board-init-r-å‡½æ•°" class="headerlink" title="8.Â board_init_r    å‡½æ•°"></a><font size=3>8.Â board_init_r    å‡½æ•°</font></h2><h3 id="8-1-board-init-r-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"><a href="#8-1-board-init-r-å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="8.1Â board_init_r å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ"></a><font size=3>8.1Â board_init_r å‡½æ•°åœ¨å“ªé‡Œï¼Ÿ</font></h3><p>ä¸Šè¾¹æˆ‘ä»¬åˆ†æ _main å‡½æ•°çš„æ—¶å€™ï¼Œå®ƒè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå‰è¾¹æˆ‘ä»¬äº†è§£äº† board_init_f å‡½æ•°ï¼Œåœ¨æ­¤å‡½æ•°é‡Œé¢ä¼šè°ƒç”¨ä¸€ç³»åˆ—çš„å‡½æ•°æ¥åˆå§‹åŒ–ä¸€äº›å¤–è®¾å’Œ gd çš„æˆå‘˜å˜é‡ã€‚ä½†æ˜¯ board_init_f å¹¶æ²¡æœ‰åˆå§‹åŒ–æ‰€æœ‰çš„å¤–è®¾ï¼Œè¿˜éœ€è¦åšä¸€äº›åç»­å·¥ä½œï¼Œè¿™äº›åç»­å·¥ä½œå°±æ˜¯ç”±å‡½æ•° board_init_r æ¥å®Œæˆçš„  å®ƒå®šä¹‰åœ¨ uboot æºç ä¸­çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">common/board_r.c</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void board_init_r(gd_t *new_gd, ulong dest_addr)</span><br><span class="line">&#123;</span><br><span class="line">#ifdef CONFIG_NEEDS_MANUAL_RELOC</span><br><span class="line">	int i;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_AVR32</span><br><span class="line">	mmu_init_r(dest_addr);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if !defined(CONFIG_X86) &amp;&amp; !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_ARM64)</span><br><span class="line">	gd = new_gd;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_NEEDS_MANUAL_RELOC</span><br><span class="line">	for (i = 0; i &lt; ARRAY_SIZE(init_sequence_r); i++)</span><br><span class="line">		init_sequence_r[i] += gd-&gt;reloc_off;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	if (initcall_run_list(init_sequence_r))</span><br><span class="line">		hang();</span><br><span class="line"></span><br><span class="line">	/* NOTREACHED - run_main_loop() does not return */</span><br><span class="line">	hang();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#8-2-åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="8.2 åšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>8.2 åšäº†ä»€ä¹ˆï¼Ÿ</font></h3><p>æˆ‘ä»¬çš„åˆ†ææŒ‰ä¸‹è¾¹çš„è¡Œå·è¿›è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void board_init_r(gd_t *new_gd, ulong dest_addr)</span><br><span class="line">&#123;</span><br><span class="line">#ifdef CONFIG_NEEDS_MANUAL_RELOC</span><br><span class="line">	int i;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_AVR32</span><br><span class="line">	mmu_init_r(dest_addr);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if !defined(CONFIG_X86) &amp;&amp; !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_ARM64)</span><br><span class="line">	gd = new_gd;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_NEEDS_MANUAL_RELOC</span><br><span class="line">	for (i = 0; i &lt; ARRAY_SIZE(init_sequence_r); i++)</span><br><span class="line">		init_sequence_r[i] += gd-&gt;reloc_off;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	if (initcall_run_list(init_sequence_r))</span><br><span class="line">		hang();</span><br><span class="line"></span><br><span class="line">	/* NOTREACHED - run_main_loop() does not return */</span><br><span class="line">	hang();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 20 è¡Œï¼ˆç¬¬ 1010 è¡Œï¼‰ï¼šè°ƒç”¨ initcall_run_list å‡½æ•°æ¥æ‰§è¡Œåˆå§‹åŒ–åºåˆ— init_sequence_rï¼Œ init_sequence_r æ˜¯ä¸€ä¸ªå‡½æ•°é›†åˆï¼Œinit_sequence_r ä¹Ÿå®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;board_r.c ä¸­ï¼Œæˆ‘ä»¬ä¸‹ä¸€å°èŠ‚è¯¦ç»†å­¦ä¹ ã€‚</p>
<h3 id="8-3-init-sequence-r"><a href="#8-3-init-sequence-r" class="headerlink" title="8.3Â init_sequence_rÂ "></a><font size=3>8.3Â init_sequence_rÂ </font></h3><h4 id="8-3-1-æ•°ç»„æˆå‘˜"><a href="#8-3-1-æ•°ç»„æˆå‘˜" class="headerlink" title="8.3.1 æ•°ç»„æˆå‘˜"></a><font size=3>8.3.1 æ•°ç»„æˆå‘˜</font></h4><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ init_sequence_r </summary>
              <div class='content'>
              <p>init_sequence_r ä¹Ÿå®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;board_r.c ä¸­ï¼Œç”±äº init_sequence_f çš„å†…å®¹æ¯”è¾ƒé•¿ï¼Œé‡Œé¢æœ‰å¤§é‡çš„æ¡ä»¶ç¼–è¯‘ä»£ç ï¼Œè¿™é‡Œå°†æ¡ä»¶ç¼–è¯‘éƒ¨åˆ†åˆ é™¤æ‰äº†ï¼Œå»æ‰æ¡ä»¶ç¼–è¯‘ä»¥åçš„ init_sequence_r å®šä¹‰å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">init_fnc_t</span> init_sequence_r[] = &#123;</span><br><span class="line">	initr_trace,</span><br><span class="line">	initr_reloc,</span><br><span class="line">	initr_caches,</span><br><span class="line">	initr_reloc_global_data,</span><br><span class="line">	initr_barrier,</span><br><span class="line">	initr_malloc,</span><br><span class="line">	initr_console_record,</span><br><span class="line">	bootstage_relocate,</span><br><span class="line">	initr_bootstage,</span><br><span class="line">	board_init, <span class="comment">/* Setup chipselects */</span></span><br><span class="line">	stdio_init_tables,</span><br><span class="line">	initr_serial,</span><br><span class="line">	initr_announce,</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	power_init_board,</span><br><span class="line">	initr_flash,</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	initr_nand,</span><br><span class="line">	initr_mmc,</span><br><span class="line">	initr_env,</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	initr_secondary_cpu,</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	stdio_add_devices,</span><br><span class="line">	initr_jumptable,</span><br><span class="line">	console_init_r, <span class="comment">/* fully init console as a device */</span></span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	interrupt_init,</span><br><span class="line">	initr_enable_interrupts,</span><br><span class="line">	initr_ethaddr,</span><br><span class="line">	board_late_init,</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	initr_net,</span><br><span class="line">	INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">	run_main_loop,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
              </div>
            </details>



<h4 id="8-3-2-é‡è¦å‡½æ•°è¯´æ˜"><a href="#8-3-2-é‡è¦å‡½æ•°è¯´æ˜" class="headerlink" title="8.3.2 é‡è¦å‡½æ•°è¯´æ˜"></a><font size=3>8.3.2 é‡è¦å‡½æ•°è¯´æ˜</font></h4><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹é‡è¦å‡½æ•°åŠŸèƒ½åˆ†æ </summary>
              <div class='content'>
              <p>ç¬¬ 2 è¡Œï¼šinitr_trace å‡½æ•°ï¼Œå¦‚æœå®šä¹‰äº†å® CONFIG_TRACE çš„è¯å°±ä¼šè°ƒç”¨å‡½æ•° trace_initï¼Œåˆå§‹åŒ–å’Œè°ƒè¯•è·Ÿè¸ªæœ‰å…³çš„å†…å®¹ã€‚</p><p>ç¬¬ 3 è¡Œï¼šinitr_reloc å‡½æ•°ç”¨äºè®¾ç½® gd-&gt;flagsï¼Œæ ‡è®°é‡å®šä½å®Œæˆã€‚</p><p>ç¬¬ 4 è¡Œï¼šinitr_caches å‡½æ•°ç”¨äºåˆå§‹åŒ– cacheï¼Œä½¿èƒ½ cacheã€‚</p><p>ç¬¬ 5 è¡Œï¼šinitr_reloc_global_data å‡½æ•°ï¼Œåˆå§‹åŒ–é‡å®šä½å gd çš„ä¸€äº›æˆå‘˜å˜é‡ã€‚</p><p>ç¬¬ 6 è¡Œï¼šinitr_barrier å‡½æ•°ï¼Œ I.MX6ULL æœªç”¨åˆ°ã€‚</p><p>ç¬¬ 7 è¡Œï¼šinitr_malloc å‡½æ•°ï¼Œåˆå§‹åŒ– mallocã€‚</p><p>ç¬¬ 8 è¡Œï¼šinitr_console_record å‡½æ•°ï¼Œåˆå§‹åŒ–æ§åˆ¶å°ç›¸å…³çš„å†…å®¹ï¼Œ I.MX6ULL æœªç”¨åˆ°ï¼Œç©ºå‡½æ•°ã€‚</p><p>ç¬¬ 9 è¡Œï¼š bootstage_relocate å‡½æ•°ï¼Œå¯åŠ¨çŠ¶æ€é‡å®šä½ã€‚</p><p>ç¬¬ 10 è¡Œï¼šinitr_bootstage å‡½æ•°ï¼Œåˆå§‹åŒ– bootstage ä»€ä¹ˆçš„ã€‚</p><p>ç¬¬ 11 è¡Œï¼šboard_init å‡½æ•°ï¼Œæ¿çº§åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬ 74XX èŠ¯ç‰‡ï¼Œ I2Cã€ FECã€ USB å’Œ QSPI ç­‰ã€‚è¿™é‡Œæ‰§è¡Œçš„æ˜¯ mx6ull_alientek_emmc.c æ–‡ä»¶ä¸­çš„ board_init å‡½æ•°ã€‚</p><p>ç¬¬ 12 è¡Œï¼šstdio_init_tables å‡½æ•°ï¼Œ stdio ç›¸å…³åˆå§‹åŒ–ã€‚</p><p>ç¬¬ 13 è¡Œï¼šinitr_serial å‡½æ•°ï¼Œåˆå§‹åŒ–ä¸²å£ã€‚</p><p>ç¬¬ 14 è¡Œï¼šinitr_announce å‡½æ•°ï¼Œä¸è°ƒè¯•æœ‰å…³ï¼Œé€šçŸ¥å·²ç»åœ¨ RAM ä¸­è¿è¡Œã€‚</p><p>ç¬¬ 18 è¡Œï¼špower_init_board å‡½æ•°ï¼Œåˆå§‹åŒ–ç”µæºèŠ¯ç‰‡ï¼Œæ­£ç‚¹åŸå­çš„ I.MX6ULL å¼€å‘æ¿æ²¡æœ‰ç”¨åˆ°ã€‚</p><p>ç¬¬ 19 è¡Œï¼šinitr_flash å‡½æ•°ï¼Œå¯¹äº I.MX6ULL è€Œè¨€ï¼Œæ²¡æœ‰å®šä¹‰å® CONFIG_SYS_NO_FLASHçš„è¯å‡½æ•° initr_flash æ‰æœ‰æ•ˆã€‚ä½†æ˜¯  mx6_common.h ä¸­å®šä¹‰äº†å® CONFIG_SYS_NO_FLASHï¼Œæ‰€ä»¥æ­¤å‡½æ•°æ— æ•ˆã€‚</p><p>ç¬¬ 21 è¡Œï¼šinitr_nand å‡½æ•°ï¼Œåˆå§‹åŒ– NANDï¼Œå¦‚æœä½¿ç”¨ NAND ç‰ˆæœ¬æ ¸å¿ƒæ¿çš„è¯å°±ä¼šåˆå§‹åŒ–NANDã€‚</p><p>ç¬¬ 22 è¡Œï¼šinitr_mmc å‡½æ•°ï¼Œåˆå§‹åŒ– EMMCï¼Œå¦‚æœä½¿ç”¨ EMMC ç‰ˆæœ¬æ ¸å¿ƒæ¿çš„è¯å°±ä¼šåˆå§‹åŒ–EMMCï¼Œä¸²å£è¾“å‡ºå¦‚ä¸‹å›¾æ‰€ç¤ºä¿¡æ¯ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016083509867.png" alt="image-20221016083509867" style="zoom:50%;" /><p>ç¬¬ 23 è¡Œï¼šinitr_env å‡½æ•°ï¼Œåˆå§‹åŒ–ç¯å¢ƒå˜é‡ã€‚</p><p>ç¬¬ 25 è¡Œï¼šinitr_secondary_cpu å‡½æ•°ï¼Œåˆå§‹åŒ–å…¶ä»– CPU æ ¸ï¼Œ I.MX6ULL åªæœ‰ä¸€ä¸ªæ ¸ï¼Œæ‰€ä»¥æ­¤å‡½æ•°æ²¡ç”¨ã€‚  </p><p>ç¬¬ 27 è¡Œï¼šstdio_add_devices å‡½æ•°ï¼Œå„ç§è¾“å…¥è¾“å‡ºè®¾å¤‡çš„åˆå§‹åŒ–ï¼Œå¦‚ LCD driverï¼Œ I.MX6ULL ä½¿ç”¨ drv_video_init å‡½æ•°åˆå§‹åŒ– LCDã€‚ä¼šè¾“å‡ºå¦‚å›¾æ‰€ç¤ºä¿¡æ¯ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016083629656.png" alt="image-20221016083629656" style="zoom:50%;" /><p>ç¬¬ 28 è¡Œï¼šinitr_jumptable å‡½æ•°ï¼Œåˆå§‹åŒ–è·³è½¬è¡¨ã€‚  </p><p>ç¬¬ 29 è¡Œï¼šconsole_init_r å‡½æ•°ï¼Œæ§åˆ¶å°åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆä»¥åæ­¤å‡½æ•°ä¼šè°ƒç”¨ stdio_print_current_devices å‡½æ•°æ¥æ‰“å°å‡ºå½“å‰çš„æ§åˆ¶å°è®¾å¤‡ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š  </p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016083741446.png" alt="image-20221016083741446" style="zoom:50%;" /><p>ç¬¬ 31 è¡Œï¼šinterrupt_init å‡½æ•°ï¼Œåˆå§‹åŒ–ä¸­æ–­ã€‚</p><p>ç¬¬ 32 è¡Œï¼šinitr_enable_interrupts å‡½æ•°ï¼Œä½¿èƒ½ä¸­æ–­ã€‚</p><p>ç¬¬ 33 è¡Œï¼šinitr_ethaddr å‡½æ•°ï¼Œåˆå§‹åŒ–ç½‘ç»œåœ°å€ï¼Œä¹Ÿå°±æ˜¯è·å– MAC åœ°å€ã€‚è¯»å–ç¯å¢ƒå˜é‡â€œethaddrâ€çš„å€¼ã€‚  </p><p>ç¬¬ 34 è¡Œï¼Œ board_late_init å‡½æ•°ï¼Œæ¿å­åç»­åˆå§‹åŒ–ï¼Œæ­¤å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ mx6ull_alientek_emmc.c ä¸­ï¼Œå¦‚æœç¯å¢ƒå˜é‡å­˜å‚¨åœ¨ EMMC æˆ–è€… SD å¡ä¸­çš„è¯ï¼Œæ­¤å‡½æ•°ä¼šè°ƒç”¨ board_late_mmc_env_init å‡½æ•°åˆå§‹åŒ– EMMC&#x2F;SDã€‚ä¼šåˆ‡æ¢åˆ°æ­£åœ¨æ—¶å€™ç”¨çš„ emmc è®¾å¤‡ã€‚</p><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ board_late_mmc_env_init </summary>              <div class='content'>              <p>è¿™ä¸ªå‡½æ•°å‡ºç°åœ¨ubootæºç çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">board/freescale/mx6ull_alientek_emmc/mx6ull_alientek_emmc.c # åœ¨è¯¥æ–‡ä»¶è¢«è°ƒç”¨</span><br><span class="line">board/freescale/common/mmc.c                                # åœ¨è¯¥æ–‡ä»¶ä¸­å®šä¹‰</span><br></pre></td></tr></table></figure><p>å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_late_mmc_env_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> cmd[<span class="number">32</span>];</span><br><span class="line">	<span class="type">char</span> mmcblk[<span class="number">32</span>];</span><br><span class="line">	u32 dev_no = mmc_get_env_dev();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!check_mmc_autodetect())</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	setenv_ulong(<span class="string">&quot;mmcdev&quot;</span>, dev_no);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set mmcblk env */</span></span><br><span class="line">	<span class="built_in">sprintf</span>(mmcblk, <span class="string">&quot;/dev/mmcblk%dp2 rootwait rw&quot;</span>,</span><br><span class="line">		mmc_map_to_kernel_blk(dev_no));</span><br><span class="line">	setenv(<span class="string">&quot;mmcroot&quot;</span>, mmcblk);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">sprintf</span>(cmd, <span class="string">&quot;mmc dev %d&quot;</span>, dev_no);</span><br><span class="line">	run_command(cmd, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ 17 ~ 18 è¡Œï¼ˆç¬¬ 46 ~ 47 è¡Œï¼‰å°±æ˜¯è¿è¡Œâ€œmmc dev xxâ€å‘½ä»¤ï¼Œç”¨äºåˆ‡æ¢åˆ°æ­£åœ¨ä½¿ç”¨çš„EMMC è®¾å¤‡ï¼Œä¸²å£è¾“å‡ºä¿¡æ¯å¦‚å›¾æ‰€ç¤ºï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016084737899.png" alt="image-20221016084737899" style="zoom:50%;" />              </div>            </details><p>ç¬¬ 38 è¡Œï¼šinitr_net  å‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–ç½‘ç»œè®¾å¤‡ï¼Œå‡½æ•°çš„è°ƒç”¨é¡ºåºä¸ºï¼šinitr_net&rarr;eth_initialize&rarr;board_eth_init() ï¼Œæœ€ç»ˆåœ¨ä¸²å£ä¸Šä¼šè¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016084922548.png" alt="image-20221016084922548" style="zoom:50%;" /><p>ç¬¬ 40 è¡Œï¼Œ run_main_loop å‡½æ•°ï¼ˆåè¾¹å†è¯¦ç»†è¯´æ˜ï¼‰ï¼Œä¸»å¾ªç¯ï¼Œå¤„ç†å‘½ä»¤ã€‚</p>
              </div>
            </details>

<h2 id="9-run-main-loop-å‡½æ•°"><a href="#9-run-main-loop-å‡½æ•°" class="headerlink" title="9.Â run_main_loop å‡½æ•°"></a><font size=3>9.Â run_main_loop å‡½æ•°</font></h2><p>å‰è¾¹æˆ‘ä»¬åˆ†æåˆ°äº† board_init_r å‡½æ•°ï¼Œåœ¨æ­¤å‡½æ•°ä¸­åˆä¼šè°ƒç”¨åˆ° run_main_loop å‡½æ•°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½ã€‚</p>
<p>uboot å¯åŠ¨ä»¥åä¼šè¿›å…¥ bootdelay ç§’å€’è®¡æ—¶ï¼Œå¦‚æœåœ¨ bootdelay  ç§’å€’è®¡æ—¶ç»“æŸä¹‹å‰æŒ‰ä¸‹æŒ‰ä¸‹å›è½¦é”®ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥ uboot çš„å‘½ä»¤æ¨¡å¼ï¼Œå¦‚æœå€’è®¡æ—¶ç»“æŸä»¥åéƒ½æ²¡æœ‰æŒ‰ä¸‹å›è½¦é”®ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨å¯åŠ¨ Linux å†…æ ¸ï¼Œè¿™ä¸ªåŠŸèƒ½å°±æ˜¯ç”± run_main_loop å‡½æ•°æ¥å®Œæˆçš„ã€‚  </p>
<h3 id="9-1-run-main-loop-å‡½æ•°åœ¨å“ªï¼Ÿ"><a href="#9-1-run-main-loop-å‡½æ•°åœ¨å“ªï¼Ÿ" class="headerlink" title="9.1Â run_main_loop å‡½æ•°åœ¨å“ªï¼Ÿ"></a><font size=3>9.1Â run_main_loop å‡½æ•°åœ¨å“ªï¼Ÿ</font></h3><p>run_main_loop å‡½æ•°å®šä¹‰åœ¨uboot æºç çš„è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">common/board_r.c</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">run_main_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SANDBOX</span></span><br><span class="line">	sandbox_main_loop_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* main_loop() can return to retry autoboot, if so just run it again */</span></span><br><span class="line">	<span class="keyword">for</span> (;;)</span><br><span class="line">		main_loop();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-2-åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#9-2-åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="9.2 åšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>9.2 åšäº†ä»€ä¹ˆï¼Ÿ</font></h3><h4 id="9-2-1-run-main-loopå‡½æ•°å®šä¹‰"><a href="#9-2-1-run-main-loopå‡½æ•°å®šä¹‰" class="headerlink" title="9.2.1Â run_main_loopå‡½æ•°å®šä¹‰"></a><font size=3>9.2.1Â run_main_loopå‡½æ•°å®šä¹‰</font></h4><p>æˆ‘ä»¬æŒ‰ç…§ä¸‹è¾¹çš„è¡Œå·åˆ†æï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">run_main_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SANDBOX</span></span><br><span class="line">	sandbox_main_loop_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* main_loop() can return to retry autoboot, if so just run it again */</span></span><br><span class="line">	<span class="keyword">for</span> (;;)</span><br><span class="line">		main_loop();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 7 è¡Œ å’Œç¬¬ 8 è¡Œï¼ˆç¬¬ 759 è¡Œå’Œç¬¬ 760 è¡Œï¼‰æ˜¯ä¸ªæ­»å¾ªç¯ï¼Œâ€œfor(;;)â€å’Œâ€œwhile(1)â€åŠŸèƒ½ä¸€æ ·ï¼Œæ­»å¾ªç¯é‡Œé¢å°±ä¸€ä¸ª main_loop å‡½æ•° ã€‚</p>
<h4 id="9-2-2-main-loop-å‡½æ•°"><a href="#9-2-2-main-loop-å‡½æ•°" class="headerlink" title="9.2.2Â main_loop å‡½æ•°"></a><font size=3>9.2.2Â main_loop å‡½æ•°</font></h4><p>è¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨ common&#x2F;main.c  ä¸­ï¼Œå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We come here after U-Boot is initialised and ready to process commands */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *s;</span><br><span class="line"></span><br><span class="line">	bootstage_mark_name(BOOTSTAGE_ID_MAIN_LOOP, <span class="string">&quot;main_loop&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SYS_GENERIC_BOARD</span></span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Warning: Your board does not use generic board. Please read\n&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;doc/README.generic-board and take action. Boards not\n&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;upgraded by the late 2014 may break or be removed.\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_VERSION_VARIABLE</span></span><br><span class="line">	setenv(<span class="string">&quot;ver&quot;</span>, version_string);  <span class="comment">/* set version variable */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_VERSION_VARIABLE */</span></span></span><br><span class="line"></span><br><span class="line">	cli_init();</span><br><span class="line"></span><br><span class="line">	run_preboot_environment_command();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_UPDATE_TFTP)</span></span><br><span class="line">	update_tftp(<span class="number">0UL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_UPDATE_TFTP */</span></span></span><br><span class="line"></span><br><span class="line">	s = bootdelay_process();</span><br><span class="line">	<span class="keyword">if</span> (cli_process_fdt(&amp;s))</span><br><span class="line">		cli_secure_boot_cmd(s);</span><br><span class="line"></span><br><span class="line">	autoboot_command(s);</span><br><span class="line"></span><br><span class="line">	cli_loop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 6 è¡Œï¼ˆç¬¬ 48 è¡Œï¼‰ï¼šè°ƒç”¨ bootstage_mark_name å‡½æ•°ï¼Œæ‰“å°å‡ºå¯åŠ¨è¿›åº¦ã€‚  </p>
<p>ç¬¬ 15 è¡Œï¼ˆç¬¬ 57 è¡Œï¼‰ï¼šå¦‚æœå®šä¹‰äº†å® CONFIG_VERSION_VARIABLE çš„è¯å°±ä¼šæ‰§è¡Œå‡½æ•° setenvï¼Œå°†å˜é‡ ver çš„å€¼è®¾ç½®ä¸º version_stringï¼Œä¹Ÿå°±æ˜¯è®¾ç½®ç‰ˆæœ¬å·ç¯å¢ƒå˜é‡ã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ version_string </summary>
              <div class='content'>
              <p>version_string å®šä¹‰åœ¨æ–‡ä»¶ cmd&#x2F;version.c ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> __weak version_string[] = U_BOOT_VERSION_STRING;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­U_BOOT_VERSION_STRING æ˜¯ä¸ªå®ï¼Œ å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;version.hï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_VERSION_STRING U_BOOT_VERSION <span class="string">&quot; (&quot;</span> U_BOOT_DATE <span class="string">&quot; - &quot;</span> \</span></span><br><span class="line"><span class="meta">	U_BOOT_TIME <span class="string">&quot; &quot;</span> U_BOOT_TZ <span class="string">&quot;)&quot;</span> CONFIG_IDENT_STRING</span></span><br></pre></td></tr></table></figure><p>U_BOOT_VERSION å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;generated&#x2F;version_autogenerated.h ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PLAIN_VERSION <span class="string">&quot;2016.03-g9e33bde-dirty&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_VERSION <span class="string">&quot;U-Boot &quot;</span> PLAIN_VERSION</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CC_VERSION_STRING <span class="string">&quot;arm-linux-gnueabihf-gcc (Linaro GCC 4.9-2017.01) 4.9.4&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LD_VERSION_STRING <span class="string">&quot;GNU ld (Linaro_Binutils-2017.01) 2.24.0.20141017 Linaro 2014_11-3-git&quot;</span></span></span><br></pre></td></tr></table></figure><p>  å¯ä»¥çœ‹å‡ºï¼Œ U_BOOT_VERSION ä¸ºâ€œU-boot 2016.03â€ï¼ŒU_BOOT_DATE ã€ U_BOOT_TIME å’Œ U_BOOT_TZ å®šä¹‰åœ¨ include&#x2F;generated&#x2F;timestamp_autogenerated.h æ–‡ä»¶ä¸­ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_DATE <span class="string">&quot;Oct 15 2022&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_TIME <span class="string">&quot;17:13:29&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_TZ <span class="string">&quot;+0800&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_DMI_DATE <span class="string">&quot;10/15/2022&quot;</span></span></span><br></pre></td></tr></table></figure><p>å® CONFIG_IDENT_STRING ä¸ºç©ºï¼Œæ‰€ä»¥ U_BOOT_VERSION_STRING ä¸ºâ€œU-Boot 2016.03(Oct 15 2022 - 17:13:29 +0800)â€ï¼Œè¿›å…¥ uboot å‘½ä»¤æ¨¡å¼ï¼Œè¾“å…¥å‘½ä»¤â€œversionâ€æŸ¥çœ‹ç‰ˆæœ¬å·ï¼Œå¦‚å›¾:</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016100037636.png" alt="image-20221016100037636" style="zoom:50%;" />
              </div>
            </details>

<p>ç¬¬ 18 è¡Œï¼ˆç¬¬ 60 è¡Œï¼‰ï¼šcli_init å‡½æ•°ï¼Œè·Ÿå‘½ä»¤åˆå§‹åŒ–æœ‰å…³ï¼Œåˆå§‹åŒ– hush shell ç›¸å…³çš„å˜é‡ã€‚</p>
<p>ç¬¬ 20 è¡Œï¼ˆç¬¬ 62 è¡Œï¼‰ï¼šrun_preboot_environment_command å‡½æ•°ï¼Œè·å–ç¯å¢ƒå˜é‡ perboot çš„å†…å®¹ï¼Œ perboot æ˜¯ä¸€äº›é¢„å¯åŠ¨å‘½ä»¤ï¼Œä¸€èˆ¬ä¸ä½¿ç”¨è¿™ä¸ªç¯å¢ƒå˜é‡ã€‚ </p>
<p>ç¬¬ 26 è¡Œï¼ˆç¬¬ 68 è¡Œï¼‰ï¼šbootdelay_process å‡½æ•°ï¼Œæ­¤å‡½æ•°ä¼šè¯»å–ç¯å¢ƒå˜é‡ bootdelay å’Œ bootcmd çš„å†…å®¹ï¼Œç„¶åå°† bootdelay çš„å€¼èµ‹å€¼ç»™å…¨å±€å˜é‡ stored_bootdelayï¼Œè¿”å›å€¼ä¸ºç¯å¢ƒå˜é‡ bootcmd çš„å€¼ã€‚</p>
<p>ç¬¬ 27 è¡Œï¼ˆç¬¬ 69 è¡Œï¼‰ï¼šå¦‚æœå®šä¹‰äº† CONFIG_OF_CONTROL çš„è¯å‡½æ•° cli_process_fdt å°±ä¼šå®ç°ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰ CONFIG_OF_CONTROL çš„è¯å‡½æ•° cli_process_fdt ç›´æ¥è¿”å›ä¸€ä¸ª falseã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨çš„ uboot ä¸­æ²¡æœ‰å®šä¹‰ CONFIG_OF_CONTROLï¼Œå› æ­¤ cli_process_fdt å‡½æ•°è¿”å›å€¼ä¸º falseã€‚  </p>
<p>ç¬¬ 30 è¡Œï¼ˆç¬¬ 72 è¡Œï¼‰ï¼šautoboot_command å‡½æ•°ï¼Œæ­¤å‡½æ•°å°±æ˜¯æ£€æŸ¥å€’è®¡æ—¶æ˜¯å¦ç»“æŸï¼Œå€’è®¡æ—¶ç»“æŸä¹‹å‰æœ‰æ²¡æœ‰è¢«æ‰“æ–­ã€‚  </p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ autoboot_command </summary>
              <div class='content'>
              <p>æ­¤å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;autoboot.c ä¸­ï¼Œå†…å®¹å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">autoboot_command</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span></span><br><span class="line">&#123;</span><br><span class="line">	debug(<span class="string">&quot;### main_loop: bootcmd=\&quot;%s\&quot;\n&quot;</span>, s ? s : <span class="string">&quot;&lt;UNDEFINED&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (stored_bootdelay != <span class="number">-1</span> &amp;&amp; s &amp;&amp; !abortboot(stored_bootdelay)) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_AUTOBOOT_KEYED) &amp;&amp; !defined(CONFIG_AUTOBOOT_KEYED_CTRLC)</span></span><br><span class="line">		<span class="type">int</span> prev = disable_ctrlc(<span class="number">1</span>);	<span class="comment">/* disable Control C checking */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		run_command_list(s, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_AUTOBOOT_KEYED) &amp;&amp; !defined(CONFIG_AUTOBOOT_KEYED_CTRLC)</span></span><br><span class="line">		disable_ctrlc(prev);	<span class="comment">/* restore Control C checking */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MENUKEY</span></span><br><span class="line">	<span class="keyword">if</span> (menukey == CONFIG_MENUKEY) &#123;</span><br><span class="line">		s = getenv(<span class="string">&quot;menucmd&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (s)</span><br><span class="line">			run_command_list(s, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_MENUKEY */</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>autoboot_command å‡½æ•°é‡Œé¢æœ‰å¾ˆå¤šæ¡ä»¶ç¼–è¯‘ï¼Œå®CONFIG_AUTOBOOT_KEYED ã€ CONFIG_AUTOBOOT_KEYED_CTRLC å’Œ<br>CONFIG_MENUKEY è¿™ä¸‰ä¸ªå®åœ¨ I.MX6ULL é‡Œé¢æ²¡æœ‰å®šä¹‰ï¼Œå»æ‰æ¡ä»¶ç¼–è¯‘å¾—åˆ°å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">autoboot_command</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (stored_bootdelay != <span class="number">-1</span> &amp;&amp; s &amp;&amp; !abortboot(stored_bootdelay))</span><br><span class="line">	&#123;</span><br><span class="line">		run_command_list(s, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> å¯ä»¥çœ‹åˆ°ï¼Œå½“ä»¥ä¸‹ä¸‰æ¡å…¨éƒ¨æˆç«‹çš„è¯ï¼Œå°±ä¼šæ‰§è¡Œå‡½æ•° run_command_list ï¼š</p><p>ï¼ˆ1ï¼‰stored_bootdelay ä¸ç­‰äº -1 ã€‚</p><p>ï¼ˆ2ï¼‰s ä¸ä¸ºç©ºã€‚</p><p>ï¼ˆ3ï¼‰å‡½æ•° abortboot è¿”å›å€¼ä¸º 0ã€‚  </p><p>stored_bootdelay ç­‰äºç¯å¢ƒå˜é‡ bootdelay çš„å€¼ï¼› s æ˜¯ç¯å¢ƒå˜é‡ bootcmd çš„å€¼ï¼Œä¸€èˆ¬ä¸ä¸ºç©ºï¼Œå› æ­¤å‰ä¸¤ä¸ªæˆç«‹ï¼Œå°±å‰©ä¸‹äº†å‡½æ•° abortboot çš„è¿”å›å€¼ ï¼Œå¦‚æœå€’è®¡æ—¶è‡ªç„¶ç»“æŸé‚£ä¹ˆå°±æ‰§è¡Œå‡½æ•° run_command_listï¼Œæ­¤å‡½æ•°ä¼šæ‰§è¡Œå‚æ•° s æŒ‡å®šçš„ä¸€ç³»åˆ—å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯ç¯å¢ƒå˜é‡ bootcmd çš„å‘½ä»¤ï¼Œbootcmd é‡Œé¢ä¿å­˜ç€é»˜è®¤çš„å¯åŠ¨å‘½ä»¤ï¼Œå› æ­¤ linux å†…æ ¸å¯åŠ¨ï¼è¿™ä¸ªå°±æ˜¯ uboot ä¸­å€’è®¡æ—¶ç»“æŸä»¥åè‡ªåŠ¨å¯åŠ¨ linux å†…æ ¸çš„åŸç†ã€‚å¦‚æœå€’è®¡æ—¶ç»“æŸä¹‹å‰æŒ‰ä¸‹äº†é”®ç›˜ä¸Šçš„æŒ‰é”®ï¼Œé‚£ä¹ˆ run_command_list å‡½æ•°å°±ä¸ä¼šæ‰§è¡Œï¼Œç›¸å½“äº autoboot_command æ˜¯ä¸ªç©ºå‡½æ•°ã€‚</p><details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ abortboot å‡½æ•° </summary>              <div class='content'>              <p> abortboot å‡½æ•° ä¹Ÿ å®š ä¹‰ åœ¨ æ–‡ ä»¶ common&#x2F;autoboot.c ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">abortboot</span><span class="params">(<span class="type">int</span> bootdelay)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AUTOBOOT_KEYED</span></span><br><span class="line">	<span class="keyword">return</span> abortboot_keyed(bootdelay);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> abortboot_normal(bootdelay);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºå® CONFIG_AUTOBOOT_KEYE æœªå®šä¹‰ï¼Œå› æ­¤æ‰§è¡Œå‡½æ•° abortboot_normal ï¼Œæ­¤å‡½æ•°ä¹Ÿå®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;autoboot.c ä¸­ï¼Œå†…å®¹<br>å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">abortboot_normal</span><span class="params">(<span class="type">int</span> bootdelay)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> <span class="built_in">abort</span> = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ts;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MENUPROMPT</span></span><br><span class="line">	<span class="built_in">printf</span>(CONFIG_MENUPROMPT);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (bootdelay &gt;= <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Hit any key to stop autoboot: %2d &quot;</span>, bootdelay);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined CONFIG_ZERO_BOOTDELAY_CHECK</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Check if key already pressed</span></span><br><span class="line"><span class="comment">	 * Don&#x27;t check if bootdelay &lt; 0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (bootdelay &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (tstc()) &#123;	<span class="comment">/* we got a key press	*/</span></span><br><span class="line">			(<span class="type">void</span>) getc();  <span class="comment">/* consume input	*/</span></span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;\b\b\b 0&quot;</span>);</span><br><span class="line">			<span class="built_in">abort</span> = <span class="number">1</span>;	<span class="comment">/* don&#x27;t auto boot	*/</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((bootdelay &gt; <span class="number">0</span>) &amp;&amp; (!<span class="built_in">abort</span>)) &#123;</span><br><span class="line">		--bootdelay;</span><br><span class="line">		<span class="comment">/* delay 1000 ms */</span></span><br><span class="line">		ts = get_timer(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (tstc()) &#123;	<span class="comment">/* we got a key press	*/</span></span><br><span class="line">				<span class="built_in">abort</span>  = <span class="number">1</span>;	<span class="comment">/* don&#x27;t auto boot	*/</span></span><br><span class="line">				bootdelay = <span class="number">0</span>;	<span class="comment">/* no more delay	*/</span></span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> CONFIG_MENUKEY</span></span><br><span class="line">				menukey = getc();</span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line">				(<span class="type">void</span>) getc();  <span class="comment">/* consume input	*/</span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			udelay(<span class="number">10000</span>);</span><br><span class="line">		&#125; <span class="keyword">while</span> (!<span class="built_in">abort</span> &amp;&amp; get_timer(ts) &lt; <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\b\b\b%2d &quot;</span>, bootdelay);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	putc(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SILENT_CONSOLE</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">abort</span>)</span><br><span class="line">		gd-&gt;flags &amp;= ~GD_FLG_SILENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">abort</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•° abortboot_normal åŒæ ·å¾ˆå¤šæ¡ä»¶ç¼–è¯‘ï¼Œåˆ é™¤æ‰æ¡ä»¶ç¼–è¯‘ç›¸å…³ä»£ç å abortboot_normal å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">abortboot_normal</span><span class="params">(<span class="type">int</span> bootdelay)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> <span class="built_in">abort</span> = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ts;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bootdelay &gt;= <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Hit any key to stop autoboot: %2d &quot;</span>, bootdelay);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((bootdelay &gt; <span class="number">0</span>) &amp;&amp; (!<span class="built_in">abort</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		--bootdelay;</span><br><span class="line">		<span class="comment">/* delay 1000 ms */</span></span><br><span class="line">		ts = get_timer(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (tstc())   <span class="comment">/* we got a key press */</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">abort</span> = <span class="number">1</span>; <span class="comment">/* don&#x27;t auto boot */</span></span><br><span class="line">				bootdelay = <span class="number">0</span>; <span class="comment">/* no more delay */</span></span><br><span class="line">				(<span class="type">void</span>) getc(); <span class="comment">/* consume input */</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			udelay(<span class="number">10000</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (!<span class="built_in">abort</span> &amp;&amp; get_timer(ts) &lt; <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\b\b\b%2d &quot;</span>, bootdelay);</span><br><span class="line">	&#125;</span><br><span class="line">	putc(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">abort</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ 3 è¡Œï¼šå˜é‡ abort æ˜¯å‡½æ•° abortboot_normal çš„è¿”å›å€¼ï¼Œé»˜è®¤å€¼ä¸º 0ã€‚</p><p> ç¬¬ 7 è¡Œï¼šé€šè¿‡ä¸²å£è¾“å‡ºâ€œHit any key to stop autobootâ€å­—æ ·ï¼Œå¦‚å›¾ï¼š</p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016101203235.png" alt="image-20221016101203235" style="zoom: 50%;" /><p>ç¬¬ 9 ~ 25 è¡Œï¼šæ˜¯å€’è®¡æ—¶çš„å…·ä½“å®ç°ã€‚å…¶ä¸­çš„ç¬¬ 16 è¡Œåˆ¤æ–­é”®ç›˜æ˜¯å¦æœ‰æŒ‰ä¸‹ï¼Œä¹Ÿå°±æ˜¯æ˜¯å¦æ‰“æ–­äº†å€’è®¡æ—¶ï¼Œå¦‚æœé”®ç›˜æŒ‰ä¸‹çš„è¯å°±æ‰§è¡Œç›¸åº”çš„<br>åˆ†æ”¯ã€‚æ¯”å¦‚è®¾ç½® abort ä¸º 1ï¼Œè®¾ç½® bootdelay ä¸º 0 ç­‰ï¼Œæœ€åè·³å‡ºå€’è®¡æ—¶å¾ªç¯ã€‚   </p><p>ç¬¬ 30 è¡Œï¼Œè¿”å› abort çš„å€¼ï¼Œå¦‚æœå€’è®¡æ—¶è‡ªç„¶ç»“æŸï¼Œæ²¡æœ‰è¢«æ‰“æ–­ abort å°±ä¸º 0ï¼Œå¦åˆ™çš„è¯ abortçš„å€¼å°±ä¸º 1ã€‚ </p>              </div>            </details> 
              </div>
            </details>

<p>ç¬¬ 32 è¡Œï¼ˆç¬¬ 74 è¡Œï¼‰ï¼šå¦‚æœå€’è®¡æ—¶ç»“æŸä¹‹å‰æŒ‰ä¸‹æŒ‰é”®ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œcli_loop å‡½æ•°ï¼Œè¿™ä¸ªå°±æ˜¯å‘½ä»¤å¤„ç†å‡½æ•°ï¼Œè´Ÿè´£æ¥æ”¶å¥½å¤„ç†è¾“å…¥çš„å‘½ä»¤ã€‚  </p>
<h2 id="10-cli-loop-å‡½æ•°"><a href="#10-cli-loop-å‡½æ•°" class="headerlink" title="10.Â cli_loop å‡½æ•°"></a><font size=3>10.Â cli_loop å‡½æ•°</font></h2><p>å‰è¾¹æˆ‘ä»¬åˆ†æåˆ°ï¼Œå½“æ‰§è¡Œrun_main_loop å‡½æ•°ï¼Œå€’è®¡æ—¶ç»“æŸå‰æŒ‰ä¸‹æŒ‰é”®ï¼Œä¼šæ‰§è¡Œ cli_loopï¼Œæ¥ä¸‹æ¥å°±æ¥äº†è§£ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ã€‚</p>
<h3 id="10-1-cli-loop-å‡½æ•°åœ¨å“ªï¼Ÿ"><a href="#10-1-cli-loop-å‡½æ•°åœ¨å“ªï¼Ÿ" class="headerlink" title="10.1Â cli_loop å‡½æ•°åœ¨å“ªï¼Ÿ"></a><font size=3>10.1Â cli_loop å‡½æ•°åœ¨å“ªï¼Ÿ</font></h3><p>cli_loop å‡½æ•°æ˜¯ uboot çš„å‘½ä»¤è¡Œå¤„ç†å‡½æ•°ï¼Œæœ€ç»ˆæ˜¯è°ƒç”¨åˆ° cmd_process å‡½æ•°æ¥å¤„ç†å‘½ä»¤ã€‚æˆ‘ä»¬åœ¨ uboot ä¸­è¾“å…¥å„ç§å‘½ä»¤ï¼Œè¿›è¡Œå„ç§æ“ä½œå°±æ˜¯ cli_loop æ¥å¤„ç†çš„ï¼Œæ­¤å‡½æ•°å®šä¹‰åœ¨ubootæºç è¿™ä¸ªæ–‡ä»¶ä¸­ ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">common/cli.c</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">cli_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_HUSH_PARSER</span></span><br><span class="line">	parse_file_outer();</span><br><span class="line">	<span class="comment">/* This point is never reached */</span></span><br><span class="line">	<span class="keyword">for</span> (;;);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	cli_simple_loop();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/*CONFIG_SYS_HUSH_PARSER*/</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-2-åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#10-2-åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="10.2 åšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>10.2 åšäº†ä»€ä¹ˆï¼Ÿ</font></h3><h4 id="10-2-1-cli-loop"><a href="#10-2-1-cli-loop" class="headerlink" title="10.2.1Â cli_loop"></a><font size=3>10.2.1Â cli_loop</font></h4><p>æˆ‘ä»¬æŒ‰ç…§ä¸‹è¾¹çš„è¡Œå·åˆ†æï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">cli_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_HUSH_PARSER</span></span><br><span class="line">	parse_file_outer();</span><br><span class="line">	<span class="comment">/* This point is never reached */</span></span><br><span class="line">	<span class="keyword">for</span> (;;);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	cli_simple_loop();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/*CONFIG_SYS_HUSH_PARSER*/</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ–‡ä»¶ include&#x2F;configs&#x2F;mx6_common.h ä¸­æœ‰å®šä¹‰å® CONFIG_SYS_HUSH_PARSERï¼Œè€Œæ­£ç‚¹åŸå­çš„ I.MX6ULL å¼€å‘æ¿é…ç½®å¤´æ–‡ä»¶ mx6ullevk.h é‡Œé¢ä¼šå¼•ç”¨ mx_common.h è¿™ä¸ªå¤´æ–‡ä»¶ï¼Œå› æ­¤å® CONFIG_SYS_HUSH_PARSER æœ‰å®šä¹‰ã€‚  </p>
<p>ç¬¬ 4 è¡Œï¼ˆç¬¬ 205 è¡Œï¼‰ï¼šè°ƒç”¨å‡½æ•° parse_file_outerï¼ˆ10.2.2ä¸­åˆ†æï¼‰ã€‚</p>
<p>ç¬¬ 6 è¡Œï¼ˆç¬¬ 207 è¡Œï¼‰æ˜¯ä¸ªæ­»å¾ªç¯ï¼Œæ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œã€‚  </p>
<h4 id="10-2-2-parse-file-outer-å‡½æ•°"><a href="#10-2-2-parse-file-outer-å‡½æ•°" class="headerlink" title="10.2.2Â parse_file_outer å‡½æ•°"></a><font size=3>10.2.2Â parse_file_outer å‡½æ•°</font></h4><p>å‡½æ•° parse_file_outer å®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;cli_hush.c ä¸­ï¼Œå»æ‰æ¡ä»¶ç¼–è¯‘å†…å®¹ä»¥åçš„å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">parse_file_outer</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> rcode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">in_str</span> <span class="title">input</span>;</span></span><br><span class="line">	setup_file_in_str(&amp;input);</span><br><span class="line">	rcode = parse_stream_outer(&amp;input, FLAG_PARSE_SEMICOLON);</span><br><span class="line">	<span class="keyword">return</span> rcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 5 è¡Œï¼šè°ƒç”¨å‡½æ•° setup_file_in_str åˆå§‹åŒ–å˜é‡ input çš„æˆå‘˜å˜é‡ã€‚</p>
<p>ç¬¬ 6 è¡Œï¼šè°ƒç”¨å‡½æ•° parse_stream_outerï¼ˆ10.2.3ä¸­åˆ†æï¼‰ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ hush shell çš„å‘½ä»¤è§£é‡Šå™¨ï¼Œè´Ÿè´£æ¥æ”¶å‘½ä»¤è¡Œè¾“å…¥ï¼Œç„¶åè§£æå¹¶æ‰§è¡Œç›¸åº”çš„å‘½ä»¤ã€‚</p>
<h4 id="10-2-3-parse-stream-outerå‡½æ•°"><a href="#10-2-3-parse-stream-outerå‡½æ•°" class="headerlink" title="10.2.3Â parse_stream_outerå‡½æ•°"></a><font size=3>10.2.3Â parse_stream_outerå‡½æ•°</font></h4><p>å‡½æ•° parse_stream_outer å®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;cli_hush.cä¸­ï¼Œç²¾ç®€ç‰ˆçš„å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">parse_stream_outer</span><span class="params">(<span class="keyword">struct</span> in_str *inp, <span class="type">int</span> flag)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">p_context</span> <span class="title">ctx</span>;</span></span><br><span class="line">	o_string temp=NULL_O_STRING;</span><br><span class="line">	<span class="type">int</span> rcode;</span><br><span class="line">	<span class="type">int</span> code = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// ä¸­é—´çš„çœç•¥ ... ...</span></span><br><span class="line">		rcode = parse_stream(&amp;temp, &amp;ctx, inp,</span><br><span class="line">		                     flag &amp; FLAG_CONT_ON_NEWLINE ? <span class="number">-1</span> : <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">		<span class="comment">// ä¸­é—´çš„çœç•¥ ......</span></span><br><span class="line">		<span class="keyword">if</span> (rcode != <span class="number">1</span> &amp;&amp; ctx.old_flag == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// ä¸­é—´çš„çœç•¥ ......</span></span><br><span class="line">			run_list(ctx.list_head);</span><br><span class="line">			<span class="comment">// ä¸­é—´çš„çœç•¥ ......</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">		<span class="comment">// ä¸­é—´çš„çœç•¥ ......</span></span><br><span class="line">		&#125;</span><br><span class="line">		b_free(&amp;temp);</span><br><span class="line">		<span class="comment">/* loop on syntax errors, return on EOF */</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (rcode != <span class="number">-1</span> &amp;&amp; !(flag &amp; FLAG_EXIT_FROM_LOOP) &amp;&amp;</span><br><span class="line">	        (inp-&gt;peek != static_peek || b_peek(inp)));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 7 ~ 21 è¡Œï¼šè¿™å‡ è¡Œä¸­çš„do-while å¾ªç¯å°±æ˜¯å¤„ç†è¾“å…¥å‘½ä»¤çš„ã€‚</p>
<p>ç¬¬ 10 è¡Œï¼šè°ƒç”¨å‡½æ•° parse_stream è¿›è¡Œå‘½ä»¤è§£æã€‚  </p>
<p>ç¬¬ 16 è¡Œï¼šè°ƒç”¨ run_list å‡½æ•°æ¥æ‰§è¡Œè§£æå‡ºæ¥çš„å‘½ä»¤ ã€‚</p>
<h4 id="10-2-4-run-list-å‡½æ•°"><a href="#10-2-4-run-list-å‡½æ•°" class="headerlink" title="10.2.4Â run_list å‡½æ•°"></a><font size=3>10.2.4Â run_list å‡½æ•°</font></h4><p>è¯¥å‡½æ•°å®šä¹‰åœ¨ common&#x2F;cli_hush.c æ–‡ä»¶ä¸­ï¼Œå‡½æ•°ä¼šç»è¿‡ä¸€ç³»åˆ—çš„å‡½æ•°è°ƒç”¨ï¼Œæœ€ç»ˆé€šè¿‡è°ƒç”¨ cmd_process å‡½æ•°æ¥å¤„ç†å‘½ä»¤ ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Select which version we will use */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">run_list</span><span class="params">(<span class="keyword">struct</span> pipe *pi)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> rcode=<span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __U_BOOT__</span></span><br><span class="line">	<span class="keyword">if</span> (fake_mode==<span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		rcode = run_list_real(pi);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __U_BOOT__</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* free_pipe_list has the side effect of clearing memory</span></span><br><span class="line"><span class="comment">	 * In the long run that function can be merged with run_list_real,</span></span><br><span class="line"><span class="comment">	 * but doing that now would hobble the debugging effort. */</span></span><br><span class="line">	free_pipe_list(pi,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> rcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 8 è¡Œï¼šrun_list è°ƒç”¨ run_list_real å‡½æ•°ã€‚  </p>
<ul>
<li>run_list_real å‡½æ•°</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/cli_hush.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">run_list_real</span><span class="params">(<span class="keyword">struct</span> pipe *pi)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *save_name = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">// ä¸­é—´çš„çœç•¥ ... ...</span></span><br><span class="line">	<span class="type">int</span> if_code=<span class="number">0</span>, next_if_code=<span class="number">0</span>;  <span class="comment">/* need double-buffer to handle elif */</span></span><br><span class="line">	<span class="comment">// ä¸­é—´çš„çœç•¥ ... ...</span></span><br><span class="line">	rcode = run_pipe_real(pi);</span><br><span class="line">	<span class="comment">// ä¸­é—´çš„çœç•¥ ... ...</span></span><br><span class="line">	<span class="keyword">return</span> rcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 8 è¡Œï¼šrun_list_real å‡½æ•°è°ƒç”¨ run_pipe_real å‡½æ•°ã€‚  </p>
<ul>
<li>run_pipe_real å‡½æ•°</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/cli_hush.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">run_pipe_real</span><span class="params">(<span class="keyword">struct</span> pipe *pi)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> nextin;</span><br><span class="line">	<span class="type">int</span> flag = do_repeat ? CMD_FLAG_REPEAT : <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">child_prog</span> *<span class="title">child</span>;</span></span><br><span class="line">	<span class="type">char</span> *p;</span><br><span class="line">	<span class="comment">// ä¸­é—´çš„çœç•¥ ... ...</span></span><br><span class="line">	<span class="keyword">if</span> (pi-&gt;num_progs == <span class="number">1</span>) child = &amp; (pi-&gt;progs[<span class="number">0</span>]);</span><br><span class="line">	<span class="comment">// ä¸­é—´çš„çœç•¥ ... ...</span></span><br><span class="line">	<span class="keyword">return</span> rcode;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (pi-&gt;num_progs == <span class="number">1</span> &amp;&amp; pi-&gt;progs[<span class="number">0</span>].argv != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// ä¸­é—´çš„çœç•¥ ... ...</span></span><br><span class="line">		<span class="comment">/* Process the command */</span></span><br><span class="line">		<span class="keyword">return</span> cmd_process(flag, child-&gt;argc, child-&gt;argv,</span><br><span class="line">						   &amp;flag_repeat, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 19 è¡Œï¼šrun_pipe_real å‡½æ•°è°ƒç”¨ cmd_process å‡½æ•°ã€‚  </p>
<h2 id="11-cmd-process-å‡½æ•°"><a href="#11-cmd-process-å‡½æ•°" class="headerlink" title="11.Â cmd_process å‡½æ•°"></a><font size=3>11.Â cmd_process å‡½æ•°</font></h2><p>æˆ‘ä»¬åœ¨ubootä¸­ä½¿ç”¨çš„å‘½ä»¤ï¼Œæ˜¯é€šè¿‡è¯¥å‡½æ•°è¿›è¡Œè§£æå’Œæ‰§è¡Œçš„ã€‚</p>
<h3 id="11-1-å‘½ä»¤çš„å®šä¹‰ä¸æ‰§è¡Œ"><a href="#11-1-å‘½ä»¤çš„å®šä¹‰ä¸æ‰§è¡Œ" class="headerlink" title="11.1 å‘½ä»¤çš„å®šä¹‰ä¸æ‰§è¡Œ"></a><font size=3>11.1 å‘½ä»¤çš„å®šä¹‰ä¸æ‰§è¡Œ</font></h3><h4 id="11-1-1-ç›¸å…³å®å®šä¹‰"><a href="#11-1-1-ç›¸å…³å®å®šä¹‰" class="headerlink" title="11.1.1 ç›¸å…³å®å®šä¹‰"></a><font size=3>11.1.1 ç›¸å…³å®å®šä¹‰</font></h4><p>ubootä½¿ç”¨å®U_BOOT_CMDæ¥å®šä¹‰å‘½ä»¤ï¼Œå® U_BOOT_CMD å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;command.h ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_CMD(_name, _maxargs, _rep, _cmd, _usage, _help)		\</span></span><br><span class="line"><span class="meta">	U_BOOT_CMD_COMPLETE(_name, _maxargs, _rep, _cmd, _usage, _help, NULL)</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡º U_BOOT_CMD æ˜¯ U_BOOT_CMD_COMPLETE çš„ ç‰¹ ä¾‹ ï¼Œ æˆ‘ä»¬å°†U_BOOT_CMD_COMPLETE çš„æœ€åä¸€ä¸ªå‚æ•°è®¾ç½®æˆNULL å°±æ˜¯ U_BOOT_CMDã€‚U_BOOT_CMD_COMPLETE å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;command.h ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_CMD_COMPLETE(_name, _maxargs, _rep, _cmd, _usage, _help, _comp) \</span></span><br><span class="line"><span class="meta">	ll_entry_declare(cmd_tbl_t, _name, cmd) =			\</span></span><br><span class="line"><span class="meta">		U_BOOT_CMD_MKENT_COMPLETE(_name, _maxargs, _rep, _cmd,	\</span></span><br><span class="line"><span class="meta">						_usage, _help, _comp);</span></span><br></pre></td></tr></table></figure>

<p>å® U_BOOT_CMD_COMPLETE åˆ ç”¨ åˆ° äº† ll_entry_declare å’Œ U_BOOT_CMD_MKENT_COMPLETEã€‚ ll_entry_declar å®šä¹‰åœ¨æ–‡ä»¶include&#x2F;linker_lists.h ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ll_entry_declare(_type, _name, _list)				\</span></span><br><span class="line"><span class="meta">	_type _u_boot_list_2_##_list##_2_##_name __aligned(4)		\</span></span><br><span class="line"><span class="meta">			__attribute__((unused,				\</span></span><br><span class="line"><span class="meta">			section(<span class="string">&quot;.u_boot_list_2_&quot;</span>#_list<span class="string">&quot;_2_&quot;</span>#_name)))</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­_type ä¸º cmd_tbl_tï¼Œå› æ­¤ ll_entry_declare å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ª cmd_tbl_t å˜é‡ï¼Œè¿™é‡Œç”¨åˆ°äº† C è¯­è¨€ä¸­çš„â€œ##â€è¿æ¥ç¬¦ã€‚å…¶ä¸­çš„â€œ##_listâ€è¡¨ç¤ºç”¨_list çš„å€¼æ¥æ›¿æ¢ï¼Œâ€œ##_nameâ€å°±æ˜¯ç”¨_name çš„å€¼æ¥æ›¿æ¢ã€‚  </p>
<p>å® U_BOOT_CMD_MKENT_COMPLETE å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;command.h ä¸­ï¼Œå†…å®¹å¦‚ä¸‹ï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> U_BOOT_CMD_MKENT_COMPLETE(_name, _maxargs, _rep, _cmd,		\</span></span><br><span class="line"><span class="meta">				_usage, _help, _comp)			\</span></span><br><span class="line"><span class="meta">		&#123; #_name, _maxargs, _rep, _cmd, _usage,			\</span></span><br><span class="line"><span class="meta">			_CMD_HELP(_help) _CMD_COMPLETE(_comp) &#125;</span></span><br></pre></td></tr></table></figure>

<p>â€œ # â€ è¡¨ ç¤º å°† _name ä¼ é€’è¿‡æ¥çš„å€¼å­—ç¬¦ä¸²åŒ– ï¼ŒU_BOOT_CMD_MKENT_COMPLETE åˆç”¨åˆ°äº†å®_CMD_HELP å’Œ_CMD_COMPLETEï¼Œè¿™ä¸¤ä¸ªå®çš„å®šä¹‰ï¼ˆinclude&#x2F;command.hï¼‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AUTO_COMPLETE</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _CMD_COMPLETE(x) x,</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _CMD_COMPLETE(x)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_LONGHELP</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _CMD_HELP(x) x,</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _CMD_HELP(x)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœå®šä¹‰äº†å® CONFIG_AUTO_COMPLETE å’Œ CONFIG_SYS_LONGHELP çš„è¯ ï¼Œ _CMD_COMPLETE å’Œ _CMD_HELP å°±æ˜¯å–è‡ªèº«çš„å€¼ï¼Œç„¶ååœ¨åŠ ä¸Šä¸€ä¸ª â€˜ , â€™ã€‚  CONFIG_AUTO_COMPLETE å’Œ CONFIG_SYS_LONGHELP è¿™ä¸¤ä¸ªå®æœ‰å®šä¹‰åœ¨æ–‡ä»¶ mx6_common.h ä¸­ã€‚  </p>
<h4 id="11-1-2-å‘½ä»¤å®ä¾‹"><a href="#11-1-2-å‘½ä»¤å®ä¾‹" class="headerlink" title="11.1.2 å‘½ä»¤å®ä¾‹"></a><font size=3>11.1.2 å‘½ä»¤å®ä¾‹</font></h4><p>U_BOOT_CMDå®çš„æµç¨‹å¤§æ¦‚æˆ‘ä»¬å·²ç»æ¸…æ¥šäº†ï¼Œæˆ‘ä»¬å°±ä»¥ä¸€ä¸ªå…·ä½“çš„å‘½ä»¤ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹ U_BOOT_CMD ç»è¿‡å±•å¼€ä»¥åç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆæ¨¡æ ·çš„ã€‚ä»¥å‘½ä»¤ dhcp ä¸ºä¾‹ï¼Œ dhcp å‘½ä»¤å®šä¹‰åœ¨ cmd&#x2F;net.c æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">U_BOOT_CMD(</span><br><span class="line">	dhcp,	<span class="number">3</span>,	<span class="number">1</span>,	do_dhcp,</span><br><span class="line">	<span class="string">&quot;boot image via network using DHCP/TFTP protocol&quot;</span>,</span><br><span class="line">	<span class="string">&quot;[loadAddress] [[hostIPaddr:]bootfilename]&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>  æˆ‘ä»¬å°†è¿™ä¸ªå‘½ä»¤è¿›è¡Œä¸€ä¸ªå±•å¼€ï¼š</p>
<ul>
<li>å°† U_BOOT_CMD å±•å¼€</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">U_BOOT_CMD_COMPLETE(dhcp, <span class="number">3</span>, <span class="number">1</span>, do_dhcp,</span><br><span class="line">                    <span class="string">&quot;boot image via network using DHCP/TFTP protocol&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;[loadAddress] [[hostIPaddr:]bootfilename]&quot;</span>,</span><br><span class="line">                    <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>å°† U_BOOT_CMD_COMPLETE å±•å¼€</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ll_entry_declare(<span class="type">cmd_tbl_t</span>, dhcp, cmd) = \</span><br><span class="line">        U_BOOT_CMD_MKENT_COMPLETE(dhcp, <span class="number">3</span>, <span class="number">1</span>, do_dhcp, \</span><br><span class="line">                                  <span class="string">&quot;boot image via network using DHCP/TFTP protocol&quot;</span>, \</span><br><span class="line">                                  <span class="string">&quot;[loadAddress] [[hostIPaddr:]bootfilename]&quot;</span>, \</span><br><span class="line">                                  <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>å°† ll_entry_declare å’Œ U_BOOT_CMD_MKENT_COMPLETE å±•å¼€</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">cmd_tbl_t</span> _u_boot_list_2_cmd_2_dhcp __aligned(<span class="number">4</span>) \</span><br><span class="line">__attribute__((unused,section(.u_boot_list_2_cmd_2_dhcp))) \</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;dhcp&quot;</span>, <span class="number">3</span>, <span class="number">1</span>, do_dhcp, \</span><br><span class="line">	<span class="string">&quot;boot image via network using DHCP/TFTP protocol&quot;</span>, \</span><br><span class="line">	<span class="string">&quot;[loadAddress] [[hostIPaddr:]bootfilename]&quot;</span>,\</span><br><span class="line">	<span class="literal">NULL</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼Œdhcp å‘½ä»¤å±•å¼€åï¼Œæœ€ç»ˆå½¢å¼ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">cmd_tbl_t</span> _u_boot_list_2_cmd_2_dhcp __aligned(<span class="number">4</span>) \</span><br><span class="line">__attribute__((unused,section(.u_boot_list_2_cmd_2_dhcp))) \</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;dhcp&quot;</span>, <span class="number">3</span>, <span class="number">1</span>, do_dhcp, \</span><br><span class="line">	<span class="string">&quot;boot image via network using DHCP/TFTP protocol&quot;</span>, \</span><br><span class="line">	<span class="string">&quot;[loadAddress] [[hostIPaddr:]bootfilename]&quot;</span>,\</span><br><span class="line">	<span class="literal">NULL</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 1 è¡Œï¼šå®šä¹‰äº†ä¸€ä¸ª cmd_tbl_t ç±»å‹çš„å˜é‡ï¼Œå˜é‡åä¸º_u_boot_list_2_cmd_2_dhcpï¼Œæ­¤å˜é‡ 4 å­—èŠ‚å¯¹é½ã€‚  </p>
<p>ç¬¬ 2 è¡Œ ï¼šä½¿ ç”¨ __attribute__ å…³é”®å­—è®¾ç½®å˜é‡ _u_boot_list_2_cmd_2_dhcp å­˜å‚¨åœ¨ .u_boot_list_2_cmd_2_dhcp æ®µä¸­ã€‚u-boot.lds é“¾æ¥è„šæœ¬ä¸­æœ‰ä¸€ä¸ªåä¸ºâ€œ.u_boot_listâ€çš„æ®µï¼Œæ‰€æœ‰.u_boot_list å¼€å¤´çš„æ®µéƒ½å­˜æ”¾åˆ°.u_boot.list ä¸­ï¼Œæ‰€ä»¥ç¬¬ 2 è¡Œ å°±æ˜¯è®¾ç½®å˜é‡_u_boot_list_2_cmd_2_dhcp çš„å­˜å‚¨ä½ç½®ã€‚  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/image-20221016113057647.png" alt="image-20221016113057647" style="zoom: 50%;" />

<p>ç¬¬ 3~6 è¡Œï¼š cmd_tbl_t æ˜¯ä¸ªç»“æ„ä½“ï¼Œå› æ­¤ç¬¬ 3 ~ 6 è¡Œæ˜¯åˆå§‹åŒ– cmd_tbl_t è¿™ä¸ªç»“æ„ä½“çš„å„ä¸ªæˆå‘˜å˜é‡ã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ cmd_tbl_t ç»“æ„ä½“æˆå‘˜ </summary>
              <div class='content'>
              <p>cmd_tbl_t ç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;command.h ä¸­ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmd_tbl_s</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">char</span>	*name;		<span class="comment">/* Command Name			*/</span></span><br><span class="line">	<span class="type">int</span>		maxargs;	<span class="comment">/* maximum number of arguments	*/</span></span><br><span class="line">	<span class="type">int</span>		repeatable;	<span class="comment">/* autorepeat allowed?		*/</span></span><br><span class="line">	<span class="comment">/* Implementation function	*/</span></span><br><span class="line">	<span class="type">int</span>		(*cmd)(<span class="keyword">struct</span> cmd_tbl_s *, <span class="type">int</span>, <span class="type">int</span>, <span class="type">char</span> * <span class="type">const</span> []);</span><br><span class="line">	<span class="type">char</span>	*usage;		<span class="comment">/* Usage message	(short)	*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>	CONFIG_SYS_LONGHELP</span></span><br><span class="line">	<span class="type">char</span>	*help;		<span class="comment">/* Help  message	(long)	*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AUTO_COMPLETE</span></span><br><span class="line">	<span class="comment">/* do auto completion on the arguments */</span></span><br><span class="line">	<span class="type">int</span>		(*complete)(<span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[], <span class="type">char</span> last_char, <span class="type">int</span> maxv, <span class="type">char</span> *cmdv[]);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">cmd_tbl_s</span>	<span class="title">cmd_tbl_t</span>;</span></span><br></pre></td></tr></table></figure><p>ç»“åˆ dhcp å‘½ä»¤å±•å¼€åçš„æœ€ç»ˆå½¢å¼ï¼Œå¯ä»¥å¾—å‡ºå˜é‡_u_boot_list_2_cmd_2_dhcp çš„å„ä¸ªæˆå‘˜çš„å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_u_boot_list_2_cmd_2_dhcp.name = <span class="string">&quot;dhcp&quot;</span></span><br><span class="line">_u_boot_list_2_cmd_2_dhcp.maxargs = <span class="number">3</span></span><br><span class="line">_u_boot_list_2_cmd_2_dhcp.repeatable = <span class="number">1</span></span><br><span class="line">_u_boot_list_2_cmd_2_dhcp.cmd = do_dhcp</span><br><span class="line">_u_boot_list_2_cmd_2_dhcp.usage = <span class="string">&quot;boot image via network using DHCP/TFTP protocol&quot;</span></span><br><span class="line">_u_boot_list_2_cmd_2_dhcp.help = <span class="string">&quot;[loadAddress] [[hostIPaddr:]bootfilename]&quot;</span></span><br><span class="line">_u_boot_list_2_cmd_2_dhcp.complete = <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
              </div>
            </details>

<h4 id="11-2-3-å‘½ä»¤æ‰§è¡Œ"><a href="#11-2-3-å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="11.2.3 å‘½ä»¤æ‰§è¡Œ"></a><font size=3>11.2.3 å‘½ä»¤æ‰§è¡Œ</font></h4><p>å‰è¾¹æˆ‘ä»¬å·²ç»åˆ†æäº†åœ¨ubootä¸­æ˜¯å¦‚ä½•å®šä¹‰ä¸€ä¸ªå‘½ä»¤çš„ï¼Œé‚£å½“æˆ‘ä»¬åœ¨ uboot çš„å‘½ä»¤è¡Œä¸­è¾“å…¥â€œdhcpâ€è¿™ä¸ªå‘½ä»¤çš„æ—¶å€™ï¼Œæ˜¯æ€ä¹ˆæ‰§è¡Œçš„å‘¢ï¼Ÿå…¶å®æœ€ç»ˆæ‰§è¡Œçš„æ˜¯ do_dhcp è¿™ä¸ªå‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_dhcp</span><span class="params">(<span class="type">cmd_tbl_t</span> *cmdtp, <span class="type">int</span> flag, <span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> netboot_common(DHCP, cmdtp, argc, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­å®é™…ä¸Šæ˜¯è°ƒç”¨äº† netboot_common å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨ cmd&#x2F;net.c ä¸­ï¼Œå…·ä½“æ€ä¹ˆæ‰§è¡Œçš„ï¼Œè¿™é‡Œæˆ‘å°±æ²¡æœ‰å»äº†è§£äº†ã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œuboot ä¸­ä½¿ç”¨ U_BOOT_CMD æ¥å®šä¹‰ä¸€ä¸ªå‘½ä»¤ï¼Œæœ€ç»ˆçš„ç›®çš„å°±æ˜¯ä¸ºäº†å®šä¹‰ä¸€ä¸ª cmd_tbl_t ç±»å‹çš„å˜é‡ï¼Œå¹¶åˆå§‹åŒ–è¿™ä¸ªå˜é‡çš„å„ä¸ªæˆå‘˜ã€‚ uboot ä¸­çš„æ¯ä¸ªå‘½ä»¤éƒ½å­˜å‚¨åœ¨.u_boot_list æ®µä¸­ï¼Œæ¯ä¸ªå‘½ä»¤éƒ½æœ‰ä¸€ä¸ªåä¸º do_xxx(xxx ä¸ºå…·ä½“çš„å‘½ä»¤å)çš„å‡½æ•°ï¼Œè¿™ä¸ª do_xxx å‡½æ•°å°±æ˜¯å…·ä½“çš„å‘½ä»¤å¤„ç†å‡½æ•°ã€‚  </p>
<h3 id="11-2-cmd-process-å‡½æ•°åœ¨å“ªï¼Ÿ"><a href="#11-2-cmd-process-å‡½æ•°åœ¨å“ªï¼Ÿ" class="headerlink" title="11.2Â cmd_process å‡½æ•°åœ¨å“ªï¼Ÿ"></a><font size=3>11.2Â cmd_process å‡½æ•°åœ¨å“ªï¼Ÿ</font></h3><p>cmd_process å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ common&#x2F;command.c ä¸­ï¼Œå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="type">command_ret_t</span> <span class="title function_">cmd_process</span><span class="params">(<span class="type">int</span> flag, <span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[],</span></span><br><span class="line"><span class="params">			       <span class="type">int</span> *repeatable, ulong *ticks)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">command_ret_t</span> <span class="title">rc</span> =</span> CMD_RET_SUCCESS;</span><br><span class="line">	<span class="type">cmd_tbl_t</span> *cmdtp;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Look up command in command table */</span></span><br><span class="line">	cmdtp = find_cmd(argv[<span class="number">0</span>]);</span><br><span class="line">	<span class="keyword">if</span> (cmdtp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Unknown command &#x27;%s&#x27; - try &#x27;help&#x27;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* found - check max args */</span></span><br><span class="line">	<span class="keyword">if</span> (argc &gt; cmdtp-&gt;maxargs)</span><br><span class="line">		rc = CMD_RET_USAGE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_BOOTD)</span></span><br><span class="line">	<span class="comment">/* avoid &quot;bootd&quot; recursion */</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (cmdtp-&gt;cmd == do_bootd) &#123;</span><br><span class="line">		<span class="keyword">if</span> (flag &amp; CMD_FLAG_BOOTD) &#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;&#x27;bootd&#x27; recursion detected\n&quot;</span>);</span><br><span class="line">			rc = CMD_RET_FAILURE;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			flag |= CMD_FLAG_BOOTD;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If OK so far, then do the command */</span></span><br><span class="line">	<span class="keyword">if</span> (!rc) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ticks)</span><br><span class="line">			*ticks = get_timer(<span class="number">0</span>);</span><br><span class="line">		rc = cmd_call(cmdtp, flag, argc, argv);</span><br><span class="line">		<span class="keyword">if</span> (ticks)</span><br><span class="line">			*ticks = get_timer(*ticks);</span><br><span class="line">		*repeatable &amp;= cmdtp-&gt;repeatable;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (rc == CMD_RET_USAGE)</span><br><span class="line">		rc = cmd_usage(cmdtp);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-3-åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#11-3-åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="11.3 åšäº†ä»€ä¹ˆï¼Ÿ"></a><font size=3>11.3 åšäº†ä»€ä¹ˆï¼Ÿ</font></h3><p>æˆ‘ä»¬æŒ‰ç…§ä¸‹è¾¹çš„è¡Œå·åˆ†æï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="type">command_ret_t</span> <span class="title function_">cmd_process</span><span class="params">(<span class="type">int</span> flag, <span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[],</span></span><br><span class="line"><span class="params">			       <span class="type">int</span> *repeatable, ulong *ticks)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">command_ret_t</span> <span class="title">rc</span> =</span> CMD_RET_SUCCESS;</span><br><span class="line">	<span class="type">cmd_tbl_t</span> *cmdtp;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Look up command in command table */</span></span><br><span class="line">	cmdtp = find_cmd(argv[<span class="number">0</span>]);</span><br><span class="line">	<span class="keyword">if</span> (cmdtp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Unknown command &#x27;%s&#x27; - try &#x27;help&#x27;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* found - check max args */</span></span><br><span class="line">	<span class="keyword">if</span> (argc &gt; cmdtp-&gt;maxargs)</span><br><span class="line">		rc = CMD_RET_USAGE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_BOOTD)</span></span><br><span class="line">	<span class="comment">/* avoid &quot;bootd&quot; recursion */</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (cmdtp-&gt;cmd == do_bootd) &#123;</span><br><span class="line">		<span class="keyword">if</span> (flag &amp; CMD_FLAG_BOOTD) &#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;&#x27;bootd&#x27; recursion detected\n&quot;</span>);</span><br><span class="line">			rc = CMD_RET_FAILURE;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			flag |= CMD_FLAG_BOOTD;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If OK so far, then do the command */</span></span><br><span class="line">	<span class="keyword">if</span> (!rc) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ticks)</span><br><span class="line">			*ticks = get_timer(<span class="number">0</span>);</span><br><span class="line">		rc = cmd_call(cmdtp, flag, argc, argv);</span><br><span class="line">		<span class="keyword">if</span> (ticks)</span><br><span class="line">			*ticks = get_timer(*ticks);</span><br><span class="line">		*repeatable &amp;= cmdtp-&gt;repeatable;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (rc == CMD_RET_USAGE)</span><br><span class="line">		rc = cmd_usage(cmdtp);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 8 è¡Œï¼ˆç¬¬ 507 è¡Œï¼‰ï¼šè°ƒç”¨å‡½æ•° find_cmd åœ¨å‘½ä»¤è¡¨ä¸­æ‰¾åˆ°æŒ‡å®šçš„å‘½ä»¤ã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ find_cmd å‡½æ•° </summary>
              <div class='content'>
              <p>å‡½æ•°å®šä¹‰åœ¨ common&#x2F;command.c æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">cmd_tbl_t</span> *<span class="title function_">find_cmd</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">cmd_tbl_t</span> *start = ll_entry_start(<span class="type">cmd_tbl_t</span>, cmd);</span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> len = ll_entry_count(<span class="type">cmd_tbl_t</span>, cmd);</span><br><span class="line">	<span class="keyword">return</span> find_cmd_tbl(cmd, start, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•° cmd å°±æ˜¯æ‰€æŸ¥æ‰¾çš„å‘½ä»¤åå­—ï¼Œ uboot ä¸­çš„å‘½ä»¤è¡¨å…¶å®å°±æ˜¯ cmd_tbl_t ç»“æ„ä½“æ•°ç»„ï¼Œé€šè¿‡å‡½æ•° ll_entry_start å¾—åˆ°æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤è¡¨èµ·å§‹åœ°å€ã€‚é€šè¿‡å‡½æ•° ll_entry_count å¾—åˆ°æ•°ç»„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤è¡¨çš„é•¿åº¦ã€‚æœ€ç»ˆé€šè¿‡å‡½æ•° find_cmd_tbl åœ¨å‘½ä»¤è¡¨ä¸­æ‰¾åˆ°æ‰€éœ€çš„å‘½ä»¤ï¼Œæ¯ä¸ªå‘½ä»¤éƒ½æœ‰ä¸€ä¸ª name æˆå‘˜ï¼Œæ‰€ä»¥å°†å‚æ•° cmd ä¸å‘½ä»¤è¡¨ä¸­æ¯ä¸ªæˆå‘˜çš„ name å­—æ®µéƒ½å¯¹æ¯”ä¸€ä¸‹ï¼Œå¦‚æœç›¸ç­‰çš„è¯å°±è¯´æ˜æ‰¾åˆ°äº†è¿™ä¸ªå‘½ä»¤ï¼Œæ‰¾åˆ°ä»¥åå°±è¿”å›è¿™ä¸ªå‘½ä»¤ã€‚  </p>
              </div>
            </details>  

<p>ç¬¬ 34 è¡Œï¼ˆç¬¬ 533 è¡Œï¼‰ï¼šå½“ find_cmd æ‰¾åˆ°ç›¸åº”å‘½ä»¤åï¼Œå°±ä¼šè°ƒç”¨å‡½æ•° cmd_call æ¥æ‰§è¡Œå…·ä½“çš„å‘½ä»¤ ã€‚</p>
<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ cmd_call å‡½æ•° </summary>
              <div class='content'>
              <p>è¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨ common&#x2F;command.c ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Call a command function. This should be the only route in U-Boot to call</span></span><br><span class="line"><span class="comment"> * a command, so that we can track whether we are waiting for input or</span></span><br><span class="line"><span class="comment"> * executing a command.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param cmdtp		Pointer to the command to execute</span></span><br><span class="line"><span class="comment"> * @param flag		Some flags normally 0 (see CMD_FLAG_.. above)</span></span><br><span class="line"><span class="comment"> * @param argc		Number of arguments (arg 0 must be the command text)</span></span><br><span class="line"><span class="comment"> * @param argv		Arguments</span></span><br><span class="line"><span class="comment"> * @return 0 if command succeeded, else non-zero (CMD_RET_...)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_call</span><span class="params">(<span class="type">cmd_tbl_t</span> *cmdtp, <span class="type">int</span> flag, <span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result;</span><br><span class="line"></span><br><span class="line">	result = (cmdtp-&gt;cmd)(cmdtp, flag, argc, argv);</span><br><span class="line">	<span class="keyword">if</span> (result)</span><br><span class="line">		debug(<span class="string">&quot;Command failed, result=%d\n&quot;</span>, result);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‰é¢çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“ï¼Œ cmd_tbl_t çš„ cmd æˆå‘˜å°±æ˜¯å…·ä½“çš„å‘½ä»¤å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥ç¬¬ 16 è¡Œï¼ˆç¬¬ 494 è¡Œï¼‰è°ƒç”¨ cmdtp çš„ cmd æˆå‘˜æ¥å¤„ç†å…·ä½“çš„å‘½ä»¤ï¼Œè¿”å›å€¼ä¸ºå‘½ä»¤çš„æ‰§è¡Œç»“æœã€‚  </p>
              </div>
            </details>

<p>ç¬¬ 39 è¡Œï¼ˆç¬¬ 538 è¡Œï¼‰ï¼šcmd_process ä¸­ä¼šæ£€æµ‹ cmd_tbl çš„è¿”å›å€¼ï¼Œå¦‚æœè¿”å›å€¼ä¸º CMD_RET_USAGE çš„è¯å°±ä¼šè°ƒç”¨ cmd_usage å‡½æ•°è¾“å‡ºå‘½ä»¤çš„ç”¨æ³•ï¼Œå…¶å®å°±æ˜¯è¾“å‡º cmd_tbl_t çš„ usage æˆå‘˜å˜é‡ã€‚  </p>
<h1 id="ä¸‰ã€ubootå¯åŠ¨æ€»ç»“"><a href="#ä¸‰ã€ubootå¯åŠ¨æ€»ç»“" class="headerlink" title="ä¸‰ã€ubootå¯åŠ¨æ€»ç»“"></a><font size=3>ä¸‰ã€ubootå¯åŠ¨æ€»ç»“</font></h1><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/LV05-01-uboot-04-uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/img/uboot_start-169061995797628.png" alt="uboot_start" style="zoom:50%;" />


    </div>

    
    
    

    <footer class="post-footer">




    <div>
        
            <div style="text-align:center;color: #ccc;font-size:14px;">
            ----------æœ¬æ–‡ç»“æŸ
            <i class="fas fa-fan fa-spin" style="color: #FF1493; font-size: 1rem"></i>
            æ„Ÿè°¢æ‚¨çš„é˜…è¯»----------
            </div>
        
    </div>





  
  <div class="my_post_copyright"> 
    <p><span>æ–‡ç« æ ‡é¢˜:</span><a href="/post/e99b9cbc.html">LV05-01-uboot-04-ubootå¯åŠ¨æµç¨‹</a></p>
    <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="æ¬¢è¿è®¿é—® ã€Šè‹æœ¨ã€‹ çš„å­¦ä¹ ç¬”è®°">è‹æœ¨</a></p>
    <p><span>å‘å¸ƒæ—¶é—´:</span>2023å¹´09æœˆ08æ—¥ - 19:22</p>
    <p><span>æœ€åæ›´æ–°:</span>2025å¹´06æœˆ14æ—¥ - 00:25</p>
    <p><span>åŸå§‹é“¾æ¥:</span><a href="/post/e99b9cbc.html" title="LV05-01-uboot-04-ubootå¯åŠ¨æµç¨‹">https://sumumm.github.io/post/e99b9cbc.html</a></p>
    <p><span>è®¸å¯åè®®:</span><i class="fab fa-creative-commons"></i> <a rel="license" href= "https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>  
  </div>
  


          <div class="post-tags">
              <a href="/tags/ALPHA-LV05-uboot%E4%B8%8E%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> (ALPHA)LV05-ubootä¸å†…æ ¸</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/a7c5ba62.html" rel="prev" title="LV05-01-uboot-05-ubootå¯åŠ¨å†…æ ¸">
                  <i class="fa fa-angle-left"></i> LV05-01-uboot-05-ubootå¯åŠ¨å†…æ ¸
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/d56430c4.html" rel="next" title="LV05-01-uboot-03-ubootç›¸å…³å‘½ä»¤">
                  LV05-01-uboot-03-ubootç›¸å…³å‘½ä»¤ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">è‹æœ¨</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">3.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">225:26</span>
  </span>
</div>




    <span id="sitetime"></span>
    <script defer language=javascript>
        function siteTime()
        {
            window.setTimeout("siteTime()", 1000);
            var seconds = 1000;
            var minutes = seconds * 60;
            var hours = minutes * 60;
            var days = hours * 24;
            var years = days * 365;
            var today = new Date();
            var todayYear = today.getFullYear();
            var todayMonth = today.getMonth()+1;
            var todayDate = today.getDate();
            var todayHour = today.getHours();
            var todayMinute = today.getMinutes();
            var todaySecond = today.getSeconds();
            /*==================================================
            Date.UTC() -- è¿”å›dateå¯¹è±¡è·ä¸–ç•Œæ ‡å‡†æ—¶é—´(UTC)1970å¹´1æœˆ1æ—¥åˆå¤œä¹‹é—´çš„æ¯«ç§’æ•°(æ—¶é—´æˆ³)
            year        - ä½œä¸ºdateå¯¹è±¡çš„å¹´ä»½ï¼Œä¸º4ä½å¹´ä»½å€¼
            month       - 0-11ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æœˆä»½
            day         - 1-31ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å¤©æ•°
            hours       - 0(åˆå¤œ24ç‚¹)-23ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å°æ—¶æ•°
            minutes     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„åˆ†é’Ÿæ•°
            seconds     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„ç§’æ•°
            microseconds - 0-999ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æ¯«ç§’æ•°
            ==================================================*/
            var t1 = Date.UTC(2017, 
                              5, 
                              19, 
                              0, 
                              0, 
                              0); //åŒ—äº¬æ—¶é—´
            var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
            var diff = t2-t1;
            var diffYears = Math.floor(diff/years);
            var diffDays = Math.floor((diff/days)-diffYears*365);
            var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
            var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
            var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
            document.getElementById("sitetime").innerHTML="å·²åœ¨è¿™é‡Œ "+diffYears+" å¹´ "+diffDays+" å¤© "+diffHours+" å°æ—¶ "+diffMinutes+" åˆ†é’Ÿ "+diffSeconds+" ç§’";
        }
        siteTime();
    </script>



    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


 
        <div id="click-show-text"
            data-mobile = false
            data-text = å¯Œå¼º,æ°‘ä¸»,æ–‡æ˜,å’Œè°,è‡ªç”±,å¹³ç­‰,å…¬æ­£,æ³•åˆ¶,çˆ±å›½,æ•¬ä¸š,è¯šä¿¡,å‹å–„
            data-fontsize = 15px
            data-random= false>
        </div>
       

      
        <script async src=https://cdn.jsdelivr.net/npm/hexo-next-mouse-effect@latest/click/showText.js></script>
      

      
    




    <script async src="/js/fancybox_param.js"></script>





<!-- APlayeræœ¬ä½“ -->



</body>
</html>
