<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/green/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"sumumm.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":300},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="æœ¬æ–‡ä¸»è¦æ˜¯kernelâ€”â€”openæºç è§£æçš„ç›¸å…³ç¬”è®°ï¼Œè‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="LV05-03-Kernel-05-03-02-openå‡½æ•°è§£æ1">
<meta property="og:url" content="https://sumumm.github.io/post/9cc69d79.html">
<meta property="og:site_name" content="è‹æœ¨">
<meta property="og:description" content="æœ¬æ–‡ä¸»è¦æ˜¯kernelâ€”â€”openæºç è§£æçš„ç›¸å…³ç¬”è®°ï¼Œè‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/image-20241214153842041.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/image-20241214155242924.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/image-20241214214800378.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/image-20241214223720583.png">
<meta property="article:published_time" content="2024-12-17T15:25:18.000Z">
<meta property="article:modified_time" content="2025-06-13T16:25:57.045Z">
<meta property="article:author" content="è‹æœ¨">
<meta property="article:tag" content="LV05-ç³»ç»Ÿé•œåƒ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/image-20241214153842041.png">


<link rel="canonical" href="https://sumumm.github.io/post/9cc69d79.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":"","permalink":"https://sumumm.github.io/post/9cc69d79.html","path":"post/9cc69d79.html","title":"LV05-03-Kernel-05-03-02-openå‡½æ•°è§£æ1"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LV05-03-Kernel-05-03-02-openå‡½æ•°è§£æ1 | è‹æœ¨</title>
  








    <script src="/js/browser_tools_disable.js"></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.com/hexo-next-tags-plus@latest/lib/tag_plus.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">è‹æœ¨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">æˆ‘çš„å­¦ä¹ ä¹‹è·¯</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>è‹æœ¨çš„å®¶</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»é¡µ<span class="badge">42</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£é¡µ<span class="badge">673</span></a></li><li class="menu-item menu-item-flink"><a href="/flink/" rel="section"><i class="fa fa-link fa-fw"></i>å‹äººå¸</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äºæˆ‘</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="nav-text">ä¸€ã€ä¸€ä¸ªå®ä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%B5%8B%E8%AF%95demo"><span class="nav-text">1. æµ‹è¯•demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9F"><span class="nav-text">2. ç³»ç»Ÿè°ƒç”¨ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81open%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">äºŒã€openæºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8openat"><span class="nav-text">1. ç³»ç»Ÿè°ƒç”¨openat()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-do-sys-open"><span class="nav-text">2.Â do_sys_open()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-build-open-flags"><span class="nav-text">2.1Â build_open_flags()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-get-unused-fd-flags"><span class="nav-text">2.2Â get_unused_fd_flags()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-do-filp-open"><span class="nav-text">3.Â do_filp_open()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-path-openat"><span class="nav-text">4.Â path_openat()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-path-init"><span class="nav-text">4.1Â path_init()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-set-root"><span class="nav-text">4.1.1Â set_root()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-nd-jump-root"><span class="nav-text">4.1.2Â nd_jump_root()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-link-path-walk"><span class="nav-text">4.2Â link_path_walk()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-walk-component"><span class="nav-text">4.2.1Â walk_component()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E6%80%BB%E7%BB%93"><span class="nav-text">4.3 æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-do-last"><span class="nav-text">5.Â do_last()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-complete-walk"><span class="nav-text">5.1Â complete_walk()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-1-legitimize-links"><span class="nav-text">5.1.1Â legitimize_links()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-2-legitimize-path"><span class="nav-text">5.1.2Â legitimize_path()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-3-%E6%80%BB%E7%BB%93"><span class="nav-text">5.1.3 æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-audit-inode"><span class="nav-text">5.2Â audit_inode()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-may-open"><span class="nav-text">5.3Â may_open()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-%E6%80%BB%E7%BB%93"><span class="nav-text">5.4Â æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-vfs-open"><span class="nav-text">6.Â vfs_open()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-do-dentry-open"><span class="nav-text">6.1 do_dentry_open()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%90%84%E4%B8%AA%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E"><span class="nav-text">7. å„ä¸ªå‡½æ•°è¿”å›</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E6%80%BB%E7%BB%93"><span class="nav-text">8. æ€»ç»“</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="è‹æœ¨"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">è‹æœ¨</p>
  <div class="site-description" itemprop="description">è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">673</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/sumumm" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;sumumm" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sumumm.github.io/post/9cc69d79.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="è‹æœ¨">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹æœ¨">
      <meta itemprop="description" content="è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="LV05-03-Kernel-05-03-02-openå‡½æ•°è§£æ1 | è‹æœ¨">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LV05-03-Kernel-05-03-02-openå‡½æ•°è§£æ1
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-12-17 23:25:18" itemprop="dateCreated datePublished" datetime="2024-12-17T23:25:18+08:00">2024-12-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">åµŒå…¥å¼å¼€å‘</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">02IMX6ULLå¹³å°</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/" itemprop="url" rel="index"><span itemprop="name">LV05-ç³»ç»Ÿé•œåƒ</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>7.1k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>26 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>æœ¬æ–‡ä¸»è¦æ˜¯kernelâ€”â€”openæºç è§£æçš„ç›¸å…³ç¬”è®°ï¼Œè‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚</p>
<span id="more"></span>

<!-- Photo: https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/ -->

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ä½¿ç”¨å·¥å…·åŠç‰ˆæœ¬ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center" rowspan="5">PCç«¯å¼€å‘ç¯å¢ƒ</td>        <td align="center" width=150px>Windows</td>        <td align="left">Windows11</td>    </tr>    <tr>        <td align="center">Ubuntu</td>        <td align="left">Ubuntu20.04.2çš„64ä½ç‰ˆæœ¬</td>      </tr>    <tr>        <td align="center">VMwareÂ® Workstation 17 Pro</td>        <td align="left">17.6.0 build-24238078</td>      </tr>    <tr>        <td align="center">ç»ˆç«¯è½¯ä»¶</td>        <td align="left">MobaXterm(Professional Edition v23.0 Build 5042 (license))</td>    </tr>    <tr>        <td align="center">Win32DiskImager</td>        <td align="left">Win32DiskImager v1.0</td>      </tr>    <tr>        <td align="center" rowspan="3">Linuxå¼€å‘æ¿ç¯å¢ƒ</td>        <td align="center">Linuxå¼€å‘æ¿</td>        <td align="left">æ­£ç‚¹åŸå­ i.MX6ULL Linux é˜¿å°”æ³•å¼€å‘æ¿</td>      </tr>    <tr>        <td align="center">uboot</td>        <td align="left">NXPå®˜æ–¹æä¾›çš„ubootï¼Œä½¿ç”¨çš„ubootç‰ˆæœ¬ä¸ºU-Boot 2019.04</td>      </tr>    <tr>        <td align="center">linuxå†…æ ¸</td>        <td align="left">linux-4.19.71(NXPå®˜æ–¹æä¾›)</td>      </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹æœ¬æ–‡å‚è€ƒèµ„æ–™ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center">åˆ†ç±»</td>        <td align="center">ç½‘å€</td>        <td align="center">è¯´æ˜</td>    </tr>    <tr>        <td align="center" rowspan="5">å®˜æ–¹ç½‘ç«™</td>        <td align="left"><a href="https://www.arm.com/" target="_blank">https://www.arm.com/</a></td>        <td align="left">ARMå®˜æ–¹ç½‘ç«™ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°Cotex-Mxä»¥åŠARMVxçš„ä¸€äº›æ–‡æ¡£</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxp.com.cn/" target="_blank">https://www.nxp.com.cn/ </a></td>        <td align="left">NXPå®˜æ–¹ç½‘ç«™</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxpic.org.cn/" target="_blank">https://www.nxpic.org.cn/</a></td><td align="left">NXP å®˜æ–¹ç¤¾åŒº</td>    </tr>    <tr>        <td align="left"><a href="https://u-boot.readthedocs.io/en/latest/" target="_blank">https://u-boot.readthedocs.io/en/latest/</a></td><td align="left">u-bootå®˜ç½‘</td>    </tr>    <tr>        <td align="left"><a href="https://www.kernel.org/" target="_blank">https://www.kernel.org/</a></td><td align="left">linuxå†…æ ¸å®˜ç½‘</td>    </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ç›¸å…³æ–‡ä»¶ä¸‹è½½ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center">åˆ†ç±»</td>        <td align="center">ç½‘å€</td>        <td align="center">è¯´æ˜</td>    </tr>    <tr>        <td align="center" rowspan="3">NXP</td>        <td align="left"><a href="https://github.com/nxp-imx" target="_blank">https://github.com/nxp-imx</a></td>        <td align="left">NXP imxå¼€å‘èµ„æºGitHubç»„ç»‡ï¼Œé‡Œè¾¹ä¼šæœ‰u-bootå’Œlinuxå†…æ ¸çš„ä»“åº“</td>    </tr>    <tr>        <td align="left"><a href="https://github.com/nxp-imx/linux-imx/releases/tag/v4.19.71" target="_blank">nxp-imx/linux-imx/releases/tag/v4.19.71</a></td>        <td align="left">NXP linuxå†…æ ¸ä»“åº“tagsä¸­çš„v4.19.71</td>    </tr>    <tr>        <td align="left"><a href="https://github.com/nxp-imx/uboot-imx/releases/tag/rel_imx_4.19.35_1.1.0" target="_blank">nxp-imx/uboot-imx/releases/tag/rel_imx_4.19.35_1.1.0</a></td>        <td align="left">NXP u-bootä»“åº“tagsä¸­çš„rel_imx_4.19.35_1.1.0</td>    </tr>    <tr>        <td align="center" rowspan="2">I.MX6ULL</td>        <td align="left"><a href="https://www.nxp.com.cn/docs/en/data-sheet/IMX6ULLIEC.pdf" target="_blank">i.MX 6ULL Applications Processors for Industrial Products</a></td>        <td align="left">I.MX6ULL èŠ¯ç‰‡æ‰‹å†Œï¼ˆdatasheetï¼Œå¯ä»¥åœ¨çº¿æŸ¥çœ‹ï¼‰</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh" target="_blank">i.MX 6ULL Applications ProcessorReference Manual</a></td>        <td align="left">I.MX6ULL å‚è€ƒæ‰‹å†Œï¼ˆä¸‹è½½åæ‰èƒ½æŸ¥çœ‹ï¼Œéœ€è¦ç™»å½•NXPå®˜ç½‘ï¼‰</td>    </tr>    <tr>        <td align="center" rowspan="2">Source Code</td>        <td align="left"><a href="https://elixir.bootlin.com/linux/latest/source" target="_blank">https://elixir.bootlin.com/linux/latest/source</a></td>        <td align="left">linux kernelæºç </td>    </tr>    <tr>        <td align="left"><a href="https://elixir.bootlin.com/u-boot/latest/source" target="_blank">https://elixir.bootlin.com/u-boot/latest/source</a></td>        <td align="left">ubootæºç </td>    </tr></table>
              </div>
            </details>

<h1 id="ä¸€ã€ä¸€ä¸ªå®ä¾‹"><a href="#ä¸€ã€ä¸€ä¸ªå®ä¾‹" class="headerlink" title="ä¸€ã€ä¸€ä¸ªå®ä¾‹"></a><font size=3>ä¸€ã€ä¸€ä¸ªå®ä¾‹</font></h1><h2 id="1-æµ‹è¯•demo"><a href="#1-æµ‹è¯•demo" class="headerlink" title="1. æµ‹è¯•demo"></a><font size=3>1. æµ‹è¯•demo</font></h2><p>è¿™é‡Œè¿˜æ˜¯å…ˆä»¥æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/home/sumu/7Linux/test.txt&quot;</span>, O_CREAT | O_RDWR);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-ç³»ç»Ÿè°ƒç”¨ï¼Ÿ"><a href="#2-ç³»ç»Ÿè°ƒç”¨ï¼Ÿ" class="headerlink" title="2. ç³»ç»Ÿè°ƒç”¨ï¼Ÿ"></a><font size=3>2. ç³»ç»Ÿè°ƒç”¨ï¼Ÿ</font></h2><p>openç”¨çš„å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿå…¶å®å‰é¢å·²ç»äº†è§£è¿‡äº†ï¼Œè¿™é‡Œåœ¨å›é¡¾ä¸€ä¸‹å§ï¼Œä»¥è¿™ä¸ªdemoä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/home/sumu/7Linux/test.txt&quot;</span>, O_RDONLY);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨straceå‘½ä»¤çœ‹ä¸€ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c -Wall</span><br><span class="line">touch test.txt</span><br><span class="line">strace -o syscall ./a.out</span><br></pre></td></tr></table></figure>

<p>ä¼šå‘ç°æœ‰è¿™ä¹ˆä¸€è¡Œï¼š</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openat(AT_FDCWD, &quot;/home/sumu/7Linux/test.txt&quot;, O_RDONLY)  = 3</span><br></pre></td></tr></table></figure>

<p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨çš„æ˜¯openatè¿™ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h1 id="äºŒã€openæºç åˆ†æ"><a href="#äºŒã€openæºç åˆ†æ" class="headerlink" title="äºŒã€openæºç åˆ†æ"></a><font size=3>äºŒã€openæºç åˆ†æ</font></h1><h2 id="1-ç³»ç»Ÿè°ƒç”¨openat"><a href="#1-ç³»ç»Ÿè°ƒç”¨openat" class="headerlink" title="1. ç³»ç»Ÿè°ƒç”¨openat()"></a><font size=3>1. ç³»ç»Ÿè°ƒç”¨openat()</font></h2><p>æˆ‘ä»¬å‰é¢ä¸€èŠ‚å·²ç»æ‰¾åˆ°äº†opençš„ç³»ç»Ÿè°ƒç”¨openatï¼Œå®ƒå®šä¹‰åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L1109">open.c - fs&#x2F;open.c - <em>openat</em></a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE4(openat, <span class="type">int</span>, dfd, <span class="type">const</span> <span class="type">char</span> __user *, filename, <span class="type">int</span>, flags,</span><br><span class="line">		<span class="type">umode_t</span>, mode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (force_o_largefile())</span><br><span class="line">		flags |= O_LARGEFILE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> do_sys_open(dfd, filename, flags, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰äº›ç‰ˆæœ¬çš„ç³»ç»Ÿè°ƒç”¨å¯èƒ½ç›´æ¥å°±æ˜¯openï¼Œè¿™ä¸ªæœä¸€ä¸‹å°±ä¼šçŸ¥é“äº†ã€‚å…¶å®ä¸ç®¡æ˜¯openè¿˜æ˜¯openatï¼Œéƒ½ä¼šè°ƒç”¨do_sys_open()å‡½æ•°è¿›è¡Œå¤„ç†ã€‚æ ¹æ®å‰é¢çš„å®ä¾‹ï¼Œè¿™é‡Œçš„å‚æ•°åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openat(AT_FDCWD, &quot;/home/sumu/7Linux/test.txt&quot;, O_RDONLY) = 3</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„AT_FDCWDå®šä¹‰åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/uapi/linux/fcntl.h#L78">fcntl.h - include&#x2F;uapi&#x2F;linux&#x2F;fcntl.h - <em>AT_FDCWD</em></a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> AT_FDCWD		-100    <span class="comment">/* Special value used to indicate openat should use the curren working directory. */</span></span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªforce_o_largefile()å‡½æ•°åº”è¯¥æ˜¯å®šä¹‰åœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/fcntl.h#L15">fcntl.h - include&#x2F;linux&#x2F;fcntl.h - <em>force_o_largefile</em></a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> force_o_largefile</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> force_o_largefile() (BITS_PER_LONG != 32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>æœ€åè°ƒç”¨do_sys_opençš„æ—¶å€™å‚æ•°åº”è¯¥æ˜¯è¿™æ ·å¯¹åº”çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * dfd = -100 (AT_FDCWD)</span></span><br><span class="line"><span class="comment"> * filename = &quot;/home/sumu/7Linux/test.txt&quot;</span></span><br><span class="line"><span class="comment"> * flags = O_RDONLY | O_LARGEFILE;</span></span><br><span class="line"><span class="comment"> * mode = 0</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h2 id="2-do-sys-open"><a href="#2-do-sys-open" class="headerlink" title="2.Â do_sys_open()"></a><font size=3>2.Â do_sys_open()</font></h2><p>do_sys_open()å‡½æ•°å®šä¹‰åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L1073">open.c - fs&#x2F;open.c - <em>do_sys_open</em></a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">do_sys_open</span><span class="params">(<span class="type">int</span> dfd, <span class="type">const</span> <span class="type">char</span> __user *filename, <span class="type">int</span> flags, <span class="type">umode_t</span> mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">open_flags</span> <span class="title">op</span>;</span></span><br><span class="line">	<span class="type">int</span> fd = build_open_flags(flags, mode, &amp;op);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">filename</span> *<span class="title">tmp</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fd)</span><br><span class="line">		<span class="keyword">return</span> fd;</span><br><span class="line"></span><br><span class="line">	tmp = getname(filename);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(tmp))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(tmp);</span><br><span class="line"></span><br><span class="line">	fd = get_unused_fd_flags(flags);</span><br><span class="line">	<span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span> =</span> do_filp_open(dfd, tmp, &amp;op);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(f)) &#123;</span><br><span class="line">			put_unused_fd(fd);</span><br><span class="line">			fd = PTR_ERR(f);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fsnotify_open(f);</span><br><span class="line">			fd_install(fd, f);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	putname(tmp);</span><br><span class="line">	<span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 14 è¡Œï¼šè·å–ä¸€ä¸ªè¯¥è¿›ç¨‹æœªä½¿ç”¨çš„fdï¼›</p>
<p>ç¬¬ 16 è¡Œï¼šç”Ÿæˆä¸€ä¸ªstruct fileï¼Œç”Ÿæˆè¿™ä¸ªå¯¹è±¡çš„æ—¶å€™é€šè¿‡do_filp_open()å‡½æ•°è¿›è¡Œã€‚</p>
<p>ç¬¬ 22 è¡Œï¼šå°†fdä¸struct fileè¿›è¡Œç»‘å®šã€‚</p>
<h3 id="2-1-build-open-flags"><a href="#2-1-build-open-flags" class="headerlink" title="2.1Â build_open_flags()"></a><font size=3>2.1Â build_open_flags()</font></h3><p>build_open_flags()å®šä¹‰åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L949">open.c - fs&#x2F;open.c - <em>build_open_flags</em></a>ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ç”¨æ¥æ„å»ºflagsï¼Œå¹¶è¿”å›åˆ°ç»“æ„ä½“ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/internal.h#L109">struct open_flags</a> opä¸­ã€‚è¯¥å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">build_open_flags</span><span class="params">(<span class="type">int</span> flags, <span class="type">umode_t</span> mode, <span class="keyword">struct</span> open_flags *op)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> lookup_flags = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> acc_mode = ACC_MODE(flags);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Clear out all open flags we don&#x27;t know about so that we don&#x27;t report</span></span><br><span class="line"><span class="comment">	 * them in fcntl(F_GETFD) or similar interfaces.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	flags &amp;= VALID_OPEN_FLAGS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; (O_CREAT | __O_TMPFILE)) <span class="comment">// if åˆ¤æ–­ä¸º 0 </span></span><br><span class="line">		op-&gt;mode = (mode &amp; S_IALLUGO) | S_IFREG;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		op-&gt;mode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Must never be set by userspace */</span></span><br><span class="line">	flags &amp;= ~FMODE_NONOTIFY &amp; ~O_CLOEXEC;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * O_SYNC is implemented as __O_SYNC|O_DSYNC.  As many places only</span></span><br><span class="line"><span class="comment">	 * check for O_DSYNC if the need any syncing at all we enforce it&#x27;s</span></span><br><span class="line"><span class="comment">	 * always set instead of having to deal with possibly weird behaviour</span></span><br><span class="line"><span class="comment">	 * for malicious applications setting only __O_SYNC.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; __O_SYNC) <span class="comment">// if åˆ¤æ–­ä¸º 0 </span></span><br><span class="line">		flags |= O_DSYNC;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; __O_TMPFILE) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0 </span></span><br><span class="line">		<span class="keyword">if</span> ((flags &amp; O_TMPFILE_MASK) != O_TMPFILE)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (!(acc_mode &amp; MAY_WRITE))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; O_PATH) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If we have O_PATH in the open flag. Then we</span></span><br><span class="line"><span class="comment">		 * cannot have anything other than the below set of flags</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		flags &amp;= O_DIRECTORY | O_NOFOLLOW | O_PATH;</span><br><span class="line">		acc_mode = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	op-&gt;open_flag = flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* O_TRUNC implies we need access checks for write permissions */</span></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; O_TRUNC) <span class="comment">// if åˆ¤æ–­ä¸º 0 </span></span><br><span class="line">		acc_mode |= MAY_WRITE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allow the LSM permission hook to distinguish append</span></span><br><span class="line"><span class="comment">	   access from general write access. */</span></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; O_APPEND) <span class="comment">// if åˆ¤æ–­ä¸º 0 </span></span><br><span class="line">		acc_mode |= MAY_APPEND;</span><br><span class="line"></span><br><span class="line">	op-&gt;acc_mode = acc_mode;</span><br><span class="line"></span><br><span class="line">	op-&gt;intent = flags &amp; O_PATH ? <span class="number">0</span> : LOOKUP_OPEN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; O_CREAT) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0 </span></span><br><span class="line">		op-&gt;intent |= LOOKUP_CREATE;</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; O_EXCL)</span><br><span class="line">			op-&gt;intent |= LOOKUP_EXCL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; O_DIRECTORY) <span class="comment">// if åˆ¤æ–­ä¸º 0 </span></span><br><span class="line">		lookup_flags |= LOOKUP_DIRECTORY;</span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; O_NOFOLLOW)) <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		lookup_flags |= LOOKUP_FOLLOW;</span><br><span class="line">	op-&gt;lookup_flags = lookup_flags;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆï¼Œopå„ä¸ªæˆå‘˜çš„å€¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">op-&gt;mode = <span class="number">0</span></span><br><span class="line">op-&gt;open_flag = <span class="number">0x8000</span></span><br><span class="line">op-&gt;acc_mode = <span class="number">0x4</span></span><br><span class="line">op-&gt;intent = <span class="number">0x100</span> (LOOKUP_OPEN)</span><br><span class="line">op-&gt;lookup_flags = <span class="number">0x1</span> (LOOKUP_FOLLOW)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆ†æçš„æ—¶å€™ï¼Œä¸è€ƒè™‘å¾ˆå¤šç‰¹æ®Šæƒ…å†µï¼Œè¯¥ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L949">build_open_flags()</a>å‡½æ•°ä¸­å¾ˆå¤šä»£ç æ˜¯ä¸ç”¨æ‰§è¡Œçš„ã€‚</p>
<h3 id="2-2-get-unused-fd-flags"><a href="#2-2-get-unused-fd-flags" class="headerlink" title="2.2Â get_unused_fd_flags()"></a><font size=3>2.2Â get_unused_fd_flags()</font></h3><p>åœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/file.c#L543">get_unused_fd_flags()</a> å‡½æ•°ä¸­ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶è¿”å›è¯¥å€¼ï¼Œè¿™é‡Œæ›´æ·±å…¥ä¸€å±‚å°±ä¼šæ¶‰åŠåˆ°æ–‡ä»¶æè¿°ç¬¦çš„åˆ†é…ä»¥åŠæŸ¥æ‰¾ï¼Œç›¸å…³çš„å‡½æ•°å’Œç»“æ„å¯ä»¥çœ‹è¿™é‡Œã€Š01åµŒå…¥å¼å¼€å‘&#x2F;02IMX6ULLå¹³å°&#x2F;LV05-ç³»ç»Ÿé•œåƒ&#x2F;LV05-03-Kernel-05-02-æ–‡ä»¶æè¿°ç¬¦åˆ†é….mdã€‹ã€‚è¿™ä¸ªå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">get_unused_fd_flags</span><span class="params">(<span class="type">unsigned</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> __alloc_fd(current-&gt;files, <span class="number">0</span>, rlimit(RLIMIT_NOFILE), flags);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(get_unused_fd_flags);</span><br></pre></td></tr></table></figure>

<p>å¯è§å®ƒæœ€åæ˜¯è°ƒç”¨äº†__alloc_fd()å‡½æ•°ã€‚</p>
<h2 id="3-do-filp-open"><a href="#3-do-filp-open" class="headerlink" title="3.Â do_filp_open()"></a><font size=3>3.Â do_filp_open()</font></h2><p>do_filp_open()å‡½æ•°å®šä¹‰åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3556">namei.c - fs&#x2F;namei.c - <em>do_filp_open</em></a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> file *<span class="title function_">do_filp_open</span><span class="params">(<span class="type">int</span> dfd, <span class="keyword">struct</span> filename *pathname,</span></span><br><span class="line"><span class="params">		<span class="type">const</span> <span class="keyword">struct</span> open_flags *op)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span> <span class="title">nd</span>;</span></span><br><span class="line">	<span class="type">int</span> flags = op-&gt;lookup_flags;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>;</span></span><br><span class="line"></span><br><span class="line">	set_nameidata(&amp;nd, dfd, pathname);</span><br><span class="line">	filp = path_openat(&amp;nd, op, flags | LOOKUP_RCU);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(filp == ERR_PTR(-ECHILD)))</span><br><span class="line">		filp = path_openat(&amp;nd, op, flags);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(filp == ERR_PTR(-ESTALE)))</span><br><span class="line">		filp = path_openat(&amp;nd, op, flags | LOOKUP_REVAL);</span><br><span class="line">	restore_nameidata();</span><br><span class="line">	<span class="keyword">return</span> filp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 8 è¡Œï¼š<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L513">set_nameidata()</a>å‡½æ•°ä¸»è¦ç”¨æ¥è®¾ç½®ç»“æ„ä½“ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L490">struct nameidata</a> çš„å€¼ï¼Œè¿™ä¸ªç»“æ„ä½“æ˜¯ä¸ªéå¸¸é‡è¦çš„ç»“æ„ä½“ï¼Œåœ¨è§£æå’ŒæŸ¥æ‰¾è·¯å¾„åæ—¶ä¼šç»å¸¸å¼•ç”¨åˆ°ã€‚å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">set_nameidata</span><span class="params">(<span class="keyword">struct</span> nameidata *p, <span class="type">int</span> dfd, <span class="keyword">struct</span> filename *name)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span> *<span class="title">old</span> =</span> current-&gt;nameidata;</span><br><span class="line">	p-&gt;<span class="built_in">stack</span> = p-&gt;internal;</span><br><span class="line">	p-&gt;dfd = dfd;</span><br><span class="line">	p-&gt;name = name;</span><br><span class="line">	p-&gt;total_link_count = old ? old-&gt;total_link_count : <span class="number">0</span>;</span><br><span class="line">	p-&gt;saved = old;</span><br><span class="line">	current-&gt;nameidata = p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 13 è¡Œï¼šè¿™ä¸ªå‡½æ•°å…¶å®åé¢è°ƒç”¨çš„æ˜¯path_openat()ï¼Œåé¢æˆ‘ä»¬ç»§ç»­åˆ†æã€‚</p>
<h2 id="4-path-openat"><a href="#4-path-openat" class="headerlink" title="4.Â path_openat()"></a><font size=3>4.Â path_openat()</font></h2><p>path_openat()å‡½æ•°å…¥å£å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å‡½æ•°å…¥å£å‚æ•°ï¼š flags = LOOKUP_FOLLOW | LOOKUP_RCU */</span></span><br></pre></td></tr></table></figure>

<p>å‡½æ•°å®šä¹‰åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3517">namei.c - fs&#x2F;namei.c - <em>path_openat</em></a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> file *<span class="title function_">path_openat</span><span class="params">(<span class="keyword">struct</span> nameidata *nd,</span></span><br><span class="line"><span class="params">			<span class="type">const</span> <span class="keyword">struct</span> open_flags *op, <span class="type">unsigned</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="type">int</span> error;</span><br><span class="line"></span><br><span class="line">	file = alloc_empty_file(op-&gt;open_flag, current_cred());</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(file))</span><br><span class="line">		<span class="keyword">return</span> file;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(file-&gt;f_flags &amp; __O_TMPFILE)) &#123;</span><br><span class="line">		error = do_tmpfile(nd, flags, op, file);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (unlikely(file-&gt;f_flags &amp; O_PATH)) &#123;</span><br><span class="line">		error = do_o_path(nd, flags, file);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="type">const</span> <span class="type">char</span> *s = path_init(nd, flags);</span><br><span class="line">		<span class="keyword">while</span> (!(error = link_path_walk(s, nd)) &amp;&amp;</span><br><span class="line">			(error = do_last(nd, file, op)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			nd-&gt;flags &amp;= ~(LOOKUP_OPEN|LOOKUP_CREATE|LOOKUP_EXCL);</span><br><span class="line">			s = trailing_symlink(nd);</span><br><span class="line">		&#125;</span><br><span class="line">		terminate_walk(nd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (likely(!error)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (likely(file-&gt;f_mode &amp; FMODE_OPENED))</span><br><span class="line">			<span class="keyword">return</span> file;</span><br><span class="line">		WARN_ON(<span class="number">1</span>);</span><br><span class="line">		error = -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	fput(file);</span><br><span class="line">	<span class="keyword">if</span> (error == -EOPENSTALE) &#123;</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; LOOKUP_RCU)</span><br><span class="line">			error = -ECHILD;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			error = -ESTALE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 7 è¡Œï¼špath_openat()è¯¥å‡½æ•°é€šè¿‡<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/file_table.c#L133">alloc_empty_file()</a>ä¸ºè¯¥è¿›ç¨‹ç”Ÿæˆäº†ä¸€ä¸ªstruct fileã€‚</p>
<p>ç¬¬ 16 è¡Œï¼špath_init()å‡½æ•°ç”¨äºåˆå§‹åŒ– <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L490">struct nameidata</a> ç»“æ„ä½“ã€‚</p>
<p>ç¬¬ 18 è¡Œï¼šæœ€åç”±do_last()å‡½æ•°å®Œæˆå‰©ä¸‹çš„æ‰“å¼€æ­¥éª¤ã€‚</p>
<h3 id="4-1-path-init"><a href="#4-1-path-init" class="headerlink" title="4.1Â path_init()"></a><font size=3>4.1Â path_init()</font></h3><p>å…ˆçœ‹å…¶ä¸­çš„ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L2172">path_init()</a> å‡½æ•°ã€‚åœ¨è§£æè·¯å¾„çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦éå†è·¯å¾„ä¸­çš„æ¯ä¸ªéƒ¨åˆ†ï¼Œè€Œå…¶ä¸­ä½¿ç”¨ç»“æ„ä½“ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L490">struct nameidata</a> æ¥ä¿å­˜å½“å‰éå†çš„çŠ¶æ€ã€‚<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L2172">path_init()</a>å‡½æ•°ä¸»è¦ç”¨æ¥å°†è¯¥ç»“æ„ä½“åˆå§‹åŒ–ã€‚å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* must be paired with terminate_walk() */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *<span class="title function_">path_init</span><span class="params">(<span class="keyword">struct</span> nameidata *nd, <span class="type">unsigned</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* å‡½æ•°å…¥å£å‚æ•°ï¼š flags = LOOKUP_FOLLOW | LOOKUP_RCU */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *s = nd-&gt;name-&gt;name; <span class="comment">/* s = &quot;/home/sumu/7Linux/test.txt&quot; */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!*s) <span class="comment">//if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	nd-&gt;last_type = LAST_ROOT; <span class="comment">/* if there are only slashes... */</span></span><br><span class="line">	nd-&gt;flags = flags | LOOKUP_JUMPED | LOOKUP_PARENT;</span><br><span class="line">	nd-&gt;depth = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; LOOKUP_ROOT) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nd-&gt;root.mnt = <span class="literal">NULL</span>;</span><br><span class="line">	nd-&gt;path.mnt = <span class="literal">NULL</span>;</span><br><span class="line">	nd-&gt;path.dentry = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	nd-&gt;m_seq = read_seqbegin(&amp;mount_lock);</span><br><span class="line">	<span class="keyword">if</span> (*s == <span class="string">&#x27;/&#x27;</span>) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 1, è¡¨ç¤ºä»ç»å¯¹è·¯å¾„&#x27;/&#x27;å¼€å§‹è§£æç›®å½•</span></span><br><span class="line">		set_root(nd);</span><br><span class="line">		<span class="keyword">if</span> (likely(!nd_jump_root(nd)))</span><br><span class="line">			<span class="keyword">return</span> s; <span class="comment">// å‡½æ•°ç”±æ­¤å¤„è¿”å›</span></span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ECHILD);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nd-&gt;dfd == AT_FDCWD) &#123;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-1-1-set-root"><a href="#4-1-1-set-root" class="headerlink" title="4.1.1Â set_root()"></a><font size=3>4.1.1Â set_root()</font></h4><p>ä¸‹é¢åˆ†æä¸€ä¸‹ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L810">set_root()</a> å‡½æ•°ï¼Œè¯¥å‡½æ•°è®¾ç½®struct nameidata nd çš„å€¼ï¼Œä½¿å¾—è·¯å¾„è§£æä»æ ¹ç›®å½•å¼€å§‹ï¼ˆè€Œä¸æ˜¯å½“å‰å·¥ä½œç›®å½•ï¼‰ã€‚å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">set_root</span><span class="params">(<span class="keyword">struct</span> nameidata *nd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> *<span class="title">fs</span> =</span> current-&gt;fs;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nd-&gt;flags &amp; LOOKUP_RCU) &#123;</span><br><span class="line">		<span class="type">unsigned</span> seq;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			seq = read_seqcount_begin(&amp;fs-&gt;seq);</span><br><span class="line">			nd-&gt;root = fs-&gt;root;</span><br><span class="line">			nd-&gt;root_seq = __read_seqcount_begin(&amp;nd-&gt;root.dentry-&gt;d_seq);</span><br><span class="line">		&#125; <span class="keyword">while</span> (read_seqcount_retry(&amp;fs-&gt;seq, seq));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		get_fs_root(fs, &amp;nd-&gt;root);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-nd-jump-root"><a href="#4-1-2-nd-jump-root" class="headerlink" title="4.1.2Â nd_jump_root()"></a><font size=3>4.1.2Â nd_jump_root()</font></h4><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L846">nd_jump_root()</a>å‡½æ•°çš„ä½œç”¨å’Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L810">set_root()</a> å‡½æ•°å·®ä¸å¤šï¼Œä½†åšçš„å·¥ä½œè¦æ›´å¤šä¸€äº›ã€‚å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">nd_jump_root</span><span class="params">(<span class="keyword">struct</span> nameidata *nd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (nd-&gt;flags &amp; LOOKUP_RCU) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d</span>;</span></span><br><span class="line">		nd-&gt;path = nd-&gt;root;</span><br><span class="line">		d = nd-&gt;path.dentry;</span><br><span class="line">		nd-&gt;inode = d-&gt;d_inode;</span><br><span class="line">		nd-&gt;seq = nd-&gt;root_seq;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(read_seqcount_retry(&amp;d-&gt;d_seq, nd-&gt;seq))) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="keyword">return</span> -ECHILD;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		path_put(&amp;nd-&gt;path);</span><br><span class="line">		nd-&gt;path = nd-&gt;root;</span><br><span class="line">		path_get(&amp;nd-&gt;path);</span><br><span class="line">		nd-&gt;inode = nd-&gt;path.dentry-&gt;d_inode;</span><br><span class="line">	&#125;</span><br><span class="line">	nd-&gt;flags |= LOOKUP_JUMPED;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-link-path-walk"><a href="#4-2-link-path-walk" class="headerlink" title="4.2Â link_path_walk()"></a><font size=3>4.2Â link_path_walk()</font></h3><p>ä¸Šé¢å¯¹struct nameidata nd ç»“æ„ä½“åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œä¾¿è¿›å…¥è·¯å¾„è§£æçš„ä¸»è¦éƒ¨åˆ†ï¼š <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L2068">link_path_walk()</a> å‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œå°†è·¯å¾„åé€æ­¥è§£æï¼Œå¹¶æœ€ç»ˆæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶çš„ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/dcache.h#L88">struct dentry</a> ç»“æ„ä½“ï¼ˆä¿å­˜åœ¨å‚æ•° struct nameidata *nd ä¸­ï¼‰ã€‚è¯¥å‡½æ•°å¾ˆé•¿ï¼Œåœ¨è¿™é‡Œï¼Œç”±äºæˆ‘ä»¬å¹¶ä¸æ¶‰åŠé“¾æ¥æ–‡ä»¶ä»¥åŠç‰¹æ®Šæ–‡ä»¶åï¼ˆ.å’Œ..)çš„è§£æé—®é¢˜ï¼Œè¯¥å‡½æ•°å¯ç®€åŒ–å¦‚ä¸‹ï¼ˆå¿½ç•¥æƒé™æ£€æŸ¥åŠé”™è¯¯å¤„ç†ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Name resolution.</span></span><br><span class="line"><span class="comment"> * This is the basic name resolution function, turning a pathname into</span></span><br><span class="line"><span class="comment"> * the final dentry. We expect &#x27;base&#x27; to be positive and a directory.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns 0 and nd will have valid dentry and mnt on success.</span></span><br><span class="line"><span class="comment"> * Returns error and drops reference to input namei data on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">link_path_walk</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="keyword">struct</span> nameidata *nd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(name))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(name);</span><br><span class="line">	<span class="keyword">while</span> (*name==<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		name++;</span><br><span class="line">	<span class="keyword">if</span> (!*name) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* At this point we know we have a real path component. */</span></span><br><span class="line">	<span class="keyword">for</span>(;;) &#123;</span><br><span class="line">		u64 hash_len;</span><br><span class="line">		<span class="type">int</span> type;</span><br><span class="line"></span><br><span class="line">		err = may_lookup(nd);</span><br><span class="line">		<span class="keyword">if</span> (err) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">		hash_len = hash_name(nd-&gt;path.dentry, name);</span><br><span class="line"></span><br><span class="line">		type = LAST_NORM;</span><br><span class="line">		<span class="keyword">if</span> (name[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (likely(type == LAST_NORM)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">parent</span> =</span> nd-&gt;path.dentry;</span><br><span class="line">			nd-&gt;flags &amp;= ~LOOKUP_JUMPED;</span><br><span class="line">			<span class="keyword">if</span> (unlikely(parent-&gt;d_flags &amp; DCACHE_OP_HASH)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">				<span class="comment">// ......</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		nd-&gt;last.hash_len = hash_len;</span><br><span class="line">		nd-&gt;last.name = name;</span><br><span class="line">		nd-&gt;last_type = type;</span><br><span class="line"></span><br><span class="line">		name += hashlen_len(hash_len);</span><br><span class="line">		<span class="keyword">if</span> (!*name) <span class="comment">// é™¤äº†è·¯å¾„ä¸­çš„æœ€åä¸€éƒ¨åˆ†ï¼ˆ&#x27;test.txt&#x27;ï¼‰ifåˆ¤æ–­ä¸º1ï¼Œå…¶ä»– if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="keyword">goto</span> OK;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If it wasn&#x27;t NUL, we know it was &#x27;/&#x27;. Skip that</span></span><br><span class="line"><span class="comment">		 * slash, and continue until no more slashes.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			name++;</span><br><span class="line">		&#125; <span class="keyword">while</span> (unlikely(*name == <span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!*name)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">OK:</span><br><span class="line">			<span class="comment">/* pathname body, done */</span></span><br><span class="line">			<span class="keyword">if</span> (!nd-&gt;depth)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// è§£æåˆ°è·¯å¾„æœ€åä¸€éƒ¨åˆ†æ—¶ï¼Œè¯¥å‡½æ•°ç”±æ­¤å¤„è¿”å›</span></span><br><span class="line">			<span class="comment">//......</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* not the last component */</span></span><br><span class="line">			err = walk_component(nd, WALK_FOLLOW | WALK_MORE); <span class="comment">// err == 0</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (err) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="comment">// ......</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!d_can_lookup(nd-&gt;path.dentry))) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="comment">//......</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// go back to for loop</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯è§ï¼Œè¯¥å‡½æ•°æ˜¯åœ¨ä¸€ä¸ªæ­»å¾ªç¯for(;;)é‡Œé¢å¯¹è·¯å¾„åä¸­çš„æ¯ä¸€ä¸ªéƒ¨åˆ†è¿›è¡Œè§£æï¼Œå®Œæˆè§£æåå‡½æ•°è¿”å›ã€‚è§£æå‰å‡ ä¸ªéƒ¨åˆ†ï¼ˆhome ã€ sumu å’Œ 7Linux)æ—¶ï¼Œå‡è°ƒç”¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1789">walk_component()</a> å‡½æ•°ã€‚</p>
<h4 id="4-2-1-walk-component"><a href="#4-2-1-walk-component" class="headerlink" title="4.2.1Â walk_component()"></a><font size=3>4.2.1Â walk_component()</font></h4><p> <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1789">walk_component()</a> å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼ˆä»¥è§£æâ€˜homeâ€™ä¸ºä¾‹æ¥åˆ†æè¯¥å‡½æ•°ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">walk_component</span><span class="params">(<span class="keyword">struct</span> nameidata *nd, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* å‡½æ•°å…¥å£å‚æ•°ï¼š flags = WALK_FOLLOW | WALK_MORE */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">path</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> seq;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * &quot;.&quot; and &quot;..&quot; are special - &quot;..&quot; especially so because it has</span></span><br><span class="line"><span class="comment">     * to be able to know about the current root directory and</span></span><br><span class="line"><span class="comment">     * parent relationships.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (unlikely(nd-&gt;last_type != LAST_NORM)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0 </span></span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">    &#125;</span><br><span class="line">    err = lookup_fast(nd, &amp;path, &amp;inode, &amp;seq);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(err &lt;= <span class="number">0</span>)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾ç›¸åº”æ–‡ä»¶çš„dentryå·²ç»å­˜åœ¨äºç³»ç»Ÿç¼“å­˜ä¸­ </span></span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> step_into(nd, &amp;path, flags, inode, seq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æˆ‘ä»¬è°ƒç”¨äº† <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1554">lookup_fast()</a> å‡½æ•°ï¼Œä»ä»¥è§£æç¬¬ä¸€éƒ¨åˆ†â€homeâ€ä¸ºä¾‹ï¼Œæ­¤æ—¶è¯¥å‡½æ•°ç­‰ä»·ä¸å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">lookup_fast</span><span class="params">(<span class="keyword">struct</span> nameidata *nd,</span></span><br><span class="line"><span class="params">		       <span class="keyword">struct</span> path *path, <span class="keyword">struct</span> inode **inode,</span></span><br><span class="line"><span class="params">		       <span class="type">unsigned</span> *seqp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt</span> =</span> nd-&gt;path.mnt;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>, *<span class="title">parent</span> =</span> nd-&gt;path.dentry;</span><br><span class="line">	<span class="type">int</span> status = <span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Rename seqlock is not required here because in the off chance</span></span><br><span class="line"><span class="comment">	 * of a false negative due to a concurrent rename, the caller is</span></span><br><span class="line"><span class="comment">	 * going to fall back to non-racy lookup.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (nd-&gt;flags &amp; LOOKUP_RCU) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		<span class="type">unsigned</span> seq;</span><br><span class="line">		<span class="type">bool</span> negative;</span><br><span class="line">		dentry = __d_lookup_rcu(parent, &amp;nd-&gt;last, &amp;seq);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!dentry)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="comment">//......</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * This sequence count validates that the inode matches</span></span><br><span class="line"><span class="comment">		 * the dentry name information from lookup.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		*inode = d_backing_inode(dentry);</span><br><span class="line">		negative = d_is_negative(dentry);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(read_seqcount_retry(&amp;dentry-&gt;d_seq, seq))) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="keyword">return</span> -ECHILD;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * This sequence count validates that the parent had no</span></span><br><span class="line"><span class="comment">		 * changes while we did the lookup of the dentry above.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * The memory barrier in read_seqcount_begin of child is</span></span><br><span class="line"><span class="comment">		 *  enough, we can use __read_seqcount_retry here.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(__read_seqcount_retry(&amp;parent-&gt;d_seq, nd-&gt;seq))) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="keyword">return</span> -ECHILD;</span><br><span class="line"></span><br><span class="line">		*seqp = seq;</span><br><span class="line">		status = d_revalidate(dentry, nd-&gt;flags);</span><br><span class="line">		<span class="keyword">if</span> (likely(status &gt; <span class="number">0</span>)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Note: do negative dentry check after revalidation in</span></span><br><span class="line"><span class="comment">			 * case that drops it.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (unlikely(negative)) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">				<span class="keyword">return</span> -ENOENT;</span><br><span class="line">			path-&gt;mnt = mnt;</span><br><span class="line">			path-&gt;dentry = dentry;</span><br><span class="line">			<span class="keyword">if</span> (likely(__follow_mount_rcu(nd, path, inode, seqp))) <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">				<span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// å‡½æ•°ä»è¿™é‡Œè¿”å›</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å‡½æ•° <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/dcache.c#L2103">__d_lookup_rcu()</a> ç”¨æ¥æ‰¾åˆ° â€œhomeâ€ å¯¹åº”çš„ dentry ç»“æ„ä½“å¹¶è¿”å›å…¶æŒ‡é’ˆï¼Œå…·ä½“è¿‡ç¨‹æ­¤å¤„ä¸åšåˆ†æã€‚è¿™é‡Œæˆ‘ä»¬ç®€å•äº†è§£ä¸‹ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1311">__follow_mount_rcu()</a> å‡½æ•°ã€‚è¯¥å‡½æ•°ä¸»è¦ç”¨æ¥æ£€æŸ¥è·¯å¾„åæ˜¯å¦æ˜¯æŒ‚è½½ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ‰¾åˆ°ç›¸åº”æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åœ¨æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿä¸‹ç»§ç»­å½“å‰çš„æ–‡ä»¶è§£æå·¥ä½œï¼ˆè€Œä¸æ˜¯åœ¨æ—§çš„æ–‡ä»¶ç³»ç»Ÿä¸‹ç»§ç»­ï¼‰ã€‚è¿™é‡Œï¼Œä»ä»¥â€homeâ€ä¸ºä¾‹ï¼Œè¯¥å‡½æ•°å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Try to skip to top of mountpoint pile in rcuwalk mode.  Fail if</span></span><br><span class="line"><span class="comment"> * we meet a managed dentry that would need blocking.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> __follow_mount_rcu(<span class="keyword">struct</span> nameidata *nd, <span class="keyword">struct</span> path *path,</span><br><span class="line">			       <span class="keyword">struct</span> inode **inode, <span class="type">unsigned</span> *seqp)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">mount</span> *<span class="title">mounted</span>;</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Don&#x27;t forget we might have a non-mountpoint managed dentry</span></span><br><span class="line"><span class="comment">		 * that wants to block transit.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">switch</span> (managed_dentry_rcu(path)) &#123; <span class="comment">// è·³è½¬è‡³ case 0:</span></span><br><span class="line">		<span class="keyword">case</span> -ECHILD:</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">case</span> -EISDIR:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!d_mountpoint(path-&gt;dentry)) <span class="comment">// if åˆ¤æ–­ä¸º 0(å¯¹åº”&#x27;home&#x27;æ–‡ä»¶å¤¹ï¼Œåˆ™ä¸º1</span></span><br><span class="line">			<span class="keyword">return</span> !(path-&gt;dentry-&gt;d_flags &amp; DCACHE_NEED_AUTOMOUNT);</span><br><span class="line"></span><br><span class="line">		mounted = __lookup_mnt(path-&gt;mnt, path-&gt;dentry);</span><br><span class="line">		<span class="keyword">if</span> (!mounted) <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">			<span class="keyword">break</span>; <span class="comment">// ç»“æŸå¾ªç¯</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> !read_seqretry(&amp;mount_lock, nd-&gt;m_seq) &amp;&amp;</span><br><span class="line">		!(path-&gt;dentry-&gt;d_flags &amp; DCACHE_NEED_AUTOMOUNT); <span class="comment">// return 1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namespace.c#L613">__lookup_mnt()</a> å‡½æ•°ä¸ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/dcache.c#L2103">__d_lookup_rcu()</a>  ç±»ä¼¼ï¼Œåªä¸è¿‡è¿™é‡Œæ˜¯æ‰¾åˆ°æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸æ˜¯ dentryã€‚åœ¨è¿™é‡Œï¼Œâ€homeâ€æ–‡ä»¶å¤¹ç¡®å®æ˜¯ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œä½†åœ¨æˆ‘çš„ç³»ç»Ÿé‡Œé¢ï¼Œå¹¶æ²¡æœ‰åœ¨è¯¥ç›®å½•ä¸‹æŒ‚è½½ä»»ä½•æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤ï¼Œ  <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namespace.c#L613">__lookup_mnt()</a> å‡½æ•°è¿”å›0ï¼ˆæ‰¾ä¸åˆ°æŒ‚è½½åœ¨æ­¤å¤„çš„æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚å…¶å®ç›¸å½“äºè¿™ä¸ªfor(;;)å¾ªç¯é‡Œé¢ä»€ä¹ˆéƒ½æ²¡åšï¼Œå°±é€€å‡ºäº†ã€‚æœ€ç»ˆè¯¥å‡½æ•°è¿”å›å€¼ä¸º1ã€‚è¿™ä¹Ÿåˆç†ï¼Œå› ä¸ºâ€homeâ€ä¸‹æ²¡æœ‰æŒ‚è½½ä»»ä½•æ–‡ä»¶ç³»ç»Ÿï¼Œä¸éœ€è¦ <code>follow mount</code>ã€‚</p>
<p>ç°åœ¨å›åˆ° <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1789">walk_component()</a> å‡½æ•°ï¼Œåœ¨è¿™é‡Œé¢æˆ‘ä»¬è¿˜éœ€è¦åˆ†æå¦å¤–ä¸€ä¸ªå‡½æ•°ï¼š <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1768">step_into()</a> ã€‚è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯å¤„ç†ç¬¦å·é“¾æ¥çš„æƒ…å†µï¼Œåœ¨è¿™é‡Œä¸æ¶‰åŠç¬¦å·é“¾æ¥ï¼Œè¯¥å‡½æ•°åˆ™å¾ˆç®€å•ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Do we need to follow links? We _really_ want to be able</span></span><br><span class="line"><span class="comment"> * to do this check without having to look at inode-&gt;i_op,</span></span><br><span class="line"><span class="comment"> * so we keep a cache of &quot;no, this doesn&#x27;t need follow_link&quot;</span></span><br><span class="line"><span class="comment"> * for the common case.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">step_into</span><span class="params">(<span class="keyword">struct</span> nameidata *nd, <span class="keyword">struct</span> path *path,</span></span><br><span class="line"><span class="params">			    <span class="type">int</span> flags, <span class="keyword">struct</span> inode *inode, <span class="type">unsigned</span> seq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; WALK_MORE) &amp;&amp; nd-&gt;depth) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		put_link(nd);</span><br><span class="line">	<span class="keyword">if</span> (likely(!d_is_symlink(path-&gt;dentry)) ||</span><br><span class="line">	   !(flags &amp; WALK_FOLLOW || nd-&gt;flags &amp; LOOKUP_FOLLOW)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		<span class="comment">/* not a symlink or should not follow */</span></span><br><span class="line">		path_to_nameidata(path, nd);</span><br><span class="line">		nd-&gt;inode = inode;</span><br><span class="line">		nd-&gt;seq = seq;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// å‡½æ•°ç”±æ­¤å¤„è¿”å›</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L834">path_to_nameidata()</a> å‡½æ•°ä¹Ÿå¾ˆç®€å•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">path_to_nameidata</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> path *path,</span></span><br><span class="line"><span class="params">					<span class="keyword">struct</span> nameidata *nd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(nd-&gt;flags &amp; LOOKUP_RCU)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		dput(nd-&gt;path.dentry);</span><br><span class="line">		<span class="keyword">if</span> (nd-&gt;path.mnt != path-&gt;mnt)</span><br><span class="line">			mntput(nd-&gt;path.mnt);</span><br><span class="line">	&#125;</span><br><span class="line">	nd-&gt;path.mnt = path-&gt;mnt;</span><br><span class="line">	nd-&gt;path.dentry = path-&gt;dentry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥  <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1768">step_into()</a> å‡½æ•°å°±ç›¸å½“äºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">step_into</span><span class="params">(<span class="keyword">struct</span> nameidata *nd, <span class="keyword">struct</span> path *path,</span></span><br><span class="line"><span class="params">			    <span class="type">int</span> flags, <span class="keyword">struct</span> inode *inode, <span class="type">unsigned</span> seq)</span></span><br><span class="line">&#123;</span><br><span class="line">    nd-&gt;path.mnt = path-&gt;mnt;</span><br><span class="line">    nd-&gt;path.dentry = path-&gt;dentry;</span><br><span class="line">    nd-&gt;inode = inode;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-æ€»ç»“"><a href="#4-3-æ€»ç»“" class="headerlink" title="4.3 æ€»ç»“"></a><font size=3>4.3 æ€»ç»“</font></h3><p>è‡³æ­¤ï¼Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1789">walk_component()</a> å‡½æ•°åˆ†æå®Œæ¯•ï¼Œæˆ‘ä»¬è¿”å›å…¶è°ƒç”¨å‡½æ•° <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L2068">link_path_walk()</a> ã€‚</p>
<p>æˆ‘ä»¬å‘ç°<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1789">walk_component()</a> å‡½æ•°è¿”å›ä¹‹åï¼Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L2068">link_path_walk()</a> å‡½æ•°çš„for(;;)å¾ªç¯ç¬¬ä¸€æ¬¡å¾ªç¯æ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿå°±è¡¨ç¤ºå¯¹è·¯å¾„çš„ç¬¬ä¸€éƒ¨åˆ†â€homeâ€çš„è§£æå®Œæ¯•ã€‚ä¸éš¾æƒ³è±¡ï¼Œåœ¨ç¬¬äºŒæ¬¡æ‰§è¡Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L2068">link_path_walk()</a> å‡½æ•°çš„for(;;)å¾ªç¯æ—¶ï¼Œå°†ä¼šè§£æä¸‹ä¸€ä¸ªè·¯å¾„ï¼Œä¹Ÿå°±æ˜¯â€sumuâ€ã€‚è§£æè¿‡ç¨‹å’Œâ€homeâ€æä¸ºç±»ä¼¼ï¼Œè¿™é‡Œä¸å†é‡å¤åˆ†æï¼Œè§£æå®Œæ¯•ä¹‹åï¼Œå°†è§£æç»“æœåŒæ ·å­˜å…¥ struct nameidata *nd ä¸­ï¼Œä¹‹å‰å¯¹â€homeâ€çš„è§£æç»“æœåˆ™è¢«è¦†ç›–ã€‚å½“ç¬¬å››æ¬¡æ‰§è¡Œfor(;;)å¾ªç¯æ—¶ï¼Œåˆ™è§£ææœ€åä¸€éƒ¨åˆ†â€test.txtâ€ã€‚</p>
<p>å¯¹æœ€åä¸€éƒ¨åˆ†çš„è§£æå’Œå‰é¢çš„è·¯å¾„åè§£æç¨æœ‰åŒºåˆ«ï¼Œä¸å†è°ƒç”¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1789">walk_component()</a> å‡½æ•°ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›åˆ° <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3517">path_openat()</a> å‡½æ•°ï¼Œå°†æœ€åè§£æå·¥ä½œç•™ç»™ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3257">do_last()</a> å‡½æ•°æ¥å®Œæˆã€‚</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/image-20241214153842041.png" alt="image-20241214153842041" />

<h2 id="5-do-last"><a href="#5-do-last" class="headerlink" title="5.Â do_last()"></a><font size=3>5.Â do_last()</font></h2><p>do_lastå‡½æ•°å®šä¹‰åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3257">namei.c - fs&#x2F;namei.c - <em>do_last</em></a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Handle the last step of open()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_last</span><span class="params">(<span class="keyword">struct</span> nameidata *nd,</span></span><br><span class="line"><span class="params">		   <span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="keyword">struct</span> open_flags *op)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dir</span> =</span> nd-&gt;path.dentry;</span><br><span class="line">	<span class="type">int</span> open_flag = op-&gt;open_flag;</span><br><span class="line">	<span class="type">bool</span> will_truncate = (open_flag &amp; O_TRUNC) != <span class="number">0</span>;</span><br><span class="line">	<span class="type">bool</span> got_write = <span class="literal">false</span>;</span><br><span class="line">	<span class="type">int</span> acc_mode = op-&gt;acc_mode;</span><br><span class="line">	<span class="type">unsigned</span> seq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">path</span>;</span></span><br><span class="line">	<span class="type">int</span> error;</span><br><span class="line"></span><br><span class="line">	nd-&gt;flags &amp;= ~LOOKUP_PARENT;</span><br><span class="line">	nd-&gt;flags |= op-&gt;intent;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nd-&gt;last_type != LAST_NORM) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(open_flag &amp; O_CREAT)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		<span class="keyword">if</span> (nd-&gt;last.name[nd-&gt;last.len]) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			nd-&gt;flags |= LOOKUP_FOLLOW | LOOKUP_DIRECTORY;</span><br><span class="line">		<span class="comment">/* we _can_ be in RCU mode here */</span></span><br><span class="line">		error = lookup_fast(nd, &amp;path, &amp;inode, &amp;seq);</span><br><span class="line">		<span class="keyword">if</span> (likely(error &gt; <span class="number">0</span>)) <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">			<span class="keyword">goto</span> finish_lookup; <span class="comment">// æ­¤å¤„è¿›è¡Œè·³è½¬</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">finish_lookup:</span><br><span class="line">	error = step_into(nd, &amp;path, <span class="number">0</span>, inode, seq);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(error))<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line">finish_open:</span><br><span class="line">	<span class="comment">/* Why this, you ask?  _Now_ we might have grown LOOKUP_JUMPED... */</span></span><br><span class="line">	error = complete_walk(nd);</span><br><span class="line">	<span class="keyword">if</span> (error) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line">	audit_inode(nd-&gt;name, nd-&gt;path.dentry, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (open_flag &amp; O_CREAT) &#123; <span class="comment">// è¿™é‡Œä¹‹å‰çœ‹çš„èµ„æ–™é“¾æ¥ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œä¹Ÿæ˜¯ç›´æ¥è·³è¿‡</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	error = -ENOTDIR;</span><br><span class="line">	<span class="keyword">if</span> ((nd-&gt;flags &amp; LOOKUP_DIRECTORY) &amp;&amp; !d_can_lookup(nd-&gt;path.dentry))<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="keyword">if</span> (!d_is_reg(nd-&gt;path.dentry))<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		will_truncate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (will_truncate) &#123;<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">finish_open_created:</span><br><span class="line">	error = may_open(&amp;nd-&gt;path, acc_mode, open_flag);</span><br><span class="line">	<span class="keyword">if</span> (error)<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	BUG_ON(file-&gt;f_mode &amp; FMODE_OPENED); <span class="comment">/* once it&#x27;s opened, it&#x27;s opened */</span></span><br><span class="line">	error = vfs_open(&amp;nd-&gt;path, file); <span class="comment">// è¿™é‡Œæ˜¯é‡ç‚¹ï¼ŒçœŸæ­£æ‰§è¡Œæ–‡ä»¶æ‰“å¼€çš„æ“ä½œ</span></span><br><span class="line">	<span class="keyword">if</span> (error)<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">opened:</span><br><span class="line">	error = ima_file_check(file, op-&gt;acc_mode);<span class="comment">// è¿™é‡Œ error==0</span></span><br><span class="line">	<span class="keyword">if</span> (!error &amp;&amp; will_truncate)<span class="comment">// if åˆ¤æ–­ä¸º 0ï¼Œwill_truncate==0</span></span><br><span class="line">		error = handle_truncate(file);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">if</span> (unlikely(error &gt; <span class="number">0</span>)) &#123;<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (got_write)<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		mnt_drop_write(nd-&gt;path.mnt);</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹åˆ°åœ¨do_last()å‡½æ•°è°ƒç”¨complete_walk()å‡½æ•°ä¹‹å‰ï¼Œåˆ†åˆ«è°ƒç”¨äº†lookup_fast()å’Œstep_into()å‡½æ•°ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/image-20241214155242924.png" alt="image-20241214155242924" />

<p>ç›¸å½“äºè°ƒç”¨äº†walk_component()å‡½æ•°ï¼Œæ‰¾åˆ°æ–‡ä»¶è·¯å¾„æœ€åä¸€éƒ¨åˆ†å¯¹åº”çš„dentryï¼Œå¹¶å­˜å…¥åˆ° struct nameidata nd ä¸­ã€‚</p>
<h3 id="5-1-complete-walk"><a href="#5-1-complete-walk" class="headerlink" title="5.1Â complete_walk()"></a><font size=3>5.1Â complete_walk()</font></h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L782">complete_walk()</a> å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * complete_walk - successful completion of path walk</span></span><br><span class="line"><span class="comment"> * @nd:  pointer nameidata</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If we had been in RCU mode, drop out of it and legitimize nd-&gt;path.</span></span><br><span class="line"><span class="comment"> * Revalidate the final result, unless we&#x27;d already done that during</span></span><br><span class="line"><span class="comment"> * the path walk or the filesystem doesn&#x27;t ask for it.  Return 0 on</span></span><br><span class="line"><span class="comment"> * success, -error on failure.  In case of failure caller does not</span></span><br><span class="line"><span class="comment"> * need to drop nd-&gt;path.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">complete_walk</span><span class="params">(<span class="keyword">struct</span> nameidata *nd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span> =</span> nd-&gt;path.dentry;</span><br><span class="line">	<span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nd-&gt;flags &amp; LOOKUP_RCU) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		<span class="keyword">if</span> (!(nd-&gt;flags &amp; LOOKUP_ROOT))  <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">			nd-&gt;root.mnt = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(unlazy_walk(nd)))  <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="keyword">return</span> -ECHILD;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (likely(!(nd-&gt;flags &amp; LOOKUP_JUMPED)))  <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//å‡½æ•°è¿”å›</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­è°ƒç”¨äº† <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L668">unlazy_walk()</a> è¿™ä¸ªå‡½æ•°ã€‚è¯¥å‡½æ•°å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * unlazy_walk - try to switch to ref-walk mode.</span></span><br><span class="line"><span class="comment"> * @nd: nameidata pathwalk data</span></span><br><span class="line"><span class="comment"> * Returns: 0 on success, -ECHILD on failure</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * unlazy_walk attempts to legitimize the current nd-&gt;path and nd-&gt;root</span></span><br><span class="line"><span class="comment"> * for ref-walk mode.</span></span><br><span class="line"><span class="comment"> * Must be called from rcu-walk context.</span></span><br><span class="line"><span class="comment"> * Nothing should touch nameidata between unlazy_walk() failure and</span></span><br><span class="line"><span class="comment"> * terminate_walk().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">unlazy_walk</span><span class="params">(<span class="keyword">struct</span> nameidata *nd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">parent</span> =</span> nd-&gt;path.dentry;</span><br><span class="line"></span><br><span class="line">	BUG_ON(!(nd-&gt;flags &amp; LOOKUP_RCU));</span><br><span class="line"></span><br><span class="line">	nd-&gt;flags &amp;= ~LOOKUP_RCU;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!legitimize_links(nd))) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">goto</span> out2;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!legitimize_path(nd, &amp;nd-&gt;path, nd-&gt;seq)))  <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">goto</span> out1;</span><br><span class="line">	<span class="keyword">if</span> (nd-&gt;root.mnt &amp;&amp; !(nd-&gt;flags &amp; LOOKUP_ROOT)) &#123;  <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	BUG_ON(nd-&gt;inode != parent-&gt;d_inode);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆæœ‰ä¸¤ä¸ªå‡½æ•°éœ€è¦åˆ†æï¼š<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L632">legitimize_links()</a> å’Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L615">legitimize_path()</a> ã€‚</p>
<h4 id="5-1-1-legitimize-links"><a href="#5-1-1-legitimize-links" class="headerlink" title="5.1.1Â legitimize_links()"></a><font size=3>5.1.1Â legitimize_links()</font></h4><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L632">legitimize_links()</a> æ˜¯ç”¨æ¥å¤„ç†é“¾æ¥çš„ï¼Œè¿™é‡Œä¸æ¶‰åŠé“¾æ¥ï¼Œå› æ­¤è¯¥å‡½æ•°ç›¸å½“äºç©ºå‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">legitimize_links</span><span class="params">(<span class="keyword">struct</span> nameidata *nd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nd-&gt;depth; i++) &#123; <span class="comment">// è¿™é‡Œ nd-&gt;depth = 0, å¾ªç¯ä¸æ‰§è¡Œ</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-2-legitimize-path"><a href="#5-1-2-legitimize-path" class="headerlink" title="5.1.2Â legitimize_path()"></a><font size=3>5.1.2Â legitimize_path()</font></h4><p> <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L615">legitimize_path()</a> å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* path_put is needed afterwards regardless of success or failure */</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">legitimize_path</span><span class="params">(<span class="keyword">struct</span> nameidata *nd,</span></span><br><span class="line"><span class="params">			    <span class="keyword">struct</span> path *path, <span class="type">unsigned</span> seq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> res = __legitimize_mnt(path-&gt;mnt, nd-&gt;m_seq);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(res)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!lockref_get_not_dead(&amp;path-&gt;dentry-&gt;d_lockref))) &#123;<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> !read_seqcount_retry(&amp;path-&gt;dentry-&gt;d_seq, seq); <span class="comment">// return 1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namespace.c#L568">__legitimize_mnt()</a>å‡½æ•°ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* call under rcu_read_lock */</span></span><br><span class="line"><span class="type">int</span> __legitimize_mnt(<span class="keyword">struct</span> vfsmount *bastard, <span class="type">unsigned</span> seq)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mount</span> *<span class="title">mnt</span>;</span></span><br><span class="line">	<span class="keyword">if</span> (read_seqretry(&amp;mount_lock, seq)) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (bastard == <span class="literal">NULL</span>) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	mnt = real_mount(bastard);</span><br><span class="line">	mnt_add_count(mnt, <span class="number">1</span>);</span><br><span class="line">	smp_mb();			<span class="comment">// see mntput_no_expire()</span></span><br><span class="line">	<span class="keyword">if</span> (likely(!read_seqretry(&amp;mount_lock, seq))) <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// å‡½æ•°è¿”å›</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¬¬ 9 è¡Œï¼š<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/mount.h#L77">real_mount()</a>å‡½æ•°è¾ƒä¸ºç®€å•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> mount *<span class="title function_">real_mount</span><span class="params">(<span class="keyword">struct</span> vfsmount *mnt)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> container_of(mnt, <span class="keyword">struct</span> mount, mnt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜¯å°† <a href="v4.19.71/source/include/linux/mount.h#L67">struct vfsmount</a> *mnt è½¬åŒ–ä¸º <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/mount.h#L34">struct mount</a> *mount (å‰è€…æ˜¯åè€…çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œé€šè¿‡å® <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/kernel.h#L996">container_of()</a> å®ç°ï¼‰ã€‚</p>
<p>ç¬¬ 10 è¡Œï¼š<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namespace.c#L139">mnt_add_count()</a> å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * vfsmount lock must be held for read</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">mnt_add_count</span><span class="params">(<span class="keyword">struct</span> mount *mnt, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">	this_cpu_add(mnt-&gt;mnt_pcp-&gt;mnt_count, n); <span class="comment">// ç•¥å»å¤šæ ¸cpuåŒæ­¥ç­‰é—®é¢˜ï¼Œç­‰ä»·ä¸ mnt-&gt;mnt_pcp-&gt;mnt_count += n</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L615">legitimize_path()</a> å‡½æ•°åˆ†æå®Œæ¯•ï¼Œå¥½åƒå°±åšäº†ä¸€ä»¶äº‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">container_of(nd-&gt;path-&gt;mnt)-&gt;mnt_pcp-&gt;mnt_count++; </span><br></pre></td></tr></table></figure>

<p>çœ‹èµ·æ¥ä¹Ÿæ˜¯å…³äºåŒæ­¥é—®é¢˜å¤„ç†ç›¸å…³çš„ï¼Œå°±ä¸æ·±å…¥åˆ†æäº†ã€‚</p>
<h4 id="5-1-3-æ€»ç»“"><a href="#5-1-3-æ€»ç»“" class="headerlink" title="5.1.3 æ€»ç»“"></a><font size=3>5.1.3 æ€»ç»“</font></h4><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L782">complete_walk()</a> å‡½æ•°ä¸­æˆ‘ä»¬å…³å¿ƒçš„å°±æ˜¯ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L668">unlazy_walk()</a> è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆå…¶å®å°±åšäº†ä¸‹é¢çš„äº‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nd-&gt;flags &amp;= ~LOOKUP_RCU;</span><br><span class="line">container_of(nd-&gt;path-&gt;mnt)-&gt;mnt_pcp-&gt;mnt_count++;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆï¼Œæ•´ä¸ª<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L782">complete_walk()</a> å‡½æ•°ç›¸å½“äº:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">complete_walk</span><span class="params">(<span class="keyword">struct</span> nameidata *nd)</span></span><br><span class="line">&#123;</span><br><span class="line">    nd-&gt;root.mnt = <span class="literal">NULL</span>;</span><br><span class="line">    nd-&gt;flags &amp;= ~LOOKUP_RCU;</span><br><span class="line">    container_of(nd-&gt;path-&gt;mnt,<span class="keyword">struct</span> mount, mnt)-&gt;mnt_pcp-&gt;mnt_count++;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-audit-inode"><a href="#5-2-audit-inode" class="headerlink" title="5.2Â audit_inode()"></a><font size=3>5.2Â audit_inode()</font></h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L782">complete_walk()</a> å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹ååˆ™è¿›å…¥ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/audit.h#L290">audit_inode()</a>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¥½åƒä»€ä¹ˆéƒ½æ²¡åšï¼Œè€Œä¸”è¿™ä¸ªå‡½æ•°çš„å®šä¹‰ä¾èµ–äºAUDITç›¸å…³çš„å†…æ ¸é…ç½®ï¼Œåœ¨æŸäº›å†…æ ¸é…ç½®ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°çš„å®šä¹‰å°±æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä¸è¿›è¡Œæ·±å…¥åˆ†æè¯¥å‡½æ•°ã€‚</p>
<h3 id="5-3-may-open"><a href="#5-3-may-open" class="headerlink" title="5.3Â may_open()"></a><font size=3>5.3Â may_open()</font></h3><p>ä¸‹é¢æ‰§è¡Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L2946">may_open()</a> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦ç”¨æ¥æ£€æŸ¥ç›¸åº”æ‰“å¼€æƒé™ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚ä¸åˆ†æï¼Œç®€å•è®¤ä¸ºæƒé™æ£€æŸ¥æ²¡æœ‰é—®é¢˜ã€‚</p>
<h3 id="5-4-æ€»ç»“"><a href="#5-4-æ€»ç»“" class="headerlink" title="5.4Â æ€»ç»“"></a><font size=3>5.4Â æ€»ç»“</font></h3><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„[do_last() å‡½æ•°å°±åˆ†æçš„å·®ä¸å¤šäº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªæœ€é‡è¦çš„å‡½æ•° <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L896">vfs_open()</a> ã€‚è¿™ä¸ªå‡½æ•°éå¸¸é‡è¦ï¼Œå¯ä»¥è¯´çœŸæ­£çš„â€œæ‰“å¼€â€æ“ä½œæ˜¯åœ¨è¿™é‡Œè¿›è¡Œçš„ï¼Œå‰é¢æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯ä¸ºäº†â€œæ‰¾åˆ°â€è¿™ä¸ªæ–‡ä»¶ã€‚åé¢æˆ‘ä»¬é‡æ–°å¼€å§‹ä¸€å°èŠ‚è¯¦ç»†åˆ†æã€‚</p>
<h2 id="6-vfs-open"><a href="#6-vfs-open" class="headerlink" title="6.Â vfs_open()"></a><font size=3>6.Â vfs_open()</font></h2><p>vfs_open()å®šä¹‰åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L896">open.c - fs&#x2F;open.c - <em>vfs_open</em></a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vfs_open - open the file at the given path</span></span><br><span class="line"><span class="comment"> * @path: path to open</span></span><br><span class="line"><span class="comment"> * @file: newly allocated file with f_flag initialized</span></span><br><span class="line"><span class="comment"> * @cred: credentials to use</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">vfs_open</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> path *path, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">	file-&gt;f_path = *path;</span><br><span class="line">	<span class="keyword">return</span> do_dentry_open(file, d_backing_inode(path-&gt;dentry), <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆè°ƒç”¨äº†do_dentry_open()å‡½æ•°å‡½å®Œæˆæ–‡ä»¶æ‰“å¼€çš„æ“ä½œã€‚</p>
<h3 id="6-1-do-dentry-open"><a href="#6-1-do-dentry-open" class="headerlink" title="6.1 do_dentry_open()"></a><font size=3>6.1 do_dentry_open()</font></h3><p>do_dentry_open()å‡½æ•°å®šä¹‰åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L735">open.c - fs&#x2F;open.c - <em>do_dentry_open</em></a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_dentry_open</span><span class="params">(<span class="keyword">struct</span> file *f,</span></span><br><span class="line"><span class="params">			  <span class="keyword">struct</span> inode *inode,</span></span><br><span class="line"><span class="params">			  <span class="type">int</span> (*open)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *))</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">empty_fops</span> =</span> &#123;&#125;;</span><br><span class="line">	<span class="type">int</span> error;</span><br><span class="line"></span><br><span class="line">	path_get(&amp;f-&gt;f_path);</span><br><span class="line">	f-&gt;f_inode = inode;</span><br><span class="line">	f-&gt;f_mapping = inode-&gt;i_mapping;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Ensure that we skip any errors that predate opening of the file */</span></span><br><span class="line">	f-&gt;f_wb_err = filemap_sample_wb_err(f-&gt;f_mapping);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(f-&gt;f_flags &amp; O_PATH)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Any file opened for execve()/uselib() has to be a regular file. */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(f-&gt;f_flags &amp; FMODE_EXEC &amp;&amp; !S_ISREG(inode-&gt;i_mode))) &#123;<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (f-&gt;f_mode &amp; FMODE_WRITE &amp;&amp; !special_file(inode-&gt;i_mode)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* POSIX.1-2008/SUSv4 Section XSI 2.9.7 */</span></span><br><span class="line">	<span class="keyword">if</span> (S_ISREG(inode-&gt;i_mode) || S_ISDIR(inode-&gt;i_mode)) <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		f-&gt;f_mode |= FMODE_ATOMIC_POS;</span><br><span class="line"></span><br><span class="line">	f-&gt;f_op = fops_get(inode-&gt;i_fop);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(WARN_ON(!f-&gt;f_op))) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	error = security_file_open(f);</span><br><span class="line">	<span class="keyword">if</span> (error)<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">goto</span> cleanup_all;</span><br><span class="line"></span><br><span class="line">	error = break_lease(locks_inode(f), f-&gt;f_flags);</span><br><span class="line">	<span class="keyword">if</span> (error)<span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">		<span class="keyword">goto</span> cleanup_all;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* normally all 3 are set; -&gt;open() can clear them if needed */</span></span><br><span class="line">	f-&gt;f_mode |= FMODE_LSEEK | FMODE_PREAD | FMODE_PWRITE;</span><br><span class="line">	<span class="keyword">if</span> (!open)     <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		open = f-&gt;f_op-&gt;open;</span><br><span class="line">	<span class="keyword">if</span> (open) &#123;    <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		error = open(inode, f);</span><br><span class="line">		<span class="keyword">if</span> (error) <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="keyword">goto</span> cleanup_all;</span><br><span class="line">	&#125;</span><br><span class="line">	f-&gt;f_mode |= FMODE_OPENED;</span><br><span class="line">	<span class="keyword">if</span> ((f-&gt;f_mode &amp; (FMODE_READ | FMODE_WRITE)) == FMODE_READ)</span><br><span class="line">		i_readcount_inc(inode);</span><br><span class="line">	<span class="keyword">if</span> ((f-&gt;f_mode &amp; FMODE_READ) &amp;&amp;</span><br><span class="line">	     likely(f-&gt;f_op-&gt;read || f-&gt;f_op-&gt;read_iter))</span><br><span class="line">		f-&gt;f_mode |= FMODE_CAN_READ;</span><br><span class="line">	<span class="keyword">if</span> ((f-&gt;f_mode &amp; FMODE_WRITE) &amp;&amp;</span><br><span class="line">	     likely(f-&gt;f_op-&gt;write || f-&gt;f_op-&gt;write_iter))</span><br><span class="line">		f-&gt;f_mode |= FMODE_CAN_WRITE;</span><br><span class="line"></span><br><span class="line">	f-&gt;f_write_hint = WRITE_LIFE_NOT_SET;</span><br><span class="line">	f-&gt;f_flags &amp;= ~(O_CREAT | O_EXCL | O_NOCTTY | O_TRUNC);</span><br><span class="line"></span><br><span class="line">	file_ra_state_init(&amp;f-&gt;f_ra, f-&gt;f_mapping-&gt;host-&gt;i_mapping);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* NB: we&#x27;re sure to have correct a_ops only after f_op-&gt;open */</span></span><br><span class="line">	<span class="keyword">if</span> (f-&gt;f_flags &amp; O_DIRECT) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!f-&gt;f_mapping-&gt;a_ops || !f-&gt;f_mapping-&gt;a_ops-&gt;direct_IO)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>do_dentry_open()å‡½æ•°å¤§éƒ¨åˆ†åœ¨ä¸ºè¿›ç¨‹ç”Ÿæˆçš„struct fileè¿›è¡Œèµ‹å€¼ï¼Œå¡«å……äº†struct file *file çš„å„ä¸ªæˆå‘˜å˜é‡ï¼Œå¹¶è°ƒç”¨é©±åŠ¨ç¨‹åºä¸­çš„ â€œopenâ€å‡½æ•°ã€‚</p>
<p>æˆ‘ä»¬è¦å…³æ³¨ä¸‹ç¬¬ 32 è¡Œï¼šè¿™ä¸€è¡Œæ˜¯å¯¹äºstruct fileçš„f_opè¿›è¡Œèµ‹å€¼ï¼Œè¯¥f_opçš„èµ‹å€¼ä¼šå¯¼è‡´æœ€ç»ˆè®¿é—®è¯¥æ–‡ä»¶æ—¶è¿›è¡Œçš„write()ã€read()çš„è¡Œä¸ºï¼Œè¿™ä¸ªæ˜¯é‡ä¸­ä¹‹é‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f-&gt;f_op = fops_get(inode-&gt;i_fop);</span><br></pre></td></tr></table></figure>

<p>struct fileä¸­çš„f_opçš„æ˜¯ç›´æ¥èµ‹å€¼ä¸ºinode&rarr;i_fopï¼Œä»ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œé©±åŠ¨ç¨‹åºçš„â€open()â€å‡½æ•°å…¶å®æ˜¯ä¿å­˜åœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/fs.h#L593">struct inode</a> *inode é‡Œé¢çš„ï¼Œè€Œinodeåˆæ˜¯ä¿å­˜åœ¨struct dentry é‡Œé¢çš„ã€‚é€šè¿‡è¯»å–ç›¸åº”çš„åœ°å€ä¿¡æ¯ï¼Œå¹¶åˆ°â€œ&#x2F;proc&#x2F;kallsysâ€é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ï¼Œå‘ç°åœ¨ä¸Šé¢demoä¸­è°ƒç”¨çš„é©±åŠ¨ç¨‹åºçš„â€œopenâ€å‡½æ•°æ˜¯â€œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/ext4/file.c#L443">ext4_file_open()</a>â€ã€‚<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/ext4/file.c#L443">ext4_file_open()</a> å‡½æ•°è¿™é‡Œæˆ‘ä»¬ä¸å†è¿›è¡Œæ·±å…¥åˆ†æäº†ã€‚</p>
<h2 id="7-å„ä¸ªå‡½æ•°è¿”å›"><a href="#7-å„ä¸ªå‡½æ•°è¿”å›" class="headerlink" title="7. å„ä¸ªå‡½æ•°è¿”å›"></a><font size=3>7. å„ä¸ªå‡½æ•°è¿”å›</font></h2><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L735">do_dentry_open()</a> å‡½æ•°åœ¨è¿™é‡Œä¸å†è¿›è¡Œæ·±å…¥åˆ†æå…¶ä¸­çš„æ¯ä¸ªå‡½æ•°è°ƒç”¨ã€‚do_last()å‡½æ•°è¿”å›ä¹‹åï¼Œå›åˆ° <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3517">path_openat()</a> å‡½æ•°ï¼Œç”±äº <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3257">do_last()</a> å‡½æ•°è¿”å›å€¼ä¸º0ï¼Œå› æ­¤åœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3517">path_openat()</a> å‡½æ•°ä¸­é€€å‡ºwhile()å¾ªç¯ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€æ¡è¯­å¥ï¼š<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L593">terminate_walk()</a> ã€‚</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/image-20241214214800378.png" alt="image-20241214214800378" />

<p>è¯¥å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">terminate_walk</span><span class="params">(<span class="keyword">struct</span> nameidata *nd)</span></span><br><span class="line">&#123;</span><br><span class="line">	drop_links(nd);</span><br><span class="line">	<span class="keyword">if</span> (!(nd-&gt;flags &amp; LOOKUP_RCU)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 1</span></span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line">		path_put(&amp;nd-&gt;path);</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nd-&gt;depth; i++)<span class="comment">// nd-&gt;depth == 0, ç©ºå¾ªç¯</span></span><br><span class="line">			<span class="comment">//......</span></span><br><span class="line">		<span class="keyword">if</span> (nd-&gt;root.mnt &amp;&amp; !(nd-&gt;flags &amp; LOOKUP_ROOT)) &#123; <span class="comment">// if åˆ¤æ–­ä¸º 0</span></span><br><span class="line">			<span class="comment">//......</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">	nd-&gt;depth = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œç”±äº <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L583">drop_links()</a> æ˜¯å¤„ç†é“¾æ¥çš„æƒ…å†µï¼Œè¿™ä¸ªdemoä¸­ä¸æ¶‰åŠï¼Œè¯¥å‡½æ•°ä¸ºç©ºå‡½æ•°ã€‚å…¶ä¸­ï¼Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L476">path_put()</a> æ˜¯è¿›ç¨‹åŒæ­¥ç›¸å…³æ“ä½œï¼Œè¿™é‡Œä¸è¿›è¡Œåˆ†æã€‚è€Œ nd&rarr;depth æœ¬æ¥å°±ç­‰äºé›¶ï¼Œå› æ­¤è¿™é‡Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L593">terminate_walk()</a> é™¤äº†è¿›ç¨‹åŒæ­¥æ“ä½œä¹‹å¤–ï¼Œæ²¡æœ‰åšå…¶ä»–å·¥ä½œã€‚</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L593">terminate_walk()</a> å‡½æ•°ç»“æŸä¹‹åï¼Œæ•´ä¸ª <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3517">path_openat()</a> å‡½æ•°ä¹Ÿå°±è¿”å›äº†ï¼Œå›åˆ° <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3556">do_filp_open()</a> å‡½æ•°ã€‚<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3556">do_filp_open()</a>å‡½æ•°åœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L3517">path_openat()</a> å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åä¹Ÿå°±è¿”å›äº†ã€‚</p>
<p>ç°åœ¨å›åˆ°æœ€é¡¶å±‚å‡½æ•°ï¼š<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L1073">do_sys_open()</a> å‡½æ•°ã€‚ä¸‹é¢å°†æ‰§è¡Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/fsnotify.h#L210">fsnotify_open()</a> å’Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/file.c#L611">fd_install()</a> å‡½æ•°ã€‚ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/fsnotify.h#L210">fsnotify_open()</a> å‡½æ•°åœ¨è¿™é‡Œæš‚ä¸è¯¦ç»†åˆ†æï¼Œä»¥åå†è¯´ã€‚</p>
<p>è‡³æ­¤ï¼Œæ•´ä¸ª<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/open.c#L1073">do_sys_open()</a> å‡½æ•°åˆ†æå®Œæ¯•ã€‚è¿™é‡Œåªä»¥æœ€ç®€å•çš„å®ä¾‹è¿›è¡Œäº†åˆæ­¥åˆ†æï¼Œå¹¶å‘æ€§é—®é¢˜çš„åŒæ­¥æ§åˆ¶å’Œæƒé™æ£€æŸ¥ä»¥åŠé”™è¯¯å¤„ç†éƒ½æ²¡æœ‰è€ƒè™‘ã€‚åé¢å°†ä¼šå†è¯¦ç»†åˆ†æ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/fs/namei.c#L1789">walk_component()</a> å‡½æ•°ã€‚</p>
<h2 id="8-æ€»ç»“"><a href="#8-æ€»ç»“" class="headerlink" title="8. æ€»ç»“"></a><font size=3>8. æ€»ç»“</font></h2><p>ä¸Šé¢åˆ†æäº†é‚£ä¹ˆå¤šï¼Œæ¶‰åŠåˆ°å¤§é‡çš„å‡½æ•°ï¼Œå¤§æ¦‚äº†è§£ä¸€ä¸‹å°±è¡Œï¼Œè¿™é‡Œæ±‡æ€»ä¸€ä¸‹å‡½æ•°è°ƒç”¨å…³ç³»ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/LV05-03-Kernel-05-03-02-open%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%901/img/image-20241214223720583.png" alt="image-20241214223720583" />



<blockquote>
<p>å‚è€ƒèµ„æ–™</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/assiduous_me/article/details/124899439">Linuxä¸­openå‘½ä»¤å®ç°åŸç†ä»¥åŠæºç åˆ†æ_linux open-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/arm7star/article/details/78668951">linuxæ–‡ä»¶æè¿°ç¬¦åˆ†é…å®ç°è¯¦è§£(åŸºäºARMå¤„ç†å™¨)_fdtable-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/bgao86/article/details/79346389">Linux ç³»ç»Ÿè°ƒç”¨ä¹‹open(ä¸€ï¼‰_linux ç³»ç»Ÿè°ƒç”¨ä¹‹open(ä¸€)-CSDNåšå®¢</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">




    <div>
        
            <div style="text-align:center;color: #ccc;font-size:14px;">
            ----------æœ¬æ–‡ç»“æŸ
            <i class="fas fa-fan fa-spin" style="color: #FF1493; font-size: 1rem"></i>
            æ„Ÿè°¢æ‚¨çš„é˜…è¯»----------
            </div>
        
    </div>





  
  <div class="my_post_copyright"> 
    <p><span>æ–‡ç« æ ‡é¢˜:</span><a href="/post/9cc69d79.html">LV05-03-Kernel-05-03-02-openå‡½æ•°è§£æ1</a></p>
    <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="æ¬¢è¿è®¿é—® ã€Šè‹æœ¨ã€‹ çš„å­¦ä¹ ç¬”è®°">è‹æœ¨</a></p>
    <p><span>å‘å¸ƒæ—¶é—´:</span>2024å¹´12æœˆ17æ—¥ - 23:25</p>
    <p><span>æœ€åæ›´æ–°:</span>2025å¹´06æœˆ14æ—¥ - 00:25</p>
    <p><span>åŸå§‹é“¾æ¥:</span><a href="/post/9cc69d79.html" title="LV05-03-Kernel-05-03-02-openå‡½æ•°è§£æ1">https://sumumm.github.io/post/9cc69d79.html</a></p>
    <p><span>è®¸å¯åè®®:</span><i class="fab fa-creative-commons"></i> <a rel="license" href= "https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>  
  </div>
  


          <div class="post-tags">
              <a href="/tags/LV05-%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F/" rel="tag"><i class="fa fa-tag"></i> LV05-ç³»ç»Ÿé•œåƒ</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/d22d4c9b.html" rel="prev" title="LV05-03-Kernel-05-03-03-openå‡½æ•°è§£æ2">
                  <i class="fa fa-angle-left"></i> LV05-03-Kernel-05-03-03-openå‡½æ•°è§£æ2
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/5a460a0.html" rel="next" title="LV05-03-Kernel-05-03-01-openå‡½æ•°ç®€ä»‹">
                  LV05-03-Kernel-05-03-01-openå‡½æ•°ç®€ä»‹ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">è‹æœ¨</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">3.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">225:26</span>
  </span>
</div>




    <span id="sitetime"></span>
    <script defer language=javascript>
        function siteTime()
        {
            window.setTimeout("siteTime()", 1000);
            var seconds = 1000;
            var minutes = seconds * 60;
            var hours = minutes * 60;
            var days = hours * 24;
            var years = days * 365;
            var today = new Date();
            var todayYear = today.getFullYear();
            var todayMonth = today.getMonth()+1;
            var todayDate = today.getDate();
            var todayHour = today.getHours();
            var todayMinute = today.getMinutes();
            var todaySecond = today.getSeconds();
            /*==================================================
            Date.UTC() -- è¿”å›dateå¯¹è±¡è·ä¸–ç•Œæ ‡å‡†æ—¶é—´(UTC)1970å¹´1æœˆ1æ—¥åˆå¤œä¹‹é—´çš„æ¯«ç§’æ•°(æ—¶é—´æˆ³)
            year        - ä½œä¸ºdateå¯¹è±¡çš„å¹´ä»½ï¼Œä¸º4ä½å¹´ä»½å€¼
            month       - 0-11ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æœˆä»½
            day         - 1-31ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å¤©æ•°
            hours       - 0(åˆå¤œ24ç‚¹)-23ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å°æ—¶æ•°
            minutes     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„åˆ†é’Ÿæ•°
            seconds     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„ç§’æ•°
            microseconds - 0-999ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æ¯«ç§’æ•°
            ==================================================*/
            var t1 = Date.UTC(2017, 
                              5, 
                              19, 
                              0, 
                              0, 
                              0); //åŒ—äº¬æ—¶é—´
            var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
            var diff = t2-t1;
            var diffYears = Math.floor(diff/years);
            var diffDays = Math.floor((diff/days)-diffYears*365);
            var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
            var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
            var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
            document.getElementById("sitetime").innerHTML="å·²åœ¨è¿™é‡Œ "+diffYears+" å¹´ "+diffDays+" å¤© "+diffHours+" å°æ—¶ "+diffMinutes+" åˆ†é’Ÿ "+diffSeconds+" ç§’";
        }
        siteTime();
    </script>



    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


 
        <div id="click-show-text"
            data-mobile = false
            data-text = å¯Œå¼º,æ°‘ä¸»,æ–‡æ˜,å’Œè°,è‡ªç”±,å¹³ç­‰,å…¬æ­£,æ³•åˆ¶,çˆ±å›½,æ•¬ä¸š,è¯šä¿¡,å‹å–„
            data-fontsize = 15px
            data-random= false>
        </div>
       

      
        <script async src=https://cdn.jsdelivr.net/npm/hexo-next-mouse-effect@latest/click/showText.js></script>
      

      
    




    <script async src="/js/fancybox_param.js"></script>





<!-- APlayeræœ¬ä½“ -->



</body>
</html>
