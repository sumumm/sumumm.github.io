<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/green/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"sumumm.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":300},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="æœ¬æ–‡ä¸»è¦æ˜¯FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤å’ŒåŸºæœ¬ä½¿ç”¨ç›¸å…³ç¬”è®°ï¼Œè‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="LV16-22-FatFs-02-FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤">
<meta property="og:url" content="https://sumumm.github.io/post/fc1f4d1a.html">
<meta property="og:site_name" content="è‹æœ¨">
<meta property="og:description" content="æœ¬æ–‡ä¸»è¦æ˜¯FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤å’ŒåŸºæœ¬ä½¿ç”¨ç›¸å…³ç¬”è®°ï¼Œè‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-22-FatFs-02-FatFs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/img/image-20230602224918758.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-22-FatFs-02-FatFs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/img/image-20230602230210319.png">
<meta property="article:published_time" content="2023-06-04T14:07:22.000Z">
<meta property="article:modified_time" content="2025-06-13T16:25:57.012Z">
<meta property="article:author" content="è‹æœ¨">
<meta property="article:tag" content="LV16-STM32å¼€å‘">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-22-FatFs-02-FatFs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/img/image-20230602224918758.png">


<link rel="canonical" href="https://sumumm.github.io/post/fc1f4d1a.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sumumm.github.io/post/fc1f4d1a.html","path":"post/fc1f4d1a.html","title":"LV16-22-FatFs-02-FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LV16-22-FatFs-02-FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤ | è‹æœ¨</title>
  








    <script src="/js/browser_tools_disable.js"></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.com/hexo-next-tags-plus@latest/lib/tag_plus.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">è‹æœ¨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">æˆ‘çš„å­¦ä¹ ä¹‹è·¯</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>è‹æœ¨çš„å®¶</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»é¡µ<span class="badge">42</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£é¡µ<span class="badge">673</span></a></li><li class="menu-item menu-item-flink"><a href="/flink/" rel="section"><i class="fa fa-link fa-fw"></i>å‹äººå¸</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äºæˆ‘</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81API%E4%B8%8E%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-text">ä¸€ã€APIä¸è¿”å›å€¼</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%B8%A4%E4%B8%AA%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">1. ä¸¤ä¸ªç»“æ„ä½“</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-FATFS"><span class="nav-text">1.1 FATFS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-FIL"><span class="nav-text">1.2Â FIL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-text">2. å‡½æ•°è¿”å›å€¼</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E8%BF%94%E5%9B%9E%E5%80%BC%E7%9A%84%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B"><span class="nav-text">2.1 è¿”å›å€¼çš„æšä¸¾ç±»å‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%95%B0%E7%BB%84%EF%BC%9F"><span class="nav-text">2.2 å­—ç¬¦ä¸²æ•°ç»„ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-text">3. å¸¸ç”¨å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-f-mount"><span class="nav-text">3.1 f_mount()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-f-mkfs"><span class="nav-text">3.2Â f_mkfs()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%97%B6%E9%97%B4%E5%87%BD%E6%95%B0get-fattime"><span class="nav-text">4. æ—¶é—´å‡½æ•°get_fattime()</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E4%BA%8ESPI-FLASH%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-text">äºŒã€åŸºäºSPI FLASHçš„æ–‡ä»¶ç³»ç»Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BA%95%E5%B1%82%E8%AF%BB%E5%86%99"><span class="nav-text">1. åº•å±‚è¯»å†™</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">1.1 åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E8%8E%B7%E5%8F%96SPI-FLASH%E5%99%A8%E4%BB%B6ID"><span class="nav-text">1.2 è·å–SPI FLASHå™¨ä»¶ID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-text">1.3 è¯»å–æ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-text">1.4 å†™å…¥æ•°æ®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-diskio-c%E6%96%87%E4%BB%B6%E7%9A%84%E7%A7%BB%E6%A4%8D"><span class="nav-text">2.Â diskio.cæ–‡ä»¶çš„ç§»æ¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-drive-number"><span class="nav-text">2.1 drive number</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-disk-initialize"><span class="nav-text">2.2 disk_initialize()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="nav-text">2.2.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-%E5%AF%B9SPI-FLASH%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">2.2.2 å¯¹SPI FLASHåˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C"><span class="nav-text">2.2.3 ç§»æ¤ç»“æœ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-disk-status"><span class="nav-text">2.3 disk_status()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="nav-text">2.3.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-%E5%AF%B9SPI-FLASH%E7%9A%84%E7%8A%B6%E6%80%81%E6%A3%80%E6%B5%8B"><span class="nav-text">2.3.2 å¯¹SPI FLASHçš„çŠ¶æ€æ£€æµ‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C"><span class="nav-text">2.3.3 ç§»æ¤ç»“æœ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-disk-read"><span class="nav-text">2.4 disk_read()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="nav-text">2.4.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-%E4%BB%8ESPI-FLASH%E8%AF%BB%E5%8F%96"><span class="nav-text">2.4.2 ä»SPI FLASHè¯»å–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C"><span class="nav-text">2.4.3 ç§»æ¤ç»“æœ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-disk-write"><span class="nav-text">2.5 disk_write()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="nav-text">2.5.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-2-%E5%90%91SPI-FLASH%E5%86%99%E5%85%A5"><span class="nav-text">2.5.2 å‘SPI FLASHå†™å…¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C"><span class="nav-text">2.5.3 ç§»æ¤ç»“æœ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-disk-ioctl"><span class="nav-text">2.6 disk_ioctl()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="nav-text">2.6.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-2-%E8%8E%B7%E5%8F%96SPI-FLASH%E4%BF%A1%E6%81%AF"><span class="nav-text">2.6.2 è·å–SPI FLASHä¿¡æ¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C"><span class="nav-text">2.6.3 ç§»æ¤ç»“æœ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-ffconf-h%E6%96%87%E4%BB%B6%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-text">3. ffconf.hæ–‡ä»¶çš„é…ç½®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-FF-VOLUMES"><span class="nav-text">3.1 FF_VOLUMES</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-FF-MAX-SS"><span class="nav-text">3.2 FF_MAX_SS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-FF-USE-MKFS"><span class="nav-text">3.3 FF_USE_MKFS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-SPI-FLASH%E7%9A%84%E4%B8%80%E4%B8%AABUG"><span class="nav-text">3.4 SPI FLASHçš„ä¸€ä¸ªBUG</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%9F%BA%E4%BA%8ESD%E5%8D%A1%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-text">ä¸‰ã€åŸºäºSDå¡çš„æ–‡ä»¶ç³»ç»Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BA%95%E5%B1%82%E8%AF%BB%E5%86%99-1"><span class="nav-text">1. åº•å±‚è¯»å†™</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%88%9D%E5%A7%8B%E5%8C%96-1"><span class="nav-text">1.1 åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E8%8E%B7%E5%8F%96SD%E5%8D%A1%E4%BF%A1%E6%81%AF"><span class="nav-text">1.2 è·å–SDå¡ä¿¡æ¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE-1"><span class="nav-text">1.3 è¯»å–æ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE-1"><span class="nav-text">1.4 å†™å…¥æ•°æ®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-diskio-c%E6%96%87%E4%BB%B6%E7%9A%84%E7%A7%BB%E6%A4%8D-1"><span class="nav-text">2.Â diskio.cæ–‡ä»¶çš„ç§»æ¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-drive-number-1"><span class="nav-text">2.1 drive number</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-disk-initialize-1"><span class="nav-text">2.2 disk_initialize()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-1"><span class="nav-text">2.2.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-%E5%AF%B9SD%E5%8D%A1%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">2.2.2 å¯¹SDå¡åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C-1"><span class="nav-text">2.2.3 ç§»æ¤ç»“æœ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-disk-status-1"><span class="nav-text">2.3 disk_status()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-1"><span class="nav-text">2.3.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-%E5%AF%B9SD%E5%8D%A1%E7%9A%84%E7%8A%B6%E6%80%81%E6%A3%80%E6%B5%8B"><span class="nav-text">2.3.2 å¯¹SDå¡çš„çŠ¶æ€æ£€æµ‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C-1"><span class="nav-text">2.3.3 ç§»æ¤ç»“æœ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-disk-read-1"><span class="nav-text">2.4 disk_read()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-1"><span class="nav-text">2.4.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-%E4%BB%8ESD%E5%8D%A1%E8%AF%BB%E5%8F%96"><span class="nav-text">2.4.2 ä»SDå¡è¯»å–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C-1"><span class="nav-text">2.4.3 ç§»æ¤ç»“æœ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-disk-write-1"><span class="nav-text">2.5 disk_write()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-1"><span class="nav-text">2.5.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-2-%E5%90%91SD%E5%8D%A1%E5%86%99%E5%85%A5"><span class="nav-text">2.5.2 å‘SDå¡å†™å…¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C-1"><span class="nav-text">2.5.3 ç§»æ¤ç»“æœ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-disk-ioctl-1"><span class="nav-text">2.6 disk_ioctl()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-1-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-1"><span class="nav-text">2.6.1 å‡½æ•°å£°æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-2-%E8%8E%B7%E5%8F%96SD%E5%8D%A1%E4%BF%A1%E6%81%AF"><span class="nav-text">2.6.2 è·å–SDå¡ä¿¡æ¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-3-%E7%A7%BB%E6%A4%8D%E7%BB%93%E6%9E%9C-1"><span class="nav-text">2.6.3 ç§»æ¤ç»“æœ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-ffconf-h%E6%96%87%E4%BB%B6%E7%9A%84%E9%85%8D%E7%BD%AE-1"><span class="nav-text">3. ffconf.hæ–‡ä»¶çš„é…ç½®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-FF-VOLUMES-1"><span class="nav-text">3.1 FF_VOLUMES</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-FF-MAX-SS-1"><span class="nav-text">3.2 FF_MAX_SS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-FF-USE-MKFS-1"><span class="nav-text">3.3 FF_USE_MKFS</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%B8%80%E4%BA%9B%E6%B5%8B%E8%AF%95%E5%87%BD%E6%95%B0"><span class="nav-text">å››ã€ä¸€äº›æµ‹è¯•å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89"><span class="nav-text">1. æ–‡ä»¶ç³»ç»Ÿç»“æ„ä½“å®šä¹‰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%94%B3%E8%AF%B7%E5%86%85%E5%AD%98"><span class="nav-text">2. ç”³è¯·å†…å­˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%8E%B7%E5%8F%96%E7%A3%81%E7%9B%98%E5%AE%B9%E9%87%8F"><span class="nav-text">3. è·å–ç£ç›˜å®¹é‡</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="è‹æœ¨"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">è‹æœ¨</p>
  <div class="site-description" itemprop="description">è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">673</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/sumumm" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;sumumm" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sumumm.github.io/post/fc1f4d1a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="è‹æœ¨">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹æœ¨">
      <meta itemprop="description" content="è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="LV16-22-FatFs-02-FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤ | è‹æœ¨">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LV16-22-FatFs-02-FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-06-04 22:07:22" itemprop="dateCreated datePublished" datetime="2023-06-04T22:07:22+08:00">2023-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">åµŒå…¥å¼å¼€å‘</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/" itemprop="url" rel="index"><span itemprop="name">01HQè¯¾ç¨‹ä½“ç³»</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">LV16-STM32å¼€å‘</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>40 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>æœ¬æ–‡ä¸»è¦æ˜¯FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤å’ŒåŸºæœ¬ä½¿ç”¨ç›¸å…³ç¬”è®°ï¼Œè‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚</p>
<span id="more"></span>

<!-- Photo: https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-22-FatFs-02-FatFs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/img/ -->

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ä½¿ç”¨å·¥å…·åŠç‰ˆæœ¬ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center" width=150px>Windows</td>        <td align="left">windows11</td>    </tr>    <tr>        <td align="center">Ubuntu</td>        <td align="left">Ubuntu16.04çš„64ä½ç‰ˆæœ¬</td>      </tr>    <tr>        <td align="center">VMwareÂ® Workstation 16 Pro</td>        <td align="left">16.2.3 build-19376536</td>      </tr>    <tr>        <td align="center">SecureCRT</td>        <td align="left">Version 8.7.2 (x64 build 2214)   -   æ­£å¼ç‰ˆ-2020å¹´5æœˆ14æ—¥</td>      </tr>    <tr>        <td align="center">å¼€å‘æ¿</td>        <td align="left">æ­£ç‚¹åŸå­ i.MX6ULL Linuxé˜¿å°”æ³•å¼€å‘æ¿</td>      </tr>    <tr>        <td align="center">uboot</td>        <td align="left">NXPå®˜æ–¹æä¾›çš„ubootï¼ŒNXPæä¾›çš„ç‰ˆæœ¬ä¸ºuboot-imx-rel_imx_4.1.15_2.1.0_ga(ä½¿ç”¨çš„ubootç‰ˆæœ¬ä¸ºU-Boot 2016.03)</td>      </tr>    <tr>        <td align="center">linuxå†…æ ¸</td>        <td align="left">linux-4.15(NXPå®˜æ–¹æä¾›)</td>      </tr>    <tr>        <td align="center">STM32å¼€å‘æ¿</td>        <td align="left">æ­£ç‚¹åŸå­æˆ˜èˆ°V3(STM32F103ZET6)</td>      </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹æœ¬æ–‡å‚è€ƒèµ„æ–™ </summary>
              <div class='content'>
              <ul><li>é€šç”¨</li></ul><table><tr><td align="center">åˆ†ç±»  </td><td align="center">ç½‘å€</td><td align="center">è¯´æ˜</td></tr><tr><td align="center" rowspan="4">å®˜æ–¹ç½‘ç«™</td><td align="left"><a href="https://www.arm.com/" target="_blank">https://www.arm.com/</a></td><td align="left">ARMå®˜æ–¹ç½‘ç«™ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°Cotex-Mxä»¥åŠARMVxçš„ä¸€äº›æ–‡æ¡£</td></tr><tr>                                            <td align="left"><a href="https://www.st.com/content/st_com/zh.html" target="_blank">https://www.st.com/content/st_com/zh.html</a></td><td align="left">STå®˜æ–¹ç½‘ç«™ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°STM32çš„ç›¸å…³æ–‡æ¡£</td></tr><tr>                                            <td align="left"><a href="https://www.stmcu.com.cn/" target="_blank">https://www.stmcu.com.cn/</a></td><td align="left">æ„æ³•åŠå¯¼ä½“STä¸­æ–‡å®˜æ–¹ç½‘ç«™ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°STM32çš„ç›¸å…³ä¸­æ–‡å‚è€ƒæ–‡æ¡£</td></tr><tr>                                            <td align="left"><a href="http://elm-chan.org/fsw/ff/00index_e.html" target="_blank">http://elm-chan.org/fsw/ff/00index_e.html</a></td><td align="left">FatFsæ–‡ä»¶ç³»ç»Ÿå®˜ç½‘</td></tr><tr><td align="center" rowspan="3">æ•™ç¨‹ä¹¦ç±</td><td align="left"><a href="STM32å¼€å‘ç›¸å…³èµ„æ–™/01ARMå‚è€ƒèµ„æ–™/ARM Cortex-M3æƒå¨æŒ‡å—(ä¸­æ–‡).pdf" target="_blank">ã€ŠARM Cortex-M3æƒå¨æŒ‡å—ã€‹</a></td><td alirn="left" rowspan="3">ARMå…¬å¸ä¸“å®¶Joseph Yiuï¼ˆå§šæ–‡ç¥¥ï¼‰çš„åŠ›ä½œï¼Œä¸­æ–‡ç¿»è¯‘æ˜¯NXPçš„å®‹å²©</td></tr><tr>                                            <td align="left"><a href="STM32å¼€å‘ç›¸å…³èµ„æ–™/01ARMå‚è€ƒèµ„æ–™/ARM Cortex-M0æƒå¨æŒ‡å—(ä¸­æ–‡).pdf" target="_blank">ã€ŠARM Cortex-M0æƒå¨æŒ‡å—ã€‹</a></td></tr><tr>                                            <td align="left"><a href="" target="_blank">ã€ŠARM Cortex-M3ä¸Cortex-M4æƒå¨æŒ‡å—ã€‹</a></td></tr><tr><td align="center" rowspan="4">å¼€å‘è®ºå›</td><td align="left"><a href="http://47.111.11.73/forum.php" target="_blank">http://47.111.11.73/forum.php</a></td><td align="left">å¼€æºç”µå­ç½‘ï¼Œæ­£ç‚¹åŸå­çš„èµ„æ–™ä¸‹è½½åŠé—®é¢˜è®¨è®ºè®ºå›</td></tr><tr>                                            <td align="left"><a href="https://www.firebbs.cn/forum.php" target="_blank">https://www.firebbs.cn/forum.php</a></td><td align="left">å›½å†…Kinetiså¼€å‘æ¿-é‡ç«/ç§‰ç«ï¼ˆåˆ˜ç«è‰¯ï¼‰ä¸»æŒçš„è®ºå›ï¼Œç°ä¹ŸåšSTM32å’Œi.MX RT</td></tr><tr>                                            <td align="left"><a href="https://www.amobbs.com/index.php" target="_blank">https://www.amobbs.com/index.php</a></td><td align="left">é˜¿è«ï¼ˆè«è¿›æ˜ï¼‰ä¸»æŒçš„è®ºå›ï¼Œå·ç§°å›½å†…æœ€æ—©æœ€ç«çš„ç”µå­è®ºå›ï¼Œä»¥äº¤æµAtmel AVRç³»åˆ—å•ç‰‡æœºèµ·å®¶ï¼Œç°å·²æ‹“å±•åˆ°åµŒå…¥å¼å…¨å¹³å°ï¼Œå…¶STM32ç³»åˆ—å¸–å­æœ‰70W+ã€‚</td></tr><tr>                                            <td align="left"><a href="http://download.100ask.net/index.html" target="_blank">http://download.100ask.net/index.html</a></td><td align="left">éŸ¦ä¸œå±±åµŒå…¥å¼èµ„æ–™ä¸­å¿ƒï¼Œæœ‰äº›STM32å’Œlinuxçš„ç›¸å…³èµ„æ–™ä¹Ÿå¯ä»¥æ¥è¿™é‡Œæ‰¾ã€‚</td></tr><tr><td align="center" rowspan="3">åšå®¢å‚è€ƒ</td><td align="left"><a href="http://www.openedv.com/" target="_blank">http://www.openedv.com/</a></td><td align="left">å¼€æºç½‘-åŸå­å“¥ä¸ªäººåšå®¢</td></tr><tr>                                            <td align="left"><a href="http://blog.chinaaet.com/jihceng0622" target="_blank">http://blog.chinaaet.com/jihceng0622</a></td><td align="left">åšä¸»æ˜¯åŸFreescaleç°NXPçš„ç°åœºåº”ç”¨å·¥ç¨‹å¸ˆ</td></tr><tr>                                            <td align="left"><a href="https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/cortex-m-resources" target="_blank">cortex-m-resources</a></td><td align="left">è¿™å…¶å®å¹¶ä¸ç®—æ˜¯ä¸€ä¸ªåšå®¢ï¼Œè¿™æ˜¯ARMå…¬å¸ä¸“å®¶Joseph Yiuæ”¶é›†æ•´ç†çš„æ‰€æœ‰å¯¹å¼€å‘è€…æœ‰ç”¨çš„å®˜æ–¹Cortex-Mèµ„æ–™é“¾æ¥ï¼ˆä¹ŸåŒ…å«æå°‘æ•°å¤–éƒ¨èµ„æºé“¾æ¥ï¼‰</td></tr></table><ul><li>STM32</li></ul><table>    <tr><td align="center" rowspan="2">STM32</td><td align="left"><a href="https://doc.embedfire.com/mcu/stm32/f103/hal_general/zh/latest/index.html" target="_blank">STM32 HALåº“å¼€å‘å®æˆ˜æŒ‡å—â€”â€”åŸºäºF103ç³»åˆ—å¼€å‘æ¿</a></td><td align="left">é‡ç«STM32å¼€å‘æ•™ç¨‹åœ¨çº¿æ–‡æ¡£</td></tr><tr>                                            <td align="left"><a href="https://doc.embedfire.com/mcu/stm32/f103badao/std/zh/latest/index.html" target="_blank">STM32åº“å¼€å‘å®æˆ˜æŒ‡å—â€”â€”åŸºäºé‡ç«éœ¸é“å¼€å‘æ¿</a></td><td align="left">é‡ç«STM32å¼€å‘æ•™ç¨‹åœ¨çº¿æ–‡æ¡£</td></tr></table><ul><li>SDå¡</li></ul><table>    <tr><td align="left"><a href="https://www.sdcard.org/" target="_blank">SD Association</a></td><td align="left">æä¾›äº†SDå­˜å‚¨å¡å’ŒSDIOå¡ç³»ç»Ÿè§„èŒƒ</td></tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ç›¸å…³æ–‡ä»¶ä¸‹è½½ </summary>
              <div class='content'>
              <table>    <tr><td align="left"><a href="https://www.st.com/resource/en/datasheet/stm32f103ze.pdf" target="_blank">STM32F103xxè‹±æ–‡æ•°æ®æ‰‹å†Œ</a></td><td align="left">STM32F103xC/D/Eç³»åˆ—çš„è‹±æ–‡æ•°æ®æ‰‹å†Œ</td></tr>    <tr><td align="left"><a href="https://www.stmcu.com.cn/Designresource/detail/localization_document%20/709978" target="_blank">STM32F103xxä¸­æ–‡æ•°æ®æ‰‹å†Œ</a></td><td align="left">STM32F103xC/D/Eç³»åˆ—çš„ä¸­æ–‡æ•°æ®æ‰‹å†Œ</td></tr>    <tr><td align="left"><a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf" target="_blank">STM32F10xxxè‹±æ–‡å‚è€ƒæ‰‹å†Œï¼ˆRM0008ï¼‰</a></td><td align="left">STM32F10xxxç³»åˆ—çš„è‹±æ–‡å‚è€ƒæ‰‹å†Œ</td></tr>    <tr><td align="left"><a href="https://www.stmcu.com.cn/Designresource/detail/localization_document%20/710001" target="_blank">STM32F10xxxä¸­æ–‡å‚è€ƒæ‰‹å†Œï¼ˆRM0008ï¼‰</a></td><td align="left">STM32F10xxxç³»åˆ—çš„ä¸­æ–‡å‚è€ƒæ‰‹å†Œ</td></tr>    <tr><td align="left"><a href="https://developer.arm.com/documentation/100165/0201/?lang=en" target="_blank">Arm Cortex-M3 å¤„ç†å™¨æŠ€æœ¯å‚è€ƒæ‰‹å†Œ-è‹±æ–‡ç‰ˆ</a></td><td align="left">Cortex-M3æŠ€æœ¯å‚è€ƒæ‰‹å†Œ-è‹±æ–‡ç‰ˆ</td></tr>    <tr><td align="left"><a href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf" target="_blank">STM32F10xxx Cortex-M3ç¼–ç¨‹æ‰‹å†Œ-è‹±æ–‡ç‰ˆ(PM0056)</a></td><td align="left">STM32F10xxx/20xxx/21xxx/L1xxxxç³»åˆ—Cortex-M3ç¼–ç¨‹æ‰‹å†Œ-è‹±æ–‡ç‰ˆ</td></tr>    <tr><td align="left"><a href="https://www.sdcard.org/downloads/pls/" target="_blank">SDå¡ç›¸å…³èµ„æ–™â€”â€”æœ€æ–°ç‰ˆæœ¬</a></td><td align="left">æœ‰å…³SDå¡çš„ä¸€äº›èµ„æ–™å¯ä»¥ä»è¿™é‡Œä¸‹è½½</td></tr>    <tr><td align="left"><a href="https://www.sdcard.org/downloads/pls/archives/" target="_blank">SDå¡ç›¸å…³èµ„æ–™â€”â€”å†å²ç‰ˆæœ¬</a></td><td align="left">æœ‰å…³SDå¡çš„ä¸€äº›å†å²ç‰ˆæœ¬èµ„æ–™å¯ä»¥ä»è¿™é‡Œä¸‹è½½ï¼Œæ¯”å¦‚åè¾¹çœ‹çš„SDå¡2.0åè®®</td></tr>    <tr><td align="left"><a href="./" target="_blank">SD 2.0 åè®®æ ‡å‡†å®Œæ•´ç‰ˆ</a></td><td align="left">è¿™æ˜¯ä¸€ç¯‡å…³äºSDå¡2.0åè®®çš„ä¸­æ–‡æ–‡æ¡£ï¼Œè¿˜æ˜¯æ¯”è¾ƒæœ‰å‚è€ƒä»·å€¼çš„ï¼Œå¯ä»¥ä¸€çœ‹</td></tr></table>
              </div>
            </details>

<p>æ³¨æ„è¿™é‡Œçš„ä»£ç å¯èƒ½ä¼šç”¨åˆ°åŠ¨æ€ç®¡ç†å†…å­˜çš„ä¸œè¥¿ï¼Œå¯ä»¥çœ‹åè¾¹çš„ç¬”è®°ã€‚</p>
<h1 id="ä¸€ã€APIä¸è¿”å›å€¼"><a href="#ä¸€ã€APIä¸è¿”å›å€¼" class="headerlink" title="ä¸€ã€APIä¸è¿”å›å€¼"></a><font size=3>ä¸€ã€APIä¸è¿”å›å€¼</font></h1><p>æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªå‡½æ•°ï¼Œä»¥åŠç»“æ„ä½“ï¼Œæ–¹ä¾¿åè¾¹æµ‹è¯•å’Œé…ç½®çš„æ—¶å€™ä½¿ç”¨ã€‚</p>
<h2 id="1-ä¸¤ä¸ªç»“æ„ä½“"><a href="#1-ä¸¤ä¸ªç»“æ„ä½“" class="headerlink" title="1. ä¸¤ä¸ªç»“æ„ä½“"></a><font size=3>1. ä¸¤ä¸ªç»“æ„ä½“</font></h2><h3 id="1-1-FATFS"><a href="#1-1-FATFS" class="headerlink" title="1.1 FATFS"></a><font size=3>1.1 FATFS</font></h3><p>å…³äºè¯¥ç»“æ„ä½“ï¼Œå®ƒå®šä¹‰åœ¨ff.hæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/sfatfs.html">FatFs - FATFS (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Filesystem object structure (FATFS) */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	BYTE	fs_type;		<span class="comment">/* Filesystem type (0:not mounted) */</span></span><br><span class="line">	BYTE	pdrv;			<span class="comment">/* Volume hosting physical drive */</span></span><br><span class="line">	BYTE	ldrv;			<span class="comment">/* Logical drive number (used only when FF_FS_REENTRANT) */</span></span><br><span class="line">	BYTE	n_fats;			<span class="comment">/* Number of FATs (1 or 2) */</span></span><br><span class="line">	<span class="comment">// ä¸­é—´çš„éƒ¨åˆ†çœç•¥</span></span><br><span class="line">	BYTE	win[FF_MAX_SS];	<span class="comment">/* Disk access window for Directory, FAT (and file data at tiny cfg) */</span></span><br><span class="line">&#125; FATFS;</span><br></pre></td></tr></table></figure>

<p>FATFSç»“æ„(æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡)ä¿å­˜å„ä¸ªé€»è¾‘é©±åŠ¨å™¨çš„åŠ¨æ€å·¥ä½œåŒºåŸŸã€‚å®ƒç”±åº”ç”¨ç¨‹åºç»™å‡ºï¼Œå¹¶é€šè¿‡f_mountå‡½æ•°æ³¨å†Œ&#x2F;å–æ¶ˆæ³¨å†Œåˆ°FatFsæ¨¡å—ã€‚ç»“æ„çš„åˆå§‹åŒ–åœ¨å¿…è¦æ—¶ç”±å·æŒ‚è½½è¿›ç¨‹å®Œæˆã€‚åº”ç”¨ç¨‹åºä¸å¾—ä¿®æ”¹æ­¤ç»“æ„ä¸­çš„ä»»ä½•æˆå‘˜ï¼Œå¦åˆ™å°†å¯¼è‡´FATå·å´©æºƒã€‚</p>
<p>æˆ‘ä»¬è¦æ³¨æ„ä¸€ä¸‹è¿™ä¸ªç»“æ„ä½“æ˜¯éå¸¸å¤§çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ€åä¸€ä¸ªæˆå‘˜winï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¤§å°ä¸ºFF_MAX_SSï¼Œè¿™ä¸ªæœ€å¤§å€¼æˆ‘ä»¬åè¾¹å¯èƒ½ä¼šé…ç½®ä¸º4096ï¼Œè¿™æ ·ä¸‹æ¥è¿™ä¸ªç»“æ„ä½“å°±éå¸¸çš„å¤§ï¼Œç”¨å®ƒå®šä¹‰çš„å˜é‡æœ€å¥½ä¸è¦å®šä¹‰ä¸ºå±€éƒ¨å˜é‡ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´æ ˆçš„æº¢å‡ºï¼Œå½“ç„¶ï¼Œè¦æ˜¯æˆ‘ä»¬çš„æ ˆéå¸¸å¤§çš„è¯å—ï¼Œå°±å¯ä»¥ä¸ç”¨è€ƒè™‘è¿™ä¸ªé—®é¢˜äº†ã€‚</p>
<h3 id="1-2-FIL"><a href="#1-2-FIL" class="headerlink" title="1.2Â FIL"></a><font size=3>1.2Â FIL</font></h3><p>å…³äºè¯¥ç»“æ„ä½“ï¼Œå®ƒå®šä¹‰åœ¨ff.hä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/sfile.html">FatFs - FIL (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* File object structure (FIL) */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	FFOBJID	obj;			<span class="comment">/* Object identifier (must be the 1st member to detect invalid object pointer) */</span></span><br><span class="line">	BYTE	flag;			<span class="comment">/* File status flags */</span></span><br><span class="line">	BYTE	err;			<span class="comment">/* Abort flag (error code) */</span></span><br><span class="line">	FSIZE_t	fptr;			<span class="comment">/* File read/write pointer (Zeroed on file open) */</span></span><br><span class="line">	DWORD	clust;			<span class="comment">/* Current cluster of fpter (invalid when fptr is 0) */</span></span><br><span class="line">	LBA_t	sect;			<span class="comment">/* Sector number appearing in buf[] (0:invalid) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !FF_FS_READONLY</span></span><br><span class="line">	LBA_t	dir_sect;		<span class="comment">/* Sector number containing the directory entry (not used at exFAT) */</span></span><br><span class="line">	BYTE*	dir_ptr;		<span class="comment">/* Pointer to the directory entry in the win[] (not used at exFAT) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> FF_USE_FASTSEEK</span></span><br><span class="line">	DWORD*	cltbl;			<span class="comment">/* Pointer to the cluster link map table (nulled on open, set by application) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !FF_FS_TINY</span></span><br><span class="line">	BYTE	buf[FF_MAX_SS];	<span class="comment">/* File private data read/write window */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; FIL;</span><br></pre></td></tr></table></figure>

<p>FILç»“æ„(æ–‡ä»¶å¯¹è±¡)ä¿å­˜æ‰“å¼€æ–‡ä»¶çš„çŠ¶æ€ã€‚å®ƒç”±f_openå‡½æ•°åˆ›å»ºï¼Œå¹¶ç”±f_closeå‡½æ•°ä¸¢å¼ƒã€‚åº”ç”¨ç¨‹åºä¸èƒ½ä¿®æ”¹è¯¥ç»“æ„ä¸­é™¤cltblä¹‹å¤–çš„ä»»ä½•æˆå‘˜ï¼Œå¦åˆ™å°†å¯¼è‡´FATå·å´©æºƒã€‚è¯·æ³¨æ„ï¼Œæ‰‡åŒºç¼“å†²åŒºæ˜¯åœ¨éå¾®å°é…ç½®(FF_FS_TINY &#x3D;&#x3D; 0)çš„ç»“æ„ä¸­å®šä¹‰çš„ï¼Œå› æ­¤è¯¥é…ç½®ä¸­çš„FILç»“æ„ä¸åº”è¯¥è¢«å®šä¹‰ä¸ºè‡ªåŠ¨å˜é‡ã€‚</p>
<p>æˆ‘ä»¬è¦æ³¨æ„ä¸€ä¸‹è¿™ä¸ªç»“æ„ä½“æ˜¯éå¸¸å¤§çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ€åä¸€ä¸ªæˆå‘˜bufï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¤§å°ä¸ºFF_MAX_SSï¼Œè¿™ä¸ªæœ€å¤§å€¼æˆ‘ä»¬åè¾¹å¯èƒ½ä¼šé…ç½®ä¸º4096ï¼Œè¿™æ ·ä¸‹æ¥è¿™ä¸ªç»“æ„ä½“è·ŸFATFSä¸€æ ·ï¼Œå°±éå¸¸çš„å¤§ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬ä¹Ÿä¸ä¼šå°†å…¶å®šä¹‰ä¸ºå±€éƒ¨å˜é‡ã€‚</p>
<h2 id="2-å‡½æ•°è¿”å›å€¼"><a href="#2-å‡½æ•°è¿”å›å€¼" class="headerlink" title="2. å‡½æ•°è¿”å›å€¼"></a><font size=3>2. å‡½æ•°è¿”å›å€¼</font></h2><h3 id="2-1-è¿”å›å€¼çš„æšä¸¾ç±»å‹"><a href="#2-1-è¿”å›å€¼çš„æšä¸¾ç±»å‹" class="headerlink" title="2.1 è¿”å›å€¼çš„æšä¸¾ç±»å‹"></a><font size=3>2.1 è¿”å›å€¼çš„æšä¸¾ç±»å‹</font></h3><p>æˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹æˆ‘ä»¬å¸¸ç”¨çš„ä¸€äº›å‡½æ•°çš„è¿”å›å€¼çš„å«ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›è¿”å›å€¼æ¥åˆ¤æ–­æ˜¯å“ªé‡Œå‡ºé”™äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* File function return code (FRESULT) */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">	FR_OK = <span class="number">0</span>,				<span class="comment">/* (0) Succeeded */</span></span><br><span class="line">	FR_DISK_ERR,			<span class="comment">/* (1) A hard error occurred in the low level disk I/O layer */</span></span><br><span class="line">	FR_INT_ERR,				<span class="comment">/* (2) Assertion failed */</span></span><br><span class="line">	FR_NOT_READY,			<span class="comment">/* (3) The physical drive cannot work */</span></span><br><span class="line">	FR_NO_FILE,				<span class="comment">/* (4) Could not find the file */</span></span><br><span class="line">	FR_NO_PATH,				<span class="comment">/* (5) Could not find the path */</span></span><br><span class="line">	FR_INVALID_NAME,		<span class="comment">/* (6) The path name format is invalid */</span></span><br><span class="line">	FR_DENIED,				<span class="comment">/* (7) Access denied due to prohibited access or directory full */</span></span><br><span class="line">	FR_EXIST,				<span class="comment">/* (8) Access denied due to prohibited access */</span></span><br><span class="line">	FR_INVALID_OBJECT,		<span class="comment">/* (9) The file/directory object is invalid */</span></span><br><span class="line">	FR_WRITE_PROTECTED,		<span class="comment">/* (10) The physical drive is write protected */</span></span><br><span class="line">	FR_INVALID_DRIVE,		<span class="comment">/* (11) The logical drive number is invalid */</span></span><br><span class="line">	FR_NOT_ENABLED,			<span class="comment">/* (12) The volume has no work area */</span></span><br><span class="line">	FR_NO_FILESYSTEM,		<span class="comment">/* (13) There is no valid FAT volume */</span></span><br><span class="line">	FR_MKFS_ABORTED,		<span class="comment">/* (14) The f_mkfs() aborted due to any problem */</span></span><br><span class="line">	FR_TIMEOUT,				<span class="comment">/* (15) Could not get a grant to access the volume within defined period */</span></span><br><span class="line">	FR_LOCKED,				<span class="comment">/* (16) The operation is rejected according to the file sharing policy */</span></span><br><span class="line">	FR_NOT_ENOUGH_CORE,		<span class="comment">/* (17) LFN working buffer could not be allocated */</span></span><br><span class="line">	FR_TOO_MANY_OPEN_FILES,	<span class="comment">/* (18) Number of open files &gt; FF_FS_LOCK */</span></span><br><span class="line">	FR_INVALID_PARAMETER	<span class="comment">/* (19) Given parameter is invalid */</span></span><br><span class="line">&#125; FRESULT;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒä¹Ÿå®šä¹‰åœ¨ff.hä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£æ¥è¯¦ç»†äº†è§£è¿™äº›å€¼çš„å«ä¹‰ï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/rc.html#id">FatFs - API Return Code (elm-chan.org)</a></p>
<h3 id="2-2-å­—ç¬¦ä¸²æ•°ç»„ï¼Ÿ"><a href="#2-2-å­—ç¬¦ä¸²æ•°ç»„ï¼Ÿ" class="headerlink" title="2.2 å­—ç¬¦ä¸²æ•°ç»„ï¼Ÿ"></a><font size=3>2.2 å­—ç¬¦ä¸²æ•°ç»„ï¼Ÿ</font></h3><p>ä¸Šè¾¹è¿”å›å€¼å¥½å¤šï¼Œæˆ‘ä»¬çŸ¥é“å€¼çš„è¯ï¼Œè¿˜éœ€è¦çŸ¥é“ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥å®šä¹‰ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼ŒæŒ‰é¡ºåºå°†ä¸Šè¾¹çš„æšä¸¾æ‰€ä»£è¡¨çš„å«ä¹‰ä¾æ¬¡å†™å…¥ï¼Œç„¶åæ‰“å°çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥è·å–é”™è¯¯ç çš„å«ä¹‰äº†ï¼Œä¸è¿‡è¿™æ ·å¯èƒ½ä¼šæ¯”è¾ƒå å†…å­˜ï¼Œæ…ç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> BYTE API_RET[][<span class="number">90</span>] = &#123;</span><br><span class="line">    <span class="string">&quot;(0) Succeeded &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(1) A hard error occurred in the low level disk I/O layer &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(2) Assertion failed &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(3) The physical drive cannot work &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(4) Could not find the file &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(5) Could not find the path &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(6) The path name format is invalid &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(7) Access denied due to prohibited access or directory full &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(8) Access denied due to prohibited access &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(9) The file/directory object is invalid &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(10) The physical drive is write protected &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(11) The logical drive number is invalid &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(12) The volume has no work area &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(13) There is no valid FAT volume &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(14) The f_mkfs() aborted due to any problem &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(15) Could not get a grant to access the volume within defined period &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(16) The operation is rejected according to the file sharing policy &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(17) LFN working buffer could not be allocated &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(18) Number of open files &gt; FF_FS_LOCK &quot;</span>,</span><br><span class="line">    <span class="string">&quot;(19) Given parameter is invalid &quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å°çš„æ—¶å€™å°±å¯ä»¥è¿™æ ·ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;res:%s\n\r&quot;</span>, API_RET[res]);</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±å¯ä»¥ç›´æ¥å°†é”™è¯¯çš„åŸå› æ‰“å°å‡ºæ¥å•¦ã€‚</p>
<h2 id="3-å¸¸ç”¨å‡½æ•°"><a href="#3-å¸¸ç”¨å‡½æ•°" class="headerlink" title="3. å¸¸ç”¨å‡½æ•°"></a><font size=3>3. å¸¸ç”¨å‡½æ•°</font></h2><h3 id="3-1-f-mount"><a href="#3-1-f-mount" class="headerlink" title="3.1 f_mount()"></a><font size=3>3.1 f_mount()</font></h3><p>æˆ‘ä»¬å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/mount.html">FatFs - f_mount (elm-chan.org)</a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FRESULT <span class="title function_">f_mount</span> <span class="params">(</span></span><br><span class="line"><span class="params">  FATFS*       fs,    <span class="comment">/* [IN] Filesystem object */</span></span></span><br><span class="line"><span class="params">  <span class="type">const</span> TCHAR* path,  <span class="comment">/* [IN] Logical drive number */</span></span></span><br><span class="line"><span class="params">  BYTE         opt    <span class="comment">/* [IN] Initialization option */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°è¯´æ˜ã€‘</strong>f_mountå‡½æ•°ä¸ºFatFsæ¨¡å—æä¾›å·¥ä½œåŒºåŸŸã€‚ä¹Ÿå°±æ˜¯ç”¨äºæŒ‚è½½æˆ‘ä»¬å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½ä¹‹åæˆ‘ä»¬æ‰èƒ½æ­£å¸¸çš„ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚</p>
<p><strong>ã€å‡½æ•°å‚æ•°ã€‘</strong></p>
<ul>
<li>fs ï¼šæŒ‡å‘è¦æ³¨å†Œå’Œæ¸…é™¤çš„æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡çš„æŒ‡é’ˆã€‚è‹¥æ˜¯NULLçš„è¯ï¼Œåˆ™è¡¨ç¤ºå–æ¶ˆæ³¨å†Œå·²æ³¨å†Œçš„æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡ï¼Œæ¯ä¸ªå­˜å‚¨ä»‹è´¨åªéœ€è¦ä¸€ä¸ªå³å¯ï¼Œç”¨äºå­˜å‚¨è¿™ä¸ªå­˜å‚¨è®¾å¤‡çš„æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ã€‚</li>
<li>path ï¼šæŒ‡å‘æŒ‡å®šé€»è¾‘é©±åŠ¨å™¨çš„ä»¥ç©ºç»“å°¾çš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚ä¸å¸¦é©±åŠ¨å™¨å·çš„å­—ç¬¦ä¸²ä¸ºé»˜è®¤é©±åŠ¨å™¨ã€‚æ¯”å¦‚æˆ‘ä»¬ä¸Šè¾¹è§„å®šçš„SPI FLASHçš„drive numberä¸º1ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥å†™ â€œ1:â€ ï¼Œå½“æŒ‚è½½æˆåŠŸåï¼Œä»–å°±ç›¸å½“äºæˆ‘ä»¬winä¸­çš„Cã€Dç­‰è¿™äº›çš„ç›˜ç¬¦ã€‚</li>
<li>opt ï¼š0ï¼Œç°åœ¨ä¸æŒ‚è½½(è¦åœ¨ç¬¬ä¸€æ¬¡è®¿é—®å·æ—¶æŒ‚è½½)ï¼Œ1ï¼Œå¼ºåˆ¶ç«‹å³æŒ‚è½½å·ï¼Œå¹¶æ£€æŸ¥å·æ˜¯å¦å¯ä»¥å·¥ä½œã€‚</li>
</ul>
<h3 id="3-2-f-mkfs"><a href="#3-2-f-mkfs" class="headerlink" title="3.2Â f_mkfs()"></a><font size=3>3.2Â f_mkfs()</font></h3><p>æˆ‘ä»¬å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/mkfs.html">FatFs - f_mkfs (elm-chan.org)</a>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FRESULT <span class="title function_">f_mkfs</span> <span class="params">(</span></span><br><span class="line"><span class="params">  <span class="type">const</span> TCHAR* path,   <span class="comment">/* [IN] Logical drive number */</span></span></span><br><span class="line"><span class="params">  <span class="type">const</span> MKFS_PARM* opt,<span class="comment">/* [IN] Format options */</span></span></span><br><span class="line"><span class="params">  <span class="type">void</span>* work,          <span class="comment">/* [-]  Working buffer */</span></span></span><br><span class="line"><span class="params">  UINT len             <span class="comment">/* [IN] Size of working buffer */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°è¯´æ˜ã€‘</strong>f_mkfså‡½æ•°åœ¨é€»è¾‘é©±åŠ¨å™¨ä¸Šåˆ›å»ºä¸€ä¸ªFAT&#x2F;exFATå·ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±æ˜¯æˆ‘ä»¬çš„å­˜å‚¨ä»‹è´¨ä¸ŠåŸæœ¬æ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ ¼å¼åŒ–å¹¶åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½æ­£å¸¸çš„å»ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæ¥ç®¡ç†å…¶ä¸­çš„æ–‡ä»¶ã€‚</p>
<p><strong>ã€å‡½æ•°å‚æ•°ã€‘</strong></p>
<ul>
<li><p>pathï¼šæŒ‡å‘ä»¥ç©ºç»“å°¾çš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆæŒ‡å®šè¦æ ¼å¼åŒ–çš„é€»è¾‘é©±åŠ¨å™¨ã€‚å¦‚æœå…¶ä¸­æ²¡æœ‰é©±åŠ¨å™¨å·ï¼Œåˆ™è¡¨ç¤ºæŒ‡å®šé»˜è®¤é©±åŠ¨å™¨ã€‚åœ¨æ ¼å¼åŒ–è¿‡ç¨‹ä¸­ï¼Œé€»è¾‘é©±åŠ¨å™¨å¯èƒ½å·²ç»æŒ‚è½½ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰æŒ‚è½½ã€‚</p>
</li>
<li><p>opt ï¼šMKFS_PARM ç±»å‹ç»“æ„ä½“æŒ‡é’ˆå˜é‡ï¼Œè¡¨ç¤ºæ ¼å¼é€‰é¡¹ã€‚å¦‚æœç»™å‡ºä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œå®ƒå°†ç»™å‡½æ•°æä¾›é»˜è®¤å€¼ä¸­çš„æ¯ä¸ªé€‰é¡¹ï¼Œè¯¦ç»†æƒ…å†µæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å‚è€ƒæ–‡æ¡£ä¸­çš„è¯¦ç»†è¯´æ˜ã€‚</p>
</li>
<li><p>work ï¼šæŒ‡å‘æ ¼å¼åŒ–è¿‡ç¨‹ä½¿ç”¨çš„å·¥ä½œç¼“å†²åŒºçš„æŒ‡é’ˆã€‚å¦‚æœ null æŒ‡é’ˆä»¥ FF_USE_LFN &#x3D;&#x3D; 3 ç»™å‡ºï¼Œåˆ™è¯¥å‡½æ•°åœ¨æ­¤å‡½æ•°ä¸­ä½¿ç”¨ len å­—èŠ‚çš„å †å†…å­˜ã€‚</p>
</li>
<li><p>len ï¼šå·¥ä½œç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚å®ƒè‡³å°‘éœ€è¦æ˜¯FF_MAX_SSã€‚å¤§é‡çš„å·¥ä½œç¼“å†²åŒºå‡å°‘äº†å¯¹é©±åŠ¨å™¨çš„å†™äº‹åŠ¡æ•°é‡ï¼Œå› æ­¤æ ¼å¼åŒ–è¿‡ç¨‹å°†å¾ˆå¿«å®Œæˆã€‚</p>
</li>
</ul>
<h2 id="4-æ—¶é—´å‡½æ•°get-fattime"><a href="#4-æ—¶é—´å‡½æ•°get-fattime" class="headerlink" title="4. æ—¶é—´å‡½æ•°get_fattime()"></a><font size=3>4. æ—¶é—´å‡½æ•°get_fattime()</font></h2><p>è¿™ä¸ªå‡½æ•°æ˜¯æ‰€æœ‰å­˜å‚¨ä»‹è´¨ç§»æ¤çš„æ—¶å€™éƒ½éœ€è¦çš„ï¼Œè¿™ä¸ªå‡½æ•°åœ¨FatFsæºç ä¸­æ²¡æœ‰å®šä¹‰ï¼Œä½†æ˜¯åˆç”¨åˆ°äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦å®šä¹‰ä¸€ä¸‹çš„ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å‚è€ƒæ–‡æ¡£<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/fattime.html">FatFs - get_fattime (elm-chan.org)</a>ï¼Œå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DWORD <span class="title function_">get_fattime</span> <span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯è·å–å½“å‰çš„æ—¶é—´ï¼Œè¿™ä¸ªå‡½æ•°åœ¨FatFsç³»ç»Ÿä¸­æ²¡æœ‰å®ç°ï¼Œæˆ‘ä»¬ç›´æ¥ç¼–è¯‘æ˜¯ä¼šæŠ¥è¿™ä¸ªé”™è¯¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡STM32çš„RTCæ¥è·å–æ—¶é—´ï¼Œå½“ç„¶ï¼Œè‹¥æ˜¯æš‚æ—¶ä¸éœ€è¦ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶å®šä¹‰ä¸ºå¦‚ä¸‹çš„å½¢å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  è·å–å½“å‰ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line"><span class="comment">  * @note   ç”¨äºæ–‡ä»¶æ—¶é—´å±æ€§çš„ç¡®å®š</span></span><br><span class="line"><span class="comment">  * @param  </span></span><br><span class="line"><span class="comment">  * @retval </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">DWORD <span class="title function_">get_fattime</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* è¿”å›å½“å‰æ—¶é—´æˆ³ */</span></span><br><span class="line">	<span class="keyword">return</span> ((DWORD)(<span class="number">2015</span> - <span class="number">1980</span>) &lt;&lt; <span class="number">25</span>) <span class="comment">/* Year 2015 */</span></span><br><span class="line">		   | ((DWORD)<span class="number">1</span> &lt;&lt; <span class="number">21</span>)			<span class="comment">/* Month 1 */</span></span><br><span class="line">		   | ((DWORD)<span class="number">1</span> &lt;&lt; <span class="number">16</span>)			<span class="comment">/* Mday 1 */</span></span><br><span class="line">		   | ((DWORD)<span class="number">0</span> &lt;&lt; <span class="number">11</span>)			<span class="comment">/* Hour 0 */</span></span><br><span class="line">		   | ((DWORD)<span class="number">0</span> &lt;&lt; <span class="number">5</span>)			<span class="comment">/* Min 0 */</span></span><br><span class="line">		   | ((DWORD)<span class="number">0</span> &gt;&gt; <span class="number">1</span>);			<span class="comment">/* Sec 0 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="äºŒã€åŸºäºSPI-FLASHçš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#äºŒã€åŸºäºSPI-FLASHçš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="äºŒã€åŸºäºSPI FLASHçš„æ–‡ä»¶ç³»ç»Ÿ"></a><font size=3>äºŒã€åŸºäºSPI FLASHçš„æ–‡ä»¶ç³»ç»Ÿ</font></h1><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä»¥SPI FLASHä¸ºå­˜å‚¨ä»‹è´¨çš„FatFsæ–‡ä»¶ç³»ç»Ÿçš„ç§»æ¤ã€‚</p>
<h2 id="1-åº•å±‚è¯»å†™"><a href="#1-åº•å±‚è¯»å†™" class="headerlink" title="1. åº•å±‚è¯»å†™"></a><font size=3>1. åº•å±‚è¯»å†™</font></h2><h3 id="1-1-åˆå§‹åŒ–"><a href="#1-1-åˆå§‹åŒ–" class="headerlink" title="1.1 åˆå§‹åŒ–"></a><font size=3>1.1 åˆå§‹åŒ–</font></h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–SPI FLASHï¼Œåœ¨è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯W25Q128ï¼Œç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯STM32CubeMXæ¥é…ç½®çš„SPIï¼Œæ‰€ä»¥åˆå§‹åŒ–å°±å¦‚ä¸‹å‡½æ•°æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPI2 init function */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MX_SPI2_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-è·å–SPI-FLASHå™¨ä»¶ID"><a href="#1-2-è·å–SPI-FLASHå™¨ä»¶ID" class="headerlink" title="1.2 è·å–SPI FLASHå™¨ä»¶ID"></a><font size=3>1.2 è·å–SPI FLASHå™¨ä»¶ID</font></h3><p>è¿™ä¸€æ­¥å…¶å®æœ¬ä¸æ˜¯å¿…é¡»ï¼Œä½†æ˜¯ç”±äºä»£ç æ”¯æŒäº†å…¶ä»–å‹å·çš„SPI FLASHï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ä¹Ÿå°±æˆäº†å¿…è¦çš„æ­¥éª¤ï¼Œå…¶å®ä¹Ÿæœ‰å¥½å¤„ï¼Œé‚£å°±æ˜¯å¯ä»¥é€šè¿‡è¯»å–IDæ¥åˆ¤æ–­æˆ‘ä»¬çš„SPI FLASHæ˜¯å¦å·²ç»åˆå§‹åŒ–å®Œæˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  è·å–W25QXXå‹å·</span></span><br><span class="line"><span class="comment">  * @note   ç›®å‰åªæ”¯æŒW25Q128</span></span><br><span class="line"><span class="comment">  * @param  </span></span><br><span class="line"><span class="comment">  * @retval è¿”å›0è¡¨ç¤ºW25Q128çŠ¶æ€æ­£å¸¸ï¼Œè¿”å›-1è¡¨ç¤ºW25Q128ä¸å¯ç”¨</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">int8_t</span> <span class="title function_">Get_W25QXX_Type</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    W25QXX_TYPE = W25QXX_ReadID();</span><br><span class="line">    <span class="comment">//printf(&quot;SPI FLASH ID=%#x\r\n&quot;, W25QXX_TYPE);</span></span><br><span class="line">    <span class="keyword">if</span>(W25QXX_TYPE == <span class="number">0XEF17</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        PRTE(<span class="string">&quot;W25QXX_TYPE not is W25Q128!!!\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-è¯»å–æ•°æ®"><a href="#1-3-è¯»å–æ•°æ®" class="headerlink" title="1.3 è¯»å–æ•°æ®"></a><font size=3>1.3 è¯»å–æ•°æ®</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  è¯»å–SPI FLASH</span></span><br><span class="line"><span class="comment">  * @note   åœ¨æŒ‡å®šåœ°å€å¼€å§‹è¯»å–æŒ‡å®šé•¿åº¦çš„æ•°æ®</span></span><br><span class="line"><span class="comment">  * @param  pBuffer æ•°æ®å­˜å‚¨åŒº</span></span><br><span class="line"><span class="comment">  * @param  ReadAddr å¼€å§‹è¯»å–çš„åœ°å€(24bit)</span></span><br><span class="line"><span class="comment">  * @param  NumByteToRead è¦è¯»å–çš„å­—èŠ‚æ•°(æœ€å¤§65535)</span></span><br><span class="line"><span class="comment">  * @retval æˆåŠŸè¿”å›0</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">int8_t</span> <span class="title function_">W25QXX_Read</span><span class="params">(<span class="type">uint8_t</span> *pBuffer, <span class="type">uint32_t</span> ReadAddr, <span class="type">uint16_t</span> NumByteToRead)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> i;</span><br><span class="line">    W25QXX_CS = <span class="number">0</span>;                     <span class="comment">// ä½¿èƒ½å™¨ä»¶</span></span><br><span class="line">    SPI2_ReadWriteByte(W25X_ReadData); <span class="comment">// å‘é€è¯»å–å‘½ä»¤</span></span><br><span class="line">    <span class="keyword">if</span> (W25QXX_TYPE == W25Q256)        <span class="comment">// å¦‚æœæ˜¯W25Q256çš„è¯åœ°å€ä¸º4å­—èŠ‚çš„ï¼Œè¦å‘é€æœ€é«˜8ä½</span></span><br><span class="line">    &#123;</span><br><span class="line">        SPI2_ReadWriteByte((<span class="type">uint8_t</span>)((ReadAddr) &gt;&gt; <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    SPI2_ReadWriteByte((<span class="type">uint8_t</span>)((ReadAddr) &gt;&gt; <span class="number">16</span>)); <span class="comment">// å‘é€24bitåœ°å€</span></span><br><span class="line">    SPI2_ReadWriteByte((<span class="type">uint8_t</span>)((ReadAddr) &gt;&gt; <span class="number">8</span>));</span><br><span class="line">    SPI2_ReadWriteByte((<span class="type">uint8_t</span>)ReadAddr);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NumByteToRead; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pBuffer[i] = SPI2_ReadWriteByte(<span class="number">0XFF</span>); <span class="comment">// å¾ªç¯è¯»æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line">    W25QXX_CS = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-å†™å…¥æ•°æ®"><a href="#1-4-å†™å…¥æ•°æ®" class="headerlink" title="1.4 å†™å…¥æ•°æ®"></a><font size=3>1.4 å†™å…¥æ•°æ®</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŠ¨æ€ç®¡ç†å†…å­˜</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span>	SRAMIN   </span></span><br><span class="line"><span class="type">uint8_t</span> W25QXX_BUFFER[<span class="number">4096</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>	</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  å‘ SPI FLASH å†™å…¥æŒ‡å®šå­—èŠ‚æ•°æ®</span></span><br><span class="line"><span class="comment">  * @note   åœ¨æŒ‡å®šåœ°å€å¼€å§‹å†™å…¥æŒ‡å®šé•¿åº¦çš„æ•°æ®,è¯¥å‡½æ•°å¸¦æ“¦é™¤æ“ä½œ!</span></span><br><span class="line"><span class="comment">  * @param  pBuffer æ•°æ®å­˜å‚¨åŒº</span></span><br><span class="line"><span class="comment">  * @param  WriteAddr å¼€å§‹å†™å…¥çš„åœ°å€(24bit)</span></span><br><span class="line"><span class="comment">  * @param  NumByteToWrite è¦å†™å…¥çš„å­—èŠ‚æ•°(æœ€å¤§65535)  </span></span><br><span class="line"><span class="comment">  * @retval æˆåŠŸè¿”å›0</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">int8_t</span> <span class="title function_">W25QXX_Write</span><span class="params">(<span class="type">uint8_t</span> *pBuffer, <span class="type">uint32_t</span> WriteAddr, <span class="type">uint16_t</span> NumByteToWrite)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> secpos;</span><br><span class="line">    <span class="type">uint16_t</span> secoff;</span><br><span class="line">    <span class="type">uint16_t</span> secremain;</span><br><span class="line">    <span class="type">uint16_t</span> i;</span><br><span class="line">    <span class="type">uint8_t</span> *W25QXX_BUF;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRAMIN</span></span><br><span class="line">    W25QXX_BUF = (<span class="type">uint8_t</span> *)pub_malloc(SRAMIN, <span class="number">4096</span>); <span class="comment">// ç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (W25QXX_BUF == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        PRTE(<span class="string">&quot;pub_malloc failed!!!\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// ç”³è¯·å¤±è´¥</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    W25QXX_BUF = W25QXX_BUFFER;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    secpos = WriteAddr / W25QXX_SECTOR_SIZE; <span class="comment">// æ‰‡åŒºåœ°å€</span></span><br><span class="line">    secoff = WriteAddr % W25QXX_SECTOR_SIZE; <span class="comment">// åœ¨æ‰‡åŒºå†…çš„åç§»</span></span><br><span class="line">    secremain = W25QXX_SECTOR_SIZE - secoff; <span class="comment">// æ‰‡åŒºå‰©ä½™ç©ºé—´å¤§å°</span></span><br><span class="line">    <span class="comment">// printf(&quot;ad:%X,nb:%X\r\n&quot;,WriteAddr,NumByteToWrite);//æµ‹è¯•ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (NumByteToWrite &lt;= secremain)</span><br><span class="line">        secremain = NumByteToWrite; <span class="comment">// ä¸å¤§äº4096ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        W25QXX_Read(W25QXX_BUF, secpos * W25QXX_SECTOR_SIZE, W25QXX_SECTOR_SIZE); <span class="comment">// è¯»å‡ºæ•´ä¸ªæ‰‡åŒºçš„å†…å®¹</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; secremain; i++)                                           <span class="comment">// æ ¡éªŒæ•°æ®</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (W25QXX_BUF[secoff + i] != <span class="number">0XFF</span>)</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// éœ€è¦æ“¦é™¤</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; secremain) <span class="comment">// éœ€è¦æ“¦é™¤</span></span><br><span class="line">        &#123;</span><br><span class="line">            W25QXX_Erase_Sector(secpos);    <span class="comment">// æ“¦é™¤è¿™ä¸ªæ‰‡åŒº</span></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; secremain; i++) <span class="comment">// å¤åˆ¶</span></span><br><span class="line">            &#123;</span><br><span class="line">                W25QXX_BUF[i + secoff] = pBuffer[i];</span><br><span class="line">            &#125;</span><br><span class="line">            W25QXX_Write_NoCheck(W25QXX_BUF, secpos * W25QXX_SECTOR_SIZE, W25QXX_SECTOR_SIZE); <span class="comment">// å†™å…¥æ•´ä¸ªæ‰‡åŒº</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            W25QXX_Write_NoCheck(pBuffer, WriteAddr, secremain); <span class="comment">// å†™å·²ç»æ“¦é™¤äº†çš„,ç›´æ¥å†™å…¥æ‰‡åŒºå‰©ä½™åŒºé—´.</span></span><br><span class="line">        <span class="keyword">if</span> (NumByteToWrite == secremain)</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">// å†™å…¥ç»“æŸäº†</span></span><br><span class="line">        <span class="keyword">else</span>       <span class="comment">// å†™å…¥æœªç»“æŸ</span></span><br><span class="line">        &#123;</span><br><span class="line">            secpos++;   <span class="comment">// æ‰‡åŒºåœ°å€å¢1</span></span><br><span class="line">            secoff = <span class="number">0</span>; <span class="comment">// åç§»ä½ç½®ä¸º0</span></span><br><span class="line"></span><br><span class="line">            pBuffer += secremain;        <span class="comment">// æŒ‡é’ˆåç§»</span></span><br><span class="line">            WriteAddr += secremain;      <span class="comment">// å†™åœ°å€åç§»</span></span><br><span class="line">            NumByteToWrite -= secremain; <span class="comment">// å­—èŠ‚æ•°é€’å‡</span></span><br><span class="line">            <span class="keyword">if</span> (NumByteToWrite &gt; W25QXX_SECTOR_SIZE)</span><br><span class="line">                secremain = W25QXX_SECTOR_SIZE; <span class="comment">// ä¸‹ä¸€ä¸ªæ‰‡åŒºè¿˜æ˜¯å†™ä¸å®Œ</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                secremain = NumByteToWrite; <span class="comment">// ä¸‹ä¸€ä¸ªæ‰‡åŒºå¯ä»¥å†™å®Œäº†</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SRAMIN</span></span><br><span class="line">    pub_free(SRAMIN, W25QXX_BUF); <span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-diskio-cæ–‡ä»¶çš„ç§»æ¤"><a href="#2-diskio-cæ–‡ä»¶çš„ç§»æ¤" class="headerlink" title="2.Â diskio.cæ–‡ä»¶çš„ç§»æ¤"></a><font size=3>2.Â diskio.cæ–‡ä»¶çš„ç§»æ¤</font></h2><p>æ¥ä¸‹æ¥ï¼Œå°±æ¥ä¸€æ­¥ä¸€æ­¥ç§»æ¤è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åçœ‹ä¸€çœ‹ä¸­é—´å¯èƒ½ä¼šæœ‰ä»€ä¹ˆå‘ã€‚è¿™ä¸€éƒ¨åˆ†ä¸»è¦éƒ½æ˜¯åœ¨diskio.cæ–‡ä»¶ä¸­è¿›è¡Œç§»æ¤ï¼Œè¿™é‡Œå…ˆä¸å…³å¿ƒé…ç½®æ–‡ä»¶ï¼Œåè¾¹æµ‹è¯•çš„æ—¶å€™ä¼šæ ¹æ®å‡ºé”™çš„æƒ…å†µä¸€æ­¥ä¸€æ­¥ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚</p>
<h3 id="2-1-drive-number"><a href="#2-1-drive-number" class="headerlink" title="2.1 drive number"></a><font size=3>2.1 drive number</font></h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰æˆ‘ä»¬çš„ç›˜ç¬¦ï¼Œåœ¨ diskio.c æ–‡ä»¶çš„å¼€å¤´æœ‰ä»¥ä¸‹å‡ ä¸ªå®ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Definitions of physical drive number for each drive */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEV_RAM		0	<span class="comment">/* Example: Map Ramdisk to physical drive 0 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEV_MMC		1	<span class="comment">/* Example: Map MMC/SD card to physical drive 1 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEV_USB		2	<span class="comment">/* Example: Map USB MSD to physical drive 2 */</span></span></span><br></pre></td></tr></table></figure>

<p>è¿™äº›å®å°±è¡¨ç¤ºäº†ä¸åŒçš„å­˜å‚¨ä»‹è´¨ï¼Œåè¾¹ä¼šæ ¹æ®è¿™äº›å®æ¥è°ƒç”¨ä¸åŒçš„åˆå§‹åŒ–åŠè¯»å†™å‡½æ•°å»æ“ä½œå¯¹åº”çš„å­˜å‚¨è®¾å¤‡ã€‚æˆ‘ä»¬è¿™é‡Œå®šä¹‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯SDå¡ï¼ˆé¢„ç•™ï¼Œåè¾¹ä¼šä½¿ç”¨ï¼‰ï¼Œä¸€ä¸ªæ˜¯SPI FLASHï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DEV_SDCARD      0	<span class="comment">/* Example: Map SD card to physical drive 0 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEV_SPI_FLASH   1	<span class="comment">/* Example: Map SPI FLASH to physical drive 1 */</span></span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-disk-initialize"><a href="#2-2-disk-initialize" class="headerlink" title="2.2 disk_initialize()"></a><font size=3>2.2 disk_initialize()</font></h3><h4 id="2-2-1-å‡½æ•°å£°æ˜"><a href="#2-2-1-å‡½æ•°å£°æ˜" class="headerlink" title="2.2.1 å‡½æ•°å£°æ˜"></a><font size=3>2.2.1 å‡½æ•°å£°æ˜</font></h4><p>é¦–å…ˆæ˜¯åˆå§‹åŒ–å‡½æ•°disk_initialize()ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒæ–‡æ¡£<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dinit.html">FatFs - disk_initialize (elm-chan.org)</a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DSTATUS <span class="title function_">disk_initialize</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv           <span class="comment">/* [IN] Physical drive number */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°åˆå§‹åŒ–å­˜å‚¨è®¾å¤‡ï¼Œå¹¶ä½¿å…¶å‡†å¤‡å¥½è¿›è¡Œé€šç”¨è¯»&#x2F;å†™ã€‚</p>
<h4 id="2-2-2-å¯¹SPI-FLASHåˆå§‹åŒ–"><a href="#2-2-2-å¯¹SPI-FLASHåˆå§‹åŒ–" class="headerlink" title="2.2.2 å¯¹SPI FLASHåˆå§‹åŒ–"></a><font size=3>2.2.2 å¯¹SPI FLASHåˆå§‹åŒ–</font></h4><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¯¹SPI FLASHçš„åˆå§‹åŒ–æ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">    <span class="comment">//MX_SPI2_Init(); // SPIåˆå§‹åŒ–ï¼Œåœ¨main.cä¸­å®Œæˆ </span></span><br><span class="line">    result = Get_W25QXX_Type();<span class="comment">// è¿™é‡Œæœ€å¼€å§‹çš„æ—¶å€™å†™çš„æ˜¯ result = 0; ä½†æ˜¯è¿™æ ·æ˜¯æ— æ³•å®Œæ•´å¯¹SPI FLASHåˆå§‹åŒ–ï¼Œåè¾¹ä¼šåˆ†æé—®é¢˜æ‰€åœ¨ã€‚</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯STM32CubeMXæ¥é…ç½®çš„SPIï¼Œæ‰€ä»¥å½“STM32CubeMXç”Ÿæˆå·¥ç¨‹çš„æ—¶å€™ï¼Œä¼šç›´æ¥åœ¨mainå‡½æ•°ä¸­è¿›è¡ŒSPIåˆå§‹åŒ–å‡½æ•°çš„è°ƒç”¨ï¼Œæ‰€ä»¥ä¸ºäº†åè¾¹ä¿®æ”¹å·¥ç¨‹æ–¹ä¾¿ï¼Œè¿™é‡Œå°±ä¸å†æ”¾å¯¹SPIçš„åˆå§‹åŒ–äº†ã€‚</p>
<h4 id="2-2-3-ç§»æ¤ç»“æœ"><a href="#2-2-3-ç§»æ¤ç»“æœ" class="headerlink" title="2.2.3 ç§»æ¤ç»“æœ"></a><font size=3>2.2.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DSTATUS <span class="title function_">disk_initialize</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv <span class="comment">/* Physical drive nmuber to identify the drive */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">			<span class="comment">//MX_SPI2_Init(); // SPIåˆå§‹åŒ–ï¼Œåœ¨main.cä¸­å®Œæˆ</span></span><br><span class="line">			result = Get_W25QXX_Type();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> STA_NOINIT; <span class="comment">//åˆå§‹åŒ–å¤±è´¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-disk-status"><a href="#2-3-disk-status" class="headerlink" title="2.3 disk_status()"></a><font size=3>2.3 disk_status()</font></h3><h4 id="2-3-1-å‡½æ•°å£°æ˜"><a href="#2-3-1-å‡½æ•°å£°æ˜" class="headerlink" title="2.3.1 å‡½æ•°å£°æ˜"></a><font size=3>2.3.1 å‡½æ•°å£°æ˜</font></h4><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯è·å–è®¾å¤‡çš„çŠ¶æ€ï¼Œå…¶å®è¿™ä¸ªå‡½æ•°å¹¶ä¸é‡è¦ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥è®©å®ƒæ°¸è¿œè¿”å›ä¸€ä¸ªæˆåŠŸæµ‹æ ‡å¿—ã€‚æˆ‘ä»¬å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dstat.html">FatFs - disk_status (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DSTATUS <span class="title function_">disk_status</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv     <span class="comment">/* [IN] Physical drive number */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-å¯¹SPI-FLASHçš„çŠ¶æ€æ£€æµ‹"><a href="#2-3-2-å¯¹SPI-FLASHçš„çŠ¶æ€æ£€æµ‹" class="headerlink" title="2.3.2 å¯¹SPI FLASHçš„çŠ¶æ€æ£€æµ‹"></a><font size=3>2.3.2 å¯¹SPI FLASHçš„çŠ¶æ€æ£€æµ‹</font></h4><p>æˆ‘ä»¬å¯ä»¥å°†è·å–W25Q128å™¨ä»¶IDçš„æ“ä½œæ”¾åœ¨çŠ¶æ€è¯»å–çš„å‡½æ•°ä¸­ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥ç¡®ä¿æˆ‘ä»¬çš„SPI FLASHå¯ä»¥æ­£å¸¸è¿è¡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">    result = Get_W25QXX_Type();</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3-ç§»æ¤ç»“æœ"><a href="#2-3-3-ç§»æ¤ç»“æœ" class="headerlink" title="2.3.3 ç§»æ¤ç»“æœ"></a><font size=3>2.3.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DSTATUS <span class="title function_">disk_status</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv <span class="comment">/* Physical drive nmuber to identify the drive */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">			result = Get_W25QXX_Type();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> STA_NOINIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-disk-read"><a href="#2-4-disk-read" class="headerlink" title="2.4 disk_read()"></a><font size=3>2.4 disk_read()</font></h3><h4 id="2-4-1-å‡½æ•°å£°æ˜"><a href="#2-4-1-å‡½æ•°å£°æ˜" class="headerlink" title="2.4.1 å‡½æ•°å£°æ˜"></a><font size=3>2.4.1 å‡½æ•°å£°æ˜</font></h4><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯è¯»å–æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dread.html">FatFs - disk_read (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_read</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv,     <span class="comment">/* [IN] Physical drive number */</span></span></span><br><span class="line"><span class="params">  BYTE* buff,    <span class="comment">/* [OUT] Pointer to the read data buffer */</span></span></span><br><span class="line"><span class="params">  LBA_t sector,  <span class="comment">/* [IN] Start sector number */</span></span></span><br><span class="line"><span class="params">  UINT count     <span class="comment">/* [IN] Number of sectros to read */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°å‚æ•°ã€‘</strong></p>
<ul>
<li><p>pdrv ï¼šç”¨äºæ ‡è¯†ç›®æ ‡è®¾å¤‡çš„ç‰©ç†é©±åŠ¨å™¨å·ã€‚</p>
</li>
<li><p>buff ï¼šæŒ‡å‘å­—èŠ‚æ•°ç»„ä¸­ç”¨äºå­˜å‚¨è¯»å–æ•°æ®çš„ç¬¬ä¸€ä¸ªæ•°æ®çš„æŒ‡é’ˆã€‚è¯»å–æ•°æ®çš„å¤§å°å°†æ˜¯ æ‰‡åŒºå¤§å°xå­—èŠ‚æ•°ã€‚</p>
</li>
<li><p>sector ï¼šå¯åŠ¨æ‰‡åŒºå·ã€‚æ•°æ®ç±»å‹ LBA_t æ˜¯ DWORD æˆ– QWORD çš„åˆ«åï¼Œå…·ä½“å–å†³äºé…ç½®é€‰é¡¹ã€‚</p>
</li>
<li><p>count ï¼šè¦è¯»å–çš„æ‰‡åŒºæ•°ã€‚</p>
</li>
</ul>
<p><strong>ã€æ³¨æ„äº‹é¡¹ã€‘</strong>FatFsæ¯æ¬¡æ“ä½œï¼Œéƒ½æ˜¯ä»¥æ‰‡åŒºä¸ºåŸºæœ¬å•ä½çš„ã€‚</p>
<h4 id="2-4-2-ä»SPI-FLASHè¯»å–"><a href="#2-4-2-ä»SPI-FLASHè¯»å–" class="headerlink" title="2.4.2 ä»SPI FLASHè¯»å–"></a><font size=3>2.4.2 ä»SPI FLASHè¯»å–</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">    result = W25QXX_Read((<span class="type">uint8_t</span> *)buff, sector * <span class="number">4096</span>, count * <span class="number">4096</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>å‰è¾¹æˆ‘ä»¬çŸ¥é“ï¼ŒW25Q128å°†16MBçš„å®¹é‡åˆ†ä¸º256ä¸ªå—ï¼ˆBlockï¼‰ï¼Œæ¯ä¸ªå—å¤§å°ä¸º64Kå­—èŠ‚ï¼Œæ¯ä¸ªå—åˆåˆ†ä¸º16ä¸ªæ‰‡åŒºï¼ˆSectorï¼‰ï¼Œæ¯ä¸ªæ‰‡åŒº4Kä¸ªå­—èŠ‚ã€‚è€Œæˆ‘ä»¬æ“ä½œW25Q128çš„æ—¶å€™æ¯æ¬¡ä¹Ÿæ˜¯æ“¦é™¤ä¸€ä¸ªæ‰‡åŒºï¼Œä¹Ÿå°±æ˜¯4KBï¼Œ16Mçš„ç©ºé—´ï¼Œä¸€å…±å°±æœ‰4096ä¸ªæ‰‡åŒºï¼Œè€Œæ‰‡åŒºå·ä¹˜ä»¥æ‰‡åŒºå¤§å°å°±å¯ä»¥å¾—åˆ°æ•´ä¸ªæ‰‡åŒºçš„èµ·å§‹åœ°å€ã€‚count è¡¨ç¤ºæ‰‡åŒºçš„æ•°é‡ï¼Œæ¯ä¸ªæ‰‡åŒº4KBï¼Œç›¸ä¹˜å°±å¯ä»¥å¾—åˆ°è¦è¯»å–çš„å­—èŠ‚æ•°é‡ã€‚</p>
<h4 id="2-4-3-ç§»æ¤ç»“æœ"><a href="#2-4-3-ç§»æ¤ç»“æœ" class="headerlink" title="2.4.3 ç§»æ¤ç»“æœ"></a><font size=3>2.4.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_read</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv,	  <span class="comment">/* Physical drive nmuber to identify the drive */</span></span></span><br><span class="line"><span class="params">	BYTE *buff,	  <span class="comment">/* Data buffer to store read data */</span></span></span><br><span class="line"><span class="params">	LBA_t sector, <span class="comment">/* Start sector in LBA */</span></span></span><br><span class="line"><span class="params">	UINT count	  <span class="comment">/* Number of sectors to read */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">			result = W25QXX_Read((<span class="type">uint8_t</span> *)buff, sector * <span class="number">4096</span>, count * <span class="number">4096</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> RES_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-disk-write"><a href="#2-5-disk-write" class="headerlink" title="2.5 disk_write()"></a><font size=3>2.5 disk_write()</font></h3><h4 id="2-5-1-å‡½æ•°å£°æ˜"><a href="#2-5-1-å‡½æ•°å£°æ˜" class="headerlink" title="2.5.1 å‡½æ•°å£°æ˜"></a><font size=3>2.5.1 å‡½æ•°å£°æ˜</font></h4><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯å†™å…¥æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dwrite.html">FatFs - disk_write (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_write</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv,        <span class="comment">/* [IN] Physical drive number */</span></span></span><br><span class="line"><span class="params">  <span class="type">const</span> BYTE* buff, <span class="comment">/* [IN] Pointer to the data to be written */</span></span></span><br><span class="line"><span class="params">  LBA_t sector,     <span class="comment">/* [IN] Sector number to write from */</span></span></span><br><span class="line"><span class="params">  UINT count        <span class="comment">/* [IN] Number of sectors to write */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°å‚æ•°ã€‘</strong></p>
<ul>
<li><p>pdrv ï¼šç”¨äºæ ‡è¯†ç›®æ ‡è®¾å¤‡çš„ç‰©ç†é©±åŠ¨å™¨å·ã€‚</p>
</li>
<li><p>buff ï¼šæŒ‡å‘å­—èŠ‚æ•°ç»„ä¸­ç”¨äºå­˜å‚¨å†™å…¥æ•°æ®çš„ç¬¬ä¸€ä¸ªæ•°æ®çš„æŒ‡é’ˆã€‚å†™å…¥æ•°æ®çš„å¤§å°å°†æ˜¯ æ‰‡åŒºå¤§å°xå­—èŠ‚æ•°ã€‚</p>
</li>
<li><p>sector ï¼šå¯åŠ¨æ‰‡åŒºå·ã€‚æ•°æ®ç±»å‹ LBA_t æ˜¯ DWORD æˆ– QWORD çš„åˆ«åï¼Œå…·ä½“å–å†³äºé…ç½®é€‰é¡¹ã€‚</p>
</li>
<li><p>count ï¼šè¦è¯»å–çš„æ‰‡åŒºæ•°ã€‚</p>
</li>
</ul>
<p><strong>ã€æ³¨æ„äº‹é¡¹ã€‘</strong>FatFsæ¯æ¬¡æ“ä½œï¼Œéƒ½æ˜¯ä»¥æ‰‡åŒºä¸ºåŸºæœ¬å•ä½çš„ã€‚</p>
<h4 id="2-5-2-å‘SPI-FLASHå†™å…¥"><a href="#2-5-2-å‘SPI-FLASHå†™å…¥" class="headerlink" title="2.5.2 å‘SPI FLASHå†™å…¥"></a><font size=3>2.5.2 å‘SPI FLASHå†™å…¥</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">    result = W25QXX_Write((<span class="type">uint8_t</span> *)buff, sector * <span class="number">4096</span>, count * <span class="number">4096</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸å‰è¾¹çš„è¯»ä¸€æ ·ï¼Œéƒ½æ˜¯ä»¥æ‰‡åŒºä¸ºå•ä½æ“ä½œï¼Œå°†å‚æ•°ä¼ å…¥åº•å±‚å†™å…¥å‡½æ•°çš„æ—¶å€™éœ€è¦è½¬æ¢ä¸ºç›¸åº”çš„åœ°å€ã€‚</p>
<h4 id="2-5-3-ç§»æ¤ç»“æœ"><a href="#2-5-3-ç§»æ¤ç»“æœ" class="headerlink" title="2.5.3 ç§»æ¤ç»“æœ"></a><font size=3>2.5.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_write</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv,		  <span class="comment">/* Physical drive nmuber to identify the drive */</span></span></span><br><span class="line"><span class="params">	<span class="type">const</span> BYTE *buff, <span class="comment">/* Data to be written */</span></span></span><br><span class="line"><span class="params">	LBA_t sector,	  <span class="comment">/* Start sector in LBA */</span></span></span><br><span class="line"><span class="params">	UINT count		  <span class="comment">/* Number of sectors to write */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">			result = W25QXX_Write((<span class="type">uint8_t</span> *)buff, sector * <span class="number">4096</span>, count * <span class="number">4096</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> RES_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-disk-ioctl"><a href="#2-6-disk-ioctl" class="headerlink" title="2.6 disk_ioctl()"></a><font size=3>2.6 disk_ioctl()</font></h3><h4 id="2-6-1-å‡½æ•°å£°æ˜"><a href="#2-6-1-å‡½æ•°å£°æ˜" class="headerlink" title="2.6.1 å‡½æ•°å£°æ˜"></a><font size=3>2.6.1 å‡½æ•°å£°æ˜</font></h4><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ç”¨äºæ§åˆ¶è®¾å¤‡ï¼Œå¯æ ¹æ®ä¸åŒå‘½ä»¤æ‰§è¡Œä¸åŒåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dioctl.html">FatFs - disk_ioctl (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_ioctl</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv,     <span class="comment">/* [IN] Drive number */</span></span></span><br><span class="line"><span class="params">  BYTE cmd,      <span class="comment">/* [IN] Control command code */</span></span></span><br><span class="line"><span class="params">  <span class="type">void</span>* buff     <span class="comment">/* [I/O] Parameter and data buffer */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°å‚æ•°ã€‘</strong></p>
<ul>
<li><p>pdrv ï¼šç”¨äºæ ‡è¯†ç›®æ ‡è®¾å¤‡çš„ç‰©ç†é©±åŠ¨å™¨å·ã€‚</p>
</li>
<li><p>cmd ï¼šå‘½ä»¤ç¼–å·ï¼Œæ¯”å¦‚GET_SECTOR_COUNTã€GET_SECTOR_SIZEã€GET_BLOCK_SIZEç­‰ï¼Œè¯¦ç»†çš„å‘½ä»¤åŠå«ä¹‰å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£è¯´æ˜ã€‚</p>
</li>
<li><p>buff ï¼šå‚æ•°çš„æŒ‡é’ˆå–å†³äºå‘½ä»¤ä»£ç ã€‚ä¸è¦åœ¨æ„è¯¥å‘½ä»¤æ˜¯å¦æ²¡æœ‰è¦ä¼ é€’çš„å‚æ•°ã€‚</p>
</li>
</ul>
<h4 id="2-6-2-è·å–SPI-FLASHä¿¡æ¯"><a href="#2-6-2-è·å–SPI-FLASHä¿¡æ¯" class="headerlink" title="2.6.2 è·å–SPI FLASHä¿¡æ¯"></a><font size=3>2.6.2 è·å–SPI FLASHä¿¡æ¯</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">    <span class="keyword">switch</span>(cmd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> GET_SECTOR_COUNT:<span class="comment">// æ‰‡åŒºæ•°é‡</span></span><br><span class="line">            *(DWORD *)buff = <span class="number">256</span> * <span class="number">16</span>;<span class="comment">//256å—x16ä¸ªæ‰‡åŒº</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GET_SECTOR_SIZE:<span class="comment">// æ‰‡åŒºå¤§å°</span></span><br><span class="line">            *(WORD *)buff = <span class="number">4096</span>;<span class="comment">// æ¯ä¸ªæ‰‡åŒºæ˜¯4KB</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GET_BLOCK_SIZE:<span class="comment">// æ¯æ¬¡æ“¦é™¤å—çš„å¤§å°çš„ä¸ªæ•°</span></span><br><span class="line">            *(DWORD *)buff = <span class="number">1</span>;<span class="comment">// æ¯æ¬¡åªæ“¦é™¤ä¸€ä¸ªæ‰‡åŒº</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-6-3-ç§»æ¤ç»“æœ"><a href="#2-6-3-ç§»æ¤ç»“æœ" class="headerlink" title="2.6.3 ç§»æ¤ç»“æœ"></a><font size=3>2.6.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_ioctl</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv, <span class="comment">/* Physical drive nmuber (0..) */</span></span></span><br><span class="line"><span class="params">	BYTE cmd,  <span class="comment">/* Control code */</span></span></span><br><span class="line"><span class="params">	<span class="type">void</span> *buff <span class="comment">/* Buffer to send/receive control data */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SPI_FLASH:</span><br><span class="line">			<span class="keyword">switch</span>(cmd)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">case</span> GET_SECTOR_COUNT:<span class="comment">// æ‰‡åŒºæ•°é‡</span></span><br><span class="line">					*(DWORD *)buff = <span class="number">256</span> * <span class="number">16</span>;<span class="comment">//256å—x16ä¸ªæ‰‡åŒº</span></span><br><span class="line">					<span class="comment">//*(DWORD *)buff = FLASH_SECTOR_COUNT;//12M/512Bä¸ªæ‰‡åŒº</span></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> GET_SECTOR_SIZE:<span class="comment">// æ‰‡åŒºå¤§å°</span></span><br><span class="line">					*(WORD *)buff = <span class="number">4096</span>;<span class="comment">// æ¯ä¸ªæ‰‡åŒºæ˜¯4KB</span></span><br><span class="line">					<span class="comment">//*(WORD *)buff = FLASH_SECTOR_SIZE;// æ¯ä¸ªæ‰‡åŒºæ˜¯512B</span></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> GET_BLOCK_SIZE:<span class="comment">// æ¯æ¬¡æ“¦é™¤å—çš„å¤§å°çš„ä¸ªæ•°</span></span><br><span class="line">					*(DWORD *)buff = <span class="number">1</span>;<span class="comment">// æ¯æ¬¡åªæ“¦é™¤ä¸€ä¸ªæ‰‡åŒº</span></span><br><span class="line">					<span class="comment">//*(DWORD *)buff = FLASH_BLOCK_SIZE;// æ¯æ¬¡åªæ“¦é™¤ä¸€ä¸ªå¤§æ‰‡åŒºï¼Œ512*8=4096</span></span><br><span class="line">				<span class="keyword">default</span>:</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			result = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> RES_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-ffconf-hæ–‡ä»¶çš„é…ç½®"><a href="#3-ffconf-hæ–‡ä»¶çš„é…ç½®" class="headerlink" title="3. ffconf.hæ–‡ä»¶çš„é…ç½®"></a><font size=3>3. ffconf.hæ–‡ä»¶çš„é…ç½®</font></h2><p>è¿™ä¸€èŠ‚æˆ‘ä»¬é€šè¿‡æŠ¥é”™æ¥çœ‹ä¸€ä¸‹ä¸åŒçš„é…ç½®é¡¹æœ‰ä»€ä¹ˆå½±å“ã€‚æˆ‘ä»¬è¿™éƒ¨åˆ†ä»¥ä¾‹å­æ¥è¯´æ˜ã€‚</p>
<h3 id="3-1-FF-VOLUMES"><a href="#3-1-FF-VOLUMES" class="headerlink" title="3.1 FF_VOLUMES"></a><font size=3>3.1 FF_VOLUMES</font></h3><p>æµ‹è¯•å‡½æ•°æˆ‘ä»¬ç”¨f_mountæ¥å°è¯•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> FATFS fs = &#123;<span class="number">0</span>&#125;; <span class="comment">// FatFsæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡</span></span><br><span class="line"><span class="type">static</span> BYTE work[FF_MAX_SS];  <span class="comment">// æ ¼å¼åŒ–è®¾å¤‡å·¥ä½œåŒº</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">fatfs_Test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    FRESULT res = FR_OK;</span><br><span class="line">	res = f_mount(&amp;fs, <span class="string">&quot;1:&quot;</span>, <span class="number">1</span>); <span class="comment">// æŒ‚è½½FLASH.</span></span><br><span class="line">	<span class="keyword">if</span>(res != FR_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;f_mount error:%s\r\n&quot;</span>, API_RET[res]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬è°ƒç”¨å¹¶æ‰“å°ï¼Œä¼šæœ‰å¦‚ä¸‹æ‰“å°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f_mount error:(<span class="number">11</span>) The logical drive number is invalid</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼ŒæŠ¥é”™å†™çš„æ˜¯æˆ‘ä»¬çš„é€»è¾‘é©±åŠ¨å™¨ç¼–å·ä¸åˆæ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æˆ‘ä»¬å®šä¹‰çš„drive numberï¼Œå‘ç°SPI FLASHæ˜¯1ï¼Œè¿™æ²¡é—®é¢˜å•Šï¼Œæˆ‘ä»¬ä»f_mount()å‡½æ•°ä¸€çº§ä¸€çº§å¾€ä¸‹æ‰¾ï¼Œå‘ç°æˆ‘ä»¬çš„é©±åŠ¨å™¨ç¼–å·æ”¶åˆ°è¿™ä¸ªå®çš„é™åˆ¶ FF_VOLUMESï¼Œå®ƒè¡¨ç¤ºæˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿæœ€å¤šæ”¯æŒå¤šå°‘ä¸ªé©±åŠ¨å™¨ï¼Œä¹Ÿå°±æ˜¯å­˜å‚¨è®¾å¤‡ï¼Œæˆ‘ä»¬è¿™ä¸ªå®é»˜è®¤æ˜¯1ï¼Œé‚£ä¹ˆæˆ‘ä»¬æŒ‚è½½çš„æ—¶å€™å°±åªèƒ½æŒ‚è½½ â€œ0:â€ ï¼Œæˆ‘ä»¬ä¿®æ”¹å®ä¸º2ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FF_VOLUMES		2</span></span><br><span class="line"><span class="comment">/* Number of volumes (logical drives) to be used. (1-10) */</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-FF-MAX-SS"><a href="#3-2-FF-MAX-SS" class="headerlink" title="3.2 FF_MAX_SS"></a><font size=3>3.2 FF_MAX_SS</font></h3><p>ä¸å‡ºæ„å¤–çš„è¯ä¸Šè¾¹å®æ”¹å®Œï¼Œå°±ä¸ä¼šæŠ¥11è¿™ä¸ªé”™äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šè¿›å…¥å¦ä¸€ä¸ªé”™è¯¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[error]HardFault!!!</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä»€ä¹ˆï¼Ÿè¿™æ˜¯æˆ‘ä»¬ä¹‹å‰æ·»åŠ çš„ç¡¬ä»¶é”™è¯¯ä¸­æ–­ä¸­æ‰“å°çš„ï¼Œæ€ä¹ˆä¼šå‘ç”Ÿè¿™æ ·ä¸€ä¸ªé”™è¯¯ï¼Ÿä¸€èˆ¬æ¥è®²éƒ½æ˜¯å†…å­˜æº¢å‡ºï¼Œæˆ–è€…è®¿é—®äº†ç©ºçš„æŒ‡é’ˆæ‰ä¼šå‡ºç°ã€‚æˆ‘ä»¬è¿˜è®°å¾—ä¸Šè¾¹çš„FATFSç»“æ„ä½“å§ï¼Œé‡Œè¾¹æœ‰ä¸€ä¸ªæˆå‘˜ win[FF_MAX_SS]ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªå®é»˜è®¤æ˜¯512ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ª512å­—èŠ‚çš„æ•°ç»„ï¼Œç”±äºæˆ‘ä»¬å®šä¹‰çš„fsæ˜¯ä¸ªå…¨å±€å˜é‡ï¼Œæ‰€ä»¥æ ˆç©ºé—´åº”è¯¥ä¸ä¼šæº¢å‡ºï¼Œé‚£æ€ä¹ˆå›äº‹å‘¢ï¼Ÿæˆ‘ä»¬ç°åœ¨ç”¨çš„SPI FLASHä¸€ä¸ªæ‰‡åŒºæ˜¯4096å­—èŠ‚ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨disk_ioctl()å‡½æ•°ä¸­å·²ç»è®¾ç½®äº†ä¸€ä¸ªæ‰‡åŒºä¸º4096ï¼Œè‹¥æ˜¯åˆå§‹åŒ–çš„æ—¶å€™æ“ä½œSPI FLASHç”¨åˆ°è¿™ä¸ªæ‰‡åŒºå¤§å°çš„è¯ï¼Œå¯èƒ½å°±æº¢å‡ºäº†ï¼Œè¿™ä¹Ÿå¾ˆæœ‰å¯èƒ½å°±ä¼šå¯¼è‡´ä¸Šè¾¹çš„é”™è¯¯ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‡½æ•°è°ƒç”¨å…³ç³»ï¼ˆSource Insightï¼‰ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-22-FatFs-02-FatFs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/img/image-20230602224918758.png" alt="image-20230602224918758" style="zoom:50%;" />

<p>å‘ç°f_mount()å‡½æ•°æŒ‚è½½ä¼šä½¿ç”¨åˆ°è¿™ä¸ªæˆå‘˜ï¼Œé‚£ä¹ˆåŸºæœ¬å°±å¯ä»¥éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†æ­¤å¤„æ”¹ä¸º4096ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FF_MIN_SS		512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FF_MAX_SS		4096</span></span><br><span class="line"><span class="comment">/* This set of options configures the range of sector size to be supported. (512,</span></span><br><span class="line"><span class="comment">/  1024, 2048 or 4096) Always set both 512 for most systems, generic memory card and</span></span><br><span class="line"><span class="comment">/  harddisk, but a larger value may be required for on-board flash memory and some</span></span><br><span class="line"><span class="comment">/  type of optical media. When FF_MAX_SS is larger than FF_MIN_SS, FatFs is configured</span></span><br><span class="line"><span class="comment">/  for variable sector size mode and disk_ioctl() function needs to implement</span></span><br><span class="line"><span class="comment">/  GET_SECTOR_SIZE command. */</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å†ç¼–è¯‘ä¸‹è½½ï¼Œå°±ä¼šäº§ç”Ÿå…¶ä»–é”™è¯¯äº†ï¼Œå°±ä¸ä¼šå†æ˜¯è¿™ä¸ªç¡¬ä»¶å‡ºé”™è¯¯äº†ï¼š</p>
<h3 id="3-3-FF-USE-MKFS"><a href="#3-3-FF-USE-MKFS" class="headerlink" title="3.3 FF_USE_MKFS"></a><font size=3>3.3 FF_USE_MKFS</font></h3><p>æ–°çš„bugï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f_mount error:(<span class="number">13</span>) There is no valid FAT volume</span><br></pre></td></tr></table></figure>

<p>è¿™åˆæ˜¯ä»€ä¹ˆï¼ŸThere is no valid FAT volumeç¿»è¯‘è¿‡æ¥å°±æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„FATå·ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™æ ·å°±å¯ä»¥ç†è§£äº†ï¼ŒåŸæœ¬æˆ‘ä»¬çš„SPI FLASHå°±ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å°±éœ€è¦æ ¼å¼åŒ–SPI FLASH æ¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°f_mkfs()å‡½æ•°å•¦ï¼Œæˆ‘ä»¬ä¿®æ”¹æµ‹è¯•å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> FATFS fs = &#123;<span class="number">0</span>&#125;; <span class="comment">// FatFsæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡</span></span><br><span class="line"><span class="type">static</span> BYTE work[FF_MAX_SS];  <span class="comment">// æ ¼å¼åŒ–è®¾å¤‡å·¥ä½œåŒº</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">fatfs_Test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    FRESULT res = FR_OK;</span><br><span class="line">	res = f_mount(&amp;fs, <span class="string">&quot;1:&quot;</span>, <span class="number">1</span>); <span class="comment">// æŒ‚è½½FLASH.</span></span><br><span class="line">	<span class="keyword">if</span>(res != FR_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;f_mount error:%s\r\n&quot;</span>, API_RET[res]);</span><br><span class="line">        <span class="keyword">if</span> (res == FR_NO_FILESYSTEM) <span class="comment">// FLASHç£ç›˜,FATæ–‡ä»¶ç³»ç»Ÿé”™è¯¯,é‡æ–°æ ¼å¼åŒ–FLASH</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Flash Disk Formatting...\r\n&quot;</span>); <span class="comment">// æ ¼å¼åŒ–FLASH</span></span><br><span class="line"></span><br><span class="line">            res = f_mkfs(<span class="string">&quot;1:&quot;</span>, <span class="number">0</span>, work, <span class="keyword">sizeof</span>(work)); <span class="comment">// æ ¼å¼åŒ–FLASH,1,ç›˜ç¬¦;1,ä¸éœ€è¦å¼•å¯¼åŒº,8ä¸ªæ‰‡åŒºä¸º1ä¸ªç°‡</span></span><br><span class="line">            <span class="keyword">if</span> (res == FR_OK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;f_mkfs:Flash Disk Format Finish!!!\r\n&quot;</span>); <span class="comment">// æ ¼å¼åŒ–å®Œæˆ</span></span><br><span class="line">                res = f_mount(<span class="literal">NULL</span>, <span class="string">&quot;1:&quot;</span>, <span class="number">1</span>);              <span class="comment">// æ ¼å¼åŒ–åï¼Œå…ˆå–æ¶ˆæŒ‚è½½</span></span><br><span class="line">                res = f_mount(&amp;fs, <span class="string">&quot;1:&quot;</span>, <span class="number">1</span>);               <span class="comment">// é‡æ–°æŒ‚è½½</span></span><br><span class="line">                <span class="keyword">if</span>(res != FR_OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;f_mount error:%s\r\n&quot;</span>, API_RET[res]);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;f_mkfs error:%s\r\n&quot;</span>, API_RET[res]); <span class="comment">// æ ¼å¼åŒ–å¤±è´¥</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å‘ç°ç¼–è¯‘ç›´æ¥æŠ¥é”™ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: L6218E: Undefined symbol <span class="title function_">f_mkfs</span> <span class="params">(referred from fatfs_ex.o)</span>.</span><br></pre></td></tr></table></figure>

<p>å‘ç°æ²¡æœ‰å®šä¹‰è¿™ä¸ªç¬¦å·ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬æ‰¾ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œä¼šå‘ç°ï¼Œå®ƒå—åˆ°è¿™ä¸ªå®çš„å½±å“ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-22-FatFs-02-FatFs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/img/image-20230602230210319.png" alt="image-20230602230210319" style="zoom:50%;" />

<p>æˆ‘ä»¬è¦å‘ä½¿ç”¨è¿™ä¸ªå®ï¼Œä¸èƒ½æ˜¯åªè¯»çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”è¿˜è¦å¼€å¯FF_USE_MKFSï¼ŒFF_FS_READONLYé»˜è®¤å°±æ˜¯0ï¼Œæ‰€ä»¥ä¸ç”¨ç®¡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FF_FS_READONLY  0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FF_USE_MKFS		1</span></span><br><span class="line"><span class="comment">/* This option switches f_mkfs() function. (0:Disable or 1:Enable) */</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-SPI-FLASHçš„ä¸€ä¸ªBUG"><a href="#3-4-SPI-FLASHçš„ä¸€ä¸ªBUG" class="headerlink" title="3.4 SPI FLASHçš„ä¸€ä¸ªBUG"></a><font size=3>3.4 SPI FLASHçš„ä¸€ä¸ªBUG</font></h3><p>ç„¶åæˆ‘ä»¬é‡æ–°ç¼–è¯‘ä¸‹è½½è¿è¡Œï¼Œå‘ç°æˆ‘ä»¬é‡æ–°æŒ‚è½½çš„æ—¶å€™åˆæŠ¥é”™äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f_mount error:(<span class="number">13</span>) There is no valid FAT volume </span><br><span class="line">Flash Disk Formatting...</span><br><span class="line">f_mkfs:Flash Disk Format Finish!!!</span><br><span class="line">f_mount error:(<span class="number">13</span>) There is no valid FAT volume </span><br></pre></td></tr></table></figure>

<p>ä¸Šè¾¹æ˜æ˜æ˜¾ç¤ºæˆ‘ä»¬æ ¼å¼åŒ–å®Œæˆäº†ï¼Œä½†æ˜¯ä¾ç„¶æ²¡æœ‰æˆåŠŸåˆ›å»ºæ–‡ä»¶ç³»ç»Ÿï¼Œç½‘ä¸Šæœç´¢äº†èµ„æ–™ï¼Œé…ç½®æ–‡ä»¶åˆ°è¿™é‡Œå…¶å®å°±å¯ä»¥äº†ï¼Œæˆ‘ä»¬å†æ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯å†™è¢«ç¦æ­¢äº†ï¼Œä½†æ˜¯ä¸Šè¾¹æˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿæ ¹æœ¬å°±ä¸æ˜¯åªè¯»çš„ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½æ˜¯æˆ‘ä»¬åº•å±‚æ¥å£é—®é¢˜äº†ï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä½¿ç”¨SPI FLASHçš„æ—¶å€™æ˜¯è¦å…ˆæ“¦é™¤æ‰èƒ½å†™å…¥çš„ï¼Œä½†æ˜¯æˆ‘ä»¬åˆå§‹åŒ–å‡½æ•°ä¸­ä¼¼ä¹å¹¶æ²¡æœ‰è¿›è¡Œæ“¦é™¤ï¼Œé‚£ä¹ˆæœ‰åˆæ€ä¹ˆæŠŠæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºä¸Šå»å‘¢ï¼Ÿæ‰€ä»¥æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™å¯¹æ‰‡åŒºè¿›è¡Œä¸€æ¬¡æ“¦é™¤ï¼Œä½†æ˜¯æˆ‘ä»¬çš„å†™å‡½æ•°ä¸­å·²ç»å†…ç½®äº†æ“¦é™¤åŠŸèƒ½äº†ï¼Œé‚£é—®é¢˜å‡ºåœ¨å“ªï¼Ÿ</p>
<p>æˆ‘åæ¥ç›´æ¥åœ¨fatfs_Test()å‡½æ•°è°ƒç”¨ä¹‹å‰å°±è¯»å†™ä¸€æ¬¡SPI FLASHï¼Œå‘ç°ä¹‹åå°±æ­£å¸¸äº†ï¼Œé‚£ä¹ˆè¿˜æ˜¯æˆ‘ä»¬åˆå§‹åŒ–çš„é—®é¢˜ï¼Œé—®é¢˜å°±å‡ºç°åœ¨æˆ‘ä»¬çš„Get_W25QXX_Type()å‡½æ•°ä¸­ï¼Œç”±äºæˆ‘ä»¬åº•å±‚çš„SPI FLASHè¿˜å¯ä»¥æ”¯æŒå…¶ä»–ç±»å‹çš„SPI FLASHï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ä¹‹å‰æ˜¯éœ€è¦å…ˆè·å–IDçš„ï¼Œä½†æ˜¯æˆ‘æŠŠè¿™ä¸ªå‡½æ•°æ”¾åœ¨äº†disk_status()ä¸­å—ï¼Œå°±å¯¼è‡´åˆå§‹åŒ–æœ‰é—®é¢˜äº†ï¼Œè¿™ä¸ªå‡½æ•°æ—¢å¯ä»¥ç”¨æ¥ç¡®è®¤SPI FLASHçš„çŠ¶æ€ï¼Œä¹Ÿæ˜¯åˆå§‹åŒ–æ‰€å¿…è¦çš„æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹ disk_initialize() ä¸­å¯¹SPI FLASHçš„åˆå§‹åŒ–ï¼Œè°ƒç”¨ä¸€æ¬¡Get_W25QXX_Type()å‡½æ•°å³å¯ï¼Œç„¶åå†ç¼–è¯‘ï¼Œä¸‹è½½è¿è¡Œå°±ä¼šå‘ç°ï¼Œæˆ‘ä»¬å¯ä»¥æ­£å¸¸æ ¼å¼åŒ–ä»¥åŠæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿäº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SPI FLASH ID=<span class="number">0xef17</span></span><br><span class="line">f_mount success!!!</span><br></pre></td></tr></table></figure>



<h1 id="ä¸‰ã€åŸºäºSDå¡çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#ä¸‰ã€åŸºäºSDå¡çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="ä¸‰ã€åŸºäºSDå¡çš„æ–‡ä»¶ç³»ç»Ÿ"></a><font size=3>ä¸‰ã€åŸºäºSDå¡çš„æ–‡ä»¶ç³»ç»Ÿ</font></h1><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä»¥SDå¡ä¸ºå­˜å‚¨ä»‹è´¨çš„FatFsæ–‡ä»¶ç³»ç»Ÿçš„ç§»æ¤ã€‚å¦å¤–å°±æ˜¯ï¼Œæˆ‘åæ¥ç§»æ¤çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°æˆ‘ä»¬åœ¨ä½¿ç”¨STM32CubeMXé…ç½®SDIOçš„æ—¶å€™ä¸è¦å¼€SDIOå’ŒDMAä¸­æ–­ï¼Œä¸ç„¶SDå¡è¯»å†™æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯å§ï¼Œç§»æ¤å¥½æ–‡ä»¶ç³»ç»Ÿåï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæ€ä¹ˆéƒ½è·‘ä¸èµ·æ¥ï¼Œå…·ä½“æ˜¯å“ªçš„å½±å“è¿˜ä¸æ¸…æ¥šï¼Œåè¾¹çŸ¥é“äº†å†è¡¥å……ã€‚</p>
<h2 id="1-åº•å±‚è¯»å†™-1"><a href="#1-åº•å±‚è¯»å†™-1" class="headerlink" title="1. åº•å±‚è¯»å†™"></a><font size=3>1. åº•å±‚è¯»å†™</font></h2><h3 id="1-1-åˆå§‹åŒ–-1"><a href="#1-1-åˆå§‹åŒ–-1" class="headerlink" title="1.1 åˆå§‹åŒ–"></a><font size=3>1.1 åˆå§‹åŒ–</font></h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–SDå¡ï¼Œè¿™é‡Œè¿˜æ˜¯ä½¿ç”¨STM32CubeMXæ¥é…ç½®çš„SDIOï¼Œæ‰€ä»¥åˆå§‹åŒ–å°±å¦‚ä¸‹å‡½æ•°æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">MX_SDIO_SD_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°è¯´æ˜ã€‘</strong>è¿™ä¸ªå‡½æ•°æ˜¯å®ŒæˆSDIOçš„åˆå§‹åŒ–ï¼Œä¹Ÿå°±å®Œæˆäº†å¯¹SDå¡çš„åˆå§‹åŒ–ã€‚æ³¨æ„è¿™é‡Œæœ‰ä¸¤ä¸ªå‘ï¼Œä¸€ä¸ªå°±æ˜¯åˆå§‹åŒ–çš„æ—¶å€™çš„æ€»çº¿å®½åº¦è®¾ç½®ä¸º1ä½ï¼Œè¿˜æœ‰å°±æ˜¯æ—¶é’Ÿé¢‘ç‡ï¼Œè‹¥é€šä¿¡å¤±è´¥ï¼Œå¯ä»¥é™ä½è¯•ä¸€è¯•ã€‚è¿™ä¸ªé‡Œè¾¹è¦æ³¨æ„æ—¶é’Ÿ</p>
<h3 id="1-2-è·å–SDå¡ä¿¡æ¯"><a href="#1-2-è·å–SDå¡ä¿¡æ¯" class="headerlink" title="1.2 è·å–SDå¡ä¿¡æ¯"></a><font size=3>1.2 è·å–SDå¡ä¿¡æ¯</font></h3><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯ä¸ºäº†çœ‹ä¸€ä¸‹SDå¡æ˜¯å¦åˆå§‹åŒ–æˆåŠŸï¼Œå¹¶ä¸”è·å–ä¸€äº›SDå¡çš„ä¿¡æ¯ï¼Œåè¾¹ä½¿ç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">HAL_SD_CardInfoTypeDef  SDCardInfo;                 <span class="comment">//SDå¡ä¿¡æ¯ç»“æ„ä½“</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_sdcard_info</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint64_t</span> CardCap;	<span class="comment">//SDå¡å®¹é‡</span></span><br><span class="line">	HAL_SD_CardCIDTypeDef SDCard_CID;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* æ£€æµ‹SDå¡æ˜¯å¦æ­£å¸¸ï¼ˆå¤„äºæ•°æ®ä¼ è¾“æ¨¡å¼çš„ä¼ è¾“çŠ¶æ€ï¼‰ */</span></span><br><span class="line">    <span class="keyword">if</span>(HAL_SD_GetCardState(&amp;hsd) != HAL_SD_CARD_TRANSFER)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SD card init fail!\r\n&quot;</span> );</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Initialize SD card successfully!\r\n&quot;</span>);</span><br><span class="line">	HAL_SD_GetCardCID(&amp;hsd, &amp;SDCard_CID);	<span class="comment">//è·å–CID</span></span><br><span class="line">	HAL_SD_GetCardInfo(&amp;hsd, &amp;SDCardInfo);  <span class="comment">//è·å–SDå¡ä¿¡æ¯</span></span><br><span class="line">	<span class="keyword">switch</span>(SDCardInfo.CardType)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> CARD_SDSC:</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(SDCardInfo.CardVersion == CARD_V1_X)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Card Type          :SDSC V1 \r\n&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(SDCardInfo.CardVersion == CARD_V2_X)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Card Type          :SDSC V2 \r\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> CARD_SDHC_SDXC:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Card Type          :SDHC \r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">	CardCap=(<span class="type">uint64_t</span>)(SDCardInfo.LogBlockNbr)*(<span class="type">uint64_t</span>)(SDCardInfo.LogBlockSize);	<span class="comment">//è®¡ç®—SDå¡å®¹é‡</span></span><br><span class="line">  	<span class="built_in">printf</span>(<span class="string">&quot;Card ManufacturerID:%d \r\n&quot;</span>,SDCard_CID.ManufacturerID);				<span class="comment">//åˆ¶é€ å•†ID</span></span><br><span class="line"> 	<span class="built_in">printf</span>(<span class="string">&quot;Card RCA           :%d \r\n&quot;</span>,SDCardInfo.RelCardAdd);					<span class="comment">//å¡ç›¸å¯¹åœ°å€</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;LogBlockNbr        :%d \r\n&quot;</span>,(<span class="type">uint32_t</span>)(SDCardInfo.LogBlockNbr));		<span class="comment">//æ˜¾ç¤ºé€»è¾‘å—æ•°é‡</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;LogBlockSize       :%d \r\n&quot;</span>,(<span class="type">uint32_t</span>)(SDCardInfo.LogBlockSize));		<span class="comment">//æ˜¾ç¤ºé€»è¾‘å—å¤§å°</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Card Capacity      :%d MB\r\n&quot;</span>,(<span class="type">uint32_t</span>)(CardCap&gt;&gt;<span class="number">20</span>));				<span class="comment">//æ˜¾ç¤ºå®¹é‡</span></span><br><span class="line"> 	<span class="built_in">printf</span>(<span class="string">&quot;Card BlockSize     :%d \r\n\r\n&quot;</span>,SDCardInfo.BlockSize);					<span class="comment">//æ˜¾ç¤ºå—å¤§å°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-è¯»å–æ•°æ®-1"><a href="#1-3-è¯»å–æ•°æ®-1" class="headerlink" title="1.3 è¯»å–æ•°æ®"></a><font size=3>1.3 è¯»å–æ•°æ®</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  ä»SDå¡è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment">  * @note   </span></span><br><span class="line"><span class="comment">  * @param  buf è¯»æ•°æ®ç¼“å­˜åŒº</span></span><br><span class="line"><span class="comment">  * @param  sector æ‰‡åŒºåœ°å€</span></span><br><span class="line"><span class="comment">  * @param  cnt æ‰‡åŒºä¸ªæ•°</span></span><br><span class="line"><span class="comment">  * @retval è¿”å›é”™è¯¯çŠ¶æ€;0,æ­£å¸¸;å…¶ä»–,é”™è¯¯ä»£ç ;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">SD_ReadDisk</span><span class="params">(<span class="type">uint8_t</span> *buf, <span class="type">uint32_t</span> sector, <span class="type">uint32_t</span> cnt)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> sta = HAL_OK;</span><br><span class="line">    <span class="type">uint32_t</span> timeout = SD_TIMEOUT;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> lsector = sector;</span><br><span class="line">    INTX_DISABLE(); <span class="comment">// å…³é—­æ€»ä¸­æ–­(POLLINGæ¨¡å¼,ä¸¥ç¦ä¸­æ–­æ‰“æ–­SDIOè¯»å†™æ“ä½œ!!!)</span></span><br><span class="line">    sta = HAL_SD_ReadBlocks(&amp;hsd, (<span class="type">uint8_t</span> *)buf, lsector, cnt, SD_TIMEOUT); <span class="comment">// å¤šä¸ªsectorçš„è¯»æ“ä½œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…SDå¡è¯»å®Œ</span></span><br><span class="line">    <span class="keyword">while</span> (SD_GetCardState() != SD_TRANSFER_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (timeout-- == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            sta = SD_TRANSFER_BUSY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    INTX_ENABLE(); <span class="comment">// å¼€å¯æ€»ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">return</span> sta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°è¯´æ˜ã€‘</strong>åœ¨æŒ‡å®šåœ°å€å¼€å§‹è¯»å–æŒ‡å®šé•¿åº¦çš„æ•°æ®ã€‚</p>
<p><strong>ã€å‚æ•°è¯´æ˜ã€‘</strong></p>
<ul>
<li>buf ï¼šè¯»æ•°æ®ç¼“å­˜åŒº</li>
<li>sector ï¼šæ‰‡åŒºåœ°å€</li>
<li>cnt ï¼šæ‰‡åŒºä¸ªæ•°</li>
</ul>
<p>	</p>
<h3 id="1-4-å†™å…¥æ•°æ®-1"><a href="#1-4-å†™å…¥æ•°æ®-1" class="headerlink" title="1.4 å†™å…¥æ•°æ®"></a><font size=3>1.4 å†™å…¥æ•°æ®</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  å‘SDå¡å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">  * @note   </span></span><br><span class="line"><span class="comment">  * @param  buf å†™æ•°æ®ç¼“å­˜åŒº</span></span><br><span class="line"><span class="comment">  * @param  sector æ‰‡åŒºåœ°å€</span></span><br><span class="line"><span class="comment">  * @param  cnt æ‰‡åŒºä¸ªæ•°</span></span><br><span class="line"><span class="comment">  * @retval è¿”å›é”™è¯¯çŠ¶æ€;0,æ­£å¸¸;å…¶ä»–,é”™è¯¯ä»£ç ;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">SD_WriteDisk</span><span class="params">(<span class="type">uint8_t</span> *buf, <span class="type">uint32_t</span> sector, <span class="type">uint32_t</span> cnt)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> sta = HAL_OK;</span><br><span class="line">    <span class="type">uint32_t</span> timeout = SD_TIMEOUT;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> lsector = sector;</span><br><span class="line">    INTX_DISABLE(); <span class="comment">// å…³é—­æ€»ä¸­æ–­(POLLINGæ¨¡å¼,ä¸¥ç¦ä¸­æ–­æ‰“æ–­SDIOè¯»å†™æ“ä½œ!!!)</span></span><br><span class="line">    sta = HAL_SD_WriteBlocks(&amp;hsd, (<span class="type">uint8_t</span> *)buf, lsector, cnt, SD_TIMEOUT); <span class="comment">// å¤šä¸ªsectorçš„å†™æ“ä½œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…SDå¡å†™å®Œ</span></span><br><span class="line">    <span class="keyword">while</span> (HAL_SD_GetCardState(&amp;hsd) != HAL_SD_CARD_TRANSFER)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (timeout-- == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            sta = SD_TRANSFER_BUSY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    INTX_ENABLE(); <span class="comment">// å¼€å¯æ€»ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">return</span> sta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°è¯´æ˜ã€‘</strong>åœ¨æŒ‡å®šåœ°å€å¼€å§‹å†™å…¥æŒ‡å®šé•¿åº¦çš„æ•°æ®ã€‚</p>
<p><strong>ã€å‚æ•°è¯´æ˜ã€‘</strong></p>
<ul>
<li>buf ï¼šå†™æ•°æ®ç¼“å­˜åŒº</li>
<li>sector ï¼šæ‰‡åŒºåœ°å€</li>
<li>cnt ï¼šæ‰‡åŒºä¸ªæ•°</li>
</ul>
<p>	</p>
<h2 id="2-diskio-cæ–‡ä»¶çš„ç§»æ¤-1"><a href="#2-diskio-cæ–‡ä»¶çš„ç§»æ¤-1" class="headerlink" title="2.Â diskio.cæ–‡ä»¶çš„ç§»æ¤"></a><font size=3>2.Â diskio.cæ–‡ä»¶çš„ç§»æ¤</font></h2><h3 id="2-1-drive-number-1"><a href="#2-1-drive-number-1" class="headerlink" title="2.1 drive number"></a><font size=3>2.1 drive number</font></h3><p>å‰è¾¹ç§»æ¤SPI FLASHçš„æ—¶å€™å·²ç»é¢„ç•™äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DEV_SDCARD      0	<span class="comment">/* Example: Map SD card to physical drive 0 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEV_SPI_FLASH   1	<span class="comment">/* Example: Map SPI FLASH to physical drive 1 */</span></span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-disk-initialize-1"><a href="#2-2-disk-initialize-1" class="headerlink" title="2.2 disk_initialize()"></a><font size=3>2.2 disk_initialize()</font></h3><h4 id="2-2-1-å‡½æ•°å£°æ˜-1"><a href="#2-2-1-å‡½æ•°å£°æ˜-1" class="headerlink" title="2.2.1 å‡½æ•°å£°æ˜"></a><font size=3>2.2.1 å‡½æ•°å£°æ˜</font></h4><p>é¦–å…ˆæ˜¯åˆå§‹åŒ–å‡½æ•°disk_initialize()ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒæ–‡æ¡£<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dinit.html">FatFs - disk_initialize (elm-chan.org)</a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DSTATUS <span class="title function_">disk_initialize</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv           <span class="comment">/* [IN] Physical drive number */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°åˆå§‹åŒ–å­˜å‚¨è®¾å¤‡ï¼Œå¹¶ä½¿å…¶å‡†å¤‡å¥½è¿›è¡Œé€šç”¨è¯»&#x2F;å†™ã€‚</p>
<h4 id="2-2-2-å¯¹SDå¡åˆå§‹åŒ–"><a href="#2-2-2-å¯¹SDå¡åˆå§‹åŒ–" class="headerlink" title="2.2.2 å¯¹SDå¡åˆå§‹åŒ–"></a><font size=3>2.2.2 å¯¹SDå¡åˆå§‹åŒ–</font></h4><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¯¹SDå¡çš„åˆå§‹åŒ–æ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">    <span class="comment">//MX_SDIO_SD_Init();// SDIOåˆå§‹åŒ–</span></span><br><span class="line">    <span class="comment">//show_sdcard_info();</span></span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-ç§»æ¤ç»“æœ-1"><a href="#2-2-3-ç§»æ¤ç»“æœ-1" class="headerlink" title="2.2.3 ç§»æ¤ç»“æœ"></a><font size=3>2.2.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DSTATUS <span class="title function_">disk_initialize</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv <span class="comment">/* Physical drive nmuber to identify the drive */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">			<span class="comment">//MX_SDIO_SD_Init();// SDIOåˆå§‹åŒ–</span></span><br><span class="line">			<span class="comment">//show_sdcard_info();</span></span><br><span class="line">			result = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> STA_NOINIT; <span class="comment">//åˆå§‹åŒ–å¤±è´¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-disk-status-1"><a href="#2-3-disk-status-1" class="headerlink" title="2.3 disk_status()"></a><font size=3>2.3 disk_status()</font></h3><h4 id="2-3-1-å‡½æ•°å£°æ˜-1"><a href="#2-3-1-å‡½æ•°å£°æ˜-1" class="headerlink" title="2.3.1 å‡½æ•°å£°æ˜"></a><font size=3>2.3.1 å‡½æ•°å£°æ˜</font></h4><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯è·å–è®¾å¤‡çš„çŠ¶æ€ï¼Œå…¶å®è¿™ä¸ªå‡½æ•°å¹¶ä¸é‡è¦ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥è®©å®ƒæ°¸è¿œè¿”å›ä¸€ä¸ªæˆåŠŸæµ‹æ ‡å¿—ã€‚æˆ‘ä»¬å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dstat.html">FatFs - disk_status (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DSTATUS <span class="title function_">disk_status</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv     <span class="comment">/* [IN] Physical drive number */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-å¯¹SDå¡çš„çŠ¶æ€æ£€æµ‹"><a href="#2-3-2-å¯¹SDå¡çš„çŠ¶æ€æ£€æµ‹" class="headerlink" title="2.3.2 å¯¹SDå¡çš„çŠ¶æ€æ£€æµ‹"></a><font size=3>2.3.2 å¯¹SDå¡çš„çŠ¶æ€æ£€æµ‹</font></h4><p>è¿™é‡Œå°±æ²¡æ£€æµ‹äº†ï¼Œç›´æ¥è¿”å›OKï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3-ç§»æ¤ç»“æœ-1"><a href="#2-3-3-ç§»æ¤ç»“æœ-1" class="headerlink" title="2.3.3 ç§»æ¤ç»“æœ"></a><font size=3>2.3.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DSTATUS <span class="title function_">disk_status</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv <span class="comment">/* Physical drive nmuber to identify the drive */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">			result = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> STA_NOINIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-disk-read-1"><a href="#2-4-disk-read-1" class="headerlink" title="2.4 disk_read()"></a><font size=3>2.4 disk_read()</font></h3><h4 id="2-4-1-å‡½æ•°å£°æ˜-1"><a href="#2-4-1-å‡½æ•°å£°æ˜-1" class="headerlink" title="2.4.1 å‡½æ•°å£°æ˜"></a><font size=3>2.4.1 å‡½æ•°å£°æ˜</font></h4><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯è¯»å–æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dread.html">FatFs - disk_read (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_read</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv,     <span class="comment">/* [IN] Physical drive number */</span></span></span><br><span class="line"><span class="params">  BYTE* buff,    <span class="comment">/* [OUT] Pointer to the read data buffer */</span></span></span><br><span class="line"><span class="params">  LBA_t sector,  <span class="comment">/* [IN] Start sector number */</span></span></span><br><span class="line"><span class="params">  UINT count     <span class="comment">/* [IN] Number of sectros to read */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°å‚æ•°ã€‘</strong></p>
<ul>
<li><p>pdrv ï¼šç”¨äºæ ‡è¯†ç›®æ ‡è®¾å¤‡çš„ç‰©ç†é©±åŠ¨å™¨å·ã€‚</p>
</li>
<li><p>buff ï¼šæŒ‡å‘å­—èŠ‚æ•°ç»„ä¸­ç”¨äºå­˜å‚¨è¯»å–æ•°æ®çš„ç¬¬ä¸€ä¸ªæ•°æ®çš„æŒ‡é’ˆã€‚è¯»å–æ•°æ®çš„å¤§å°å°†æ˜¯ æ‰‡åŒºå¤§å°xå­—èŠ‚æ•°ã€‚</p>
</li>
<li><p>sector ï¼šå¯åŠ¨æ‰‡åŒºå·ã€‚æ•°æ®ç±»å‹ LBA_t æ˜¯ DWORD æˆ– QWORD çš„åˆ«åï¼Œå…·ä½“å–å†³äºé…ç½®é€‰é¡¹ã€‚</p>
</li>
<li><p>count ï¼šè¦è¯»å–çš„æ‰‡åŒºæ•°ã€‚</p>
</li>
</ul>
<p><strong>ã€æ³¨æ„äº‹é¡¹ã€‘</strong>FatFsæ¯æ¬¡æ“ä½œï¼Œéƒ½æ˜¯ä»¥æ‰‡åŒºä¸ºåŸºæœ¬å•ä½çš„ã€‚</p>
<h4 id="2-4-2-ä»SDå¡è¯»å–"><a href="#2-4-2-ä»SDå¡è¯»å–" class="headerlink" title="2.4.2 ä»SDå¡è¯»å–"></a><font size=3>2.4.2 ä»SDå¡è¯»å–</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">    result = SD_ReadDisk(buff, sector, count);	<span class="comment">// æˆåŠŸæ—¶è¿”å›0;</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>



<h4 id="2-4-3-ç§»æ¤ç»“æœ-1"><a href="#2-4-3-ç§»æ¤ç»“æœ-1" class="headerlink" title="2.4.3 ç§»æ¤ç»“æœ"></a><font size=3>2.4.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_read</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv,	  <span class="comment">/* Physical drive nmuber to identify the drive */</span></span></span><br><span class="line"><span class="params">	BYTE *buff,	  <span class="comment">/* Data buffer to store read data */</span></span></span><br><span class="line"><span class="params">	LBA_t sector, <span class="comment">/* Start sector in LBA */</span></span></span><br><span class="line"><span class="params">	UINT count	  <span class="comment">/* Number of sectors to read */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">			result = SD_ReadDisk(buff, sector, count);	<span class="comment">// æˆåŠŸæ—¶è¿”å›0;</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> RES_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-disk-write-1"><a href="#2-5-disk-write-1" class="headerlink" title="2.5 disk_write()"></a><font size=3>2.5 disk_write()</font></h3><h4 id="2-5-1-å‡½æ•°å£°æ˜-1"><a href="#2-5-1-å‡½æ•°å£°æ˜-1" class="headerlink" title="2.5.1 å‡½æ•°å£°æ˜"></a><font size=3>2.5.1 å‡½æ•°å£°æ˜</font></h4><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯å†™å…¥æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dwrite.html">FatFs - disk_write (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_write</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv,        <span class="comment">/* [IN] Physical drive number */</span></span></span><br><span class="line"><span class="params">  <span class="type">const</span> BYTE* buff, <span class="comment">/* [IN] Pointer to the data to be written */</span></span></span><br><span class="line"><span class="params">  LBA_t sector,     <span class="comment">/* [IN] Sector number to write from */</span></span></span><br><span class="line"><span class="params">  UINT count        <span class="comment">/* [IN] Number of sectors to write */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°å‚æ•°ã€‘</strong></p>
<ul>
<li><p>pdrv ï¼šç”¨äºæ ‡è¯†ç›®æ ‡è®¾å¤‡çš„ç‰©ç†é©±åŠ¨å™¨å·ã€‚</p>
</li>
<li><p>buff ï¼šæŒ‡å‘å­—èŠ‚æ•°ç»„ä¸­ç”¨äºå­˜å‚¨å†™å…¥æ•°æ®çš„ç¬¬ä¸€ä¸ªæ•°æ®çš„æŒ‡é’ˆã€‚å†™å…¥æ•°æ®çš„å¤§å°å°†æ˜¯ æ‰‡åŒºå¤§å°xå­—èŠ‚æ•°ã€‚</p>
</li>
<li><p>sector ï¼šå¯åŠ¨æ‰‡åŒºå·ã€‚æ•°æ®ç±»å‹ LBA_t æ˜¯ DWORD æˆ– QWORD çš„åˆ«åï¼Œå…·ä½“å–å†³äºé…ç½®é€‰é¡¹ã€‚</p>
</li>
<li><p>count ï¼šè¦è¯»å–çš„æ‰‡åŒºæ•°ã€‚</p>
</li>
</ul>
<p><strong>ã€æ³¨æ„äº‹é¡¹ã€‘</strong>FatFsæ¯æ¬¡æ“ä½œï¼Œéƒ½æ˜¯ä»¥æ‰‡åŒºä¸ºåŸºæœ¬å•ä½çš„ã€‚</p>
<h4 id="2-5-2-å‘SDå¡å†™å…¥"><a href="#2-5-2-å‘SDå¡å†™å…¥" class="headerlink" title="2.5.2 å‘SDå¡å†™å…¥"></a><font size=3>2.5.2 å‘SDå¡å†™å…¥</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">    result =SD_WriteDisk((<span class="type">uint8_t</span>*)buff, sector, count);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸å‰è¾¹çš„è¯»ä¸€æ ·ï¼Œéƒ½æ˜¯ä»¥æ‰‡åŒºä¸ºå•ä½æ“ä½œï¼Œå°†å‚æ•°ä¼ å…¥åº•å±‚å†™å…¥å‡½æ•°çš„æ—¶å€™éœ€è¦è½¬æ¢ä¸ºç›¸åº”çš„åœ°å€ã€‚</p>
<h4 id="2-5-3-ç§»æ¤ç»“æœ-1"><a href="#2-5-3-ç§»æ¤ç»“æœ-1" class="headerlink" title="2.5.3 ç§»æ¤ç»“æœ"></a><font size=3>2.5.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_write</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv,		  <span class="comment">/* Physical drive nmuber to identify the drive */</span></span></span><br><span class="line"><span class="params">	<span class="type">const</span> BYTE *buff, <span class="comment">/* Data to be written */</span></span></span><br><span class="line"><span class="params">	LBA_t sector,	  <span class="comment">/* Start sector in LBA */</span></span></span><br><span class="line"><span class="params">	UINT count		  <span class="comment">/* Number of sectors to write */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">			result =SD_WriteDisk((<span class="type">uint8_t</span>*)buff, sector, count);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> RES_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-disk-ioctl-1"><a href="#2-6-disk-ioctl-1" class="headerlink" title="2.6 disk_ioctl()"></a><font size=3>2.6 disk_ioctl()</font></h3><h4 id="2-6-1-å‡½æ•°å£°æ˜-1"><a href="#2-6-1-å‡½æ•°å£°æ˜-1" class="headerlink" title="2.6.1 å‡½æ•°å£°æ˜"></a><font size=3>2.6.1 å‡½æ•°å£°æ˜</font></h4><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ç”¨äºæ§åˆ¶è®¾å¤‡ï¼Œå¯æ ¹æ®ä¸åŒå‘½ä»¤æ‰§è¡Œä¸åŒåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://elm-chan.org/fsw/ff/doc/dioctl.html">FatFs - disk_ioctl (elm-chan.org)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_ioctl</span> <span class="params">(</span></span><br><span class="line"><span class="params">  BYTE pdrv,     <span class="comment">/* [IN] Drive number */</span></span></span><br><span class="line"><span class="params">  BYTE cmd,      <span class="comment">/* [IN] Control command code */</span></span></span><br><span class="line"><span class="params">  <span class="type">void</span>* buff     <span class="comment">/* [I/O] Parameter and data buffer */</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ã€å‡½æ•°å‚æ•°ã€‘</strong></p>
<ul>
<li><p>pdrv ï¼šç”¨äºæ ‡è¯†ç›®æ ‡è®¾å¤‡çš„ç‰©ç†é©±åŠ¨å™¨å·ã€‚</p>
</li>
<li><p>cmd ï¼šå‘½ä»¤ç¼–å·ï¼Œæ¯”å¦‚GET_SECTOR_COUNTã€GET_SECTOR_SIZEã€GET_BLOCK_SIZEç­‰ï¼Œè¯¦ç»†çš„å‘½ä»¤åŠå«ä¹‰å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£è¯´æ˜ã€‚</p>
</li>
<li><p>buff ï¼šå‚æ•°çš„æŒ‡é’ˆå–å†³äºå‘½ä»¤ä»£ç ã€‚ä¸è¦åœ¨æ„è¯¥å‘½ä»¤æ˜¯å¦æ²¡æœ‰è¦ä¼ é€’çš„å‚æ•°ã€‚</p>
</li>
</ul>
<h4 id="2-6-2-è·å–SDå¡ä¿¡æ¯"><a href="#2-6-2-è·å–SDå¡ä¿¡æ¯" class="headerlink" title="2.6.2 è·å–SDå¡ä¿¡æ¯"></a><font size=3>2.6.2 è·å–SDå¡ä¿¡æ¯</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">    <span class="keyword">switch</span>(cmd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> GET_SECTOR_COUNT:<span class="comment">// æ‰‡åŒºæ•°é‡</span></span><br><span class="line">            *(DWORD *)buff = SDCardInfo.LogBlockNbr;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GET_SECTOR_SIZE:<span class="comment">// æ‰‡åŒºå¤§å°</span></span><br><span class="line">            *(WORD *)buff = SDCardInfo.BlockSize;<span class="comment">// æ¯ä¸ªæ‰‡åŒºæ˜¯512B</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GET_BLOCK_SIZE:<span class="comment">// æ¯æ¬¡æ“¦é™¤å—çš„å¤§å°çš„ä¸ªæ•°</span></span><br><span class="line">            *(DWORD *)buff = SDCardInfo.LogBlockSize;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-6-3-ç§»æ¤ç»“æœ-1"><a href="#2-6-3-ç§»æ¤ç»“æœ-1" class="headerlink" title="2.6.3 ç§»æ¤ç»“æœ"></a><font size=3>2.6.3 ç§»æ¤ç»“æœ</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">DRESULT <span class="title function_">disk_ioctl</span><span class="params">(</span></span><br><span class="line"><span class="params">	BYTE pdrv, <span class="comment">/* Physical drive nmuber (0..) */</span></span></span><br><span class="line"><span class="params">	BYTE cmd,  <span class="comment">/* Control code */</span></span></span><br><span class="line"><span class="params">	<span class="type">void</span> *buff <span class="comment">/* Buffer to send/receive control data */</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pdrv)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> DEV_SDCARD:</span><br><span class="line">			<span class="keyword">switch</span>(cmd)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">case</span> GET_SECTOR_COUNT:<span class="comment">// æ‰‡åŒºæ•°é‡</span></span><br><span class="line">					*(DWORD *)buff = SDCardInfo.LogBlockNbr;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> GET_SECTOR_SIZE:<span class="comment">// æ‰‡åŒºå¤§å°</span></span><br><span class="line">					*(WORD *)buff = SDCardInfo.BlockSize;<span class="comment">// æ¯ä¸ªæ‰‡åŒºæ˜¯512B</span></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> GET_BLOCK_SIZE:<span class="comment">// æ¯æ¬¡æ“¦é™¤å—çš„å¤§å°çš„ä¸ªæ•°</span></span><br><span class="line">					*(DWORD *)buff = SDCardInfo.LogBlockSize;</span><br><span class="line">				<span class="keyword">default</span>:</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			result = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			result = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(result == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> RES_OK;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> RES_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-ffconf-hæ–‡ä»¶çš„é…ç½®-1"><a href="#3-ffconf-hæ–‡ä»¶çš„é…ç½®-1" class="headerlink" title="3. ffconf.hæ–‡ä»¶çš„é…ç½®"></a><font size=3>3. ffconf.hæ–‡ä»¶çš„é…ç½®</font></h2><p>è¿™é‡Œçš„é…ç½®åŸºæœ¬ä¸å˜ã€‚</p>
<h3 id="3-1-FF-VOLUMES-1"><a href="#3-1-FF-VOLUMES-1" class="headerlink" title="3.1 FF_VOLUMES"></a><font size=3>3.1 FF_VOLUMES</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FF_VOLUMES		2</span></span><br><span class="line"><span class="comment">/* Number of volumes (logical drives) to be used. (1-10) */</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-FF-MAX-SS-1"><a href="#3-2-FF-MAX-SS-1" class="headerlink" title="3.2 FF_MAX_SS"></a><font size=3>3.2 FF_MAX_SS</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FF_MIN_SS		512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FF_MAX_SS		4096</span></span><br><span class="line"><span class="comment">/* This set of options configures the range of sector size to be supported. (512,</span></span><br><span class="line"><span class="comment">/  1024, 2048 or 4096) Always set both 512 for most systems, generic memory card and</span></span><br><span class="line"><span class="comment">/  harddisk, but a larger value may be required for on-board flash memory and some</span></span><br><span class="line"><span class="comment">/  type of optical media. When FF_MAX_SS is larger than FF_MIN_SS, FatFs is configured</span></span><br><span class="line"><span class="comment">/  for variable sector size mode and disk_ioctl() function needs to implement</span></span><br><span class="line"><span class="comment">/  GET_SECTOR_SIZE command. */</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-FF-USE-MKFS-1"><a href="#3-3-FF-USE-MKFS-1" class="headerlink" title="3.3 FF_USE_MKFS"></a><font size=3>3.3 FF_USE_MKFS</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FF_FS_READONLY  0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FF_USE_MKFS		1</span></span><br><span class="line"><span class="comment">/* This option switches f_mkfs() function. (0:Disable or 1:Enable) */</span></span><br></pre></td></tr></table></figure>

<h1 id="å››ã€ä¸€äº›æµ‹è¯•å‡½æ•°"><a href="#å››ã€ä¸€äº›æµ‹è¯•å‡½æ•°" class="headerlink" title="å››ã€ä¸€äº›æµ‹è¯•å‡½æ•°"></a><font size=3>å››ã€ä¸€äº›æµ‹è¯•å‡½æ•°</font></h1><p>æœ€ç»ˆçš„ä»£ç å¯ä»¥çœ‹è¿™é‡Œï¼š<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/stm32f103-prj">STM32F103-Prj: STM32å­¦ä¹ ä½¿ç”¨ï¼ˆSTM32CubeMX+Makefile+VScode+J-Flashï¼‰ (gitee.com)</a></p>
<h2 id="1-æ–‡ä»¶ç³»ç»Ÿç»“æ„ä½“å®šä¹‰"><a href="#1-æ–‡ä»¶ç³»ç»Ÿç»“æ„ä½“å®šä¹‰" class="headerlink" title="1. æ–‡ä»¶ç³»ç»Ÿç»“æ„ä½“å®šä¹‰"></a><font size=3>1. æ–‡ä»¶ç³»ç»Ÿç»“æ„ä½“å®šä¹‰</font></h2><p>ä¸ºäº†æ–¹ä¾¿ç®¡ç†æ–‡ä»¶ç³»ç»Ÿï¼Œå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">ex_fatfs</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    FATFS *fs[FF_VOLUMES]; <span class="comment">// é€»è¾‘ç£ç›˜å·¥ä½œåŒº.</span></span><br><span class="line">    BYTE *work;  <span class="comment">// æŒ‚è½½çš„æ—¶å€™ç”¨</span></span><br><span class="line">    FIL *file;             <span class="comment">// æ–‡ä»¶1</span></span><br><span class="line">    FIL *ftemp;            <span class="comment">// æ–‡ä»¶2</span></span><br><span class="line">    UINT br;               <span class="comment">// è¯»æŒ‡é’ˆ</span></span><br><span class="line">    UINT bw;               <span class="comment">// å†™æŒ‡é’ˆ</span></span><br><span class="line">    FILINFO fileinfo;      <span class="comment">// æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">    DIR dir;               <span class="comment">// ç›®å½•</span></span><br><span class="line">&#125; EX_FATFS_PARAM;</span><br></pre></td></tr></table></figure>

<h2 id="2-ç”³è¯·å†…å­˜"><a href="#2-ç”³è¯·å†…å­˜" class="headerlink" title="2. ç”³è¯·å†…å­˜"></a><font size=3>2. ç”³è¯·å†…å­˜</font></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  ä¸ºæ–‡ä»¶ç³»ç»Ÿæ‰€ç”¨å˜é‡ç”³è¯·å†…å­˜</span></span><br><span class="line"><span class="comment">  * @note   </span></span><br><span class="line"><span class="comment">  * @param  </span></span><br><span class="line"><span class="comment">  * @retval 0ï¼Œç”³è¯·æˆåŠŸï¼Œ-1ï¼Œç”³è¯·å¤±è´¥</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">int8_t</span> <span class="title function_">exf_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; FF_VOLUMES; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        exFatfsParam.fs[i] = (FATFS *)pub_malloc(SRAMIN, <span class="keyword">sizeof</span>(FATFS)); <span class="comment">// ä¸ºç£ç›˜iå·¥ä½œåŒºç”³è¯·å†…å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (!exFatfsParam.fs[i])</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    exFatfsParam.file = (FIL *)pub_malloc(SRAMEX, <span class="keyword">sizeof</span>(FIL));   <span class="comment">// ä¸ºfileç”³è¯·å†…å­˜</span></span><br><span class="line">    exFatfsParam.ftemp = (FIL *)pub_malloc(SRAMEX, <span class="keyword">sizeof</span>(FIL));  <span class="comment">// ä¸ºftempç”³è¯·å†…å­˜</span></span><br><span class="line">    exFatfsParam.work = (<span class="type">uint8_t</span> *)pub_malloc(SRAMEX, FF_MAX_SS); <span class="comment">// ä¸ºworkç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (i == FF_VOLUMES &amp;&amp; exFatfsParam.file &amp;&amp; exFatfsParam.ftemp &amp;&amp; exFatfsParam.work)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// ç”³è¯·æœ‰ä¸€ä¸ªå¤±è´¥,å³å¤±è´¥.</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-è·å–ç£ç›˜å®¹é‡"><a href="#3-è·å–ç£ç›˜å®¹é‡" class="headerlink" title="3. è·å–ç£ç›˜å®¹é‡"></a><font size=3>3. è·å–ç£ç›˜å®¹é‡</font></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  å¾—åˆ°ç£ç›˜å‰©ä½™å®¹é‡</span></span><br><span class="line"><span class="comment">  * @note   å¥½åƒæ˜¯å»æ‰äº†FatFsè‡ªèº«å æ®çš„ç©ºé—´</span></span><br><span class="line"><span class="comment">  * @param  drv ç£ç›˜ç¼–å·(&quot;0:&quot;/&quot;1:&quot;)</span></span><br><span class="line"><span class="comment">  * @param  total æ€»å®¹é‡ ï¼ˆå•ä½KBï¼‰</span></span><br><span class="line"><span class="comment">  * @param  free å‰©ä½™å®¹é‡ ï¼ˆå•ä½KBï¼‰</span></span><br><span class="line"><span class="comment">  * @retval 0,æ­£å¸¸.å…¶ä»–,é”™è¯¯ä»£ç </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">exf_getfree</span><span class="params">(<span class="type">uint8_t</span> *drv, <span class="type">uint32_t</span> *total, <span class="type">uint32_t</span> *<span class="built_in">free</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    FATFS *fs1;</span><br><span class="line">    <span class="type">uint8_t</span> res;</span><br><span class="line">    <span class="type">uint32_t</span> fre_clust = <span class="number">0</span>, fre_sect = <span class="number">0</span>, tot_sect = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å¾—åˆ°ç£ç›˜ä¿¡æ¯åŠç©ºé—²ç°‡æ•°é‡</span></span><br><span class="line">    res = (<span class="type">uint32_t</span>)f_getfree((<span class="type">const</span> TCHAR *)drv, (DWORD *)&amp;fre_clust, &amp;fs1);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        tot_sect = (fs1-&gt;n_fatent - <span class="number">2</span>) * fs1-&gt;csize; <span class="comment">// å¾—åˆ°æ€»æ‰‡åŒºæ•°</span></span><br><span class="line">        fre_sect = fre_clust * fs1-&gt;csize;           <span class="comment">// å¾—åˆ°ç©ºé—²æ‰‡åŒºæ•°</span></span><br><span class="line">		<span class="comment">//printf(&quot;fs1-&gt;n_fatent %d, fs1-&gt;csize %d, tot_sect %d, fre_sect %d\r\n&quot;, fs1-&gt;n_fatent, fs1-&gt;csize, tot_sect, fre_sect);</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> FF_MAX_SS != 512                                 <span class="comment">// æ‰‡åŒºå¤§å°ä¸æ˜¯512å­—èŠ‚,åˆ™è½¬æ¢ä¸º512å­—èŠ‚</span></span></span><br><span class="line">        tot_sect *= fs1-&gt;ssize / <span class="number">512</span>;</span><br><span class="line">        fre_sect *= fs1-&gt;ssize / <span class="number">512</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        *total = tot_sect &gt;&gt; <span class="number">1</span>; <span class="comment">// å•ä½ä¸ºKB</span></span><br><span class="line">        *<span class="built_in">free</span> = fre_sect &gt;&gt; <span class="number">1</span>;  <span class="comment">// å•ä½ä¸ºKB</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">




    <div>
        
            <div style="text-align:center;color: #ccc;font-size:14px;">
            ----------æœ¬æ–‡ç»“æŸ
            <i class="fas fa-fan fa-spin" style="color: #FF1493; font-size: 1rem"></i>
            æ„Ÿè°¢æ‚¨çš„é˜…è¯»----------
            </div>
        
    </div>





  
  <div class="my_post_copyright"> 
    <p><span>æ–‡ç« æ ‡é¢˜:</span><a href="/post/fc1f4d1a.html">LV16-22-FatFs-02-FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤</a></p>
    <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="æ¬¢è¿è®¿é—® ã€Šè‹æœ¨ã€‹ çš„å­¦ä¹ ç¬”è®°">è‹æœ¨</a></p>
    <p><span>å‘å¸ƒæ—¶é—´:</span>2023å¹´06æœˆ04æ—¥ - 22:07</p>
    <p><span>æœ€åæ›´æ–°:</span>2025å¹´06æœˆ14æ—¥ - 00:25</p>
    <p><span>åŸå§‹é“¾æ¥:</span><a href="/post/fc1f4d1a.html" title="LV16-22-FatFs-02-FatFsæ–‡ä»¶ç³»ç»Ÿç§»æ¤">https://sumumm.github.io/post/fc1f4d1a.html</a></p>
    <p><span>è®¸å¯åè®®:</span><i class="fab fa-creative-commons"></i> <a rel="license" href= "https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>  
  </div>
  


          <div class="post-tags">
              <a href="/tags/LV16-STM32%E5%BC%80%E5%8F%91/" rel="tag"><i class="fa fa-tag"></i> LV16-STM32å¼€å‘</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/7e7fa731.html" rel="prev" title="LV16-23-WDG-01-çœ‹é—¨ç‹—åŸºç¡€çŸ¥è¯†">
                  <i class="fa fa-angle-left"></i> LV16-23-WDG-01-çœ‹é—¨ç‹—åŸºç¡€çŸ¥è¯†
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/d715f558.html" rel="next" title="LV16-22-FatFs-01-FatFsæ–‡ä»¶ç³»ç»Ÿ">
                  LV16-22-FatFs-01-FatFsæ–‡ä»¶ç³»ç»Ÿ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">è‹æœ¨</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">3.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">225:26</span>
  </span>
</div>




    <span id="sitetime"></span>
    <script defer language=javascript>
        function siteTime()
        {
            window.setTimeout("siteTime()", 1000);
            var seconds = 1000;
            var minutes = seconds * 60;
            var hours = minutes * 60;
            var days = hours * 24;
            var years = days * 365;
            var today = new Date();
            var todayYear = today.getFullYear();
            var todayMonth = today.getMonth()+1;
            var todayDate = today.getDate();
            var todayHour = today.getHours();
            var todayMinute = today.getMinutes();
            var todaySecond = today.getSeconds();
            /*==================================================
            Date.UTC() -- è¿”å›dateå¯¹è±¡è·ä¸–ç•Œæ ‡å‡†æ—¶é—´(UTC)1970å¹´1æœˆ1æ—¥åˆå¤œä¹‹é—´çš„æ¯«ç§’æ•°(æ—¶é—´æˆ³)
            year        - ä½œä¸ºdateå¯¹è±¡çš„å¹´ä»½ï¼Œä¸º4ä½å¹´ä»½å€¼
            month       - 0-11ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æœˆä»½
            day         - 1-31ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å¤©æ•°
            hours       - 0(åˆå¤œ24ç‚¹)-23ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å°æ—¶æ•°
            minutes     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„åˆ†é’Ÿæ•°
            seconds     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„ç§’æ•°
            microseconds - 0-999ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æ¯«ç§’æ•°
            ==================================================*/
            var t1 = Date.UTC(2017, 
                              5, 
                              19, 
                              0, 
                              0, 
                              0); //åŒ—äº¬æ—¶é—´
            var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
            var diff = t2-t1;
            var diffYears = Math.floor(diff/years);
            var diffDays = Math.floor((diff/days)-diffYears*365);
            var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
            var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
            var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
            document.getElementById("sitetime").innerHTML="å·²åœ¨è¿™é‡Œ "+diffYears+" å¹´ "+diffDays+" å¤© "+diffHours+" å°æ—¶ "+diffMinutes+" åˆ†é’Ÿ "+diffSeconds+" ç§’";
        }
        siteTime();
    </script>



    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


 
        <div id="click-show-text"
            data-mobile = false
            data-text = å¯Œå¼º,æ°‘ä¸»,æ–‡æ˜,å’Œè°,è‡ªç”±,å¹³ç­‰,å…¬æ­£,æ³•åˆ¶,çˆ±å›½,æ•¬ä¸š,è¯šä¿¡,å‹å–„
            data-fontsize = 15px
            data-random= false>
        </div>
       

      
        <script async src=https://cdn.jsdelivr.net/npm/hexo-next-mouse-effect@latest/click/showText.js></script>
      

      
    




    <script async src="/js/fancybox_param.js"></script>





<!-- APlayeræœ¬ä½“ -->



</body>
</html>
