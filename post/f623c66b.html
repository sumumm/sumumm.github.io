<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/green/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"sumumm.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":300},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本文主要是Cortex-M3异常与NVIC介绍的一些的相关笔记，若笔记中有错误或者不合适的地方，欢迎批评指正😃。">
<meta property="og:type" content="article">
<meta property="og:title" content="LV16-13-Cortex-M3异常与NVIC">
<meta property="og:url" content="https://sumumm.github.io/post/f623c66b.html">
<meta property="og:site_name" content="苏木">
<meta property="og:description" content="本文主要是Cortex-M3异常与NVIC介绍的一些的相关笔记，若笔记中有错误或者不合适的地方，欢迎批评指正😃。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/1.gif">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230501095948630.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416220627178.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416220643832.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221150873.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221128792.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221330969.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221525461.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221600368.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221923360.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221939791.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416222219091.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416222342224.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221525461.png">
<meta property="article:published_time" content="2023-06-04T14:06:56.000Z">
<meta property="article:modified_time" content="2025-06-13T16:25:57.009Z">
<meta property="article:author" content="苏木">
<meta property="article:tag" content="LV16-STM32开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/1.gif">


<link rel="canonical" href="https://sumumm.github.io/post/f623c66b.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sumumm.github.io/post/f623c66b.html","path":"post/f623c66b.html","title":"LV16-13-Cortex-M3异常与NVIC"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LV16-13-Cortex-M3异常与NVIC | 苏木</title>
  








    <script src="/js/browser_tools_disable.js"></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.com/hexo-next-tags-plus@latest/lib/tag_plus.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">苏木</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">我的学习之路</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>苏木的家</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类页<span class="badge">42</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档页<span class="badge">673</span></a></li><li class="menu-item menu-item-flink"><a href="/flink/" rel="section"><i class="fa fa-link fa-fw"></i>友人帐</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%B8%B8%E8%A7%81%E7%BC%A9%E7%95%A5%E8%AF%AD%E5%90%AB%E4%B9%89"><span class="nav-text">一、常见缩略语含义</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%BC%82%E5%B8%B8"><span class="nav-text">二、异常</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%BC%82%E5%B8%B8%EF%BC%9F"><span class="nav-text">1. 什么是异常？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%BC%82%E5%B8%B8%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-text">2. 异常的类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-text">3. 优先级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E8%A1%A8%E7%A4%BA%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84%E4%BD%8D%E6%95%B0"><span class="nav-text">3.1 表示优先级的位数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AA%E5%89%A9128%E4%B8%AA%E6%8A%A2%E5%8D%A0%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%9F"><span class="nav-text">3.2 为什么只剩128个抢占优先级？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%90%91%E9%87%8F%E8%A1%A8"><span class="nav-text">4. 向量表</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81NVIC%E4%B8%8E%E4%B8%AD%E6%96%AD%E6%8E%A7%E5%88%B6"><span class="nav-text">三、NVIC与中断控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-NVIC%E6%A6%82%E8%A7%88"><span class="nav-text">1. NVIC概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%AD%E6%96%AD%E9%85%8D%E7%BD%AE%E5%9F%BA%E7%A1%80"><span class="nav-text">2. 中断配置基础  </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%B8%AD%E6%96%AD%E7%9A%84%E4%BD%BF%E8%83%BD%E4%B8%8E%E9%99%A4%E8%83%BD"><span class="nav-text">3. 中断的使能与除能  </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E4%B8%AD%E6%96%AD%E7%9A%84%E6%82%AC%E8%B5%B7%E4%B8%8E%E8%A7%A3%E6%82%AC"><span class="nav-text">4. 中断的悬起与解悬  </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-text">5. 优先级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E4%BC%98%E5%85%88%E7%BA%A7%E4%BD%8D%E6%95%B0%E8%AE%BE%E7%BD%AE"><span class="nav-text">5.1 优先级位数设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E4%BC%98%E5%85%88%E7%BA%A7%E4%B8%8B%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="nav-text">5.2 优先级下的执行顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD%E4%BC%98%E5%85%88%E7%BA%A7%E6%8E%A7%E5%88%B6"><span class="nav-text">5.2 外部中断优先级控制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%B4%BB%E5%8A%A8%E7%8A%B6%E6%80%81"><span class="nav-text">6. 活动状态  </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%85%B6%E4%BB%96%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">7. 其他寄存器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E4%B8%AD%E6%96%AD%E5%BB%BA%E7%AB%8B%E5%85%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E6%BC%94%E7%A4%BA"><span class="nav-text">8. 中断建立全过程的演示  </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E8%BD%AF%E4%BB%B6%E4%B8%AD%E6%96%AD"><span class="nav-text">9. 软件中断</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苏木"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">苏木</p>
  <div class="site-description" itemprop="description">莫道桑榆晚，为霞尚满天</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">673</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/sumumm" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;sumumm" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sumumm.github.io/post/f623c66b.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="苏木">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏木">
      <meta itemprop="description" content="莫道桑榆晚，为霞尚满天">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="LV16-13-Cortex-M3异常与NVIC | 苏木">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LV16-13-Cortex-M3异常与NVIC
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-04 22:06:56" itemprop="dateCreated datePublished" datetime="2023-06-04T22:06:56+08:00">2023-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">嵌入式开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/" itemprop="url" rel="index"><span itemprop="name">01HQ课程体系</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">LV16-STM32开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>36 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>本文主要是Cortex-M3异常与NVIC介绍的一些的相关笔记，若笔记中有错误或者不合适的地方，欢迎批评指正😃。</p>
<span id="more"></span>

<!-- Photo: https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/ -->

<details class="folding-tag" blue><summary> 点击查看使用工具及版本 </summary>
              <div class='content'>
              <table>    <tr>        <td align="center" width=150px>Windows</td>        <td align="left">windows11</td>    </tr>    <tr>        <td align="center">Ubuntu</td>        <td align="left">Ubuntu16.04的64位版本</td>      </tr>    <tr>        <td align="center">VMware® Workstation 16 Pro</td>        <td align="left">16.2.3 build-19376536</td>      </tr>    <tr>        <td align="center">SecureCRT</td>        <td align="left">Version 8.7.2 (x64 build 2214)   -   正式版-2020年5月14日</td>      </tr>    <tr>        <td align="center">开发板</td>        <td align="left">正点原子 i.MX6ULL Linux阿尔法开发板</td>      </tr>    <tr>        <td align="center">uboot</td>        <td align="left">NXP官方提供的uboot，NXP提供的版本为uboot-imx-rel_imx_4.1.15_2.1.0_ga(使用的uboot版本为U-Boot 2016.03)</td>      </tr>    <tr>        <td align="center">linux内核</td>        <td align="left">linux-4.15(NXP官方提供)</td>      </tr>    <tr>        <td align="center">STM32开发板</td>        <td align="left">正点原子战舰V3(STM32F103ZET6)</td>      </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> 点击查看本文参考资料 </summary>
              <div class='content'>
              <ul><li>通用</li></ul><table><tr><td align="center">分类  </td><td align="center">网址</td><td align="center">说明</td></tr><tr><td align="center" rowspan="4">官方网站</td><td align="left"><a href="https://www.arm.com/" target="_blank">https://www.arm.com/</a></td><td align="left">ARM官方网站，在这里我们可以找到Cotex-Mx以及ARMVx的一些文档</td></tr><tr>                                            <td align="left"><a href="https://www.st.com/content/st_com/zh.html" target="_blank">https://www.st.com/content/st_com/zh.html</a></td><td align="left">ST官方网站，在这里我们可以找到STM32的相关文档</td></tr><tr>                                            <td align="left"><a href="https://www.stmcu.com.cn/" target="_blank">https://www.stmcu.com.cn/</a></td><td align="left">意法半导体ST中文官方网站，在这里我们可以找到STM32的相关中文参考文档</td></tr><tr>                                            <td align="left"><a href="http://elm-chan.org/fsw/ff/00index_e.html" target="_blank">http://elm-chan.org/fsw/ff/00index_e.html</a></td><td align="left">FatFs文件系统官网</td></tr><tr><td align="center" rowspan="3">教程书籍</td><td align="left"><a href="STM32开发相关资料/01ARM参考资料/ARM Cortex-M3权威指南(中文).pdf" target="_blank">《ARM Cortex-M3权威指南》</a></td><td alirn="left" rowspan="3">ARM公司专家Joseph Yiu（姚文祥）的力作，中文翻译是NXP的宋岩</td></tr><tr>                                            <td align="left"><a href="STM32开发相关资料/01ARM参考资料/ARM Cortex-M0权威指南(中文).pdf" target="_blank">《ARM Cortex-M0权威指南》</a></td></tr><tr>                                            <td align="left"><a href="" target="_blank">《ARM Cortex-M3与Cortex-M4权威指南》</a></td></tr><tr><td align="center" rowspan="4">开发论坛</td><td align="left"><a href="http://47.111.11.73/forum.php" target="_blank">http://47.111.11.73/forum.php</a></td><td align="left">开源电子网，正点原子的资料下载及问题讨论论坛</td></tr><tr>                                            <td align="left"><a href="https://www.firebbs.cn/forum.php" target="_blank">https://www.firebbs.cn/forum.php</a></td><td align="left">国内Kinetis开发板-野火/秉火（刘火良）主持的论坛，现也做STM32和i.MX RT</td></tr><tr>                                            <td align="left"><a href="https://www.amobbs.com/index.php" target="_blank">https://www.amobbs.com/index.php</a></td><td align="left">阿莫（莫进明）主持的论坛，号称国内最早最火的电子论坛，以交流Atmel AVR系列单片机起家，现已拓展到嵌入式全平台，其STM32系列帖子有70W+。</td></tr><tr>                                            <td align="left"><a href="http://download.100ask.net/index.html" target="_blank">http://download.100ask.net/index.html</a></td><td align="left">韦东山嵌入式资料中心，有些STM32和linux的相关资料也可以来这里找。</td></tr><tr><td align="center" rowspan="3">博客参考</td><td align="left"><a href="http://www.openedv.com/" target="_blank">http://www.openedv.com/</a></td><td align="left">开源网-原子哥个人博客</td></tr><tr>                                            <td align="left"><a href="http://blog.chinaaet.com/jihceng0622" target="_blank">http://blog.chinaaet.com/jihceng0622</a></td><td align="left">博主是原Freescale现NXP的现场应用工程师</td></tr><tr>                                            <td align="left"><a href="https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/cortex-m-resources" target="_blank">cortex-m-resources</a></td><td align="left">这其实并不算是一个博客，这是ARM公司专家Joseph Yiu收集整理的所有对开发者有用的官方Cortex-M资料链接（也包含极少数外部资源链接）</td></tr></table><ul><li>STM32</li></ul><table>    <tr><td align="center" rowspan="2">STM32</td><td align="left"><a href="https://doc.embedfire.com/mcu/stm32/f103/hal_general/zh/latest/index.html" target="_blank">STM32 HAL库开发实战指南——基于F103系列开发板</a></td><td align="left">野火STM32开发教程在线文档</td></tr><tr>                                            <td align="left"><a href="https://doc.embedfire.com/mcu/stm32/f103badao/std/zh/latest/index.html" target="_blank">STM32库开发实战指南——基于野火霸道开发板</a></td><td align="left">野火STM32开发教程在线文档</td></tr></table><ul><li>SD卡</li></ul><table>    <tr><td align="left"><a href="https://www.sdcard.org/" target="_blank">SD Association</a></td><td align="left">提供了SD存储卡和SDIO卡系统规范</td></tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> 点击查看相关文件下载 </summary>
              <div class='content'>
              <table>    <tr><td align="left"><a href="https://www.st.com/resource/en/datasheet/stm32f103ze.pdf" target="_blank">STM32F103xx英文数据手册</a></td><td align="left">STM32F103xC/D/E系列的英文数据手册</td></tr>    <tr><td align="left"><a href="https://www.stmcu.com.cn/Designresource/detail/localization_document%20/709978" target="_blank">STM32F103xx中文数据手册</a></td><td align="left">STM32F103xC/D/E系列的中文数据手册</td></tr>    <tr><td align="left"><a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf" target="_blank">STM32F10xxx英文参考手册（RM0008）</a></td><td align="left">STM32F10xxx系列的英文参考手册</td></tr>    <tr><td align="left"><a href="https://www.stmcu.com.cn/Designresource/detail/localization_document%20/710001" target="_blank">STM32F10xxx中文参考手册（RM0008）</a></td><td align="left">STM32F10xxx系列的中文参考手册</td></tr>    <tr><td align="left"><a href="https://developer.arm.com/documentation/100165/0201/?lang=en" target="_blank">Arm Cortex-M3 处理器技术参考手册-英文版</a></td><td align="left">Cortex-M3技术参考手册-英文版</td></tr>    <tr><td align="left"><a href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf" target="_blank">STM32F10xxx Cortex-M3编程手册-英文版(PM0056)</a></td><td align="left">STM32F10xxx/20xxx/21xxx/L1xxxx系列Cortex-M3编程手册-英文版</td></tr>    <tr><td align="left"><a href="https://www.sdcard.org/downloads/pls/" target="_blank">SD卡相关资料——最新版本</a></td><td align="left">有关SD卡的一些资料可以从这里下载</td></tr>    <tr><td align="left"><a href="https://www.sdcard.org/downloads/pls/archives/" target="_blank">SD卡相关资料——历史版本</a></td><td align="left">有关SD卡的一些历史版本资料可以从这里下载，比如后边看的SD卡2.0协议</td></tr>    <tr><td align="left"><a href="./" target="_blank">SD 2.0 协议标准完整版</a></td><td align="left">这是一篇关于SD卡2.0协议的中文文档，还是比较有参考价值的，可以一看</td></tr></table>
              </div>
            </details> 

<h1 id="一、常见缩略语含义"><a href="#一、常见缩略语含义" class="headerlink" title="一、常见缩略语含义"></a><font size=3>一、常见缩略语含义</font></h1><table>
<thead>
<tr>
<th>缩写</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>IRQ</td>
<td>中断请求（通常是指外部中断的请求）</td>
</tr>
<tr>
<td>ISR</td>
<td>中断服务例程</td>
</tr>
<tr>
<td>NMI</td>
<td>不可屏蔽中断</td>
</tr>
<tr>
<td>NVIC</td>
<td>嵌套向量中断控制器</td>
</tr>
<tr>
<td>PSP</td>
<td>进程堆栈指针</td>
</tr>
</tbody></table>
<h1 id="二、异常"><a href="#二、异常" class="headerlink" title="二、异常"></a><font size=3>二、异常</font></h1><h2 id="1-什么是异常？"><a href="#1-什么是异常？" class="headerlink" title="1. 什么是异常？"></a><font size=3>1. 什么是异常？</font></h2><p>正常情况下，微处理器根据代码内容，按顺序执行指令。执行过程中，如果遇到其它紧急的事件需要处理，则先暂停当前任务，执行紧急事件，待紧急事件处理完后，再恢复到刚才暂停的地方继续执行。这个产生的紧急事件就叫做<strong>中断或异常</strong>  。</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/1.gif" alt="1" style="zoom:50%;" />

<p>我们可以看一张更加详细的图片：</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230501095948630.png" alt="image-20230501095948630" style="zoom:33%;" />

<p>通常， 把CPU内部产生的紧急事件叫做异常，比如非法指令（除零） 、 地址访问越界等； 把来自CPU外部的片上外设产生的紧急事件叫做中断，比如GPIO引脚电平变化、 定时器溢出等。 异常和中断的效果基本一致，都是暂停当前任务， 优先执行紧急事件，因此一般将中断和异常统称为中断。</p>
<p>ARM公司设计了Cortex-M3内核，这个内核就包含了中断系统框架，对应资料“ [CortexM3权威指南.pdf](STM32开发相关资料&#x2F;01ARM参考资料&#x2F;ARM Cortex-M3权威指南(中文).pdf)”，后简称《CM3权威指南》。ST公司根据该内核， 因地制宜的设计了STM32系列产品， 对应资料“ <a target="_blank" rel="noopener" href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf">STM32F10xx CortexM3编程手册.pdf</a>”，后简称《CM3编程手册》。  </p>
<h2 id="2-异常的类型"><a href="#2-异常的类型" class="headerlink" title="2. 异常的类型"></a><font size=3>2. 异常的类型</font></h2><p>Cortex‐M3 在内核水平上搭载了一个异常响应系统， 支持为数众多的系统异常和外部中断。其中，编号为 1~15的对应系统异常，大于等于 16 的则全是外部中断。</p>
<p>除了个别异常的优先级被定死外， 其它异常的优先级都是可编程的（所有能打断正常执行流的事件都称为异常）。</p>
<p>因为芯片设计者可以修改 CM3 的硬件描述源代码，所以做成芯片后，支持的中断源数目常常不到 240 个，并且优先级的位数也由芯片厂商最终决定。</p>
<ul>
<li>类型编号为 1－15 的系统异常如下表所示（注意： 没有编号为 0 的异常）</li>
</ul>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416220627178.png" alt="image-20230416220627178" style="zoom:50%;" />

<ul>
<li>从 16 开始的外部中断类型如表 7.2 所示。</li>
</ul>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416220643832.png" alt="image-20230416220643832" style="zoom:50%;" />

<p>Reset（ 复位） 、 NMI（ Non Maskable Interrupt，不可屏蔽中断）、 HardFault（ 硬件异常） 的优先级是固定的， 且优先级是负数，也就是最高的（优先级数字越小，优先级越高）。 剩下的异常或中断，都是可以通过修改NVIC的寄存器调整优先级（ 但不能设置为负数），后边会提到 。 </p>
<p>在 NVIC（后边会学到）的中断控制及状态寄存器中，有一个 VECTACTIVE 位段；另外，还有一个特殊功能寄存器 IPSR。在它们二者的里面，都记录了当前正服务异常的编号。需要注意：这里所讲的中断号，都是指 NVIC 所使用的中断号。另一方面，芯片一些管脚的名字也可能被取为类似”IRQ #”的名字，这两者不能混淆，它们没有必然联系。</p>
<p>常见的情况是，编号最靠前的几个中断源被指定到片上外设，接下来的中断源才给外部中断引脚使用，因此还是要参阅芯片的数据手册来弄清楚。</p>
<p>如果一个发生的异常不能被即刻响应，就称它被<strong>“悬起</strong>” (pending)。不过，少数 fault 异常是不允许被悬起的。一个异常被悬起的原因，可能是系统当前正在执行一个更高优先级异常的服务例程，或者因相关掩蔽位的设置导致该异常被除能。对于每个异常源，在被悬起的情况下，都会有一个对应的“悬起状态寄存器”保存其异常请求，直到该异常能够执行为止，这与传统的 ARM 是完全不同的。在以前，是由产生中断的设备保持住请求信号。现在NVIC 的悬起状态寄存器的出现解决了这个问题，即使后来设备已经释放了请求信号，曾经的中断请求也不会错失。  </p>
<h2 id="3-优先级"><a href="#3-优先级" class="headerlink" title="3. 优先级"></a><font size=3>3. 优先级</font></h2><p>从上一小节我们知道有256个中断，那么如此多的中断， 导致了一些新问题。 比如两个中断同时发生，应该先执行哪个中断任务？又比如一个中断发生了，又来了一个更紧急的中断，是该继续执行原来的中断，还是执行新的紧急中断？  于是就有了优先级的概念。</p>
<h3 id="3-1-表示优先级的位数"><a href="#3-1-表示优先级的位数" class="headerlink" title="3.1 表示优先级的位数"></a><font size=3>3.1 表示优先级的位数</font></h3><p>在 CM3 中，优先级对于异常来说很关键的，它会影响一个异常是否能被响应，以及何时可以响应。<strong>优先级的数值越小，则优先级越高</strong>。 CM3 支持中断嵌套，使得高优先级异常会抢占(preempt)低优先级异常。</p>
<p>有 3 个系统异常：复位， NMI 以及硬 fault，它们有固定的优先级，并且它们的优先级号是负数，从而高于所有其它异常。所有其它异常的优先级则都是可编程的（但不能编程为负数）。</p>
<p>原则上， CM3 支持 3 个固定的高优先级和多达 256 级的可编程优先级，并且支持 128 级抢占（128 的来历请见下文）。但是，绝大多数 CM3 芯片都会精简设计，以致实际上支持的优先级数会更少，如 8 级， 16 级， 32 级等。它们在设计时会<strong>裁掉表达优先级的几个低端有效位，以达到减少优先级数的目的</strong>（可见，不管使用多少位，优先级号是以MSB 对齐的）。举例来说，如果只使用了 3 个位来表达优先级，则优先级配置寄存器的结构会如图所示：  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221150873.png" alt="image-20230416221150873" style="zoom:50%;" />

<p>在图中， [4:0]没有被实现，所以读它们总是返回零，写它们则忽略写入的值。因此，对于 3 个位的情况，我们能够使用的 8 个优先级为： 0x00（最高）， 0x20， 0x40， 0x60， 0x80，0xA0， 0xC0 以及 0xE0。</p>
<p>如果使用更多的位来表达优先级，则能够使用的值也更多，同时需要的门也更多——带来更多的成本和功耗。CM3 允许的<strong>最少使用位数为 3 个位</strong>，也就是说<strong>至少要支持 8 级优先级</strong>。下图给出 3 个优先级位和 4 个优先级位的对比：  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221128792.png" alt="image-20230416221128792" style="zoom: 50%;" />



<p>通过让优先级以 MSB 对齐，可以简化程序的跨器件移植。比如，如果一个程序早先在支持 4 位优先级的器件上运行，在移植到只支持 3 位优先级的器件后，其功能不受影响。但若是对齐到 LSB，则会使 MSB 丢失，导致数值大于 7 的低优先级一下子升高了，甚至会反转小于等于 7 的高优先级。如， 8 号优先级（1000 0000）因为损失了 MSB（高位的1丢掉了的话），现在反而变成 0 号了 。</p>
<p>那么当使用了 3 位、 5 位及 8 位来表达优先级时，各是什么情况呢？  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221330969.png" alt="image-20230416221330969" style="zoom:50%;" />

<h3 id="3-2-为什么只剩128个抢占优先级？"><a href="#3-2-为什么只剩128个抢占优先级？" class="headerlink" title="3.2 为什么只剩128个抢占优先级？"></a><font size=3>3.2 为什么只剩128个抢占优先级？</font></h3><p>明明支持 256 个优先级，为啥只有 128 个抢占级，剩下一半哪儿去了？原来，为了使抢占机能变得更可控， CM3 还把 256 级优先级按位分成高低两段，分别是<strong>抢占优先级</strong>和<strong>亚优先级</strong>。</p>
<p>NVIC 中有一个寄存器是“应用程序中断及复位控制寄存器”：</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221525461.png" alt="image-20230416221525461" style="zoom:50%;" />

<p>它里面有一个位段名为“优先级组”。该位段的值对每一个优先级可配置的异常都有影响——把其优先级分为个位段： MSB 所在的位段（左边的）对应抢占优先级，而 LSB 所在的位段（右边的）对应亚优先级 ：</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221600368.png" alt="image-20230416221600368" style="zoom:50%;" />

<p>抢占优先级决定了抢占行为：当系统正在响应某异常 L 时，如果来了抢占优先级更高的异常 H，则 H 可以抢占 L。亚优先级则处理“内务”：当抢占优先级相同的异常有不止一个悬起时，就优先响应亚优先级最高的异常。这种优先级分组规定：<strong>亚优先级至少是 1 个位</strong>。因此<strong>抢占优先级最多是 7 个位，造成了最多只有 128 级抢占的现象</strong>。    </p>
<p>但是 CM3 允许从比特 7 处分组，此时所有的位都表达亚优先级，没有任何位表达抢占优先级，因而所有优先级可编程的异常之间就不会发生抢占——相当于在它们之中除能了CM3 的中断嵌套机制。当然还有凌架于法律之上的三位老大：复位， NMI 和硬 fault。它们无论何时出现，都立即无条件抢占所有优先级可编程的“平民异常”。  </p>
<p>在计算抢占优先级和亚优先级的有效位数时，必须先求出下列值 :</p>
<ul>
<li>芯片实际使用了多少位来表达优先级。</li>
<li>优先级组是如何划分的。</li>
</ul>
<p>举个例子，如果只使用 3 个位来表达优先级（[7:5]有效，剩下的[4:0]无效，全为0），那么此时的优先级组的值是 5（从比特 5 处分组），这样我们得到 4 级抢占优先级，且在每个抢占优先级的内部有 2 个亚优先级，如下图所示。  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221923360.png" alt="image-20230416221923360" style="zoom:50%;" />

<p>那么这种情况之下，其可用优先级的具体情况如下所示：  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221939791.png" alt="image-20230416221939791" style="zoom: 50%;" />



<p>注意：虽然[4:0]未使用，却允许从它们中分组。例如，如果优先级组为 1 ，则所有可用的 8 个优先级（因为目前分析的是只有3个位表示优先级，也就是最高3位 [7:5] 才表示有效的优先级）都是抢占优先级，如下图（3 位优先级，从比特 1 处分组  ）:</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416222219091.png" alt="image-20230416222219091" style="zoom:50%;" />

<p>那么 3 位优先级，从比特 1 处分组，详细情况 如下图，即便是从位 1 处分组，理论上有4个亚优先级，32个抢占优先级，但是由于只有最高三位表示优先级，这就导致了只会有8个抢占优先级，0个亚优先级的情况：</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416222342224.png" alt="image-20230416222342224" style="zoom:50%;" />

<p>如果优先级完全相同的多个异常同时悬起，则先响应异常编号最小的那一个。如 IRQ #3 会比 IRQ #5 先得到响应。  </p>
<p>虽然优先级分组的功能很强大，但是粗心地更改会使它变得很暴力，尤其是在设计硬实时系统的时候，这常常会改变系统的响应特性，导致某些关键任务有可能得不到及时响应，凶多吉少的意外随时可能猛烈发作。其实在绝大多数情况下，优先级的分组都要预先经过计算论证，并且在开机初始化时一次性地设置好，以后就再也不动它了。只有在绝对需要且绝对有把握时，才小心地更改，并且要经过尽可能充分的测试。另外，优先级组所在的寄存器 AIRCR也基本上是“一次成型”，只是需要手工产生复位时才写里面相应的位。  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/01HQ%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB/LV16-STM32%E5%BC%80%E5%8F%91/LV16-13-Cortex-M3%E5%BC%82%E5%B8%B8%E4%B8%8ENVIC/img/image-20230416221525461.png" alt="image-20230416221525461" style="zoom:50%;" />

<h2 id="4-向量表"><a href="#4-向量表" class="headerlink" title="4. 向量表"></a><font size=3>4. 向量表</font></h2><p>当发生了异常并且要响应它时， CM3 需要定位其处理例程的入口地址。这些入口地址存储在所谓的“（异常）向量表”中。缺省情况下， CM3 认为该表位于零地址处，且各向量占用 4 字节，因此每个表项占用 4 字节，如下表所示。  </p>
<table>
<thead>
<tr>
<th align="center">地址</th>
<th align="center">异常编号</th>
<th>值（32 位整数）</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x0000_0000</td>
<td align="center">‐</td>
<td>MSP 的初始值</td>
</tr>
<tr>
<td align="center">0x0000_0004</td>
<td align="center">1</td>
<td>复位向量（PC 初始值）</td>
</tr>
<tr>
<td align="center">0x0000_0008</td>
<td align="center">2</td>
<td>NMI 服务例程的入口地址</td>
</tr>
<tr>
<td align="center">0x0000_000C</td>
<td align="center">3</td>
<td>硬 fault 服务例程的入口地址</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td>其它异常服务例程的入口地址</td>
</tr>
</tbody></table>
<p>因为地址 0 处应该存储引导代码，所以它通常是 Flash 或者是 ROM 器件，并且它们的值不得在运行时改变。然而，为了动态重分发中断， CM3 允许向量表重定位——从其它地址处开始定位各异常向量。这些地址对应的区域可以是代码区，但也可以是 RAM 区。</p>
<p>在 RAM区就可以修改向量的入口地址了。为了实现这个功能， NVIC 中有一个寄存器，称为“向量表偏移量寄存器”（在地址 0xE000_ED08 处），通过修改它的值就能定位向量表。</p>
<p><strong>【注意】</strong>向量表的起始地址是有要求的：必须先求出系统中共有多少个向量，再把这个数字向上增大到是 2 的整次幂，而起始地址必须对齐到后者的边界上。例如，如果一共有 32 个中断，则共有 32+16（系统异常） &#x3D; 48 个向量，向上增大到 2 的整次幂后值为 64，因此地址地址必须能被 64*4&#x3D;256 整除，从而合法的起始地址可以是： 0x0, 0x100, 0x200 等。向量表偏移量寄存器的定义如下表所示。  </p>
<table>
<thead>
<tr>
<th>位段</th>
<th>名称</th>
<th>类型</th>
<th>复位值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>29</td>
<td>TBLBASE</td>
<td>RW</td>
<td>0</td>
<td>向量表是在 Code 区（0），还是在 RAM 区（1）</td>
</tr>
<tr>
<td>15</td>
<td>ENDIANESS</td>
<td>R</td>
<td>‐</td>
<td>向量表的起始地址</td>
</tr>
</tbody></table>
<p>如果需要动态地更改向量表，则对于任何器件来说，向量表的起始处都必须包含以下向量：</p>
<p>（1）主堆栈指针（MSP）的初始值</p>
<p>（2）复位向量</p>
<p>（3）NMI（不可屏蔽中断）</p>
<p>（4）硬 fault 服务例程</p>
<p>后两者也是必需的，因为有可能在引导过程中发生这两种异常。我们可以在 SRAM 中开出一块用于存储向量表。然后在引导完成后，就可以启用内存中的向<br>量表，从而实现向量可动态调整的功能。  </p>
<h1 id="三、NVIC与中断控制"><a href="#三、NVIC与中断控制" class="headerlink" title="三、NVIC与中断控制"></a><font size=3>三、NVIC与中断控制</font></h1><h2 id="1-NVIC概览"><a href="#1-NVIC概览" class="headerlink" title="1. NVIC概览"></a><font size=3>1. NVIC概览</font></h2><p>Cortex-M3内核有一个专门管理中断的外设NVIC（ Nested Vectored Interrupt Controller，嵌套向量中断控制器） ， 通过优先级控制中断的嵌套和调度。NVIC是一个总的中断控制器， 无论是来在内核的异常还是外设的外部中断， 都由NVIC统一进行管理。 是 Cortex‐M3 不可分离的一部分， 它与 CM3 内核的逻辑紧密耦合， 有一部分甚至水乳交融在一起。 </p>
<p>NVIC 与 CM3 内核同声相应，同气相求，相辅相成，里应外合，共同完成对中断的响应。 NVIC作为在内核里的外设，NVIC 的寄存器以存储器映射的方式来访问， 除了包含控制寄存器和中断处理的控制逻辑之外， NVIC 还包含了 MPU的控制寄存器、 SysTick 定时器以及调试控制。</p>
<p>NVIC 共支持 1 至 240 个外部中断输入（通常外部中断写作 IRQs）。 具体的数值由芯片厂商在设计芯片时决定。此外， NVIC 还支持一个“永垂不朽”的不可屏蔽中断（NMI）输入。NMI 的实际功能亦由芯片制造商决定。在某些情况下， NMI 无法由外部中断源控制。NVIC 的访问地址是 0xE000_E000。 所有NVIC 的中断控制&#x2F;状态寄存器都只能在特权级下访问。 不过有一个例外——软件触发中断寄存器可以在用户级下访问以产生软件中断。 </p>
<p>所有的中断控制／状态寄存器均可按字／半字／字节的方式访问。 此外， 有几个中断屏蔽寄存器也与中断控制密切相关，它们是“特殊功能寄存器”， 只能通过 MRS&#x2F;MSR及 CPS 来访问。  </p>
<h2 id="2-中断配置基础"><a href="#2-中断配置基础" class="headerlink" title="2. 中断配置基础  "></a><font size=3>2. 中断配置基础  </font></h2><p>每个外部中断都在 NVIC 的下列寄存器中“挂号”：</p>
<p>（1）使能与除能寄存器</p>
<p>（2）悬起与“解悬”寄存器</p>
<p>（3）优先级寄存器</p>
<p>（4）活动状态寄存器</p>
<p>另外，下列寄存器也对中断处理有重大影响</p>
<p>（1）异常掩蔽寄存器（PRIMASK, FAULTMASK 以及 BASEPRI）</p>
<p>（2）向量表偏移量寄存器</p>
<p>（3）软件触发中断寄存器</p>
<p>（4）优先级分组位段  </p>
<h2 id="3-中断的使能与除能"><a href="#3-中断的使能与除能" class="headerlink" title="3. 中断的使能与除能  "></a><font size=3>3. 中断的使能与除能  </font></h2><p>中断的使能与除能分别使用各自的寄存器来控制——这与传统的， 使用单一比特的两个状态来表达使能与除能是不同的。 CM3 中可以有 240 对使能位／除能位，每个中断拥有一对。这 240 个对子分布在 8 对 32 位寄存器中（最后一对没有用完）。欲使能一个中断，需要写 1 到对应 SETENA 的位中；欲除能一个中断，需要写 1 到对应的 CLRENA 位中；如果往它们中写 0，不会有任何效果。通过这种方式，使能／除能中断时只需把“当事位”写成1，其它的位可以全部为零。再也不用像以前那样，害怕有些位被写入 0 而破坏其对应的中断设置（因为现在写 0 没有效果），从而实现每个中断都可以自顾地设置，而互不侵犯——只需单一的写指令，不再需要读‐改‐写。</p>
<p>如上所述， SETENA 位和 CLRENA 位可以有 240 对，对应的 32 位寄存器可以有 8 对，因此使用数字后缀来区分这些寄存器，如 SETENA0, SETENA1…SETENA7，如下表所示（SETENAs: xE000_E100 – 0xE000_E11C ; CLRENAs:0xE000E180 - 0xE000_E19C  ）。</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">类型</th>
<th align="center">地址</th>
<th align="center">复位值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SETENA0</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E100</td>
<td align="center">0</td>
<td>中断 0‐31 的使能寄存器，共 32 个使能位 位[n]，中断#n 使能（异常号 16+n）</td>
</tr>
<tr>
<td align="center">SETENA1</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E104</td>
<td align="center">0</td>
<td>中断 32‐63 的使能寄存器，共 32 个使能位</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td>…</td>
</tr>
<tr>
<td align="center">SETENA7</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E11C</td>
<td align="center">0</td>
<td>中断 224‐239 的使能寄存器，共 16 个使能位</td>
</tr>
<tr>
<td align="center">CLRENA0</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E180</td>
<td align="center">0</td>
<td>中断 0‐31 的除能寄存器，共 32 个除能位 位[n]，中断#n 除能（异常号 16+n）</td>
</tr>
<tr>
<td align="center">CLRENA1</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E184</td>
<td align="center">0</td>
<td>中断 32‐63 的除能寄存器，共 32 个除能位</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td>…</td>
</tr>
<tr>
<td align="center">CLRENA7</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E19C</td>
<td align="center">0</td>
<td>中断 224‐239 的除能寄存器，共 16 个除能位</td>
</tr>
</tbody></table>
<p>但是在特定的芯片中，只有该芯片实现的中断，其对应的位才有意义。因此，如果使用的芯片支持 32 个中断，则只有 SETENA0&#x2F;CLRENA0 才需要使用。SETENA&#x2F;CLRENA 可以按字&#x2F;半字&#x2F;字节的方式来访问。又因为前 16 个异常已经分配给系统异常，故而中断 0 的异常号是 16。  </p>
<h2 id="4-中断的悬起与解悬"><a href="#4-中断的悬起与解悬" class="headerlink" title="4. 中断的悬起与解悬  "></a><font size=3>4. 中断的悬起与解悬  </font></h2><p>如果中断发生时，正在处理同级或高优先级异常，或者被掩蔽，则中断不能立即得到响应。此时中断被悬起。中断的悬起状态可以通过“中断设置悬起寄存器(SETPEND)”和“中断悬起清除寄存器(CLRPEND)”来读取，还可以写它们来手工悬起中断。</p>
<p>悬起寄存器和“解悬”寄存器也可以有 8 对，其用法和用量都与前面介绍的使能&#x2F;除能寄存器完全相同， 如下表（SETPENDs:0xE000_E200 – 0xE000_E21C ; CLRPENDs:0xE000E280 - 0xE000_E29C  ）：</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">类型</th>
<th align="center">地址</th>
<th align="center">复位值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SETPEND0</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E200</td>
<td align="center">0</td>
<td>中断 0‐31 的悬起寄存器，共 32 个悬起位 位[n]，中断#n 悬起（异常号 16+n）</td>
</tr>
<tr>
<td align="center">SETPEND1</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E204</td>
<td align="center">0</td>
<td>中断 32‐63 的悬起寄存器，共 32 个悬起位</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td>…</td>
</tr>
<tr>
<td align="center">SETPEND7</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E21C</td>
<td align="center">0</td>
<td>中断 224‐239 的悬起寄存器，共 16 个悬起位</td>
</tr>
<tr>
<td align="center">CLRPEND0</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E280</td>
<td align="center">0</td>
<td>中断 0‐31 的解悬寄存器，共 32 个解悬位 位[n]，中断#n 解悬（异常号 16+n）</td>
</tr>
<tr>
<td align="center">CLRPEND1</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E284</td>
<td align="center">0</td>
<td>中断 32‐63 的解悬寄存器，共 32 个解悬位</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td>…</td>
</tr>
<tr>
<td align="center">CLRPEND7</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E29C</td>
<td align="center">0</td>
<td>中断 224‐239 的解悬寄存器，共 16 个解悬位</td>
</tr>
</tbody></table>
<h2 id="5-优先级"><a href="#5-优先级" class="headerlink" title="5. 优先级"></a><font size=3>5. 优先级</font></h2><h3 id="5-1-优先级位数设置"><a href="#5-1-优先级位数设置" class="headerlink" title="5.1 优先级位数设置"></a><font size=3>5.1 优先级位数设置</font></h3><p>通过应用中断和复位控制寄存器（ Application Interrupt and Reset Control Register， AIRCR） 的Bits[10:8]（ PRIGROUP）将优先级分组。分组决定每个可编程中断的PRI_n的Bits[7:0]的高低位分配，从而影响抢占优先和亚优先级的级数 </p>
<table>
<thead>
<tr>
<th>PRIGROUP</th>
<th>抢占优先级位</th>
<th>亚优先级位</th>
<th>抢占优先级级数</th>
<th>亚优先级级数</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>[7:1]</td>
<td>[0]</td>
<td>128</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>[7:2]</td>
<td>[1:0]</td>
<td>64</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>[7:3]</td>
<td>[2:0]</td>
<td>32</td>
<td>8</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>[7:4]</td>
<td>[3:0]</td>
<td>16</td>
<td>16</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>[7:5]</td>
<td>[4:0]</td>
<td>8</td>
<td>32</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>[7:6]</td>
<td>[5:0]</td>
<td>4</td>
<td>64</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>[7]</td>
<td>[6:0]</td>
<td>2</td>
<td>128</td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>None</td>
<td>[7:0]</td>
<td>1</td>
<td>256</td>
<td></td>
</tr>
</tbody></table>
<p>假设将优先级分组（ PRIGROUP）设置为2，此时每个中断可设置抢占优先级范围为0<del>32，亚优先级范围为0</del>8， 比如某中断的抢占优先级为2， 亚优先级为3。  </p>
<h3 id="5-2-优先级下的执行顺序"><a href="#5-2-优先级下的执行顺序" class="headerlink" title="5.2 优先级下的执行顺序"></a><font size=3>5.2 优先级下的执行顺序</font></h3><p>所有可编程的中断都需要指定抢占优先级和亚优先级， 抢占优先级决定是否可以产生中断嵌套，亚优先级决定中断响应顺序，若两种优先级一样则看中断在中断异常表中的位置，越靠前越先响应。抢占优先级高（值小） 的中断可以中断抢占优先级低（值大） 的中断处理函数，进而执行高优先级的中断处理函数，执行完毕后再继续执行被中断的低优先级的处理函数。</p>
<p>当两个中断的抢占优先级相同时，即这两个中断将没有嵌套关系，当一个中断到来后，若此时CPU正在处理另一个中断，则这个后到来的中断就要等到前一个中断处理函数处理完毕后才能被处理，当这两个中断同时到达，则中断控制器会根据它们的亚优先级决定先处理哪个。</p>
<p>如果两个中断的优先级都设置为一样了，那么谁先触发的就谁先执行；如果是同时触发的，那么就根据中断异常表的位置（靠前） 来决定谁先执行。  </p>
<h3 id="5-2-外部中断优先级控制"><a href="#5-2-外部中断优先级控制" class="headerlink" title="5.2 外部中断优先级控制"></a><font size=3>5.2 外部中断优先级控制</font></h3><p>每个外部中断都有一个对应的优先级寄存器，每个寄存器占用 8 位，但是允许最少只使用最高 3 位。 4 个相临的优先级寄存器拼成一个 32 位寄存器。如前所述，根据优先级组设置，优先级可以被分为高低两个位段，分别是抢占优先级和亚优先级。优先级寄存器都可以按字节访问，当然也可以按半字&#x2F;字来访问。有意义的优先级寄存器数目由芯片厂商实现的中断数目决定，优先级配置相关寄存器如下表：</p>
<ul>
<li>中断优先级寄存器阵列 （0xE000_E400 – 0xE000_E4EF）</li>
</ul>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">类型</th>
<th align="center">地址</th>
<th align="center">复位值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">PRI_0</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E400</td>
<td align="center">0（8 位）</td>
<td>外中断#0 的优先级</td>
</tr>
<tr>
<td align="center">PRI_1</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E401</td>
<td align="center">0（8 位）</td>
<td>外中断#1 的优先级</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td>…</td>
</tr>
<tr>
<td align="center">PRI_239</td>
<td align="center">R&#x2F;W</td>
<td align="center">0xE000_E4EF</td>
<td align="center">0（8 位）</td>
<td>外中断#239 的优先级</td>
</tr>
</tbody></table>
<ul>
<li>系统异常优先级寄存器阵列 （0xE000_ED18 － 0xE000_ED23 ）</li>
</ul>
<table>
<thead>
<tr>
<th align="center">地址</th>
<th align="center">名称</th>
<th>类型</th>
<th>复位值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0xE000_ED18</td>
<td align="center">PRI_4</td>
<td>存储器管理 fault 的优先级</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center">0xE000_ED19</td>
<td align="center">PRI_5</td>
<td>总线 fault 的优先级</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center">0xE000_ED1A</td>
<td align="center">PRI_6</td>
<td>用法 fault 的优先级</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center">0xE000_ED1B</td>
<td align="center">‐</td>
<td>‐</td>
<td>‐</td>
<td>‐</td>
</tr>
<tr>
<td align="center">0xE000_ED1C</td>
<td align="center">‐</td>
<td>‐</td>
<td>‐</td>
<td>‐</td>
</tr>
<tr>
<td align="center">0xE000_ED1D</td>
<td align="center">‐</td>
<td>‐</td>
<td>‐</td>
<td>‐</td>
</tr>
<tr>
<td align="center">0xE000_ED1E</td>
<td align="center">‐</td>
<td>‐</td>
<td>‐</td>
<td>‐</td>
</tr>
<tr>
<td align="center">0xE000_ED1F</td>
<td align="center">PRI_11</td>
<td>SVC 优先级</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center">0xE000_ED20</td>
<td align="center">PRI_12</td>
<td>调试监视器的优先级</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center">0xE000_ED21</td>
<td align="center">‐</td>
<td>‐</td>
<td>‐</td>
<td>‐</td>
</tr>
<tr>
<td align="center">0xE000_ED22</td>
<td align="center">PRI_14</td>
<td>PendSV 的优先级</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center">0xE000_ED23</td>
<td align="center">PRI_15</td>
<td>SysTick 的优先级</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="6-活动状态"><a href="#6-活动状态" class="headerlink" title="6. 活动状态  "></a><font size=3>6. 活动状态  </font></h2><p>每个外部中断都有一个活动状态位。在处理器执行了其 ISR 的第一条指令后，它的活动位就被置 1，并且直到 ISR 返回时才硬件清零。由于支持嵌套，允许高优先级异常抢占某个ISR。然而，哪怕一个中断被抢占，其活动状态也依然为 1（请仔细琢磨前文讲到的“直到 ISR返回时才清零）。活动状态寄存器的定义，与前面讲的使能&#x2F;除能和悬起&#x2F;解悬寄存器相同，只是不再成对出现。它们也能按字／半字／字节访问，但他们是只读的，如下表。  </p>
<ul>
<li>ACTIVE 寄存器族 （0xE000_E300_0xE000_E31C ）</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>地址</th>
<th>复位值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>ACTIVE0</td>
<td>RO</td>
<td>0xE000_E300</td>
<td>0</td>
<td>中断 0‐31 的活动状态寄存器，共 32 个状态位 位[n]，中断#n 活动状态（异常号 16+n）</td>
</tr>
<tr>
<td>ACTIVE1</td>
<td>RO</td>
<td>0xE000_E304</td>
<td>0</td>
<td>中断 32‐63 的活动状态寄存器，共 32 个状态位</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>ACTIVE7</td>
<td>RO</td>
<td>0xE000_E31C</td>
<td>0</td>
<td>中断 224‐239 的活动状态寄存器，共 16 个状态 位</td>
</tr>
</tbody></table>
<h2 id="7-其他寄存器"><a href="#7-其他寄存器" class="headerlink" title="7. 其他寄存器"></a><font size=3>7. 其他寄存器</font></h2><p>后边还有一些其他的寄存器，这里就不写了，后边用到的话可以再查手册。</p>
<h2 id="8-中断建立全过程的演示"><a href="#8-中断建立全过程的演示" class="headerlink" title="8. 中断建立全过程的演示  "></a><font size=3>8. 中断建立全过程的演示  </font></h2><p>下面给出一个简单的例子，以演示如何建立一个外部中断 ：</p>
<p>（1）当系统启动后，先设置优先级组寄存器。缺省情况下使用组0（7位抢占优先级， 1位亚优先级）。</p>
<p>（2）如果需要重定位向量表，先把硬fault和NMI服务例程的入口地址写到新表项所在的地址中。</p>
<p>（3）配置向量表偏移量寄存器，使之指向新的向量表（如果有重定位的话）。</p>
<p>（4）为该中断建立中断向量。因为向量表可能已经重定位了，保险起见需要先读取向量表偏移量寄存器的值，再根据该中断在表中的位置，计算出服务例程入口地址应写入的表项，再填写之。如果一直使用ROM中的向量表，则无需此步骤。</p>
<p>（5）为该中断设置优先级。</p>
<p>（6）使能该中断</p>
<p>另外，如果优先级组设置使得中断嵌套层次可以很深，则务必请确认主堆栈空间足够用。因为异常服务程序总是使用MSP，为安全起见，主堆栈的容量应是最大可能需求的量（嵌套最深时需要的量）。如果应用程序储存在ROM中，并且不需要改变异常服务程序，则我们可以把整个向量表编码到ROM的起始区域（从0地址开始的那段）。在这种情况下，向量表的偏移量将一直为0,并且中断向量一直在ROM中，因此上例可以大大简化，只需3步：  </p>
<p>（1）建立优先级组</p>
<p>（2）为该中断指定优先级</p>
<p>（3）使能该中断</p>
<p>如果在I&#x2F;O密集型系统中，软件需要控制大量的硬件设备，则可能必须要考虑如下因素：</p>
<ul>
<li><p>该芯片支持的中断数</p>
</li>
<li><p>该芯片中表达优先级的位数</p>
</li>
</ul>
<p>在CM3的NVIC中，有一个名为“中断控制器类型寄存器”，它提供了该芯片中支持的中断数目，粒度是32的整数倍，（如下表所示）。如果嫌它太粗枝大叶，也可以通过对每个SETENA位进行先写后读的测试，来获取支持的中断的精确数目（往各SETENA中写1，不支持的中断将永远读回0，求出第1个0的位置即可），亦可使用SETPEND等其它位来做此测试。这主要用于需要适应不同芯片的程序。如果已经确定使用固定的芯片，则无需多此一举。  </p>
<table>
<thead>
<tr>
<th>位段</th>
<th>名称</th>
<th>类型</th>
<th>复位值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>4:0</td>
<td>INTLINESUM</td>
<td>R</td>
<td>‐</td>
<td>中断输入的数量，以 32 为粒度，如 0&#x3D;1 至 32；1&#x3D;33 至 64；2&#x3D;65 至 96 …</td>
</tr>
</tbody></table>
<p>为了判定正在使用的芯片使用了多少位来表达优先级，也可使用类似的方法：往某个优先级寄存器中写入0xFF，再读回来。则从MSB开始，有多少位是1就有多少位表达优先级。最少要使用3个位，此时读回的是0xE0。  </p>
<h2 id="9-软件中断"><a href="#9-软件中断" class="headerlink" title="9. 软件中断"></a><font size=3>9. 软件中断</font></h2><p>软件中断，包括手工产生的普通中断，能以多种方式产生。最简单的就是使用相应的SETPEND寄存器；而更专业更快捷的作法，则是通过使用软件触发中断寄存器STIR，如下表。</p>
<ul>
<li>软件触发中断寄存器STIR（地址：0xE000_EF00）</li>
</ul>
<table>
<thead>
<tr>
<th>位段</th>
<th>名称</th>
<th>类型</th>
<th>复位值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>8:0</td>
<td>INTID</td>
<td>W</td>
<td>‐</td>
<td>影响编号为 INTID 的外部中断，其悬起位被置位。 例如，写入 8，则悬起 IRQ #8</td>
</tr>
</tbody></table>
<p>注意：系统异常（NMI， faults， PendSV等），不能用此法悬起。而且缺省时就不允许用户程序改动NVIC寄存器的值。如果确实需要，必须先在NVIC的配置和控制寄存器(0xE000_ED14)中，把比特1（USERSETMPEND）置位，才能允许用户级下访问NVIC的STIR。</p>

    </div>

    
    
    

    <footer class="post-footer">




    <div>
        
            <div style="text-align:center;color: #ccc;font-size:14px;">
            ----------本文结束
            <i class="fas fa-fan fa-spin" style="color: #FF1493; font-size: 1rem"></i>
            感谢您的阅读----------
            </div>
        
    </div>





  
  <div class="my_post_copyright"> 
    <p><span>文章标题:</span><a href="/post/f623c66b.html">LV16-13-Cortex-M3异常与NVIC</a></p>
    <p><span>文章作者:</span><a href="/" title="欢迎访问 《苏木》 的学习笔记">苏木</a></p>
    <p><span>发布时间:</span>2023年06月04日 - 22:06</p>
    <p><span>最后更新:</span>2025年06月14日 - 00:25</p>
    <p><span>原始链接:</span><a href="/post/f623c66b.html" title="LV16-13-Cortex-M3异常与NVIC">https://sumumm.github.io/post/f623c66b.html</a></p>
    <p><span>许可协议:</span><i class="fab fa-creative-commons"></i> <a rel="license" href= "https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
  </div>
  


          <div class="post-tags">
              <a href="/tags/LV16-STM32%E5%BC%80%E5%8F%91/" rel="tag"><i class="fa fa-tag"></i> LV16-STM32开发</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/df9d48df.html" rel="prev" title="LV16-14-STM32中断系统">
                  <i class="fa fa-angle-left"></i> LV16-14-STM32中断系统
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/b5ae2a27.html" rel="next" title="LV16-12-GPIO-03-GPIO实例">
                  LV16-12-GPIO-03-GPIO实例 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">苏木</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">3.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">225:26</span>
  </span>
</div>




    <span id="sitetime"></span>
    <script defer language=javascript>
        function siteTime()
        {
            window.setTimeout("siteTime()", 1000);
            var seconds = 1000;
            var minutes = seconds * 60;
            var hours = minutes * 60;
            var days = hours * 24;
            var years = days * 365;
            var today = new Date();
            var todayYear = today.getFullYear();
            var todayMonth = today.getMonth()+1;
            var todayDate = today.getDate();
            var todayHour = today.getHours();
            var todayMinute = today.getMinutes();
            var todaySecond = today.getSeconds();
            /*==================================================
            Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
            year        - 作为date对象的年份，为4位年份值
            month       - 0-11之间的整数，做为date对象的月份
            day         - 1-31之间的整数，做为date对象的天数
            hours       - 0(午夜24点)-23之间的整数，做为date对象的小时数
            minutes     - 0-59之间的整数，做为date对象的分钟数
            seconds     - 0-59之间的整数，做为date对象的秒数
            microseconds - 0-999之间的整数，做为date对象的毫秒数
            ==================================================*/
            var t1 = Date.UTC(2017, 
                              5, 
                              19, 
                              0, 
                              0, 
                              0); //北京时间
            var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
            var diff = t2-t1;
            var diffYears = Math.floor(diff/years);
            var diffDays = Math.floor((diff/days)-diffYears*365);
            var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
            var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
            var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
            document.getElementById("sitetime").innerHTML="已在这里 "+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
        }
        siteTime();
    </script>



    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


 
        <div id="click-show-text"
            data-mobile = false
            data-text = 富强,民主,文明,和谐,自由,平等,公正,法制,爱国,敬业,诚信,友善
            data-fontsize = 15px
            data-random= false>
        </div>
       

      
        <script async src=https://cdn.jsdelivr.net/npm/hexo-next-mouse-effect@latest/click/showText.js></script>
      

      
    




    <script async src="/js/fancybox_param.js"></script>





<!-- APlayer本体 -->



</body>
</html>
