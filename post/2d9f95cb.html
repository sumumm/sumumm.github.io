<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/green/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"sumumm.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":300},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="æ¥è¯¦ç»†äº†è§£ä¸‹I2Cçš„é©±åŠ¨æ¡†æ¶ã€‚è‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="LV08-01-I2Cå­ç³»ç»Ÿ-04-I2Cé©±åŠ¨æ¡†æ¶åˆ†æ">
<meta property="og:url" content="https://sumumm.github.io/post/2d9f95cb.html">
<meta property="og:site_name" content="è‹æœ¨">
<meta property="og:description" content="æ¥è¯¦ç»†äº†è§£ä¸‹I2Cçš„é©±åŠ¨æ¡†æ¶ã€‚è‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250328092854901.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330141349194.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330141544900.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330141610365.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329162411698.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329162949427.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330135916716.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330140012476.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330140511185.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330173825291.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330173931777.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330174321446.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330174422138.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250328113706039.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329105907331.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329110046602.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329110358912.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329110637057.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329110910312.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250328113804113.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/072_master_xfer_imx6ull.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330145705461.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330163641600.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330164220088.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330164312223.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330164613670.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330164711276.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/009_i2c_signal.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329131418887.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329140210360.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329135722971.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329140631954.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330170557596.png">
<meta property="og:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330170813059.png">
<meta property="article:published_time" content="2025-04-07T23:38:03.000Z">
<meta property="article:modified_time" content="2025-06-13T16:25:57.058Z">
<meta property="article:author" content="è‹æœ¨">
<meta property="article:tag" content="LV08-I2Cå­ç³»ç»Ÿ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250328092854901.png">


<link rel="canonical" href="https://sumumm.github.io/post/2d9f95cb.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":"","permalink":"https://sumumm.github.io/post/2d9f95cb.html","path":"post/2d9f95cb.html","title":"LV08-01-I2Cå­ç³»ç»Ÿ-04-I2Cé©±åŠ¨æ¡†æ¶åˆ†æ"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LV08-01-I2Cå­ç³»ç»Ÿ-04-I2Cé©±åŠ¨æ¡†æ¶åˆ†æ | è‹æœ¨</title>
  








    <script src="/js/browser_tools_disable.js"></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.com/hexo-next-tags-plus@latest/lib/tag_plus.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">è‹æœ¨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">æˆ‘çš„å­¦ä¹ ä¹‹è·¯</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>è‹æœ¨çš„å®¶</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»é¡µ<span class="badge">42</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£é¡µ<span class="badge">673</span></a></li><li class="menu-item menu-item-flink"><a href="/flink/" rel="section"><i class="fa fa-link fa-fw"></i>å‹äººå¸</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äºæˆ‘</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81I2C%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90"><span class="nav-text">ä¸€ã€I2Cè®¾å¤‡é©±åŠ¨åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%B3%A8%E5%86%8Ci2c-driver"><span class="nav-text">1. æ³¨å†Œi2c_driver</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%B3%A8%E5%86%8CI2C%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8"><span class="nav-text">1.1 æ³¨å†ŒI2Cè®¾å¤‡é©±åŠ¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E9%94%80%E6%AF%81I2C%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8"><span class="nav-text">1.2 é”€æ¯I2Cè®¾å¤‡é©±åŠ¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-i2c-driver%E7%BB%93%E6%9E%84%E4%BD%93%E6%B3%A8%E5%86%8C%E7%A4%BA%E4%BE%8B"><span class="nav-text">1.3Â i2c_driverç»“æ„ä½“æ³¨å†Œç¤ºä¾‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-i2c-driver%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6"><span class="nav-text">1.4 i2c_driveré©±åŠ¨æ¡†æ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-%E5%9C%A8sysfs%E4%B8%AD%E7%9A%84%E4%BD%93%E7%8E%B0"><span class="nav-text">1.5 åœ¨sysfsä¸­çš„ä½“ç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%B3%A8%E5%86%8Ci2c-client"><span class="nav-text">2. æ³¨å†Œi2c_client</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E6%96%B9%E5%BC%8F%E4%B8%80"><span class="nav-text">2.1 æ–¹å¼ä¸€</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-%E9%80%9A%E8%BF%87devicetree%E5%A3%B0%E6%98%8EI2C%E8%AE%BE%E5%A4%87"><span class="nav-text">2.1.1 é€šè¿‡devicetreeå£°æ˜I2Cè®¾å¤‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-%E6%A0%B9%E6%8D%AE%E6%80%BB%E7%BA%BF%E5%8F%B7%E5%A3%B0%E6%98%8EI2C%E8%AE%BE%E5%A4%87"><span class="nav-text">2.1.2 æ ¹æ®æ€»çº¿å·å£°æ˜I2Cè®¾å¤‡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9A%E6%98%BE%E5%BC%8F%E5%9C%B0%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%AE%BE%E5%A4%87"><span class="nav-text">2.2 æ–¹å¼äºŒï¼šæ˜¾å¼åœ°å®ä¾‹åŒ–è®¾å¤‡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-i2c-new-device"><span class="nav-text">2.2.1Â i2c_new_device()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-i2c-new-probed-device"><span class="nav-text">2.2.2Â i2c_new_probed_device()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E6%96%B9%E5%BC%8F%E4%B8%89%EF%BC%9A%E6%8E%A2%E6%B5%8B%E7%89%B9%E5%AE%9A%E8%AE%BE%E5%A4%87%E7%9A%84I2C%E6%80%BB%E7%BA%BF"><span class="nav-text">2.3 æ–¹å¼ä¸‰ï¼šæ¢æµ‹ç‰¹å®šè®¾å¤‡çš„I2Cæ€»çº¿</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E6%96%B9%E5%BC%8F%E5%9B%9B%EF%BC%9A%E4%BB%8E%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="nav-text">2.4 æ–¹å¼å››ï¼šä»ç”¨æˆ·ç©ºé—´å®ä¾‹åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-i2c-client%E8%AE%BE%E5%A4%87%E6%B3%A8%E5%86%8C%E7%A4%BA%E4%BE%8B"><span class="nav-text">2.5 i2c_clientè®¾å¤‡æ³¨å†Œç¤ºä¾‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-%E5%9C%A8sysfs%E4%B8%AD%E7%9A%84%E4%BD%93%E7%8E%B0"><span class="nav-text">2.6 åœ¨sysfsä¸­çš„ä½“ç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-I2C%E8%AE%BE%E5%A4%87%E5%92%8C%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%8C%B9%E9%85%8D"><span class="nav-text">3. I2Cè®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E8%AE%BE%E5%A4%87%E6%A0%91%E5%8C%B9%E9%85%8D%EF%BC%9Ai2c-of-match-device"><span class="nav-text">3.1 è®¾å¤‡æ ‘åŒ¹é…ï¼ši2c_of_match_device()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-id%E5%8C%B9%E9%85%8D%EF%BC%9Ai2c-match-id"><span class="nav-text">3.2 idåŒ¹é…ï¼ši2c_match_id()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-I2C%E8%AE%BE%E5%A4%87%E6%94%B6%E5%8F%91%E6%95%B0%E6%8D%AE"><span class="nav-text">4. I2Cè®¾å¤‡æ”¶å‘æ•°æ®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-i2c-transfer"><span class="nav-text">4.1Â i2c_transfer()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E6%94%B6%E5%8F%91%E7%A4%BA%E4%BE%8B"><span class="nav-text">4.2 æ”¶å‘ç¤ºä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-%E8%AE%BE%E5%A4%87%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">4.2.1 è®¾å¤‡ç»“æ„ä½“</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-xxx-read-regs"><span class="nav-text">4.2.2Â xxx_read_regs()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-3-xxx-write-regs"><span class="nav-text">4.2.3Â xxx_write_regs()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-ap3216c%E5%AE%9E%E4%BE%8B"><span class="nav-text">5. ap3216cå®ä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-demo%E6%BA%90%E7%A0%81"><span class="nav-text">5.1 demoæºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%BC%80%E5%8F%91%E6%9D%BF%E6%B5%8B%E8%AF%95"><span class="nav-text">5.2 å¼€å‘æ¿æµ‹è¯•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81I2C%E6%80%BB%E7%BA%BF%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90"><span class="nav-text">äºŒã€I2Cæ€»çº¿é©±åŠ¨åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-I-MX6U-I2C-%E7%AE%80%E4%BB%8B"><span class="nav-text">1.Â I.MX6U I2C ç®€ä»‹  </span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-I2Cx-IADR-x-1-4"><span class="nav-text">1.1Â I2Cx_IADR(x&#x3D;1~4)  </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-I2Cx-IFDR-x-1-4"><span class="nav-text">1.2Â I2Cx_IFDR  (x&#x3D;1~4)  </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-I2Cx-I2CR-x-1-4"><span class="nav-text">1.3Â I2Cx_I2CR    (x&#x3D;1~4)  </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-I2Cx-I2SR-x-1-4"><span class="nav-text">1.4Â I2Cx_I2SR   (x&#x3D;1~4)  </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-I2Cx-I2DR-x-1-4"><span class="nav-text">1.5Â I2Cx_I2DR     (x&#x3D;1~4)  </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-I2C1-%E6%8E%A7%E5%88%B6%E5%99%A8%E8%8A%82%E7%82%B9"><span class="nav-text">2.Â  I2C1 æ§åˆ¶å™¨èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-I2C%E9%80%82%E9%85%8D%E5%99%A8%E9%A9%B1%E5%8A%A8"><span class="nav-text">3. I2Cé€‚é…å™¨é©±åŠ¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-i2c-imx-driver-of-match-table"><span class="nav-text">3.1Â i2c_imx_driver.of_match_table</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-i2c-imx-driver-i2c-imx-probe"><span class="nav-text">3.2Â i2c_imx_driver. i2c_imx_probe</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-i2c-imx-algo"><span class="nav-text">3.3Â i2c_imx_algo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-i2c-adapter%E6%B3%A8%E5%86%8C-%E6%B3%A8%E9%94%80%E5%87%BD%E6%95%B0"><span class="nav-text">3.4Â i2c_adapteræ³¨å†Œ&#x2F;æ³¨é”€å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-1-i2c-add-adapter"><span class="nav-text">3.4.1Â i2c_add_adapter()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-2-i2c-add-numbered-adapter"><span class="nav-text">3.4.2Â i2c_add_numbered_adapter()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-3-i2c-del-adapter"><span class="nav-text">3.4.3Â i2c_del_adapter()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E8%99%9A%E6%8B%9F%E7%9A%84i2c-adapter"><span class="nav-text">4. ç¼–å†™ä¸€ä¸ªè™šæ‹Ÿçš„i2c_adapter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E8%AE%BE%E5%A4%87%E6%A0%91"><span class="nav-text">4.1 è®¾å¤‡æ ‘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E9%80%82%E9%85%8D%E5%99%A8%E7%9A%84%E9%A9%B1%E5%8A%A8"><span class="nav-text">4.2 é€‚é…å™¨çš„é©±åŠ¨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-%E8%A6%81%E5%81%9A%E5%93%AA%E4%BA%9B%EF%BC%9F"><span class="nav-text">4.2.1 è¦åšå“ªäº›ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-i2c-adapter%E6%A1%86%E6%9E%B6"><span class="nav-text">4.2.2Â i2c_adapteræ¡†æ¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-3-%E6%A8%A1%E6%8B%9FEEPROM"><span class="nav-text">4.2.3 æ¨¡æ‹ŸEEPROM</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E6%A8%A1%E6%8B%9FEEPROM-demo"><span class="nav-text">4.3 æ¨¡æ‹ŸEEPROM demo</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-1-demo%E6%BA%90%E7%A0%81"><span class="nav-text">4.3.1 demoæºç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-text">4.3.2 æµ‹è¯•ç»“æœ</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81GPIO%E6%A8%A1%E6%8B%9FI2C"><span class="nav-text">ä¸‰ã€GPIOæ¨¡æ‹ŸI2C</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-GPIO%E6%A8%A1%E6%8B%9FI2C%E7%AE%80%E4%BB%8B"><span class="nav-text">1. GPIOæ¨¡æ‹ŸI2Cç®€ä»‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-GPIO%E5%BC%95%E8%84%9A%E5%AE%9A%E4%B9%89"><span class="nav-text">2. GPIOå¼•è„šå®šä¹‰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-i2c-gpio%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6"><span class="nav-text">3. i2c-gpioåŸºæœ¬æ¡†æ¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%A8%A1%E6%8B%9FI2C%EF%BC%9F"><span class="nav-text">4. å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ¨¡æ‹ŸI2Cï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E9%A9%B1%E5%8A%A8%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6%E6%94%BE%E5%9C%A8%E9%82%A3%E9%87%8C%EF%BC%9F"><span class="nav-text">4.1 é©±åŠ¨ç›¸å…³æ–‡ä»¶æ”¾åœ¨é‚£é‡Œï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E4%BD%BF%E8%83%BD%E5%86%85%E6%A0%B8%E7%9A%84I2C-GPIO%E9%A9%B1%E5%8A%A8"><span class="nav-text">4.2 ä½¿èƒ½å†…æ ¸çš„I2C GPIOé©±åŠ¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E8%AE%BE%E5%A4%87%E6%A0%91%E9%85%8D%E7%BD%AE"><span class="nav-text">4.3 è®¾å¤‡æ ‘é…ç½®</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-1-%E6%A8%A1%E6%8B%9FI2C%E8%8A%82%E7%82%B9"><span class="nav-text">4.3.1 æ¨¡æ‹ŸI2CèŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-%E4%BF%AE%E6%94%B9aliases"><span class="nav-text">4.3.2 ä¿®æ”¹aliases</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-open-drain%E5%B1%9E%E6%80%A7"><span class="nav-text">4.3.3 open drainå±æ€§</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-4-%E6%B7%BB%E5%8A%A0i2c%E8%AE%BE%E5%A4%87"><span class="nav-text">4.3.4 æ·»åŠ i2cè®¾å¤‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-5-%E5%BC%80%E5%8F%91%E6%9D%BF%E6%B5%8B%E8%AF%95"><span class="nav-text">4.3.5 å¼€å‘æ¿æµ‹è¯•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-i2c-gpio%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90"><span class="nav-text">5. i2c-gpioé©±åŠ¨åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-i2c-gpio-driver-driver-of-match-table"><span class="nav-text">5.1Â i2c_gpio_driver.driver.of_match_table</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-i2c-gpio-driver-probe"><span class="nav-text">5.2Â i2c_gpio_driver.probe</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-1-%E8%A7%A3%E6%9E%90%E8%AE%BE%E5%A4%87%E6%A0%91"><span class="nav-text">5.2.1 è§£æè®¾å¤‡æ ‘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-2-%E6%B3%A8%E5%86%8C%E5%88%B0i2c-algo-bit-c"><span class="nav-text">5.2.2Â æ³¨å†Œåˆ°i2c-algo-bit.c</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-i2c-bit-algo"><span class="nav-text">5.3Â i2c_bit_algo</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-1-i2c-bit-algo-functionality"><span class="nav-text">5.3.1Â i2c_bit_algo.functionality</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-2-i2c-bit-algo-master-xfer"><span class="nav-text">5.3.2Â i2c_bit_algo.master_xfer</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-GPIO%E6%A8%A1%E6%8B%9FI2Cdemo"><span class="nav-text">6. GPIOæ¨¡æ‹ŸI2Cdemo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-demo%E6%BA%90%E7%A0%81"><span class="nav-text">6.1 demoæºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E5%BC%80%E5%8F%91%E6%9D%BF%E6%B5%8B%E8%AF%95"><span class="nav-text">6.2 å¼€å‘æ¿æµ‹è¯•</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="è‹æœ¨"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">è‹æœ¨</p>
  <div class="site-description" itemprop="description">è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">673</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/sumumm" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;sumumm" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sumumm.github.io/post/2d9f95cb.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="è‹æœ¨">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è‹æœ¨">
      <meta itemprop="description" content="è«é“æ¡‘æ¦†æ™šï¼Œä¸ºéœå°šæ»¡å¤©">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="LV08-01-I2Cå­ç³»ç»Ÿ-04-I2Cé©±åŠ¨æ¡†æ¶åˆ†æ | è‹æœ¨">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LV08-01-I2Cå­ç³»ç»Ÿ-04-I2Cé©±åŠ¨æ¡†æ¶åˆ†æ
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-04-08 07:38:03" itemprop="dateCreated datePublished" datetime="2025-04-08T07:38:03+08:00">2025-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">åµŒå…¥å¼å¼€å‘</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">02IMX6ULLå¹³å°</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">LV08-I2Cå­ç³»ç»Ÿ</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>52 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>æ¥è¯¦ç»†äº†è§£ä¸‹I2Cçš„é©±åŠ¨æ¡†æ¶ã€‚è‹¥ç¬”è®°ä¸­æœ‰é”™è¯¯æˆ–è€…ä¸åˆé€‚çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ğŸ˜ƒã€‚</p>
<span id="more"></span>

<!-- Photo: https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/ -->

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ä½¿ç”¨å·¥å…·åŠç‰ˆæœ¬ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center" rowspan="5">PCç«¯å¼€å‘ç¯å¢ƒ</td>        <td align="center" width=150px>Windows</td>        <td align="left">Windows11</td>    </tr>    <tr>        <td align="center">Ubuntu</td>        <td align="left">Ubuntu20.04.2çš„64ä½ç‰ˆæœ¬</td>      </tr>    <tr>        <td align="center">VMwareÂ® Workstation 17 Pro</td>        <td align="left">17.6.0 build-24238078</td>      </tr>    <tr>        <td align="center">ç»ˆç«¯è½¯ä»¶</td>        <td align="left">MobaXterm(Professional Edition v23.0 Build 5042 (license))</td>    </tr>    <tr>        <td align="center">Win32DiskImager</td>        <td align="left">Win32DiskImager v1.0</td>      </tr>    <tr>        <td align="center" rowspan="3">Linuxå¼€å‘æ¿ç¯å¢ƒ</td>        <td align="center">Linuxå¼€å‘æ¿</td>        <td align="left">æ­£ç‚¹åŸå­ i.MX6ULL Linux é˜¿å°”æ³•å¼€å‘æ¿</td>      </tr>    <tr>        <td align="center">uboot</td>        <td align="left">NXPå®˜æ–¹æä¾›çš„ubootï¼Œä½¿ç”¨çš„ubootç‰ˆæœ¬ä¸ºU-Boot 2019.04</td>      </tr>    <tr>        <td align="center">linuxå†…æ ¸</td>        <td align="left">linux-4.19.71(NXPå®˜æ–¹æä¾›)</td>      </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹æœ¬æ–‡å‚è€ƒèµ„æ–™ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center">åˆ†ç±»</td>        <td align="center">ç½‘å€</td>        <td align="center">è¯´æ˜</td>    </tr>    <tr>        <td align="center" rowspan="5">å®˜æ–¹ç½‘ç«™</td>        <td align="left"><a href="https://www.arm.com/" target="_blank">https://www.arm.com/</a></td>        <td align="left">ARMå®˜æ–¹ç½‘ç«™ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°Cotex-Mxä»¥åŠARMVxçš„ä¸€äº›æ–‡æ¡£</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxp.com.cn/" target="_blank">https://www.nxp.com.cn/ </a></td>        <td align="left">NXPå®˜æ–¹ç½‘ç«™</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxpic.org.cn/" target="_blank">https://www.nxpic.org.cn/</a></td><td align="left">NXP å®˜æ–¹ç¤¾åŒº</td>    </tr>    <tr>        <td align="left"><a href="https://u-boot.readthedocs.io/en/latest/" target="_blank">https://u-boot.readthedocs.io/en/latest/</a></td><td align="left">u-bootå®˜ç½‘</td>    </tr>    <tr>        <td align="left"><a href="https://www.kernel.org/" target="_blank">https://www.kernel.org/</a></td><td align="left">linuxå†…æ ¸å®˜ç½‘</td>    </tr></table>
              </div>
            </details>

<details class="folding-tag" blue><summary> ç‚¹å‡»æŸ¥çœ‹ç›¸å…³æ–‡ä»¶ä¸‹è½½ </summary>
              <div class='content'>
              <table>    <tr>        <td align="center">åˆ†ç±»</td>        <td align="center">ç½‘å€</td>        <td align="center">è¯´æ˜</td>    </tr>    <tr>        <td align="center" rowspan="3">NXP</td>        <td align="left"><a href="https://github.com/nxp-imx" target="_blank">https://github.com/nxp-imx</a></td>        <td align="left">NXP imxå¼€å‘èµ„æºGitHubç»„ç»‡ï¼Œé‡Œè¾¹ä¼šæœ‰u-bootå’Œlinuxå†…æ ¸çš„ä»“åº“</td>    </tr>    <tr>        <td align="left"><a href="https://github.com/nxp-imx/linux-imx/releases/tag/v4.19.71" target="_blank">nxp-imx/linux-imx/releases/tag/v4.19.71</a></td>        <td align="left">NXP linuxå†…æ ¸ä»“åº“tagsä¸­çš„v4.19.71</td>    </tr>    <tr>        <td align="left"><a href="https://github.com/nxp-imx/uboot-imx/releases/tag/rel_imx_4.19.35_1.1.0" target="_blank">nxp-imx/uboot-imx/releases/tag/rel_imx_4.19.35_1.1.0</a></td>        <td align="left">NXP u-bootä»“åº“tagsä¸­çš„rel_imx_4.19.35_1.1.0</td>    </tr>    <tr>        <td align="center" rowspan="2">I.MX6ULL</td>        <td align="left"><a href="https://www.nxp.com.cn/docs/en/data-sheet/IMX6ULLIEC.pdf" target="_blank">i.MX 6ULL Applications Processors for Industrial Products</a></td>        <td align="left">I.MX6ULL èŠ¯ç‰‡æ‰‹å†Œï¼ˆdatasheetï¼Œå¯ä»¥åœ¨çº¿æŸ¥çœ‹ï¼‰</td>    </tr>    <tr>        <td align="left"><a href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh" target="_blank">i.MX 6ULL Applications ProcessorReference Manual</a></td>        <td align="left">I.MX6ULL å‚è€ƒæ‰‹å†Œï¼ˆä¸‹è½½åæ‰èƒ½æŸ¥çœ‹ï¼Œéœ€è¦ç™»å½•NXPå®˜ç½‘ï¼‰</td>    </tr>    <tr>        <td align="center" rowspan="3">Source Code</td>        <td align="left"><a href="https://elixir.bootlin.com/linux/latest/source" target="_blank">https://elixir.bootlin.com/linux/latest/source</a></td>        <td align="left">linux kernelæºç </td>    </tr>    <tr>        <td align="left"><a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/?h=v4.19.71&id=e7d2672c66e4d3675570369bf20856296da312c4" target="_blank">kernel/git/stable/linux.git - Linux kernel stable tree</a></td>        <td align="left">linux kernelæºç (å®˜ç½‘,tag 4.19.71)</td>    </tr>    <tr>        <td align="left"><a href="https://elixir.bootlin.com/u-boot/latest/source" target="_blank">https://elixir.bootlin.com/u-boot/latest/source</a></td>        <td align="left">ubootæºç </td>    </tr></table>
              </div>
            </details>

<h1 id="ä¸€ã€I2Cè®¾å¤‡é©±åŠ¨åˆ†æ"><a href="#ä¸€ã€I2Cè®¾å¤‡é©±åŠ¨åˆ†æ" class="headerlink" title="ä¸€ã€I2Cè®¾å¤‡é©±åŠ¨åˆ†æ"></a><font size=3>ä¸€ã€I2Cè®¾å¤‡é©±åŠ¨åˆ†æ</font></h1><h2 id="1-æ³¨å†Œi2c-driver"><a href="#1-æ³¨å†Œi2c-driver" class="headerlink" title="1. æ³¨å†Œi2c_driver"></a><font size=3>1. æ³¨å†Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L231">i2c_driver</a></font></h2><h3 id="1-1-æ³¨å†ŒI2Cè®¾å¤‡é©±åŠ¨"><a href="#1-1-æ³¨å†ŒI2Cè®¾å¤‡é©±åŠ¨" class="headerlink" title="1.1 æ³¨å†ŒI2Cè®¾å¤‡é©±åŠ¨"></a><font size=3>1.1 æ³¨å†ŒI2Cè®¾å¤‡é©±åŠ¨</font></h3><p>å¯¹äºæˆ‘ä»¬ I2C è®¾å¤‡é©±åŠ¨ç¼–å†™äººæ¥è¯´ï¼Œé‡ç‚¹å·¥ä½œå°±æ˜¯åˆ›å»º <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L231">i2c_driver</a>ï¼Œåˆ›å»ºå®Œæˆä»¥åéœ€è¦å‘Linux å†…æ ¸æ³¨å†Œè¿™ä¸ª i2c_driverã€‚i2c_driver æ³¨å†Œå‡½æ•°ä¸º <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1605">i2c_register_driver()</a> ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_register_driver</span><span class="params">(<span class="keyword">struct</span> module *owner, <span class="keyword">struct</span> i2c_driver *driver)</span>;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­owner ä¸€èˆ¬ä¸º THIS_MODULEï¼Œdriveræ˜¯è¦æ³¨å†Œçš„ i2c_driverã€‚è¿”å›å€¼ï¼š 0ï¼ŒæˆåŠŸï¼›è´Ÿå€¼ï¼Œå¤±è´¥ã€‚</p>
<p>å¦å¤– <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L804">i2c_add_driver()</a> ä¹Ÿå¸¸å¸¸ç”¨äºæ³¨å†Œ i2c_driverï¼Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L804">i2c_add_driver()</a> æ˜¯ä¸€ä¸ªå®ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* use a define to avoid include chaining to get THIS_MODULE */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> i2c_add_driver(driver) \</span></span><br><span class="line"><span class="meta">	i2c_register_driver(THIS_MODULE, driver)</span></span><br></pre></td></tr></table></figure>

<p>å…¶å®i2c_add_driver å°±æ˜¯å¯¹ i2c_register_driver åšäº†ä¸€ä¸ªç®€å•çš„å°è£…ï¼Œåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯è¦æ³¨å†Œçš„ i2c_driverã€‚  </p>
<h3 id="1-2-é”€æ¯I2Cè®¾å¤‡é©±åŠ¨"><a href="#1-2-é”€æ¯I2Cè®¾å¤‡é©±åŠ¨" class="headerlink" title="1.2 é”€æ¯I2Cè®¾å¤‡é©±åŠ¨"></a><font size=3>1.2 é”€æ¯I2Cè®¾å¤‡é©±åŠ¨</font></h3><p>æ³¨é”€ I2C è®¾å¤‡é©±åŠ¨çš„æ—¶å€™éœ€è¦å°†å‰é¢æ³¨å†Œçš„ i2c_driver ä» Linux å†…æ ¸ä¸­æ³¨é”€æ‰ï¼Œéœ€è¦ç”¨åˆ°<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1641">i2c_del_driver()</a> å‡½æ•° :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">i2c_del_driver</span><span class="params">(<span class="keyword">struct</span> i2c_driver *driver)</span></span><br><span class="line">&#123;</span><br><span class="line">	i2c_for_each_dev(driver, __process_removed_driver);</span><br><span class="line"></span><br><span class="line">	driver_unregister(&amp;driver-&gt;driver);</span><br><span class="line">	pr_debug(<span class="string">&quot;driver [%s] unregistered\n&quot;</span>, driver-&gt;driver.name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-i2c-driverç»“æ„ä½“æ³¨å†Œç¤ºä¾‹"><a href="#1-3-i2c-driverç»“æ„ä½“æ³¨å†Œç¤ºä¾‹" class="headerlink" title="1.3Â i2c_driverç»“æ„ä½“æ³¨å†Œç¤ºä¾‹"></a><font size=3>1.3Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L231">i2c_driver</a>ç»“æ„ä½“æ³¨å†Œç¤ºä¾‹</font></h3><p>åˆ†é…ã€è®¾ç½®ã€æ³¨å†Œä¸€ä¸ªi2c_driverç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä¼ ç»ŸåŒ¹é…æ–¹å¼ ID åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">ap3216c_id</span>[] =</span> &#123;</span><br><span class="line">	&#123;<span class="string">&quot;alpha,ap3216c&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">	&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾å¤‡æ ‘åŒ¹é…åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">ap3216c_of_match</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;alpha,ap3216c&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="comment">/* Sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* i2c é©±åŠ¨ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">ap3216c_driver</span> =</span> &#123;</span><br><span class="line">    .probe = ap3216c_probe,       <span class="comment">// æ‰¾åˆ°å¯ä»¥æ”¯æŒçš„è®¾å¤‡åï¼Œå°†ä¼šè°ƒç”¨è¯¥å‡½æ•°</span></span><br><span class="line">    .remove = ap3216c_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .name = <span class="string">&quot;ap3216c&quot;</span>,</span><br><span class="line">        .of_match_table = ap3216c_of_match, <span class="comment">// å¯ä»¥æ”¯æŒå“ªäº›è®¾å¤‡ï¼ˆä¸»è¦ç”¨æ¥åˆ¤æ–­è®¾å¤‡æ ‘ä¸­çš„I2Cè®¾å¤‡ï¼‰</span></span><br><span class="line">    &#125;,</span><br><span class="line">    .id_table = ap3216c_id,                 <span class="comment">// å¯ä»¥æ”¯æŒå“ªäº›è®¾å¤‡ï¼Œç”¨ä¸idåŒ¹é…</span></span><br><span class="line">&#125;;  </span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨åœ¨ap3216c_probeå‡½æ•°ä¸­ï¼Œåˆ†é…ã€è®¾ç½®ã€æ³¨å†Œfile_operationsç»“æ„ä½“ã€‚åœ¨file_operationsçš„å‡½æ•°ä¸­ï¼Œä½¿ç”¨i2c_transferç­‰å‡½æ•°å‘èµ·I2Cä¼ è¾“ã€‚</p>
<h3 id="1-4-i2c-driveré©±åŠ¨æ¡†æ¶"><a href="#1-4-i2c-driveré©±åŠ¨æ¡†æ¶" class="headerlink" title="1.4 i2c_driveré©±åŠ¨æ¡†æ¶"></a><font size=3>1.4 i2c_driveré©±åŠ¨æ¡†æ¶</font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ï¼ˆ1ï¼‰ç¬¬ä¸€éƒ¨åˆ† å®ç°è®¾å¤‡çš„è¯»ã€å†™ å’Œåˆå§‹åŒ–ç­‰ç›¸å…³åŠŸèƒ½</span></span><br><span class="line"><span class="comment">//å®ç°i2cæ€»çº¿è®¾å¤‡ç»“æ„ä½“ä¸­å®šä¹‰çš„æ“ä½œå‡½æ•°ï¼Œä¸»è¦æ˜¯.probeåŒ¹é…å‡½æ•°ï¼Œåœ¨.probeå‡½æ•°ä¸­æ·»åŠ ã€æ³¨å†Œä¸€ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œè¿™ä¸ªå­—ç¬¦è®¾å¤‡ç”¨äºå®ç°i2cè®¾å¤‡çš„å…·ä½“åŠŸèƒ½ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">i2c_write_dev_xxx</span><span class="params">(<span class="keyword">struct</span> i2c_client *mpu6050_client, u8 address, u8 data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">i2c_read_dev_xxx</span><span class="params">(<span class="keyword">struct</span> i2c_client *mpu6050_client, u8 address, <span class="type">void</span> *data, u32 length)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dev_xxx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ï¼ˆ2ï¼‰ç¬¬äºŒéƒ¨åˆ† å®ç°å­—ç¬¦è®¾å¤‡æ“ä½œå‡½æ•°é›†</span></span><br><span class="line"><span class="comment">/*å­—ç¬¦è®¾å¤‡æ“ä½œå‡½æ•°é›†ï¼Œopenå‡½æ•°å®ç°*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dev_xxx_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*å­—ç¬¦è®¾å¤‡æ“ä½œå‡½æ•°é›†ï¼Œ.readå‡½æ•°å®ç°*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">dev_xxx_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *off)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*å­—ç¬¦è®¾å¤‡æ“ä½œå‡½æ•°é›†ï¼Œ.releaseå‡½æ•°å®ç°*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dev_xxx_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*å­—ç¬¦è®¾å¤‡æ“ä½œå‡½æ•°é›†*/</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">mpu6050_chr_dev_fops</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">            .owner = THIS_MODULE,</span><br><span class="line">            .open = dev_xxx_open,</span><br><span class="line">            .read = dev_xxx_read,</span><br><span class="line">            .release = dev_xxx_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ï¼ˆ3ï¼‰ ç¬¬ä¸‰éƒ¨åˆ† .probeå‡½æ•°å’Œ.removeå‡½æ•°å®ç°</span></span><br><span class="line"><span class="comment">/* i2c é©±åŠ¨çš„ probe å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_probe</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* å‡½æ•°å…·ä½“ç¨‹åº */</span></span><br><span class="line">    <span class="comment">/* 1ã€æ„å»ºè®¾å¤‡å· */</span></span><br><span class="line">    <span class="comment">/* 2ã€æ³¨å†Œè®¾å¤‡ */</span></span><br><span class="line">    <span class="comment">/* 3ã€åˆ›å»ºç±» */</span></span><br><span class="line">    <span class="comment">/* 4ã€åˆ›å»ºè®¾å¤‡ */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* i2c é©±åŠ¨çš„ remove å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_remove</span><span class="params">(<span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* å‡½æ•°å…·ä½“ç¨‹åº */</span></span><br><span class="line">    <span class="comment">/* åˆ é™¤è®¾å¤‡ */</span></span><br><span class="line">    <span class="comment">/* æ³¨é”€æ‰ç±»å’Œè®¾å¤‡ */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ï¼ˆ4ï¼‰ç¬¬å››éƒ¨åˆ† é©±åŠ¨å…¥å£å’Œå‡ºå£å‡½æ•°å®ç°</span></span><br><span class="line"><span class="comment">/* ä¼ ç»ŸåŒ¹é…æ–¹å¼ ID åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">xxx_id</span>[] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;xxx&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾å¤‡æ ‘åŒ¹é…åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">xxx_of_match</span>[] =</span> &#123;</span><br><span class="line">    &#123; .compatible = <span class="string">&quot;xxx&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="comment">/* Sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* i2c é©±åŠ¨ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">xxx_driver</span> =</span> &#123;</span><br><span class="line">    .probe = xxx_probe,</span><br><span class="line">    .remove = xxx_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .name = <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">        .of_match_table = xxx_of_match,</span><br><span class="line">    &#125;,</span><br><span class="line">    .id_table = xxx_id,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ret = i2c_add_driver(&amp;xxx_driver);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å‡ºå£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">xxx_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	i2c_del_driver(&amp;xxx_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(xxx_init);</span><br><span class="line">module_exit(xxx_exit);</span><br></pre></td></tr></table></figure>

<h3 id="1-5-åœ¨sysfsä¸­çš„ä½“ç°"><a href="#1-5-åœ¨sysfsä¸­çš„ä½“ç°" class="headerlink" title="1.5 åœ¨sysfsä¸­çš„ä½“ç°"></a><font size=3>1.5 åœ¨sysfsä¸­çš„ä½“ç°</font></h3><p>å½“æˆ‘ä»¬åŠ è½½äº†i2cè®¾å¤‡é©±åŠ¨åï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ª <code>/sys/bus/i2c/drivers/</code>ç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸‹å­˜æ”¾ç€æ‰€æœ‰çš„i2cé©±åŠ¨ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250328092854901.png" alt="image-20250328092854901"  />

<h2 id="2-æ³¨å†Œi2c-client"><a href="#2-æ³¨å†Œi2c-client" class="headerlink" title="2. æ³¨å†Œi2c_client"></a><font size=3>2. æ³¨å†Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L309">i2c_client</a></font></h2><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L309">i2c_client</a>è¡¨ç¤ºä¸€ä¸ªI2Cè®¾å¤‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆæ³¨å†Œä¸€ä¸ª <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L309">i2c_client</a>?è¿™éƒ¨åˆ†å¯ä»¥çœ‹<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/Documentation/i2c/instantiating-devices">instantiating-devices - Documentation&#x2F;i2c&#x2F;instantiating-devices</a></p>
<h3 id="2-1-æ–¹å¼ä¸€"><a href="#2-1-æ–¹å¼ä¸€" class="headerlink" title="2.1 æ–¹å¼ä¸€"></a><font size=3>2.1 æ–¹å¼ä¸€</font></h3><h4 id="2-1-1-é€šè¿‡devicetreeå£°æ˜I2Cè®¾å¤‡"><a href="#2-1-1-é€šè¿‡devicetreeå£°æ˜I2Cè®¾å¤‡" class="headerlink" title="2.1.1 é€šè¿‡devicetreeå£°æ˜I2Cè®¾å¤‡"></a><font size=3>2.1.1 é€šè¿‡devicetreeå£°æ˜I2Cè®¾å¤‡</font></h4><p>ä½¿ç”¨è®¾å¤‡æ ‘çš„æ—¶å€™ I2C è®¾å¤‡ä¿¡æ¯é€šè¿‡åˆ›å»ºç›¸åº”çš„èŠ‚ç‚¹å°±è¡Œäº†ï¼Œæ¯”å¦‚ NXP å®˜æ–¹çš„ EVK å¼€å‘æ¿åœ¨ I2C1 ä¸Šæ¥äº† mag3110 è¿™ä¸ªç£åŠ›è®¡èŠ¯ç‰‡ï¼Œå› æ­¤å¿…é¡»åœ¨ i2c1 èŠ‚ç‚¹ä¸‹åˆ›å»º mag3110 å­èŠ‚ç‚¹ï¼Œç„¶ååœ¨è¿™ä¸ªå­èŠ‚ç‚¹å†…æè¿° mag3110 è¿™ä¸ªèŠ¯ç‰‡çš„ç›¸å…³ä¿¡æ¯ã€‚æˆ‘ä»¬æ‰“å¼€<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/arch/arm/boot/dts/imx6ul-14x14-evk.dtsi#L136">imx6ul-14x14-evk.dtsi</a>  ï¼Œæ‰¾åˆ°ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c1 &#123;</span><br><span class="line">	clock-frequency = &lt;<span class="number">100000</span>&gt;;</span><br><span class="line">	pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">	pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_i2c1&gt;;</span><br><span class="line">	status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">	mag3110@e &#123;</span><br><span class="line">		compatible = <span class="string">&quot;fsl,mag3110&quot;</span>;</span><br><span class="line">		reg = &lt;<span class="number">0x0e</span>&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 7~11 è¡Œï¼Œå‘ i2c1 æ·»åŠ  mag3110 å­èŠ‚ç‚¹ï¼Œç¬¬ 7 è¡Œâ€œmag3110@0eâ€æ˜¯å­èŠ‚ç‚¹åå­—ï¼Œâ€œ@â€åé¢çš„â€œ0eâ€å°±æ˜¯ mag3110 çš„ I2C å™¨ä»¶åœ°å€ã€‚ç¬¬ 8 è¡Œè®¾ç½® compatible å±æ€§å€¼ä¸ºâ€œfsl,mag3110â€ã€‚ç¬¬ 9 è¡Œçš„ reg å±æ€§ä¹Ÿæ˜¯è®¾ç½® mag3110 çš„å™¨ä»¶åœ°å€çš„ï¼Œå› æ­¤å€¼ä¸º 0x0eã€‚ </p>
<p>I2C è®¾å¤‡èŠ‚ç‚¹çš„<strong>åˆ›å»ºé‡ç‚¹æ˜¯ compatible å±æ€§å’Œ reg å±æ€§çš„è®¾ç½®ï¼Œä¸€ä¸ªç”¨äºåŒ¹é…é©±åŠ¨ï¼Œä¸€ä¸ªç”¨äºè®¾ç½®å™¨ä»¶åœ°å€ã€‚</strong></p>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">i2c1: i2c@<span class="number">400</span>a0000 &#123;</span><br><span class="line">	<span class="comment">/* ... master properties skipped ... */</span></span><br><span class="line">	clock-frequency = &lt;<span class="number">100000</span>&gt;;</span><br><span class="line"></span><br><span class="line">	flash@<span class="number">50</span> &#123;</span><br><span class="line">		compatible = <span class="string">&quot;atmel,24c256&quot;</span>;</span><br><span class="line">		reg = &lt;<span class="number">0x50</span>&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	pca9532: gpio@<span class="number">60</span> &#123;</span><br><span class="line">		compatible = <span class="string">&quot;nxp,pca9532&quot;</span>;</span><br><span class="line">		gpio-controller;</span><br><span class="line">		<span class="meta">#gpio-cells = <span class="string">&lt;2&gt;</span>;</span></span><br><span class="line">		reg = &lt;<span class="number">0x60</span>&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-2-æ ¹æ®æ€»çº¿å·å£°æ˜I2Cè®¾å¤‡"><a href="#2-1-2-æ ¹æ®æ€»çº¿å·å£°æ˜I2Cè®¾å¤‡" class="headerlink" title="2.1.2 æ ¹æ®æ€»çº¿å·å£°æ˜I2Cè®¾å¤‡"></a><font size=3>2.1.2 æ ¹æ®æ€»çº¿å·å£°æ˜I2Cè®¾å¤‡</font></h4><p>é¦–å…ˆè‚¯å®šè¦æè¿° I2C è®¾å¤‡èŠ‚ç‚¹ä¿¡æ¯ï¼Œåœ¨æœªä½¿ç”¨è®¾å¤‡æ ‘çš„æ—¶å€™éœ€è¦åœ¨ BSP é‡Œé¢ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L390">struct i2c_board_info</a> ç»“æ„ä½“æ¥æè¿°ä¸€ä¸ªå…·ä½“çš„ I2C è®¾å¤‡ã€‚   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_board_info</span> &#123;</span></span><br><span class="line">	<span class="type">char</span>		type[I2C_NAME_SIZE]; <span class="comment">/* I2C è®¾å¤‡åå­— */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>	flags; <span class="comment">/* æ ‡å¿— */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>	addr;  <span class="comment">/* I2C å™¨ä»¶åœ°å€ */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>	*dev_name;</span><br><span class="line">	<span class="type">void</span>		*platform_data;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_node</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span> *<span class="title">fwnode</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">property_entry</span> *<span class="title">properties</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">resources</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>	num_resources;</span><br><span class="line">	<span class="type">int</span>		irq;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>type å’Œ addr è¿™ä¸¤ä¸ªæˆå‘˜å˜é‡æ˜¯å¿…é¡»è¦è®¾ç½®çš„ï¼Œä¸€ä¸ªæ˜¯ I2C è®¾å¤‡çš„åå­—ï¼Œä¸€ä¸ªæ˜¯ I2C è®¾å¤‡çš„å™¨ä»¶åœ°å€ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/arch/arm/mach-imx/mach-pcm037.c#L271">mach-pcm037.c</a>è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå°±æœ‰è¿™ç§ç”¨æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_board_info</span> <span class="title">pcm037_i2c_devices</span>[] =</span> &#123;</span><br><span class="line">	&#123;</span><br><span class="line">		I2C_BOARD_INFO(<span class="string">&quot;24c32&quot;</span>, <span class="number">0x52</span>), <span class="comment">/* E0=0, E1=1, E2=0 */</span></span><br><span class="line">		.properties = board_eeprom_properties,</span><br><span class="line">	&#125;, &#123;</span><br><span class="line">		I2C_BOARD_INFO(<span class="string">&quot;pcf8563&quot;</span>, <span class="number">0x51</span>),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸­ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L429">I2C_BOARD_INFO</a> æ¥å®Œæˆ pcm037_i2c_devices çš„åˆå§‹åŒ–å·¥ä½œï¼Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L429">I2C_BOARD_INFO</a> æ˜¯ä¸€ä¸ªå®ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> I2C_BOARD_INFO(dev_type, dev_addr) \</span></span><br><span class="line"><span class="meta">	.type = dev_type, .addr = (dev_addr)</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œ I2C_BOARD_INFO å®å…¶å®å°±æ˜¯è®¾ç½® i2c_board_info çš„ type å’Œ addr è¿™ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œå› æ­¤å‰é¢çš„ä¸»è¦å·¥ä½œå°±æ˜¯è®¾ç½® I2C è®¾å¤‡åå­—ä¸º 24c32ï¼Œ 24c32çš„å™¨ä»¶åœ°å€ä¸º 0X52ã€‚å¯ä»¥åœ¨ Linux æºç é‡Œé¢å…¨å±€æœç´¢ i2c_board_infoï¼Œä¼šæ‰¾åˆ°å¤§é‡ä»¥ i2c_board_info å®šä¹‰çš„I2C è®¾å¤‡ä¿¡æ¯ï¼Œè¿™äº›å°±æ˜¯æœªä½¿ç”¨è®¾å¤‡æ ‘çš„æ—¶å€™ I2C è®¾å¤‡çš„æè¿°æ–¹å¼ï¼Œå½“é‡‡ç”¨äº†è®¾å¤‡æ ‘ä»¥åå°±ä¸ä¼šå†ä½¿ç”¨ i2c_board_info æ¥æè¿° I2C è®¾å¤‡äº†ã€‚  </p>
<p>ä¸Šé¢çš„å˜é‡åªæ˜¯å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç„¶åéœ€è¦é€šè¿‡<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-boardinfo.c#L38">i2c_register_board_info()</a>å‡½æ•°åˆ›å»ºä¸€ä¸ªi2cè®¾å¤‡ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_register_board_info</span><span class="params">(<span class="type">int</span> busnum, <span class="keyword">struct</span> i2c_board_info <span class="type">const</span> *info, <span class="type">unsigned</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __init <span class="title function_">omap_h4_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	(...)</span><br><span class="line">	i2c_register_board_info(<span class="number">1</span>, h4_i2c_board_info,</span><br><span class="line">			ARRAY_SIZE(h4_i2c_board_info));</span><br><span class="line">	(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-æ–¹å¼äºŒï¼šæ˜¾å¼åœ°å®ä¾‹åŒ–è®¾å¤‡"><a href="#2-2-æ–¹å¼äºŒï¼šæ˜¾å¼åœ°å®ä¾‹åŒ–è®¾å¤‡" class="headerlink" title="2.2 æ–¹å¼äºŒï¼šæ˜¾å¼åœ°å®ä¾‹åŒ–è®¾å¤‡"></a><font size=3>2.2 æ–¹å¼äºŒï¼šæ˜¾å¼åœ°å®ä¾‹åŒ–è®¾å¤‡</font></h3><p>æœ‰æ—¶å€™æ— æ³•çŸ¥é“è¯¥è®¾å¤‡æŒ‚è½½å“ªä¸ªI2C busä¸‹ï¼Œæ— æ³•çŸ¥é“å®ƒå¯¹åº”çš„I2C bus numberã€‚ä½†æ˜¯å¯ä»¥é€šè¿‡å…¶ä»–æ–¹æ³•çŸ¥é“å¯¹åº”çš„i2c_adapterç»“æ„ä½“ã€‚å¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ä¸ªå‡½æ•°æ¥åˆ›å»ºi2c_clientã€‚</p>
<h4 id="2-2-1-i2c-new-device"><a href="#2-2-1-i2c-new-device" class="headerlink" title="2.2.1Â i2c_new_device()"></a><font size=3>2.2.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L716">i2c_new_device()</a></font></h4><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L716">i2c_new_device()</a>å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> i2c_client *</span><br><span class="line"><span class="title function_">i2c_new_device</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap, <span class="keyword">struct</span> i2c_board_info <span class="type">const</span> *info)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(i2c_new_device);</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L716">i2c_new_device()</a>å‡½æ•°ä¼šåˆ›å»ºi2c_clientï¼Œå³ä½¿è¯¥è®¾å¤‡å¹¶ä¸å­˜åœ¨ã€‚è¿™é‡Œå°±ä¸è¯¦ç»†åˆ†æè¿™ä¸ªå‡½æ•°äº†ï¼Œäº†è§£ä¸€ä¸‹ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_board_info</span> <span class="title">sfe4001_hwmon_info</span> =</span> &#123;</span><br><span class="line">	I2C_BOARD_INFO(<span class="string">&quot;max6647&quot;</span>, <span class="number">0x4e</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sfe4001_init</span><span class="params">(<span class="keyword">struct</span> efx_nic *efx)</span></span><br><span class="line">&#123;</span><br><span class="line">	(...)</span><br><span class="line">	efx-&gt;board_info.hwmon_client =</span><br><span class="line">		i2c_new_device(&amp;efx-&gt;i2c_adap, &amp;sfe4001_hwmon_info);</span><br><span class="line"></span><br><span class="line">	(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-i2c-new-probed-device"><a href="#2-2-2-i2c-new-probed-device" class="headerlink" title="2.2.2Â i2c_new_probed_device()"></a><font size=3>2.2.2Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L2199">i2c_new_probed_device()</a></font></h4><p>è¿˜å¯ä»¥ä½¿ç”¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L2199">i2c_new_probed_device()</a>å‡½æ•°ï¼Œå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> i2c_client *</span><br><span class="line"><span class="title function_">i2c_new_probed_device</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap,</span></span><br><span class="line"><span class="params">		      <span class="keyword">struct</span> i2c_board_info *info,</span></span><br><span class="line"><span class="params">		      <span class="type">unsigned</span> <span class="type">short</span> <span class="type">const</span> *addr_list,</span></span><br><span class="line"><span class="params">		      <span class="type">int</span> (*probe)(<span class="keyword">struct</span> i2c_adapter *, <span class="type">unsigned</span> <span class="type">short</span> addr))</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(i2c_new_probed_device);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°æˆåŠŸçš„è¯ï¼Œä¼šåˆ›å»ºi2c_clientï¼Œå¹¶ä¸”è¡¨ç¤ºè¿™ä¸ªè®¾å¤‡è‚¯å®šå­˜åœ¨ã€‚I2Cè®¾å¤‡çš„åœ°å€å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œæ¯”å¦‚AT24C02çš„å¼•è„šA2A1A0ç”µå¹³ä¸ä¸€æ ·æ—¶ï¼Œè®¾å¤‡åœ°å€å°±ä¸ä¸€æ ·ã€‚å®ƒå¯ä»¥ç½—åˆ—å‡ºå¯èƒ½çš„åœ°å€ï¼Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L2199">i2c_new_probed_device()</a>å°†ä¼šä½¿ç”¨è¿™äº›åœ°å€åˆ¤æ–­è®¾å¤‡æ˜¯å¦å­˜åœ¨ã€‚è¿™é‡Œä¹Ÿæ˜¯ç®€å•äº†è§£ä¸‹ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> normal_i2c[] = &#123; <span class="number">0x2c</span>, <span class="number">0x2d</span>, I2C_CLIENT_END &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">usb_hcd_nxp_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">	(...)</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2c_adapter</span> *<span class="title">i2c_adap</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2c_board_info</span> <span class="title">i2c_info</span>;</span></span><br><span class="line"></span><br><span class="line">	(...)</span><br><span class="line">	i2c_adap = i2c_get_adapter(<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">memset</span>(&amp;i2c_info, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> i2c_board_info));</span><br><span class="line">	strlcpy(i2c_info.type, <span class="string">&quot;isp1301_nxp&quot;</span>, I2C_NAME_SIZE);</span><br><span class="line">	isp1301_i2c_client = i2c_new_probed_device(i2c_adap, &amp;i2c_info,</span><br><span class="line">						   normal_i2c, <span class="literal">NULL</span>);</span><br><span class="line">	i2c_put_adapter(i2c_adap);</span><br><span class="line">	(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-æ–¹å¼ä¸‰ï¼šæ¢æµ‹ç‰¹å®šè®¾å¤‡çš„I2Cæ€»çº¿"><a href="#2-3-æ–¹å¼ä¸‰ï¼šæ¢æµ‹ç‰¹å®šè®¾å¤‡çš„I2Cæ€»çº¿" class="headerlink" title="2.3 æ–¹å¼ä¸‰ï¼šæ¢æµ‹ç‰¹å®šè®¾å¤‡çš„I2Cæ€»çº¿"></a><font size=3>2.3 æ–¹å¼ä¸‰ï¼šæ¢æµ‹ç‰¹å®šè®¾å¤‡çš„I2Cæ€»çº¿</font></h3><p>ç”±i2c_driver.detectå‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„I2Cè®¾å¤‡å¹¶ç”Ÿæˆi2c_clientã€‚å¥½åƒä¸æ˜¯å¾ˆå»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè¿™ä¸ªè¯¦ç»†çš„å¯ä»¥çœ‹<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/Documentation/i2c/instantiating-devices#L158">instantiating-devices - Method 3: Probe an I2C bus for certain devices</a>ã€‚</p>
<h3 id="2-4-æ–¹å¼å››ï¼šä»ç”¨æˆ·ç©ºé—´å®ä¾‹åŒ–"><a href="#2-4-æ–¹å¼å››ï¼šä»ç”¨æˆ·ç©ºé—´å®ä¾‹åŒ–" class="headerlink" title="2.4 æ–¹å¼å››ï¼šä»ç”¨æˆ·ç©ºé—´å®ä¾‹åŒ–"></a><font size=3>2.4 æ–¹å¼å››ï¼šä»ç”¨æˆ·ç©ºé—´å®ä¾‹åŒ–</font></h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œå†…æ ¸åº”è¯¥çŸ¥é“è¿æ¥äº†å“ªäº›I2Cè®¾å¤‡ä»¥åŠå®ƒä»¬æ‰€åœ¨çš„åœ°å€ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒä¸ä¼šè¿™æ ·åšï¼Œå› æ­¤æ·»åŠ äº†sysfsæ¥å£æ¥è®©ç”¨æˆ·æä¾›ä¿¡æ¯ã€‚è¯¥æ¥å£ç”±2ä¸ªå±æ€§æ–‡ä»¶ç»„æˆï¼Œå®ƒä»¬åœ¨æ¯ä¸ªI2Cæ€»çº¿ç›®å½•ä¸­åˆ›å»ºï¼šnew_deviceå’Œdelete_deviceã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶éƒ½åªèƒ½å†™ï¼Œæˆ‘ä»¬å¿…é¡»å‘å®ƒä»¬å†™å…¥æ­£ç¡®çš„å‚æ•°ï¼Œä»¥ä¾¿æ­£ç¡®åœ°å®ä¾‹åŒ–ï¼ˆæˆ–è€…åˆ é™¤ï¼‰I2Cè®¾å¤‡ã€‚</p>
<ul>
<li>æ–‡ä»¶new_deviceæ¥å—2ä¸ªå‚æ•°ï¼šI2Cè®¾å¤‡çš„åç§°ï¼ˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰å’ŒI2Cè®¾å¤‡çš„åœ°å€ï¼ˆä¸€ä¸ªæ•°å­—ï¼Œé€šå¸¸ä»¥0xå¼€å¤´çš„åå…­è¿›åˆ¶è¡¨ç¤ºï¼Œä½†ä¹Ÿå¯ä»¥ç”¨åè¿›åˆ¶è¡¨ç¤ºï¼‰ã€‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªi2c_client, .name &#x3D; â€œsdeveepromâ€, .addr&#x3D;0x50, .adapteræ˜¯i2c-1</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo sdeveeprom 0x50 &gt; /sys/bus/i2c/devices/i2c-1/new_device</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330141349194.png" alt="image-20250330141349194"  />

<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ç”¨i2cdetectå·¥å…·çœ‹ä¸€ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2cdetect -y -a 1</span><br></pre></td></tr></table></figure>

<p>ä¼šå‘ç°ä»€ä¹ˆä¹Ÿæ²¡æœ‰ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯å› ä¸ºæˆ‘ä»¬å®é™…å¹¶æ²¡æœ‰å¯¹åº”çš„i2cè®¾å¤‡å­˜åœ¨ï¼Œè¿™å°±ä¼šå¯¼è‡´i2cdetectå‘è¿™ä¸ªåœ°å€å‘æ•°æ®çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šæ”¶åˆ°å›åº”ï¼Œæ‰€ä»¥å°±æ¢æµ‹ä¸å‡ºæ¥äº†</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330141544900.png" alt="image-20250330141544900" />

<ul>
<li>æ–‡ä»¶delete_deviceæ¥å—ä¸€ä¸ªå‚æ•°ï¼šI2Cè®¾å¤‡çš„åœ°å€ã€‚ç”±äºæ²¡æœ‰ä¸¤ä¸ªè®¾å¤‡å¯ä»¥åœ¨ç»™å®šçš„I2Cæ®µä¸Šä½¿ç”¨ç›¸åŒçš„åœ°å€ï¼Œå› æ­¤åœ°å€è¶³ä»¥å”¯ä¸€åœ°æ ‡è¯†è¦åˆ é™¤çš„è®¾å¤‡ã€‚åˆ é™¤ä¸€ä¸ªi2c_client</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0x50 &gt; /sys/bus/i2c/devices/i2c-1/delete_device</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330141610365.png" alt="image-20250330141610365" />

<h3 id="2-5-i2c-clientè®¾å¤‡æ³¨å†Œç¤ºä¾‹"><a href="#2-5-i2c-clientè®¾å¤‡æ³¨å†Œç¤ºä¾‹" class="headerlink" title="2.5 i2c_clientè®¾å¤‡æ³¨å†Œç¤ºä¾‹"></a><font size=3>2.5 i2c_clientè®¾å¤‡æ³¨å†Œç¤ºä¾‹</font></h3><p>è¿™é‡Œé‡‡ç”¨è®¾å¤‡æ ‘çš„æ–¹å¼ï¼Œä»¥æ­£ç‚¹åŸå­alphaå¼€å‘æ¿ä¸Šçš„ap3216cä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹åŸç†å›¾ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329162411698.png" alt="image-20250329162411698" style="zoom: 33%;" />

<p>å¯ä»¥çœ‹åˆ°ï¼ŒAP3216CèŠ¯ç‰‡çš„SCLå’ŒSDAæ˜¯æ¥åœ¨I2C1ä¸Šçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c1 &#123;</span><br><span class="line">    clock-frequency = &lt;<span class="number">100000</span>&gt;;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_i2c1&gt;;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ap3216c@<span class="number">1</span>e &#123;</span><br><span class="line">    	compatible = <span class="string">&quot;alpha,ap3216c&quot;</span>;</span><br><span class="line">    	reg = &lt;<span class="number">0x1e</span>&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä¸ªå¼•è„šå¯ä»¥ç”¨ä½œGPIOå—ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å®ƒä»¬ä¸¤ä¸ªç”¨çš„æ˜¯ä»€ä¹ˆå¼•è„šï¼Œçœ‹ä¸€ä¸‹ã€Š <a target="_blank" rel="noopener" href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh">i.MX 6ULL Applications Processor Reference Manual</a>ã€‹â€”â€”Table 31-1. I2C External Signals  ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329162949427.png" alt="image-20250329162949427"  />

<p>å¯ä»¥çœ‹åˆ°å…¶å®è¿™ä¸¤ä¸ªå¼•è„šå¯ä»¥ç”±GPIO1_IO02å’ŒGPIO1_03å¤ç”¨è€Œæ¥ï¼Œä»è¡¨ä¸Šçœ‹ï¼Œè¿™ä¸¤ä¸ªgpioé»˜è®¤çš„åŠŸèƒ½å°±æ˜¯I2C1çš„SCLå’ŒSDAã€‚æˆ‘ä»¬å¯ä»¥æ‰“å¼€ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/arch/arm/boot/dts/imx6ul-14x14-evk.dtsi#L328">imx6ul-14x14-evk.dtsi</a> æ‰¾ä¸€ä¸‹pinctrl_i2c1ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_i2c1: i2c1grp &#123;</span><br><span class="line">		fsl,pins = &lt;</span><br><span class="line">			MX6UL_PAD_UART4_TX_DATA__I2C1_SCL <span class="number">0x4001b8b0</span></span><br><span class="line">			MX6UL_PAD_UART4_RX_DATA__I2C1_SDA <span class="number">0x4001b8b0</span></span><br><span class="line">		&gt;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ï¼Œè¿™é‡Œçš„I2C1ç”¨çš„æ˜¯UART4çš„é‚£ä¸¤ä¸ªå¼•è„šå¤ç”¨è€Œæ¥çš„ã€‚</p>
<h3 id="2-6-åœ¨sysfsä¸­çš„ä½“ç°"><a href="#2-6-åœ¨sysfsä¸­çš„ä½“ç°" class="headerlink" title="2.6 åœ¨sysfsä¸­çš„ä½“ç°"></a><font size=3>2.6 åœ¨sysfsä¸­çš„ä½“ç°</font></h3><p>å½“æˆ‘ä»¬åœ¨è®¾å¤‡æ ‘å†™å¥½è®¾å¤‡èŠ‚ç‚¹åï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ª <code>/sys/bus/i2c/devices   </code>ç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸‹å­˜æ”¾ç€æ‰€æœ‰çš„i2cè®¾å¤‡ã€‚å¦‚æœè®¾å¤‡æ ‘ä¿®æ”¹æ­£ç¡®çš„è¯ï¼Œä¼šåœ¨&#x2F;sys&#x2F;bus&#x2F;i2c&#x2F;devices ç›®å½•ä¸‹çœ‹åˆ°ä¸€ä¸ªåä¸ºâ€œ0-001eâ€çš„å­ç›®å½• ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330135916716.png" alt="image-20250330135916716" />

<p>â€œ0-001eâ€å°±æ˜¯ ap3216c çš„è®¾å¤‡ç›®å½•ï¼Œâ€œ1eâ€å°±æ˜¯ ap3216c å™¨ä»¶åœ°å€ã€‚è¿›å…¥0-001e ç›®å½•ï¼Œå¯ä»¥çœ‹åˆ°â€œnameâ€æ–‡ä»¶ï¼Œ name æ–‡ä»¶å°±ä¿å­˜ç€æ­¤è®¾å¤‡åå­—ï¼Œåœ¨è¿™é‡Œå°±æ˜¯â€œap3216câ€ ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330140012476.png" alt="image-20250330140012476" />

<p>æˆ‘ä»¬è¿˜å¯ä»¥ç”¨i2cdetectå·¥å…·æ¢æµ‹ä¸€ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">i2cdetect -y -a 0</span><br><span class="line">i2cdetect -y -a 1</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330140511185.png" alt="image-20250330140511185" />

<h2 id="3-I2Cè®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…"><a href="#3-I2Cè®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…" class="headerlink" title="3. I2Cè®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…"></a><font size=3>3. I2Cè®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…</font></h2><p>è®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…è¿‡ç¨‹ä¹Ÿæ˜¯ç”± I2C æ€»çº¿å®Œæˆçš„ï¼Œ I2C æ€»çº¿çš„æ•°æ®ç»“æ„ä¸º <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L493">i2c_bus_type</a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> <span class="title">i2c_bus_type</span> =</span> &#123;</span><br><span class="line">	.name		= <span class="string">&quot;i2c&quot;</span>,</span><br><span class="line">	.match		= i2c_device_match,</span><br><span class="line">	.probe		= i2c_device_probe,</span><br><span class="line">	.remove		= i2c_device_remove,</span><br><span class="line">	.shutdown	= i2c_device_shutdown,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>.match å°±æ˜¯ I2C æ€»çº¿çš„è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…å‡½æ•°ï¼Œåœ¨è¿™é‡Œå°±æ˜¯ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L101">i2c_device_match()</a> è¿™ä¸ªå‡½æ•° :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">i2c_device_match</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span>	*<span class="title">client</span> =</span> i2c_verify_client(dev);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span>	*<span class="title">driver</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Attempt an OF style match */</span></span><br><span class="line">	<span class="keyword">if</span> (i2c_of_match_device(drv-&gt;of_match_table, client))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Then ACPI style match */</span></span><br><span class="line">	<span class="keyword">if</span> (acpi_driver_match_device(dev, drv))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	driver = to_i2c_driver(drv);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Finally an I2C match */</span></span><br><span class="line">	<span class="keyword">if</span> (i2c_match_id(driver-&gt;id_table, client))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-1-è®¾å¤‡æ ‘åŒ¹é…ï¼ši2c-of-match-device"><a href="#3-1-è®¾å¤‡æ ‘åŒ¹é…ï¼ši2c-of-match-device" class="headerlink" title="3.1 è®¾å¤‡æ ‘åŒ¹é…ï¼ši2c_of_match_device()"></a><font size=3>3.1 è®¾å¤‡æ ‘åŒ¹é…ï¼š<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-of.c#L220">i2c_of_match_device()</a></font></h3><p>ç¬¬ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡å‡½æ•°<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-of.c#L220">i2c_of_match_device()</a>å®Œæˆè®¾å¤‡æ ‘åŒ¹é…ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="keyword">struct</span> of_device_id</span><br><span class="line">*<span class="title function_">i2c_of_match_device</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches,</span></span><br><span class="line"><span class="params">		     <span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">match</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(client &amp;&amp; matches))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	match = of_match_device(matches, &amp;client-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (match)</span><br><span class="line">		<span class="keyword">return</span> match;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> i2c_of_match_device_sysfs(matches, client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œè°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯ä½¿ç”¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L297">i2c_driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/device.h#L287">driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/mod_devicetable.h#L241">of_match_table</a>è¿™ä¸ªåŒ¹é…è¡¨è¿›è¡ŒåŒ¹é…ã€‚</p>
<ul>
<li>ï¼ˆ1ï¼‰<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/of/device.c#L18">of_match_device()</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="keyword">struct</span> of_device_id *<span class="title function_">of_match_device</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches,</span></span><br><span class="line"><span class="params">					   <span class="type">const</span> <span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ((!matches) || (!dev-&gt;of_node))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> of_match_node(matches, dev-&gt;of_node);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(of_match_device);</span><br></pre></td></tr></table></figure>

<p>è®¾å¤‡æ ‘ä¸­ï¼ŒæŸä¸ªI2Cæ§åˆ¶å™¨èŠ‚ç‚¹ä¸‹å¯ä»¥åˆ›å»ºI2Cè®¾å¤‡çš„èŠ‚ç‚¹ã€‚å¦‚æœI2Cè®¾å¤‡èŠ‚ç‚¹çš„compatibleå±æ€§è·Ÿof_match_tableçš„æŸé¡¹å…¼å®¹ï¼Œåˆ™åŒ¹é…æˆåŠŸã€‚</p>
<ul>
<li>ï¼ˆ2ï¼‰<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-of.c#L191">i2c_of_match_device_sysfs()</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> of_device_id*</span><br><span class="line"><span class="title function_">i2c_of_match_device_sysfs</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches,</span></span><br><span class="line"><span class="params">				  <span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (; matches-&gt;compatible[<span class="number">0</span>]; matches++) &#123;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">		<span class="keyword">if</span> (sysfs_streq(client-&gt;name, matches-&gt;compatible))</span><br><span class="line">			<span class="keyword">return</span> matches;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°æ˜¯æ¯”è¾ƒ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L335">i2c_client</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L333">name</a>è·ŸæŸä¸ª<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L297">i2c_driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/device.h#L287">driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/mod_devicetable.h#L241">of_match_table[i]</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/mod_devicetable.h#L244">compatible</a>å€¼ï¼Œè‹¥æœ‰ç›¸åŒçš„ï¼Œåˆ™åŒ¹é…æˆåŠŸã€‚ï¼ˆè¿™ç§æ–¹å¼åœ¨platformå¹³å°æ€»çº¿ä¸­å¥½åƒæ²¡çœ‹åˆ°ï¼Œä½†æ˜¯i2cä¸­æ˜¯æœ‰è¿™æ ·çš„æ–¹å¼çš„ï¼‰ã€‚<code>strchr()</code>å‡½æ•°æ˜¯ç”¨äºåœ¨å­—ç¬¦ä¸²ä¸­æŸ¥æ‰¾ç¬¬ä¸€æ¬¡å‡ºç°çš„æŒ‡å®šå­—ç¬¦ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥å­—ç¬¦çš„æŒ‡é’ˆã€‚å¦‚æœæœªæ‰¾åˆ°å­—ç¬¦ï¼Œåˆ™è¿”å›<em>NULL</em>ã€‚</p>
<h3 id="3-2-idåŒ¹é…ï¼ši2c-match-id"><a href="#3-2-idåŒ¹é…ï¼ši2c-match-id" class="headerlink" title="3.2 idåŒ¹é…ï¼ši2c_match_id()"></a><font size=3>3.2 idåŒ¹é…ï¼š<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L86">i2c_match_id()</a></font></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *<span class="title function_">i2c_match_id</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *id,</span></span><br><span class="line"><span class="params">						<span class="type">const</span> <span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(id &amp;&amp; client))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (id-&gt;name[<span class="number">0</span>]) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(client-&gt;name, id-&gt;name) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> id;</span><br><span class="line">		id++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ç”¨äºä¼ ç»Ÿçš„ã€æ— è®¾å¤‡æ ‘çš„ I2C è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…è¿‡ç¨‹ã€‚  ä½¿ç”¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L298">i2c_driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/mod_devicetable.h#L436">id_table</a>æ¥åˆ¤æ–­ï¼Œå½“<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L335">i2c_client</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L333">name</a> è·ŸæŸä¸ª <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L298">i2c_driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/mod_devicetable.h#L436">id_table[i]</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/mod_devicetable.h#L437">name</a> å€¼ç›¸åŒï¼Œåˆ™åŒ¹é…æˆåŠŸ</p>
<p>i2c_driverè·Ÿi2c_clientåŒ¹é…æˆåŠŸåï¼Œå°±è°ƒç”¨i2c_driver.probeå‡½æ•°ã€‚</p>
<h2 id="4-I2Cè®¾å¤‡æ”¶å‘æ•°æ®"><a href="#4-I2Cè®¾å¤‡æ”¶å‘æ•°æ®" class="headerlink" title="4. I2Cè®¾å¤‡æ”¶å‘æ•°æ®"></a><font size=3>4. I2Cè®¾å¤‡æ”¶å‘æ•°æ®</font></h2><h3 id="4-1-i2c-transfer"><a href="#4-1-i2c-transfer" class="headerlink" title="4.1Â i2c_transfer()"></a><font size=3>4.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1913">i2c_transfer()</a></font></h3><p>I2C è®¾å¤‡é©±åŠ¨é¦–å…ˆè¦åšçš„å°±æ˜¯åˆå§‹åŒ– i2c_driver å¹¶å‘ Linux å†…æ ¸æ³¨å†Œã€‚å½“è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…ä»¥å i2c_driver é‡Œé¢çš„ probe å‡½æ•°å°±ä¼šæ‰§è¡Œï¼Œ probe å‡½æ•°é‡Œé¢æ‰€åšçš„å°±æ˜¯å­—ç¬¦è®¾å¤‡é©±åŠ¨é‚£ä¸€å¥—äº†ã€‚  </p>
<p>ä¸€èˆ¬éœ€è¦åœ¨ probe å‡½æ•°é‡Œé¢åˆå§‹åŒ– I2C è®¾å¤‡ï¼Œåˆå§‹åŒ–å®Œè‚¯å®šå°±æ˜¯å¯¹I2Cè®¾å¤‡è¿›è¡Œæ“ä½œäº†ï¼Œåœ¨linuxä¸­ä¸ºæˆ‘ä»¬æä¾›äº† <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1913">i2c_transfer()</a> å‡½æ•°ã€‚ i2c_transfer å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨ I2C é€‚é…å™¨ä¸­ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L497">i2c_algorithm</a> é‡Œé¢çš„ <strong><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L526">master_xfer()</a></strong> å‡½æ•°ï¼Œå¯¹äºimx6ullæ¥è¯´å°±æ˜¯<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1042">i2c_imx_algo</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L883">i2c_imx_xfer()</a>ï¼Œè¿™ä¸ªå‡½æ•°åé¢ä¼šè¿›è¡Œåˆ†æï¼Œåœ¨é‡Œé¢å°±æ˜¯å®Œæˆäº†èµ·å§‹ä¿¡å·ã€ç»“æŸä¿¡å·ã€åº”ç­”ä¸éåº”ç­”ï¼Œè¯»å†™ç­‰ç›¸å…³æ“ä½œã€‚  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_transfer</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap, <span class="keyword">struct</span> i2c_msg *msgs, <span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">		ret = __i2c_transfer(adap, msgs, num);</span><br><span class="line">		i2c_unlock_bus(adap, I2C_LOCK_SEGMENT);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(i2c_transfer);</span><br></pre></td></tr></table></figure>

<p><strong>å‡½æ•°å‚æ•°</strong></p>
<ul>
<li>adapï¼š æ‰€ä½¿ç”¨çš„ I2C é€‚é…å™¨ï¼Œ i2c_client ä¼šä¿å­˜å…¶å¯¹åº”çš„ i2c_adapterã€‚</li>
<li>msgsï¼š <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/uapi/linux/i2c.h#L33">struct i2c_msg</a>ç±»å‹æŒ‡é’ˆï¼Œè¡¨ç¤ºI2C è¦å‘é€çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆæ¯ã€‚</li>
<li>numï¼š æ¶ˆæ¯æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ msgs çš„æ•°é‡ã€‚</li>
</ul>
<p><strong>è¿”å›å€¼ï¼š</strong> è´Ÿå€¼ï¼Œå¤±è´¥ï¼Œå…¶ä»–éè´Ÿå€¼ï¼Œå‘é€çš„ msgs æ•°é‡ã€‚  </p>
<p>å¦å¤–è¿˜æœ‰ä¸¤ä¸ªAPIå‡½æ•°<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L108">i2c_master_send()</a>å’Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L78">i2c_master_recv()</a>ï¼Œåˆ†åˆ«ç”¨äºI2Cæ•°æ®çš„æ”¶å‘æ“ä½œï¼Œè¿™ä¸¤ä¸ªå‡½æ•°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨i2c_transferã€‚å°±ç›¸å½“äºæ›¿æˆ‘ä»¬å°è£…äº†ä¸€ä¸‹ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨è‡ªå·±å»å®šä¹‰i2c_msgäº†ã€‚</p>
<h3 id="4-2-æ”¶å‘ç¤ºä¾‹"><a href="#4-2-æ”¶å‘ç¤ºä¾‹" class="headerlink" title="4.2 æ”¶å‘ç¤ºä¾‹"></a><font size=3>4.2 æ”¶å‘ç¤ºä¾‹</font></h3><h4 id="4-2-1-è®¾å¤‡ç»“æ„ä½“"><a href="#4-2-1-è®¾å¤‡ç»“æ„ä½“" class="headerlink" title="4.2.1 è®¾å¤‡ç»“æ„ä½“"></a><font size=3>4.2.1 è®¾å¤‡ç»“æ„ä½“</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è®¾å¤‡ç»“æ„ä½“ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xxx_dev</span> &#123;</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="type">void</span> *private_data; <span class="comment">/* ç§æœ‰æ•°æ®ï¼Œä¸€èˆ¬ä¼šè®¾ç½®ä¸º i2c_client */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è®¾å¤‡ç»“æ„ä½“ï¼Œåœ¨è®¾å¤‡ç»“æ„ä½“é‡Œé¢æ·»åŠ ä¸€ä¸ªæ‰§è¡Œvoidçš„æŒ‡é’ˆæˆå‘˜å˜é‡private_dataï¼Œæ­¤æˆå‘˜å˜é‡ç”¨äºä¿å­˜è®¾å¤‡çš„ç§æœ‰æ•°æ®ã€‚åœ¨ I2C è®¾å¤‡é©±åŠ¨ä¸­æˆ‘ä»¬ä¸€èˆ¬å°†å…¶æŒ‡å‘ I2C è®¾å¤‡å¯¹åº”çš„i2c_clientã€‚  </p>
<h4 id="4-2-2-xxx-read-regs"><a href="#4-2-2-xxx-read-regs" class="headerlink" title="4.2.2Â xxx_read_regs()"></a><font size=3>4.2.2Â xxx_read_regs()</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description : è¯»å– I2C è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨æ•°æ®</span></span><br><span class="line"><span class="comment"> * @param â€“ dev : I2C è®¾å¤‡</span></span><br><span class="line"><span class="comment"> * @param â€“ reg : è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment"> * @param â€“ val : è¯»å–åˆ°çš„æ•°æ®</span></span><br><span class="line"><span class="comment"> * @param â€“ len : è¦è¯»å–çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment"> * @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_read_regs</span><span class="params">(<span class="keyword">struct</span> xxx_dev *dev, u8 reg, <span class="type">void</span> *val, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[2];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* msg[0]ï¼Œç¬¬ä¸€æ¡å†™æ¶ˆæ¯ï¼Œå‘é€è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€ */</span></span><br><span class="line">    msg[<span class="number">0</span>].addr = client-&gt;addr; <span class="comment">/* I2C å™¨ä»¶åœ°å€ */</span></span><br><span class="line">    msg[<span class="number">0</span>].flags = <span class="number">0</span>;           <span class="comment">/* æ ‡è®°ä¸ºå‘é€æ•°æ® */</span></span><br><span class="line">    msg[<span class="number">0</span>].buf = &amp;reg;          <span class="comment">/* è¯»å–çš„é¦–åœ°å€ */</span></span><br><span class="line">    msg[<span class="number">0</span>].len = <span class="number">1</span>;             <span class="comment">/* reg é•¿åº¦ */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* msg[1]ï¼Œç¬¬äºŒæ¡è¯»æ¶ˆæ¯ï¼Œè¯»å–å¯„å­˜å™¨æ•°æ® */</span></span><br><span class="line">    msg[<span class="number">1</span>].addr = client-&gt;addr; <span class="comment">/* I2C å™¨ä»¶åœ°å€ */</span></span><br><span class="line">    msg[<span class="number">1</span>].flags = I2C_M_RD;    <span class="comment">/* æ ‡è®°ä¸ºè¯»å–æ•°æ® */</span></span><br><span class="line">    msg[<span class="number">1</span>].buf = val;           <span class="comment">/* è¯»å–æ•°æ®ç¼“å†²åŒº */</span></span><br><span class="line">    msg[<span class="number">1</span>].len = len;           <span class="comment">/* è¦è¯»å–çš„æ•°æ®é•¿åº¦ */</span></span><br><span class="line">    ret = i2c_transfer(client-&gt;adapter, msg, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        ret = -EREMOTEIO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ç”¨äºè¯»å– I2C è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨æ•°æ®ã€‚</p>
<p>ç¬¬ 12 è¡Œï¼šå®šä¹‰äº†ä¸€ä¸ªi2c_msg æ•°ç»„ï¼Œ 2 ä¸ªæ•°ç»„å…ƒç´ ï¼Œå› ä¸º I2C è¯»å–æ•°æ®çš„æ—¶å€™è¦å…ˆå‘é€è¦è¯»å–çš„å¯„å­˜å™¨åœ°å€ï¼Œç„¶åå†è¯»å–æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦å‡†å¤‡ä¸¤ä¸ª i2c_msgã€‚ä¸€ä¸ªç”¨äºå‘é€å¯„å­˜å™¨åœ°å€ï¼Œä¸€ä¸ªç”¨äºè¯»å–å¯„å­˜å™¨å€¼ã€‚</p>
<p>ç¬¬15 - 19 è¡Œï¼šå¯¹äº msg[0]ï¼Œå°† flags è®¾ç½®ä¸º 0ï¼Œè¡¨ç¤ºå†™æ•°æ®ã€‚ msg[0]çš„ addr æ˜¯ I2C è®¾å¤‡çš„å™¨ä»¶åœ°å€ï¼Œ msg[0]çš„ bufæˆå‘˜å˜é‡å°±æ˜¯è¦è¯»å–çš„å¯„å­˜å™¨åœ°å€ã€‚    </p>
<p>ç¬¬ 21 - 25 è¡Œï¼šå¯¹äº msg[1]ï¼Œå°† flags è®¾ç½®ä¸º I2C_M_RDï¼Œè¡¨ç¤ºè¯»å–æ•°æ®ã€‚msg[1]çš„ buf æˆå‘˜å˜é‡ç”¨äºä¿å­˜è¯»å–åˆ°çš„æ•°æ®ï¼Œ len æˆå‘˜å˜é‡å°±æ˜¯è¦è¯»å–çš„æ•°æ®é•¿åº¦ã€‚</p>
<p>ç¬¬26 - 34 è¡Œï¼šè°ƒç”¨i2c_transfer å‡½æ•°å®Œæˆ I2C æ•°æ®è¯»æ“ä½œã€‚  </p>
<h4 id="4-2-3-xxx-write-regs"><a href="#4-2-3-xxx-write-regs" class="headerlink" title="4.2.3Â xxx_write_regs()"></a><font size=3>4.2.3Â xxx_write_regs()</font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description : å‘ I2C è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment"> * @param â€“ dev : è¦å†™å…¥çš„è®¾å¤‡ç»“æ„ä½“</span></span><br><span class="line"><span class="comment"> * @param â€“ reg : è¦å†™å…¥çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment"> * @param â€“ buf : è¦å†™å…¥çš„æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line"><span class="comment"> * @param â€“ len : è¦å†™å…¥çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment"> * @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> s32 <span class="title function_">xxx_write_regs</span><span class="params">(<span class="keyword">struct</span> xxx_dev *dev, u8 reg, u8 *buf, u8 len)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 b[<span class="number">256</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    b[<span class="number">0</span>] = reg;              <span class="comment">/* å¯„å­˜å™¨é¦–åœ°å€ */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;b[<span class="number">1</span>], buf, len); <span class="comment">/* å°†è¦å‘é€çš„æ•°æ®æ‹·è´åˆ°æ•°ç»„ b é‡Œé¢ */</span></span><br><span class="line"></span><br><span class="line">    msg.addr = client-&gt;addr; <span class="comment">/* I2C å™¨ä»¶åœ°å€ */</span></span><br><span class="line">    msg.flags = <span class="number">0</span>;           <span class="comment">/* æ ‡è®°ä¸ºå†™æ•°æ® */</span></span><br><span class="line"></span><br><span class="line">    msg.buf = b;       <span class="comment">/* è¦å‘é€çš„æ•°æ®ç¼“å†²åŒº */</span></span><br><span class="line">    msg.len = len + <span class="number">1</span>; <span class="comment">/* è¦å‘é€çš„æ•°æ®é•¿åº¦ */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i2c_transfer(client-&gt;adapter, &amp;msg, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ç”¨äºå‘ I2C è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨å†™æ•°æ®ï¼Œ I2C å†™æ“ä½œè¦æ¯”è¯»æ“ä½œç®€å•ä¸€ç‚¹ï¼Œå› æ­¤ä¸€ä¸ª i2c_msg å³å¯ã€‚</p>
<p>ç¬¬ 11 è¡Œï¼šæ•°ç»„ b ç”¨äºå­˜æ”¾å¯„å­˜å™¨é¦–åœ°å€å’Œè¦å‘é€çš„æ•°æ®ã€‚</p>
<p>ç¬¬ 18 è¡Œï¼šè®¾ç½® msg çš„ addr ä¸º I2C å™¨ä»¶åœ°å€ã€‚</p>
<p>ç¬¬ 19 è¡Œï¼šè®¾ç½® msg çš„ flags ä¸º 0ï¼Œä¹Ÿå°±æ˜¯å†™æ•°æ®ã€‚</p>
<p>ç¬¬ 21 è¡Œï¼šè®¾ç½®è¦å‘é€çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„ bã€‚</p>
<p>ç¬¬ 22 è¡Œï¼šè®¾ç½® msg çš„ len ä¸º len+1ï¼Œå› ä¸ºè¦åŠ ä¸Šä¸€ä¸ªå­—èŠ‚çš„å¯„å­˜å™¨åœ°å€ã€‚</p>
<p>ç¬¬ 24 è¡Œï¼šæœ€åé€šè¿‡ i2c_transfer å‡½æ•°å®Œæˆå‘ I2C è®¾å¤‡çš„å†™æ“ä½œã€‚  </p>
<h2 id="5-ap3216cå®ä¾‹"><a href="#5-ap3216cå®ä¾‹" class="headerlink" title="5. ap3216cå®ä¾‹"></a><font size=3>5. ap3216cå®ä¾‹</font></h2><h3 id="5-1-demoæºç "><a href="#5-1-demoæºç " class="headerlink" title="5.1 demoæºç "></a><font size=3>5.1 demoæºç </font></h3><p>demoæºç å¯ä»¥çœ‹è¿™é‡Œï¼š<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/tree/master/30_i2c_subsystem/01_ap3216c">30_i2c_subsystem&#x2F;01_ap3216c Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<h3 id="5-2-å¼€å‘æ¿æµ‹è¯•"><a href="#5-2-å¼€å‘æ¿æµ‹è¯•" class="headerlink" title="5.2 å¼€å‘æ¿æµ‹è¯•"></a><font size=3>5.2 å¼€å‘æ¿æµ‹è¯•</font></h3><p>æˆ‘ä»¬æ›´æ–°å¯¹åº”çš„è®¾å¤‡æ ‘ï¼Œç„¶åé‡å¯ï¼Œå°±ä¼šå‘ç°åœ¨&#x2F;sys&#x2F;bus&#x2F;i2c&#x2F;devices&#x2F;ä¸‹å­˜åœ¨æˆ‘ä»¬åˆ›å»ºçš„ap3216cè®¾å¤‡ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330173825291.png" alt="image-20250330173825291" />

<p>ç”±äºè¿™è®¾å¤‡å®¤çœŸå®å­˜åœ¨çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨i2cdetectä¹Ÿä¼šå¾—åˆ°æ­£ç¡®çš„å›åº”ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2cdetect -y -a 0</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330173931777.png" alt="image-20250330173931777" />

<p>ç„¶ååŠ è½½é©±åŠ¨ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insmod sdriver_ap3216c.ko</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330174321446.png" alt="image-20250330174321446" />

<p>ç„¶åæˆ‘ä»¬æ‰§è¡Œæµ‹è¯•ç¨‹åºï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330174422138.png" alt="image-20250330174422138" />

<h1 id="äºŒã€I2Cæ€»çº¿é©±åŠ¨åˆ†æ"><a href="#äºŒã€I2Cæ€»çº¿é©±åŠ¨åˆ†æ" class="headerlink" title="äºŒã€I2Cæ€»çº¿é©±åŠ¨åˆ†æ"></a><font size=3>äºŒã€I2Cæ€»çº¿é©±åŠ¨åˆ†æ</font></h1><p>I2Cæ€»çº¿é©±åŠ¨å…¶å®å°±æ˜¯I2C é€‚é…å™¨é©±åŠ¨ï¼Œä¹Ÿå°±æ˜¯ SOC çš„ I2C æ§åˆ¶å™¨é©±åŠ¨ã€‚å°±ç›¸å½“äºä¹‹å‰åœ¨è£¸æœºä¸Šæ§åˆ¶I.MX6Uçš„ç‰©ç†I2Cå¤–è®¾ã€‚</p>
<p>I2C è®¾å¤‡é©±åŠ¨æ˜¯éœ€è¦ç”¨æˆ·æ ¹æ®ä¸åŒçš„ I2C è®¾å¤‡å»ç¼–å†™ï¼Œè€Œ I2C é€‚é…å™¨é©±åŠ¨ä¸€èˆ¬éƒ½æ˜¯ SOC å‚å•†å»ç¼–å†™çš„ï¼Œæ¯”å¦‚ NXP å°±ç¼–å†™å¥½äº† I.MX6U çš„I2C é€‚é…å™¨é©±åŠ¨ã€‚   </p>
<h2 id="1-I-MX6U-I2C-ç®€ä»‹"><a href="#1-I-MX6U-I2C-ç®€ä»‹" class="headerlink" title="1.Â I.MX6U I2C ç®€ä»‹  "></a><font size=3>1.Â I.MX6U I2C ç®€ä»‹  </font></h2><blockquote>
<p>å¯ä»¥å‚è€ƒã€Š<a target="_blank" rel="noopener" href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh">i.MX 6ULL Applications Processor Reference Manual</a>ã€‹â€”â€”Chapter 31 I2C Controller (I2C)</p>
</blockquote>
<p>I.MX6U æä¾›äº† 4 ä¸ª I2C å¤–è®¾ï¼Œé€šè¿‡è¿™å››ä¸ª I2C å¤–è®¾å³å¯å®Œæˆä¸ I2C ä»å™¨ä»¶è¿›è¡Œé€šä¿¡ã€‚I.MX6U çš„ I2C æ”¯æŒä¸¤ç§æ¨¡å¼ï¼šæ ‡å‡†æ¨¡å¼å’Œå¿«é€Ÿæ¨¡å¼ï¼Œæ ‡å‡†æ¨¡å¼ä¸‹ I2C æ•°æ®ä¼ è¾“é€Ÿç‡æœ€é«˜æ˜¯ 100Kbits&#x2F;sï¼Œåœ¨å¿«é€Ÿæ¨¡å¼ä¸‹æ•°æ®ä¼ è¾“é€Ÿç‡æœ€é«˜ä¸º 400Kbits&#x2F;sã€‚å®ƒçš„å†…éƒ¨æ¡†å›¾å¦‚ä¸‹ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250328113706039.png" alt="image-20250328113706039" style="zoom:50%;" />

<h3 id="1-1-I2Cx-IADR-x-1-4"><a href="#1-1-I2Cx-IADR-x-1-4" class="headerlink" title="1.1Â I2Cx_IADR(x&#x3D;1~4)  "></a><font size=3>1.1Â I2Cx_IADR(x&#x3D;1~4)  </font></h3><p>è¿™ä¸ªå¯ä»¥çœ‹ã€Š <a target="_blank" rel="noopener" href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh">i.MX 6ULL Applications Processor Reference Manual</a>ã€‹â€”â€” 31.7.1 I2C Address Register (I2Cx_IADR)  ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329105907331.png" alt="image-20250329105907331"  />

<p>å¯„å­˜å™¨ I2Cx_IADR åªæœ‰ ADR(bit7:1)ä½æœ‰æ•ˆï¼Œç”¨æ¥ä¿å­˜ I2C ä»è®¾å¤‡åœ°å€æ•°æ®ã€‚å½“æˆ‘ä»¬è¦è®¿é—®æŸä¸ª I2C ä»è®¾å¤‡çš„æ—¶å€™å°±éœ€è¦å°†å…¶è®¾å¤‡åœ°å€å†™å…¥åˆ° ADR é‡Œé¢ã€‚  </p>
<h3 id="1-2-I2Cx-IFDR-x-1-4"><a href="#1-2-I2Cx-IFDR-x-1-4" class="headerlink" title="1.2Â I2Cx_IFDR  (x&#x3D;1~4)  "></a><font size=3>1.2Â I2Cx_IFDR  (x&#x3D;1~4)  </font></h3><p>è¿™ä¸ªå¯ä»¥çœ‹ã€Š <a target="_blank" rel="noopener" href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh">i.MX 6ULL Applications Processor Reference Manual</a>ã€‹â€”â€” 31.7.2 I2C Frequency Divider Register (I2Cx_IFDR)  ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329110046602.png" alt="image-20250329110046602"  />

<p>è¿™ä¸ªæ˜¯ I2C çš„åˆ†é¢‘å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨ I2Cx_IFDR ä¹Ÿåªæœ‰ IC(bit5:0)è¿™ä¸ªä½ï¼Œç”¨æ¥è®¾ç½® I2C çš„æ³¢ç‰¹ç‡ï¼Œ I2C çš„æ—¶é’Ÿæºå¯ä»¥é€‰æ‹© IPG_CLK_ROOT&#x3D;66MHzï¼Œé€šè¿‡è®¾ç½® IC ä½æ—¢å¯ä»¥å¾—åˆ°æƒ³è¦çš„ I2C æ³¢ç‰¹ç‡ã€‚ IC ä½å¯é€‰çš„è®¾ç½®å¯ä»¥çœ‹ã€Š <a target="_blank" rel="noopener" href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh">i.MX 6ULL Applications Processor Reference Manual</a>ã€‹â€”â€” Table 31-3. I2C_IFDR Register Field Values ã€‚</p>
<p>ä¸åƒå…¶ä»–å¤–è®¾çš„åˆ†é¢‘è®¾ç½®ä¸€æ ·å¯ä»¥éšæ„è®¾ç½®ï¼Œ Table 31-3. I2C_IFDR Register Field Values  ä¸­åˆ—å‡ºäº† IC çš„æ‰€æœ‰å¯é€‰å€¼ã€‚æ¯”å¦‚ç°åœ¨I2Cçš„æ—¶é’Ÿæºä¸º66MHzï¼Œæˆ‘ä»¬è¦è®¾ç½®I2Cçš„æ³¢ç‰¹ç‡ä¸º100KHzï¼Œé‚£ä¹ˆICå°±å¯ä»¥è®¾ç½®ä¸º0X15ï¼Œä¹Ÿå°±æ˜¯ 640 åˆ†é¢‘ã€‚ 66000000&#x2F;640&#x3D;103.125KHz â‰ˆ 100KHzã€‚  </p>
<h3 id="1-3-I2Cx-I2CR-x-1-4"><a href="#1-3-I2Cx-I2CR-x-1-4" class="headerlink" title="1.3Â I2Cx_I2CR    (x&#x3D;1~4)  "></a><font size=3>1.3Â I2Cx_I2CR    (x&#x3D;1~4)  </font></h3><p>è¿™ä¸ªå¯ä»¥çœ‹ã€Š <a target="_blank" rel="noopener" href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh">i.MX 6ULL Applications Processor Reference Manual</a>ã€‹â€”â€” 31.7.3 I2C Control Register (I2Cx_I2CR)ï¼Œè¿™ä¸ªæ˜¯ I2C æ§åˆ¶å¯„å­˜å™¨ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329110358912.png" alt="image-20250329110358912"  />

<p>å­˜å™¨ I2Cx_I2CR çš„å„ä½å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><strong>IEN(bit7)ï¼š</strong> I2C ä½¿èƒ½ä½ï¼Œä¸º 1 çš„æ—¶å€™ä½¿èƒ½ I2Cï¼Œä¸º 0 çš„æ—¶å€™å…³é—­ I2Cã€‚ </p>
</li>
<li><p><strong>IIEN(bit6)ï¼š</strong> I2C ä¸­æ–­ä½¿èƒ½ä½ï¼Œä¸º 1 çš„æ—¶å€™ä½¿èƒ½ I2C ä¸­æ–­ï¼Œä¸º 0 çš„æ—¶å€™å…³é—­ I2C ä¸­æ–­ã€‚  </p>
</li>
<li><p><strong>MSTA(bit5)ï¼š</strong>ä¸»ä»æ¨¡å¼é€‰æ‹©ä½ï¼Œè®¾ç½® IIC å·¥ä½œåœ¨ä¸»æ¨¡å¼è¿˜æ˜¯ä»æ¨¡å¼ï¼Œä¸º 1 çš„æ—¶å€™å·¥ä½œåœ¨ä¸»æ¨¡å¼ï¼Œä¸º 0 çš„æ—¶å€™å·¥ä½œåœ¨ä»æ¨¡å¼ã€‚</p>
</li>
<li><p><strong>MTX(bit4)ï¼š</strong>ä¼ è¾“æ–¹å‘é€‰æ‹©ä½ï¼Œç”¨æ¥è®¾ç½®æ˜¯è¿›è¡Œå‘é€è¿˜æ˜¯æ¥æ”¶ï¼Œä¸º 0 çš„æ—¶å€™æ˜¯æ¥æ”¶ï¼Œä¸º 1 çš„æ—¶å€™æ˜¯å‘é€ã€‚</p>
</li>
<li><p><strong>TXAK(bit3)ï¼š</strong>ä¼ è¾“åº”ç­”ä½ä½¿èƒ½ï¼Œä¸º 0 çš„è¯å‘é€ ACK ä¿¡å·ï¼Œä¸º 1 çš„è¯å‘é€ NO ACK ä¿¡å·ã€‚</p>
</li>
<li><p><strong>RSTA(bit2)ï¼š</strong>é‡å¤å¼€å§‹ä¿¡å·ï¼Œä¸º 1 çš„è¯äº§ç”Ÿä¸€ä¸ªé‡æ–°å¼€å§‹ä¿¡å·ã€‚</p>
</li>
</ul>
<h3 id="1-4-I2Cx-I2SR-x-1-4"><a href="#1-4-I2Cx-I2SR-x-1-4" class="headerlink" title="1.4Â I2Cx_I2SR   (x&#x3D;1~4)  "></a><font size=3>1.4Â I2Cx_I2SR   (x&#x3D;1~4)  </font></h3><p>è¿™ä¸ªå¯ä»¥çœ‹ã€Š <a target="_blank" rel="noopener" href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh">i.MX 6ULL Applications Processor Reference Manual</a>ã€‹â€”â€” 31.7.4 I2C Status Register (I2Cx_I2SR)  ï¼Œè¿™ä¸ªæ˜¯ I2C çš„çŠ¶æ€å¯„å­˜å™¨ ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329110637057.png" alt="image-20250329110637057"  />

<p>å¯„å­˜å™¨ I2Cx_I2SR çš„å„ä½å«ä¹‰å¦‚ä¸‹ï¼š  </p>
<ul>
<li><strong>ICF(bit7)ï¼š</strong>æ•°æ®ä¼ è¾“çŠ¶æ€ä½ï¼Œä¸º 0 çš„æ—¶å€™è¡¨ç¤ºæ•°æ®æ­£åœ¨ä¼ è¾“ï¼Œä¸º 1 çš„æ—¶å€™è¡¨ç¤ºæ•°æ®ä¼ è¾“å®Œæˆã€‚</li>
<li><strong>IAAS(bit6)ï¼š</strong>å½“ä¸º 1 çš„æ—¶å€™è¡¨ç¤º I2C åœ°å€ï¼Œä¹Ÿå°±æ˜¯ I2Cx_IADR å¯„å­˜å™¨ä¸­çš„åœ°å€æ˜¯ä»è®¾å¤‡åœ°å€ã€‚</li>
<li><strong>IBB(bit5)ï¼š</strong> I2C æ€»çº¿å¿™æ ‡å¿—ä½ï¼Œå½“ä¸º 0 çš„æ—¶å€™è¡¨ç¤º I2C æ€»çº¿ç©ºé—²ï¼Œä¸º 1 çš„æ—¶å€™è¡¨ç¤º I2C æ€»çº¿å¿™ã€‚</li>
<li><strong>IAL(bit4)ï¼š</strong>ä»²è£ä¸¢å¤±ä½ï¼Œä¸º 1 çš„æ—¶å€™è¡¨ç¤ºå‘ç”Ÿä»²è£ä¸¢å¤±ã€‚</li>
<li><strong>SRW(bit2)ï¼š</strong>ä»æœºè¯»å†™çŠ¶æ€ä½ï¼Œå½“ I2C ä½œä¸ºä»æœºçš„æ—¶å€™ä½¿ç”¨ï¼Œæ­¤ä½ç”¨æ¥è¡¨æ˜ä¸»æœºå‘é€ç»™ä»æœºçš„æ˜¯è¯»è¿˜æ˜¯å†™å‘½ä»¤ã€‚ä¸º 0 çš„æ—¶å€™è¡¨ç¤ºä¸»æœºè¦å‘ä»æœºå†™æ•°æ®ï¼Œä¸º 1 çš„æ—¶å€™è¡¨ç¤ºä¸»æœºè¦ä»ä»æœºè¯»å–æ•°æ®ã€‚</li>
<li><strong>IIF(bit1)ï¼š</strong> I2C ä¸­æ–­æŒ‚èµ·æ ‡å¿—ä½ï¼Œå½“ä¸º 1 çš„æ—¶å€™è¡¨ç¤ºæœ‰ä¸­æ–­æŒ‚èµ·ï¼Œæ­¤ä½éœ€è¦è½¯ä»¶æ¸…é›¶ã€‚</li>
<li><strong>RXAK(bit0)ï¼š</strong> åº”ç­”ä¿¡å·æ ‡å¿—ä½ï¼Œä¸º 0 çš„æ—¶å€™è¡¨ç¤ºæ¥æ”¶åˆ° ACK åº”ç­”ä¿¡å·ï¼Œä¸º 1 çš„è¯è¡¨ç¤ºæ£€æµ‹åˆ° NO ACK ä¿¡å·ã€‚</li>
</ul>
<h3 id="1-5-I2Cx-I2DR-x-1-4"><a href="#1-5-I2Cx-I2DR-x-1-4" class="headerlink" title="1.5Â I2Cx_I2DR     (x&#x3D;1~4)  "></a><font size=3>1.5Â I2Cx_I2DR     (x&#x3D;1~4)  </font></h3><p>è¿™ä¸ªå¯ä»¥çœ‹ã€Š <a target="_blank" rel="noopener" href="https://www.nxp.com.cn/webapp/Download?colCode=IMX6ULLRM&lang_cd=zh">i.MX 6ULL Applications Processor Reference Manual</a>ã€‹â€”â€” 31.7.5 I2C Data I&#x2F;O Register (I2Cx_I2DR)   ï¼Œè¿™æ˜¯ I2C çš„æ•°æ®å¯„å­˜å™¨ï¼Œæ­¤å¯„å­˜å™¨åªæœ‰ä½ 8 ä½æœ‰æ•ˆï¼Œå½“è¦å‘é€æ•°æ®çš„æ—¶å€™å°†è¦å‘é€çš„æ•°æ®å†™å…¥åˆ°æ­¤å¯„å­˜å™¨ï¼Œå¦‚æœè¦æ¥æ”¶æ•°æ®çš„è¯ç›´æ¥è¯»å–æ­¤å¯„å­˜å™¨å³å¯å¾—åˆ°æ¥æ”¶åˆ°çš„æ•°æ®ã€‚  </p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329110910312.png" alt="image-20250329110910312"  />

<p>â‘ ã€ä¸æ ‡å‡† I2C æ€»çº¿å…¼å®¹ã€‚</p>
<p>â‘¡ã€å¤šä¸»æœºè¿è¡Œ</p>
<p>â‘¢ã€è½¯ä»¶å¯ç¼–ç¨‹çš„ 64 ä¸­ä¸åŒçš„ä¸²è¡Œæ—¶é’Ÿåºåˆ—ã€‚</p>
<p>â‘£ã€è½¯ä»¶å¯é€‰æ‹©çš„åº”ç­”ä½ã€‚â‘¤ã€å¼€å§‹&#x2F;ç»“æŸä¿¡å·ç”Ÿæˆå’Œæ£€æµ‹ã€‚â‘¥ã€é‡å¤å¼€å§‹ä¿¡å·ç”Ÿæˆã€‚â‘¦ã€ç¡®è®¤ä½ç”Ÿæˆã€‚â‘§ã€æ€»çº¿å¿™æ£€æµ‹</p>
<h2 id="2-I2C1-æ§åˆ¶å™¨èŠ‚ç‚¹"><a href="#2-I2C1-æ§åˆ¶å™¨èŠ‚ç‚¹" class="headerlink" title="2.Â  I2C1 æ§åˆ¶å™¨èŠ‚ç‚¹"></a><font size=3>2.Â  I2C1 æ§åˆ¶å™¨èŠ‚ç‚¹</font></h2><p>åœ¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/arch/arm/boot/dts/imx6ul.dtsi#L886">imx6ul.dtsi</a> æ–‡ä»¶ä¸­æ‰¾åˆ° I.MX6U çš„ I2C1 æ§åˆ¶å™¨èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">i2c1: i2c@<span class="number">21</span>a0000 &#123;</span><br><span class="line">	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">	<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line">	compatible = <span class="string">&quot;fsl,imx6ul-i2c&quot;</span>, <span class="string">&quot;fsl,imx21-i2c&quot;</span>;</span><br><span class="line">	reg = &lt;<span class="number">0x021a0000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">	interrupts = &lt;GIC_SPI <span class="number">36</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">	clocks = &lt;&amp;clks IMX6UL_CLK_I2C1&gt;;</span><br><span class="line">	status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250328113804113.png" alt="image-20250328113804113" style="zoom:80%;" />

<p>å¯ä»¥çœ‹åˆ°ï¼ŒI2C1çš„èµ·å§‹åœ°å€å°±æ˜¯0x021A_0000ã€‚ä¸è¿‡è¿™é‡Œé‡ç‚¹å…³æ³¨ i2c1 èŠ‚ç‚¹çš„ compatible å±æ€§å€¼ï¼Œå› ä¸ºé€šè¿‡ compatible å±æ€§å€¼å¯ä»¥åœ¨ Linux æºç é‡Œé¢æ‰¾åˆ°å¯¹åº”çš„é©±åŠ¨æ–‡ä»¶ã€‚</p>
<p>è¿™é‡Œi2c1èŠ‚ç‚¹çš„compatibleå±æ€§å€¼æœ‰ä¸¤ä¸ªï¼šâ€œfsl,imx6ul-i2câ€å’Œâ€œfsl,imx21- i2câ€ï¼Œåœ¨ Linux æºç ä¸­æœç´¢è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²å³å¯æ‰¾åˆ°å¯¹åº”çš„é©±åŠ¨æ–‡ä»¶ã€‚    </p>
<h2 id="3-I2Cé€‚é…å™¨é©±åŠ¨"><a href="#3-I2Cé€‚é…å™¨é©±åŠ¨" class="headerlink" title="3. I2Cé€‚é…å™¨é©±åŠ¨"></a><font size=3>3. I2Cé€‚é…å™¨é©±åŠ¨</font></h2><p>æˆ‘ä»¬æ‰“å¼€ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1244">i2c-imx.c - drivers&#x2F;i2c&#x2F;busses&#x2F;i2c-imx.c</a>æ–‡ä»¶ï¼Œæ‰¾åˆ°è¿™äº›å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">i2c_imx_driver</span> =</span> &#123;</span><br><span class="line">	.probe = i2c_imx_probe,</span><br><span class="line">	.remove = i2c_imx_remove,</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name = DRIVER_NAME,</span><br><span class="line">		.pm = I2C_IMX_PM_OPS,</span><br><span class="line">		.of_match_table = i2c_imx_dt_ids,</span><br><span class="line">	&#125;,</span><br><span class="line">	.id_table = imx_i2c_devtype,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">i2c_adap_imx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> platform_driver_register(&amp;i2c_imx_driver);</span><br><span class="line">&#125;</span><br><span class="line">subsys_initcall(i2c_adap_imx_init);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">i2c_adap_imx_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	platform_driver_unregister(&amp;i2c_imx_driver);</span><br><span class="line">&#125;</span><br><span class="line">module_exit(i2c_adap_imx_exit);</span><br></pre></td></tr></table></figure>

<p>è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨çš„å…¥å£å’Œé€€å‡ºå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°I.MX6U çš„ I2C é€‚é…å™¨é©±åŠ¨æ˜¯ä¸ªæ ‡å‡†çš„ platform é©±åŠ¨ï¼Œç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶ I2C æ€»çº¿ä¸ºåˆ«çš„è®¾å¤‡æä¾›äº†ä¸€ç§æ€»çº¿é©±åŠ¨æ¡†æ¶ï¼Œä½†æ˜¯ I2C é€‚é…å™¨å´æ˜¯ platformé©±åŠ¨ã€‚  </p>
<h3 id="3-1-i2c-imx-driver-of-match-table"><a href="#3-1-i2c-imx-driver-of-match-table" class="headerlink" title="3.1Â i2c_imx_driver.of_match_table"></a><font size=3>3.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1250">i2c_imx_driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/device.h#L287">of_match_table</a></font></h3><p>æ—¢ç„¶æ˜¯platformå¹³å°æ€»çº¿é©±åŠ¨ï¼Œé‚£ä¹ˆå°±å’Œå‰é¢è‚¯å®šæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1250">i2c_imx_driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/device.h#L287">of_match_table</a>ï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„å€¼æ˜¯ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L250">i2c_imx_dt_ids</a> ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">i2c_imx_dt_ids</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;fsl,imx1-i2c&quot;</span>, .data = &amp;imx1_i2c_hwdata, &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;fsl,imx21-i2c&quot;</span>, .data = &amp;imx21_i2c_hwdata, &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;fsl,vf610-i2c&quot;</span>, .data = &amp;vf610_i2c_hwdata, &#125;,</span><br><span class="line">	&#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(of, i2c_imx_dt_ids);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ˜¯å’Œè®¾å¤‡æ ‘è¿›è¡ŒåŒ¹é…çš„åŒ¹é…è¡¨å•¦ï¼Œå‰é¢i2c1çš„å±æ€§ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/arch/arm/boot/dts/imx6ul.dtsi#L889">compatible</a> ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compatible = <span class="string">&quot;fsl,imx6ul-i2c&quot;</span>, <span class="string">&quot;fsl,imx21-i2c&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¿™é‡Œå°±å¯ä»¥åŒ¹é…ä¸Šäº†ã€‚</p>
<h3 id="3-2-i2c-imx-driver-i2c-imx-probe"><a href="#3-2-i2c-imx-driver-i2c-imx-probe" class="headerlink" title="3.2Â i2c_imx_driver. i2c_imx_probe"></a><font size=3>3.2Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1245">i2c_imx_driver</a>. <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1046">i2c_imx_probe</a></font></h3><p>æŒ‰ç…§platformå¹³å°æ€»çº¿çš„é€»è¾‘ï¼Œå½“i2cé€‚é…å™¨å’Œé©±åŠ¨åŒ¹é…åå°±ä¼šè°ƒç”¨  <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1245">i2c_imx_driver</a>. <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1046">i2c_imx_probe</a>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">i2c_imx_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">	<span class="comment">// è°ƒç”¨ platform_get_irq å‡½æ•°è·å–ä¸­æ–­å·ã€‚</span></span><br><span class="line">	irq = platform_get_irq(pdev, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="comment">// è°ƒç”¨ platform_get_resource å‡½æ•°ä»è®¾å¤‡æ ‘ä¸­è·å– I2C1 æ§åˆ¶å™¨å¯„å­˜å™¨ç‰©ç†åŸºåœ°å€ï¼Œä¹Ÿå°±æ˜¯ 0X021A0000ã€‚</span></span><br><span class="line">	res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è·å–åˆ°å¯„å­˜å™¨åŸºåœ°å€ä»¥åä½¿ç”¨ devm_ioremap_resource å‡½æ•°å¯¹å…¶è¿›è¡Œå†…å­˜æ˜ å°„ï¼Œå¾—åˆ°å¯ä»¥åœ¨ Linux å†…æ ¸ä¸­ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€ã€‚</span></span><br><span class="line">	base = devm_ioremap_resource(&amp;pdev-&gt;dev, res);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="comment">// NXP ä½¿ç”¨ imx_i2c_struct ç»“æ„ä½“æ¥è¡¨ç¤º I.MX ç³»åˆ— SOC çš„ I2C æ§åˆ¶å™¨ï¼Œè¿™é‡Œä½¿ç”¨ devm_kzalloc å‡½æ•°æ¥ç”³è¯·å†…å­˜ã€‚</span></span><br><span class="line">	phy_addr = (<span class="type">dma_addr_t</span>)res-&gt;start;</span><br><span class="line">	i2c_imx = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(*i2c_imx), GFP_KERNEL);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="comment">/* Setup i2c_imx driver structure */</span></span><br><span class="line">    <span class="comment">// mx_i2c_struct ç»“æ„ä½“è¦æœ‰ä¸ªå«åš adapter çš„æˆå‘˜å˜é‡ï¼Œ adapter å°±æ˜¯i2c_adapterï¼Œè¿™é‡Œåˆå§‹åŒ–i2c_adapterã€‚</span></span><br><span class="line">	strlcpy(i2c_imx-&gt;adapter.name, pdev-&gt;name, <span class="keyword">sizeof</span>(i2c_imx-&gt;adapter.name));</span><br><span class="line">	i2c_imx-&gt;adapter.owner		= THIS_MODULE;</span><br><span class="line">	i2c_imx-&gt;adapter.algo		= &amp;i2c_imx_algo; <span class="comment">// è®¾ç½®i2c_adapterçš„algoæˆå‘˜å˜é‡ä¸ºi2c_imx_algoï¼Œä¹Ÿå°±æ˜¯è®¾ç½® i2c_algorithmã€‚</span></span><br><span class="line">	i2c_imx-&gt;adapter.dev.parent	= &amp;pdev-&gt;dev;</span><br><span class="line">	i2c_imx-&gt;adapter.nr		= pdev-&gt;id;</span><br><span class="line">	i2c_imx-&gt;adapter.dev.of_node	= pdev-&gt;dev.of_node;</span><br><span class="line">	i2c_imx-&gt;base			= base;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get I2C clock */</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Request IRQ */</span></span><br><span class="line">    <span class="comment">//æ³¨å†Œ I2C æ§åˆ¶å™¨ä¸­æ–­ï¼Œä¸­æ–­æœåŠ¡å‡½æ•°ä¸º i2c_imx_isrã€‚</span></span><br><span class="line">	ret = devm_request_irq(&amp;pdev-&gt;dev, irq, i2c_imx_isr, IRQF_SHARED,</span><br><span class="line">				pdev-&gt;name, i2c_imx);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="comment">/* Set up clock divider */</span></span><br><span class="line">    <span class="comment">//è®¾ç½® I2C é¢‘ç‡é»˜è®¤ä¸º IMX_I2C_BIT_RATE=100KHzï¼Œå¦‚æœè®¾å¤‡æ ‘èŠ‚ç‚¹è®¾ç½®äº†â€œclock-frequencyâ€å±æ€§çš„è¯ I2C é¢‘ç‡å°±ä½¿ç”¨ clock-frequency å±æ€§å€¼ã€‚</span></span><br><span class="line">	i2c_imx-&gt;bitrate = IMX_I2C_BIT_RATE;</span><br><span class="line">	ret = of_property_read_u32(pdev-&gt;dev.of_node,</span><br><span class="line">				   <span class="string">&quot;clock-frequency&quot;</span>, &amp;i2c_imx-&gt;bitrate);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span> &amp;&amp; pdata &amp;&amp; pdata-&gt;bitrate)</span><br><span class="line">		i2c_imx-&gt;bitrate = pdata-&gt;bitrate;</span><br><span class="line">	i2c_imx-&gt;clk_change_nb.notifier_call = i2c_imx_clk_notifier_call;</span><br><span class="line">	clk_notifier_register(i2c_imx-&gt;clk, &amp;i2c_imx-&gt;clk_change_nb);</span><br><span class="line">	i2c_imx_set_clk(i2c_imx, clk_get_rate(i2c_imx-&gt;clk));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set up chip registers to defaults */</span></span><br><span class="line">    <span class="comment">// è®¾ç½® I2C1 æ§åˆ¶çš„ I2CR å’Œ I2SR å¯„å­˜å™¨ã€‚</span></span><br><span class="line">	imx_i2c_write_reg(i2c_imx-&gt;hwdata-&gt;i2cr_ien_opcode ^ I2CR_IEN,</span><br><span class="line">			i2c_imx, IMX_I2C_I2CR);</span><br><span class="line">	imx_i2c_write_reg(i2c_imx-&gt;hwdata-&gt;i2sr_clr_opcode, i2c_imx, IMX_I2C_I2SR);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="comment">/* Add I2C adapter */</span></span><br><span class="line">    <span class="comment">//è°ƒç”¨ i2c_add_numbered_adapter å‡½æ•°å‘ Linux å†…æ ¸æ³¨å†Œ i2c_adapterã€‚</span></span><br><span class="line">	ret = i2c_add_numbered_adapter(&amp;i2c_imx-&gt;adapter);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="comment">/* Init DMA config if supported */</span></span><br><span class="line">    <span class="comment">//ç”³è¯· DMAï¼Œ çœ‹æ¥ I.MX çš„ I2C é€‚é…å™¨é©±åŠ¨é‡‡ç”¨äº† DMA æ–¹å¼ã€‚</span></span><br><span class="line">	i2c_imx_dma_request(i2c_imx, phy_addr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;   <span class="comment">/* Return OK */</span></span><br><span class="line">	<span class="comment">//.......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>i2c_imx_probe å‡½æ•°ä¸»è¦çš„å·¥ä½œå°±æ˜¯ä¸€ä¸‹ä¸¤ç‚¹ï¼šâ‘ ã€åˆå§‹åŒ– i2c_adapterï¼Œè®¾ç½® i2c_algorithm ä¸º i2c_imx_algoï¼Œæœ€åå‘ Linux å†…æ ¸æ³¨å†Œi2c_adapterã€‚â‘¡ã€åˆå§‹åŒ– I2C1 æ§åˆ¶å™¨çš„ç›¸å…³å¯„å­˜å™¨ã€‚</p>
<h3 id="3-3-i2c-imx-algo"><a href="#3-3-i2c-imx-algo" class="headerlink" title="3.3Â i2c_imx_algo"></a><font size=3>3.3Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1041">i2c_imx_algo</a></font></h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1046">i2c_imx_probe()</a>å‡½æ•°çš„<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1084">1084</a>è¡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2c_imx-&gt;adapter.algo		= &amp;i2c_imx_algo;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ˜¯åœ¨è®¾ç½® <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L670">i2c_adapter</a>çš„algoæˆå‘˜å˜é‡ä¸º <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1041">i2c_imx_algo</a> ï¼Œä¹Ÿå°±æ˜¯è®¾ç½® <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L497">i2c_algorithm</a>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_algorithm</span> <span class="title">i2c_imx_algo</span> =</span> &#123;</span><br><span class="line">	.master_xfer	= i2c_imx_xfer, <span class="comment">// å®Œæˆä¸ I2C è®¾å¤‡é€šä¿¡çš„</span></span><br><span class="line">	.functionality	= i2c_imx_func, <span class="comment">// functionalityç”¨äºè¿”å›æ­¤I2Cé€‚é…å™¨æ”¯æŒä»€ä¹ˆæ ·çš„é€šä¿¡åè®®</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å‰é¢æˆ‘ä»¬å°±çŸ¥é“<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L497">i2c_algorithm</a>ä¸­çš„å…³é”®å‡½æ•°**<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L497">i2c_algorithm</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L526">master_xfer()</a>**ç”¨äºäº§ç”Ÿi2cè®¿é—®å‘¨æœŸéœ€è¦çš„start stop ackä¿¡å·ï¼Œä»¥i2c_msgï¼ˆå³i2cæ¶ˆæ¯ï¼‰ä¸ºå•ä½å‘é€å’Œæ¥æ”¶é€šä¿¡æ•°æ®ã€‚åœ¨è¿™é‡Œå°±å¯¹åº” <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L1042">i2c_imx_algo</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L883">i2c_imx_xfer()</a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">i2c_imx_xfer</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adapter,</span></span><br><span class="line"><span class="params">						<span class="keyword">struct</span> i2c_msg *msgs, <span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="comment">/* Start I2C transfer å¼€å¯ I2C é€šä¿¡ */</span></span><br><span class="line">	result = i2c_imx_start(i2c_imx);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="comment">/* read/write data */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (i == num - <span class="number">1</span>)</span><br><span class="line">			is_lastmsg = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (i) &#123;</span><br><span class="line">			dev_dbg(&amp;i2c_imx-&gt;adapter.dev,</span><br><span class="line">				<span class="string">&quot;&lt;%s&gt; repeated start\n&quot;</span>, __func__);</span><br><span class="line">			temp = imx_i2c_read_reg(i2c_imx, IMX_I2C_I2CR);</span><br><span class="line">			temp |= I2CR_RSTA;</span><br><span class="line">			imx_i2c_write_reg(temp, i2c_imx, IMX_I2C_I2CR);</span><br><span class="line">			result = i2c_imx_bus_busy(i2c_imx, <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">if</span> (result)</span><br><span class="line">				<span class="keyword">goto</span> fail0;</span><br><span class="line">		&#125;</span><br><span class="line">		dev_dbg(&amp;i2c_imx-&gt;adapter.dev,</span><br><span class="line">			<span class="string">&quot;&lt;%s&gt; transfer message: %d\n&quot;</span>, __func__, i);</span><br><span class="line">		<span class="comment">/* write/read data */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_I2C_DEBUG_BUS</span></span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">if</span> (msgs[i].flags &amp; I2C_M_RD)</span><br><span class="line">			result = i2c_imx_read(i2c_imx, &amp;msgs[i], is_lastmsg);</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (i2c_imx-&gt;dma &amp;&amp; msgs[i].len &gt;= DMA_THRESHOLD)</span><br><span class="line">				result = i2c_imx_dma_write(i2c_imx, &amp;msgs[i]);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				result = i2c_imx_write(i2c_imx, &amp;msgs[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (result)</span><br><span class="line">			<span class="keyword">goto</span> fail0;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">fail0:</span><br><span class="line">	<span class="comment">/* Stop I2C transfer åœæ­¢ I2C é€šä¿¡ */</span></span><br><span class="line">	i2c_imx_stop(i2c_imx);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="keyword">return</span> (result &lt; <span class="number">0</span>) ? result : num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ¶‰åŠåˆ°è¿™å‡ ä¸ªå‡½æ•°ï¼š<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L523">i2c_imx_start</a>ã€ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L778">i2c_imx_read</a>ã€ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L475">i2c_imx_write</a> å’Œ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-imx.c#L552">i2c_imx_stop()</a>ï¼Œè¿™é‡Œå°±æ˜¯å’Œè£¸æœºä¸­i2cçš„é©±åŠ¨æ˜¯ä¸€æ ·çš„äº†ï¼Œå¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-bare-demo/blob/master/20_i2c/01_i2c_demo/bsp/i2c/bsp_i2c.c">20_i2c&#x2F;01_i2c_demo&#x2F;bsp&#x2F;i2c&#x2F;bsp_i2c.c Â· è‹æœ¨&#x2F;imx6ull-bare-demo - ç äº‘ - å¼€æºä¸­å›½</a>è¿™ä¸ªdemoä¸­çš„i2cå¤–è®¾çš„æ“ä½œè¿›è¡Œç†è§£ã€‚ä¸è¿‡è¿™é‡Œéƒ½æ˜¯ç‰©ç†I2Cçš„æ“ä½œï¼Œå¹¶ä¸æ˜¯ç”¨GPIOæ¨¡æ‹Ÿçš„ï¼Œæ‰€ä»¥éƒ½æ˜¯åœ¨æ“ä½œI2Cå¤–è®¾ç›¸å…³å¯„å­˜å™¨ã€‚<br><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/072_master_xfer_imx6ull.png" alt="image-20210315141442957"></p>
<h3 id="3-4-i2c-adapteræ³¨å†Œ-æ³¨é”€å‡½æ•°"><a href="#3-4-i2c-adapteræ³¨å†Œ-æ³¨é”€å‡½æ•°" class="headerlink" title="3.4Â i2c_adapteræ³¨å†Œ&#x2F;æ³¨é”€å‡½æ•°"></a><font size=3>3.4Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L670">i2c_adapter</a>æ³¨å†Œ&#x2F;æ³¨é”€å‡½æ•°</font></h3><h4 id="3-4-1-i2c-add-adapter"><a href="#3-4-1-i2c-add-adapter" class="headerlink" title="3.4.1Â i2c_add_adapter()"></a><font size=3>3.4.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1346">i2c_add_adapter()</a></font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adapter)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-i2c-add-numbered-adapter"><a href="#3-4-2-i2c-add-numbered-adapter" class="headerlink" title="3.4.2Â i2c_add_numbered_adapter()"></a><font size=3>3.4.2Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1372">i2c_add_numbered_adapter()</a></font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_numbered_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-3-i2c-del-adapter"><a href="#3-4-3-i2c-del-adapter" class="headerlink" title="3.4.3Â i2c_del_adapter()"></a><font size=3>3.4.3Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1450">i2c_del_adapter()</a></font></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">i2c_del_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-ç¼–å†™ä¸€ä¸ªè™šæ‹Ÿçš„i2c-adapter"><a href="#4-ç¼–å†™ä¸€ä¸ªè™šæ‹Ÿçš„i2c-adapter" class="headerlink" title="4. ç¼–å†™ä¸€ä¸ªè™šæ‹Ÿçš„i2c_adapter"></a><font size=3>4. ç¼–å†™ä¸€ä¸ªè™šæ‹Ÿçš„<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L670">i2c_adapter</a></font></h2><h3 id="4-1-è®¾å¤‡æ ‘"><a href="#4-1-è®¾å¤‡æ ‘" class="headerlink" title="4.1 è®¾å¤‡æ ‘"></a><font size=3>4.1 è®¾å¤‡æ ‘</font></h3><p>åœ¨è®¾å¤‡æ ‘æ ¹èŠ‚ç‚¹é‡Œæ„é€ I2C BusèŠ‚ç‚¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">	i2c-bus-virtual &#123;</span><br><span class="line">		 compatible = <span class="string">&quot;alpha,i2c-bus-virtual&quot;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå…¶å®å°±ç›¸å½“äº<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L670">i2c_adapter</a>çš„è®¾å¤‡ã€‚</p>
<h3 id="4-2-é€‚é…å™¨çš„é©±åŠ¨"><a href="#4-2-é€‚é…å™¨çš„é©±åŠ¨" class="headerlink" title="4.2 é€‚é…å™¨çš„é©±åŠ¨"></a><font size=3>4.2 é€‚é…å™¨çš„é©±åŠ¨</font></h3><h4 id="4-2-1-è¦åšå“ªäº›ï¼Ÿ"><a href="#4-2-1-è¦åšå“ªäº›ï¼Ÿ" class="headerlink" title="4.2.1 è¦åšå“ªäº›ï¼Ÿ"></a><font size=3>4.2.1 è¦åšå“ªäº›ï¼Ÿ</font></h4><p>å‰é¢æˆ‘ä»¬çŸ¥é“ I2C é€‚é…å™¨é©±åŠ¨æ˜¯ä¸ªæ ‡å‡†çš„ platform é©±åŠ¨ï¼Œæ‰€ä»¥è¿™é‡Œå…¶å®å°±æŒ‰ç…§ platform é©±åŠ¨çš„ç¼–å†™æµç¨‹ï¼Œè¿›è¡Œåˆ†é…ã€è®¾ç½®ã€æ³¨å†Œplatform_driverç»“æ„ä½“å³å¯ã€‚æ ¸å¿ƒæ˜¯probeå‡½æ•°ï¼Œå®ƒè¦åšè¿™å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>æ ¹æ®è®¾å¤‡æ ‘ä¿¡æ¯è®¾ç½®ç¡¬ä»¶(å¼•è„šã€æ—¶é’Ÿç­‰)</li>
<li>åˆ†é…ã€è®¾ç½®ã€æ³¨å†Œi2c_apdaterï¼Œi2c_apdaterçš„æ ¸å¿ƒæ˜¯master_xferå‡½æ•°ï¼Œå®ƒçš„å®ç°å–å†³äºç¡¬ä»¶ï¼Œå¤§æ¦‚ä»£ç å¦‚ä¸‹</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_master_xfer</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adapter,</span></span><br><span class="line"><span class="params">						<span class="keyword">struct</span> i2c_msg *msgs, <span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> *<span class="title">msg</span> =</span> msgs[i];</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="comment">// 1. å‘å‡ºSä¿¡å·: è®¾ç½®å¯„å­˜å™¨å‘å‡ºSä¿¡å·</span></span><br><span class="line">            CTLREG = S;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. æ ¹æ®Flagå‘å‡ºè®¾å¤‡åœ°å€å’ŒR/Wä½: æŠŠè¿™8ä½æ•°æ®å†™å…¥æŸä¸ªDATAREGå³å¯å‘å‡ºä¿¡å·</span></span><br><span class="line">            <span class="comment">//    åˆ¤æ–­æ˜¯å¦æœ‰ACK</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!ACK)</span><br><span class="line">                <span class="keyword">return</span> ERROR;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">	            <span class="comment">// 3. read / write</span></span><br><span class="line">	            <span class="keyword">if</span> (read) &#123;</span><br><span class="line">                    STATUS = XXX; <span class="comment">// è¿™å†³å®šè¯»åˆ°ä¸€ä¸ªæ•°æ®åæ˜¯å¦å‘å‡ºACKç»™å¯¹æ–¹</span></span><br><span class="line">                    val = DATAREG; <span class="comment">// è¿™ä¼šå‘èµ·I2Cè¯»æ“ä½œ</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(write) &#123;</span><br><span class="line">                    DATAREG = val; <span class="comment">// è¿™ä¼šå‘èµ·I2Cå†™æ“ä½œ</span></span><br><span class="line">                    val = STATUS;  <span class="comment">// åˆ¤æ–­æ˜¯å¦æ”¶åˆ°ACK</span></span><br><span class="line">                    <span class="keyword">if</span> (!ACK)</span><br><span class="line">                        <span class="keyword">return</span> ERROR;</span><br><span class="line">                &#125;                </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 4. å‘å‡ºPä¿¡å·</span></span><br><span class="line">            CTLREG = P;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-i2c-adapteræ¡†æ¶"><a href="#4-2-2-i2c-adapteræ¡†æ¶" class="headerlink" title="4.2.2Â i2c_adapteræ¡†æ¶"></a><font size=3>4.2.2Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L670">i2c_adapter</a>æ¡†æ¶</font></h4><p>æ¡†æ¶ä»£ç å¯ä»¥çœ‹è¿™é‡Œï¼š<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/blob/master/30_i2c_subsystem/02_i2c_adapter_virtual/drivers_demo/sdriver_demo.c">30_i2c_subsystem&#x2F;02_i2c_adapter_virtual&#x2F;drivers_demo&#x2F;sdriver_demo.c Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a>ï¼Œæ›´æ–°è®¾å¤‡æ ‘ï¼Œç„¶ååŠ è½½é©±åŠ¨ï¼Œæˆ‘ä»¬ç”¨i2cdetectåˆ—å‡ºæ‰€æœ‰çš„i2cæ€»çº¿ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2cdetect -l</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330145705461.png" alt="image-20250330145705461" />

<p><strong>æ³¨æ„</strong>ï¼šä¸åŒçš„æ¿å­ä¸Šï¼Œi2c-bus-virtualçš„æ€»çº¿å·å¯èƒ½ä¸ä¸€æ ·ï¼Œä¸Šé—®ä¸­æ€»çº¿å·æ˜¯4ã€‚</p>
<p>æˆ‘ä»¬åœ¨è¿™ä¸ªæ€»çº¿ä¸Šåˆ›å»ºä¸€ä¸ªi2cè®¾å¤‡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo sdeveeprom 0x50 &gt; /sys/bus/i2c/devices/i2c-4/new_device</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330163641600.png" alt="image-20250330163641600" />

<p>å‘ç°ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<h4 id="4-2-3-æ¨¡æ‹ŸEEPROM"><a href="#4-2-3-æ¨¡æ‹ŸEEPROM" class="headerlink" title="4.2.3 æ¨¡æ‹ŸEEPROM"></a><font size=3>4.2.3 æ¨¡æ‹ŸEEPROM</font></h4><p>åœ¨å‰é¢å®Œæˆçš„è™šæ‹Ÿçš„I2C_Adapteré©±åŠ¨æ¡†æ¶é‡Œï¼Œåªè¦å®ç°äº†å…¶ä¸­çš„master_xferå‡½æ•°ï¼Œè¿™ä¸ªI2C Adapterå°±å¯ä»¥ä½¿ç”¨äº†ã€‚åœ¨master_xferå‡½æ•°é‡Œï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ªEEPROMï¼Œæ€è·¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ†é…ä¸€ä¸ª512å­—èŠ‚çš„bufferï¼Œè¡¨ç¤ºEEPROM</li>
<li>å¯¹äºslave addressä¸º0x50çš„i2c_msgï¼Œè§£æå¹¶å¤„ç†</li>
</ul>
<p>å¯¹äºå†™ï¼šæŠŠi2c_msgçš„æ•°æ®å†™å…¥bufferã€‚å¯¹äºè¯»ï¼šä»bufferä¸­æŠŠæ•°æ®å†™å…¥i2c_msgã€‚</p>
<ul>
<li>å¯¹äºslave addressä¸ºå…¶ä»–å€¼çš„i2c_msgï¼Œè¿”å›é”™è¯¯</li>
</ul>
<p>å®Œæ•´çš„demoçœ‹è¿™é‡Œï¼š<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/tree/master/30_i2c_subsystem/03_i2c_adapter_virtual_ok">30_i2c_subsystem&#x2F;03_i2c_adapter_virtual_ok Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<h3 id="4-3-æ¨¡æ‹ŸEEPROM-demo"><a href="#4-3-æ¨¡æ‹ŸEEPROM-demo" class="headerlink" title="4.3 æ¨¡æ‹ŸEEPROM demo"></a><font size=3>4.3 æ¨¡æ‹ŸEEPROM demo</font></h3><h4 id="4-3-1-demoæºç "><a href="#4-3-1-demoæºç " class="headerlink" title="4.3.1 demoæºç "></a><font size=3>4.3.1 demoæºç </font></h4><p>demoæºç çœ‹è¿™é‡Œï¼š<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/tree/master/30_i2c_subsystem/03_i2c_adapter_virtual_ok">30_i2c_subsystem&#x2F;03_i2c_adapter_virtual_ok Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<h4 id="4-3-2-æµ‹è¯•ç»“æœ"><a href="#4-3-2-æµ‹è¯•ç»“æœ" class="headerlink" title="4.3.2 æµ‹è¯•ç»“æœ"></a><font size=3>4.3.2 æµ‹è¯•ç»“æœ</font></h4><p>æ›´æ–°å¼€å‘æ¿ä¸­çš„è®¾å¤‡æ ‘ï¼Œç„¶ååº”è¯¥å¯ä»¥<code>i2c/devices/</code>åœ¨çœ‹åˆ°å¯¹åº”çš„i2cé€‚é…å™¨ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330164220088.png" alt="image-20250330164220088" />

<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨i2c-toolsè¿›è¡Œæµ‹è¯•ï¼š</p>
<ul>
<li>åˆ—å‡ºI2Cæ€»çº¿</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2cdetect -l</span><br></pre></td></tr></table></figure>

<p>ç»“æœç±»ä¼¼ä¸‹åˆ—çš„ä¿¡æ¯ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330164312223.png" alt="image-20250330164312223" />

<p><strong>æ³¨æ„</strong>ï¼šä¸åŒçš„æ¿å­ä¸Šï¼Œi2c-bus-virtualçš„æ€»çº¿å·å¯èƒ½ä¸ä¸€æ ·ï¼Œä¸Šé—®ä¸­æ€»çº¿å·æ˜¯4ã€‚</p>
<ul>
<li>æ£€æŸ¥è™šæ‹Ÿæ€»çº¿ä¸‹çš„I2Cè®¾å¤‡</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‡è®¾è™šæ‹ŸI2C BUSå·ä¸º4</span></span><br><span class="line">i2cdetect -y -a 4</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330164613670.png" alt="image-20250330164613670" />

<p>è¿™é‡Œä¼¼ä¹å¹¶ä¸éœ€è¦è‡ªå·±åˆ›å»ºè®¾å¤‡ã€‚</p>
<ul>
<li>è¯»å†™æ¨¡æ‹Ÿçš„EEPROM</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">i2cset -f -y 4 0x50 0 0x55   # å‡è®¾è™šæ‹ŸI2C BUSå·ä¸º4 å¾€0åœ°å€å†™å…¥0x55</span><br><span class="line">i2cget -f -y 4 0x50 0        # è¯»0åœ°å€</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330164711276.png" alt="image-20250330164711276" />

<h1 id="ä¸‰ã€GPIOæ¨¡æ‹ŸI2C"><a href="#ä¸‰ã€GPIOæ¨¡æ‹ŸI2C" class="headerlink" title="ä¸‰ã€GPIOæ¨¡æ‹ŸI2C"></a><font size=3>ä¸‰ã€GPIOæ¨¡æ‹ŸI2C</font></h1><h2 id="1-GPIOæ¨¡æ‹ŸI2Cç®€ä»‹"><a href="#1-GPIOæ¨¡æ‹ŸI2Cç®€ä»‹" class="headerlink" title="1. GPIOæ¨¡æ‹ŸI2Cç®€ä»‹"></a><font size=3>1. GPIOæ¨¡æ‹ŸI2Cç®€ä»‹</font></h2><p>åœ¨Linuxé¡¹ç›®ä¸­ï¼Œå¦‚æœå‡ºç°ç¡¬ä»¶I2Cä¸å¤Ÿç”¨çš„æƒ…å†µï¼Œå°±å¯ä»¥ä½¿ç”¨æ¨¡æ‹Ÿi2cæ¥è§£å†³ã€‚å…¶å®I2Cåªæ˜¯è§„å®šäº†æ•°æ®ä¼ è¾“çš„åè®®ï¼Œå¹¶æ²¡æœ‰è¯´ä¸€å®šè¦ä½¿ç”¨ç‰©ç†çš„I2Cå¤–è®¾ï¼Œæˆ‘ä»¬çŸ¥é“2Cåè®®ä¿¡å·å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/009_i2c_signal.png" alt="image-20210220151524099"></p>
<p>è¿™é‡Œå…¶å®å°±æ˜¯ä¸€æ ¹æ—¶é’Ÿçº¿ï¼Œä¸€æ ¹æ•°æ®çº¿ï¼Œè¿™äº›æˆ‘ä»¬å®Œå…¨å¯ä»¥ç”¨ä¸¤ä¸ªGPIOæ¥è¿›è¡Œæ¨¡æ‹Ÿã€‚ä¹‹å‰å­¦ä¹ å•ç‰‡æœºçš„æ—¶å€™å…¶å®ä¸€å¼€å§‹ç”¨çš„éƒ½æ˜¯gpioæ¨¡æ‹Ÿi2cï¼š<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/stm32f103-prj/blob/master/STM32_HAL_Prj/Drivers/BSP/IIC/myiic.c">STM32_HAL_Prj&#x2F;Drivers&#x2F;BSP&#x2F;IIC&#x2F;myiic.c Â· è‹æœ¨&#x2F;STM32F103-Prj - ç äº‘ - å¼€æºä¸­å›½</a></p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329131418887.png" alt="image-20250329131418887"  />

<p>ä½¿ç”¨GPIOæ¨¡æ‹ŸI2Cçš„è¦ç‚¹ï¼š</p>
<ul>
<li>å¼•è„šè®¾ä¸ºGPIOã€‚</li>
<li>GPIOè®¾ä¸ºè¾“å‡ºã€å¼€æ&#x2F;å¼€æ¼(open collector&#x2F;open drain)ã€‚</li>
<li>è¦æœ‰ä¸Šæ‹‰ç”µé˜»ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸Šæ‹‰ç”µé˜»ï¼Œåœ¨å‰é¢å·²ç»å­¦ä¹ è¿‡äº†ï¼Œä¸»è¦å°±æ˜¯å¯ä»¥æ–¹ä¾¿çš„å®ç°æ•°æ®åŒå‘ä¼ è¾“ã€‚ä»¥åŠå®ç°å¤šä¸ªè®¾å¤‡å¯¹I2Cæ€»çº¿çš„ä½¿ç”¨ã€‚</li>
</ul>
<h2 id="2-GPIOå¼•è„šå®šä¹‰"><a href="#2-GPIOå¼•è„šå®šä¹‰" class="headerlink" title="2. GPIOå¼•è„šå®šä¹‰"></a><font size=3>2. GPIOå¼•è„šå®šä¹‰</font></h2><p>æ—¢ç„¶æ˜¯GPIOæ¨¡æ‹ŸI2Cï¼Œé‚£å…¶å®ï¼Œåªéœ€è¦ä¸¤ä¸ªI2Cå°±å¯ä»¥äº†ï¼Œä½†æ˜¯åœ¨ä¸åŒç‰ˆæœ¬çš„å†…æ ¸ä¸­ï¼Œä¼šæ”¯æŒä¸€äº›æ–°çš„å†™æ³•ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/Documentation/devicetree/bindings/i2c/i2c-gpio.txt">i2c-gpio.txt - Documentation&#x2F;devicetree&#x2F;bindings&#x2F;i2c&#x2F;i2c-gpio.txt - Linux source code v4.19.71</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Example nodes:</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dt-bindings/gpio/gpio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">i2c@<span class="number">0</span> &#123;</span><br><span class="line">	compatible = <span class="string">&quot;i2c-gpio&quot;</span>;</span><br><span class="line">	sda-gpios = &lt;&amp;pioA <span class="number">23</span> (GPIO_ACTIVE_HIGH|GPIO_OPEN_DRAIN)&gt;;</span><br><span class="line">	scl-gpios = &lt;&amp;pioA <span class="number">24</span> (GPIO_ACTIVE_HIGH|GPIO_OPEN_DRAIN)&gt;;</span><br><span class="line">	i2c-gpio,delay-us = &lt;<span class="number">2</span>&gt;;	<span class="comment">/* ~100 kHz */</span></span><br><span class="line">	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">	<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"></span><br><span class="line">	rv3029c2@<span class="number">56</span> &#123;</span><br><span class="line">		compatible = <span class="string">&quot;rv3029c2&quot;</span>;</span><br><span class="line">		reg = &lt;<span class="number">0x56</span>&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.1.15/source/Documentation/devicetree/bindings/i2c/i2c-gpio.txt">i2c-gpio.txt - Documentation&#x2F;devicetree&#x2F;bindings&#x2F;i2c&#x2F;i2c-gpio.txt - Linux source code v4.1.15</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">i2c@<span class="number">0</span> &#123;</span><br><span class="line">	compatible = <span class="string">&quot;i2c-gpio&quot;</span>;</span><br><span class="line">	gpios = &lt;&amp;pioA <span class="number">23</span> <span class="number">0</span> <span class="comment">/* sda */</span></span><br><span class="line">		 &amp;pioA <span class="number">24</span> <span class="number">0</span> <span class="comment">/* scl */</span></span><br><span class="line">		&gt;;</span><br><span class="line">	i2c-gpio,sda-open-drain;</span><br><span class="line">	i2c-gpio,scl-open-drain;</span><br><span class="line">	i2c-gpio,delay-us = &lt;<span class="number">2</span>&gt;;	<span class="comment">/* ~100 kHz */</span></span><br><span class="line">	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">	<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"></span><br><span class="line">	rv3029c2@<span class="number">56</span> &#123;</span><br><span class="line">		compatible = <span class="string">&quot;rv3029c2&quot;</span>;</span><br><span class="line">		reg = &lt;<span class="number">0x56</span>&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3-i2c-gpioåŸºæœ¬æ¡†æ¶"><a href="#3-i2c-gpioåŸºæœ¬æ¡†æ¶" class="headerlink" title="3. i2c-gpioåŸºæœ¬æ¡†æ¶"></a><font size=3>3. i2c-gpioåŸºæœ¬æ¡†æ¶</font></h2><p>Lnuxå†…æ ¸çš„<strong>i2c-gpio</strong>æ˜¯ä½¿ç”¨GPIOæ¨¡æ‹ŸI2Cåè®®çš„é©±åŠ¨ï¼Œåœ¨å†…æ ¸ä¸­å·²ç»å®ç°äº†ï¼Œæˆ‘ä»¬è¦åšçš„åªéœ€è¦é…ç½®2ä¸ªGPIOï¼ˆSDAå’ŒSCLï¼‰å³å¯ã€‚</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329140210360.png" alt="image-20250329140210360"  />

<ul>
<li><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c">i2c-gpio.c - drivers&#x2F;i2c&#x2F;busses&#x2F;i2c-gpio.c</a></li>
</ul>
<p>ï¼ˆ1ï¼‰è§£æè®¾å¤‡æ ‘ä¸­çš„å¼•è„šé…ç½®ä¿¡æ¯</p>
<p>ï¼ˆ2ï¼‰æä¾›GPIO SDAå’ŒSCLå¼•è„šé…ç½®æ¥å£ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c">i2c-algo-bit.c - drivers&#x2F;i2c&#x2F;algos&#x2F;i2c-algo-bit.c</a></li>
</ul>
<p>ï¼ˆ1ï¼‰å‘I2C Coreæ³¨å†Œä¸€ä¸ªadapter</p>
<p>ï¼ˆ2ï¼‰æä¾›I2Cé€šä¿¡æ—¶çš„ç®—æ³•ï¼Œç„¶åé€šè¿‡<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c">i2c-gpio.c</a>æä¾›GPIOé…ç½®æ¥å£æ¥æ”¶å‘æ•°æ®ã€‚</p>
<blockquote>
<p>æ³¨å†ŒæˆåŠŸåï¼Œ<code>&quot;i2c-dev&quot;</code>é©±åŠ¨å°±ä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„<code>&quot;/dev/i2c-x&quot;</code>å­—ç¬¦è®¾å¤‡ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨åº”ç”¨å±‚å’Œé©±åŠ¨å±‚æ“ä½œè¯¥æ€»çº¿ã€‚</p>
</blockquote>
<h2 id="4-å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ¨¡æ‹ŸI2Cï¼Ÿ"><a href="#4-å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ¨¡æ‹ŸI2Cï¼Ÿ" class="headerlink" title="4. å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ¨¡æ‹ŸI2Cï¼Ÿ"></a><font size=3>4. å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ¨¡æ‹ŸI2Cï¼Ÿ</font></h2><h3 id="4-1-é©±åŠ¨ç›¸å…³æ–‡ä»¶æ”¾åœ¨é‚£é‡Œï¼Ÿ"><a href="#4-1-é©±åŠ¨ç›¸å…³æ–‡ä»¶æ”¾åœ¨é‚£é‡Œï¼Ÿ" class="headerlink" title="4.1 é©±åŠ¨ç›¸å…³æ–‡ä»¶æ”¾åœ¨é‚£é‡Œï¼Ÿ"></a><font size=3>4.1 é©±åŠ¨ç›¸å…³æ–‡ä»¶æ”¾åœ¨é‚£é‡Œï¼Ÿ</font></h3><p>GPIOæ¨¡æ‹ŸI2Cåè®®çš„é©±åŠ¨ä½äº <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses">busses - drivers&#x2F;i2c&#x2F;busses</a> ç›®å½•ã€‚é©±åŠ¨åç§°ä¸ºâ€œi2c-gpioâ€ï¼Œé©±åŠ¨æ–‡ä»¶ä¸º<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c">i2c-gpio.c - drivers&#x2F;i2c&#x2F;busses&#x2F;i2c-gpio.c</a>ï¼Œè¿™ä¸ªä¹Ÿæ˜¯platformé©±åŠ¨ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329135722971.png" alt="image-20250329135722971"  />

<h3 id="4-2-ä½¿èƒ½å†…æ ¸çš„I2C-GPIOé©±åŠ¨"><a href="#4-2-ä½¿èƒ½å†…æ ¸çš„I2C-GPIOé©±åŠ¨" class="headerlink" title="4.2 ä½¿èƒ½å†…æ ¸çš„I2C GPIOé©±åŠ¨"></a><font size=3>4.2 ä½¿èƒ½å†…æ ¸çš„I2C GPIOé©±åŠ¨</font></h3><p>æˆ‘ä»¬åœ¨å†…æ ¸æºç ç›®å½•ä¸‹è¾“å…¥ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- imx_v6_v7_defconfig</span><br><span class="line">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- menuconfig</span><br></pre></td></tr></table></figure>

<p>æŒ‰ä»¥ä¸‹è·¯å¾„æ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Device Drivers-&gt;</span><br><span class="line">    I2C support  ---&gt;</span><br><span class="line">        I2C Hardware Bus support  ---&gt;</span><br><span class="line">            &lt;*&gt; GPIO-based bitbanging I2C</span><br></pre></td></tr></table></figure>

<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250329140631954.png" alt="image-20250329140631954"  />

<p>ç¡®è®¤é…ç½®åï¼Œ<code>i2c-gpio</code>ç›¸å…³é©±åŠ¨å°±ä¼šè¢«ç¼–è¯‘è¿›å†…æ ¸ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç¼–è¯‘æˆé©±åŠ¨æ¨¡å—ï¼Œç„¶åæ‰‹åŠ¨åŠ è½½ï¼Œä¸è¿‡è¿˜æ˜¯ç›´æ¥ç¼–è¯‘åˆ°å†…æ ¸æ›´æ–¹ä¾¿ä¸€äº›ã€‚</p>
<h3 id="4-3-è®¾å¤‡æ ‘é…ç½®"><a href="#4-3-è®¾å¤‡æ ‘é…ç½®" class="headerlink" title="4.3 è®¾å¤‡æ ‘é…ç½®"></a><font size=3>4.3 è®¾å¤‡æ ‘é…ç½®</font></h3><h4 id="4-3-1-æ¨¡æ‹ŸI2CèŠ‚ç‚¹"><a href="#4-3-1-æ¨¡æ‹ŸI2CèŠ‚ç‚¹" class="headerlink" title="4.3.1 æ¨¡æ‹ŸI2CèŠ‚ç‚¹"></a><font size=3>4.3.1 æ¨¡æ‹ŸI2CèŠ‚ç‚¹</font></h4><p>i2c-gpioçš„<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L670">i2c_adapter</a>è®¾å¤‡æ ‘èŠ‚ç‚¹è¿™æ ·å†™ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">i2c5:i2c5_gpio &#123;</span><br><span class="line">	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">	<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line">	compatible = <span class="string">&quot;i2c-gpio&quot;</span>;</span><br><span class="line">	gpios = &lt;&amp;gpio1 <span class="number">29</span> GPIO_ACTIVE_HIGH&gt;, 	<span class="comment">/* sda */</span></span><br><span class="line">			&lt;&amp;gpio1 <span class="number">28</span> GPIO_ACTIVE_HIGH&gt;; 	<span class="comment">/* scl */</span></span><br><span class="line">	i2c-gpio,delay-us = &lt;<span class="number">5</span>&gt;;		<span class="comment">/* ~100 kHz */</span></span><br><span class="line">	status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å¼€<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/arch/arm/boot/dts/imx6ul.dtsi#L886">imx6ul.dtsi</a>æ·»åŠ ä»¥ä¸Šå†…å®¹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ·»åŠ éœ€è¦æ¨¡æ‹Ÿi2cçš„gpioçš„æ—¶å€™ï¼Œä¸€å®šæ˜¯å…ˆæ”¾<strong>sda</strong>å†æ”¾<strong>scl</strong>ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨<code>i2c-gpio.c</code>é‡Œé¢å®šä¹‰å¥½çš„ï¼Œå¿…é¡»è¿™ä¹ˆå†™æ‰å¯ä»¥ã€‚</p>
<h4 id="4-3-2-ä¿®æ”¹aliases"><a href="#4-3-2-ä¿®æ”¹aliases" class="headerlink" title="4.3.2 ä¿®æ”¹aliases"></a><font size=3>4.3.2 ä¿®æ”¹aliases</font></h4><p>è¿™é‡Œä»¥ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/arch/arm/boot/dts/imx6ul.dtsi#L34">imx6ul.dtsi - arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ul.dtsi</a> ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">	<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	aliases &#123;</span><br><span class="line">		ethernet0 = &amp;fec1;</span><br><span class="line">		ethernet1 = &amp;fec2;</span><br><span class="line">		gpio0 = &amp;gpio1;</span><br><span class="line">		gpio1 = &amp;gpio2;</span><br><span class="line">		gpio2 = &amp;gpio3;</span><br><span class="line">		gpio3 = &amp;gpio4;</span><br><span class="line">		gpio4 = &amp;gpio5;</span><br><span class="line">		i2c0 = &amp;i2c1;</span><br><span class="line">		i2c1 = &amp;i2c2;</span><br><span class="line">		i2c2 = &amp;i2c3;</span><br><span class="line">		i2c3 = &amp;i2c4;</span><br><span class="line">        i2c4 = &amp;i2c5; <span class="comment">// è¿™è¡Œæ˜¯æ–°æ·»åŠ çš„</span></span><br><span class="line">		mmc0 = &amp;usdhc1;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>ä¸ºä»€ä¹ˆéœ€è¦ä¿®æ”¹aliaseså‘¢ï¼Ÿ</strong>å› ä¸ºåœ¨æ·»åŠ æ·»åŠ adapteræ—¶ï¼Œä¼šé€šè¿‡<code>aliases</code>çš„åˆ«åç¼–å·é…ç½®<code>adapter-&gt;nr</code>æ€»çº¿ç¼–å·ã€‚æ³¨å†ŒæˆåŠŸåï¼Œä¼šåˆ›å»º<code>/dev/i2c-4</code>è®¾å¤‡ã€‚åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1352">i2c_add_adapter()</a>å‡½æ•°ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adapter)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> =</span> &amp;adapter-&gt;dev;</span><br><span class="line">	<span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dev-&gt;of_node) &#123;</span><br><span class="line">		id = of_alias_get_id(dev-&gt;of_node, <span class="string">&quot;i2c&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			adapter-&gt;nr = id;</span><br><span class="line">			<span class="keyword">return</span> __i2c_add_numbered_adapter(adapter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	adapter-&gt;nr = id;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> i2c_register_adapter(adapter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·åœ¨æ³¨å†Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L670">i2c_adapter</a>çš„æ—¶å€™<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1352">i2c_add_adapter()</a>å‡½æ•°å°±ä¼šè·å–åˆ°å¯¹åº”çš„ä¸€ä¸ªç¼–å·ã€‚</p>
<h4 id="4-3-3-open-drainå±æ€§"><a href="#4-3-3-open-drainå±æ€§" class="headerlink" title="4.3.3 open drainå±æ€§"></a><font size=3>4.3.3 open drainå±æ€§</font></h4><p>ä½¿ç”¨GPIOæ¨¡æ‹ŸI2Cæ¨¡å¼æ—¶ï¼Œä¸€èˆ¬GPIOéœ€è¦å·¥ä½œåœ¨å¼€æ¼æ¨¡å¼ã€‚åœ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c#L203">of_i2c_gpio_get_props()</a>å‡½æ•°ä¸­ï¼Œè§£ææ˜¯å¦æœ‰å®šä¹‰open drainç›¸å…³å±æ€§ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">of_i2c_gpio_get_props</span><span class="params">(<span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params">				  <span class="keyword">struct</span> i2c_gpio_platform_data *pdata)</span></span><br><span class="line">&#123;</span><br><span class="line">	u32 reg;</span><br><span class="line"></span><br><span class="line">	of_property_read_u32(np, <span class="string">&quot;i2c-gpio,delay-us&quot;</span>, &amp;pdata-&gt;udelay);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!of_property_read_u32(np, <span class="string">&quot;i2c-gpio,timeout-ms&quot;</span>, &amp;reg))</span><br><span class="line">		pdata-&gt;timeout = msecs_to_jiffies(reg);</span><br><span class="line"></span><br><span class="line">	pdata-&gt;sda_is_open_drain =</span><br><span class="line">		of_property_read_bool(np, <span class="string">&quot;i2c-gpio,sda-open-drain&quot;</span>);</span><br><span class="line">	pdata-&gt;scl_is_open_drain =</span><br><span class="line">		of_property_read_bool(np, <span class="string">&quot;i2c-gpio,scl-open-drain&quot;</span>);</span><br><span class="line">	pdata-&gt;scl_is_output_only =</span><br><span class="line">		of_property_read_bool(np, <span class="string">&quot;i2c-gpio,scl-output-only&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“å®šä¹‰i2c-gpio,sda-open-drainå’Œi2c-gpio,scl-open-drainå±æ€§åï¼Œè¯´æ˜æ˜¯å…¶å®ƒå­ç³»ç»Ÿå·²ç»å°†è¯¥GPIOé…ç½®æˆå¼€æ¼è¾“å‡ºäº†ï¼Œè¿™é‡Œä¸å†è¿›è¡Œå¼€æ¼çš„é…ç½®ã€‚å¦‚æœdtsé‡Œé¢ä¸å®šä¹‰ï¼Œå°±å¯åŠ¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/gpio/consumer.h#L45">GPIOD_OUT_HIGH_OPEN_DRAIN</a>é…ç½®GPIOï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c#L295">i2c_gpio_probe()</a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pdata-&gt;sda_is_open_drain)</span><br><span class="line">	gflags = GPIOD_OUT_HIGH;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	gflags = GPIOD_OUT_HIGH_OPEN_DRAIN;</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line"><span class="keyword">if</span> (pdata-&gt;scl_is_open_drain)</span><br><span class="line">	gflags = GPIOD_OUT_HIGH;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	gflags = GPIOD_OUT_HIGH_OPEN_DRAIN;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼Œè¿™é‡Œå¯ä»¥ä¸å®šä¹‰è¯¥å±æ€§ï¼Œå®ƒå°†ä¼šåœ¨å‡½æ•°<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c#L295">i2c_gpio_probe()</a>ä¸­é…ç½®ä¸ºå¼€æ¼ã€‚</p>
<h4 id="4-3-4-æ·»åŠ i2cè®¾å¤‡"><a href="#4-3-4-æ·»åŠ i2cè®¾å¤‡" class="headerlink" title="4.3.4 æ·»åŠ i2cè®¾å¤‡"></a><font size=3>4.3.4 æ·»åŠ i2cè®¾å¤‡</font></h4><p>æœ‰äº†i2cé€‚é…å™¨ï¼Œå°±å¯ä»¥æ·»åŠ å¯¹åº”çš„i2cè®¾å¤‡äº†ï¼Œè¿™é‡Œå°±å’Œå‰é¢ä¸€æ ·äº†ã€‚ä¸ºäº†æ–¹ä¾¿åé¢æµ‹è¯•æ¨¡æ‹ŸI2Cæ€»çº¿ï¼Œè¿™é‡Œè¿˜æ˜¯éœ€è¦ä¸€ä¸ªè®¾å¤‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c5 &#123;</span><br><span class="line">	status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">	</span><br><span class="line">	ap3216c@<span class="number">1</span>e &#123;</span><br><span class="line">		compatible = <span class="string">&quot;alpha,ap3216c&quot;</span>;</span><br><span class="line">		reg = &lt;<span class="number">0x1e</span>&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å®é™…çš„è®¾å¤‡æŒ‚è½½åœ¨ä¸Šé¢ï¼Œåé¢å¯ä»¥ç›´æ¥ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ›å»ºæ¨¡æ‹Ÿçš„i2cè®¾å¤‡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// åˆ›å»ºä¸€ä¸ªi2c_client, .name = &quot;eeprom&quot;, .addr=0x50, .adapteræ˜¯i2c-4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span> eeprom 0x50 &gt; /sys/bus/i2c/devices/i2c-4/new_device</span></span><br><span class="line"></span><br><span class="line">// åˆ é™¤ä¸€ä¸ªi2c_client</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span> 0x50 &gt; /sys/bus/i2c/devices/i2c-4/delete_device</span></span><br></pre></td></tr></table></figure>

<h4 id="4-3-5-å¼€å‘æ¿æµ‹è¯•"><a href="#4-3-5-å¼€å‘æ¿æµ‹è¯•" class="headerlink" title="4.3.5 å¼€å‘æ¿æµ‹è¯•"></a><font size=3>4.3.5 å¼€å‘æ¿æµ‹è¯•</font></h4><p>æˆ‘ä»¬æ›´æ–°å¼€å‘æ¿çš„è®¾å¤‡æ ‘ï¼Œå°±ä¼šå‘ç°è¿™é‡Œæ–°å¢äº†<code>/dev/i2c-4</code>æ€»çº¿è®¾å¤‡ï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬æ–°å¢çš„GPIOæ¨¡æ‹ŸI2Cæ€»çº¿è®¾å¤‡ã€‚</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330170557596.png" alt="image-20250330170557596" />

<p>ä½¿ç”¨<code>i2c_tools</code>æµ‹è¯•è¯¥æ€»çº¿ï¼Œå¯ä»¥æ­£å¸¸çš„è¯†åˆ«åˆ°è®¾å¤‡ï¼Œè¯´æ˜ç§»æ¤å·²ç»æˆåŠŸäº†ã€‚ä½†æ˜¯æˆ‘è¿™é‡Œå®é™…ä¸Šå¹¶æ²¡æœ‰æ¥å…¥i2cè®¾å¤‡ï¼Œå°±ç®—æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªi2cè®¾å¤‡ï¼Œä¹Ÿåªä¼šåˆ›å»ºå¯¹åº”çš„è®¾å¤‡ï¼Œä½†æ˜¯i2cdetectä¸ä¼šæœ‰ååº”ï¼Œå› ä¸ºæˆ‘ä»¬å®é™…å¹¶æ²¡æœ‰å¯¹åº”çš„i2cè®¾å¤‡å­˜åœ¨ï¼Œè¿™å°±ä¼šå¯¼è‡´i2cå‘è¿™ä¸ªåœ°å€å‘æ•°æ®çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šæ”¶åˆ°å›åº”ï¼Œæ‰€ä»¥å°±æ¢æµ‹ä¸å‡ºæ¥äº†ï¼š</p>
<img data-src="https://fanhua-picture.oss-cn-hangzhou.aliyuncs.com/01%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/02IMX6ULL%E5%B9%B3%E5%8F%B0/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/LV08-01-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F-04-I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/img/image-20250330170813059.png" alt="image-20250330170813059" />

<h2 id="5-i2c-gpioé©±åŠ¨åˆ†æ"><a href="#5-i2c-gpioé©±åŠ¨åˆ†æ" class="headerlink" title="5. i2c-gpioé©±åŠ¨åˆ†æ"></a><font size=3>5. i2c-gpioé©±åŠ¨åˆ†æ</font></h2><p>å‰é¢çŸ¥é“ï¼ŒGPIOæ¨¡æ‹ŸI2Cåè®®çš„é©±åŠ¨ä½äº <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses">busses - drivers&#x2F;i2c&#x2F;busses</a> ç›®å½•ã€‚é©±åŠ¨åç§°ä¸ºâ€œi2c-gpioâ€ï¼Œé©±åŠ¨æ–‡ä»¶ä¸º<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c">i2c-gpio.c - drivers&#x2F;i2c&#x2F;busses&#x2F;i2c-gpio.c</a>ï¼Œæ˜¯ä¸€ä¸ªå¹³å°è®¾å¤‡é©±åŠ¨ï¼Œå®ƒçš„å¹³å°è®¾å¤‡é©±åŠ¨ç»“æ„ä½“ä¸º <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c#L399">i2c_gpio_driver</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">i2c_gpio_driver</span> =</span> &#123;</span><br><span class="line">	.driver		= &#123;</span><br><span class="line">		.name	= <span class="string">&quot;i2c-gpio&quot;</span>,</span><br><span class="line">		.of_match_table	= of_match_ptr(i2c_gpio_dt_ids),</span><br><span class="line">	&#125;,</span><br><span class="line">	.probe		= i2c_gpio_probe,</span><br><span class="line">	.remove		= i2c_gpio_remove,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-i2c-gpio-driver-driver-of-match-table"><a href="#5-1-i2c-gpio-driver-driver-of-match-table" class="headerlink" title="5.1Â i2c_gpio_driver.driver.of_match_table"></a><font size=3>5.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c#L402">i2c_gpio_driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/platform_device.h#L186">driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/device.h#L287">of_match_table</a></font></h3><p>å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåŒ¹é…è¡¨ï¼Œå¯¹åº”çš„æ•°ç»„ä¸º <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c#L391">i2c_gpio_dt_ids</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">i2c_gpio_dt_ids</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;i2c-gpio&quot;</span>, &#125;,</span><br><span class="line">	&#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MODULE_DEVICE_TABLE(of, i2c_gpio_dt_ids);</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬å‰é¢å®šä¹‰çš„æ¨¡æ‹ŸI2Cçš„compatibleå±æ€§åç§°å°±åŒ…å«çš„æœ‰â€i2c-gpioâ€ã€‚</p>
<h3 id="5-2-i2c-gpio-driver-probe"><a href="#5-2-i2c-gpio-driver-probe" class="headerlink" title="5.2Â i2c_gpio_driver.probe"></a><font size=3>5.2Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c#L404">i2c_gpio_driver</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/platform_device.h#L181">probe</a></font></h3><p>å½“i2cé€‚é…å™¨è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œ.probeå‡½æ•°ï¼Œåœ¨è¿™é‡Œå°±æ˜¯<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c#L257">i2c_gpio_probe()</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">i2c_gpio_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="comment">// (1)è§£æè®¾å¤‡æ ‘</span></span><br><span class="line">	<span class="keyword">if</span> (np) &#123;</span><br><span class="line">		of_i2c_gpio_get_props(np, pdata);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">// (2)è§£ædtsè®¾å¤‡æ ‘æ–‡ä»¶é‡Œé¢å®šä¹‰gpiosé…ç½®ï¼šgpios = &lt;&amp;gpio1 29 GPIO_ACTIVE_HIGH&gt;, &lt;&amp;gpio1 28 GPIO_ACTIVE_HIGH&gt;;</span></span><br><span class="line">    <span class="keyword">if</span> (pdata-&gt;sda_is_open_drain)</span><br><span class="line">		gflags = GPIOD_OUT_HIGH;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		gflags = GPIOD_OUT_HIGH_OPEN_DRAIN;</span><br><span class="line">	priv-&gt;sda = i2c_gpio_get_desc(dev, <span class="string">&quot;sda&quot;</span>, <span class="number">0</span>, gflags);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(priv-&gt;sda))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(priv-&gt;sda);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pdata-&gt;scl_is_open_drain)</span><br><span class="line">		gflags = GPIOD_OUT_HIGH;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		gflags = GPIOD_OUT_HIGH_OPEN_DRAIN;</span><br><span class="line">	priv-&gt;scl = i2c_gpio_get_desc(dev, <span class="string">&quot;scl&quot;</span>, <span class="number">1</span>, gflags);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(priv-&gt;scl))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(priv-&gt;scl);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="comment">// (3)é…ç½®æ“ä½œSDAå’ŒSCL 2ä¸ªGPIOçš„å‡½æ•°æ¥å£ï¼Œåé¢å¯ä»¥é€šè¿‡å®ƒè®¾ç½®å’Œè·å–GPIOçš„é«˜ä½ç”µå¹³</span></span><br><span class="line">	bit_data-&gt;setsda = i2c_gpio_setsda_val;</span><br><span class="line">	bit_data-&gt;setscl = i2c_gpio_setscl_val;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pdata-&gt;scl_is_output_only)</span><br><span class="line">		bit_data-&gt;getscl = i2c_gpio_getscl;</span><br><span class="line">	bit_data-&gt;getsda = i2c_gpio_getsda;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="comment">// (4)æ³¨å†Œåˆ°i2c-algo-bit.c</span></span><br><span class="line">	adap-&gt;algo_data = bit_data;</span><br><span class="line">	adap-&gt;<span class="class"><span class="keyword">class</span> =</span> I2C_CLASS_HWMON | I2C_CLASS_SPD;</span><br><span class="line">	adap-&gt;dev.parent = dev;</span><br><span class="line">	adap-&gt;dev.of_node = np;</span><br><span class="line"></span><br><span class="line">	adap-&gt;nr = pdev-&gt;id;</span><br><span class="line">	ret = i2c_bit_add_numbered_bus(adap);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-1-è§£æè®¾å¤‡æ ‘"><a href="#5-2-1-è§£æè®¾å¤‡æ ‘" class="headerlink" title="5.2.1 è§£æè®¾å¤‡æ ‘"></a><font size=3>5.2.1 è§£æè®¾å¤‡æ ‘</font></h4><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ª <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/busses/i2c-gpio.c#L203">of_i2c_gpio_get_props()</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">of_i2c_gpio_get_props</span><span class="params">(<span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params">				  <span class="keyword">struct</span> i2c_gpio_platform_data *pdata)</span></span><br><span class="line">&#123;</span><br><span class="line">	u32 reg;</span><br><span class="line"></span><br><span class="line">	of_property_read_u32(np, <span class="string">&quot;i2c-gpio,delay-us&quot;</span>, &amp;pdata-&gt;udelay);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!of_property_read_u32(np, <span class="string">&quot;i2c-gpio,timeout-ms&quot;</span>, &amp;reg))</span><br><span class="line">		pdata-&gt;timeout = msecs_to_jiffies(reg);</span><br><span class="line"></span><br><span class="line">	pdata-&gt;sda_is_open_drain =</span><br><span class="line">		of_property_read_bool(np, <span class="string">&quot;i2c-gpio,sda-open-drain&quot;</span>);</span><br><span class="line">	pdata-&gt;scl_is_open_drain =</span><br><span class="line">		of_property_read_bool(np, <span class="string">&quot;i2c-gpio,scl-open-drain&quot;</span>);</span><br><span class="line">	pdata-&gt;scl_is_output_only =</span><br><span class="line">		of_property_read_bool(np, <span class="string">&quot;i2c-gpio,scl-output-only&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>i2c-gpio,delay-usï¼šé…ç½®æ¯ä¸ªbitçš„ä½¿ç”¨æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯I2Cé€šä¿¡æ—¶Clockçš„é¢‘ç‡ã€‚</li>
<li>i2c-gpio,timeout-msï¼šé…ç½®i2cé€šä¿¡æ—¶çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´æ²¡æœ‰æ”¶åˆ°ackï¼Œè¯´æ˜é€šä¿¡å¤±è´¥ã€‚</li>
<li>i2c-gpio,sda-open-drainï¼šæ˜¯å¦æœ‰åœ¨å…¶å®ƒå­ç³»ç»Ÿé‡Œé¢å®šä¹‰äº†sda gpioä¸ºå¼€æ¼æ¨¡å¼ï¼Œå¦‚æœæœ‰å°±å®šä¹‰è¯¥å±æ€§ã€‚</li>
<li>i2c-gpio,scl-open-drainï¼šæ˜¯å¦æœ‰åœ¨å…¶å®ƒå­ç³»ç»Ÿé‡Œé¢å®šä¹‰äº†scl gpioä¸ºå¼€æ¼æ¨¡å¼ï¼Œå¦‚æœæœ‰å°±å®šä¹‰è¯¥å±æ€§ã€‚</li>
<li>i2c-gpio,scl-output-onlyï¼šé…ç½®scl gpioåªæ”¯æŒè¾“å‡ºæ¨¡å¼ï¼Œä¸æ”¯æŒè¾“å…¥æ¨¡å¼ã€‚</li>
</ul>
<h4 id="5-2-2-æ³¨å†Œåˆ°i2c-algo-bit-c"><a href="#5-2-2-æ³¨å†Œåˆ°i2c-algo-bit-c" class="headerlink" title="5.2.2Â æ³¨å†Œåˆ°i2c-algo-bit.c"></a><font size=3>5.2.2Â æ³¨å†Œåˆ°i2c-algo-bit.c</font></h4><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L680">i2c_bit_add_numbered_bus()</a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_bit_add_numbered_bus</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> __i2c_bit_add_bus(adap, i2c_add_numbered_adapter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ƒè°ƒç”¨çš„æ˜¯<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L639">__i2c_bit_add_busr()</a>å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __i2c_bit_add_bus(<span class="keyword">struct</span> i2c_adapter *adap,</span><br><span class="line">			     <span class="type">int</span> (*add_adapter)(<span class="keyword">struct</span> i2c_adapter *))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* register new adapter to i2c module... */</span></span><br><span class="line">	adap-&gt;algo = &amp;i2c_bit_algo;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	ret = add_adapter(adap);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¸ºi2c-gpioæ·»åŠ äº†å¯¹åº”çš„ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/include/linux/i2c.h#L497">i2c_algorithm</a> ï¼Œè¿™é‡Œå¯¹åº”çš„æ˜¯ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L626">i2c_bit_algo</a>ï¼Œå®ƒçš„master_xferæˆå‘˜æŒ‡å‘çš„å‡½æ•°å°±ä¸ºæ¨¡æ‹Ÿi2cæ·»åŠ ç”¨äºäº§ç”Ÿi2cè®¿é—®å‘¨æœŸéœ€è¦çš„start stop ackä¿¡å·æ“ä½œå‡½æ•°ã€‚å°±ç®—æˆ‘ä»¬è‡ªå·±å†™GPIOæ¨¡æ‹ŸI2Cé©±åŠ¨ï¼Œä¹Ÿéƒ½å¿…é¡»å®ç°è¿™äº›å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_algorithm</span> <span class="title">i2c_bit_algo</span> =</span> &#123;</span><br><span class="line">	.master_xfer	= bit_xfer,</span><br><span class="line">	.functionality	= bit_func,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæˆ‘ä»¬åé¢å†çœ‹ã€‚ç„¶åå°±æ˜¯è°ƒç”¨ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/net/ethernet/chelsio/cxgb3/cxgb3_offload.c#L1203">add_adapter()</a> å‘I2C Coreæ³¨å†Œä¸€ä¸ªadapterï¼Œæ³¨å†ŒæˆåŠŸåï¼Œ<code>&quot;i2c-dev&quot;</code>é©±åŠ¨å°±ä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„<code>&quot;/dev/i2c-x&quot;</code>å­—ç¬¦è®¾å¤‡ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨åº”ç”¨å±‚å’Œé©±åŠ¨å±‚æ“ä½œè¯¥æ€»çº¿ã€‚</p>
<h3 id="5-3-i2c-bit-algo"><a href="#5-3-i2c-bit-algo" class="headerlink" title="5.3Â i2c_bit_algo"></a><font size=3>5.3Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L626">i2c_bit_algo</a></font></h3><h4 id="5-3-1-i2c-bit-algo-functionality"><a href="#5-3-1-i2c-bit-algo-functionality" class="headerlink" title="5.3.1Â i2c_bit_algo.functionality"></a><font size=3>5.3.1Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L626">i2c_bit_algo</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L628">functionality</a></font></h4><p> <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L626">i2c_bit_algo</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L628">functionality</a>å¯¹åº”çš„å‡½æ•°æ˜¯<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L615">bit_func()</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> u32 <span class="title function_">bit_func</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> I2C_FUNC_I2C | I2C_FUNC_NOSTART | I2C_FUNC_SMBUS_EMUL |</span><br><span class="line">	       I2C_FUNC_SMBUS_READ_BLOCK_DATA |</span><br><span class="line">	       I2C_FUNC_SMBUS_BLOCK_PROC_CALL |</span><br><span class="line">	       I2C_FUNC_10BIT_ADDR | I2C_FUNC_PROTOCOL_MANGLING;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ˜¯è¿”å›æ”¯æŒçš„I2Cåè®®ã€‚</p>
<h4 id="5-3-2-i2c-bit-algo-master-xfer"><a href="#5-3-2-i2c-bit-algo-master-xfer" class="headerlink" title="5.3.2Â i2c_bit_algo.master_xfer"></a><font size=3>5.3.2Â <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L626">i2c_bit_algo</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L627">master_xfer</a></font></h4><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L626">i2c_bit_algo</a>.<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L627">master_xfer</a>å¯¹åº”çš„æ˜¯<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/algos/i2c-algo-bit.c#L540">bit_xfer()</a>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ä¸ºi2cçš„è®¿é—®äº§ç”Ÿi2cè®¿é—®å‘¨æœŸéœ€è¦çš„start stop ackä¿¡å·ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bit_xfer</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *i2c_adap,</span></span><br><span class="line"><span class="params">		    <span class="keyword">struct</span> i2c_msg msgs[], <span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	i2c_start(adap);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line">		<span class="keyword">if</span> (pmsg-&gt;flags &amp; I2C_M_RD) &#123;</span><br><span class="line">			<span class="comment">/* read bytes into buffer*/</span></span><br><span class="line">			ret = readbytes(i2c_adap, pmsg);</span><br><span class="line">			<span class="comment">//......</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* write bytes from buffer */</span></span><br><span class="line">			ret = sendbytes(i2c_adap, pmsg);</span><br><span class="line">			<span class="comment">//......</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	ret = i;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	i2c_stop(adap);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬ä½¿ç”¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.71/source/drivers/i2c/i2c-core-base.c#L1913">i2c_transfer()</a> å‡½æ•°æ”¶å‘æ•°æ®çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°ã€‚ </p>
<h2 id="6-GPIOæ¨¡æ‹ŸI2Cdemo"><a href="#6-GPIOæ¨¡æ‹ŸI2Cdemo" class="headerlink" title="6. GPIOæ¨¡æ‹ŸI2Cdemo"></a><font size=3>6. GPIOæ¨¡æ‹ŸI2Cdemo</font></h2><h3 id="6-1-demoæºç "><a href="#6-1-demoæºç " class="headerlink" title="6.1 demoæºç "></a><font size=3>6.1 demoæºç </font></h3><p>è¿™ä¸ªdemoæºç å¯ä»¥çœ‹è¿™é‡Œï¼š<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/blob/master/30_i2c_subsystem/04_i2c_gpio/device_tree/imx6ull-alpha-emmc/imx6ull-alpha-emmc.dtsi">30_i2c_subsystem&#x2F;04_i2c_gpio&#x2F;device_tree&#x2F;imx6ull-alpha-emmc&#x2F;imx6ull-alpha-emmc.dtsi Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<p>è¿™ä¸ªdemoä¸»è¦æ˜¯ä¿®æ”¹è®¾å¤‡æ ‘ï¼Œé©±åŠ¨æ˜¯ä¸éœ€è¦çš„ï¼Œå¦å¤–è¿˜ä¿®æ”¹äº†<a target="_blank" rel="noopener" href="https://gitee.com/sumumm/imx6ull-driver-demo/blob/master/kernel/dts_common/imx6ul.dtsi">kernel&#x2F;dts_common&#x2F;imx6ul.dtsi Â· è‹æœ¨&#x2F;imx6ull-driver-demo - ç äº‘ - å¼€æºä¸­å›½</a></p>
<h3 id="6-2-å¼€å‘æ¿æµ‹è¯•"><a href="#6-2-å¼€å‘æ¿æµ‹è¯•" class="headerlink" title="6.2 å¼€å‘æ¿æµ‹è¯•"></a><font size=3>6.2 å¼€å‘æ¿æµ‹è¯•</font></h3><p>å°±å’Œè¿™ä¸€èŠ‚çš„4.3çš„æµ‹è¯•ç°è±¡ä¸€æ ·ã€‚</p>
<blockquote>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lcw/p/3297889.html">ã€é©±åŠ¨ã€‘linuxä¸‹I2Cé©±åŠ¨æ¶æ„å…¨é¢åˆ†æ - Leo.cheng - åšå®¢å›­</a></p>
<p><a target="_blank" rel="noopener" href="https://www.linuxidc.com/Linux/2017-03/142198.htm">Linux i2cå­ç³»ç»Ÿ(ä¸€) _åŠ¨æ‰‹å†™ä¸€ä¸ªi2cè®¾å¤‡é©±åŠ¨_Linuxç¼–ç¨‹_Linuxå…¬ç¤¾-Linuxç³»ç»Ÿé—¨æˆ·ç½‘ç«™</a></p>
<p><a target="_blank" rel="noopener" href="https://doc.embedfire.com/linux/imx6/driver/zh/latest/linux_driver/i2c_mpu6050.html">I2Cå­ç³»ç»Ÿâ€“mpu6050é©±åŠ¨å®éªŒ é‡ç«åµŒå…¥å¼Linuxé©±åŠ¨å¼€å‘å®æˆ˜æŒ‡å—â€”â€”åŸºäºi.MX6ULLç³»åˆ— æ–‡æ¡£</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ZHONGCAI0901/article/details/131167968">ã€I2Cã€‘Linuxä½¿ç”¨GPIOæ¨¡æ‹ŸI2C_i2c dts é…ç½®-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/landishu/article/details/118441943">Linuxå†…æ ¸é©±åŠ¨ï¼šgpioæ¨¡æ‹Ÿi2cé©±åŠ¨_i2c-gpio-CSDNåšå®¢</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">




    <div>
        
            <div style="text-align:center;color: #ccc;font-size:14px;">
            ----------æœ¬æ–‡ç»“æŸ
            <i class="fas fa-fan fa-spin" style="color: #FF1493; font-size: 1rem"></i>
            æ„Ÿè°¢æ‚¨çš„é˜…è¯»----------
            </div>
        
    </div>





  
  <div class="my_post_copyright"> 
    <p><span>æ–‡ç« æ ‡é¢˜:</span><a href="/post/2d9f95cb.html">LV08-01-I2Cå­ç³»ç»Ÿ-04-I2Cé©±åŠ¨æ¡†æ¶åˆ†æ</a></p>
    <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="æ¬¢è¿è®¿é—® ã€Šè‹æœ¨ã€‹ çš„å­¦ä¹ ç¬”è®°">è‹æœ¨</a></p>
    <p><span>å‘å¸ƒæ—¶é—´:</span>2025å¹´04æœˆ08æ—¥ - 07:38</p>
    <p><span>æœ€åæ›´æ–°:</span>2025å¹´06æœˆ14æ—¥ - 00:25</p>
    <p><span>åŸå§‹é“¾æ¥:</span><a href="/post/2d9f95cb.html" title="LV08-01-I2Cå­ç³»ç»Ÿ-04-I2Cé©±åŠ¨æ¡†æ¶åˆ†æ">https://sumumm.github.io/post/2d9f95cb.html</a></p>
    <p><span>è®¸å¯åè®®:</span><i class="fab fa-creative-commons"></i> <a rel="license" href= "https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>  
  </div>
  


          <div class="post-tags">
              <a href="/tags/LV08-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/" rel="tag"><i class="fa fa-tag"></i> LV08-I2Cå­ç³»ç»Ÿ</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/55b3c723.html" rel="prev" title="LV08-I2Cå­ç³»ç»Ÿ-readme">
                  <i class="fa fa-angle-left"></i> LV08-I2Cå­ç³»ç»Ÿ-readme
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/1c16e473.html" rel="next" title="LV08-01-I2Cå­ç³»ç»Ÿ-03-I2Cé©±åŠ¨æ¡†æ¶ç®€ä»‹">
                  LV08-01-I2Cå­ç³»ç»Ÿ-03-I2Cé©±åŠ¨æ¡†æ¶ç®€ä»‹ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">è‹æœ¨</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">3.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">225:26</span>
  </span>
</div>




    <span id="sitetime"></span>
    <script defer language=javascript>
        function siteTime()
        {
            window.setTimeout("siteTime()", 1000);
            var seconds = 1000;
            var minutes = seconds * 60;
            var hours = minutes * 60;
            var days = hours * 24;
            var years = days * 365;
            var today = new Date();
            var todayYear = today.getFullYear();
            var todayMonth = today.getMonth()+1;
            var todayDate = today.getDate();
            var todayHour = today.getHours();
            var todayMinute = today.getMinutes();
            var todaySecond = today.getSeconds();
            /*==================================================
            Date.UTC() -- è¿”å›dateå¯¹è±¡è·ä¸–ç•Œæ ‡å‡†æ—¶é—´(UTC)1970å¹´1æœˆ1æ—¥åˆå¤œä¹‹é—´çš„æ¯«ç§’æ•°(æ—¶é—´æˆ³)
            year        - ä½œä¸ºdateå¯¹è±¡çš„å¹´ä»½ï¼Œä¸º4ä½å¹´ä»½å€¼
            month       - 0-11ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æœˆä»½
            day         - 1-31ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å¤©æ•°
            hours       - 0(åˆå¤œ24ç‚¹)-23ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å°æ—¶æ•°
            minutes     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„åˆ†é’Ÿæ•°
            seconds     - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„ç§’æ•°
            microseconds - 0-999ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æ¯«ç§’æ•°
            ==================================================*/
            var t1 = Date.UTC(2017, 
                              5, 
                              19, 
                              0, 
                              0, 
                              0); //åŒ—äº¬æ—¶é—´
            var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
            var diff = t2-t1;
            var diffYears = Math.floor(diff/years);
            var diffDays = Math.floor((diff/days)-diffYears*365);
            var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
            var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
            var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
            document.getElementById("sitetime").innerHTML="å·²åœ¨è¿™é‡Œ "+diffYears+" å¹´ "+diffDays+" å¤© "+diffHours+" å°æ—¶ "+diffMinutes+" åˆ†é’Ÿ "+diffSeconds+" ç§’";
        }
        siteTime();
    </script>



    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


 
        <div id="click-show-text"
            data-mobile = false
            data-text = å¯Œå¼º,æ°‘ä¸»,æ–‡æ˜,å’Œè°,è‡ªç”±,å¹³ç­‰,å…¬æ­£,æ³•åˆ¶,çˆ±å›½,æ•¬ä¸š,è¯šä¿¡,å‹å–„
            data-fontsize = 15px
            data-random= false>
        </div>
       

      
        <script async src=https://cdn.jsdelivr.net/npm/hexo-next-mouse-effect@latest/click/showText.js></script>
      

      
    




    <script async src="/js/fancybox_param.js"></script>





<!-- APlayeræœ¬ä½“ -->



</body>
</html>
